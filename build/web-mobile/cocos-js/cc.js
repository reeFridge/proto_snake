System.register([],(function(e,t){"use strict";return{execute:function(){function n(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function i(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function r(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}e({BitMask:pt,CCClass:un,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,Enum:mt,Eventify:cu,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,Physics2DManifoldType:void 0,PhysicsGroup:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Fb,WorldNode3DToWorldNodeUI:zb,absMax:Mn,absMaxComponent:Nn,approx:vn,assert:S,assertID:M,bezier:Vf,bezierByTime:sd,ccenum:yt,clamp:gn,clamp01:yn,color:Fn,computeRatioByType:Sz,createDefaultPipeline:LN,debug:T,deserialize:qh,earcut:DQ,enumerableProps:kn,equals:mn,error:x,errorID:D,find:OD,fragmentText:nV,getBaselineOffset:function(){return 0},getError:k,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i="".concat(n.name,"/").concat(i),n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[Pc]},getWorldTransformUntilRoot:function(e,t,n){for(ei.identity(n);e!==t;)ei.fromRTS(KG,e.rotation,e.position,e.scale),ei.multiply(n,KG,n),e=e.parent;return n},instantiate:l_,inverseLerp:On,isCustomTargetModifier:nH,isDisplayStats:L,isElementModifier:tH,isPropertyModifier:eH,isUnicodeCJK:JH,isUnicodeSpace:$H,isValid:Cl,lerp:xn,log:g,logID:w,markAsWarning:void 0,mat4:ii,murmurhash2_32_gc:wa,nextPow2:Pn,pingPong:Dn,pseudoRandom:bn,pseudoRandomRange:wn,pseudoRandomRangeInt:Rn,quat:Jn,randomRange:Cn,randomRangeInt:An,rect:di,removeProperty:void 0,repeat:In,replaceProperty:void 0,safeMeasureText:eV,sampleAnimationCurve:xz,setDefaultLogTimes:function(e){e>0&&(W=e)},setDisplayStats:B,size:_i,toDegree:Tn,toRadian:Sn,v2:si,v3:Hn,v4:li,warn:y,warnID:P});var a=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(a);var o=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(e){return(e>0)-(e<0)},abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:n,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:i,nextPow2:r,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return a[255&e]<<24|a[e>>>8&255]<<16|a[e>>>16&255]<<8|a[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>i(e)+1}});e("bits",o);var s="undefined"==typeof window?global:window,c=e("cclegacy",{_global:s});c.internal={},s.CC_BUILD=!0,s.CC_TEST=!1,s.CC_EDITOR=false,s.CC_PREVIEW=!1,s.CC_DEV=!1,s.CC_DEBUG=!1,s.CC_JSB=!1,s.CC_BYTEDANCE=!1,s.CC_WECHAT=!1,s.CC_ALIPAY=!1,s.CC_XIAOMI=!1,s.CC_BAIDU=!1,s.CC_COCOSPLAY=!1,s.CC_HUAWEI=!1,s.CC_OPPO=!1,s.CC_VIVO=!1,s.CC_MINIGAME=!1,s.CC_RUNTIME_BASED=!1,s.CC_SUPPORT_JIT=!0;var l=e("VERSION","3.4.2");s.CocosEngine=c.ENGINE_VERSION=l,s.cc=c;var u="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",h=null,_=console.log.bind(console),f=_,d=_,p=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: ".concat(v.apply(void 0,[t].concat(i))))}},m=_;function v(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return c.js.formatStr.apply(null,[e].concat(n))}function g(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return _.apply(void 0,[e].concat(n))}function y(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return f.apply(void 0,[e].concat(n))}function x(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return d.apply(void 0,[e].concat(n))}function S(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return p.apply(void 0,[e,t].concat(i))}function T(){return m.apply(void 0,arguments)}function E(e){if(_=f=d=p=m=function(){},e!==O.NONE){if(e>O.ERROR){var t=function(e){if(c.game.canvas){if(!h){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",c.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(h=document.createElement("textarea")).setAttribute("rows","20"),h.setAttribute("cols","30"),h.setAttribute("disabled","true");var i=h.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(h),c.game.canvas.parentNode.appendChild(t)}h.value="".concat(h.value+e,"\r\n"),h.scrollTop=h.scrollHeight}};d=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  ".concat(v.apply(void 0,[e].concat(i))))},p=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),a=2;a<i;a++)r[a-2]=arguments[a];t("ASSERT: ".concat(v.apply(void 0,[n].concat(r))))}},e!==O.ERROR_FOR_WEB_PAGE&&(f=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  ".concat(v.apply(void 0,[e].concat(i))))}),e===O.INFO_FOR_WEB_PAGE&&(_=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(v.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),d=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},p=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var a=v.apply(void 0,[t].concat(i));throw new Error(a)}});if(e!==O.ERROR&&(f=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=O.INFO&&(_=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=O.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);m=function(){return n.apply(void 0,arguments)}}}}function C(e){x(e.stack||e)}function A(e){return function(t){for(var n="".concat(e," ").concat(t,", please go to ").concat(u,"#").concat(t," to see details."),i=arguments.length,r=new Array(i>1?i-1:0),a=1;a<i;a++)r[a-1]=arguments[a];return 0===r.length?n:"".concat(n," Arguments: ").concat(r.join(", "))}}var b=A("Log");function w(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];g(b.apply(void 0,[e].concat(n)))}var R=A("Warning");function P(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];y(R.apply(void 0,[e].concat(n)))}var I=A("Error");function D(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];x(I.apply(void 0,[e].concat(n)))}var O,N=A("Assert");function M(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];S(!1,N.apply(void 0,[t].concat(i)))}}function k(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return I.apply(void 0,[e].concat(n))}function L(){return!!c.profiler&&c.profiler.isShowingStats()}function B(e){c.profiler&&(e?c.profiler.showStats():c.profiler.hideStats(),c.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(O||(O=e("DebugMode",{})));var F,z,U,G,H,V,j=Object.freeze({__proto__:null,log:g,warn:y,error:x,assert:S,debug:T,_resetDebugSetting:E,_throw:C,logID:w,warnID:P,errorID:D,assertID:M,get DebugMode(){return O},getError:k,isDisplayStats:L,setDisplayStats:B}),W=10,q=0,X=new Map;function Y(e){return(Y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function K(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Z(e,t,n){return t&&Q(e.prototype,t),n&&Q(e,n),e}function J(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function $(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function ee(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$(Object(n),!0).forEach((function(t){J(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function te(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ie(e,t)}function ne(e){return(ne=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ie(e,t){return(ie=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function re(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function ae(e,t,n){return(ae=re()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&ie(r,n.prototype),r}).apply(null,arguments)}function oe(e){var t="function"==typeof Map?new Map:void 0;return(oe=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return ae(e,arguments,ne(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),ie(i,e)})(e)}function se(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ce(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?se(e):t}function le(e){var t=re();return function(){var n,i=ne(e);if(t){var r=ne(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return ce(this,n)}}function ue(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ne(e)););return e}function he(e,t,n){return(he="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=ue(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function _e(e,t,n,i){return(_e="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,n,i){var r,a=ue(e,t);if(a){if((r=Object.getOwnPropertyDescriptor(a,t)).set)return r.set.call(i,n),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(i,t)){if(!r.writable)return!1;r.value=n,Object.defineProperty(i,t,r)}else J(i,t,n);return!0})(e,t,n,i)}function fe(e,t,n,i,r){if(!_e(e,t,n,i||e)&&r)throw new Error("failed to set property");return n}function de(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],i=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(e){r=!0,a=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw a}}return n}}(e,t)||me(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function pe(e){return function(e){if(Array.isArray(e))return ve(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||me(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function me(e,t){if(e){if("string"==typeof e)return ve(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ve(e,t):void 0}}function ve(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function ge(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=me(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function ye(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function xe(e,t,n,i,r){var a={};return Object.keys(i).forEach((function(e){a[e]=i[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}G=function(e,t,n,i,r,a,o){var s=X.get(a);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. ".concat(o),"".concat(e,".").concat(t),"".concat(n,".").concat(i)),s.count++)},F=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=q++;X.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:W});var r=null!=n.target?n.target:e,a=null!=n.newName?n.newName:n.name,o=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"(".concat(n.suggest,")"):"";if(null!=n.customFunction)e[n.name]=function(){var e;return G(t,n.name,o,a,y,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return G(t,n.name,o,a,y,i,c),n.customGetter.call(this)},set:function(e){G(t,n.name,o,a,y,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){G(t,n.name,o,a,y,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return G(t,n.name,o,a,y,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return G(t,n.name,o,a,y,i,c),s?this[a]:r[a]},set:function(e){G(t,n.name,o,a,y,i,c),s?this[a]=e:r[a]=e},enumerable:!1})}))})),V=function(e,t,n,i,r){var a=X.get(i);a&&a.logTimes>a.count&&(n("'%s' has been removed. ".concat(r),"".concat(e,".").concat(t)),a.count++)},z=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=q++;X.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:W});var r=n.suggest?"(".concat(n.suggest,")"):"";Object.defineProperty(e,n.name,{get:function(){return V(t,n.name,x,i,r)},set:function(){V(t,n.name,x,i,r)},enumerable:!1})}))})),H=function(e,t,n,i,r){var a=X.get(i);a&&a.logTimes>a.count&&(n("'%s' is deprecated. ".concat(r),"".concat(e,".").concat(t)),a.count++)},U=e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var a=q++;X.set(a,{id:a,count:0,logTimes:void 0!==n.logTimes?n.logTimes:W});var o=n.suggest?"(".concat(n.suggest,")"):"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return H(t,i,y,a,o),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return H(t,i,y,a,o),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){H(t,i,y,a,o),c=e}})}else!function(t,n,i,r,a,o){if(t.get){var s=t.get;t.get=function(){return H(n,i,r,a,o),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){H(n,i,r,a,o),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,y,a,o);Object.defineProperty(e,i,{enumerable:!1})}}))}));var Se=function(){function e(t){K(this,e),this.i=0,this.array=t}return Z(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}},{key:"remove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}}]),e}();function Te(e,t){e.splice(t,1)}function Ee(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function Ce(e,t){var n=e.indexOf(t);return n>=0&&(Te(e,n),!0)}function Ae(e,t){return e.indexOf(t)>=0}var be=Object.freeze({__proto__:null,removeAt:Te,fastRemoveAt:Ee,remove:Ce,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:function(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return Te(e,n),i}},verifyType:function(e,t){if(e&&e.length>0)for(var n,i=ge(e);!(n=i()).done;)if(!(n.value instanceof t))return w(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)Ce(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(pe(t))),e},contains:Ae,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:Se}),we=function(){function e(t){K(this,e),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return Z(e,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),e}();we.global=new we("global");var Re=new we("TmpCId."),Pe="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),Ie="__cid__";function De(e){return"number"==typeof e||e instanceof Number}function Oe(e){return"string"==typeof e||e instanceof String}function Ne(e){for(var t in e)return!1;return!0}var Me,ke=(Me={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){Me.value=n,Me.writable=i,Me.enumerable=r,Object.defineProperty(e,t,Me),Me.value=void 0}),Le=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof r&&(a=r,r=void 0),e.get=i,e.set=r,e.enumerable=a,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),Be=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,a){e.get=i,e.enumerable=r,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0}}(),Fe=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,a){e.set=i,e.enumerable=r,e.configurable=a,Object.defineProperty(t,n,e),e.set=void 0}}();function ze(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function Ue(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?Ue(e.constructor):""}function Ge(e,t,n,i){var r=/([^.]+)$/,a=r.exec(t)[0],o=r.exec(n)[0];function s(){return this[o]}i?Le(e,a,s,(function(e){this[o]=e})):Be(e,a,s)}function He(e,t,n,i){for(var r in n){var a=n[r];Ge(e,"".concat(t,".").concat(r),a,i)}}var Ve=/(%d)|(%s)/,je=/%s/;function We(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return"".concat(e);var r="string"==typeof e&&Ve.test(e);if(r)for(var a,o=ge(n);!(a=o()).done;){var s=a.value,c="number"==typeof s?Ve:je;if(c.test(e)){var l="".concat(s);e=e.replace(c,l)}else e+=" ".concat(s)}else for(var u,h=ge(n);!(u=h()).done;){var _=u.value;e+=" ".concat(_)}return e}function qe(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function Xe(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Ye(e,t,n){var i=Xe(t,e);i&&Object.defineProperty(n,e,i)}function Ke(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,a=n;r<a.length;r++){var o=a[r];if(o){if("object"!==Y(o)){D(5402,o);continue}for(var s in o)s in e||Ye(s,o,e)}}return e}function Qe(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,a=n;r<a.length;r++){var o=a[r];if(o){if("object"!==Y(o)){D(5403,o);continue}for(var s in o)Ye(s,o,e)}}return e}function Ze(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Je(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function $e(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Je(e)))return!1;if(e===t)return!0}}return!1}function et(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var tt=ze(!0),nt=ze(!0);function it(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],ke(i.prototype,e,n),n){var r=t[n];r&&r!==i?x("A Class already exists with the same ".concat(e,' : "').concat(n,'".')):t[n]=i}}}var rt=it("__cid__",tt),at=it("__classname__",nt);function ot(e,t){if(at(e,t),!t.prototype.hasOwnProperty(Ie)){var n=e||Re.getNewId();n&&rt(n,t)}}function st(e,t){var n=nt[t],i=tt[t],r=!0;if(n&&n!==e&&(x('"'.concat(t,'" has already been set as name or alias of another class.')),r=!1),i&&i!==e&&(x('"'.concat(t,'" has already been set as id or alias of another class.')),r=!1),r){var a=e[Pe];a||(a=[],e[Pe]=a),a.push(t),nt[t]=e,tt[t]=e}}function ct(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var a=r[i],o=a.prototype,s=o.__cid__;s&&delete tt[s];var c=o.__classname__;c&&delete nt[c];var l=o[Pe];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete nt[h],delete tt[h]}}}function lt(e){return tt[e]}function ut(e){return nt[e]}function ht(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(Ie))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(Ie))return e.__cid__}return""}var _t=function(){function e(t,n){K(this,e),this.count=void 0,this._pool=void 0,this._cleanup=void 0;var i=void 0===n?t:n,r=void 0===n?null:t;this.count=0,this._pool=new Array(i),this._cleanup=r}return Z(e,[{key:"get",value:function(){return this._get()}},{key:"_get",value:function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),e}(),ft=be,dt={IDGenerator:we,Pool:_t,array:be,isNumber:De,isString:Oe,isEmptyObject:Ne,getPropertyDescriptor:Xe,addon:Ke,mixin:Qe,extend:Ze,getSuper:Je,isChildClassOf:$e,clear:et,value:ke,getset:Le,get:Be,set:Fe,unregisterClass:ct,getClassName:Ue,setClassName:ot,setClassAlias:st,getClassByName:ut,get _registeredClassNames(){return ee({},nt)},set _registeredClassNames(e){et(nt),Object.assign(nt,e)},get _registeredClassIds(){return ee({},tt)},set _registeredClassIds(e){et(tt),Object.assign(tt,e)},_getClassId:ht,_setClassId:rt,_getClassById:lt,obsolete:Ge,obsoletes:He,formatStr:We,shiftArguments:qe,createMap:ze};function pt(e){if("__bitmask__"in e)return e;ke(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o="".concat(a);r!==o&&ke(e,o,r)}return e}function mt(e){return"__enums__"in e?e:(ke(e,"__enums__",null,!0),mt.update(e))}function vt(e){e.hasOwnProperty("__enums__")}function gt(e){vt(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function yt(e){"__enums__"in e||ke(e,"__enums__",null,!0)}c.js=dt,e("js",Object.freeze({__proto__:null,array:ft,js:dt,IDGenerator:we,Pool:_t,isNumber:De,isString:Oe,isEmptyObject:Ne,value:ke,getset:Le,get:Be,set:Fe,createMap:ze,getClassName:Ue,obsolete:Ge,obsoletes:He,formatStr:We,shiftArguments:qe,getPropertyDescriptor:Xe,addon:Ke,mixin:Qe,extend:Ze,getSuper:Je,isChildClassOf:$e,clear:et,_idToClass:tt,_nameToClass:nt,_setClassId:rt,setClassName:ot,setClassAlias:st,unregisterClass:ct,_getClassById:lt,getClassByName:ut,_getClassId:ht})),pt.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},pt.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},c.BitMask=pt,mt.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o="".concat(a);r!==o&&ke(e,o,r)}return Array.isArray(e.__enums__)&&gt(e),e},mt||(mt=e("Enum",{})),mt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},mt.getList=function(e){return vt(e),e.__enums__?e.__enums__:gt(e)},c.Enum=mt;var xt=e("ValueType",function(){function e(){K(this,e)}return Z(e,[{key:"clone",value:function(){return D(100,"".concat(Ue(this),".clone")),this}},{key:"equals",value:function(){return!1}},{key:"set",value:function(){D(100,"".concat(Ue(this),".set"))}},{key:"toString",value:function(){return"".concat({})}}]),e}());ot("cc.ValueType",xt),c.ValueType=xt;var St=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});c.macro=St;for(var Tt=/^(?:cc|dragonBones|sp|ccsg)\..+/,Et=new Array(123),Ct=0;Ct<123;++Ct)Et[Ct]=64;for(var At=0;At<64;++At)Et["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(At)]=At;var bt=Et;function wt(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var a=e[n];Le(e,t,a,e[i])}}for(var r,a=e.prototype,o=0;o<t.length;o++){var s=(r=t[o])[0].toUpperCase()+r.slice(1);i(a,r,"get".concat(s),"set".concat(s))}for(r in n){var c=n[r];i(a,r,c[0],c[1])}}function Rt(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function Pt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function It(e){return"object"===("undefined"==typeof window?"undefined":Y(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===Y(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function Dt(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function Ot(e){return!(!e||e.constructor!==Object)&&Ne(e)}function Nt(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function Mt(e){return e*St.RAD}function kt(e){return e*St.DEG}c.misc={BUILTIN_CLASSID_RE:Tt,BASE64_VALUES:bt,propertyDefine:wt,pushToMap:Rt,contains:Pt,isDomNode:It,callInNextTick:Dt,isPlainEmptyObj_DEV:Ot,clampf:Nt,degreesToRadians:Mt,radiansToDegrees:kt},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:Tt,BASE64_VALUES:bt,propertyDefine:wt,pushToMap:Rt,contains:Pt,isDomNode:It,callInNextTick:Dt,tryCatchFunctor_EDITOR:function(e){return Function("target","".concat("try {\n  target.").concat(e,"();\n")+"}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:Ot,clampf:Nt,degreesToRadians:Mt,radiansToDegrees:kt}));var Lt="$_$";function Bt(e,t){var n=t?Object.create(t):{};return ke(e,"__attrs__",n),n}function Ft(e){if("function"!=typeof e)return Bt(e,Ut(e.constructor));for(var t,n=c.Class.getInheritanceChain(e),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||Bt(r,(t=n[i+1])&&t.__attrs__)}return Bt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function zt(e,t){var n=Ut(e),i=t+Lt,r={};for(var a in n)a.startsWith(i)&&(r[a.slice(i.length)]=n[a]);return r}function Ut(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||Ft(e)}function Gt(e,t,n,i){Ut(e)[t+Lt+n]=i}var Ht=function(){function e(t,n){K(this,e),this.name=void 0,this.default=void 0,this.name=t,this.default=n}return Z(e,[{key:"toString",value:function(){return this.name}}]),e}(),Vt=e("CCInteger",new Ht("Integer",0));c.Integer=Vt,c.CCInteger=Vt;var jt=e("CCFloat",new Ht("Float",0));c.Float=jt,c.CCFloat=jt;var Wt=e("CCBoolean",new Ht("Boolean",!1));c.Boolean=Wt,c.CCBoolean=Wt;var qt=e("CCString",new Ht("String",""));function Xt(e,t){return function(n,i){var r='"'.concat(Ue(n),".").concat(i,'"'),a=zt(n,i),o=a.type;if(o===Vt||o===jt?o="Number":o!==qt&&o!==Wt||(o="".concat(o)),o===e){if(a.hasOwnProperty("default")){var s=a.default;if(void 0!==s&&!Array.isArray(s)&&!Ot(s)){var c=Y(s),l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof a.ctor)return;P(3605,r,Ue(a.ctor))}else"Number"!==e&&P(3606,t,r,e);else{if("function"===c)return;e===qt.default&&null==s?P(3607,r):P(3611,t,r,c)}delete a.type}}}else P(3604,r)}}c.String=qt,c.CCString=qt;var Yt=Object.freeze({__proto__:null,DELIMETER:Lt,createAttrsSingle:Bt,createAttrs:Ft,attr:zt,getClassAttrs:Ut,setClassAttr:Gt,PrimitiveType:Ht,CCInteger:Vt,CCFloat:jt,CCBoolean:Wt,CCString:qt,getTypeChecker_ET:Xt,getObjTypeChecker_ET:function(e){return function(t,n){Xt("Object","type")(t,n);var i=Ut(t)["".concat(n+Lt,"default")],r=c.Class.getDefault(i);if(!Array.isArray(r)&&$e(e,c.ValueType)){var a=Ue(e),o=We('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Ue(t),n,a);i?g(o):P(3612,o,a,Ue(t),n,a)}}}}),Kt={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Qt(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$".concat(t);e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var a={};for(var o in i[r]=a,Kt){var s=Kt[o];e.hasOwnProperty(o)&&(a[o]=e[o],s.canUsedInGet||delete e[o])}}}function Zt(e,t,n,i){if(Array.isArray(t)){if(!(t.length>0))return D(5508,n,i);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=c.String:t===Boolean?e.type=c.Boolean:t===Number&&(e.type=c.Float))}function Jt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function $t(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return Jt(t,[],e);if("function"==typeof e){var n=e;return Jt(t,$e(n,c.ValueType)?new n:null,n)}return Jt(t,e instanceof Ht?e.default:e)}return null}var en=[];function tn(){return en[en.length-1]}c._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),en.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=en.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:tn};var nn=Lt,rn={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var a=Ue(i);r?ln(i,a,r,i.$super,n.mixins):D(3633,a)}this.datas=null}}};function an(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),_n(e,i,t,n)}function on(e,t,n,i){var r=i.get;i.set,r&&(_n(e,i,t,n),Gt(e,n,"serializable",!1))}function sn(e){return"function"==typeof e?e():e}function cn(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,Xe(t,i))}function ln(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var a=0;a<r.length;++a){var o=r[a];o.__props__&&(e.__props__=e.__props__.concat(o.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=$t(i,!1);if(r&&(i=e[n]=r),i){var a=i.notify;a&&Qt(i,n,a,e),"type"in i&&Zt(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?on(e,t,s,c):an(e,t,s,c)}var l=Ut(e);e.__values__=e.__props__.filter((function(e){return!1!==l["".concat(e+nn,"serializable")]}))}function un(e){var t=e.name,n=e.extends,i=e.mixins,r=function(e,t,n,i){var r=c.Component,a=tn();if(a&&$e(t,r)){if($e(a.cls,r))return D(3615),null;e=e||a.script}var o=function(e,t,n,i){var r=i.ctor,a=[r],o=r;ke(o,"__ctors__",a.length>0?a:null,!0);var s=o.prototype;if(t&&(o.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];cn(s,l.prototype),un._isCCClass(l)&&cn(Ut(o),Ut(l))}s.constructor=o}return ot(e,o),o}(e,t,n,i);if(a)if($e(t,r)){var s=a.uuid;s&&rt(s,o),a.cls=o}else $e(a.cls,r)||(a.cls=o);return o}(t,n,i,e);t||(t=c.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var a=e.properties;"function"==typeof a||n&&null===n.__props__||i&&i.some((function(e){return null===e.__props__}))?(rn.push({cls:r,props:a,mixins:i}),r.__props__=r.__values__=null):ln(r,t,a,n,e.mixins);var o=e.editor;return o&&$e(n,c.Component)&&c.Component._registerEditorProps(r,o),r}un._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},un.fastDefine=function(e,t,n){ot(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=Ut(t),a=0;a<i.length;a++){var o=i[a];r["".concat(o+nn,"visible")]=!1,r["".concat(o+nn,"default")]=n[o]}},un.Attr=Yt,un.attr=zt,un.getInheritanceChain=function(e){for(var t=[];e=Je(e);)e!==Object&&t.push(e);return t};var hn={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function _n(e,t,n,i){var r=null,a="";function o(){return a=i+nn,r=Ut(e)}"type"in t&&void 0===t.type&&P(3660,i,n);var s=t.type;s&&(hn[s]?(r||o())["".concat(a,"type")]=s:"Object"===s||("object"===Y(s)?mt.isEnum(s)?((r||o())["".concat(a,"type")]="Enum",r["".concat(a,"enumList")]=mt.getList(s)):pt.isBitMask(s)&&((r||o())["".concat(a,"type")]="BitMask",r["".concat(a,"bitmaskList")]=pt.getList(s)):"function"==typeof s&&((r||o())["".concat(a,"type")]="Object",r["".concat(a,"ctor")]=s))),"default"in t&&((r||o())["".concat(a,"default")]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];Y(i)===n&&((r||o())[a+e]=i)}};t.editorOnly&&((r||o())["".concat(a,"editorOnly")]=!0),t.__noImplicit?(r||o())["".concat(a,"serializable")]=null!==(c=t.serializable)&&void 0!==c&&c:!1===t.serializable&&((r||o())["".concat(a,"serializable")]=!1),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||o())["".concat(a,"min")]=u[0],r["".concat(a,"max")]=u[1],u.length>2&&(r["".concat(a,"step")]=u[2])),l("min","number"),l("max","number"),l("step","number")}un.isArray=function(e){return e=sn(e),Array.isArray(e)},un.getDefault=sn,un.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},un.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,un.getNewValueTypeCode=function(e){for(var t=Ue(e),n=e.constructor,i="new ".concat(t,"("),r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return"".concat(i,")")},c.Class=un;var fn=Math.PI/180,dn=180/Math.PI,pn=e("EPSILON",1e-6);function mn(e,t){return Math.abs(e-t)<=pn*Math.max(1,Math.abs(e),Math.abs(t))}function vn(e,t,n){return n=n||pn,Math.abs(e-t)<=n}function gn(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function yn(e){return e<0?0:e>1?1:e}function xn(e,t,n){return e+(t-e)*n}function Sn(e){return e*fn}function Tn(e){return e*dn}var En=e("random",Math.random);function Cn(e,t){return Math.random()*(t-e)+e}function An(e,t){return Math.floor(Cn(e,t))}function bn(e){return(e=(9301*e+49297)%233280)/233280}function wn(e,t,n){return bn(e)*(n-t)+t}function Rn(e,t,n){return Math.floor(wn(e,t,n))}function Pn(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function In(e,t){return e-Math.floor(e/t)*t}function Dn(e,t){return e=In(e,2*t),t-Math.abs(e-t)}function On(e,t,n){return(n-e)/(t-e)}function Nn(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function Mn(e,t){return Math.abs(e)>Math.abs(t)?e:t}function kn(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var Ln=1/255,Bn=e("Color",function(e){te(n,e);var t=le(n);function n(e,i,r,a){var o;return K(this,n),(o=t.call(this))._val=0,"string"==typeof e?o.fromHEX(e):void 0!==i?o.set(e,i,r,a):o.set(e),o}return Z(n,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~gn(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~gn(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~gn(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~gn(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*Ln},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*Ln},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*Ln},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*Ln},set:function(e){this.a=255*e}},{key:"clone",value:function(){var e=new n;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){var n=this.r,i=this.g,r=this.b,a=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,a+=(e.a-a)*t,this._val=Math.floor((a<<24>>>0)+(r<<16)+(i<<8)+n),this}},{key:"toString",value:function(){return"rgba(".concat(this.r.toFixed(),", ").concat(this.g.toFixed(),", ").concat(this.b.toFixed(),", ").concat(this.a.toFixed(),")")}},{key:"toCSS",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"rgba";return"rgba"===e?"rgba(".concat(this.r,",").concat(this.g,",").concat(this.b,",").concat((this.a*Ln).toFixed(2),")"):"rgb"===e?"rgb(".concat(this.r,",").concat(this.g,",").concat(this.b,")"):"#".concat(this.toHEX(e))}},{key:"fromHEX",value:function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this}},{key:"toHEX",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"#rrggbb",t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,n){var i=0,r=0,a=0;if(0===t)i=r=a=n;else if(0===n)i=r=a=0;else{1===e&&(e=0),e*=6;var o=Math.floor(e),s=e-o,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(o){case 0:i=n,r=u,a=c;break;case 1:i=l,r=n,a=c;break;case 2:i=c,r=n,a=u;break;case 3:i=c,r=l,a=n;break;case 4:i=u,r=c,a=n;break;case 5:i=n,r=c,a=l}}return i*=255,r*=255,a*=255,this._val=(this.a<<24>>>0)+(a<<16)+(r<<8)+(0|i),this}},{key:"toHSV",value:function(){var e=this.r*Ln,t=this.g*Ln,n=this.b*Ln,i={h:0,s:0,v:0},r=Math.max(e,t,n),a=Math.min(e,t,n),o=0;return i.v=r,i.s=r?(r-a)/r:0,i.s?(o=r-a,i.h=e===r?(t-n)/o:t===r?2+(n-e)/o:4+(e-t)/o,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i}},{key:"set",value:function(e,t,n,i){return"object"===Y(e)?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this}},{key:"multiply",value:function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24)>>>0,this}}],[{key:"clone",value:function(e){var t=new n;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e}},{key:"fromHEX",value:function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;var n=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(n)?255:n,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e}},{key:"add",value:function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e}},{key:"subtract",value:function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e}},{key:"multiply",value:function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e}},{key:"divide",value:function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e}},{key:"scale",value:function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e}},{key:"lerp",value:function(e,t,n,i){var r=t.r,a=t.g,o=t.b,s=t.a;return r+=(n.r-r)*i,a+=(n.g-a)*i,o+=(n.b-o)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(o<<16)+(a<<8)+r),e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=t instanceof n||t.a>1?1/255:1;return e[i+0]=t.r*r,e[i+1]=t.g*r,e[i+2]=t.b*r,e[i+3]=t.a*r,e}},{key:"fromArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pn;return Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),n}(xt));function Fn(e,t,n,i){return new Bn(e,t,n,i)}Bn.WHITE=Object.freeze(new Bn(255,255,255,255)),Bn.GRAY=Object.freeze(new Bn(127,127,127,255)),Bn.BLACK=Object.freeze(new Bn(0,0,0,255)),Bn.TRANSPARENT=Object.freeze(new Bn(0,0,0,0)),Bn.RED=Object.freeze(new Bn(255,0,0,255)),Bn.GREEN=Object.freeze(new Bn(0,255,0,255)),Bn.BLUE=Object.freeze(new Bn(0,0,255,255)),Bn.CYAN=Object.freeze(new Bn(0,255,255,255)),Bn.MAGENTA=Object.freeze(new Bn(255,0,255,255)),Bn.YELLOW=Object.freeze(new Bn(255,255,0,255)),un.fastDefine("cc.Color",Bn,{r:0,g:0,b:0,a:255}),c.Color=Bn,c.color=Fn;var zn=e("Vec3",function(e){te(n,e);var t=le(n);function n(e,i,r){var a;return K(this,n),a=t.call(this),e&&"object"===Y(e)?(a.x=e.x,a.y=e.y,a.z=e.z):(a.x=e||0,a.y=i||0,a.z=r||0),a}return Z(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z)}},{key:"set",value:function(e,t,n){return e&&"object"===Y(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pn;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))}},{key:"equals3f",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:pn;return Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,n){return this.x===e&&this.y===t&&this.z===n}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}},{key:"add3f",value:function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}},{key:"subtract3f",value:function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this}},{key:"multiplyScalar",value:function(e){return"object"===Y(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this}},{key:"multiply",value:function(e){return"object"!==Y(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this}},{key:"multiply3f",value:function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this}},{key:"divide",value:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}},{key:"divide3f",value:function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=gn(this.x,e.x,t.x),this.y=gn(this.y,e.y,t.y),this.z=gn(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,n=this.y,i=this.z,r=e.x,a=e.y,o=e.z;return this.x=n*o-i*a,this.y=i*r-t*o,this.z=t*a-n*r,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this}},{key:"transformMat4",value:function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this}}],[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new n(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e}},{key:"add",value:function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e}},{key:"subtract",value:function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e}},{key:"multiply",value:function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e}},{key:"divide",value:function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e}},{key:"max",value:function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e}},{key:"scaleAndAdd",value:function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e}},{key:"distance",value:function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)}},{key:"squaredDistance",value:function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r}},{key:"len",value:function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)}},{key:"lengthSqr",value:function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<pn?e.x=0:e.x=1/n,Math.abs(i)<pn?e.y=0:e.y=1/i,Math.abs(r)<pn?e.z=0:e.z=1/r,e}},{key:"normalize",value:function(e,t){var n=t.x,i=t.y,r=t.z,a=n*n+i*i+r*r;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.x,s=n.y,c=n.z;return e.x=r*c-a*s,e.y=a*o-i*c,e.z=i*s-r*o,e}},{key:"lerp",value:function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var n=2*En()*Math.PI,i=2*En()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e}},{key:"transformMat4",value:function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.m03*i+n.m07*r+n.m11*a+n.m15;return o=o?Math.abs(1/o):1,e.x=(n.m00*i+n.m04*r+n.m08*a+n.m12)*o,e.y=(n.m01*i+n.m05*r+n.m09*a+n.m13)*o,e.z=(n.m02*i+n.m06*r+n.m10*a+n.m14)*o,e}},{key:"transformMat4Normal",value:function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.m03*i+n.m07*r+n.m11*a;return o=o?Math.abs(1/o):1,e.x=(n.m00*i+n.m04*r+n.m08*a)*o,e.y=(n.m01*i+n.m05*r+n.m09*a)*o,e.z=(n.m02*i+n.m06*r+n.m10*a)*o,e}},{key:"transformMat3",value:function(e,t,n){var i=t.x,r=t.y,a=t.z;return e.x=i*n.m00+r*n.m03+a*n.m06,e.y=i*n.m01+r*n.m04+a*n.m07,e.z=i*n.m02+r*n.m05+a*n.m08,e}},{key:"transformAffine",value:function(e,t,n){var i=t.x,r=t.y,a=t.z;return e.x=n.m00*i+n.m04*r+n.m08*a+n.m12,e.y=n.m01*i+n.m05*r+n.m09*a+n.m13,e.x=n.m02*i+n.m06*r+n.m10*a+n.m14,e}},{key:"transformQuat",value:function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,a=n.w*t.z+n.x*t.y-n.y*t.x,o=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+o*-n.x+r*-n.z-a*-n.y,e.y=r*n.w+o*-n.y+a*-n.x-i*-n.z,e.z=a*n.w+o*-n.z+i*-n.y-r*-n.x,e}},{key:"transformRTS",value:function(e,t,n,i,r){var a=t.x*r.x,o=t.y*r.y,s=t.z*r.z,c=n.w*a+n.y*s-n.z*o,l=n.w*o+n.z*a-n.x*s,u=n.w*s+n.x*o-n.y*a,h=-n.x*a-n.y*o-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e}},{key:"transformInverseRTS",value:function(e,t,n,i,r){var a=t.x-i.x,o=t.y-i.y,s=t.z-i.z,c=n.w*a-n.y*s+n.z*o,l=n.w*o-n.z*a+n.x*s,u=n.w*s-n.x*o+n.y*a,h=n.x*a+n.y*o+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e}},{key:"rotateX",value:function(e,t,n,i){var r=t.x-n.x,a=t.y-n.y,o=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=a*s-o*c,h=a*c+o*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e}},{key:"rotateY",value:function(e,t,n,i){var r=t.x-n.x,a=t.y-n.y,o=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=o*c+r*s,u=a,h=o*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e}},{key:"rotateZ",value:function(e,t,n,i){var r=t.x-n.x,a=t.y-n.y,o=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-a*c,u=r*c+a*s,h=o;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e}},{key:"toArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e}},{key:"fromArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pn,i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,c=t.z;return Math.abs(i-o)<=n*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(a-c)<=n*Math.max(1,Math.abs(a),Math.abs(c))}},{key:"angle",value:function(e,t){n.normalize(Un,e),n.normalize(Gn,t);var i=n.dot(Un,Gn);return i>1?0:i<-1?Math.PI:Math.acos(i)}},{key:"projectOnPlane",value:function(e,t,i){return n.subtract(e,t,n.project(e,t,i))}},{key:"project",value:function(e,t,i){var r=n.lengthSqr(i);return r<1e-6?n.set(e,0,0,0):n.multiplyScalar(e,i,n.dot(t,i)/r)}}]),n}(xt));zn.UNIT_X=Object.freeze(new zn(1,0,0)),zn.UNIT_Y=Object.freeze(new zn(0,1,0)),zn.UNIT_Z=Object.freeze(new zn(0,0,1)),zn.RIGHT=Object.freeze(new zn(1,0,0)),zn.UP=Object.freeze(new zn(0,1,0)),zn.FORWARD=Object.freeze(new zn(0,0,-1)),zn.ZERO=Object.freeze(new zn(0,0,0)),zn.ONE=Object.freeze(new zn(1,1,1)),zn.NEG_ONE=Object.freeze(new zn(-1,-1,-1));var Un=new zn,Gn=new zn;function Hn(e,t,n){return new zn(e,t,n)}un.fastDefine("cc.Vec3",zn,{x:0,y:0,z:0}),c.Vec3=zn,c.v3=Hn;var Vn=e("Mat3",function(e){te(n,e);var t=le(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return K(this,n),e=t.call(this),"object"===Y(i)?(e.m00=i.m00,e.m01=i.m01,e.m02=i.m02,e.m03=i.m03,e.m04=i.m04,e.m05=i.m05,e.m06=i.m06,e.m07=i.m07,e.m08=i.m08):(e.m00=i,e.m01=r,e.m02=a,e.m03=o,e.m04=s,e.m05=c,e.m06=l,e.m07=u,e.m08=h),e}return Z(n,[{key:"clone",value:function(){var e=this;return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return"object"===Y(e)?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=a,this.m06=o,this.m07=s,this.m08=c),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pn;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){var e=this;return"[\n".concat(e.m00,", ").concat(e.m01,", ").concat(e.m02,",\n").concat(e.m03,",\n").concat(e.m04,", ").concat(e.m05,",\n").concat(e.m06,", ").concat(e.m07,",\n").concat(e.m08,"\n")+"]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this}},{key:"invert",value:function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08,l=c*r-a*s,u=-c*i+a*o,h=s*i-r*o,_=e*l+t*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+n*s)*_,this.m02=(a*t-n*r)*_,this.m03=u*_,this.m04=(c*e-n*o)*_,this.m05=(-a*e+n*i)*_,this.m06=h*_,this.m07=(-s*e+t*o)*_,this.m08=(r*e-t*i)*_,this)}},{key:"determinant",value:function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08;return e*(c*r-a*s)+t*(-c*i+a*o)+n*(s*i-r*o)}},{key:"add",value:function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this}},{key:"subtract",value:function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,d=e.m04,p=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+_*s,this.m01=u*n+h*a+_*c,this.m02=u*i+h*o+_*l,this.m03=f*t+d*r+p*s,this.m04=f*n+d*a+p*c,this.m05=f*i+d*o+p*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*a+g*c,this.m08=m*i+v*o+g*l,this}},{key:"multiplyScalar",value:function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this}},{key:"scale",value:function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*a,this.m02=h*i+u*o,this.m03=h*r-u*t,this.m04=h*a-u*n,this.m05=h*o-u*i,this.m06=s,this.m07=c,this.m08=l,this}},{key:"fromQuat",value:function(e){var t=e.x,n=e.y,i=e.z,r=e.w,a=t+t,o=n+n,s=i+i,c=t*a,l=n*a,u=n*o,h=i*a,_=i*o,f=i*s,d=r*a,p=r*o,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+p,this.m01=l+m,this.m04=1-c-f,this.m07=_-d,this.m02=h-p,this.m05=_+d,this.m08=1-c-u,this}}],[{key:"clone",value:function(e){return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,n,i,r,a,o,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=c,e.m08=l,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e}},{key:"invert",value:function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*o-s*l,_=-u*a+s*c,f=l*a-o*c,d=n*h+i*_+r*f;return 0===d?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(d=1/d,e.m00=h*d,e.m01=(-u*i+r*l)*d,e.m02=(s*i-r*o)*d,e.m03=_*d,e.m04=(u*n-r*c)*d,e.m05=(-s*n+r*a)*d,e.m06=f*d,e.m07=(-l*n+i*c)*d,e.m08=(o*n-i*a)*d,e)}},{key:"determinant",value:function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*a-o*c)+n*(-l*r+o*s)+i*(c*r-a*s)}},{key:"multiply",value:function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return e.m00=_*i+f*o+d*l,e.m01=_*r+f*s+d*u,e.m02=_*a+f*c+d*h,e.m03=p*i+m*o+v*l,e.m04=p*r+m*s+v*u,e.m05=p*a+m*c+v*h,e.m06=g*i+y*o+x*l,e.m07=g*r+y*s+x*u,e.m08=g*a+y*c+x*h,e}},{key:"multiplyMat4",value:function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return e.m00=_*i+f*o+d*l,e.m01=_*r+f*s+d*u,e.m02=_*a+f*c+d*h,e.m03=p*i+m*o+v*l,e.m04=p*r+m*s+v*u,e.m05=p*a+m*c+v*h,e.m06=g*i+y*o+x*l,e.m07=g*r+y*s+x*u,e.m08=g*a+y*c+x*h,e}},{key:"transform",value:function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.x,f=n.y;return e.m00=i,e.m01=r,e.m02=a,e.m03=o,e.m04=s,e.m05=c,e.m06=_*i+f*o+l,e.m07=_*r+f*s+u,e.m08=_*a+f*c+h,e}},{key:"scale",value:function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=Math.sin(n),f=Math.cos(n);return e.m00=f*i+_*o,e.m01=f*r+_*s,e.m02=f*a+_*c,e.m03=f*o-_*i,e.m04=f*s-_*r,e.m05=f*c-_*a,e.m06=l,e.m07=u,e.m08=h,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return zn.lengthSqr(t)<pn*pn?(n.identity(e),e):(i=i||zn.UNIT_Y,zn.normalize(jn,zn.cross(jn,i,t)),zn.lengthSqr(jn)<pn*pn?(n.identity(e),e):(zn.cross(Wn,t,jn),n.set(e,jn.x,jn.y,jn.z,Wn.x,Wn.y,Wn.z,t.x,t.y,t.z),e))}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w,o=n+n,s=i+i,c=r+r,l=n*o,u=i*o,h=i*s,_=r*o,f=r*s,d=r*c,p=a*o,m=a*s,v=a*c;return e.m00=1-h-d,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-l-d,e.m07=f-p,e.m02=_-m,e.m05=f+p,e.m08=1-l-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*o,y=n*c-r*o,x=n*l-a*o,S=i*c-r*s,T=i*l-a*s,E=r*l-a*c,C=u*p-h*d,A=u*m-_*d,b=u*v-f*d,w=h*m-_*p,R=h*v-f*p,P=_*v-f*m,I=g*P-y*R+x*w+S*b-T*A+E*C;return I?(I=1/I,e.m00=(s*P-c*R+l*w)*I,e.m01=(c*b-o*P-l*A)*I,e.m02=(o*R-s*b+l*C)*I,e.m03=(r*R-i*P-a*w)*I,e.m04=(n*P-r*b+a*A)*I,e.m05=(i*b-n*R-a*C)*I,e.m06=(p*E-m*T+v*S)*I,e.m07=(m*x-d*E-v*y)*I,e.m08=(d*T-p*x+v*g)*I,e):null}},{key:"toArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e}},{key:"fromArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e}},{key:"add",value:function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e}},{key:"subtract",value:function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e}},{key:"multiplyScalar",value:function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e}},{key:"multiplyScalarAndAdd",value:function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pn;return Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}}]),n}(xt));Vn.IDENTITY=Object.freeze(new Vn);var jn=new zn,Wn=new zn;un.fastDefine("cc.Mat3",Vn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),c.Mat3=Vn;var qn=e("Quat",function(e){te(n,e);var t=le(n);function n(e,i,r,a){var o;return K(this,n),o=t.call(this),e&&"object"===Y(e)?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=i||0,o.z=r||0,o.w=null!=a?a:1),o}return Z(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,n,i){return e&&"object"===Y(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pn;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return n.toEuler(e,this)}},{key:"lerp",value:function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this}},{key:"slerp",value:function(e,t){return n.slerp(this,this,e,t)}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}],[{key:"clone",value:function(e){return new n(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var r=zn.dot(t,i);return r<-.999999?(zn.cross(Kn,zn.UNIT_X,t),Kn.length()<1e-6&&zn.cross(Kn,zn.UNIT_Y,t),zn.normalize(Kn,Kn),n.fromAxisAngle(e,Kn,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(zn.cross(Kn,t,i),e.x=Kn.x,e.y=Kn.y,e.z=Kn.z,e.w=1+r,n.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n}},{key:"multiply",value:function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,a=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,o=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=a,e.w=o,e}},{key:"multiplyScalar",value:function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e}},{key:"scaleAndAdd",value:function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e}},{key:"rotateX",value:function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),a=t.x,o=t.y,s=t.z,c=t.w;return e.x=a*r+c*i,e.y=o*r+s*i,e.z=s*r-o*i,e.w=c*r-a*i,e}},{key:"rotateY",value:function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),a=t.x,o=t.y,s=t.z,c=t.w;return e.x=a*r-s*i,e.y=o*r+c*i,e.z=s*r+a*i,e.w=c*r-o*i,e}},{key:"rotateZ",value:function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),a=t.x,o=t.y,s=t.z,c=t.w;return e.x=a*r+o*i,e.y=o*r-a*i,e.z=s*r+c*i,e.w=c*r-s*i,e}},{key:"rotateAround",value:function(e,t,i,r){return n.invert(Xn,t),zn.transformQuat(Kn,i,Xn),n.fromAxisAngle(Xn,Kn,r),n.multiply(e,t,Xn),e}},{key:"rotateAroundLocal",value:function(e,t,i,r){return n.fromAxisAngle(Xn,i,r),n.multiply(e,t,Xn),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e}},{key:"slerp",value:function(e,t,n,i){var r=0,a=0,o=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,o=-o,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,a=Math.sin(i*h)/_}else r=1-i,a=i;return e.x=r*t.x+a*o,e.y=r*t.y+a*s,e.z=r*t.z+a*c,e.w=r*t.w+a*l,e}},{key:"sqlerp",value:function(e,t,i,r,a,o){return n.slerp(Xn,t,a,o),n.slerp(Yn,i,r,o),n.slerp(e,Xn,Yn,2*o*(1-o)),e}},{key:"invert",value:function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e}},{key:"fromAxes",value:function(e,t,i,r){return Vn.set(Qn,t.x,t.y,t.z,i.x,i.y,i.z,r.x,r.y,r.z),n.normalize(e,n.fromMat3(e,Qn))}},{key:"fromViewUp",value:function(e,t,i){return Vn.fromViewUp(Qn,t,i),n.normalize(e,n.fromMat3(e,Qn))}},{key:"fromAxisAngle",value:function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e}},{key:"fromMat3",value:function(e,t){var n=t.m00,i=t.m03,r=t.m06,a=t.m01,o=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+o+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-s)*_,e.y=(r-c)*_,e.z=(a-i)*_}else if(n>o&&n>u){var f=2*Math.sqrt(1+n-o-u);e.w=(l-s)/f,e.x=.25*f,e.y=(i+a)/f,e.z=(r+c)/f}else if(o>u){var d=2*Math.sqrt(1+o-n-u);e.w=(r-c)/d,e.x=(i+a)/d,e.y=.25*d,e.z=(s+l)/d}else{var p=2*Math.sqrt(1+u-n-o);e.w=(a-i)/p,e.x=(r+c)/p,e.y=(s+l)/p,e.z=.25*p}return e}},{key:"fromEuler",value:function(e,t,n,i){t*=Zn,n*=Zn,i*=Zn;var r=Math.sin(t),a=Math.cos(t),o=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+a*o*c,e.y=a*o*l+r*s*c,e.z=a*s*c-r*o*l,e.w=a*s*l-r*o*c,e}},{key:"fromAngleZ",value:function(e,t){return t*=Zn,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e}},{key:"toAxisX",value:function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e}},{key:"toAxisY",value:function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e}},{key:"toAxisZ",value:function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e}},{key:"toEuler",value:function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w,s=0,c=0,l=0,u=i*r+a*o;if(u>.499999)s=0,c=Tn(2*Math.atan2(i,o)),l=90;else if(u<-.499999)s=0,c=-Tn(2*Math.atan2(i,o)),l=-90;else{var h=i*i,_=r*r,f=a*a;s=Tn(Math.atan2(2*i*o-2*r*a,1-2*h-2*f)),c=Tn(Math.atan2(2*r*o-2*i*a,1-2*_-2*f)),l=Tn(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e}},{key:"toArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e}},{key:"fromArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pn;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),n}(xt));qn.IDENTITY=Object.freeze(new qn);var Xn=new qn,Yn=new qn,Kn=new zn,Qn=new Vn,Zn=.5*Math.PI/180;function Jn(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new qn(e,t,n,i)}un.fastDefine("cc.Quat",qn,{x:0,y:0,z:0,w:1}),c.Quat=qn,c.quat=Jn;var $n=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),ei=e("Mat4",function(e){te(n,e);var t=le(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,_=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,f=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,d=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,p=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,m=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,v=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,g=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return K(this,n),(e=t.call(this)).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,e.m09=void 0,e.m10=void 0,e.m11=void 0,e.m12=void 0,e.m13=void 0,e.m14=void 0,e.m15=void 0,"object"===Y(i)?(e.m00=i.m00,e.m01=i.m01,e.m02=i.m02,e.m03=i.m03,e.m04=i.m04,e.m05=i.m05,e.m06=i.m06,e.m07=i.m07,e.m08=i.m08,e.m09=i.m09,e.m10=i.m10,e.m11=i.m11,e.m12=i.m12,e.m13=i.m13,e.m14=i.m14,e.m15=i.m15):(e.m00=i,e.m01=r,e.m02=a,e.m03=o,e.m04=s,e.m05=c,e.m06=l,e.m07=u,e.m08=h,e.m09=_,e.m10=f,e.m11=d,e.m12=p,e.m13=m,e.m14=v,e.m15=g),e}return Z(n,[{key:"clone",value:function(){return new n(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,l=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,u=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,_=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,f=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,d=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,p=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return"object"===Y(e)?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=a,this.m06=o,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=d,this.m15=p,this.m00=e),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pn;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n".concat(this.m00,", ").concat(this.m01,", ").concat(this.m02,", ").concat(this.m03,",\n").concat(this.m04,", ").concat(this.m05,", ").concat(this.m06,", ").concat(this.m07,",\n").concat(this.m08,", ").concat(this.m09,", ").concat(this.m10,", ").concat(this.m11,",\n").concat(this.m12,", ").concat(this.m13,", ").concat(this.m14,", ").concat(this.m15,"\n")+"]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"zero",value:function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=a,this}},{key:"invert",value:function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15,m=e*a-t*r,v=e*o-n*r,g=e*s-i*r,y=t*o-n*a,x=t*s-i*a,S=n*s-i*o,T=c*f-l*_,E=c*d-u*_,C=c*p-h*_,A=l*d-u*f,b=l*p-h*f,w=u*p-h*d,R=m*w-v*b+g*A+y*C-x*E+S*T;return 0===R?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(R=1/R,this.m00=(a*w-o*b+s*A)*R,this.m01=(n*b-t*w-i*A)*R,this.m02=(f*S-d*x+p*y)*R,this.m03=(u*x-l*S-h*y)*R,this.m04=(o*C-r*w-s*E)*R,this.m05=(e*w-n*C+i*E)*R,this.m06=(d*g-_*S-p*v)*R,this.m07=(c*S-u*g+h*v)*R,this.m08=(r*b-a*C+s*T)*R,this.m09=(t*C-e*b-i*T)*R,this.m10=(_*x-f*g+p*m)*R,this.m11=(l*g-c*x-h*m)*R,this.m12=(a*E-r*A-o*T)*R,this.m13=(e*A-t*E+n*T)*R,this.m14=(f*v-_*y-d*m)*R,this.m15=(c*y-l*v+u*m)*R,this)}},{key:"determinant",value:function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15;return(e*a-t*r)*(u*p-h*d)-(e*o-n*r)*(l*p-h*f)+(e*s-i*r)*(l*d-u*f)+(t*o-n*a)*(c*p-h*_)-(t*s-i*a)*(c*d-u*_)+(n*s-i*o)*(c*f-l*_)}},{key:"add",value:function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this}},{key:"subtract",value:function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this}},{key:"multiply",value:function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,d=this.m13,p=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,x=e.m03;return this.m00=v*t+g*a+y*l+x*f,this.m01=v*n+g*o+y*u+x*d,this.m02=v*i+g*s+y*h+x*p,this.m03=v*r+g*c+y*_+x*m,v=e.m04,g=e.m05,y=e.m06,x=e.m07,this.m04=v*t+g*a+y*l+x*f,this.m05=v*n+g*o+y*u+x*d,this.m06=v*i+g*s+y*h+x*p,this.m07=v*r+g*c+y*_+x*m,v=e.m08,g=e.m09,y=e.m10,x=e.m11,this.m08=v*t+g*a+y*l+x*f,this.m09=v*n+g*o+y*u+x*d,this.m10=v*i+g*s+y*h+x*p,this.m11=v*r+g*c+y*_+x*m,v=e.m12,g=e.m13,y=e.m14,x=e.m15,this.m12=v*t+g*a+y*l+x*f,this.m13=v*n+g*o+y*u+x*d,this.m14=v*i+g*s+y*h+x*p,this.m15=v*r+g*c+y*_+x*m,this}},{key:"multiplyScalar",value:function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this}},{key:"translate",value:function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this}},{key:"scale",value:function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this}},{key:"rotate",value:function(e,t){var n=t.x,i=t.y,r=t.z,a=Math.sqrt(n*n+i*i+r*r);if(Math.abs(a)<pn)return null;n*=a=1/a,i*=a,r*=a;var o=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,d=this.m05,p=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,T=i*n*c+r*o,E=r*n*c-i*o,C=n*i*c-r*o,A=i*i*c+s,b=r*i*c+n*o,w=n*r*c+i*o,R=i*r*c-n*o,P=r*r*c+s;return this.m00=l*S+f*T+v*E,this.m01=u*S+d*T+g*E,this.m02=h*S+p*T+y*E,this.m03=_*S+m*T+x*E,this.m04=l*C+f*A+v*b,this.m05=u*C+d*A+g*b,this.m06=h*C+p*A+y*b,this.m07=_*C+m*A+x*b,this.m08=l*w+f*R+v*P,this.m09=u*w+d*R+g*P,this.m10=h*w+p*R+y*P,this.m11=_*w+m*R+x*P,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=ni.m00=this.m00,n=ni.m01=this.m01,i=ni.m02=this.m02,r=ni.m03=this.m04,a=ni.m04=this.m05,o=ni.m05=this.m06,s=ni.m06=this.m08,c=ni.m07=this.m09,l=ni.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+a*a+o*o),e.z=Math.sqrt(s*s+c*c+l*l),Vn.determinant(ni)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e}},{key:"fromRTS",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,c=r+r,l=a+a,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=a*l,m=o*s,v=o*c,g=o*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(f+p))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+p))*x,this.m06=(d+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(d-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,n=e.y,i=e.z,r=e.w,a=t+t,o=n+n,s=i+i,c=t*a,l=n*a,u=n*o,h=i*a,_=i*o,f=i*s,d=r*a,p=r*o,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-p,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+d,this.m07=0,this.m08=h+p,this.m09=_-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}],[{key:"clone",value:function(e){return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,n,i,r,a,o,s,c,l,u,h,_,f,d,p,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=d,e.m14=p,e.m15=m,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,a=t.m06,o=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=o,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*o,y=n*c-r*o,x=n*l-a*o,S=i*c-r*s,T=i*l-a*s,E=r*l-a*c,C=u*p-h*d,A=u*m-_*d,b=u*v-f*d,w=h*m-_*p,R=h*v-f*p,P=_*v-f*m,I=g*P-y*R+x*w+S*b-T*A+E*C;return 0===I?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(I=1/I,e.m00=(s*P-c*R+l*w)*I,e.m01=(r*R-i*P-a*w)*I,e.m02=(p*E-m*T+v*S)*I,e.m03=(_*T-h*E-f*S)*I,e.m04=(c*b-o*P-l*A)*I,e.m05=(n*P-r*b+a*A)*I,e.m06=(m*x-d*E-v*y)*I,e.m07=(u*E-_*x+f*y)*I,e.m08=(o*R-s*b+l*C)*I,e.m09=(i*b-n*R-a*C)*I,e.m10=(d*T-p*x+v*g)*I,e.m11=(h*x-u*T-f*g)*I,e.m12=(s*A-o*w-c*C)*I,e.m13=(n*w-i*A+r*C)*I,e.m14=(p*y-d*S-m*g)*I,e.m15=(u*S-h*y+_*g)*I,e)}},{key:"determinant",value:function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11,f=e.m12,d=e.m13,p=e.m14,m=e.m15;return(t*o-n*a)*(h*m-_*p)-(t*s-i*a)*(u*m-_*d)+(t*c-r*a)*(u*p-h*d)+(n*s-i*o)*(l*m-_*f)-(n*c-r*o)*(l*p-h*f)+(i*c-r*s)*(l*d-u*f)}},{key:"multiply",value:function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=t.m09,f=t.m10,d=t.m11,p=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,x=n.m01,S=n.m02,T=n.m03;return e.m00=y*i+x*s+S*h+T*p,e.m01=y*r+x*c+S*_+T*m,e.m02=y*a+x*l+S*f+T*v,e.m03=y*o+x*u+S*d+T*g,y=n.m04,x=n.m05,S=n.m06,T=n.m07,e.m04=y*i+x*s+S*h+T*p,e.m05=y*r+x*c+S*_+T*m,e.m06=y*a+x*l+S*f+T*v,e.m07=y*o+x*u+S*d+T*g,y=n.m08,x=n.m09,S=n.m10,T=n.m11,e.m08=y*i+x*s+S*h+T*p,e.m09=y*r+x*c+S*_+T*m,e.m10=y*a+x*l+S*f+T*v,e.m11=y*o+x*u+S*d+T*g,y=n.m12,x=n.m13,S=n.m14,T=n.m15,e.m12=y*i+x*s+S*h+T*p,e.m13=y*r+x*c+S*_+T*m,e.m14=y*a+x*l+S*f+T*v,e.m15=y*o+x*u+S*d+T*g,e}},{key:"transform",value:function(e,t,n){var i=n.x,r=n.y,a=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*a+t.m15;else{var o=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,_=t.m06,f=t.m07,d=t.m08,p=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=o,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=_,e.m07=f,e.m08=d,e.m09=p,e.m10=m,e.m11=v,e.m12=o*i+u*r+d*a+t.m12,e.m13=s*i+h*r+p*a+t.m13,e.m14=c*i+_*r+m*a+t.m14,e.m15=l*i+f*r+v*a+t.m15}return e}},{key:"translate",value:function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,n){var i=n.x,r=n.y,a=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,n,i){var r=i.x,a=i.y,o=i.z,s=Math.sqrt(r*r+a*a+o*o);if(Math.abs(s)<pn)return null;r*=s=1/s,a*=s,o*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,_=t.m01,f=t.m02,d=t.m03,p=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,x=t.m09,S=t.m10,T=t.m11,E=r*r*u+l,C=a*r*u+o*c,A=o*r*u-a*c,b=r*a*u-o*c,w=a*a*u+l,R=o*a*u+r*c,P=r*o*u+a*c,I=a*o*u-r*c,D=o*o*u+l;return e.m00=h*E+p*C+y*A,e.m01=_*E+m*C+x*A,e.m02=f*E+v*C+S*A,e.m03=d*E+g*C+T*A,e.m04=h*b+p*w+y*R,e.m05=_*b+m*w+x*R,e.m06=f*b+v*w+S*R,e.m07=d*b+g*w+T*R,e.m08=h*P+p*I+y*D,e.m09=_*P+m*I+x*D,e.m10=f*P+v*I+S*D,e.m11=d*P+g*I+T*D,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,n){var i=Math.sin(n),r=Math.cos(n),a=t.m04,o=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+l*i,e.m05=o*r+u*i,e.m06=s*r+h*i,e.m07=c*r+_*i,e.m08=l*r-a*i,e.m09=u*r-o*i,e.m10=h*r-s*i,e.m11=_*r-c*i,e}},{key:"rotateY",value:function(e,t,n){var i=Math.sin(n),r=Math.cos(n),a=t.m00,o=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-l*i,e.m01=o*r-u*i,e.m02=s*r-h*i,e.m03=c*r-_*i,e.m08=a*i+l*r,e.m09=o*i+u*r,e.m10=s*i+h*r,e.m11=c*i+_*r,e}},{key:"rotateZ",value:function(e,t,n){var i=Math.sin(n),r=Math.cos(n),a=t.m00,o=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+l*i,e.m01=o*r+u*i,e.m02=s*r+h*i,e.m03=c*r+_*i,e.m04=l*r-a*i,e.m05=u*r-o*i,e.m06=h*r-s*i,e.m07=_*r-c*i,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,n){var i=n.x,r=n.y,a=n.z,o=Math.sqrt(i*i+r*r+a*a);if(Math.abs(o)<pn)return null;i*=o=1/o,r*=o,a*=o;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+a*s,e.m02=a*i*l-r*s,e.m03=0,e.m04=i*r*l-a*s,e.m05=r*r*l+c,e.m06=a*r*l+i*s,e.m07=0,e.m08=i*a*l+r*s,e.m09=r*a*l-i*s,e.m10=a*a*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w,s=i+i,c=r+r,l=a+a,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=a*l,m=o*s,v=o*c,g=o*l;return e.m00=1-(f+p),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+p),e.m06=d+m,e.m07=0,e.m08=_+v,e.m09=d-m,e.m10=1-(u+f),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var n=ni.m00=t.m00,i=ni.m01=t.m01,r=ni.m02=t.m02,a=ni.m03=t.m04,o=ni.m04=t.m05,s=ni.m05=t.m06,c=ni.m06=t.m08,l=ni.m07=t.m09,u=ni.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(a*a+o*o+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Vn.determinant(ni)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e}},{key:"toRTS",value:function(e,t,n,i){i.x=zn.set(ti,e.m00,e.m01,e.m02).length(),ni.m00=e.m00/i.x,ni.m01=e.m01/i.x,ni.m02=e.m02/i.x,i.y=zn.set(ti,e.m04,e.m05,e.m06).length(),ni.m03=e.m04/i.y,ni.m04=e.m05/i.y,ni.m05=e.m06/i.y,i.z=zn.set(ti,e.m08,e.m09,e.m10).length(),ni.m06=e.m08/i.z,ni.m07=e.m09/i.z,ni.m08=e.m10/i.z,Vn.determinant(ni)<0&&(i.x*=-1,ni.m00*=-1,ni.m01*=-1,ni.m02*=-1),qn.fromMat3(t,ni),zn.set(n,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,n,i){var r=t.x,a=t.y,o=t.z,s=t.w,c=r+r,l=a+a,u=o+o,h=r*c,_=r*l,f=r*u,d=a*l,p=a*u,m=o*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,T=i.z;return e.m00=(1-(d+m))*x,e.m01=(_+y)*x,e.m02=(f-g)*x,e.m03=0,e.m04=(_-y)*S,e.m05=(1-(h+m))*S,e.m06=(p+v)*S,e.m07=0,e.m08=(f+g)*T,e.m09=(p-v)*T,e.m10=(1-(h+d))*T,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,n,i,r){var a=t.x,o=t.y,s=t.z,c=t.w,l=a+a,u=o+o,h=s+s,_=a*l,f=a*u,d=a*h,p=o*u,m=o*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,T=i.y,E=i.z,C=r.x,A=r.y,b=r.z;return e.m00=(1-(p+v))*S,e.m01=(f+x)*S,e.m02=(d-y)*S,e.m03=0,e.m04=(f-x)*T,e.m05=(1-(_+v))*T,e.m06=(m+g)*T,e.m07=0,e.m08=(d+y)*E,e.m09=(m-g)*E,e.m10=(1-(_+p))*E,e.m11=0,e.m12=n.x+C-(e.m00*C+e.m04*A+e.m08*b),e.m13=n.y+A-(e.m01*C+e.m05*A+e.m09*b),e.m14=n.z+b-(e.m02*C+e.m06*A+e.m10*b),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w,o=n+n,s=i+i,c=r+r,l=n*o,u=i*o,h=i*s,_=r*o,f=r*s,d=r*c,p=a*o,m=a*s,v=a*c;return e.m00=1-h-d,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-l-d,e.m06=f+p,e.m07=0,e.m08=_+m,e.m09=f-p,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,n,i,r,a,o){var s=1/(n-t),c=1/(r-i),l=1/(a-o);return e.m00=2*a*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(o+a)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=o*a*2*l,e.m15=0,e}},{key:"perspective",value:function(e,t,n,i,r){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:-1,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,l=1/Math.tan(t/2),u=1/(i-r),h=a?l/n:l,_=(a?l:l*n)*s,f=$n[c];return e.m00=h*f[0],e.m01=h*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-o*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-o),e.m15=0,e}},{key:"ortho",value:function(e,t,n,i,r,a,o){var s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:-1,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1,l=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,u=1/(t-n),h=1/(i-r)*c,_=1/(a-o),f=-2*u,d=-2*h,p=(t+n)*u,m=(r+i)*h,v=$n[l];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=d*v[2],e.m05=d*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-s),e.m11=0,e.m12=p*v[0]+m*v[2],e.m13=p*v[1]+m*v[3],e.m14=(a-s*o)*_,e.m15=1,e}},{key:"lookAt",value:function(e,t,n,i){var r=t.x,a=t.y,o=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=a-n.y,_=o-n.z,f=1/Math.sqrt(u*u+h*h+_*_),d=c*(_*=f)-l*(h*=f),p=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(d*d+p*p+m*m))-_*(p*=f),g=_*(d*=f)-u*m,y=u*p-h*d;return e.m00=d,e.m01=v,e.m02=u,e.m03=0,e.m04=p,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(d*r+p*a+m*o),e.m13=-(v*r+g*a+y*o),e.m14=-(u*r+h*a+_*o),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*o,y=n*c-r*o,x=n*l-a*o,S=i*c-r*s,T=i*l-a*s,E=r*l-a*c,C=u*p-h*d,A=u*m-_*d,b=u*v-f*d,w=h*m-_*p,R=h*v-f*p,P=_*v-f*m,I=g*P-y*R+x*w+S*b-T*A+E*C;return I?(I=1/I,e.m00=(s*P-c*R+l*w)*I,e.m01=(c*b-o*P-l*A)*I,e.m02=(o*R-s*b+l*C)*I,e.m03=0,e.m04=(r*R-i*P-a*w)*I,e.m05=(n*P-r*b+a*A)*I,e.m06=(i*b-n*R-a*C)*I,e.m07=0,e.m08=(p*E-m*T+v*S)*I,e.m09=(m*x-d*E-v*y)*I,e.m10=(d*T-p*x+v*g)*I,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"toArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e}},{key:"fromArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e}},{key:"add",value:function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e}},{key:"subtract",value:function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e}},{key:"multiplyScalar",value:function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e}},{key:"multiplyScalarAndAdd",value:function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pn;return Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),n}(xt));ei.IDENTITY=Object.freeze(new ei);var ti=new zn,ni=new Vn;function ii(e,t,n,i,r,a,o,s,c,l,u,h,_,f,d,p){return new ei(e,t,n,i,r,a,o,s,c,l,u,h,_,f,d,p)}un.fastDefine("cc.Mat4",ei,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),c.Mat4=ei,c.mat4=ii;var ri=e("Vec2",function(e){te(n,e);var t=le(n);function n(e,i){var r;return K(this,n),r=t.call(this),e&&"object"===Y(e)?(r.x=e.x,r.y=e.y):(r.x=e||0,r.y=i||0),r}return Z(n,[{key:"clone",value:function(){return new n(this.x,this.y)}},{key:"set",value:function(e,t){return e&&"object"===Y(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pn;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pn;return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this}},{key:"clampf",value:function(e,t){return this.x=gn(this.x,e.x,t.x),this.y=gn(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"add2f",value:function(e,t){return this.x+=e,this.y+=t,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"subtract2f",value:function(e,t){return this.x-=e,this.y-=t,this}},{key:"multiplyScalar",value:function(e){return"object"===Y(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this}},{key:"multiply",value:function(e){return"object"!==Y(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this}},{key:"multiply2f",value:function(e,t){return this.x*=e,this.y*=t,this}},{key:"divide",value:function(e){return this.x/=e.x,this.y/=e.y,this}},{key:"divide2f",value:function(e,t){return this.x/=e,this.y/=t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=gn(i,-1,1),Math.acos(i)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this}}],[{key:"clone",value:function(e){return new n(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,n){return e.x=t,e.y=n,e}},{key:"add",value:function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e}},{key:"subtract",value:function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e}},{key:"multiply",value:function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e}},{key:"divide",value:function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e}},{key:"max",value:function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e}},{key:"scaleAndAdd",value:function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e}},{key:"distance",value:function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)}},{key:"squaredDistance",value:function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i}},{key:"len",value:function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)}},{key:"lengthSqr",value:function(e){var t=e.x,n=e.y;return t*t+n*n}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){var n=t.x,i=t.y;return Math.abs(n)<pn?e.x=0:e.x=1/n,Math.abs(i)<pn?e.y=0:e.y=1/i,e}},{key:"normalize",value:function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,n){return e instanceof zn?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x}},{key:"lerp",value:function(e,t,n,i){var r=t.x,a=t.y;return e.x=r+i*(n.x-r),e.y=a+i*(n.y-a),e}},{key:"random",value:function(e,t){t=t||1;var n=2*En()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e}},{key:"transformMat3",value:function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e}},{key:"transformMat4",value:function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"toArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n+0]=t.x,e[n+1]=t.y,e}},{key:"fromArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[n+0],e.y=t[n+1],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pn;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,t){n.normalize(ai,e),n.normalize(oi,t);var i=n.dot(ai,oi);return i>1?0:i<-1?Math.PI:Math.acos(i)}}]),n}(xt));ri.ZERO=Object.freeze(new ri(0,0)),ri.ONE=Object.freeze(new ri(1,1)),ri.NEG_ONE=Object.freeze(new ri(-1,-1)),ri.UNIT_X=Object.freeze(new ri(1,0)),ri.UNIT_Y=Object.freeze(new ri(0,1));var ai=new ri,oi=new ri;function si(e,t){return new ri(e,t)}un.fastDefine("cc.Vec2",ri,{x:0,y:0}),c.Vec2=ri,c.v2=si;var ci=e("Vec4",function(e){te(n,e);var t=le(n);function n(e,i,r,a){var o;return K(this,n),o=t.call(this),e&&"object"===Y(e)?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=i||0,o.z=r||0,o.w=a||0),o}return Z(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,n,i){return e&&"object"===Y(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pn;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:pn;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i}},{key:"lerp",value:function(e,t){var n=this.x,i=this.y,r=this.z,a=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=a+t*(e.w-a),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=gn(this.x,e.x,t.x),this.y=gn(this.y,e.y,t.y),this.z=gn(this.z,e.z,t.z),this.w=gn(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}},{key:"add4f",value:function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}},{key:"subtract4f",value:function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this}},{key:"multiplyScalar",value:function(e){return"object"===Y(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}},{key:"multiply",value:function(e){return"object"!==Y(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}},{key:"multiply4f",value:function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this}},{key:"divide",value:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}},{key:"divide4f",value:function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,n=this.y,i=this.z,r=e.x,a=e.y,o=e.z;return this.x=n*o-i*a,this.y=i*r-t*o,this.z=t*a-n*r,this}},{key:"length",value:function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)}},{key:"lengthSqr",value:function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i}},{key:"normalize",value:function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this}},{key:"transformMat4",value:function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this}}],[{key:"clone",value:function(e){return new n(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e}},{key:"add",value:function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e}},{key:"subtract",value:function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e}},{key:"multiply",value:function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e}},{key:"divide",value:function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e}},{key:"max",value:function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e}},{key:"scaleAndAdd",value:function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e}},{key:"distance",value:function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+a*a)}},{key:"squaredDistance",value:function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return n*n+i*i+r*r+a*a}},{key:"len",value:function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)}},{key:"lengthSqr",value:function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w;return Math.abs(n)<pn?e.x=0:e.x=1/n,Math.abs(i)<pn?e.y=0:e.y=1/i,Math.abs(r)<pn?e.z=0:e.z=1/r,Math.abs(a)<pn?e.w=0:e.w=1/a,e}},{key:"normalize",value:function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w,o=n*n+i*i+r*r+a*a;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o,e.w=a*o),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var n=2*En()*Math.PI,i=2*En()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w;return e.x=n.m00*i+n.m04*r+n.m08*a+n.m12*o,e.y=n.m01*i+n.m05*r+n.m09*a+n.m13*o,e.z=n.m02*i+n.m06*r+n.m10*a+n.m14*o,e.w=n.m03*i+n.m07*r+n.m11*a+n.m15*o,e}},{key:"transformAffine",value:function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w;return e.x=n.m00*i+n.m01*r+n.m02*a+n.m03*o,e.y=n.m04*i+n.m05*r+n.m06*a+n.m07*o,e.x=n.m08*i+n.m09*r+n.m10*a+n.m11*o,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*a-c*r,h=l*r+c*i-o*a,_=l*a+o*r-s*i,f=-o*i-s*r-c*a;return e.x=u*l+f*-o+h*-c-_*-s,e.y=h*l+f*-s+_*-o-u*-c,e.z=_*l+f*-c+u*-s-h*-o,e.w=t.w,e}},{key:"toArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e}},{key:"fromArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pn;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),n}(xt));function li(e,t,n,i){return new ci(e,t,n,i)}ci.ZERO=Object.freeze(new ci(0,0,0,0)),ci.ONE=Object.freeze(new ci(1,1,1,1)),ci.NEG_ONE=Object.freeze(new ci(-1,-1,-1,-1)),un.fastDefine("cc.Vec4",ci,{x:0,y:0,z:0,w:0}),c.Vec4=ci,c.v4=li,F(ri,"Vec2",[{name:"sub",newName:"subtract",target:ri,targetName:"Vec2"},{name:"mul",newName:"multiply",target:ri,targetName:"Vec2"},{name:"div",newName:"divide",target:ri,targetName:"Vec2"},{name:"dist",newName:"distance",target:ri,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:ri,targetName:"Vec2"},{name:"mag",newName:"len",target:ri,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:ri,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:ri,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:ri,targetName:"Vec2"}]),F(ri.prototype,"Vec2",[{name:"mag",newName:"length",target:ri.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:ri.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:ri.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:ri.prototype,targetName:"Vec2"}]),F(zn,"Vec3",[{name:"sub",newName:"subtract",target:zn,targetName:"Vec3"},{name:"mul",newName:"multiply",target:zn,targetName:"Vec3"},{name:"div",newName:"divide",target:zn,targetName:"Vec3"},{name:"dist",newName:"distance",target:zn,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:zn,targetName:"Vec3"},{name:"mag",newName:"len",target:zn,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:zn,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:zn,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:zn,targetName:"Vec3"}]),F(zn.prototype,"Vec3",[{name:"mag",newName:"length",target:zn.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:zn.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:zn.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:zn.prototype,targetName:"Vec3"}]),F(ci,"Vec4",[{name:"sub",newName:"subtract",target:ci,targetName:"Vec4"},{name:"mul",newName:"multiply",target:ci,targetName:"Vec4"},{name:"div",newName:"divide",target:ci,targetName:"Vec4"},{name:"dist",newName:"distance",target:ci,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:ci,targetName:"Vec4"},{name:"mag",newName:"len",target:ci,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:ci,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ci,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ci,targetName:"Vec4"}]),F(ci.prototype,"Vec4",[{name:"mag",newName:"length",target:ci.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:ci.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ci.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ci.prototype,targetName:"Vec4"}]),F(qn,"Quat",[{name:"mag",newName:"len",target:qn,targetName:"Quat"},{name:"mul",newName:"multiply",target:qn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:qn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:qn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:qn,targetName:"Quat"}]),F(qn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:qn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:qn.prototype,targetName:"Quat"}]),F(Bn,"Color",[{name:"sub",newName:"subtract",target:Bn,targetName:"Color"},{name:"mul",newName:"multiply",target:Bn,targetName:"Color"},{name:"div",newName:"divide",target:Bn,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Bn,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[1].toString(16);return c.Color.fromHEX(t[0],i)}}]),F(Vn,"Mat3",[{name:"sub",newName:"subtract",target:Vn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Vn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Vn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Vn,targetName:"Mat3"}]),F(Vn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Vn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Vn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Vn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Vn.prototype,targetName:"Mat3"}]),F(ei,"Mat4",[{name:"sub",newName:"subtract",target:ei,targetName:"Mat4"},{name:"mul",newName:"multiply",target:ei,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:ei,targetName:"Mat4"}]),F(ei.prototype,"Mat4",[{name:"sub",newName:"subtract",target:ei.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:ei.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:ei.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:ei.prototype,targetName:"Mat4"}]);var ui=e("AffineTransform",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;K(this,e),this.a=t,this.b=n,this.c=i,this.d=r,this.tx=a,this.ty=o}return Z(e,null,[{key:"identity",value:function(){return new e}},{key:"clone",value:function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)}},{key:"concat",value:function(e,t,n){var i=t.a,r=t.b,a=t.c,o=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=a*n.a+o*n.c,e.d=a*n.b+o*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty}},{key:"invert",value:function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,n,i){var r,a;void 0===i?(i=n,r=t.x,a=t.y):(r=t,a=n),e.x=i.a*r+i.c*a+i.tx,e.y=i.b*r+i.d*a+i.ty}},{key:"transformSize",value:function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height}},{key:"transformRect",value:function(e,t,n){var i=t.x+t.width,r=t.y+t.height,a=n.a*t.x+n.c*t.y+n.tx,o=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(a,s,l,h),d=Math.max(a,s,l,h),p=Math.min(o,c,u,_),m=Math.max(o,c,u,_);e.x=f,e.y=p,e.width=d-f,e.height=m-p}},{key:"transformObb",value:function(e,t,n,i,r,a){var o=a.a*r.x+a.c*r.y+a.tx,s=a.b*r.x+a.d*r.y+a.ty,c=a.a*r.width,l=a.b*r.width,u=a.c*r.height,h=a.d*r.height;t.x=o,t.y=s,n.x=c+o,n.y=l+s,e.x=u+o,e.y=h+s,i.x=c+u+o,i.y=l+h+s}}]),e}());c.AffineTransform=ui;var hi=e("Size",function(e){te(n,e);var t=le(n);function n(e,i){var r;return K(this,n),r=t.call(this),e&&"object"===Y(e)?(r.width=e.width,r.height=e.height):(r.width=e||0,r.height=i||0),r}return Z(n,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}},{key:"clone",value:function(){return new n(this.width,this.height)}},{key:"set",value:function(e,t){return e&&"object"===Y(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}],[{key:"lerp",value:function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e}}]),n}(xt));function _i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new hi(e,t)}hi.ZERO=Object.freeze(new hi(0,0)),hi.ONE=Object.freeze(new hi(1,1)),un.fastDefine("cc.Size",hi,{width:0,height:0}),c.size=_i,c.Size=hi;var fi=e("Rect",function(e){te(n,e);var t=le(n);function n(e,i,r,a){var o;return K(this,n),o=t.call(this),e&&"object"===Y(e)?(o.y=e.y,o.width=e.width,o.height=e.height,o.x=e.x):(o.x=e||0,o.y=i||0,o.width=r||0,o.height=a||0),o}return Z(n,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new ri(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new ri(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new hi(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}},{key:"clone",value:function(){return new n(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,t,n,i){return e&&"object"===Y(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){var n=this.x,i=this.y,r=this.width,a=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=a+(e.height-a)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,a=e.m00*t+e.m04*n+e.m12,o=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,_=e.m01*i+e.m05*r+e.m13,f=Math.min(a,s,l,h),d=Math.max(a,s,l,h),p=Math.min(o,c,u,_),m=Math.max(o,c,u,_);return this.x=f,this.y=p,this.width=d-f,this.height=m-p,this}},{key:"transformMat4ToPoints",value:function(e,t,n,i,r){var a=this.x,o=this.y,s=a+this.width,c=o+this.height;t.x=e.m00*a+e.m04*o+e.m12,t.y=e.m01*a+e.m05*o+e.m13,r.x=e.m00*s+e.m04*o+e.m12,r.y=e.m01*s+e.m05*o+e.m13,n.x=e.m00*a+e.m04*c+e.m12,n.y=e.m01*a+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13}}],[{key:"fromMinMax",value:function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),a=Math.max(t.x,n.x),o=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=a-i,e.height=o-r,e}},{key:"lerp",value:function(e,t,n,i){var r=t.x,a=t.y,o=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=a+(n.y-a)*i,e.width=o+(n.width-o)*i,e.height=s+(n.height-s)*i,e}},{key:"intersection",value:function(e,t,n){var i=t.x,r=t.y,a=t.x+t.width,o=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(a,l)-e.x,e.height=Math.min(o,u)-e.y,e}},{key:"union",value:function(e,t,n){var i=t.x,r=t.y,a=t.width,o=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+a,s+l)-e.x,e.height=Math.max(r+o,c+u)-e.y,e}}]),n}(xt));function di(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return new fi(e,t,n,i)}un.fastDefine("cc.Rect",fi,{x:0,y:0,width:0,height:0}),c.Rect=fi,c.rect=di;var pi=e("MATH_FLOAT_ARRAY",Float64Array),mi=e("MathBase",function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"array",get:function(){return this._array}}],[{key:"createFloatArray",value:function(e){return new pi(e)}}]),n}(xt)),vi=Object.freeze({__proto__:null,bits:o,Vec2:ri,v2:si,Vec3:zn,v3:Hn,Vec4:ci,v4:li,Quat:qn,quat:Jn,Mat3:Vn,Mat4:ei,mat4:ii,AffineTransform:ui,Size:hi,size:_i,Rect:fi,rect:di,Color:Bn,color:Fn,EPSILON:pn,equals:mn,approx:vn,clamp:gn,clamp01:yn,lerp:xn,toRadian:Sn,toDegree:Tn,random:En,randomRange:Cn,randomRangeInt:An,pseudoRandom:bn,pseudoRandomRange:wn,pseudoRandomRangeInt:Rn,nextPow2:Pn,repeat:In,pingPong:Dn,inverseLerp:On,absMaxComponent:Nn,absMax:Mn,enumerableProps:kn,MATH_FLOAT_ARRAY:pi,MathBase:mi});e("math",vi);var gi,yi,xi,Si,Ti,Ei,Ci,Ai,bi,wi,Ri,Pi,Ii,Di,Oi,Ni,Mi,ki,Li,Bi,Fi,zi,Ui,Gi,Hi,Vi,ji,Wi,qi,Xi,Yi,Ki,Qi,Zi,Ji,$i,er,tr,nr,ir,rr,ar=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(gi||(gi={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(yi||(yi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(xi||(xi={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(Si||(Si={})),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_SRGB=7]="FORMAT_SRGB",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.FORMAT_RGB8=13]="FORMAT_RGB8",e[e.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=17]="BLEND_MINMAX",e[e.COMPUTE_SHADER=18]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=20]="COUNT"}(Ti||(Ti={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(Ei||(Ei={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Ci||(Ci={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(Ai||(Ai={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(bi||(bi={})),function(e){e[e.NONE=0]="NONE"}(wi||(wi={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(Ri||(Ri={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(Pi||(Pi={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Ii||(Ii={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Di||(Di={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Oi||(Oi={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Ni||(Ni={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(Mi||(Mi={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(ki||(ki={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Li||(Li={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Bi||(Bi={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Fi||(Fi={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(zi||(zi={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Ui||(Ui={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Gi||(Gi={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Hi||(Hi={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(Vi||(Vi={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(ji||(ji={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=3]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=17]="TRANSFER_READ",e[e.HOST_READ=18]="HOST_READ",e[e.PRESENT=19]="PRESENT",e[e.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=25]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",e[e.HOST_WRITE=27]="HOST_WRITE"}(Wi||(Wi={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(qi||(qi={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Xi||(Xi={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Yi||(Yi={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Ki||(Ki={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Qi||(Qi={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Zi||(Zi={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Ji||(Ji={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}($i||($i={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(er||(er={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(tr||(tr={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(nr||(nr={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(ir||(ir={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(rr||(rr={}));var or,sr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;K(this,e),this.x=t,this.y=n,this.z=i}return Z(e,[{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}}]),e}(),cr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,_=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,f=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:1,p=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,m=arguments.length>15&&void 0!==arguments[15]?arguments[15]:0,v=arguments.length>16&&void 0!==arguments[16]?arguments[16]:new sr,g=arguments.length>17&&void 0!==arguments[17]?arguments[17]:new sr,y=arguments.length>18&&void 0!==arguments[18]&&arguments[18],x=arguments.length>19&&void 0!==arguments[19]?arguments[19]:-1,S=arguments.length>20&&void 0!==arguments[20]?arguments[20]:1,T=arguments.length>21&&void 0!==arguments[21]?arguments[21]:1;K(this,e),this.maxVertexAttributes=t,this.maxVertexUniformVectors=n,this.maxFragmentUniformVectors=i,this.maxTextureUnits=r,this.maxImageUnits=a,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=s,this.maxShaderStorageBufferBindings=c,this.maxShaderStorageBlockSize=l,this.maxUniformBufferBindings=u,this.maxUniformBlockSize=h,this.maxTextureSize=_,this.maxCubeMapTextureSize=f,this.uboOffsetAlignment=d,this.maxComputeSharedMemorySize=p,this.maxComputeWorkGroupInvocations=m,this.maxComputeWorkGroupSize=v,this.maxComputeWorkGroupCount=g,this.supportQuery=y,this.clipSpaceMinZ=x,this.screenSpaceSignY=S,this.clipSpaceSignY=T}return Z(e,[{key:"copy",value:function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this}}]),e}(),lr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;K(this,e),this.x=t,this.y=n,this.z=i}return Z(e,[{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}}]),e}(),ur=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;K(this,e),this.x=t,this.y=n,this.width=i,this.height=r}return Z(e,[{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}}]),e}(),hr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;K(this,e),this.width=t,this.height=n,this.depth=i}return Z(e,[{key:"copy",value:function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this}}]),e}(),_r=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;K(this,e),this.mipLevel=t,this.baseArrayLayer=n,this.layerCount=i}return Z(e,[{key:"copy",value:function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this}}]),e}(),fr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;K(this,e),this.baseMipLevel=t,this.levelCount=n,this.baseArrayLayer=i,this.layerCount=r}return Z(e,[{key:"copy",value:function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this}}]),e}(),dr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new _r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new lr,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new _r,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new lr,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new hr;K(this,e),this.srcSubres=t,this.srcOffset=n,this.dstSubres=i,this.dstOffset=r,this.extent=a}return Z(e,[{key:"copy",value:function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this}}]),e}(),pr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new _r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new lr,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new hr,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new _r,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new lr,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new hr;K(this,e),this.srcSubres=t,this.srcOffset=n,this.srcExtent=i,this.dstSubres=r,this.dstOffset=a,this.dstExtent=o}return Z(e,[{key:"copy",value:function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this}}]),e}(),mr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new lr,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new hr,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new _r;K(this,e),this.buffStride=t,this.buffTexHeight=n,this.texOffset=i,this.texExtent=r,this.texSubres=a}return Z(e,[{key:"copy",value:function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this}}]),e}(),vr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;K(this,e),this.left=t,this.top=n,this.width=i,this.height=r,this.minDepth=a,this.maxDepth=o}return Z(e,[{key:"copy",value:function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this}}]),e}(),gr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;K(this,e),this.x=t,this.y=n,this.z=i,this.w=r}return Z(e,[{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}}]),e}(),yr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;K(this,e),this.bufferOffsets=t,this.samplerOffsets=n,this.flexibleSet=i}return Z(e,[{key:"copy",value:function(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this}}]),e}(),xr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Mi.ON,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;K(this,e),this.windowHandle=t,this.vsyncMode=n,this.width=i,this.height=r}return Z(e,[{key:"copy",value:function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this}}]),e}(),Sr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new yr;K(this,e),this.bindingMappingInfo=t}return Z(e,[{key:"copy",value:function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this}}]),e}(),Tr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bi.NONE,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Pi.NONE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:wi.NONE;K(this,e),this.usage=t,this.memUsage=n,this.size=i,this.stride=r,this.flags=a}return Z(e,[{key:"copy",value:function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this}}]),e}(),Er=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;K(this,e),this.buffer=t,this.offset=n,this.range=i}return Z(e,[{key:"copy",value:function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this}}]),e}(),Cr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;K(this,e),this.vertexCount=t,this.firstVertex=n,this.indexCount=i,this.firstIndex=r,this.vertexOffset=a,this.instanceCount=o,this.firstInstance=s}return Z(e,[{key:"copy",value:function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this}}]),e}(),Ar=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;K(this,e),this.groupCountX=t,this.groupCountY=n,this.groupCountZ=i,this.indirectBuffer=r,this.indirectOffset=a}return Z(e,[{key:"copy",value:function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this}}]),e}(),br=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];K(this,e),this.drawInfos=t}return Z(e,[{key:"copy",value:function(e){return ar(this.drawInfos,e.drawInfos,Cr),this}}]),e}(),wr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ii.TEX2D,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Di.NONE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ei.UNKNOWN,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Oi.NONE,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:Ni.ONE,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:1,h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0;K(this,e),this.type=t,this.usage=n,this.format=i,this.width=r,this.height=a,this.flags=o,this.layerCount=s,this.levelCount=c,this.samples=l,this.depth=u,this.externalRes=h}return Z(e,[{key:"copy",value:function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this}}]),e}(),Rr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ii.TEX2D,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ei.UNKNOWN,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;K(this,e),this.texture=t,this.type=n,this.format=i,this.baseLevel=r,this.levelCount=a,this.baseLayer=o,this.layerCount=s}return Z(e,[{key:"copy",value:function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this}}]),e}(),Pr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ki.LINEAR,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ki.LINEAR,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ki.NONE,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Li.WRAP,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Li.WRAP,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Li.WRAP,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Bi.ALWAYS;K(this,e),this.minFilter=t,this.magFilter=n,this.mipFilter=i,this.addressU=r,this.addressV=a,this.addressW=o,this.maxAnisotropy=s,this.cmpFunc=c}return Z(e,[{key:"copy",value:function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this}}]),e}(),Ir=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ai.UNKNOWN,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;K(this,e),this.name=t,this.type=n,this.count=i}return Z(e,[{key:"copy",value:function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this}}]),e}(),Dr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;K(this,e),this.set=t,this.binding=n,this.name=i,this.members=r,this.count=a}return Z(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,ar(this.members,e.members,Ir),this.count=e.count,this}}]),e}(),Or=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ai.UNKNOWN,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;K(this,e),this.set=t,this.binding=n,this.name=i,this.type=r,this.count=a}return Z(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this}}]),e}(),Nr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;K(this,e),this.set=t,this.binding=n,this.name=i,this.count=r}return Z(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this}}]),e}(),Mr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ai.UNKNOWN,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;K(this,e),this.set=t,this.binding=n,this.name=i,this.type=r,this.count=a}return Z(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this}}]),e}(),kr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ai.UNKNOWN,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Ri.READ_WRITE;K(this,e),this.set=t,this.binding=n,this.name=i,this.type=r,this.count=a,this.memoryAccess=o}return Z(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this}}]),e}(),Lr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ri.READ_WRITE;K(this,e),this.set=t,this.binding=n,this.name=i,this.count=r,this.memoryAccess=a}return Z(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this}}]),e}(),Br=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;K(this,e),this.set=t,this.binding=n,this.name=i,this.count=r}return Z(e,[{key:"copy",value:function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this}}]),e}(),Fr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Hi.NONE,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";K(this,e),this.stage=t,this.source=n}return Z(e,[{key:"copy",value:function(e){return this.stage=e.stage,this.source=e.source,this}}]),e}(),zr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ei.UNKNOWN,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;K(this,e),this.name=t,this.format=n,this.isNormalized=i,this.stream=r,this.isInstanced=a,this.location=o}return Z(e,[{key:"copy",value:function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this}}]),e}(),Ur=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[],c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:[],l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:[],u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:[];K(this,e),this.name=t,this.stages=n,this.attributes=i,this.blocks=r,this.buffers=a,this.samplerTextures=o,this.samplers=s,this.textures=c,this.images=l,this.subpassInputs=u}return Z(e,[{key:"copy",value:function(e){return this.name=e.name,ar(this.stages,e.stages,Fr),ar(this.attributes,e.attributes,zr),ar(this.blocks,e.blocks,Dr),ar(this.buffers,e.buffers,Lr),ar(this.samplerTextures,e.samplerTextures,Or),ar(this.samplers,e.samplers,Nr),ar(this.textures,e.textures,Mr),ar(this.images,e.images,kr),ar(this.subpassInputs,e.subpassInputs,Br),this}}]),e}(),Gr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;K(this,e),this.attributes=t,this.vertexBuffers=n,this.indexBuffer=i,this.indirectBuffer=r}return Z(e,[{key:"copy",value:function(e){return ar(this.attributes,e.attributes,zr),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this}}]),e}(),Hr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ei.UNKNOWN,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ni.ONE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Vi.CLEAR,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ji.STORE,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[Wi.COLOR_ATTACHMENT_WRITE],s=arguments.length>6&&void 0!==arguments[6]&&arguments[6];K(this,e),this.format=t,this.sampleCount=n,this.loadOp=i,this.storeOp=r,this.beginAccesses=a,this.endAccesses=o,this.isGeneralLayout=s}return Z(e,[{key:"copy",value:function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this}}]),e}(),Vr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ei.UNKNOWN,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ni.ONE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Vi.CLEAR,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ji.STORE,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Vi.CLEAR,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:ji.STORE,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[],c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:[Wi.DEPTH_STENCIL_ATTACHMENT_WRITE],l=arguments.length>8&&void 0!==arguments[8]&&arguments[8];K(this,e),this.format=t,this.sampleCount=n,this.depthLoadOp=i,this.depthStoreOp=r,this.stencilLoadOp=a,this.stencilStoreOp=o,this.beginAccesses=s,this.endAccesses=c,this.isGeneralLayout=l}return Z(e,[{key:"copy",value:function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this}}]),e}(),jr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:-1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:qi.NONE,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:qi.NONE;K(this,e),this.inputs=t,this.colors=n,this.resolves=i,this.preserves=r,this.depthStencil=a,this.depthStencilResolve=o,this.depthResolveMode=s,this.stencilResolveMode=c}return Z(e,[{key:"copy",value:function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this}}]),e}(),Wr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];K(this,e),this.srcSubpass=t,this.dstSubpass=n,this.srcAccesses=i,this.dstAccesses=r}return Z(e,[{key:"copy",value:function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.srcAccesses=e.srcAccesses.slice(),this.dstAccesses=e.dstAccesses.slice(),this}}]),e}(),qr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Vr,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];K(this,e),this.colorAttachments=t,this.depthStencilAttachment=n,this.subpasses=i,this.dependencies=r}return Z(e,[{key:"copy",value:function(e){return ar(this.colorAttachments,e.colorAttachments,Hr),this.depthStencilAttachment.copy(e.depthStencilAttachment),ar(this.subpasses,e.subpasses,jr),ar(this.dependencies,e.dependencies,Wr),this}}]),e}(),Xr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];K(this,e),this.prevAccesses=t,this.nextAccesses=n}return Z(e,[{key:"copy",value:function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this}}]),e}(),Yr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;K(this,e),this.prevAccesses=t,this.nextAccesses=n,this.discardContents=i,this.srcQueue=r,this.dstQueue=a}return Z(e,[{key:"copy",value:function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this}}]),e}(),Kr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;K(this,e),this.renderPass=t,this.colorTextures=n,this.depthStencilTexture=i}return Z(e,[{key:"copy",value:function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this}}]),e}(),Qr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:er.UNKNOWN,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Hi.NONE,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];K(this,e),this.binding=t,this.descriptorType=n,this.count=i,this.stageFlags=r,this.immutableSamplers=a}return Z(e,[{key:"copy",value:function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this}}]),e}(),Zr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];K(this,e),this.bindings=t}return Z(e,[{key:"copy",value:function(e){return ar(this.bindings,e.bindings,Qr),this}}]),e}(),Jr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;K(this,e),this.layout=t}return Z(e,[{key:"copy",value:function(e){return this.layout=e.layout,this}}]),e}(),$r=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];K(this,e),this.setLayouts=t}return Z(e,[{key:"copy",value:function(e){return this.setLayouts=e.setLayouts.slice(),this}}]),e}(),ea=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];K(this,e),this.attributes=t}return Z(e,[{key:"copy",value:function(e){return ar(this.attributes,e.attributes,zr),this}}]),e}(),ta=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ir.PRIMARY;K(this,e),this.queue=t,this.type=n}return Z(e,[{key:"copy",value:function(e){return this.queue=e.queue,this.type=e.type,this}}]),e}(),na=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:tr.GRAPHICS;K(this,e),this.type=t}return Z(e,[{key:"copy",value:function(e){return this.type=e.type,this}}]),e}(),ia=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:nr.OCCLUSION,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:65536,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];K(this,e),this.type=t,this.maxQueryObjects=n,this.forceWait=i}return Z(e,[{key:"copy",value:function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this}}]),e}(),ra=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ci.NONE,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=arguments.length>6&&void 0!==arguments[6]&&arguments[6],c=arguments.length>7&&void 0!==arguments[7]&&arguments[7];K(this,e),this.name=t,this.size=n,this.count=i,this.type=r,this.hasAlpha=a,this.hasDepth=o,this.hasStencil=s,this.isCompressed=c},aa=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;K(this,e),this.bufferSize=t,this.textureSize=n}return Z(e,[{key:"copy",value:function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this}}]),e}(),oa=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;K(this,e),this.writeMask=t,this.compareMask=n,this.reference=i}return Z(e,[{key:"copy",value:function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this}}]),e}(),sa=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new vr,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new ur,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new gr,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:new oa,h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:new oa;K(this,e),this.viewport=t,this.scissor=n,this.blendConstant=i,this.lineWidth=r,this.depthBiasConstant=a,this.depthBiasClamp=o,this.depthBiasSlope=s,this.depthMinBounds=c,this.depthMaxBounds=l,this.stencilStatesFront=u,this.stencilStatesBack=h}return Z(e,[{key:"copy",value:function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this}}]),e}(),ca=function(){function e(t){K(this,e),this._objectType=gi.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=t,this._objectID=e._idTable[gi.UNKNOWN]++,this._typedID=e._idTable[t]++}return Z(e,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),e}();ca._idTable=Array(gi.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(or||(or={}));var la=Object.freeze([new ra("UNKNOWN",0,0,Ci.NONE,!1,!1,!1,!1),new ra("A8",1,1,Ci.UNORM,!0,!1,!1,!1),new ra("L8",1,1,Ci.UNORM,!1,!1,!1,!1),new ra("LA8",1,2,Ci.UNORM,!0,!1,!1,!1),new ra("R8",1,1,Ci.UNORM,!1,!1,!1,!1),new ra("R8SN",1,1,Ci.SNORM,!1,!1,!1,!1),new ra("R8UI",1,1,Ci.UINT,!1,!1,!1,!1),new ra("R8I",1,1,Ci.INT,!1,!1,!1,!1),new ra("R16F",2,1,Ci.FLOAT,!1,!1,!1,!1),new ra("R16UI",2,1,Ci.UINT,!1,!1,!1,!1),new ra("R16I",2,1,Ci.INT,!1,!1,!1,!1),new ra("R32F",4,1,Ci.FLOAT,!1,!1,!1,!1),new ra("R32UI",4,1,Ci.UINT,!1,!1,!1,!1),new ra("R32I",4,1,Ci.INT,!1,!1,!1,!1),new ra("RG8",2,2,Ci.UNORM,!1,!1,!1,!1),new ra("RG8SN",2,2,Ci.SNORM,!1,!1,!1,!1),new ra("RG8UI",2,2,Ci.UINT,!1,!1,!1,!1),new ra("RG8I",2,2,Ci.INT,!1,!1,!1,!1),new ra("RG16F",4,2,Ci.FLOAT,!1,!1,!1,!1),new ra("RG16UI",4,2,Ci.UINT,!1,!1,!1,!1),new ra("RG16I",4,2,Ci.INT,!1,!1,!1,!1),new ra("RG32F",8,2,Ci.FLOAT,!1,!1,!1,!1),new ra("RG32UI",8,2,Ci.UINT,!1,!1,!1,!1),new ra("RG32I",8,2,Ci.INT,!1,!1,!1,!1),new ra("RGB8",3,3,Ci.UNORM,!1,!1,!1,!1),new ra("SRGB8",3,3,Ci.UNORM,!1,!1,!1,!1),new ra("RGB8SN",3,3,Ci.SNORM,!1,!1,!1,!1),new ra("RGB8UI",3,3,Ci.UINT,!1,!1,!1,!1),new ra("RGB8I",3,3,Ci.INT,!1,!1,!1,!1),new ra("RGB16F",6,3,Ci.FLOAT,!1,!1,!1,!1),new ra("RGB16UI",6,3,Ci.UINT,!1,!1,!1,!1),new ra("RGB16I",6,3,Ci.INT,!1,!1,!1,!1),new ra("RGB32F",12,3,Ci.FLOAT,!1,!1,!1,!1),new ra("RGB32UI",12,3,Ci.UINT,!1,!1,!1,!1),new ra("RGB32I",12,3,Ci.INT,!1,!1,!1,!1),new ra("RGBA8",4,4,Ci.UNORM,!0,!1,!1,!1),new ra("BGRA8",4,4,Ci.UNORM,!0,!1,!1,!1),new ra("SRGB8_A8",4,4,Ci.UNORM,!0,!1,!1,!1),new ra("RGBA8SN",4,4,Ci.SNORM,!0,!1,!1,!1),new ra("RGBA8UI",4,4,Ci.UINT,!0,!1,!1,!1),new ra("RGBA8I",4,4,Ci.INT,!0,!1,!1,!1),new ra("RGBA16F",8,4,Ci.FLOAT,!0,!1,!1,!1),new ra("RGBA16UI",8,4,Ci.UINT,!0,!1,!1,!1),new ra("RGBA16I",8,4,Ci.INT,!0,!1,!1,!1),new ra("RGBA32F",16,4,Ci.FLOAT,!0,!1,!1,!1),new ra("RGBA32UI",16,4,Ci.UINT,!0,!1,!1,!1),new ra("RGBA32I",16,4,Ci.INT,!0,!1,!1,!1),new ra("R5G6B5",2,3,Ci.UNORM,!1,!1,!1,!1),new ra("R11G11B10F",4,3,Ci.FLOAT,!1,!1,!1,!1),new ra("RGB5A1",2,4,Ci.UNORM,!0,!1,!1,!1),new ra("RGBA4",2,4,Ci.UNORM,!0,!1,!1,!1),new ra("RGB10A2",2,4,Ci.UNORM,!0,!1,!1,!1),new ra("RGB10A2UI",2,4,Ci.UINT,!0,!1,!1,!1),new ra("RGB9E5",2,4,Ci.FLOAT,!0,!1,!1,!1),new ra("DEPTH",4,1,Ci.FLOAT,!1,!0,!1,!1),new ra("DEPTH_STENCIL",5,2,Ci.FLOAT,!1,!0,!0,!1),new ra("BC1",1,3,Ci.UNORM,!1,!1,!1,!0),new ra("BC1_ALPHA",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("BC1_SRGB",1,3,Ci.UNORM,!1,!1,!1,!0),new ra("BC1_SRGB_ALPHA",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("BC2",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("BC2_SRGB",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("BC3",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("BC3_SRGB",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("BC4",1,1,Ci.UNORM,!1,!1,!1,!0),new ra("BC4_SNORM",1,1,Ci.SNORM,!1,!1,!1,!0),new ra("BC5",1,2,Ci.UNORM,!1,!1,!1,!0),new ra("BC5_SNORM",1,2,Ci.SNORM,!1,!1,!1,!0),new ra("BC6H_UF16",1,3,Ci.UFLOAT,!1,!1,!1,!0),new ra("BC6H_SF16",1,3,Ci.FLOAT,!1,!1,!1,!0),new ra("BC7",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("BC7_SRGB",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ETC_RGB8",1,3,Ci.UNORM,!1,!1,!1,!0),new ra("ETC2_RGB8",1,3,Ci.UNORM,!1,!1,!1,!0),new ra("ETC2_SRGB8",1,3,Ci.UNORM,!1,!1,!1,!0),new ra("ETC2_RGB8_A1",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ETC2_SRGB8_A1",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ETC2_RGBA8",2,4,Ci.UNORM,!0,!1,!1,!0),new ra("ETC2_SRGB8_A8",2,4,Ci.UNORM,!0,!1,!1,!0),new ra("EAC_R11",1,1,Ci.UNORM,!1,!1,!1,!0),new ra("EAC_R11SN",1,1,Ci.SNORM,!1,!1,!1,!0),new ra("EAC_RG11",2,2,Ci.UNORM,!1,!1,!1,!0),new ra("EAC_RG11SN",2,2,Ci.SNORM,!1,!1,!1,!0),new ra("PVRTC_RGB2",2,3,Ci.UNORM,!1,!1,!1,!0),new ra("PVRTC_RGBA2",2,4,Ci.UNORM,!0,!1,!1,!0),new ra("PVRTC_RGB4",2,3,Ci.UNORM,!1,!1,!1,!0),new ra("PVRTC_RGBA4",2,4,Ci.UNORM,!0,!1,!1,!0),new ra("PVRTC2_2BPP",2,4,Ci.UNORM,!0,!1,!1,!0),new ra("PVRTC2_4BPP",2,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_4x4",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_5x4",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_5x5",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_6x5",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_6x6",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_8x5",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_8x6",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_8x8",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_10x5",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_10x6",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_10x8",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_10x10",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_12x10",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_RGBA_12x12",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_4x4",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_5x4",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_5x5",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_6x5",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_6x6",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_8x5",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_8x6",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_8x8",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_10x5",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_10x6",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_10x8",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_10x10",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_12x10",1,4,Ci.UNORM,!0,!1,!1,!0),new ra("ASTC_SRGBA_12x12",1,4,Ci.UNORM,!0,!1,!1,!0)]),ua=er.UNIFORM_BUFFER|er.DYNAMIC_UNIFORM_BUFFER|er.STORAGE_BUFFER|er.DYNAMIC_STORAGE_BUFFER,ha=er.SAMPLER_TEXTURE|er.SAMPLER|er.TEXTURE|er.STORAGE_IMAGE|er.INPUT_ATTACHMENT,_a=er.DYNAMIC_STORAGE_BUFFER|er.DYNAMIC_UNIFORM_BUFFER;function fa(e){return e>0&&0==(e&e-1)}function da(e,t,n,i){if(!la[e].isCompressed)return t*n*i*la[e].size;switch(e){case Ei.BC1:case Ei.BC1_ALPHA:case Ei.BC1_SRGB:case Ei.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Ei.BC2:case Ei.BC2_SRGB:case Ei.BC3:case Ei.BC3_SRGB:case Ei.BC4:case Ei.BC4_SNORM:case Ei.BC6H_SF16:case Ei.BC6H_UF16:case Ei.BC7:case Ei.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Ei.BC5:case Ei.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case Ei.ETC_RGB8:case Ei.ETC2_RGB8:case Ei.ETC2_SRGB8:case Ei.ETC2_RGB8_A1:case Ei.EAC_R11:case Ei.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Ei.ETC2_RGBA8:case Ei.ETC2_SRGB8_A1:case Ei.EAC_RG11:case Ei.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Ei.PVRTC_RGB2:case Ei.PVRTC_RGBA2:case Ei.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case Ei.PVRTC_RGB4:case Ei.PVRTC_RGBA4:case Ei.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case Ei.ASTC_RGBA_4X4:case Ei.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Ei.ASTC_RGBA_5X4:case Ei.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case Ei.ASTC_RGBA_5X5:case Ei.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case Ei.ASTC_RGBA_6X5:case Ei.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case Ei.ASTC_RGBA_6X6:case Ei.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case Ei.ASTC_RGBA_8X5:case Ei.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case Ei.ASTC_RGBA_8X6:case Ei.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case Ei.ASTC_RGBA_8X8:case Ei.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case Ei.ASTC_RGBA_10X5:case Ei.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case Ei.ASTC_RGBA_10X6:case Ei.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case Ei.ASTC_RGBA_10X8:case Ei.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case Ei.ASTC_RGBA_10X10:case Ei.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case Ei.ASTC_RGBA_12X10:case Ei.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case Ei.ASTC_RGBA_12X12:case Ei.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function pa(e,t,n,i,r){for(var a=0,o=0;o<r;++o)a+=da(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return a}var ma=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function va(e){return ma[e]||0}function ga(e){var t=e.size/e.count;switch(e.type){case Ci.UNORM:case Ci.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Ci.SNORM:case Ci.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Ci.FLOAT:return Float32Array}return Float32Array}var ya=Object.freeze({__proto__:null,get ObjectType(){return gi},get Status(){return yi},get API(){return xi},get SurfaceTransform(){return Si},get Feature(){return Ti},get Format(){return Ei},get FormatType(){return Ci},get Type(){return Ai},get BufferUsageBit(){return bi},get BufferFlagBit(){return wi},get MemoryAccessBit(){return Ri},get MemoryUsageBit(){return Pi},get TextureType(){return Ii},get TextureUsageBit(){return Di},get TextureFlagBit(){return Oi},get SampleCount(){return Ni},get VsyncMode(){return Mi},get Filter(){return ki},get Address(){return Li},get ComparisonFunc(){return Bi},get StencilOp(){return Fi},get BlendFactor(){return zi},get BlendOp(){return Ui},get ColorMask(){return Gi},get ShaderStageFlagBit(){return Hi},get LoadOp(){return Vi},get StoreOp(){return ji},get AccessType(){return Wi},get ResolveMode(){return qi},get PipelineBindPoint(){return Xi},get PrimitiveMode(){return Yi},get PolygonMode(){return Ki},get ShadeModel(){return Qi},get CullMode(){return Zi},get DynamicStateFlagBit(){return Ji},get StencilFace(){return $i},get DescriptorType(){return er},get QueueType(){return tr},get QueryType(){return nr},get CommandBufferType(){return ir},get ClearFlagBit(){return rr},Size:sr,DeviceCaps:cr,Offset:lr,Rect:ur,Extent:hr,TextureSubresLayers:_r,TextureSubresRange:fr,TextureCopy:dr,TextureBlit:pr,BufferTextureCopy:mr,Viewport:vr,Color:gr,BindingMappingInfo:yr,SwapchainInfo:xr,DeviceInfo:Sr,BufferInfo:Tr,BufferViewInfo:Er,DrawInfo:Cr,DispatchInfo:Ar,IndirectBuffer:br,TextureInfo:wr,TextureViewInfo:Rr,SamplerInfo:Pr,Uniform:Ir,UniformBlock:Dr,UniformSamplerTexture:Or,UniformSampler:Nr,UniformTexture:Mr,UniformStorageImage:kr,UniformStorageBuffer:Lr,UniformInputAttachment:Br,ShaderStage:Fr,Attribute:zr,ShaderInfo:Ur,InputAssemblerInfo:Gr,ColorAttachment:Hr,DepthStencilAttachment:Vr,SubpassInfo:jr,SubpassDependency:Wr,RenderPassInfo:qr,GlobalBarrierInfo:Xr,TextureBarrierInfo:Yr,FramebufferInfo:Kr,DescriptorSetLayoutBinding:Qr,DescriptorSetLayoutInfo:Zr,DescriptorSetInfo:Jr,PipelineLayoutInfo:$r,InputState:ea,CommandBufferInfo:ta,QueueInfo:na,QueryPoolInfo:ia,FormatInfo:ra,MemoryStatus:aa,DynamicStencilStates:oa,DynamicStates:sa,GFXObject:ca,get AttributeName(){return or},FormatInfos:la,DESCRIPTOR_BUFFER_TYPE:ua,DESCRIPTOR_SAMPLER_TYPE:ha,DESCRIPTOR_DYNAMIC_TYPE:_a,DRAW_INFO_SIZE:28,IsPowerOf2:fa,FormatSize:da,FormatSurfaceSize:pa,GetTypeSize:va,getTypedArrayConstructor:ga}),xa=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.BUFFER))._usage=bi.NONE,e._memUsage=Pi.NONE,e._size=0,e._stride=1,e._count=0,e._flags=wi.NONE,e._isBufferView=!1,e}return Z(n,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),n}(ca),Sa=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.COMMAND_BUFFER))._queue=null,e._type=ir.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}return Z(n,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),n}(ca),Ta=function(){function e(){K(this,e),this._gfxAPI=xi.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(Ti.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new aa,this._caps=new cr,this._bindingMappingInfo=new yr,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return Z(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"hasFeature",value:function(e){return this._features[e]}}]),e}();Ta.canvas=void 0;var Ea=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.SWAPCHAIN))._transform=Si.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}return Z(n,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),n}(ca),Ca=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.FRAMEBUFFER))._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}return Z(n,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),n}(ca),Aa=String.prototype.charCodeAt;function ba(e){return this[e]}function wa(e,t){for(var n=e.length,i=t^n,r=0,a="string"==typeof e?Aa:ba;n>=4;){var o=255&a.call(e,r)|(255&a.call(e,++r))<<8|(255&a.call(e,++r))<<16|(255&a.call(e,++r))<<24;o=1540483477*(65535&o)+((1540483477*(o>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(o=1540483477*(65535&(o^=o>>>24))+((1540483477*(o>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&a.call(e,r+2))<<16;case 2:i^=(255&a.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&a.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var Ra=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.INPUT_ASSEMBLER))._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new Cr,e}return Z(n,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}},{key:"getVertexBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}},{key:"computeAttributesHash",value:function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=",".concat(n.name,",").concat(n.format,",").concat(n.isNormalized,",").concat(n.stream,",").concat(n.isInstanced)}return wa(e,666)}}]),n}(ca),Pa=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.DESCRIPTOR_SET))._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}return Z(n,[{key:"layout",get:function(){return this._layout}},{key:"bindBuffer",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ua){var a=this._layout.descriptorIndices[e];this._buffers[a+n]!==t&&(this._buffers[a+n]=t,this._isDirty=!0)}}},{key:"bindSampler",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ha){var a=this._layout.descriptorIndices[e];this._samplers[a+n]!==t&&(this._samplers[a+n]=t,this._isDirty=!0)}}},{key:"bindTexture",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ha){var a=this._layout.descriptorIndices[e];this._textures[a+n]!==t&&(this._textures[a+n]=t,this._isDirty=!0)}}},{key:"getBuffer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._layout.descriptorIndices[e];return this._buffers[n+t]}},{key:"getSampler",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._layout.descriptorIndices[e];return this._samplers[n+t]}},{key:"getTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._layout.descriptorIndices[e];return this._textures[n+t]}}]),n}(ca),Ia=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.DESCRIPTOR_SET_LAYOUT))._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}return Z(n,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),n}(ca),Da=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.PIPELINE_LAYOUT))._setLayouts=[],e}return Z(n,[{key:"setLayouts",get:function(){return this._setLayouts}}]),n}(ca),Oa=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ki.FILL,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Qi.GOURAND,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Zi.BACK,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=!(arguments.length>9&&void 0!==arguments[9])||arguments[9],h=arguments.length>10&&void 0!==arguments[10]&&arguments[10],_=arguments.length>11&&void 0!==arguments[11]?arguments[11]:1;K(this,e),this.isDiscard=t,this.polygonMode=n,this.shadeModel=i,this.cullMode=r,this.isFrontFaceCCW=a,this.depthBiasEnabled=o,this.depthBias=s,this.depthBiasClamp=c,this.depthBiasSlop=l,this.isDepthClip=u,this.isMultisample=h,this.lineWidth=_}return Z(e,[{key:"native",get:function(){return this}},{key:"reset",value:function(){this.isDiscard=!1,this.polygonMode=Ki.FILL,this.shadeModel=Qi.GOURAND,this.cullMode=Zi.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}},{key:"assign",value:function(e){Object.assign(this,e)}},{key:"destroy",value:function(){}}]),e}(),Na=function(){function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Bi.LESS,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Bi.ALWAYS,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:65535,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:65535,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Fi.KEEP,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:Fi.KEEP,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:Fi.KEEP,h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,_=arguments.length>11&&void 0!==arguments[11]&&arguments[11],f=arguments.length>12&&void 0!==arguments[12]?arguments[12]:Bi.ALWAYS,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:65535,p=arguments.length>14&&void 0!==arguments[14]?arguments[14]:65535,m=arguments.length>15&&void 0!==arguments[15]?arguments[15]:Fi.KEEP,v=arguments.length>16&&void 0!==arguments[16]?arguments[16]:Fi.KEEP,g=arguments.length>17&&void 0!==arguments[17]?arguments[17]:Fi.KEEP,y=arguments.length>18&&void 0!==arguments[18]?arguments[18]:1;K(this,e),this.depthTest=t,this.depthWrite=n,this.depthFunc=i,this.stencilTestFront=r,this.stencilFuncFront=a,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=s,this.stencilFailOpFront=c,this.stencilZFailOpFront=l,this.stencilPassOpFront=u,this.stencilRefFront=h,this.stencilTestBack=_,this.stencilFuncBack=f,this.stencilReadMaskBack=d,this.stencilWriteMaskBack=p,this.stencilFailOpBack=m,this.stencilZFailOpBack=v,this.stencilPassOpBack=g,this.stencilRefBack=y}return Z(e,[{key:"native",get:function(){return this}},{key:"reset",value:function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Bi.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Bi.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Fi.KEEP,this.stencilZFailOpFront=Fi.KEEP,this.stencilPassOpFront=Fi.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Bi.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Fi.KEEP,this.stencilZFailOpBack=Fi.KEEP,this.stencilPassOpBack=Fi.KEEP,this.stencilRefBack=1}},{key:"assign",value:function(e){Object.assign(this,e)}},{key:"destroy",value:function(){}}]),e}(),Ma=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:zi.ONE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:zi.ZERO,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ui.ADD,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:zi.ONE,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:zi.ZERO,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:Ui.ADD,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Gi.ALL;K(this,e),this.blend=t,this.blendSrc=n,this.blendDst=i,this.blendEq=r,this.blendSrcAlpha=a,this.blendDstAlpha=o,this.blendAlphaEq=s,this.blendColorMask=c}return Z(e,[{key:"reset",value:function(){this.blend=!1,this.blendSrc=zi.ONE,this.blendDst=zi.ZERO,this.blendEq=Ui.ADD,this.blendSrcAlpha=zi.ONE,this.blendDstAlpha=zi.ZERO,this.blendAlphaEq=Ui.ADD,this.blendColorMask=Gi.ALL}},{key:"assign",value:function(e){Object.assign(this,e)}},{key:"destroy",value:function(){}}]),e}(),ka=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new gr,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[new Ma];K(this,e),this.isA2C=t,this.isIndepend=n,this.blendColor=i,this.targets=r}return Z(e,[{key:"native",get:function(){return this}},{key:"setTarget",value:function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new Ma),Object.assign(n,t)}},{key:"reset",value:function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()}},{key:"destroy",value:function(){}}]),e}(),La=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new ea,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Oa,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new Na,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:new ka,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Yi.TRIANGLE_LIST,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:Ji.NONE,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:Xi.GRAPHICS;K(this,e),this.shader=t,this.pipelineLayout=n,this.renderPass=i,this.inputState=r,this.rasterizerState=a,this.depthStencilState=o,this.blendState=s,this.primitive=c,this.dynamicStates=l,this.bindPoint=u},Ba=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.PIPELINE_STATE))._shader=null,e._pipelineLayout=null,e._primitive=Yi.TRIANGLE_LIST,e._is=null,e._rs=new Oa,e._dss=new Na,e._bs=new ka,e._dynamicStates=Ji.NONE,e._renderPass=null,e}return Z(n,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),n}(ca),Fa=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.QUEUE))._type=tr.GRAPHICS,e}return Z(n,[{key:"type",get:function(){return this._type}}]),n}(ca),za=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.RENDER_PASS))._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}return Z(n,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}},{key:"computeHash",value:function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=",".concat(r.format,",").concat(r.sampleCount)}}if(n.colors.length){e+="ca";for(var a=0;a<n.inputs.length;++a){var o=this._colorInfos[n.inputs[a]];e+=",".concat(o.format,",").concat(o.sampleCount)}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,".concat(s.format,",").concat(s.sampleCount)}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=",".concat(l.format,",").concat(l.sampleCount)}var u=this._depthStencilInfo;u&&(e+="ds,".concat(u.format,",").concat(u.sampleCount))}return wa(e,666)}}]),n}(ca),Ua=function(e){te(n,e);var t=le(n);function n(e,i){var r;return K(this,n),(r=t.call(this,gi.SAMPLER))._info=new Pr,r._hash=0,r._info.copy(e),r._hash=i,r}return Z(n,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}],[{key:"computeHash",value:function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16}},{key:"unpackFromHash",value:function(e){var t=new Pr;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t}}]),n}(ca),Ga=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.SHADER))._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}return Z(n,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),n}(ca),Ha=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,gi.TEXTURE))._type=Ii.TEX2D,e._usage=Di.NONE,e._format=Ei.UNKNOWN,e._width=0,e._height=0,e._depth=1,e._layerCount=1,e._levelCount=1,e._samples=Ni.ONE,e._flags=Oi.NONE,e._isPowerOf2=!1,e._size=0,e}return Z(n,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),n}(ca),Va=function(e){te(n,e);var t=le(n);function n(e,i){var r;return K(this,n),(r=t.call(this,gi.GLOBAL_BARRIER))._info=new Xr,r._hash=0,r._info.copy(e),r._hash=i,r}return Z(n,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}],[{key:"computeHash",value:function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" ".concat(e.prevAccesses[n]);t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" ".concat(e.nextAccesses[i]);return wa(t,666)}}]),n}(ca),ja=function(e){te(n,e);var t=le(n);function n(e,i){var r;return K(this,n),(r=t.call(this,gi.TEXTURE_BARRIER))._info=new Yr,r._hash=0,r._info.copy(e),r._hash=i,r}return Z(n,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}],[{key:"computeHash",value:function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" ".concat(e.prevAccesses[n]);t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" ".concat(e.nextAccesses[i]);return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,wa(t+=e.dstQueue?e.dstQueue.type:0,666)}}]),n}(ca),Wa={Device:Ta,Swapchain:Ea,Buffer:xa,Texture:Ha,Sampler:Ua,Shader:Ga,InputAssembler:Ra,RenderPass:za,Framebuffer:Ca,DescriptorSet:Pa,DescriptorSetLayout:Ia,PipelineLayout:Da,PipelineState:Ba,CommandBuffer:Sa,Queue:Fa,GlobalBarrier:Va,TextureBarrier:ja,RasterizerState:Oa,BlendState:ka,BlendTarget:Ma,DepthStencilState:Na,PipelineStateInfo:La};Object.assign(Wa,ya),c.gfx=Wa;var qa={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var Xa in c.gfx)if("__esModule"!==Xa){var Ya=qa[Xa];""===Ya?Ya=Xa:void 0===Ya&&(Ya="GFX".concat(Xa)),F(c,"cc",[{name:Ya,newName:Xa,target:c.gfx,targetName:"cc.gfx"}])}e("gfx",Object.freeze({__proto__:null,DescriptorSet:Pa,Buffer:xa,CommandBuffer:Sa,get ObjectType(){return gi},get Status(){return yi},get API(){return xi},get SurfaceTransform(){return Si},get Feature(){return Ti},get Format(){return Ei},get FormatType(){return Ci},get Type(){return Ai},get BufferUsageBit(){return bi},get BufferFlagBit(){return wi},get MemoryAccessBit(){return Ri},get MemoryUsageBit(){return Pi},get TextureType(){return Ii},get TextureUsageBit(){return Di},get TextureFlagBit(){return Oi},get SampleCount(){return Ni},get VsyncMode(){return Mi},get Filter(){return ki},get Address(){return Li},get ComparisonFunc(){return Bi},get StencilOp(){return Fi},get BlendFactor(){return zi},get BlendOp(){return Ui},get ColorMask(){return Gi},get ShaderStageFlagBit(){return Hi},get LoadOp(){return Vi},get StoreOp(){return ji},get AccessType(){return Wi},get ResolveMode(){return qi},get PipelineBindPoint(){return Xi},get PrimitiveMode(){return Yi},get PolygonMode(){return Ki},get ShadeModel(){return Qi},get CullMode(){return Zi},get DynamicStateFlagBit(){return Ji},get StencilFace(){return $i},get DescriptorType(){return er},get QueueType(){return tr},get QueryType(){return nr},get CommandBufferType(){return ir},get ClearFlagBit(){return rr},Size:sr,DeviceCaps:cr,Offset:lr,Rect:ur,Extent:hr,TextureSubresLayers:_r,TextureSubresRange:fr,TextureCopy:dr,TextureBlit:pr,BufferTextureCopy:mr,Viewport:vr,Color:gr,BindingMappingInfo:yr,SwapchainInfo:xr,DeviceInfo:Sr,BufferInfo:Tr,BufferViewInfo:Er,DrawInfo:Cr,DispatchInfo:Ar,IndirectBuffer:br,TextureInfo:wr,TextureViewInfo:Rr,SamplerInfo:Pr,Uniform:Ir,UniformBlock:Dr,UniformSamplerTexture:Or,UniformSampler:Nr,UniformTexture:Mr,UniformStorageImage:kr,UniformStorageBuffer:Lr,UniformInputAttachment:Br,ShaderStage:Fr,Attribute:zr,ShaderInfo:Ur,InputAssemblerInfo:Gr,ColorAttachment:Hr,DepthStencilAttachment:Vr,SubpassInfo:jr,SubpassDependency:Wr,RenderPassInfo:qr,GlobalBarrierInfo:Xr,TextureBarrierInfo:Yr,FramebufferInfo:Kr,DescriptorSetLayoutBinding:Qr,DescriptorSetLayoutInfo:Zr,DescriptorSetInfo:Jr,PipelineLayoutInfo:$r,InputState:ea,CommandBufferInfo:ta,QueueInfo:na,QueryPoolInfo:ia,FormatInfo:ra,MemoryStatus:aa,DynamicStencilStates:oa,DynamicStates:sa,GFXObject:ca,get AttributeName(){return or},FormatInfos:la,DESCRIPTOR_BUFFER_TYPE:ua,DESCRIPTOR_SAMPLER_TYPE:ha,DESCRIPTOR_DYNAMIC_TYPE:_a,DRAW_INFO_SIZE:28,IsPowerOf2:fa,FormatSize:da,FormatSurfaceSize:pa,GetTypeSize:va,getTypedArrayConstructor:ga,Device:Ta,Swapchain:Ea,Framebuffer:Ca,InputAssembler:Ra,DescriptorSetLayout:Ia,PipelineLayout:Da,RasterizerState:Oa,DepthStencilState:Na,BlendTarget:Ma,BlendState:ka,PipelineStateInfo:La,PipelineState:Ba,Queue:Fa,RenderPass:za,Sampler:Ua,Shader:Ga,Texture:Ha,GlobalBarrier:Va,TextureBarrier:ja}));var Ka=new zn,Qa=new zn,Za=new zn,Ja=new zn,$a=new zn,eo=new zn,to=new Array(3),no=new Array(3);function io(e,t){return zn.dot(t.n,e)-t.d}function ro(e,t,n){return zn.copy(e,t),zn.subtract($a,n.center,n.halfExtents),zn.add(eo,n.center,n.halfExtents),e.x=e.x<$a.x?$a.x:e.x,e.y=e.y<$a.y?$a.y:e.y,e.z=e.z<$a.z?$a.z:e.z,e.x=e.x>eo.x?eo.x:e.x,e.y=e.y>eo.y?eo.y:e.y,e.z=e.z>eo.z?eo.z:e.z,e}function ao(e,t,n){zn.set(Ka,n.orientation.m00,n.orientation.m01,n.orientation.m02),zn.set(Qa,n.orientation.m03,n.orientation.m04,n.orientation.m05),zn.set(Za,n.orientation.m06,n.orientation.m07,n.orientation.m08),to[0]=Ka,to[1]=Qa,to[2]=Za,no[0]=n.halfExtents.x,no[1]=n.halfExtents.y,no[2]=n.halfExtents.z,zn.subtract(Ja,t,n.center),zn.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=zn.dot(Ja,to[i]);r>no[i]&&(r=no[i]),r<-no[i]&&(r=-no[i]),e.x+=r*to[i].x,e.y+=r*to[i].y,e.z+=r*to[i].z}return e}var oo=Object.freeze({__proto__:null,point_plane:io,pt_point_plane:function(e,t,n){var i=io(t,n);return zn.subtract(e,t,zn.multiplyScalar(e,n.n,i))},pt_point_aabb:ro,pt_point_obb:ao,pt_point_line:function(e,t,n,i){zn.subtract(Ka,n,i);var r=Ka,a=zn.lengthSqr(r);if(0==a)zn.copy(e,n);else{zn.subtract(Ka,t,n);var o=zn.dot(Ka,r)/a;o<0?zn.copy(e,n):o>1?zn.copy(e,i):zn.scaleAndAdd(e,n,r,o)}}}),so={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},co=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;K(this,e),this.s=void 0,this.e=void 0,this._type=void 0,this._type=so.SHAPE_LINE,this.s=new zn(t,n,i),this.e=new zn(r,a,o)}return Z(e,[{key:"type",get:function(){return this._type}},{key:"length",value:function(){return zn.distance(this.s,this.e)}}],[{key:"create",value:function(t,n,i,r,a,o){return new e(t,n,i,r,a,o)}},{key:"clone",value:function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}},{key:"copy",value:function(e,t){return zn.copy(e.s,t.s),zn.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,n){return zn.copy(e.s,t),zn.copy(e.e,n),e}},{key:"set",value:function(e,t,n,i,r,a,o){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=a,e.e.z=o,e}},{key:"len",value:function(e){return zn.distance(e.s,e.e)}}]),e}(),lo=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;K(this,e),this.o=void 0,this.d=void 0,this._type=void 0,this._type=so.SHAPE_RAY,this.o=new zn(t,n,i),this.d=new zn(r,a,o)}return Z(e,[{key:"type",get:function(){return this._type}},{key:"computeHit",value:function(e,t){zn.normalize(e,this.d),zn.scaleAndAdd(e,this.o,e,t)}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;return new e(t,n,i,r,a,o)}},{key:"clone",value:function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}},{key:"copy",value:function(e,t){return zn.copy(e.o,t.o),zn.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,n){return zn.copy(e.o,t),zn.normalize(e.d,zn.subtract(e.d,n,t)),e}},{key:"set",value:function(e,t,n,i,r,a,o){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=a,e.d.z=o,e}}]),e}(),uo=new zn,ho=new zn,_o=new zn,fo=new zn;function po(e){return Math.max(Math.max(e.x,e.y),e.z)}var mo,vo=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;K(this,e),this._center=new zn(0,0,0),this._radius=0,this._type=void 0,this._type=so.SHAPE_SPHERE,this._center=new zn(t,n,i),this._radius=r}return Z(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}},{key:"destroy",value:function(){}},{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}},{key:"getBoundary",value:function(e,t){zn.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),zn.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,n,i,r){zn.transformMat4(r.center,this.center,e),r.radius=this.radius*po(i)}},{key:"translateAndRotate",value:function(e,t,n){zn.transformMat4(n.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*po(e)}},{key:"mergePoint",value:function(e){this.radius<0&&(this.center.set(e),this.radius=0),zn.subtract(ho,e,this.center);var t=ho.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,zn.multiplyScalar(ho,ho,n/t),zn.add(this.center,this.center,ho)}}},{key:"mergePoints",value:function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}}},{key:"mergeAABB",value:function(e){e.getBoundary(_o,fo),this.mergePoint(_o),this.mergePoint(fo)}}],[{key:"create",value:function(t,n,i,r){return new e(t,n,i,r)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)}},{key:"copy",value:function(e,t){return zn.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,n){return zn.multiplyScalar(e.center,zn.add(uo,t,n),.5),e.radius=.5*zn.subtract(uo,n,t).length(),e}},{key:"set",value:function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e}}]),e}(),go=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;K(this,e),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=so.SHAPE_TRIANGLE,this.a=new zn(t,n,i),this.b=new zn(r,a,o),this.c=new zn(s,c,l)}return Z(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return new e(t,n,i,r,a,o,s,c,l)}},{key:"clone",value:function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}},{key:"copy",value:function(e,t){return zn.copy(e.a,t.a),zn.copy(e.b,t.b),zn.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,n,i){return zn.copy(e.a,t),zn.copy(e.b,n),zn.copy(e.c,i),e}},{key:"set",value:function(e,t,n,i,r,a,o,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=a,e.b.z=o,e.c.x=s,e.c.y=c,e.c.z=l,e}}]),e}();!function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(mo||(mo={}));var yo,xo,So,To,Eo,Co,Ao,bo,wo=(yo=new zn(0,0,0),function(e,t){var n=zn.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;zn.multiplyScalar(yo,t.n,t.d);var i=zn.dot(zn.subtract(yo,yo,e.o),t.n)/n;return i<0?0:i}),Ro=(xo=new zn(0,0,0),So=new zn(0,0,0),To=new zn(0,0,0),Eo=new zn(0,0,0),Co=new zn(0,0,0),function(e,t,n){zn.subtract(xo,t.b,t.a),zn.subtract(So,t.c,t.a),zn.cross(To,e.d,So);var i=zn.dot(xo,To);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;zn.subtract(Eo,e.o,t.a);var a=zn.dot(Eo,To)*r;if(a<0||a>1)return 0;zn.cross(Co,Eo,xo);var o=zn.dot(e.d,Co)*r;if(o<0||a+o>1)return 0;var s=zn.dot(So,Co)*r;return s<0?0:s}),Po=function(){var e=new zn(0,0,0);return function(t,n){var i=n.radius,r=n.center,a=t.o,o=t.d,s=i*i;zn.subtract(e,r,a);var c=e.lengthSqr(),l=zn.dot(e,o),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),Io=(Ao=new zn,bo=new zn,function(e,t){return zn.subtract(Ao,t.center,t.halfExtents),zn.add(bo,t.center,t.halfExtents),Do(e,Ao,bo)});function Do(e,t,n){var i=e.o,r=e.d,a=1/r.x,o=1/r.y,s=1/r.z,c=(t.x-i.x)*a,l=(n.x-i.x)*a,u=(t.y-i.y)*o,h=(n.y-i.y)*o,_=(t.z-i.z)*s,f=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),p=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return p<0||d>p?0:d>0?d:p}var Oo,No,Mo,ko,Lo=function(){var e=new zn,t=new zn,n=new zn,i=new zn,r=new zn,a=new zn,o=new zn,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,n=h.d,zn.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),zn.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),zn.set(a,_.orientation.m06,_.orientation.m07,_.orientation.m08),zn.subtract(o,e,t),c[0]=zn.dot(i,n),c[1]=zn.dot(r,n),c[2]=zn.dot(a,n),l[0]=zn.dot(i,o),l[1]=zn.dot(r,o),l[2]=zn.dot(a,o);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var d=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),p=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return p<0||d>p?0:d>0?d:p}}(),Bo=function(){var e=new zn,t=new zn,n=new zn,i=new zn,r=new zn,a=new zn,o=new zn,s=new vo;return function(c,l){var u=l.radius*l.radius,h=zn.normalize(e,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,d=zn.subtract(t,f,_);if(d.equals(zn.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),Ss.raySphere(c,s);var p=c.o,m=zn.subtract(n,p,_),v=zn.cross(i,h,d),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=zn.subtract(r,f,p);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),Ss.raySphere(c,s)}var x=zn.cross(r,m,d),S=d.lengthSqr(),T=2*zn.dot(v,x),E=T*T-4*g*(x.lengthSqr()-u*S);if(E<0)return 0;var C=(-T-Math.sqrt(E))/(2*g);if(C<0){s.radius=l.radius;var A=zn.subtract(a,f,p);return m.lengthSqr()<A.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),Ss.raySphere(c,s)}var b=zn.scaleAndAdd(a,c.o,h,C),w=zn.subtract(o,b,_),R=zn.dot(w,d)/S;return R>=0&&R<=1?C:R<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),Ss.raySphere(c,s)):R>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),Ss.raySphere(c,s)):0}}(),Fo=(Oo=go.create(),No={distance:1/0,doubleSided:!1,mode:mo.ANY},Mo=0,ko=function(e,t,n,i,r,a){e===mo.CLOSEST?(Mo>t||0===Mo)&&(Mo=t,a&&(0===a.length?a.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(a[0].distance=t,a[0].vertexIndex0=n/3,a[0].vertexIndex1=i/3,a[0].vertexIndex2=r/3))):(Mo=t,a&&a.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(Mo=0,0===t.geometricInfo.positions.length)return Mo;var i=void 0===n?No:n;if(Do(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,a=t.geometricInfo;!function(e,t,n,i,r){if(n===Yi.TRIANGLE_LIST)for(var a=t.length,o=0;o<a;o+=3){var s=3*t[o],c=3*t[o+1],l=3*t[o+2];zn.set(Oo.a,e[s],e[s+1],e[s+2]),zn.set(Oo.b,e[c],e[c+1],e[c+2]),zn.set(Oo.c,e[l],e[l+1],e[l+2]);var u=Ss.rayTriangle(i,Oo,r.doubleSided);if(!(0===u||u>r.distance)&&(ko(r.mode,u,s,c,l,r.result),r.mode===mo.ANY))return u}else if(n===Yi.TRIANGLE_STRIP)for(var h=t.length-2,_=0,f=0;f<h;f+=1){var d=3*t[f-_],p=3*t[f+_+1],m=3*t[f+2];zn.set(Oo.a,e[d],e[d+1],e[d+2]),zn.set(Oo.b,e[p],e[p+1],e[p+2]),zn.set(Oo.c,e[m],e[m+1],e[m+2]),_=~_;var v=Ss.rayTriangle(i,Oo,r.doubleSided);if(!(0===v||v>r.distance)&&(ko(r.mode,v,d,p,m,r.result),r.mode===mo.ANY))return v}else if(n===Yi.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];zn.set(Oo.a,e[y],e[y+1],e[y+2]);for(var x=1;x<g;x+=1){var S=3*t[x],T=3*t[x+1];zn.set(Oo.b,e[S],e[S+1],e[S+2]),zn.set(Oo.c,e[T],e[T+1],e[T+2]);var E=Ss.rayTriangle(i,Oo,r.doubleSided);if(!(0===E||E>r.distance)&&(ko(r.mode,E,y,S,T,r.result),r.mode===mo.ANY))return E}}}(a.positions,a.indices,r,e,i)}return Mo}),zo=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:mo.ANY};return function(n,i,r){e=0;var a=void 0===r?t:r,o=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!Do(n,s,c))return e;for(var l=0;l<o;l++){var u=i.renderingSubMeshes[l],h=Fo(n,u,a);if(h)if(a.mode===mo.CLOSEST)(0===e||e>h)&&(e=h,a.subIndices&&(a.subIndices[0]=l));else if(e=h,a.subIndices&&a.subIndices.push(l),a.mode===mo.ANY)return h}return e&&a.mode===mo.CLOSEST&&(a.result&&(a.result[0].distance=e,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),e}}(),Uo=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:mo.ANY},n=new lo,i=new ei;return function(r,a,o){e=0;var s=void 0===o?t:o,c=a.worldBounds;if(c&&!Io(r,c))return e;lo.copy(n,r),a.node&&(ei.invert(i,a.node.getWorldMatrix(i)),zn.transformMat4(n.o,r.o,i),zn.transformMat4Normal(n.d,r.d,i));for(var l=a.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=Fo(n,h,s);if(_)if(s.mode===mo.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===mo.ANY)return _}return e&&s.mode===mo.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),Go=function(){var e=new zn(0,0,0);return function(t,n){zn.subtract(e,t.e,t.s);var i=(n.d-zn.dot(t.s,n.n))/zn.dot(e,n.n);return i<0||i>1?0:i}}(),Ho=function(){var e=new zn(0,0,0),t=new zn(0,0,0),n=new zn(0,0,0),i=new zn(0,0,0),r=new zn(0,0,0),a=new zn(0,0,0);return function(o,s,c){zn.subtract(e,s.b,s.a),zn.subtract(t,s.c,s.a),zn.subtract(n,o.s,o.e),zn.cross(r,e,t);var l=zn.dot(n,r);if(l<=0)return 0;zn.subtract(i,o.s,s.a);var u=zn.dot(i,r);if(u<0||u>l)return 0;zn.cross(a,n,i);var h=zn.dot(t,a);if(h<0||h>l)return 0;var _=-zn.dot(e,a);if(_<0||h+_>l)return 0;if(c){var f=1/l,d=1-(h*=f)-(_*=f);zn.set(c,s.a.x*d+s.b.x*h+s.c.x*_,s.a.y*d+s.b.y*h+s.c.y*_,s.a.z*d+s.b.z*h+s.c.z*_)}return 1}}(),Vo=new lo;function jo(e,t){Vo.o.set(e.s),zn.subtract(Vo.d,e.e,e.s),Vo.d.normalize();var n=Io(Vo,t);return n<=e.length()?n:0}function Wo(e,t){Vo.o.set(e.s),zn.subtract(Vo.d,e.e,e.s),Vo.d.normalize();var n=Lo(Vo,t);return n<=e.length()?n:0}function qo(e,t){Vo.o.set(e.s),zn.subtract(Vo.d,e.e,e.s),Vo.d.normalize();var n=Po(Vo,t);return n<=e.length()?n:0}var Xo,Yo,Ko,Qo,Zo=(Xo=new zn,Yo=new zn,Ko=new zn,Qo=new zn,function(e,t){return zn.subtract(Xo,e.center,e.halfExtents),zn.add(Yo,e.center,e.halfExtents),zn.subtract(Ko,t.center,t.halfExtents),zn.add(Qo,t.center,t.halfExtents),Xo.x<=Qo.x&&Yo.x>=Ko.x&&Xo.y<=Qo.y&&Yo.y>=Ko.y&&Xo.z<=Qo.z&&Yo.z>=Ko.z});function Jo(e,t,n,i,r,a){zn.set(a[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),zn.set(a[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),zn.set(a[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),zn.set(a[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),zn.set(a[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),zn.set(a[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),zn.set(a[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),zn.set(a[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function $o(e,t){for(var n=zn.dot(t,e[0]),i=n,r=1;r<8;++r){var a=zn.dot(t,e[r]);n=a<n?a:n,i=a>i?a:i}return[n,i]}var es,ts,ns,is=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new zn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new zn(0,0,0),i[r]=new zn(0,0,0);var a=new zn,o=new zn;return function(t,r){zn.set(e[0],1,0,0),zn.set(e[1],0,1,0),zn.set(e[2],0,0,1),zn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),zn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),zn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)zn.cross(e[6+3*s],e[s],e[3]),zn.cross(e[7+3*s],e[s],e[4]),zn.cross(e[7+3*s],e[s],e[5]);zn.subtract(a,t.center,t.halfExtents),zn.add(o,t.center,t.halfExtents),function(e,t,n){zn.set(n[0],e.x,t.y,t.z),zn.set(n[1],e.x,t.y,e.z),zn.set(n[2],e.x,e.y,t.z),zn.set(n[3],e.x,e.y,e.z),zn.set(n[4],t.x,t.y,t.z),zn.set(n[5],t.x,t.y,e.z),zn.set(n[6],t.x,e.y,t.z),zn.set(n[7],t.x,e.y,e.z)}(a,o,n),Jo(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=$o(n,e[c]),u=$o(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),rs=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=zn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},as=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===rs(e,t.planes[n]))return 0;return 1},os=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new zn(0,0,0);return function(i,r){for(var a=0,o=!1,s=0;s<r.planes.length;s++){if(-1===(a=rs(i,r.planes[s])))return 0;1===a&&(o=!0)}if(!o)return 1;for(var c=0;c<r.vertices.length;c++)zn.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),ss=(es=new zn(0,0,0),ts=new Vn,function(e,t){return zn.subtract(es,t,e.center),zn.transformMat3(es,es,Vn.transpose(ts,e.orientation)),n=es,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),cs=(ns=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*ns(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*ns(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*ns(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=zn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),ls=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===cs(e,t.planes[n]))return 0;return 1},us=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new zn(0,0,0);var a=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,o){for(var s=0,c=!1,l=0;l<o.planes.length;l++){if(-1===(s=cs(r,o.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<o.vertices.length;u++)zn.subtract(e[u],o.vertices[u],r.center);n=0,i=0;for(var h=0;h<o.vertices.length;h++)(t=a(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===o.vertices.length||i===o.vertices.length)return 0;n=0,i=0;for(var _=0;_<o.vertices.length;_++)(t=a(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===o.vertices.length||i===o.vertices.length)return 0;n=0,i=0;for(var f=0;f<o.vertices.length;f++)(t=a(e[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===o.vertices.length||i===o.vertices.length?0:1}}(),hs=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new zn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new zn(0,0,0),i[r]=new zn(0,0,0);return function(t,r){zn.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),zn.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),zn.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),zn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),zn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),zn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var a=0;a<3;++a)zn.cross(e[6+3*a],e[a],e[3]),zn.cross(e[7+3*a],e[a],e[4]),zn.cross(e[8+3*a],e[a],e[5]);Jo(t.center,t.halfExtents,e[0],e[1],e[2],n),Jo(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var o=0;o<15;++o){var s=$o(n,e[o]),c=$o(i,e[o]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),_s=function(){for(var e=new vo,t=new zn,n=new zn,i=new zn,r=new Array(8),a=0;a<8;a++)r[a]=new zn;for(var o=new Array(8),s=0;s<8;s++)o[s]=new zn;return function(a,s){if(0===zn.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),Ss.sphereOBB(e,a);t.x=a.orientation.m00,t.y=a.orientation.m01,t.z=a.orientation.m02,n.x=a.orientation.m03,n.y=a.orientation.m04,n.z=a.orientation.m05,i.x=a.orientation.m06,i.y=a.orientation.m07,i.z=a.orientation.m08,Jo(a.center,a.halfExtents,t,n,i,r);var c=o,l=zn.copy(c[0],t),u=zn.copy(c[1],n),h=zn.copy(c[2],i);zn.subtract(c[3],s.center,a.center).normalize();var _=zn.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),zn.cross(c[5],l,_),zn.cross(c[6],u,_),zn.cross(c[7],h,_);for(var f=0;f<8;++f){var d=$o(r,c[f]),p=zn.dot(c[f],s.ellipseCenter0),m=zn.dot(c[f],s.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-s.radius,y=v+s.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),fs=function(e,t){var n=zn.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},ds=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===fs(e,t.planes[n]))return 0;return 1},ps=function(){var e=new zn(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var a=i.planes[r],o=n.radius,s=n.center,c=a.n,l=a.d,u=zn.dot(c,s);if(u+o<l)return 0;if(!(u-o>l)){zn.add(e,s,zn.multiplyScalar(e,c,o));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var _=i.planes[h];if(zn.dot(_.n,e)<_.d)return 0}}}return 1}}(),ms=function(e,t){var n=e.radius+t.radius;return zn.squaredDistance(e.center,t.center)<n*n},vs=function(){var e=new zn;return function(t,n){return ro(e,t.center,n),zn.squaredDistance(t.center,e)<t.radius*t.radius}}(),gs=function(){var e=new zn;return function(t,n){return ao(e,t.center,n),zn.squaredDistance(t.center,e)<t.radius*t.radius}}(),ys=function(){var e=new zn,t=new zn;return function(n,i){var r=n.radius+i.radius,a=r*r,o=zn.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===o)return zn.squaredDistance(n.center,i.center)<a;zn.subtract(e,n.center,i.ellipseCenter0),zn.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=zn.dot(e,t)/o;return s<0?zn.squaredDistance(n.center,i.ellipseCenter0)<a:s>1?zn.squaredDistance(n.center,i.ellipseCenter1)<a:(zn.scaleAndAdd(e,i.ellipseCenter0,t,s),zn.squaredDistance(n.center,e)<a)}}(),xs=function(){var e=new zn,t=new zn,n=new zn,i=new zn,r=new zn,a=new zn;return function(o,s){var c,l,u=zn.subtract(e,o.ellipseCenter1,o.ellipseCenter0),h=zn.subtract(t,s.ellipseCenter1,s.ellipseCenter0),_=zn.subtract(n,o.ellipseCenter0,s.ellipseCenter0),f=zn.dot(u,u),d=zn.dot(u,h),p=zn.dot(h,h),m=zn.dot(u,_),v=zn.dot(h,_),g=f*p-d*d,y=g,x=g;g<pn?(c=0,y=1,l=v,x=p):(l=f*v-d*m,(c=d*v-p*m)<0?(c=0,l=v,x=p):c>y&&(c=y,l=v+d,x=p)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>x&&(l=x,-m+d<0?c=0:-m+d>f?c=y:(c=-m+d,y=f));var S=Math.abs(c)<pn?0:c/y,T=Math.abs(l)<pn?0:l/x,E=i;E.set(_),E.add(zn.multiplyScalar(r,u,S)),E.subtract(zn.multiplyScalar(a,h,T));var C=o.radius+s.radius;return E.lengthSqr()<C*C}}(),Ss={raySphere:Po,rayAABB:Io,rayOBB:Lo,rayPlane:wo,rayTriangle:Ro,rayCapsule:Bo,raySubMesh:Fo,rayMesh:zo,rayModel:Uo,lineSphere:qo,lineAABB:jo,lineOBB:Wo,linePlane:Go,lineTriangle:Ho,sphereWithSphere:ms,sphereAABB:vs,sphereOBB:gs,spherePlane:fs,sphereFrustum:ds,sphereFrustumAccurate:ps,sphereCapsule:ys,aabbWithAABB:Zo,aabbWithOBB:is,aabbPlane:rs,aabbFrustum:as,aabbFrustumAccurate:os,obbWithOBB:hs,obbPlane:cs,obbFrustum:ls,obbFrustumAccurate:us,obbPoint:ss,obbCapsule:_s,capsuleWithCapsule:xs,resolve:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=e._type,r=t._type,a=this[i|r];return i<r?a(e,t,n):a(t,e,n)}};Ss[so.SHAPE_RAY|so.SHAPE_SPHERE]=Po,Ss[so.SHAPE_RAY|so.SHAPE_AABB]=Io,Ss[so.SHAPE_RAY|so.SHAPE_OBB]=Lo,Ss[so.SHAPE_RAY|so.SHAPE_PLANE]=wo,Ss[so.SHAPE_RAY|so.SHAPE_TRIANGLE]=Ro,Ss[so.SHAPE_RAY|so.SHAPE_CAPSULE]=Bo,Ss[so.SHAPE_LINE|so.SHAPE_SPHERE]=qo,Ss[so.SHAPE_LINE|so.SHAPE_AABB]=jo,Ss[so.SHAPE_LINE|so.SHAPE_OBB]=Wo,Ss[so.SHAPE_LINE|so.SHAPE_PLANE]=Go,Ss[so.SHAPE_LINE|so.SHAPE_TRIANGLE]=Ho,Ss[so.SHAPE_SPHERE]=ms,Ss[so.SHAPE_SPHERE|so.SHAPE_AABB]=vs,Ss[so.SHAPE_SPHERE|so.SHAPE_OBB]=gs,Ss[so.SHAPE_SPHERE|so.SHAPE_PLANE]=fs,Ss[so.SHAPE_SPHERE|so.SHAPE_FRUSTUM]=ds,Ss[so.SHAPE_SPHERE|so.SHAPE_FRUSTUM_ACCURATE]=ps,Ss[so.SHAPE_SPHERE|so.SHAPE_CAPSULE]=ys,Ss[so.SHAPE_AABB]=Zo,Ss[so.SHAPE_AABB|so.SHAPE_OBB]=is,Ss[so.SHAPE_AABB|so.SHAPE_PLANE]=rs,Ss[so.SHAPE_AABB|so.SHAPE_FRUSTUM]=as,Ss[so.SHAPE_AABB|so.SHAPE_FRUSTUM_ACCURATE]=os,Ss[so.SHAPE_OBB]=hs,Ss[so.SHAPE_OBB|so.SHAPE_PLANE]=cs,Ss[so.SHAPE_OBB|so.SHAPE_FRUSTUM]=ls,Ss[so.SHAPE_OBB|so.SHAPE_FRUSTUM_ACCURATE]=us,Ss[so.SHAPE_OBB|so.SHAPE_CAPSULE]=_s,Ss[so.SHAPE_CAPSULE]=xs,F(co.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),z(Ss,"intersect",[{name:"line_quad"}]);var Ts,Es,Cs,As,bs,ws,Rs,Ps=new zn(0,0,0),Is=new zn(0,0,0),Ds=c.mat4(),Os=c.v4(),Ns=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;K(this,e),this.n=void 0,this.d=void 0,this._type=void 0,this._type=so.SHAPE_PLANE,this.n=new zn(t,n,i),this.d=r}return Z(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}},{key:"transform",value:function(e){ei.invert(Ds,e),ei.transpose(Ds,Ds),ci.set(Os,this.n.x,this.n.y,this.n.z,this.d),ci.transformMat4(Os,Os,Ds),zn.set(this.n,Os.x,Os.y,Os.z),this.d=Os.w}}],[{key:"create",value:function(t,n,i,r){return new e(t,n,i,r)}},{key:"clone",value:function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)}},{key:"copy",value:function(e,t){return zn.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,n,i){return zn.subtract(Ps,n,t),zn.subtract(Is,i,t),zn.normalize(e.n,zn.cross(e.n,Ps,Is)),e.d=zn.dot(e.n,t),e}},{key:"set",value:function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,n){return zn.copy(e.n,t),e.d=zn.dot(t,n),e}},{key:"normalize",value:function(e,t){var n=t.n.length();return zn.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e}}]),e}(),Ms=function(){function e(t,n,i){K(this,e),this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=i*(1<<n)}return Z(e,[{key:"allocateNewChunk",value:function(){return new ArrayBuffer(this._chunkSize)}}]),e}();Z((function e(){K(this,e)}),[{key:"bind",value:function(){}}]),Z((function e(){K(this,e)}),[{key:"alloc",value:function(e,t){return new ArrayBuffer(t)}},{key:"free",value:function(){}}]),function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(Rs||(Rs={}));var ks,Ls,Bs=function(){function e(t,n,i,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;K(this,e),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=r.COUNT,this._entryBits=a,this._dataType=n,this._dataMembers=i;var o=4;this._stride=o*this._elementCount,this._entriesPerChunk=1<<a,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Ms(t,a,this._stride);var s=Rs.NEVER,c=!1,l=!1;for(var u in n){if(c=this._hasFloat32,(l=this._hasUint32)&&c)break;s=n[u],c||s!==Rs.FLOAT32?l||s!==Rs.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}return Z(e,[{key:"alloc",value:function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],a=[],o=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&a.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&o.push(l);return c&&this._uint32BufferViews.push(a),s&&this._float32BufferViews.push(r),this._freeLists.push(o),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag}},{key:"getBuffer",value:function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]}},{key:"getTypedArray",value:function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,a=(this._dataType[t]===Rs.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],o=this._dataMembers[t];return a.subarray(r,r+o)}},{key:"free",value:function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)}}]),e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(ks||(ks={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(Ls||(Ls={}));var Fs,zs=(J(Ts={},Ls.DIRTY_FLAG,Rs.UINT32),J(Ts,Ls.LAYER,Rs.UINT32),J(Ts,Ls.WORLD_SCALE,Rs.FLOAT32),J(Ts,Ls.WORLD_POSITION,Rs.FLOAT32),J(Ts,Ls.WORLD_ROTATION,Rs.FLOAT32),J(Ts,Ls.WORLD_MATRIX,Rs.FLOAT32),J(Ts,Ls.LOCAL_SCALE,Rs.FLOAT32),J(Ts,Ls.LOCAL_POSITION,Rs.FLOAT32),J(Ts,Ls.LOCAL_ROTATION,Rs.FLOAT32),J(Ts,Ls.COUNT,Rs.NEVER),Ts),Us=(J(Es={},Ls.DIRTY_FLAG,Ls.LAYER-Ls.DIRTY_FLAG),J(Es,Ls.LAYER,Ls.WORLD_SCALE-Ls.LAYER),J(Es,Ls.WORLD_SCALE,Ls.WORLD_POSITION-Ls.WORLD_SCALE),J(Es,Ls.WORLD_POSITION,Ls.WORLD_ROTATION-Ls.WORLD_POSITION),J(Es,Ls.WORLD_ROTATION,Ls.WORLD_MATRIX-Ls.WORLD_ROTATION),J(Es,Ls.WORLD_MATRIX,Ls.LOCAL_SCALE-Ls.WORLD_MATRIX),J(Es,Ls.LOCAL_SCALE,Ls.LOCAL_POSITION-Ls.LOCAL_SCALE),J(Es,Ls.LOCAL_POSITION,Ls.LOCAL_ROTATION-Ls.LOCAL_POSITION),J(Es,Ls.LOCAL_ROTATION,Ls.COUNT-Ls.LOCAL_ROTATION),J(Es,Ls.COUNT,1),Es),Gs=new Bs(ks.NODE,zs,Us,Ls);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(Fs||(Fs={}));var Hs,Vs=(J(Cs={},Fs.PRIORITY,Rs.UINT32),J(Cs,Fs.STAGE,Rs.UINT32),J(Cs,Fs.PHASE,Rs.UINT32),J(Cs,Fs.PRIMITIVE,Rs.UINT32),J(Cs,Fs.BATCHING_SCHEME,Rs.UINT32),J(Cs,Fs.DYNAMIC_STATE,Rs.UINT32),J(Cs,Fs.HASH,Rs.UINT32),J(Cs,Fs.COUNT,Rs.NEVER),Cs),js=(J(As={},Fs.PRIORITY,Fs.STAGE-Fs.PRIORITY),J(As,Fs.STAGE,Fs.PHASE-Fs.STAGE),J(As,Fs.PHASE,Fs.PRIMITIVE-Fs.PHASE),J(As,Fs.PRIMITIVE,Fs.BATCHING_SCHEME-Fs.PRIMITIVE),J(As,Fs.BATCHING_SCHEME,Fs.DYNAMIC_STATE-Fs.BATCHING_SCHEME),J(As,Fs.DYNAMIC_STATE,Fs.HASH-Fs.DYNAMIC_STATE),J(As,Fs.HASH,Fs.COUNT-Fs.HASH),J(As,Fs.COUNT,1),As),Ws=new Bs(ks.PASS,Vs,js,Fs);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(Hs||(Hs={}));var qs=(J(bs={},Hs.CENTER,Rs.FLOAT32),J(bs,Hs.HALFEXTENTS,Rs.FLOAT32),J(bs,Hs.COUNT,Rs.NEVER),bs),Xs=(J(ws={},Hs.CENTER,Hs.HALFEXTENTS-Hs.CENTER),J(ws,Hs.HALFEXTENTS,Hs.COUNT-Hs.HALFEXTENTS),J(ws,Hs.COUNT,1),ws),Ys=new Bs(ks.AABB,qs,Xs,Hs),Ks=new zn,Qs=new zn,Zs=new zn,Js=new zn,$s=new Vn,ec=function(e,t,n){$s.m00=Math.abs(n.m00),$s.m01=Math.abs(n.m01),$s.m02=Math.abs(n.m02),$s.m03=Math.abs(n.m04),$s.m04=Math.abs(n.m05),$s.m05=Math.abs(n.m06),$s.m06=Math.abs(n.m08),$s.m07=Math.abs(n.m09),$s.m08=Math.abs(n.m10),zn.transformMat3(e,t,$s)},tc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;K(this,e),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=so.SHAPE_AABB,this.center=new zn(t,n,i),this.halfExtents=new zn(r,a,o)}return Z(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}},{key:"getBoundary",value:function(e,t){zn.subtract(e,this.center,this.halfExtents),zn.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,n,i,r){zn.transformMat4(r.center,this.center,e),ec(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}},{key:"mergePoint",value:function(e){this.getBoundary(Ks,Qs),e.x<Ks.x&&(Ks.x=e.x),e.y<Ks.y&&(Ks.y=e.y),e.z<Ks.z&&(Ks.z=e.z),e.x>Qs.x&&(Qs.x=e.x),e.y>Qs.y&&(Qs.y=e.y),e.z>Qs.z&&(Qs.z=e.z),zn.add(Zs,Ks,Qs),this.center.set(zn.multiplyScalar(Zs,Zs,.5)),this.halfExtents.set(Qs.x-Zs.x,Qs.y-Zs.y,Qs.z-Zs.z)}},{key:"mergePoints",value:function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])}},{key:"mergeFrustum",value:function(e){return this.mergePoints(e.vertices)}}],[{key:"create",value:function(t,n,i,r,a,o){return new e(t,n,i,r,a,o)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}},{key:"copy",value:function(e,t){return zn.copy(e.center,t.center),zn.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,n){return zn.add(Ks,n,t),zn.subtract(Qs,n,t),zn.multiplyScalar(e.center,Ks,.5),zn.multiplyScalar(e.halfExtents,Qs,.5),e}},{key:"set",value:function(e,t,n,i,r,a,o){return e.center.set(t,n,i),e.halfExtents.set(r,a,o),e}},{key:"merge",value:function(t,n,i){return zn.subtract(Ks,n.center,n.halfExtents),zn.subtract(Qs,i.center,i.halfExtents),zn.add(Zs,n.center,n.halfExtents),zn.add(Js,i.center,i.halfExtents),zn.max(Js,Zs,Js),zn.min(Zs,Ks,Qs),e.fromPoints(t,Zs,Js)}},{key:"toBoundingSphere",value:function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e}},{key:"transform",value:function(e,t,n){return zn.transformMat4(e.center,t.center,n),ec(e.halfExtents,t.halfExtents,n),e}}]),e}(),nc=new zn,ic=new zn,rc=new Vn,ac=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,_=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,f=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,p=arguments.length>14&&void 0!==arguments[14]?arguments[14]:1;K(this,e),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=so.SHAPE_OBB,this.center=new zn(t,n,i),this.halfExtents=new zn(r,a,o),this.orientation=new Vn(s,c,l,u,h,_,f,d,p)}return Z(e,[{key:"type",get:function(){return this._type}},{key:"getBoundary",value:function(e,t){!function(e,t,n){rc.m00=Math.abs(n.m00),rc.m01=Math.abs(n.m01),rc.m02=Math.abs(n.m02),rc.m03=Math.abs(n.m03),rc.m04=Math.abs(n.m04),rc.m05=Math.abs(n.m05),rc.m06=Math.abs(n.m06),rc.m07=Math.abs(n.m07),rc.m08=Math.abs(n.m08),zn.transformMat3(e,t,rc)}(nc,this.halfExtents,this.orientation),zn.subtract(e,this.center,nc),zn.add(t,this.center,nc)}},{key:"transform",value:function(e,t,n,i,r){zn.transformMat4(r.center,this.center,e),Vn.fromQuat(r.orientation,n),zn.multiply(r.halfExtents,this.halfExtents,i)}},{key:"translateAndRotate",value:function(e,t,n){zn.transformMat4(n.center,this.center,e),Vn.fromQuat(n.orientation,t)}},{key:"setScale",value:function(e,t){zn.multiply(t.halfExtents,this.halfExtents,e)}}],[{key:"create",value:function(t,n,i,r,a,o,s,c,l,u,h,_,f,d,p){return new e(t,n,i,r,a,o,s,c,l,u,h,_,f,d,p)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}},{key:"copy",value:function(e,t){return zn.copy(e.center,t.center),zn.copy(e.halfExtents,t.halfExtents),Vn.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,n){return zn.multiplyScalar(e.center,zn.add(nc,t,n),.5),zn.multiplyScalar(e.halfExtents,zn.subtract(ic,n,t),.5),Vn.identity(e.orientation),e}},{key:"set",value:function(e,t,n,i,r,a,o,s,c,l,u,h,_,f,d,p){return zn.set(e.center,t,n,i),zn.set(e.halfExtents,r,a,o),Vn.set(e.orientation,s,c,l,u,h,_,f,d,p),e}}]),e}(),oc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;K(this,e),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=so.SHAPE_CAPSULE,this.radius=t,this.halfHeight=n,this.axis=i,this.center=new zn,this.rotation=new qn,this.ellipseCenter0=new zn(0,n,0),this.ellipseCenter1=new zn(0,-n,0),this.updateCache()}return Z(e,[{key:"type",get:function(){return this._type}},{key:"transform",value:function(e,t,n,i,r){var a=i,o=Nn(a);r.radius=this.radius*Math.abs(o);var s=(this.halfHeight+this.radius)*Math.abs(a.y)-r.radius;s<0&&(s=0),r.halfHeight=s,zn.transformMat4(r.center,this.center,e),qn.multiply(r.rotation,this.rotation,n),r.updateCache()}},{key:"updateCache",value:function(){this.updateLocalCenter(),zn.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),zn.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}},{key:"updateLocalCenter",value:function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}}}]),e}(),sc=new Array(8);sc[0]=new zn(1,1,1),sc[1]=new zn(-1,1,1),sc[2]=new zn(-1,-1,1),sc[3]=new zn(1,-1,1),sc[4]=new zn(1,1,-1),sc[5]=new zn(-1,1,-1),sc[6]=new zn(-1,-1,-1),sc[7]=new zn(1,-1,-1);var cc,lc,uc=new zn,hc=new zn,_c=new zn,fc=function(){function e(){K(this,e),this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=so.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=Ns.create(0,0,0,0);this.vertices=new Array(8);for(var n=0;n<8;++n)this.vertices[n]=new zn}return Z(e,[{key:"accurate",set:function(e){this._type=e?so.SHAPE_FRUSTUM_ACCURATE:so.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}},{key:"update",value:function(e,t){if(zn.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),zn.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),zn.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),zn.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),zn.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),zn.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===so.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();zn.multiplyScalar(i.n,i.n,r),i.d*=r}for(var a=0;a<8;a++)zn.transformMat4(this.vertices[a],sc[a],t)}}},{key:"transform",value:function(e){if(this._type===so.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)zn.transformMat4(this.vertices[t],this.vertices[t],e);Ns.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Ns.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Ns.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Ns.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Ns.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Ns.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}}},{key:"updatePlanes",value:function(){Ns.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Ns.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Ns.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Ns.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Ns.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Ns.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}}],[{key:"createFromAABB",value:function(e,t){var n=new zn,i=new zn;return zn.subtract(n,t.center,t.halfExtents),zn.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==so.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e}},{key:"split",value:function(e,t,n,i,r){var a=Math.tan(.5*t.fov),o=a*t.aspect;uc.set(i*o,i*a,i),hc.set(r*o,r*a,r);var s=e.vertices;return _c.set(uc.x,uc.y,uc.z),zn.transformMat4(s[0],_c,n),_c.set(-uc.x,uc.y,uc.z),zn.transformMat4(s[1],_c,n),_c.set(-uc.x,-uc.y,uc.z),zn.transformMat4(s[2],_c,n),_c.set(uc.x,-uc.y,uc.z),zn.transformMat4(s[3],_c,n),_c.set(hc.x,hc.y,hc.z),zn.transformMat4(s[4],_c,n),_c.set(-hc.x,hc.y,hc.z),zn.transformMat4(s[5],_c,n),_c.set(-hc.x,-hc.y,hc.z),zn.transformMat4(s[6],_c,n),_c.set(hc.x,-hc.y,hc.z),zn.transformMat4(s[7],_c,n),e.updatePlanes(),e}},{key:"create",value:function(){return new e}},{key:"clone",value:function(t){return e.copy(new e,t)}},{key:"copy",value:function(e,t){e._type=t._type;for(var n=0;n<6;++n)Ns.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)zn.copy(e.vertices[i],t.vertices[i]);return e}}]),e}();fc.createOrtho=function(e,t,n,i,r,a){var o=t/2,s=n/2;zn.set(_c,o,s,-i),zn.transformMat4(e.vertices[0],_c,a),zn.set(_c,-o,s,-i),zn.transformMat4(e.vertices[1],_c,a),zn.set(_c,-o,-s,-i),zn.transformMat4(e.vertices[2],_c,a),zn.set(_c,o,-s,-i),zn.transformMat4(e.vertices[3],_c,a),zn.set(_c,o,s,-r),zn.transformMat4(e.vertices[4],_c,a),zn.set(_c,-o,s,-r),zn.transformMat4(e.vertices[5],_c,a),zn.set(_c,-o,-s,-r),zn.transformMat4(e.vertices[6],_c,a),zn.set(_c,o,-s,-r),zn.transformMat4(e.vertices[7],_c,a),Ns.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Ns.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Ns.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Ns.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Ns.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Ns.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(cc||(cc={})),function(e){e[e.Default=cc.Default]="Default",e[e.Normal=cc.Normal]="Normal",e[e.Reverse=cc.Reverse]="Reverse",e[e.Loop=cc.Loop]="Loop",e[e.LoopReverse=cc.Loop|cc.Reverse]="LoopReverse",e[e.PingPong=cc.PingPong]="PingPong",e[e.PingPongReverse=cc.PingPong|cc.Reverse]="PingPongReverse"}(lc||(lc={})),yt(lc);var dc=function(){function e(t){K(this,e),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return Z(e,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),e}();function pc(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-6,i=0,r=e.length-1,a=r>>>1;i<=r;a=i+r>>>1){var o=e[a];if(o>t+n)r=a-1;else{if(!(o<t-n))return a;i=a+1}}return~i}var mc=function(){},vc=function(){return mc},gc=yc((function(){}));function yc(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function xc(e){return function(t){return function(n){!function(e,t,n){var i=Tc(e);if(i){var r=Ec(i,"proto");Ec(r,"editor")[t]=n}}(n,e,t)}}}var Sc="__ccclassCache__";function Tc(e){return Ec(e,Sc)}function Ec(e,t){return e[t]||(e[t]={})}var Cc=yc((function(e,t){var n=dt.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[Sc];if(r){var a=r.proto;a&&dt.mixin(i,a),e[Sc]=void 0}return un(i)})),Ac=xc("requireComponent"),bc=xc("executionOrder"),wc=gc;function Rc(e,t,n){var i=null;function r(e,t,n){var r=Tc(e.constructor);if(r){var a=Ec(r,"proto"),o=Ec(a,"properties");!function(e,t,n,i,r,a){var o,s=r&&(r.get||r.set);i&&(o=$t(i,s));var c=t[n],l=dt.mixin(c||{},o||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!==Y(t)||null===t?t:e}(r.initializer));else{var u=a.default||(a.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(n)&&(l.default=u[n])}t[n]=l}(e.constructor,o,t,i,n,r)}}return void 0===e?Rc({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}var Pc=Symbol("cc:SerializationMetadata"),Ic=function(e,t,n){return Rc(Nc({}))(e,t,n)};function Dc(e){return Rc(Nc({formerlySerializedAs:e}))}var Oc=function(e,t,n){return Rc({editorOnly:!0})(e,t,n)};function Nc(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var Mc=mc,kc=gc,Lc=vc,Bc=gc,Fc=vc,zc=vc,Uc=vc,Gc=mc,Hc=vc,Vc=mc,jc=vc,Wc=vc,qc=vc,Xc=vc,Yc=vc,Kc=vc,Qc=mc,Zc=vc,Jc=mc,$c=mc,el=rl(Vt),tl=rl(jt),nl=rl(Wt),il=rl(qt);function rl(e){return Rc({type:e})}var al,ol,sl,cl,ll,ul,hl,_l,fl,dl=function(e,t,n){return Rc({__noImplicit:!0,override:!0})(e,t,n)},pl=Cc("cc.KeyframeCurve")((al=Symbol.iterator,ul=function(){function e(){K(this,e),ye(this,"_times",cl,this),ye(this,"_values",ll,this)}return Z(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}},{key:al,value:function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}}},{key:"keyframes",value:function(){return this}},{key:"times",value:function(){return this._times}},{key:"values",value:function(){return this._values}},{key:"getKeyframeTime",value:function(e){return this._times[e]}},{key:"getKeyframeValue",value:function(e){return this._values[e]}},{key:"addKeyFrame",value:function(e,t){return this._insertNewKeyframe(e,t)}},{key:"removeKeyframe",value:function(e){this._times.splice(e,1),this._values.splice(e,1)}},{key:"indexOfKeyframe",value:function(e){return pc(this._times,e)}},{key:"updateTime",value:function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)}},{key:"assignSorted",value:function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return de(e,1)[0]})),n.map((function(e){return de(e,2)[1]})))}}},{key:"clear",value:function(){this._times.length=0,this._values.length=0}},{key:"searchKeyframe",value:function(e){return pc(this._times,e)}},{key:"setKeyframes",value:function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||vn(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t}},{key:"_insertNewKeyframe",value:function(e,t){var n=this._times,i=this._values,r=n.length,a=pc(n,e);if(a>=0)return a;var o=~a;return 0===o?(n.unshift(e),i.unshift(t)):o===r?(n.push(e),i.push(t)):(n.splice(o-1,0,e),i.splice(o-1,0,t)),o}}]),e}(),cl=xe((sl=ul).prototype,"_times",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ll=xe(sl.prototype,"_values",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ol=sl))||ol;function ml(e){return e>-1e-9&&e<1e-9}!function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(hl||(hl=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(_l||(_l=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(fl||(fl=e("TangentWeightMode",{})));var vl=e("editorExtrasTag","__editorExtras__"),gl=function e(){K(this,e)},yl=Object.freeze({__proto__:null,uniquelyReferenced:Mc,ccclass:Cc,property:Rc,requireComponent:Ac,executionOrder:bc,disallowMultiple:wc,allowReplicated:function(e){un.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:kc,menu:Lc,playOnFocus:Bc,inspector:Fc,icon:zc,help:Uc,type:rl,integer:el,float:tl,boolean:nl,string:il});e("_decorator",yl);var xl=1<<22,Sl=[],Tl=e("CCObject",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";K(this,e),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}return Z(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&xl)},set:function(e){e?this._objFlags|=xl:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}},{key:"destroy",value:function(){return 1&this._objFlags?(P(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Sl.push(this),0))}},{key:"_destruct",value:function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,i=e instanceof c._BaseNode||e instanceof c.Component,r=i?"_id":null,a={};for(n in e)if(e.hasOwnProperty(n)){if(n===r)continue;switch(Y(e[n])){case"string":a[n]="";break;case"object":case"function":a[n]=null}}if(un._isCCClass(t))for(var o=c.Class.Attr.getClassAttrs(t),s=t.__props__,l=0;l<s.length;l++){n=s[l];var u="".concat(n+c.Class.Attr.DELIMETER,"default");if(u in o){if(i&&"_id"===n)continue;switch(Y(o[u])){case"string":a[n]="";break;case"object":case"function":a[n]=null;break;case"undefined":a[n]=void 0}}}var h="";for(n in a){var _;_=un.IDENTIFIER_RE.test(n)?"o.".concat(n,"="):"o[".concat(un.escapeForJS(n),"]=");var f=a[n];""===f&&(f='""'),h+="".concat(_+f,";\n")}return Function("o",h)}(this,e),ke(e,"__destruct__",t,!0)),t(this)}},{key:"_destroyImmediate",value:function(){1&this._objFlags?D(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}}],[{key:"_deferredDestroy",value:function(){for(var e=Sl.length,t=0;t<e;++t){var n=Sl[t];1&n._objFlags||n._destroyImmediate()}e===Sl.length?Sl.length=0:Sl.splice(0,e)}}]),e}()),El=Tl.prototype;function Cl(e,t){return"object"===Y(e)?!(!e||e._objFlags&(t?5:1)):void 0!==e}El._deserialize=null,El._onPreDestroy=null,un.fastDefine("cc.Object",Tl,J({_name:"",_objFlags:0},vl,{})),un.Attr.setClassAttr(Tl,vl,"editorOnly",!0),un.Attr.setClassAttr(Tl,"replicated","visible",!1),ke(Tl,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),c.isValid=Cl,c.Object=Tl;var Al=function(){function e(t){K(this,e),this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=dt.createMap(!0),this._count=0)}return Z(e,[{key:"add",value:function(e,t){return e in this._map||this._count++,this._map[e]=t}},{key:"get",value:function(e){return this._map[e]}},{key:"has",value:function(e){return e in this._map}},{key:"remove",value:function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t}},{key:"clear",value:function(){0!==this._count&&(this._map=dt.createMap(!0),this._count=0)}},{key:"forEach",value:function(e){for(var t in this._map)e(this._map[t],t)}},{key:"find",value:function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null}},{key:"count",get:function(){return this._count}},{key:"destroy",value:function(){this._map=null}}]),e}(),bl=function(){function e(t,n){K(this,e),this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}return Z(e,[{key:"insert",value:function(e,t){return t>this.pipes.length?(P(4921),this):(this.pipes.splice(t,0,e),this)}},{key:"append",value:function(e){return this.pipes.push(e),this}},{key:"remove",value:function(e){return this.pipes.splice(e,1),this}},{key:"sync",value:function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output}},{key:"async",value:function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))}},{key:"_flow",value:function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))}}]),e}();bl._pipelineId=0,Z((function e(t){if(K(this,e),this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(t)for(var n in t)this._weakMap[n]=new WeakRef(t[n])}),[{key:"add",value:function(e,t){return this._weakMap[e]=new WeakRef(t),t}},{key:"has",value:function(e){return e in this._weakMap&&!!this._weakMap[e].deref()}},{key:"get",value:function(e){return this._weakMap[e]&&this._weakMap[e].deref()}},{key:"remove",value:function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()}},{key:"clear",value:function(){this._weakMap=dt.createMap(!0)}},{key:"forEach",value:function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}}},{key:"find",value:function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null}},{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}},{key:"destroy",value:function(){this._weakMap={}}}]);var wl,Rl=new Al,Pl=new Al,Il=new Al,Dl=new Al,Ol=new bl("normal load",[]),Nl=new bl("fetch",[]),Ml=new bl("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(wl||(wl={}));var kl,Ll={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(kl||(kl={}));var Bl=function(){function e(t){K(this,e),this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}return Z(e,[{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object.create(null);this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)}},{key:"dispatch",value:function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var a="on".concat(e[0].toUpperCase()).concat(e.substr(1));"function"==typeof this[a]&&this[a](t,n,i,r)}}},{key:"recycle",value:function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))}}],[{key:"create",value:function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n}}]),e}();Bl.MAX_DEAD_NUM=500,Bl._taskId=0,Bl._deadPool=[];var Fl="0123456789abcdef".split(""),zl=["","","",""],Ul=zl.concat(zl,"-",zl,"-",zl,"-",zl,"-",zl,zl,zl),Gl=Ul.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Hl(e){var t=e.split("@")[0];if(22!==t.length)return e;Ul[0]=e[0],Ul[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=bt[e.charCodeAt(n)],a=bt[e.charCodeAt(n+1)];Ul[Gl[i++]]=Fl[r>>2],Ul[Gl[i++]]=Fl[(3&r)<<2|a>>4],Ul[Gl[i++]]=Fl[15&a]}return e.replace(t,Ul.join(""))}var Vl=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function jl(e){var t=Vl.exec(e);return t?t[1]:""}function Wl(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.ext=t.nativeExt;var n=Dl.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),Yl(e,t)}function ql(e){return!!e&&(e instanceof c.SceneAsset||e instanceof c.Scene)}function Xl(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function Yl(e,t){var n=Bl.create({input:e,options:t}),i=[];try{for(var r,a=ge(Ml.sync(n));!(r=a()).done;){var o=r.value,s=o.url;o.recycle(),i.push(s)}}catch(e){for(var c,l=ge(n.output);!(c=l()).done;)c.value.recycle();x(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var Kl=Object.freeze({__proto__:null,getUuidFromURL:jl,getUrlWithUuid:Wl,isScene:ql,normalize:Xl,transform:Yl,decodeUuid:Hl}),Ql=new(function(){function e(){K(this,e),this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}return Z(e,[{key:"addContainer",value:function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))}},{key:"removeContainer",value:function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,dt.array.fastRemoveAt(this._pools,e._poolHandle),e._poolHandle=-1)}},{key:"tryShrink",value:function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()}},{key:"update",value:function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)}}]),e}()),Zl=function(){function e(){K(this,e),this._poolHandle=-1,Ql.addContainer(this)}return Z(e,[{key:"destroy",value:function(){Ql.removeContainer(this)}}]),e}(),Jl=e("Pool",function(e){te(n,e);var t=le(n);function n(e,i,r){var a;K(this,n),(a=t.call(this))._ctor=void 0,a._elementsPerBatch=void 0,a._nextAvail=void 0,a._freepool=[],a._dtor=void 0,a._ctor=e,a._dtor=r||null,a._elementsPerBatch=Math.max(i,1),a._nextAvail=a._elementsPerBatch-1;for(var o=0;o<a._elementsPerBatch;++o)a._freepool.push(e());return a}return Z(n,[{key:"alloc",value:function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]}},{key:"free",value:function(e){this._freepool[++this._nextAvail]=e}},{key:"freeArray",value:function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length}},{key:"tryShrink",value:function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}}},{key:"destroy",value:function(){var e=arguments.length>0?arguments[0]:null;e&&P(14100);var t=e||this._dtor;if(t)for(var i=0;i<=this._nextAvail;i++)t(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,he(ne(n.prototype),"destroy",this).call(this)}}]),n}(Zl)),$l=e("RecyclePool",function(e){te(n,e);var t=le(n);function n(e,i,r){var a;K(this,n),(a=t.call(this))._fn=void 0,a._dtor=null,a._count=0,a._data=void 0,a._initSize=0,a._fn=e,a._dtor=r||null,a._data=new Array(i),a._initSize=i;for(var o=0;o<i;++o)a._data[o]=e();return a}return Z(n,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}},{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]}},{key:"destroy",value:function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,he(ne(n.prototype),"destroy",this).call(this)}},{key:"tryShrink",value:function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}}}]),n}(Zl)),eu=e("CachedArray",function(e){te(n,e);var t=le(n);function n(e,i){var r;return K(this,n),(r=t.call(this)).array=void 0,r.length=0,r._compareFn=void 0,r._initSize=0,r.array=new Array(e),r._initSize=e,r.length=0,r._compareFn=void 0!==i?i:function(e,t){return e-t},r}return Z(n,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[--this.length]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.length=0}},{key:"destroy",value:function(){this.length=0,this.array.length=0,he(ne(n.prototype),"destroy",this).call(this)}},{key:"tryShrink",value:function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]}},{key:"fastRemove",value:function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}}},{key:"indexOf",value:function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1}}]),n}(Zl));e("memop",Object.freeze({__proto__:null,Pool:Jl,RecyclePool:$l,CachedArray:eu}));var tu=ft.fastRemoveAt;function nu(){}var iu=function(){function e(){K(this,e),this.callback=nu,this.target=void 0,this.once=!1}return Z(e,[{key:"set",value:function(e,t,n){this.callback=e||nu,this.target=t,this.once=!!n}},{key:"reset",value:function(){this.target=void 0,this.callback=nu,this.once=!1}},{key:"check",value:function(){return!(this.target instanceof Tl&&!Cl(this.target,!0))}}]),e}(),ru=new Jl((function(){return new iu}),32),au=function(){function e(){K(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return Z(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),ru.free(n),tu(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),ru.free(n),tu(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:tu(this.callbackInfos,e),ru.free(t)),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),ru.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||tu(this.callbackInfos,e);this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),ou=new Jl((function(){return new au}),16),su=function(){function e(){K(this,e),this._callbackTable=ze(!0),this._offCallback=void 0}return Z(e,[{key:"on",value:function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=ou.alloc());var a=ru.alloc();a.set(t,n,i),r.callbackInfos.push(a)}return t}},{key:"hasEventListener",value:function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var a=0;a<r.length;++a)if(r[a])return!0;return!1}return r.length>0}for(var o=0;o<r.length;++o){var s=r[o];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1}},{key:"removeAll",value:function(e){var t=Y(e);if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),ou.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var a=r.callbackInfos,o=0;o<a.length;++o){var s=a[o];s&&s.target===e&&r.cancel(o)}else r.removeByTarget(e)}}},{key:"off",value:function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var a=r.callbackInfos;if(t)for(var o=0;o<a.length;++o){var s=a[o];if(s&&s.callback===t&&s.target===n){r.cancel(o);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)}},{key:"emit",value:function(e,t,n,i,r,a){var o=this._callbackTable&&this._callbackTable[e];if(o){var s=!o.isInvoking;o.isInvoking=!0;for(var c=o.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(e,_,f),h.check()?f?_.call(f,t,n,i,r,a):_(t,n,i,r,a):this.off(e,_,f)}}s&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}}},{key:"clear",value:function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),ou.free(t),delete this._callbackTable[e])}}},{key:"_registerOffCallback",value:function(e){this._offCallback=e}}]),e}();function cu(e){for(var t=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._callbackTable=ze(!0),e}return Z(n,[{key:"once",value:function(e,t,n){return this.on(e,t,n,!0)}},{key:"targetOff",value:function(e){this.removeAll(e)}}]),n}(e),n=su.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var a=i[r];if(!(a in t.prototype)){var o=Object.getOwnPropertyDescriptor(n,a);o&&Object.defineProperty(t.prototype,a,o)}}return t}var lu=e("EventTarget",cu((function e(){K(this,e)})));c.EventTarget=lu;var uu,hu,_u,fu,du,pu,mu,vu=new(function(){function e(){K(this,e),this._finalizationRegistry=null}return Z(e,[{key:"registerGCObject",value:function(e){return e}},{key:"unregisterGCObject",value:function(){}},{key:"init",value:function(){}},{key:"finalizationRegistryCallback",value:function(e){e.isValid&&e.destroy()}},{key:"destroy",value:function(){}}]),e}()),gu=Cc("cc.GCObject")(uu=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ce(e=t.call.apply(t,[this].concat(r)),vu.registerGCObject(se(e)))}return Z(n,[{key:"equals",value:function(e){return!!e&&e===this}},{key:"destroy",value:function(){return vu.unregisterGCObject(this),he(ne(n.prototype),"destroy",this).call(this)}}]),n}(Tl))||uu;!function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(hu||(hu={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(_u||(_u={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(fu||(fu={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(du||(du={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(pu||(pu={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(mu||(mu={}));var yu,xu,Su,Tu,Eu=new(function(e){te(n,e);var t=le(n);function n(){var e,i,r;K(this,n),(r=t.call(this)).networkType=void 0,r.isNative=void 0,r.isBrowser=void 0,r.isMobile=void 0,r.isLittleEndian=void 0,r.platform=void 0,r.language=void 0,r.nativeLanguage=void 0,r.os=void 0,r.osVersion=void 0,r.osMainVersion=void 0,r.browserType=void 0,r.browserVersion=void 0,r._battery=void 0,r._featureMap=void 0;var a,o=window.navigator,s=o.userAgent.toLowerCase();null===(e=o.getBattery)||void 0===e||e.call(o).then((function(e){r._battery=e})),r.networkType=fu.LAN,r.isNative=!1,r.isBrowser=!0,r.isMobile=/mobile|android|iphone|ipad/.test(s),r.platform=r.isMobile?pu.MOBILE_BROWSER:pu.DESKTOP_BROWSER,r.isLittleEndian=(a=new ArrayBuffer(2),new DataView(a).setInt16(0,256,!0),256===new Int16Array(a)[0]);var c=o.language;r.nativeLanguage=c.toLowerCase(),c=(c=c||o.browserLanguage)?c.split("-")[0]:_u.ENGLISH,r.language=c;var l=!1,u=!1,h="",_=0,f=/android\s*(\d+(?:\.\d+)*)/i.exec(s)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);f&&(l=!0,h=f[1]||"",_=parseInt(h)||0),(f=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(s))?(u=!0,h=f[2]||"",_=parseInt(h)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(u=!0,h="",_=0);var d=du.UNKNOWN;-1!==o.appVersion.indexOf("Win")?d=du.WINDOWS:u?d=du.IOS:-1!==o.appVersion.indexOf("Mac")?d=du.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?d=du.LINUX:l?d=du.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===s.indexOf("ubuntu")||(d=du.LINUX),r.os=d,r.osVersion=h,r.osMainVersion=_,r.browserType=hu.UNKNOWN;var p=/wechat|weixin|micromessenger/i.exec(s)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(s)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(s)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(s),m=p?p[0].toLowerCase():du.UNKNOWN;("safari"===m&&l||"qq"===m&&/android.*applewebkit/i.test(s))&&(m=hu.ANDROID);var v={micromessenger:hu.WECHAT,wechat:hu.WECHAT,weixin:hu.WECHAT,trident:hu.IE,edge:hu.EDGE,"360 aphone":hu.BROWSER_360,mxbrowser:hu.MAXTHON,"opr/":hu.OPERA,ubrowser:hu.UC,huaweibrowser:hu.HUAWEI};r.browserType=v[m]||m,r.browserVersion="";var g=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(s);g||(g=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(s)),r.browserVersion=g?g[4]:"";var y,x=document.createElement("canvas");x.getContext("2d");try{y=x.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){y=!1}var S=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(x.width=x.height=2,createImageBitmap(x,{}).then((function(e){S=!0,null==e||e.close()})).catch((function(){})));var T=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,E=void 0!==document.documentElement.onmouseup;return r._featureMap=(J(i={},mu.WEBP,y),J(i,mu.IMAGE_BITMAP,S),J(i,mu.WEB_VIEW,!0),J(i,mu.VIDEO_PLAYER,!0),J(i,mu.SAFE_AREA,!1),J(i,mu.INPUT_TOUCH,T),J(i,mu.EVENT_KEYBOARD,void 0!==document.documentElement.onkeyup),J(i,mu.EVENT_MOUSE,E),J(i,mu.EVENT_TOUCH,T||E),J(i,mu.EVENT_ACCELEROMETER,void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent),i),r._registerEvent(),r}return Z(n,[{key:"_registerEvent",value:function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,a,o){n&&(n=!1,t.emit("show",e,i,r,a,o))};if(e)for(var a=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],o=0;o<a.length;o++)document.addEventListener(a[o],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))}},{key:"hasFeature",value:function(e){return this._featureMap[e]}},{key:"getBatteryLevel",value:function(){return this._battery?this._battery.level:1}},{key:"triggerGC",value:function(){}},{key:"openURL",value:function(e){window.open(e)}},{key:"now",value:function(){return Date.now?Date.now():+new Date}},{key:"restartJSVM",value:function(){}},{key:"close",value:function(){this.emit("close"),window.close()}}]),n}(lu)),Cu=/(\.[^\.\/\?\\]*)(\?.*)?$/,Au=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,bu=/[^\.\/]+\/\.\.\//;function wu(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,a=n;r<a.length;r++){var o=a[r];e=(e+(""===e?"":"/")+o).replace(/(\/|\\\\)$/,"")}return e}function Ru(e){var t=Cu.exec(e);return t?t[1]:""}function Pu(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function Iu(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function Du(e){var t=Au.exec(e);return t?t[2]:""}function Ou(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function Nu(e,t,n){if(0===t.indexOf("."))return Ou(e,t);var i=e.indexOf("?"),r="",a=n?Ru(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+a+r}function Mu(e){var t=e=String(e);do{t=e,e=e.replace(bu,"")}while(t.length!==e.length);return e}function ku(e){return e.replace(/[\/\\]$/,"")}function Lu(){return Eu.os===du.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:wu,extname:Ru,mainFileName:Pu,basename:Iu,dirname:Du,changeExtname:Ou,changeBasename:Nu,_normalize:Mu,stripSep:ku,getSeperator:Lu}));var Bu,Fu,zu,Uu=e("Asset",Cc("cc.Asset")((Tu=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).loaded=!0,ye(e,"_native",Su,se(e)),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(se(e),"_uuid",{value:"",writable:!0}),e}return Z(n,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=Wl(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=Wl(this._uuid,{__nativeName__:e,nativeExt:Ru(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"toString",value:function(){return this.nativeUrl}},{key:"serialize",value:function(){}},{key:"_setRawAsset",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._native=!1!==t?e||"":"/".concat(e)}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}},{key:"addRef",value:function(){return this._ref++,this}},{key:"decRef",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._ref>0&&this._ref--,e&&c.assetManager._releaseManager.tryRelease(this),this}},{key:"onLoaded",value:function(){}},{key:"initDefault",value:function(e){e&&(this._uuid=e),this.isDefault=!0}},{key:"validate",value:function(){return!0}},{key:"destroy",value:function(){return T(k(12101,this._uuid)),he(ne(n.prototype),"destroy",this).call(this)}}],[{key:"deserialize",value:function(e){return c.deserialize(e)}}]),n}(cu(gu)),Su=xe((xu=Tu).prototype,"_native",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xe(xu.prototype,"_nativeAsset",[Rc],Object.getOwnPropertyDescriptor(xu.prototype,"_nativeAsset"),xu.prototype),yu=xu))||yu);Uu.prototype.createNode=null,c.Asset=Uu;var Gu=e("Script",Cc("cc.Script")(Bu=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(Uu))||Bu);c._Script=Gu;var Hu=e("JavaScript",Cc("cc.JavaScript")(Fu=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(Gu))||Fu);c._JavaScript=Hu;var Vu,ju,Wu,qu,Xu,Yu,Ku,Qu,Zu,Ju,$u,eh=e("TypeScript",Cc("cc.TypeScript")(zu=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(Gu))||zu);c._TypeScript=eh;var th,nh,ih,rh,ah=new we("Comp"),oh=Tl.Flags.IsOnLoadCalled,sh=e("Component",(Vu=Cc("cc.Component"),ju=jc(),Wu=rl(Gu),qu=Wc(),Vu(($u=Ju=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"node",Ku,se(e)),ye(e,"_enabled",Qu,se(e)),ye(e,"__prefab",Zu,se(e)),e._sceneGetter=null,e._id=ah.getNewId(),e}return Z(n,[{key:"name",get:function(){if(this._name)return this._name;var e=Ue(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?"".concat(this.node.name,"<").concat(e,">"):e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=c.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&oh}},{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){return!!he(ne(n.prototype),"destroy",this).call(this)&&(this._enabled&&this.node.activeInHierarchy&&c.director._compScheduler.disableComp(this),!0)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks(),c.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return e||(e=c.instantiate._clone(this,this)),e&&(e.node=null),e}},{key:"schedule",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:c.macro.REPEAT_FOREVER,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;M(e,1619),M((t=t||0)>=0,1620),n=Number.isNaN(n)?c.macro.REPEAT_FOREVER:n,i=i||0;var r=c.director.getScheduler(),a=r.isTargetPaused(this);r.schedule(e,this,t,n,i,a)}},{key:"scheduleOnce",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.schedule(e,0,0,t)}},{key:"unschedule",value:function(e){e&&c.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){c.director.getScheduler().unscheduleAllForTarget(this)}}]),n}(Tl),Ju.system=null,xe((Yu=$u).prototype,"__scriptAsset",[ju,Wu,qu,$c],Object.getOwnPropertyDescriptor(Yu.prototype,"__scriptAsset"),Yu.prototype),Ku=xe(Yu.prototype,"node",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qu=xe(Yu.prototype,"_enabled",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Zu=xe(Yu.prototype,"__prefab",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xu=Yu))||Xu)),ch=sh.prototype;ch.update=null,ch.lateUpdate=null,ch.__preload=null,ch.onLoad=null,ch.start=null,ch.onEnable=null,ch.onDisable=null,ch.onDestroy=null,ch.onFocusInEditor=null,ch.onLostFocusInEditor=null,ch.resetInEditor=null,ch._getLocalBounds=null,ch.onRestore=null,sh._requireComponent=null,sh._executionOrder=0,ke(sh,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),c.Component=sh;var lh,uh=e("MissingScript",Cc("cc.MissingScript")(th=Fc()((rh=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"_$erialized",ih,se(e)),e}return Z(n,[{key:"onLoad",value:function(){P(4600,this.node.name)}}],[{key:"safeFindClass",value:function(e){var t=lt(e);if(t)return t;c.deserialize.reportMissingClass(e)}}]),n}(sh),ih=xe((nh=rh).prototype,"_$erialized",[Ic,Oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),th=nh))||th)||th);c._MissingScript=uh;try{var hh=uh.__values__;0!==hh.length&&"_$erialized"===hh[hh.length-1]||(x("The '_$erialized' prop in MissingScript is missing. Please contact jare."),x("    Error props: ['".concat(hh,"']")))}catch(no){x("Error when checking MissingScript 5, ".concat(no))}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(lh||(lh={}));var _h,fh={auto:lh.AUTO,landscape:lh.LANDSCAPE,portrait:lh.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(_h||(_h={}));var dh=new(function(e){te(n,e);var t=le(n);function n(){var e,i,r,a,o,s;K(this,n),(e=t.call(this)).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new hi(0,0),e._exactFitScreen=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=lh.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null===(i=e._gameCanvas)||void 0===i||null===(r=i.parentNode)||void 0===r||r.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(a=e._gameCanvas)||void 0===a||null===(o=a.parentNode)||void 0===o||o.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var c=e._fnGroup,l=0;l<c.length;l++)if(s=c[l],void 0!==document[s[1]]){for(var u=0;u<s.length;u++)e._fn[c[0][u]]=s[u];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}return Z(n,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!==(e=window.devicePixelRatio)&&void 0!==e?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===_h.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):P(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new hi(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new hi(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(P(9201),new hi(0,0));var e,t,n;switch(this._windowType){case _h.SubFrame:return this._gameFrame?new hi(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(P(9201),new hi(0,0));case _h.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new hi(t,n);case _h.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new hi(t,n);case _h.Unknown:default:return new hi(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?_h.Fullscreen:this._gameFrame?this._exactFitScreen?_h.BrowserWindow:_h.SubFrame:(P(9201),_h.Unknown)}},{key:"init",value:function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=fh[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()}},{key:"requestFullScreen",value:function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))}},{key:"exitFullScreen",value:function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))}},{key:"_registerEvent",value:function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: ".concat(r,"dppx)")))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))}},{key:"_convertToSizeInCssPixels",value:function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t}},{key:"_resizeFrame",value:function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===_h.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width="".concat(e.width,"px"),this._gameFrame.style.height="".concat(e.height,"px")}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 ".concat(t,"px"),this._gameFrame.style.width="".concat(n,"px"),this._gameFrame.style.height="".concat(t,"px")):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width="".concat(t,"px"),this._gameFrame.style.height="".concat(n,"px"))}this._updateContainer()}}},{key:"_getFullscreenTarget",value:function(){var e=this._windowType;return e===_h.Fullscreen?document[this._fn.fullscreenElement]:e===_h.SubFrame?this._gameFrame:document.body}},{key:"_doRequestFullScreen",value:function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))}},{key:"_updateFrameState",value:function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=Eu.isMobile&&(t&&e===lh.PORTRAIT||!t&&e===lh.LANDSCAPE)}},{key:"_updateContainer",value:function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void P(9201);var e,t,n=c.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,a=i.clientHeight,o=n.width,s=n.height,l=r/o,u=a/s,h=this._gameContainer.style;l<u?(e=r,t=s*l):(e=o*u,t=a),h.width="".concat(e,"px"),h.height="".concat(t,"px")}else{var _=this._gameContainer.style;_.width="100%",_.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else P(9201)}}]),n}(lu)),ph=function(){function e(){K(this,e)}return Z(e,[{key:"_init",value:function(e){dh.init(e,(function(){var e,t=c.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=dh.resolutionScale:P(1220)}))}},{key:"devicePixelRatio",get:function(){return dh.devicePixelRatio}},{key:"windowSize",get:function(){return dh.windowSize},set:function(e){dh.windowSize=e}},{key:"resolution",get:function(){return dh.resolution}},{key:"supportsFullScreen",get:function(){return dh.supportFullScreen}},{key:"fullScreen",value:function(){return dh.isFullScreen}},{key:"requestFullScreen",value:function(e,t,n){return arguments.length>0&&P(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),dh.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))}},{key:"exitFullScreen",value:function(){return dh.exitFullScreen()}},{key:"autoFullScreen",value:function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))}},{key:"disableAutoFullScreen",value:function(){}}]),e}(),mh=e("screen",new ph);c.screen=mh;var vh=e("sys",{Feature:mu,hasFeature:function(e){return Eu.hasFeature(e)},NetworkType:fu,Language:_u,OS:du,Platform:pu,BrowserType:hu,isNative:Eu.isNative,isBrowser:Eu.isBrowser,isMobile:Eu.isMobile,isLittleEndian:Eu.isLittleEndian,platform:Eu.platform,language:Eu.language,languageCode:Eu.nativeLanguage,os:Eu.os,osVersion:Eu.osVersion,osMainVersion:Eu.osMainVersion,browserType:Eu.browserType,browserVersion:Eu.browserVersion,windowPixelResolution:mh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:Eu.hasFeature(mu.WEBP),imageBitmap:Eu.hasFeature(mu.IMAGE_BITMAP),touches:Eu.hasFeature(mu.INPUT_TOUCH),mouse:Eu.hasFeature(mu.EVENT_MOUSE),keyboard:Eu.hasFeature(mu.EVENT_KEYBOARD),accelerometer:Eu.hasFeature(mu.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return Eu.networkType},getBatteryLevel:function(){return Eu.getBatteryLevel()},garbageCollect:function(){Eu.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : ".concat(this.isMobile,"\r\n"),e+="language : ".concat(this.language,"\r\n"),e+="browserType : ".concat(this.browserType,"\r\n"),e+="browserVersion : ".concat(this.browserVersion,"\r\n"),e+="capabilities : ".concat(JSON.stringify(this.capabilities),"\r\n"),e+="os : ".concat(this.os,"\r\n"),e+="osVersion : ".concat(this.osVersion,"\r\n"),e+="platform : ".concat(this.platform,"\r\n"),g(e+="Using ".concat(c.game.renderType===c.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS"," renderer.\r\n"))},openURL:function(e){Eu.openURL(e)},now:function(){return Eu.now()},restartVM:function(){Eu.restartJSVM()},getSafeAreaRect:function(){var e=c.view,t=dh.safeAreaEdge,n=dh.windowSize,i=new ri(t.left,t.bottom),r=new ri(n.width-t.right,n.height-t.top);e._convertToUISpace(i),e._convertToUISpace(r);var a=i.x,o=i.y,s=r.x-i.x,l=r.y-i.y;return new fi(a,o,s,l)}});!function(){try{var e=vh.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){P(5200)};vh.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}vh.__isWebIOS14OrIPadOS14Env=(vh.os===du.IOS||vh.os===du.OSX)&&Eu.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),c.sys=vh;var gh=e("serializeTag",Symbol("[[Serialize]]")),yh=e("deserializeTag",Symbol("[[Deserialize]]")),xh=function(){function e(t,n){K(this,e),this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=n}return Z(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function Sh(e){var t=e;return{chunks:t.chunks,document:t.document}}function Th(e){if(e.length<16)throw new Eh(k(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new Eh(k(13100));var n=t.getUint32(4,!0);if(1!==n)throw new Eh(k(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new Eh(k(13102));var i=12,r=t.getUint32(i,!0);i+=4;var a=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var o,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(k(13104))}(a);try{o=JSON.parse(s)}catch(e){throw new Eh(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new Eh(k(13102));return new xh(o,c)}var Eh=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(oe(Error));function Ch(e,t,n,i,r){if(t instanceof c.ValueType){r||e.push("if(prop){");var a=Ue(t);e.push("s._deserializeFastDefinedObject(o".concat(n,",prop,").concat(a,");")),r||e.push("}else o".concat(n,"=null;"))}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, ".concat(i,");\n} else {\n    o").concat(n,"=null;\n}\n"))}Z((function e(){K(this,e),this._viewOrPaddings=[],this._length=0}),[{key:"byteLength",get:function(){return this._length}},{key:"alignAs",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0}},{key:"append",value:function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"get",value:function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e}}]),c.internal.parseCCONJson=Sh,c.internal.decodeCCONBinary=Th,c.internal.CCON=xh;var Ah=Lt,bh="".concat(Ah,"type"),wh="".concat(Ah,"default"),Rh="".concat(Ah,"formerlySerializedAs"),Ph=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.call(this,(function(e){e.clear()}),1)}return Z(n,[{key:"get",value:function(e,t,n,i,r){var a=this._get();return a?(a.reset(e,t,n,i,r),a):new Ih(e,t,n,i,r)}}]),n}(_t),Ih=function(){function e(t,n,i,r){K(this,e),this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=r,this.deserializedList=[],this.deserializedData=null,this._classFinder=n,this._reportMissingClass=i,this._onDereferenced=null==n?void 0:n.onDereferenced}return Z(e,[{key:"reset",value:function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}},{key:"clear",value:function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null}},{key:"deserialize",value:function(e){var t,n=!1;e instanceof xh?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData}},{key:"_deserializeObject",value:function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}}},{key:"_deserializeTypedArrayView",value:function(e){return globalThis[e.ctor].from(e.array)}},{key:"_deserializeTypedArrayViewRef",value:function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)}},{key:"_deserializeArray",value:function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"===Y(t=e[i])&&t?this._deserializeAndAssignField(n,t,"".concat(i))&&(n[i]=null):n[i]=t;return n}},{key:"_deserializePlainObject",value:function(e){var t={};return this._fillPlainObject(t,e),t}},{key:"_deserializeTypeTaggedObject",value:function(e,t,n,i){var r=this,a=e.__type__,o=this._classFinder(a,e,n,i);if(!o)return this._classFinder===lt&&this._reportMissingClass(a),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(o);return this._deserializeInto(e,s,o),s}},{key:"_deserializeInto",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];i||!t[yh]?t._deserialize?t._deserialize(e.content,this):c.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)}},{key:"_runCustomizedDeserialize",value:function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"===Y(n)&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=Je(n);r&&i._deserializeInto(e,t,r)}};t[yh](r,this._context)}},{key:"_deserializeFireClass",value:function(e,t,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(e,t){for(var n=Ut(t),i=t.__values__,r=["var prop;"],a=Tt.test(ht(t)),o=0;o<i.length;o++){var s=i[o],l=void 0,u=void 0;un.IDENTIFIER_RE.test(s)?(u='"'.concat(s,'"'),l=".".concat(s)):(u=un.escapeForJS(s),l="[".concat(u,"]"));var h=l;if(n[s+Rh]){var _=n[s+Rh];h=un.IDENTIFIER_RE.test(_)?".".concat(_):"[".concat(un.escapeForJS(_),"]")}r.push("prop=d".concat(h,";")),r.push("if(typeof ".concat("prop",'!=="undefined"){'));var f=un.getDefault(n[s+wh]);if(a){var d=void 0,p=n[s+bh];if(void 0===f&&p)d=p instanceof Ht;else{var m=Y(f);d="string"===m||"number"===m||"boolean"===m}d?r.push("o".concat(l,"=prop;")):Ch(r,f,l,u,!0)}else r.push("".concat("if(typeof ".concat("prop",'!=="object"){')+"o").concat(l,"=prop;")+"}else{"),Ch(r,f,l,u,!1),r.push("}");r.push("}")}return(c.js.isChildClassOf(t,c._BaseNode)||c.js.isChildClassOf(t,c.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===uh){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(x("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),x("    Error props: ['".concat(r,"']. Please contact jare.")));var a=i;i=function(e,t,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||x("Unable to load previously serialized data. ".concat(JSON.stringify(n)))}catch(e){x("Error when checking MissingScript 7, ".concat(e))}a(e,t,n,i)}}}catch(e){x("Error when checking MissingScript 6, ".concat(e))}ke(n,"__deserialize__",i,!0)}i(this,e,t,n)}},{key:"_deserializeAndAssignField",value:function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var a,o=this._serializedData[i];e[n]=this._deserializeObject(o,i,void 0,n),null===(a=this._onDereferenced)||void 0===a||a.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1}},{key:"_deserializeObjectField",value:function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)}},{key:"_fillPlainObject",value:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!==Y(i)?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}}},{key:"_deserializeFastDefinedObject",value:function(e,t,n){if(n===c.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===c.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==c.Color){if(n===c.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=Ut(n),r=n.__values__,a=0;a<r.length;a++){var o=r[a],s=t[o];void 0!==s||t.hasOwnProperty(o)||(s=un.getDefault(i[o+wh])),"object"!==Y(s)?e[o]=s:s?this._deserializeAndAssignField(e,s,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var l=t.a;e.a=void 0===l?255:l}}}]),e}();Ih.pool=new Ph;var Dh=[ri,zn,ci,qn,Bn,hi,fi,ei];function Oh(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var Nh=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},Oh,Oh,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){ei.fromArray(e,t,1)}],Mh=e("Details",function(){function e(){K(this,e),this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}return Z(e,[{key:"init",value:function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])}},{key:"reset",value:function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)}},{key:"push",value:function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")}}]),e}());function kh(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),a=i[1],o=i[2],s=n[n.length-1],c=1;c<s;++c)r[a[n[c]]]=t[c];for(;c<t.length;++c){var l=a[n[c]],u=i[n[c]+o];(0,Gh[u])(e,r,l,t[c])}return r}function Lh(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):D(5303,Ue(t)),i}function Bh(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function Fh(e){return function(t,n,i,r){n[i]=r;for(var a=0;a<r.length;++a)e(t,r,a,r[a])}}function zh(e,t,n,i){t[n]=null,e[8][i]=t}function Uh(e,t,n,i){t[n]=kh(e,i)}Mh.pool=new _t((function(e){e.reset()}),5),Mh.pool.get=function(){return this._get()||new Mh};var Gh=new Array(13);function Hh(e,t,n){return e||n(t),Object}function Vh(e,t,n,i,r,a,o){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||Hh(a,i,o);return t[n]=r,new r}}(n,i,t));s=Hh(a,t,o)}n[i]=s}function jh(e,t,n,i){for(var r=n||lt,a=e[3],o=0;o<a.length;++o){var s=a[o];"string"!=typeof s?Vh(r,s[0],s,0,t,n,i):Vh(r,s,a,o,t,n,i)}}function Wh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function qh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var i,r=!t;if(t=t||Mh.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Xh}return!1}(e)){t.init(e),n=n||{};var a,o=e[0],s=!1;if("object"===Y(o)&&(s=o.preprocessed,o=o.version),o<1)throw new Error(k(5304,o));n._version=o,n.result=t,e[0]=n,s||(jh(e,!1,n.classFinder,null!==(a=n.reportMissingClass)&&void 0!==a?a:qh.reportMissingClass),Wh(e)),c.game._isCloning=!0;var l=e[5],u=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],a=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--a);for(var o=0;o<a;++o)t[o]=kh(e,t[o]);for(var s=e[3],c=0;c<i;++c,++o){var l=n[c],u=t[o];if(l>=0){var h=s[l];t[o]=Lh(e,h,u)}else(0,Gh[l=~l])(e,t,o,u)}return r}(e);c.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,a=3*e[i];r<a;r+=3){var o=e[r],s=t[e[r+2]],c=e[r+1];c>=0?o[n[c]]=s:o[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],l,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],a=e[9],o=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=a[s];"number"==typeof l&&(l=l>=0?n[l]:~l,a[s]=l);var u=o[s];"number"==typeof u&&(o[s]=i[u])}}(e),i=l[u]}else i=function(e,t,n){var i,r=(n=n||{}).classFinder||lt,a=n.createAssetRefs||vh.platform===pu.EDITOR_CORE,o=n.customEnv,s=n.ignoreEditorOnly,l=null!==(i=n.reportMissingClass)&&void 0!==i?i:c.deserialize.reportMissingClass;t.init();var u=Ih.pool.get(t,r,l,o,s);c.game._isCloning=!0;var h=u.deserialize(e);return c.game._isCloning=!1,Ih.pool.put(u),a&&t.assignAssetsBy(EditorExtends.serialize.asAsset),h}(e,t,n);return r&&Mh.pool.put(t),i}Gh[0]=function(e,t,n,i){t[n]=i},Gh[1]=Bh,Gh[2]=Fh(Bh),Gh[3]=Fh(zh),Gh[4]=Uh,Gh[5]=function(e,t,n,i){Nh[i[0]](t[n],i)},Gh[6]=zh,Gh[7]=function(e,t,n,i){t[n].set(i)},Gh[8]=function(e,t,n,i){var r=new Dh[i[0]];Nh[i[0]](r,i),t[n]=r},Gh[9]=Fh(Uh),Gh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=Lh(e,r,i[1])},Gh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var a=1;a<i.length;a+=3){var o=i[a],s=i[a+1],c=i[a+2];(0,Gh[s])(e,r,o,c)}},Gh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var a=0;a<r.length;++a){var o=r[a],s=i[a+1];0!==s&&(0,Gh[s])(e,r,a,o)}},qh.Details=Mh,qh.reportMissingClass=function(e){D(5302,e)};var Xh=function e(t){K(this,e),this.preprocessed=!0,this.version=t};function Yh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}c.deserialize=qh;var Kh,Qh,Zh,Jh,$h,e_,t_,n_,i_,r_,a_,o_=Tl.Flags.Destroyed,s_=Tl.Flags.PersistentMask,c_=[];function l_(e){var t;if(e instanceof Tl){if(e._instantiate)return c.game._isCloning=!0,t=e._instantiate(null,!0),c.game._isCloning=!1,t;if(e instanceof c.Asset)throw new TypeError(k(6903))}return c.game._isCloning=!0,t=u_(e),c.game._isCloning=!1,t}function u_(e,t){var n;h_(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=c_.length;i<r;++i)c_[i]._iN$t=null;return c_.length=0,n}function h_(e,t,n){dt.value(e,"_iN$t",t,!0),c_.push(e);var i=e.constructor;if(c.Class._isCCClass(i))!function(e,t,n,i){for(var r=e.__values__,a=0;a<r.length;a++){var o=r[a],s=t[o];if("object"===Y(s)&&s){var c=n[o];c instanceof xt&&c.constructor===s.constructor?c.set(s):n[o]=s._iN$t||__(s,i)}else n[o]=s}}(i,e,t,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var a=e[r];if("object"===Y(a)&&a){if(a===t)continue;t[r]=a._iN$t||__(a,n)}else t[r]=a}e instanceof Tl&&(t._objFlags&=s_)}function __(e,t){if(e instanceof xt)return e.clone();if(e instanceof c.Asset)return e;var n;if(ArrayBuffer.isView(e)){var i=e.length;n=new e.constructor(i),e._iN$t=n,c_.push(e);for(var r=0;r<i;++r)n[r]=e[r];return n}if(Array.isArray(e)){var a=e.length;n=new Array(a),e._iN$t=n,c_.push(e);for(var o=0;o<a;++o){var s=e[o];"object"===Y(s)&&s?n[o]=s._iN$t||__(s,t):n[o]=s}return n}if(e._objFlags&o_)return null;var l=e.constructor;if(c.Class._isCCClass(l)){if(t)if(t instanceof c.Component){if(e instanceof c._BaseNode||e instanceof c.Component)return e}else if(t instanceof c._BaseNode)if(e instanceof c._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof c.Component&&e.node&&!e.node.isChildOf(t))return e;n=new l}else if(l===Object)n={};else{if(l)return e;n=Object.create(null)}return h_(e,n,t),n}function f_(e,t){return(t<<3)+e}function d_(e){return m_[e]}function p_(e){switch(e){case r_.Uint8:return Uint8Array;case r_.Uint16:return Uint16Array;case r_.Uint32:return Uint32Array;case r_.Int8:return Int8Array;case r_.Int16:return Int16Array;case r_.Int32:return Int32Array;case r_.Float32:return Float32Array;case r_.Float64:return Float64Array}}l_._clone=u_,c.instantiate=l_,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(r_||(r_={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(a_||(a_={})),e("CompactValueTypeArray",Cc("cc.CompactValueTypeArray")((n_=t_=function(){function e(){K(this,e),ye(this,"_byteOffset",Zh,this),ye(this,"_unitCount",Jh,this),ye(this,"_unitElement",$h,this),ye(this,"_length",e_,this)}return Z(e,[{key:"decompress",value:function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=d_(n.elementType),a=new(p_(i))(e,this._byteOffset,this._unitCount),o=new Array(this._length),s=0;s<this._length;++s)o[s]=r.decompress(a,s);return o}}],[{key:"lengthFor",value:function(e,t,n){return d_(t).requiredUnits*e.length*p_(n).BYTES_PER_ELEMENT}},{key:"compress",value:function(t,n,i,r,a,o){for(var s=d_(n),c=p_(i),l=s.requiredUnits*t.length,u=new c(r,a,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=f_(i,n),_._byteOffset=o,_._unitCount=l,_._length=t.length,_}}]),e}(),t_.StorageUnit=r_,t_.ElementType=a_,Zh=xe((Qh=n_).prototype,"_byteOffset",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jh=xe(Qh.prototype,"_unitCount",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$h=xe(Qh.prototype,"_unitElement",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f_(r_.Uint8,a_.Scalar)}}),e_=xe(Qh.prototype,"_length",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kh=Qh))||Kh);var m_=(J(i_={},a_.Scalar,{requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}}),J(i_,a_.Vec2,{requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new zn(e[2*t],e[2*t+1])}}),J(i_,a_.Vec3,{requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new zn(e[3*t],e[3*t+1],e[3*t+2])}}),J(i_,a_.Vec4,{requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new ci(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),J(i_,a_.Quat,{requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new qn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),J(i_,a_.Mat4,{requiredUnits:16,compress:function(e,t,n){ei.toArray(e,n,16*t)},decompress:function(e,t){return ei.fromArray(new ei,e,16*t)}}),i_);function v_(){return 0}function g_(e){return e}function y_(e){return e*e}function x_(e){return e*(2-e)}function S_(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function T_(e){return e*e*e}function E_(e){return--e*e*e+1}function C_(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function A_(e){return e*e*e*e}function b_(e){return 1- --e*e*e*e}function w_(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function R_(e){return e*e*e*e*e}function P_(e){return--e*e*e*e*e+1}function I_(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function D_(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function O_(e){return Math.sin(e*Math.PI/2)}function N_(e){return.5*(1-Math.cos(Math.PI*e))}function M_(e){return 0===e?0:Math.pow(1024,e-1)}function k_(e){return 1===e?1:1-Math.pow(2,-10*e)}function L_(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function B_(e){return 1-Math.sqrt(1-e*e)}function F_(e){return Math.sqrt(1- --e*e)}function z_(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function U_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function G_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function H_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function V_(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function j_(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function W_(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function q_(e){return 1-X_(1-e)}function X_(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function Y_(e){return e<.5?.5*q_(2*e):.5*X_(2*e-1)+.5}function K_(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function Q_(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}c._decorator=yl;var Z_=cf(y_,x_),J_=cf(T_,E_),$_=cf(A_,b_),ef=cf(R_,P_),tf=cf(D_,O_),nf=cf(M_,k_),rf=cf(B_,F_),af=cf(U_,G_),of=cf(V_,j_),sf=cf(q_,X_);function cf(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var lf,uf,hf=Object.freeze({__proto__:null,constant:v_,linear:g_,quadIn:y_,quadOut:x_,quadInOut:S_,cubicIn:T_,cubicOut:E_,cubicInOut:C_,quartIn:A_,quartOut:b_,quartInOut:w_,quintIn:R_,quintOut:P_,quintInOut:I_,sineIn:D_,sineOut:O_,sineInOut:N_,expoIn:M_,expoOut:k_,expoInOut:L_,circIn:B_,circOut:F_,circInOut:z_,elasticIn:U_,elasticOut:G_,elasticInOut:H_,backIn:V_,backOut:j_,backInOut:W_,bounceIn:q_,bounceOut:X_,bounceInOut:Y_,smooth:K_,fade:Q_,quadOutIn:Z_,cubicOutIn:J_,quartOutIn:$_,quintOutIn:ef,sineOutIn:tf,expoOutIn:nf,circOutIn:rf,elasticOutIn:af,backOutIn:of,bounceOutIn:sf});e("easing",hf),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(uf||(uf={}));var _f,ff,df,pf,mf,vf=(J(lf={},uf.CONSTANT,v_),J(lf,uf.LINEAR,g_),J(lf,uf.QUAD_IN,y_),J(lf,uf.QUAD_OUT,x_),J(lf,uf.QUAD_IN_OUT,S_),J(lf,uf.QUAD_OUT_IN,Z_),J(lf,uf.CUBIC_IN,T_),J(lf,uf.CUBIC_OUT,E_),J(lf,uf.CUBIC_IN_OUT,C_),J(lf,uf.CUBIC_OUT_IN,J_),J(lf,uf.QUART_IN,A_),J(lf,uf.QUART_OUT,b_),J(lf,uf.QUART_IN_OUT,w_),J(lf,uf.QUART_OUT_IN,$_),J(lf,uf.QUINT_IN,R_),J(lf,uf.QUINT_OUT,P_),J(lf,uf.QUINT_IN_OUT,I_),J(lf,uf.QUINT_OUT_IN,ef),J(lf,uf.SINE_IN,D_),J(lf,uf.SINE_OUT,O_),J(lf,uf.SINE_IN_OUT,N_),J(lf,uf.SINE_OUT_IN,tf),J(lf,uf.EXPO_IN,M_),J(lf,uf.EXPO_OUT,k_),J(lf,uf.EXPO_IN_OUT,L_),J(lf,uf.EXPO_OUT_IN,nf),J(lf,uf.CIRC_IN,B_),J(lf,uf.CIRC_OUT,F_),J(lf,uf.CIRC_IN_OUT,z_),J(lf,uf.CIRC_OUT_IN,rf),J(lf,uf.ELASTIC_IN,U_),J(lf,uf.ELASTIC_OUT,G_),J(lf,uf.ELASTIC_IN_OUT,H_),J(lf,uf.ELASTIC_OUT_IN,af),J(lf,uf.BACK_IN,V_),J(lf,uf.BACK_OUT,j_),J(lf,uf.BACK_IN_OUT,W_),J(lf,uf.BACK_OUT_IN,of),J(lf,uf.BOUNCE_IN,q_),J(lf,uf.BOUNCE_OUT,X_),J(lf,uf.BOUNCE_IN_OUT,Y_),J(lf,uf.BOUNCE_OUT_IN,sf),J(lf,uf.SMOOTH,K_),J(lf,uf.FADE,Q_),lf);function gf(e){return vf[e]}var yf,xf,Sf,Tf=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).interpolationMode=hl.LINEAR,e.tangentWeightMode=fl.NONE,e.value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e.easingMethod=uf.LINEAR,e}return n}(gl);function Ef(e){var t=new Tf;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,a=e.rightTangent,o=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[vl];t.value=null!=r?r:t.value,t.rightTangent=null!=a?a:t.rightTangent,t.rightTangentWeight=null!=o?o:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[vl]=u)}return t}un.fastDefine("cc.RealKeyframeValue",Tf,{interpolationMode:hl.LINEAR,tangentWeightMode:fl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:uf.LINEAR}),un.Attr.setClassAttr(Tf,vl,"editorOnly",!0),(yf=Tf,null!==(Sf=(xf=yf)[Pc])&&void 0!==Sf?Sf:xf[Pc]={}).uniquelyReferenced=!0;var Cf,Af=e("RealCurve",Cc("cc.RealCurve")((mf=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"preExtrapolation",df,se(e)),ye(e,"postExtrapolation",pf,se(e)),e}return Z(n,[{key:"evaluate",value:function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],a=t[i-1];if(e<r){var o=this.preExtrapolation,s=n[0];if(o===_l.CLAMP||i<2)return s.value;switch(o){case _l.LINEAR:return Gf(r,n[0].value,t[1],n[1].value,e);case _l.LOOP:e=zf(e,r,a);break;case _l.PING_PONG:e=Uf(e,r,a);break;default:return s.value}}else if(e>a){var c=this.postExtrapolation,l=n[i-1];if(c===_l.CLAMP||i<2)return l.value;switch(c){case _l.LINEAR:return Gf(a,l.value,t[i-2],n[i-2].value,e);case _l.LOOP:e=zf(e,r,a);break;case _l.PING_PONG:e=Uf(e,r,a);break;default:return l.value}}var u=pc(t,e);if(u>=0)return n[u].value;var h=~u,_=h-1,f=t[_],d=n[_],p=t[h];return function(e,t,n,i,r){var a=n-e;switch(t.interpolationMode){default:case hl.CONSTANT:return t.value;case hl.LINEAR:var o=t.easingMethod===uf.LINEAR?r:gf(t.easingMethod)(r);return xn(t.value,i.value,o);case hl.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&fl.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&fl.LEFT);if(u||f){var d=0;if(u)d=l;else{var p=a,m=a*c;d=Math.sqrt(p*p+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*d+e,y=Math.sin(v)*d+t.value,x=0;if(f)x=_;else{var S=a,T=a*h;x=Math.sqrt(S*S+T*T)*s}var E=Math.atan(h),C=(g-e)/a,A=(-Math.cos(E)*x+n-e)/a,b=y,w=-Math.sin(E)*x+i.value,R=[0,0,0],P=function(e,t,n,i,r){var a=n/i,o=t/i,s=a*a,c=1/3*(-1/3*s+o),l=.5*(2/27*a*s-1/3*a*o+e/i),u=c*c*c,h=l*l+u,_=0;if(ml(h)){if(ml(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var d=1/3*Math.acos(-l/Math.sqrt(-u)),p=2*Math.sqrt(-c);r[0]=p*Math.cos(d),r[1]=-p*Math.cos(d+Math.PI/3),r[2]=-p*Math.cos(d-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*a,x=0;x<_;++x)r[x]-=y;return _}(0-r,3*C,3*A-6*C,3*(C-A)+1,R),I=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var a=e[r];a>=0&&a<=1&&a>i&&(i=a)}i===-1/0&&(i=0)}return i}(R,P,r);return Hf(t.value,b,w,i.value,I)}var D=t.value+s*c*a,O=i.value-s*h*a;return Hf(t.value,D,O,i.value,r)}}(f,d,p,n[h],(e-f)/(p-f))}},{key:"addKeyFrame",value:function(e,t){return he(ne(n.prototype),"addKeyFrame",this).call(this,e,Ef(t))}},{key:"assignSorted",value:function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return Ef(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return de(e,1)[0]})),n.map((function(e){return Ef(de(e,2)[1])})))}}},{key:"isConstant",value:function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return vn(n.value,t,e)}))}},{key:gh,value:function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,a=new DataView(new ArrayBuffer(0+bf+bf+wf+Rf*r+Lf*r)),o=0;a.setUint8(o,this.preExtrapolation),o+=bf,a.setUint8(o,this.postExtrapolation),o+=bf,a.setUint32(o,r,!0),o+=wf,n.forEach((function(e,t){return a.setFloat32(o+Rf*t,e,!0)})),o+=Rf*r;for(var s,c=ge(i);!(s=c()).done;){var l=s.value;o=Bf(a,l,o)}var u=new Uint8Array(a.buffer,0,o);e.writeProperty("bytes",u);var h=i.map((function(e){return e[vl]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()}},{key:yh,value:function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=bf,this.postExtrapolation=i.getUint8(r),r+=bf;var a=i.getUint32(r,!0);r+=wf;var o=Array.from({length:a},(function(e,t){return i.getFloat32(r+Rf*t,!0)}));r+=Rf*a;for(var s=new Array(a),c=0;c<a;++c){var l=Ef({});r=Ff(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][vl]=e}))),this._times=o,this._values=s}else e.readThis()}}]),n}(pl),df=xe((ff=mf).prototype,"preExtrapolation",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _l.CLAMP}}),pf=xe(ff.prototype,"postExtrapolation",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _l.CLAMP}}),_f=ff))||_f);!function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(Cf||(Cf={}));var bf=1,wf=4,Rf=4,Pf=Ef({}),If=Pf.interpolationMode,Df=Pf.tangentWeightMode,Of=Pf.leftTangent,Nf=Pf.leftTangentWeight,Mf=Pf.rightTangent,kf=Pf.rightTangentWeight,Lf=26;function Bf(e,t,n){var i=0,r=n,a=r;r+=4;var o=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,_=t.leftTangentWeight,f=t.easingMethod;return e.setFloat32(r,o,!0),r+=4,s!==If&&(i|=Cf.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==Df&&(i|=Cf.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==Of&&(i|=Cf.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),_!==Nf&&(i|=Cf.LEFT_TANGENT_WEIGHT,e.setFloat32(r,_,!0),r+=4),l!==Mf&&(i|=Cf.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==kf&&(i|=Cf.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=f<<8,e.setUint32(a,i,!0),r}function Ff(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&Cf.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&Cf.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&Cf.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&Cf.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&Cf.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&Cf.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var a=(65280&r)>>8;return t.easingMethod=a,i}function zf(e,t,n){return t+In(e-t,n-t)}function Uf(e,t,n){return t+Dn(e-t,n-t)}function Gf(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function Hf(e,t,n,i,r){var a=1-r;return a*a*a*e+3*a*a*r*t+3*a*r*r*n+r*r*r*i}function Vf(e,t,n,i,r){var a=1-r;return a*(a*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}c.bezier=Vf;var jf,Wf,qf,Xf,Yf,Kf,Qf,Zf,Jf,$f,ed,td=Math.cos,nd=Math.acos,id=Math.max,rd=2*Math.PI,ad=Math.sqrt;function od(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function sd(e,t){var n=function(e,t){var n,i,r,a,o=t-0,s=t-e[0],c=3*o,l=3*s,u=3*(t-e[2]),h=1/(-o+l-u+(t-1)),_=1/3,f=(c-6*s+u)*h,d=f*_,p=(-c+l)*h,m=(3*p-f*f)*_,v=m*_,g=(2*f*f*f-9*f*p+o*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*_,T=ad(S*S*S),E=-g/(2*T),C=nd(E<-1?-1:E>1?1:E),A=2*od(T);return i=A*td(C*_)-d,r=A*td((C+rd)*_)-d,a=A*td((C+2*rd)*_)-d,i>=0&&i<=1?r>=0&&r<=1?a>=0&&a<=1?id(i,r,a):id(i,r):a>=0&&a<=1?id(i,a):i:r>=0&&r<=1?a>=0&&a<=1?id(r,a):r:a}if(0===x)return r=-(n=y<0?od(-y):-od(y))-d,(i=2*n-d)>=0&&i<=1?r>=0&&r<=1?id(i,r):i:r;var b=ad(x);return(n=od(-y+b))-od(y+b)-d}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}c.bezierByTime=sd,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(ed||(ed=e("QuatInterpolationMode",{})));var cd=Cc("cc.QuatKeyframeValue")(jf=Mc((qf=xe((Wf=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.value,i=t.interpolationMode,r=t.easingMethod;K(this,e),ye(this,"interpolationMode",qf,this),ye(this,"value",Xf,this),ye(this,"easingMethod",Yf,this),this.value=n?qn.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ed.SLERP}}),Xf=xe(Wf.prototype,"value",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qn.clone(qn.IDENTITY)}}),Yf=xe(Wf.prototype,"easingMethod",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uf.LINEAR}}),jf=Wf))||jf)||jf;function ld(e){return new cd(e)}var ud,hd=e("QuatCurve",Cc("cc.QuatCurve")(($f=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"preExtrapolation",Zf,se(e)),ye(e,"postExtrapolation",Jf,se(e)),e}return Z(n,[{key:"evaluate",value:function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new qn);var i=this._times,r=this._values,a=this.postExtrapolation,o=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(o){case _l.LOOP:e=c+In(e-c,l-c);break;case _l.PING_PONG:e=c+Dn(e-c,l-c);break;case _l.CLAMP:default:return qn.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(a){case _l.LOOP:e=c+In(e-c,l-c);break;case _l.PING_PONG:e=c+Dn(e-c,l-c);break;case _l.CLAMP:default:return qn.copy(t,h.value)}}var _=pc(i,e);if(_>=0)return qn.copy(t,r[_].value);var f=~_,d=f-1,p=i[d],m=r[d],v=i[f],g=r[f],y=(e-p)/(v-p);switch(m.interpolationMode){default:case ed.CONSTANT:return qn.copy(t,m.value);case ed.SLERP:var x=m.easingMethod,S=x===uf.LINEAR?y:Array.isArray(x)?sd(x,y):gf(x)(y);return qn.slerp(t,m.value,g.value,S)}}},{key:"addKeyFrame",value:function(e,t){var i=new cd(t);return he(ne(n.prototype),"addKeyFrame",this).call(this,e,i)}},{key:"assignSorted",value:function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return ld(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return de(e,1)[0]})),n.map((function(e){return ld(de(e,2)[1])})))}}},{key:gh,value:function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=de(n,1)[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var a=n.length,o=Td*(r?1:a),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?Ed+4*Ad:Ed)}),0),c=0,l=new DataView(new ArrayBuffer(c+=gd+yd+xd*a+4*Sd*a+s+o+0)),u=0,h=0;r&&(h|=ud.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=gd,l.setUint32(u,a,!0),u+=yd,n.forEach((function(e,t){return l.setFloat32(u+xd*t,e,!0)})),u+=xd*a,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,a=n.z,o=n.w,s=u+4*Sd*t;l.setFloat32(s+0*Sd,i,!0),l.setFloat32(s+1*Sd,r,!0),l.setFloat32(s+2*Sd,a,!0),l.setFloat32(s+3*Sd,o,!0)})),u+=4*Sd*a,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,Cd),++u,l.setFloat32(u+0*Ad,t[0],!0),l.setFloat32(u+1*Ad,t[1],!0),l.setFloat32(u+2*Ad,t[2],!0),l.setFloat32(u+3*Ad,t[3],!0),u+=4*Ad):(l.setUint8(u,t),++u)}));var _=u;u+=o;var f=_;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(f,t),r||(f+=Td)}));var d=new Uint8Array(l.buffer);e.writeProperty("bytes",d)}else e.writeThis()}},{key:yh,value:function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,a=i.getUint32(r,!0);r+=gd;var o=a&ud.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=yd;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+xd*t,!0)})),l=r+=xd*s;r+=4*Sd*s;var u=Array.from({length:s},(function(e,t){var n=l+4*Sd*t,a=i.getFloat32(n+0*Sd,!0),o=i.getFloat32(n+1*Sd,!0),s=i.getFloat32(n+2*Sd,!0),c=i.getFloat32(n+3*Sd,!0),u=i.getUint8(r);++r;var h=ld({value:{x:a,y:o,z:s,w:c}});return u!==Cd?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*Ad,!0),i.getFloat32(r+1*Ad,!0),i.getFloat32(r+2*Ad,!0),i.getFloat32(r+3*Ad,!0)],r+=4*Ad),h}));if(o){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var d=i.getUint8(r+f);u[f].interpolationMode=d}r+=s}this._times=c,this._values=u}else e.readThis()}}]),n}(pl),Zf=xe((Qf=$f).prototype,"preExtrapolation",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _l.CLAMP}}),Jf=xe(Qf.prototype,"postExtrapolation",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _l.CLAMP}}),Kf=Qf))||Kf);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(ud||(ud={}));var _d,fd,dd,pd,md,vd,gd=1,yd=4,xd=4,Sd=4,Td=1,Ed=1,Cd=255,Ad=4,bd=e("ObjectCurve",Cc("cc.ObjectCurve")(_d=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"evaluate",value:function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=gn(~t-1,0,this._values.length-1);return this._values[n]}}]),n}(pl))||_d),wd=function e(){K(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};un.fastDefine("cc.Keyframe",wd,{time:0,value:0,inTangent:0,outTangent:0});var Rd=function(){function e(){K(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return Z(e,[{key:"evaluate",value:function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n}}]),e}(),Pd=Cc("cc.AnimationCurve")((vd=md=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(K(this,e),ye(this,"_curve",pd,this),this.cachedKey=void 0,t instanceof Af)this._curve=t;else{var n=new Af;this._curve=n,n.preExtrapolation=_l.LOOP,n.postExtrapolation=_l.CLAMP,t?n.assignSorted(t.map((function(e){return[e.time,{interpolationMode:hl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):n.assignSorted([[0,{interpolationMode:hl.CUBIC,value:1}],[1,{interpolationMode:hl.CUBIC,value:1}]])}this.cachedKey=new Rd}return Z(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=de(e,2),n=t[0],i=t[1],r=new wd;return r.time=n,r.value=i.value,r.inTangent=i.leftTangent,r.outTangent=i.rightTangent,r}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:hl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return Dd(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=Id(e)}},{key:"postWrapMode",get:function(){return Dd(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=Id(e)}},{key:"addKey",value:function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:hl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()}},{key:"evaluate_slow",value:function(e){return this._curve.evaluate(e)}},{key:"evaluate",value:function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,a=e<0?n.preExtrapolation:n.postExtrapolation,o=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(a){case _l.LOOP:r=In(e-o,s-o)+o;break;case _l.PING_PONG:r=Dn(e-o,s-o)+o;break;case _l.CLAMP:default:r=gn(e,o,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)}},{key:"calcOptimizedKey",value:function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),a=this._curve.getKeyframeValue(t),o=a.value,s=a.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,_=l-o,f=1/(h*h),d=s*h,p=u*h;e.coefficient[0]=(d+p-_-_)*f/h,e.coefficient[1]=(_+_+_-d-d-p)*f,e.coefficient[2]=s,e.coefficient[3]=o}},{key:"findIndex",value:function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var a=0;a<3;a++){var o=r+a;if(o+1<i&&n.getKeyframeTime(o+1)>t)return o}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u}}]),e}(),md.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],pd=xe((dd=vd).prototype,"_curve",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fd=dd))||fd;function Id(e){switch(e){default:case cc.Default:case cc.Normal:case cc.Clamp:return _l.CLAMP;case cc.PingPong:return _l.PING_PONG;case cc.Loop:return _l.LOOP}}function Dd(e){switch(e){default:case _l.LINEAR:case _l.CLAMP:return cc.Clamp;case _l.PING_PONG:return cc.PingPong;case _l.LOOP:return cc.Loop}}function Od(e,t){console.warn("".concat(e," is deprecated, please use ").concat(t," instead."))}F(Ss,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var Nd=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),Od("line","Line"),e}return n}(co),Md=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),Od("plane","Plane"),e}return n}(Ns),kd=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),Od("ray","Ray"),e}return n}(lo),Ld=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),Od("triangle","Triangle"),e}return n}(go),Bd=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),Od("sphere","Sphere"),e}return n}(vo),Fd=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),Od("aabb","AABB"),e}return n}(tc),zd=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),Od("obb","OBB"),e}return n}(ac),Ud=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),Od("capsule","Capsule"),e}return n}(oc),Gd=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),Od("frustum","Frustum"),e}return n}(fc),Hd=Object.freeze({__proto__:null,distance:oo,enums:so,intersect:Ss,Line:co,Plane:Ns,Ray:lo,Triangle:go,Sphere:vo,AABB:tc,OBB:ac,Capsule:oc,Frustum:fc,Keyframe:wd,AnimationCurve:Pd,get ERaycastMode(){return mo},line:Nd,plane:Md,ray:kd,triangle:Ld,sphere:Bd,aabb:Fd,obb:zd,capsule:Ud,frustum:Gd});e("geometry",Hd);var Vd={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},jd=e("Layers",function(){function e(){K(this,e)}return Z(e,null,[{key:"makeMaskInclude",value:function(e){for(var t,n=0,i=ge(e);!(t=i()).done;)n|=t.value;return n}},{key:"makeMaskExclude",value:function(t){return~e.makeMaskInclude(t)}},{key:"addLayer",value:function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],k(2104,t),e.Enum[t]=i,dt.value(e.Enum,String(i),t),e.BitMask[t]=i,dt.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}}},{key:"nameToLayer",value:function(t){return void 0===t?(console.warn("name can't be undefined"),-1):n(e.Enum[t])}},{key:"layerToName",value:function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]}}]),e}());jd.Enum=mt(Vd),jd.BitMask=pt(ee({},Vd)),c.Layers=jd;var Wd,qd,Xd="MainFlow",Yd="ForwardFlow",Kd="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(Wd||(Wd={})),c.RenderPassStage=Wd,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(qd||(qd={}));var Qd,Zd={bindings:[],layouts:{}},Jd={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(Qd||(Qd={}));var $d,ep=Qd.SAMPLER_SHADOWMAP,tp=Qd.COUNT-ep;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}($d||($d={}));var np,ip=$d.SAMPLER_JOINTS,rp=$d.COUNT-ip;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(np||(np={}));var ap=new yr;ap.bufferOffsets=[0,ep+ip,ep],ap.samplerOffsets=[-ep,tp+rp,tp-ip],ap.flexibleSet=1;var op=function e(){K(this,e)};op.SIZE=4*(op.COUNT=4+(op.SCREEN_SIZE_OFFSET=4+(op.NATIVE_SIZE_OFFSET=4+(op.TIME_OFFSET=0)))),op.NAME="CCGlobal",op.BINDING=Qd.UBO_GLOBAL,op.DESCRIPTOR=new Qr(op.BINDING,er.UNIFORM_BUFFER,1,Hi.ALL),op.LAYOUT=new Dr(np.GLOBAL,op.BINDING,op.NAME,[new Ir("cc_time",Ai.FLOAT4,1),new Ir("cc_screenSize",Ai.FLOAT4,1),new Ir("cc_nativeSize",Ai.FLOAT4,1)],1),Zd.layouts[op.NAME]=op.LAYOUT,Zd.bindings[op.BINDING]=op.DESCRIPTOR;var sp=function e(){K(this,e)};sp.SIZE=4*(sp.COUNT=4+(sp.VIEW_PORT_OFFSET=4+(sp.NEAR_FAR_OFFSET=4+(sp.GLOBAL_FOG_ADD_OFFSET=4+(sp.GLOBAL_FOG_BASE_OFFSET=4+(sp.GLOBAL_FOG_COLOR_OFFSET=4+(sp.AMBIENT_GROUND_OFFSET=4+(sp.AMBIENT_SKY_OFFSET=4+(sp.MAIN_LIT_COLOR_OFFSET=4+(sp.MAIN_LIT_DIR_OFFSET=4+(sp.EXPOSURE_OFFSET=4+(sp.SCREEN_SCALE_OFFSET=4+(sp.CAMERA_POS_OFFSET=16+(sp.MAT_VIEW_PROJ_INV_OFFSET=16+(sp.MAT_VIEW_PROJ_OFFSET=16+(sp.MAT_PROJ_INV_OFFSET=16+(sp.MAT_PROJ_OFFSET=16+(sp.MAT_VIEW_INV_OFFSET=16+(sp.MAT_VIEW_OFFSET=0))))))))))))))))))),sp.NAME="CCCamera",sp.BINDING=Qd.UBO_CAMERA,sp.DESCRIPTOR=new Qr(sp.BINDING,er.UNIFORM_BUFFER,1,Hi.ALL),sp.LAYOUT=new Dr(np.GLOBAL,sp.BINDING,sp.NAME,[new Ir("cc_matView",Ai.MAT4,1),new Ir("cc_matViewInv",Ai.MAT4,1),new Ir("cc_matProj",Ai.MAT4,1),new Ir("cc_matProjInv",Ai.MAT4,1),new Ir("cc_matViewProj",Ai.MAT4,1),new Ir("cc_matViewProjInv",Ai.MAT4,1),new Ir("cc_cameraPos",Ai.FLOAT4,1),new Ir("cc_screenScale",Ai.FLOAT4,1),new Ir("cc_exposure",Ai.FLOAT4,1),new Ir("cc_mainLitDir",Ai.FLOAT4,1),new Ir("cc_mainLitColor",Ai.FLOAT4,1),new Ir("cc_ambientSky",Ai.FLOAT4,1),new Ir("cc_ambientGround",Ai.FLOAT4,1),new Ir("cc_fogColor",Ai.FLOAT4,1),new Ir("cc_fogBase",Ai.FLOAT4,1),new Ir("cc_fogAdd",Ai.FLOAT4,1),new Ir("cc_nearFar",Ai.FLOAT4,1),new Ir("cc_viewPort",Ai.FLOAT4,1)],1),Zd.layouts[sp.NAME]=sp.LAYOUT,Zd.bindings[sp.BINDING]=sp.DESCRIPTOR;var cp=function e(){K(this,e)};cp.SIZE=4*(cp.COUNT=4+(cp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(cp.SHADOW_COLOR_OFFSET=4+(cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(cp.SHADOW_PROJ_INFO_OFFSET=4+(cp.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(cp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(cp.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(cp.MAT_LIGHT_VIEW_OFFSET=16+(cp.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),cp.NAME="CCShadow",cp.BINDING=Qd.UBO_SHADOW,cp.DESCRIPTOR=new Qr(cp.BINDING,er.UNIFORM_BUFFER,1,Hi.ALL),cp.LAYOUT=new Dr(np.GLOBAL,cp.BINDING,cp.NAME,[new Ir("cc_matLightPlaneProj",Ai.MAT4,1),new Ir("cc_matLightView",Ai.MAT4,1),new Ir("cc_matLightViewProj",Ai.MAT4,1),new Ir("cc_shadowInvProjDepthInfo",Ai.FLOAT4,1),new Ir("cc_shadowProjDepthInfo",Ai.FLOAT4,1),new Ir("cc_shadowProjInfo",Ai.FLOAT4,1),new Ir("cc_shadowNFLSInfo",Ai.FLOAT4,1),new Ir("cc_shadowWHPBInfo",Ai.FLOAT4,1),new Ir("cc_shadowLPNNInfo",Ai.FLOAT4,1),new Ir("cc_shadowColor",Ai.FLOAT4,1),new Ir("cc_planarNDInfo",Ai.FLOAT4,1)],1),Zd.layouts[cp.NAME]=cp.LAYOUT,Zd.bindings[cp.BINDING]=cp.DESCRIPTOR;var lp=Qd.SAMPLER_SHADOWMAP,up=new Qr(lp,er.SAMPLER_TEXTURE,1,Hi.FRAGMENT),hp=new Or(np.GLOBAL,lp,"cc_shadowMap",Ai.SAMPLER2D,1);Zd.layouts.cc_shadowMap=hp,Zd.bindings[lp]=up;var _p=Qd.SAMPLER_ENVIRONMENT,fp=new Qr(_p,er.SAMPLER_TEXTURE,1,Hi.FRAGMENT),dp=new Or(np.GLOBAL,_p,"cc_environment",Ai.SAMPLER_CUBE,1);Zd.layouts.cc_environment=dp,Zd.bindings[_p]=fp;var pp=Qd.SAMPLER_DIFFUSEMAP,mp=new Qr(pp,er.SAMPLER_TEXTURE,1,Hi.FRAGMENT),vp=new Or(np.GLOBAL,pp,"cc_diffuseMap",Ai.SAMPLER_CUBE,1);Zd.layouts.cc_diffuseMap=vp,Zd.bindings[pp]=mp;var gp=Qd.SAMPLER_SPOT_LIGHTING_MAP,yp=new Qr(gp,er.SAMPLER_TEXTURE,1,Hi.FRAGMENT),xp=new Or(np.GLOBAL,gp,"cc_spotLightingMap",Ai.SAMPLER2D,1);Zd.layouts.cc_spotLightingMap=xp,Zd.bindings[gp]=yp;var Sp=function e(){K(this,e)};Sp.SIZE=4*(Sp.COUNT=4+(Sp.LIGHTINGMAP_UVPARAM=16+(Sp.MAT_WORLD_IT_OFFSET=16+(Sp.MAT_WORLD_OFFSET=0)))),Sp.NAME="CCLocal",Sp.BINDING=$d.UBO_LOCAL,Sp.DESCRIPTOR=new Qr(Sp.BINDING,er.UNIFORM_BUFFER,1,Hi.VERTEX|Hi.COMPUTE),Sp.LAYOUT=new Dr(np.LOCAL,Sp.BINDING,Sp.NAME,[new Ir("cc_matWorld",Ai.MAT4,1),new Ir("cc_matWorldIT",Ai.MAT4,1),new Ir("cc_lightingMapUVParam",Ai.FLOAT4,1)],1),Jd.layouts[Sp.NAME]=Sp.LAYOUT,Jd.bindings[Sp.BINDING]=Sp.DESCRIPTOR;var Tp=function e(){K(this,e)};Tp.SIZE=4*(Tp.COUNT=4+(Tp.WORLD_BOUND_HALF_EXTENTS=4+(Tp.WORLD_BOUND_CENTER=0))),Tp.NAME="CCWorldBound",Tp.BINDING=$d.UBO_LOCAL,Tp.DESCRIPTOR=new Qr(Tp.BINDING,er.UNIFORM_BUFFER,1,Hi.VERTEX|Hi.COMPUTE),Tp.LAYOUT=new Dr(np.LOCAL,Tp.BINDING,Tp.NAME,[new Ir("cc_worldBoundCenter",Ai.FLOAT4,1),new Ir("cc_worldBoundHalfExtents",Ai.FLOAT4,1)],1),Jd.layouts[Tp.NAME]=Tp.LAYOUT,Jd.bindings[Tp.BINDING]=Tp.DESCRIPTOR;var Ep="a_matWorld0",Cp=function e(){K(this,e)};Cp.BATCHING_COUNT=10,Cp.MAT_WORLDS_OFFSET=0,Cp.SIZE=4*(Cp.COUNT=16*Cp.BATCHING_COUNT),Cp.NAME="CCLocalBatched",Cp.BINDING=$d.UBO_LOCAL,Cp.DESCRIPTOR=new Qr(Cp.BINDING,er.UNIFORM_BUFFER,1,Hi.VERTEX|Hi.COMPUTE),Cp.LAYOUT=new Dr(np.LOCAL,Cp.BINDING,Cp.NAME,[new Ir("cc_matWorlds",Ai.MAT4,Cp.BATCHING_COUNT)],1),Jd.layouts[Cp.NAME]=Cp.LAYOUT,Jd.bindings[Cp.BINDING]=Cp.DESCRIPTOR;var Ap=function e(){K(this,e)};Ap.LIGHTS_PER_PASS=1,Ap.SIZE=4*(Ap.COUNT=(Ap.LIGHT_DIR_OFFSET=(Ap.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Ap.LIGHT_COLOR_OFFSET=(Ap.LIGHT_POS_OFFSET=0)+4*Ap.LIGHTS_PER_PASS)+4*Ap.LIGHTS_PER_PASS)+4*Ap.LIGHTS_PER_PASS)+4*Ap.LIGHTS_PER_PASS),Ap.NAME="CCForwardLight",Ap.BINDING=$d.UBO_FORWARD_LIGHTS,Ap.DESCRIPTOR=new Qr(Ap.BINDING,er.DYNAMIC_UNIFORM_BUFFER,1,Hi.FRAGMENT),Ap.LAYOUT=new Dr(np.LOCAL,Ap.BINDING,Ap.NAME,[new Ir("cc_lightPos",Ai.FLOAT4,Ap.LIGHTS_PER_PASS),new Ir("cc_lightColor",Ai.FLOAT4,Ap.LIGHTS_PER_PASS),new Ir("cc_lightSizeRangeAngle",Ai.FLOAT4,Ap.LIGHTS_PER_PASS),new Ir("cc_lightDir",Ai.FLOAT4,Ap.LIGHTS_PER_PASS)],1),Jd.layouts[Ap.NAME]=Ap.LAYOUT,Jd.bindings[Ap.BINDING]=Ap.DESCRIPTOR;var bp=function e(){K(this,e)};bp.LIGHTS_PER_PASS=10;var wp=function e(){K(this,e)};wp.SIZE=4*(wp.COUNT=4+(wp.JOINTS_TEXTURE_INFO_OFFSET=0)),wp.NAME="CCSkinningTexture",wp.BINDING=$d.UBO_SKINNING_TEXTURE,wp.DESCRIPTOR=new Qr(wp.BINDING,er.UNIFORM_BUFFER,1,Hi.VERTEX),wp.LAYOUT=new Dr(np.LOCAL,wp.BINDING,wp.NAME,[new Ir("cc_jointTextureInfo",Ai.FLOAT4,1)],1),Jd.layouts[wp.NAME]=wp.LAYOUT,Jd.bindings[wp.BINDING]=wp.DESCRIPTOR;var Rp=function e(){K(this,e)};Rp.SIZE=4*(Rp.COUNT=4+(Rp.JOINTS_ANIM_INFO_OFFSET=0)),Rp.NAME="CCSkinningAnimation",Rp.BINDING=$d.UBO_SKINNING_ANIMATION,Rp.DESCRIPTOR=new Qr(Rp.BINDING,er.UNIFORM_BUFFER,1,Hi.VERTEX),Rp.LAYOUT=new Dr(np.LOCAL,Rp.BINDING,Rp.NAME,[new Ir("cc_jointAnimInfo",Ai.FLOAT4,1)],1),Jd.layouts[Rp.NAME]=Rp.LAYOUT,Jd.bindings[Rp.BINDING]=Rp.DESCRIPTOR;var Pp=function e(){K(this,e)};Pp.SIZE=4*(Pp.COUNT=360+(Pp.JOINTS_OFFSET=0)),Pp.NAME="CCSkinning",Pp.BINDING=$d.UBO_SKINNING_TEXTURE,Pp.DESCRIPTOR=new Qr(Pp.BINDING,er.UNIFORM_BUFFER,1,Hi.VERTEX),Pp.LAYOUT=new Dr(np.LOCAL,Pp.BINDING,Pp.NAME,[new Ir("cc_joints",Ai.FLOAT4,90)],1),Jd.layouts[Pp.NAME]=Pp.LAYOUT,Jd.bindings[Pp.BINDING]=Pp.DESCRIPTOR;var Ip=function e(){K(this,e)};Ip.MAX_MORPH_TARGET_COUNT=60,Ip.OFFSET_OF_WEIGHTS=0,Ip.OFFSET_OF_VERTICES_COUNT=4+(Ip.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(Ip.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Ip.MAX_MORPH_TARGET_COUNT)),Ip.COUNT_BASE_4_BYTES=4*Math.ceil(Ip.MAX_MORPH_TARGET_COUNT/4)+4,Ip.SIZE=4*Ip.COUNT_BASE_4_BYTES,Ip.NAME="CCMorph",Ip.BINDING=$d.UBO_MORPH,Ip.DESCRIPTOR=new Qr(Ip.BINDING,er.UNIFORM_BUFFER,1,Hi.VERTEX),Ip.LAYOUT=new Dr(np.LOCAL,Ip.BINDING,Ip.NAME,[new Ir("cc_displacementWeights",Ai.FLOAT4,Ip.MAX_MORPH_TARGET_COUNT/4),new Ir("cc_displacementTextureInfo",Ai.FLOAT4,1)],1),Jd.layouts[Ip.NAME]=Ip.LAYOUT,Jd.bindings[Ip.BINDING]=Ip.DESCRIPTOR;var Dp=function e(){K(this,e)};Dp.NAME="CCUILocal",Dp.BINDING=$d.UBO_UI_LOCAL,Dp.DESCRIPTOR=new Qr(Dp.BINDING,er.DYNAMIC_UNIFORM_BUFFER,1,Hi.VERTEX),Dp.LAYOUT=new Dr(np.LOCAL,Dp.BINDING,Dp.NAME,[new Ir("cc_local_data",Ai.FLOAT4,1)],1),Jd.layouts[Dp.NAME]=Dp.LAYOUT,Jd.bindings[Dp.BINDING]=Dp.DESCRIPTOR;var Op=$d.SAMPLER_JOINTS,Np=new Qr(Op,er.SAMPLER_TEXTURE,1,Hi.VERTEX),Mp=new Or(np.LOCAL,Op,"cc_jointTexture",Ai.SAMPLER2D,1);Jd.layouts.cc_jointTexture=Mp,Jd.bindings[Op]=Np;var kp=$d.SAMPLER_MORPH_POSITION,Lp=new Qr(kp,er.SAMPLER_TEXTURE,1,Hi.VERTEX),Bp=new Or(np.LOCAL,kp,"cc_PositionDisplacements",Ai.SAMPLER2D,1);Jd.layouts.cc_PositionDisplacements=Bp,Jd.bindings[kp]=Lp;var Fp=$d.SAMPLER_MORPH_NORMAL,zp=new Qr(Fp,er.SAMPLER_TEXTURE,1,Hi.VERTEX),Up=new Or(np.LOCAL,Fp,"cc_NormalDisplacements",Ai.SAMPLER2D,1);Jd.layouts.cc_NormalDisplacements=Up,Jd.bindings[Fp]=zp;var Gp=$d.SAMPLER_MORPH_TANGENT,Hp=new Qr(Gp,er.SAMPLER_TEXTURE,1,Hi.VERTEX),Vp=new Or(np.LOCAL,Gp,"cc_TangentDisplacements",Ai.SAMPLER2D,1);Jd.layouts.cc_TangentDisplacements=Vp,Jd.bindings[Gp]=Hp;var jp=$d.SAMPLER_LIGHTMAP,Wp=new Qr(jp,er.SAMPLER_TEXTURE,1,Hi.FRAGMENT),qp=new Or(np.LOCAL,jp,"cc_lightingMap",Ai.SAMPLER2D,1);Jd.layouts.cc_lightingMap=qp,Jd.bindings[jp]=Wp;var Xp=$d.SAMPLER_SPRITE,Yp=new Qr(Xp,er.SAMPLER_TEXTURE,1,Hi.FRAGMENT),Kp=new Or(np.LOCAL,Xp,"cc_spriteTexture",Ai.SAMPLER2D,1);Jd.layouts.cc_spriteTexture=Kp,Jd.bindings[Xp]=Yp;var Qp=$d.SAMPLER_REFLECTION,Zp=new Qr(Qp,er.SAMPLER_TEXTURE,1,Hi.FRAGMENT),Jp=new Or(np.LOCAL,Qp,"cc_reflectionTexture",Ai.SAMPLER2D,1);Jd.layouts.cc_reflectionTexture=Jp,Jd.bindings[Qp]=Zp;var $p=$d.STORAGE_REFLECTION,em=new Qr($p,er.STORAGE_IMAGE,1,Hi.COMPUTE),tm=new kr(np.LOCAL,$p,"cc_reflectionStorage",Ai.IMAGE2D,1);Jd.layouts.cc_reflectionStorage=tm,Jd.bindings[$p]=em;var nm,im,rm=jd.makeMaskExclude([jd.BitMask.UI_2D,jd.BitMask.GIZMOS,jd.BitMask.EDITOR,jd.BitMask.SCENE_GIZMO,jd.BitMask.PROFILER]),am=jd.makeMaskExclude([jd.BitMask.UI_2D,jd.BitMask.PROFILER]),om=jd.Enum.ALL;function sm(e){return e.hasFeature(Ti.COLOR_FLOAT)&&e.hasFeature(Ti.TEXTURE_FLOAT)&&!(e.gfxAPI===xi.WEBGL)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Xd,PIPELINE_FLOW_FORWARD:Yd,PIPELINE_FLOW_SHADOW:Kd,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Wd},get RenderPriority(){return qd},globalDescriptorSetLayout:Zd,localDescriptorSetLayout:Jd,get PipelineGlobalBindings(){return Qd},get ModelLocalBindings(){return $d},get SetIndex(){return np},bindingMappingInfo:ap,UBOGlobal:op,UBOCamera:sp,UBOShadow:cp,UNIFORM_SHADOWMAP_BINDING:lp,UNIFORM_ENVIRONMENT_BINDING:_p,UNIFORM_DIFFUSEMAP_BINDING:pp,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:gp,UBOLocal:Sp,UBOWorldBound:Tp,INST_MAT_WORLD:Ep,UBOLocalBatched:Cp,UBOForwardLight:Ap,UBODeferredLight:bp,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:wp,UBOSkinningAnimation:Rp,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:Pp,UBOMorph:Ip,UBOUILocal:Dp,UNIFORM_JOINT_TEXTURE_BINDING:Op,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:kp,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Fp,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Gp,UNIFORM_LIGHTMAP_TEXTURE_BINDING:jp,UNIFORM_SPRITE_TEXTURE_BINDING:Xp,UNIFORM_REFLECTION_TEXTURE_BINDING:Qp,UNIFORM_REFLECTION_STORAGE_BINDING:$p,CAMERA_DEFAULT_MASK:rm,CAMERA_EDITOR_MASK:am,MODEL_ALWAYS_MASK:om,supportsHalfFloatTexture:function(e){return e.hasFeature(Ti.COLOR_HALF_FLOAT)&&e.hasFeature(Ti.TEXTURE_HALF_FLOAT)&&!(e.gfxAPI===xi.WEBGL)},supportsFloatTexture:sm}));var cm=4227858432,lm=66060288,um=1044480,hm=4095,_m=function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return t<<26&cm|e<<20&lm|n<<12&um|i&hm},fm=function(e){return(e&cm)>>>26},dm=function(e){return(e&lm)>>>20},pm=function(e){return(e&um)>>>12},mm=function(e){return e&hm},vm=function(e,t){return 67108863&e|t<<26&cm},gm=(J(nm={},Ai.UNKNOWN,(function(){return console.warn("illegal uniform handle")})),J(nm,Ai.INT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]})),J(nm,Ai.INT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ri.fromArray(t,e,n)})),J(nm,Ai.INT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return zn.fromArray(t,e,n)})),J(nm,Ai.INT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ci.fromArray(t,e,n)})),J(nm,Ai.FLOAT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]})),J(nm,Ai.FLOAT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ri.fromArray(t,e,n)})),J(nm,Ai.FLOAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return zn.fromArray(t,e,n)})),J(nm,Ai.FLOAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ci.fromArray(t,e,n)})),J(nm,Ai.MAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Vn.fromArray(t,e,n)})),J(nm,Ai.MAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ei.fromArray(t,e,n)})),nm),ym=(J(im={},Ai.UNKNOWN,(function(){return console.warn("illegal uniform handle")})),J(im,Ai.INT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]=t})),J(im,Ai.INT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ri.toArray(e,t,n)})),J(im,Ai.INT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return zn.toArray(e,t,n)})),J(im,Ai.INT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ci.toArray(e,t,n)})),J(im,Ai.FLOAT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]=t})),J(im,Ai.FLOAT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ri.toArray(e,t,n)})),J(im,Ai.FLOAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return zn.toArray(e,t,n)})),J(im,Ai.FLOAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ci.toArray(e,t,n)})),J(im,Ai.MAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Vn.toArray(e,t,n)})),J(im,Ai.MAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ei.toArray(e,t,n)})),im),xm=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Sm(e){switch(e){case Ai.BOOL:case Ai.INT:case Ai.UINT:case Ai.FLOAT:return xm[0];case Ai.BOOL2:case Ai.INT2:case Ai.UINT2:case Ai.FLOAT2:return xm[1];case Ai.BOOL4:case Ai.INT4:case Ai.UINT4:case Ai.FLOAT4:return xm[2];case Ai.MAT4:return xm[3];case Ai.SAMPLER2D:return"default-texture";case Ai.SAMPLER_CUBE:return"default-cube-texture"}return xm[0]}function Tm(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var Em=new Zr;function Cm(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Am(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '".concat(e.type,"'")),"-1"}}function bm(e,t,n,i,r){for(var a=e.builtins[i],o=[],s=function(e){var t=a.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&ua))return console.warn("builtin UBO '".concat(t.name,"' not available!")),"continue";o.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<a.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,o);for(var l=[],u=function(e){var t=a.samplerTextures[e],i=n.layouts[t.name],o=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&o&&o.descriptorType&ha))return console.warn("builtin samplerTexture '".concat(t.name,"' not available!")),"continue";l.push(i),r&&!r.includes(o)&&r.push(o)},h=0;h<a.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function wm(e){return e.members.reduce((function(e,t){return e+va(t.type)*t.count}),0)}function Rm(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function Pm(e){switch(e.gfxAPI){case xi.GLES2:case xi.WEBGL:return"glsl1";case xi.GLES3:case xi.WEBGL2:return"glsl3";default:return"glsl4"}}var Im,Dm,Om,Nm,Mm,km,Lm,Bm,Fm=new(function(){function e(){K(this,e),this._templates={},this._cache={},this._templateInfos={}}return Z(e,[{key:"register",value:function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var a=i.passes[r];void 0!==a.propertyIndex&&void 0===a.properties&&(a.properties=i.passes[a.propertyIndex].properties)}}},{key:"define",value:function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=ee({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var a=t.range;r=Cm(a[1]-a[0]+1),t._map=function(e){return e-a[0]}}else"string"===t.type?(r=Cm(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},a=0;a<n.defines.length;a++)r(a);for(var o in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define ".concat(o," ").concat(n.builtins.statistics[o],"\n");if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Ur,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(wm(l)),s.bindings.push(new Qr(l.binding,er.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new Dr(np.MATERIAL,l.binding,l.name,l.members.map((function(e){return new Ir(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Qr(h.binding,er.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Or(np.MATERIAL,h.binding,h.name,h.type,h.count))}for(var _=0;_<n.samplers.length;_++){var f=n.samplers[_];s.bindings.push(new Qr(f.binding,er.SAMPLER,f.count,f.stageFlags)),s.shaderInfo.samplers.push(new Nr(np.MATERIAL,f.binding,f.name,f.count))}for(var d=0;d<n.textures.length;d++){var p=n.textures[d];s.bindings.push(new Qr(p.binding,er.TEXTURE,p.count,p.stageFlags)),s.shaderInfo.textures.push(new Mr(np.MATERIAL,p.binding,p.name,p.type,p.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new Qr(v.binding,er.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Lr(np.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new Qr(y.binding,er.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new kr(np.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<n.subpassInputs.length;x++){var S=n.subpassInputs[x];s.bindings.push(new Qr(S.binding,er.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new Br(np.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var T=0;T<n.attributes.length;T++){var E=n.attributes[T];s.gfxAttributes.push(new zr(E.name,E.format,E.isNormalized,0,E.isInstanced,E.location))}bm(n,s,Jd,"locals"),s.shaderInfo.stages.push(new Fr(Hi.VERTEX,"")),s.shaderInfo.stages.push(new Fr(Hi.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,a=0,o=0;o<r.length;o++){var s=r[o];t[s.name]=_m(i.binding,s.type,s.count,a),a+=(va(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=_m(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"getTemplateInfo",value:function(e){var t=this._templates[e].hash;return this._templateInfos[t]}},{key:"getDescriptorSetLayout",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(Em.bindings=r.bindings,r.setLayouts[np.MATERIAL]=e.createDescriptorSetLayout(Em),Em.bindings=Jd.bindings,r.setLayouts[np.LOCAL]=e.createDescriptorSetLayout(Em)),r.setLayouts[n?np.LOCAL:np.MATERIAL]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",a=0;a<i.length;a++){var o=i[a],s=t[o.name];if(s&&o._map){var c=o._map(s),l=o._offset;r+="".concat(l).concat(c,"|")}}return"".concat(r).concat(n.hash)}for(var u=0,h=0;h<i.length;h++){var _=i[h],f=t[_.name];f&&_._map&&(u|=_._map(f)<<_._offset)}return"".concat(u.toString(16),"|").concat(n.hash)}},{key:"destroyShaderByDefines",value:function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp("".concat(t).concat(n))})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),a=0;a<r.length;a++){var o=r[a],s=this._cache[o];T("destroyed shader ".concat(s.name)),s.destroy(),delete this._cache[o]}}},{key:"getGFXShader",value:function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var a=this._cache[r];if(a)return a;var o=this._templates[t],s=this._templateInfos[o.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),bm(o,s,Zd,"globals"),s.setLayouts[np.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new $r(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],a=r.name,o=e[a],s=Am(r,o),c=!o||"0"===o;n.push({name:a,value:s,isDefault:c})}return n}(n,o.defines),l=i.constantMacros+o.constantMacros+c.reduce((function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.value,"\n")}),""),u=o.glsl3,h=Pm(e);return h?u=o[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,a=t.gfxAttributes,o=0;o<r.length;o++)Rm(r[o].defines,n)&&i.push(a[o]);return i}(o,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:"".concat(e,"|").concat(t.name).concat(t.value)}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)}}]),e}());c.programLib=Fm;var zm=e("EffectAsset",Cc("cc.EffectAsset")((Bm=Lm=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"techniques",Om,se(e)),ye(e,"shaders",Nm,se(e)),ye(e,"combinations",Mm,se(e)),ye(e,"hideInEditor",km,se(e)),e}return Z(n,[{key:"onLoaded",value:function(){Fm.register(this),n.register(this),c.game.once(c.Game.EVENT_ENGINE_INITED,this._precompile,this)}},{key:"_precompile",value:function(){for(var e=this,t=c.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],a=0;a<i.length;++a){var o=ee({},n);o[t]=i[a],e.push(o)}return e}),[])}),[{}]).forEach((function(e){return Fm.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)}},{key:"destroy",value:function(){return n.remove(this),he(ne(n.prototype),"destroy",this).call(this)}},{key:"initDefault",value:function(e){he(ne(n.prototype),"initDefault",this).call(this,e);var t=n.get("unlit");this.name="unlit",this.shaders=t.shaders,this.combinations=t.combinations,this.techniques=t.techniques}},{key:"validate",value:function(){return this.techniques.length>0&&this.shaders.length>0}}],[{key:"register",value:function(e){n._effects[e.name]=e}},{key:"remove",value:function(e){if("string"!=typeof e)n._effects[e.name]&&n._effects[e.name].equals(e)&&delete n._effects[e.name];else{if(n._effects[e])return void delete n._effects[e];for(var t in n._effects)if(n._effects[t]._uuid===e)return void delete n._effects[t]}}},{key:"get",value:function(e){if(n._effects[e])return n._effects[e];for(var t in n._effects)if(n._effects[t]._uuid===e)return n._effects[t];return null}},{key:"getAll",value:function(){return n._effects}}]),n}(Uu),Lm._effects={},Om=xe((Dm=Bm).prototype,"techniques",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nm=xe(Dm.prototype,"shaders",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mm=xe(Dm.prototype,"combinations",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),km=xe(Dm.prototype,"hideInEditor",[Ic,Oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Im=Dm))||Im);c.EffectAsset=zm;var Um,Gm,Hm,Vm,jm,Wm,qm,Xm,Ym,Km,Qm,Zm,Jm,$m,ev,tv=1024;!function(e){e[e.RGB565=Ei.R5G6B5]="RGB565",e[e.RGB5A1=Ei.RGB5A1]="RGB5A1",e[e.RGBA4444=Ei.RGBA4]="RGBA4444",e[e.RGB888=Ei.RGB8]="RGB888",e[e.RGB32F=Ei.RGB32F]="RGB32F",e[e.RGBA8888=Ei.RGBA8]="RGBA8888",e[e.RGBA32F=Ei.RGBA32F]="RGBA32F",e[e.A8=Ei.A8]="A8",e[e.I8=Ei.L8]="I8",e[e.AI8=Ei.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=Ei.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=Ei.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=tv++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=Ei.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=Ei.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=tv++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=Ei.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=tv++]="RGBA_ETC1",e[e.RGB_ETC2=Ei.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=Ei.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=Ei.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=Ei.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=Ei.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=Ei.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=Ei.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=Ei.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=Ei.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=Ei.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=Ei.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=Ei.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=Ei.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=Ei.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=Ei.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=Ei.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Um||(Um={})),function(e){e[e.REPEAT=Li.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Li.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Li.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Li.BORDER]="CLAMP_TO_BORDER"}(Gm||(Gm={})),function(e){e[e.NONE=ki.NONE]="NONE",e[e.LINEAR=ki.LINEAR]="LINEAR",e[e.NEAREST=ki.POINT]="NEAREST"}(Hm||(Hm={})),yt(Ei);var nv,iv,rv,av,ov=new we("Tex"),sv=Cc("cc.TextureBase")((ev=$m=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"_format",Wm,se(e)),ye(e,"_minFilter",qm,se(e)),ye(e,"_magFilter",Xm,se(e)),ye(e,"_mipFilter",Ym,se(e)),ye(e,"_wrapS",Km,se(e)),ye(e,"_wrapT",Qm,se(e)),ye(e,"_wrapR",Zm,se(e)),ye(e,"_anisotropy",Jm,se(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new Pr,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=ov.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=wa(e._id,666),e}return Z(n,[{key:"isCompressed",get:function(){return this._format>=Um.RGB_ETC1&&this._format<=Um.RGBA_ASTC_12x12||this._format>=Um.RGB_A_PVRTC_2BPPV1&&this._format<=Um.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}},{key:"destroy",value:function(){var e,t=he(ne(n.prototype),"destroy",this).call(this);return t&&(null===(e=c.director.root)||void 0===e?void 0:e.batcher2D)&&c.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),t}},{key:"getHash",value:function(){return this._textureHash}},{key:"getGFXTexture",value:function(){return null}},{key:"getSamplerInfo",value:function(){return this._samplerInfo}},{key:"getGFXSampler",value:function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):D(9302)),this._gfxSampler}},{key:"_serialize",value:function(){return""}},{key:"_deserialize",value:function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))}},{key:"_getGFXDevice",value:function(){return c.director.root?c.director.root.device:null}},{key:"_getGFXFormat",value:function(){return this._getGFXPixelFormat(this._format)}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?Um.RGBA8888:e}},{key:"_getGFXPixelFormat",value:function(e){return e===Um.RGBA_ETC1?e=Um.RGB_ETC1:e===Um.RGB_A_PVRTC_4BPPV1?e=Um.RGB_PVRTC_4BPPV1:e===Um.RGB_A_PVRTC_2BPPV1&&(e=Um.RGB_PVRTC_2BPPV1),e}}]),n}(Uu),$m.PixelFormat=Um,$m.WrapMode=Gm,$m.Filter=Hm,Wm=xe((jm=ev).prototype,"_format",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Um.RGBA8888}}),qm=xe(jm.prototype,"_minFilter",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hm.LINEAR}}),Xm=xe(jm.prototype,"_magFilter",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hm.LINEAR}}),Ym=xe(jm.prototype,"_mipFilter",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hm.NONE}}),Km=xe(jm.prototype,"_wrapS",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gm.REPEAT}}),Qm=xe(jm.prototype,"_wrapT",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gm.REPEAT}}),Zm=xe(jm.prototype,"_wrapR",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gm.REPEAT}}),Jm=xe(jm.prototype,"_anisotropy",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vm=jm))||Vm;function cv(e){return!!(c.sys.hasFeature(c.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}c.TextureBase=sv;var lv=e("ImageAsset",Cc("cc.ImageAsset")((av=rv=function(e){te(n,e);var t=le(n);function n(e){var i;return K(this,n),(i=t.call(this))._nativeData=void 0,i._exportedExts=void 0,i._format=Um.RGBA8888,i._width=0,i._height=0,i._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&i.reset(e),i}return Z(n,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||cv(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||cv(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Um.RGB_ETC1&&this._format<=Um.RGBA_ASTC_12x12||this._format>=Um.RGB_A_PVRTC_2BPPV1&&this._format<=Um.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}},{key:"reset",value:function(e){cv(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)}},{key:"destroy",value:function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):cv(this.data)&&this.data.close&&this.data.close(),he(ne(n.prototype),"destroy",this).call(this)}},{key:"_serialize",value:function(){}},{key:"_deserialize",value:function(e){var t="";"string"==typeof e?t=e:(this._width=e.w,this._height=e.h,t=e.fmt);for(var i,r=c.director.root?c.director.root.device:null,a=t.split("_"),o=Number.MAX_VALUE,s=this._format,l="",u=c.macro.SUPPORT_TEXTURE_FORMATS,h=ge(a);!(i=h()).done;){var _=i.value.split("@"),f=parseInt(_[0],void 0),d=n.extnames[f]||_[0],p=u.indexOf(d);if(-1!==p&&p<o){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==d||r&&r.hasFeature(Ti.FORMAT_ASTC)))continue;if(!(".pvr"!==d||r&&r.hasFeature(Ti.FORMAT_PVRTC)))continue;if(!(m!==Um.RGB_ETC1&&m!==Um.RGBA_ETC1||r&&r.hasFeature(Ti.FORMAT_ETC1)))continue;if(!(m!==Um.RGB_ETC2&&m!==Um.RGBA_ETC2||r&&r.hasFeature(Ti.FORMAT_ETC2)))continue;if(".webp"===d&&!c.sys.hasFeature(c.sys.Feature.WEBP))continue;o=p,l=d,s=m}}l?(this._setRawAsset(l),this._format=s):P(3121)}},{key:"initDefault",value:function(e){if(he(ne(n.prototype),"initDefault",this).call(this,e),n._sharedPlaceHolderCanvas)this.reset(n._sharedPlaceHolderCanvas);else{var t=document.createElement("canvas"),i=t.getContext("2d"),r=t.width=t.height=2;i.fillStyle="#ff00ff",i.fillRect(0,0,r,r),this.reset(t),n._sharedPlaceHolderCanvas=t}}},{key:"validate",value:function(){return!!this.data}}]),n}(Uu),rv.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],rv._sharedPlaceHolderCanvas=null,xe((iv=av).prototype,"_nativeAsset",[dl],Object.getOwnPropertyDescriptor(iv.prototype,"_nativeAsset"),iv.prototype),nv=iv))||nv);c.ImageAsset=lv;var uv=new WeakMap,hv=new WeakSet,_v=new WeakSet;function fv(e,t){var n;n=uh.safeFindClass;var i,r=Mh.pool.get();try{i=qh(e,r,{classFinder:n,customEnv:t})}catch(e){throw x(e),Mh.pool.put(r),e}i._uuid=t.__uuid__||"";for(var a=r.uuidList,o=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<a.length;u++){var h=a[u];l[u]={uuid:Hl(h),owner:o[u],prop:s[u],type:dt._getClassById(c[u])}}return uv.set(i,l),i._native&&hv.add(i),Mh.pool.put(r),i}var dv,pv=new(function(){function e(){K(this,e),this._depends=new Al}return Z(e,[{key:"init",value:function(){this._depends.clear()}},{key:"getNativeDep",value:function(e){var t=this._depends.get(e);return t&&t.nativeDep?ee({},t.nativeDep):null}},{key:"getDeps",value:function(e){return this._depends.has(e)?this._depends.get(e).deps:[]}},{key:"getDepsRecursively",value:function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n}},{key:"remove",value:function(e){this._depends.remove(e)}},{key:"parse",value:function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof xh){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var a=fv(t,{__uuid__:e});(r=this._parseDepsFromAsset(a)).nativeDep&&(r.nativeDep.uuid=e),Il.add("".concat(e,"@import"),a)}catch(t){Pl.remove("".concat(e,"@import")),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r}},{key:"_parseDepsFromAsset",value:function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=uv.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return hv.has(e)&&(t.nativeDep=e._nativeDep),t}},{key:"_parseDepsFromJson",value:function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=Hl(e)})),t}},{key:"_descend",value:function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var a=i[r];t[a]||(t[a]=!0,n.push(a),this._descend(a,t,n))}}}]),e}()),mv=[new mr];function vv(e){return e&&0==(e&e-1)}var gv,yv,xv,Sv,Tv,Ev,Cv=Cc("cc.SimpleTexture")(dv=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gfxTexture=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e}return Z(n,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}},{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"destroy",value:function(){return this._tryDestroyTexture(),he(ne(n.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=mv[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,mv):i.copyTexImagesToTexture([e],this._gfxTexture,mv)}}}},{key:"_assignImage",value:function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),St.CLEANUP_IMAGE_CACHE)){var r=pv.getDeps(this._uuid),a=r.indexOf(e._uuid);-1!==a&&(Ee(r,a),e.decRef())}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(){return null}},{key:"_tryReset",value:function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}}},{key:"_createTexture",value:function(e){if(0!==this._width&&0!==this._height){var t=Oi.NONE;this._mipFilter!==Hm.NONE&&function(e,t,n){return!(e.gfxAPI===xi.WEBGL)||vv(t)&&vv(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=Oi.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Di.SAMPLED|Di.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}}]),n}(sv))||dv;c.SimpleTexture=Cv;var Av,bv,wv,Rv,Pv,Iv,Dv,Ov=e("Texture2D",(gv=Cc("cc.Texture2D"),yv=rl([lv]),gv((Ev=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_mipmaps",Tv,se(e)),e}return Z(n,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}},{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Um.RGBA8888,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.reset({width:e,height:t,format:n,mipmapLevel:i})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;if(!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],he(ne(n.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(){return null}},{key:"_deserialize",value:function(e,t){var i=e;he(ne(n.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new lv,i.mipmaps[r]){var a=i.mipmaps[r];t.result.push(this._mipmaps,"".concat(r),a,dt._getClassId(lv))}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=new wr(Ii.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)}},{key:"initDefault",value:function(e){he(ne(n.prototype),"initDefault",this).call(this,e);var t=new lv;t.initDefault(),this.image=t}},{key:"validate",value:function(){return this.mipmaps&&0!==this.mipmaps.length}}]),n}(Cv),Tv=xe((Sv=Ev).prototype,"_mipmaps",[yv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xv=Sv))||xv));c.Texture2D=Ov,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(Dv||(Dv={}));var Nv=e("TextureCube",Cc("cc.TextureCube")((Iv=Pv=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"isRGBE",wv,se(e)),ye(e,"_mipmaps",Rv,se(e)),e}return Z(n,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){Mv(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}},{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1?arguments[1]:void 0;if(!(t>=this._mipmaps.length))for(var i=Math.min(void 0===n?this._mipmaps.length:n,this._mipmaps.length-t),r=function(n){var i=t+n;Mv(e._mipmaps[i],(function(t,n){e._assignImage(t,i,n)}))},a=0;a<i;++a)r(a)}},{key:"destroy",value:function(){return this._mipmaps=[],he(ne(n.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(){return null}},{key:"_deserialize",value:function(e,t){var i=e;he(ne(n.prototype),"_deserialize",this).call(this,i.base,t),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new lv,back:new lv,left:new lv,right:new lv,top:new lv,bottom:new lv};var a=i.mipmaps[r],o=dt._getClassId(lv);t.result.push(this._mipmaps[r],"front",a.front,o),t.result.push(this._mipmaps[r],"back",a.back,o),t.result.push(this._mipmaps[r],"left",a.left,o),t.result.push(this._mipmaps[r],"right",a.right,o),t.result.push(this._mipmaps[r],"top",a.top,o),t.result.push(this._mipmaps[r],"bottom",a.bottom,o)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=new wr(Ii.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t}},{key:"initDefault",value:function(e){he(ne(n.prototype),"initDefault",this).call(this,e);var t=new lv;t.initDefault(),this.mipmaps=[{front:t,back:t,top:t,bottom:t,left:t,right:t}]}},{key:"validate",value:function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))}}],[{key:"fromTexture2DArray",value:function(e,t){for(var i=[],r=e.length/6,a=0;a<r;a++){var o=6*a;i.push({front:e[o+Dv.front].image,back:e[o+Dv.back].image,left:e[o+Dv.left].image,right:e[o+Dv.right].image,top:e[o+Dv.top].image,bottom:e[o+Dv.bottom].image})}return(t=t||new n).mipmaps=i,t}}]),n}(Cv),Pv.FaceIndex=Dv,wv=xe((bv=Iv).prototype,"isRGBE",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rv=xe(bv.prototype,"_mipmaps",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Av=bv))||Av);function Mv(e,t){t(e.front,Dv.front),t(e.back,Dv.back),t(e.left,Dv.left),t(e.right,Dv.right),t(e.top,Dv.top),t(e.bottom,Dv.bottom)}c.TextureCube=Nv;var kv,Lv,Bv,Fv=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2554907268,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:730673320,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:4277052359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),zv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Uv=function(){function e(){K(this,e),this._device=null,this._resources={}}return Z(e,[{key:"initBuiltinRes",value:function(e){var t=this;this._device=e;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),a=new Uint8Array(16),o=new Uint8Array(16),s=new Uint8Array(16),l=0,u=0;u<4;u++)i[l]=0,i[l+1]=0,i[l+2]=0,i[l+3]=255,r[l]=0,r[l+1]=0,r[l+2]=0,r[l+3]=0,a[l]=119,a[l+1]=119,a[l+2]=119,a[l+3]=255,o[l]=255,o[l+1]=255,o[l+2]=255,o[l+3]=255,s[l]=127,s[l+1]=127,s[l+2]=255,s[l+3]=255,l+=4;var h=new Uint8Array(1024);l=0;for(var _=0;_<256;_++)h[l]=221,h[l+1]=221,h[l+2]=221,h[l+3]=255,l+=4;l=0;for(var f=0;f<8;f++){for(var d=0;d<8;d++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}l+=32;for(var p=0;p<8;p++){for(var m=0;m<8;m++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}var v={width:2,height:2,_data:i,_compressed:!1,format:Ov.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:Ov.PixelFormat.RGBA8888},y={width:2,height:2,_data:a,_compressed:!1,format:Ov.PixelFormat.RGBA8888},x={width:2,height:2,_data:o,_compressed:!1,format:Ov.PixelFormat.RGBA8888},S={width:2,height:2,_data:s,_compressed:!1,format:Ov.PixelFormat.RGBA8888},T={width:16,height:16,_data:h,_compressed:!1,format:Ov.PixelFormat.RGBA8888},E=new lv(v),C=new Ov;C._uuid="black-texture",C.image=E,n[C._uuid]=C;var A=new lv(g),b=new Ov;b._uuid="empty-texture",b.image=A,n[b._uuid]=b;var w=new Nv;w._uuid="black-cube-texture",w.setMipFilter(Nv.Filter.NEAREST),w.image={front:new lv(v),back:new lv(v),left:new lv(v),right:new lv(v),top:new lv(v),bottom:new lv(v)},n[w._uuid]=w;var R=new lv(y),P=new Ov;P._uuid="grey-texture",P.image=R,n[P._uuid]=P;var I=new lv(x),D=new Ov;D._uuid="white-texture",D.image=I,n[D._uuid]=D;var O=new Nv;O._uuid="white-cube-texture",O.setMipFilter(Nv.Filter.NEAREST),O.image={front:new lv(x),back:new lv(x),left:new lv(x),right:new lv(x),top:new lv(x),bottom:new lv(x)},n[O._uuid]=O;var N=new lv(S),M=new Ov;M._uuid="normal-texture",M.image=N,n[M._uuid]=M;var k=new lv(T),L=new Ov;L._uuid="default-texture",L.image=k,n[L._uuid]=L;var B=new Nv;if(B.setMipFilter(Nv.Filter.NEAREST),B._uuid="default-cube-texture",B.image={front:new lv(T),back:new lv(T),left:new lv(T),right:new lv(T),top:new lv(T),bottom:new lv(T)},n[B._uuid]=B,c.SpriteFrame){var F=new c.SpriteFrame,z=E,U=new Ov;U.image=z,F.texture=U,F._uuid="default-spriteframe",n[F._uuid]=F}var G=Pm(e);if(!G)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var H=zv[G];return H?Promise.resolve().then((function(){Fv.forEach((function(e,t){var n=Object.assign(new c.EffectAsset,e);n.shaders.forEach((function(e,n){var i=H[t][n];i&&(e[G]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version ".concat(G," ")+"but shaders of that version are not assembled in this build."))}},{key:"get",value:function(e){return this._resources[e]}},{key:"_initMaterials",value:function(){var e=this._resources,t=[],n=new c.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var i=new c.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",c.color("#ffff00")),e[i._uuid]=i,t.push(i);var r=new c.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",c.color("#ff00ff")),e[r._uuid]=r,t.push(r);var a=new c.Material;a._uuid="default-clear-stencil",a.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[a._uuid]=a,t.push(a);var o=new c.Material;o._uuid="ui-base-material",o.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[o._uuid]=o,t.push(o);var s=new c.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var l=new c.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var u=new c.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new c.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var _=new c.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[_._uuid]=_,t.push(_);var f=new c.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),e[f._uuid]=f,t.push(f);var d=new c.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),e[d._uuid]=d,t.push(d);var p=new c.Material;p._uuid="default-particle-gpu-material",p.initialize({effectName:"particle-gpu"}),e[p._uuid]=p,t.push(p);var m=new c.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new c.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new c.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g),c.game.on(c.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))}}]),e}(),Gv=e("builtinResMgr",c.builtinResMgr=new Uv),Hv=e("getPhaseID",(kv=new Map,Lv=0,function(e){return"number"==typeof e?e:(kv.has(e)||(kv.set(e,1<<Lv),Lv++),kv.get(e))})),Vv=32,jv=e("InstancedBuffer",function(){function e(t){K(this,e),this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}return Z(e,[{key:"destroy",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0}},{key:"merge",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=t.buffer.length;if(r){var a=e.inputAssembler,o=e.descriptorSet.getTexture(jp),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==a.indexBuffer||u.count>=1024)&&u.lightingMap===o&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,r*Vv,r)),d=new Uint8Array(r*Vv),p=a.vertexBuffers.slice(),m=a.attributes.slice(),v=a.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],x=new zr(y.name,y.format,y.isNormalized,p.length,!0);m.push(x)}d.set(t.buffer),p.push(f);var S=new Gr(m,p,v),T=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:Vv,vb:f,data:d,ia:T,stride:r,shader:s,descriptorSet:c,lightingMap:o}),this.hasPendingModels=!0}}},{key:"uploadBuffers",value:function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}}},{key:"clear",value:function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1}}]),e}()),Wv=function(){function e(t){K(this,e),this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}return Z(e,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0}},{key:"merge",value:function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,a=0,o=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<Cp.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var d=0;d<_.vbs.length;++d){var p=i[d],m=_.vbs[d],v=_.vbDatas[d];(r=(o+_.vbCount)*p.stride)>m.size&&(m.resize(r),_.vbDatas[d]=new Uint8Array(r),_.vbDatas[d].set(v)),_.vbDatas[d].set(p.buffer,_.vbCount*p.stride)}var g=_.vbIdxData;(a=4*(o+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(a),_.vbIdxData=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+o,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var T=y;T<x;T++)g[T]=S+.1;return ei.toArray(_.uboData,n.transform.worldMatrix,Cp.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(Cp.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=o,void(_.ia.vertexCount+=o)}}}for(var E=[],C=[],A=[],b=0;b<i.length;++b){var w=i[b],R=this._device.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,w.count*w.stride,w.stride));R.update(w.buffer.buffer),E.push(R),C.push(new Uint8Array(R.size)),A.push(R)}var P=this._device.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,4*o,4)),I=new Float32Array(o);I.fill(0),P.update(I),A.push(P);for(var D=e.inputAssembler.attributes,O=new Array(D.length+1),N=0;N<D.length;++N)O[N]=D[N];O[D.length]=new zr("a_dyn_batch_id",Ei.R32F,!1,i.length);var M=new Gr(O,A),k=this._device.createInputAssembler(M),L=this._device.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,Cp.SIZE,Cp.SIZE));l.bindBuffer(Cp.BINDING,L),l.update();var B=new Float32Array(Cp.COUNT);ei.toArray(B,n.transform.worldMatrix,Cp.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:C,vbIdx:P,vbIdxData:I,vbCount:o,ia:k,ubo:L,uboData:B,pass:s,shader:c,descriptorSet:l})}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}}]),e}(),qv=new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.DEVICE),Xv=new Er(null),Yv=new Jr(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(Bv||(Bv={}));var Kv=function(){function e(t){K(this,e),this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new ka,this._dss=new Na,this._rs=new Oa,this._priority=qd.DEFAULT,this._stage=Wd.DEFAULT,this._phase=Hv("default"),this._primitive=Yi.TRIANGLE_LIST,this._batchingScheme=Bv.NONE,this._dynamicStates=Ji.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=t,this._device=t.device}return Z(e,[{key:"native",get:function(){return this._nativeObj}},{key:"initialize",value:function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ai.UNKNOWN,i=this._propertyHandleMap[e];return i?(n?i=vm(i,n):t&&(i=vm(i,fm(i)-t)),i+t):0}},{key:"getBinding",value:function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1}},{key:"setUniform",value:function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._getBlockView(r,i);ym[r](o,n,a),this._setRootBufferDirty(!0)}},{key:"getUniform",value:function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._getBlockView(r,i);return gm[r](o,n,a)}},{key:"setUniformArray",value:function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=va(r)>>2,o=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=a)null!==n[c]&&ym[r](o,n[c],s);this._setRootBufferDirty(!0)}},{key:"bindTexture",value:function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)}},{key:"bindSampler",value:function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)}},{key:"setDynamicState",value:function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)}},{key:"overridePipelineStates",value:function(){console.warn("base pass cannot override states, please use pass instance instead.")}},{key:"_setRootBufferDirty",value:function(e){this._rootBufferDirty=e}},{key:"update",value:function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):D(12006)}},{key:"getInstancedBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._instancedBuffers[e]||(this._instancedBuffers[e]=new jv(this))}},{key:"getBatchedBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._batchedBuffers[e]||(this._batchedBuffers[e]=new Wv(this))}},{key:"_initNative",value:function(){}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()}},{key:"resetUniform",value:function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),a=e.getOffsetFromHandle(n),o=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||Sm(i),u=(va(i)>>2)*o,h=0;h+l.length<=u;h+=l.length)s.set(l,a+h);this._setRootBufferDirty(!0)}}},{key:"resetTexture",value:function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),a=e.getBindingFromHandle(i),o=this._properties[t],s=o&&o.value,c=s?"".concat(s,"-texture"):Sm(r),l=Gv.get(c),u=l&&l.getGFXTexture(),h=o&&void 0!==o.samplerHash?Ua.unpackFromHash(o.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(a,_,n),this._descriptorSet.bindTexture(a,u,n)}}},{key:"resetUBOs",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],a=this._getBlockView(r.type,t.binding),o=this._properties[r.name],s=o&&o.value||Sm(r.type),c=(va(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)a.set(s,n+l);n+=c}this._setRootBufferDirty(!0)}},{key:"resetTextures",value:function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)}},{key:"tryCompile",value:function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=Fm.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(Fm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader ".concat(this._programName," failed")),!1)}},{key:"getShaderVariant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=Fm.getGFXShader(this._device,this._programName,this._defines,t),a=0;a<e.length;a++){var o=e[a];delete this._defines[o.name]}return r}},{key:"beginChangeStatesSilently",value:function(){}},{key:"endChangeStatesSilently",value:function(){}},{key:"_setPriority",value:function(e){this._priority=e}},{key:"_setStage",value:function(e){this._stage=e}},{key:"_setPhase",value:function(e){this._phase=e}},{key:"_setPrimitive",value:function(e){this._primitive=e}},{key:"_setState",value:function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i}},{key:"_doInit",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._initNative(),this._setPriority(qd.DEFAULT),this._setStage(Wd.DEFAULT),this._setPhase(Hv("default")),this._setPrimitive(Yi.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?ee({},t.defines):t.defines,this._shaderInfo=Fm.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),Yv.layout=Fm.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(Yv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,a=Fm.getTemplateInfo(t.program),o=a.blockSizes,s=a.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=o[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var d=l[l.length-1]+u;d&&(qv.size=16*Math.ceil(d/16),this._rootBuffer=i.createBuffer(qv),this._rootBlock=new ArrayBuffer(d));for(var p=0,m=0;p<r.length;p++){var v=r[p].binding,g=o[p];Xv.buffer=this._rootBuffer,Xv.offset=l[m++],Xv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Xv);this._blocks[v]=new Float32Array(this._rootBlock,Xv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var T in this._properties){var E=this._properties[T];E.handleInfo&&(S[T]=this.getHandle.apply(this,E.handleInfo))}Object.assign(x,S)}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_INSTANCING?this._device.hasFeature(Ti.INSTANCED_ARRAYS)?this._setBatchingScheme(Bv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Bv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Bv.VB_MERGING):this._setBatchingScheme(Bv.NONE)}},{key:"_setBatchingScheme",value:function(e){this._batchingScheme=e}},{key:"_setDynamicState",value:function(e){this._dynamicStates=e}},{key:"_setHash",value:function(e){this._hash=e}},{key:"_getBlockView",value:function(e,t){return e<Ai.FLOAT?this._blocksInt[t]:this._blocks[t]}},{key:"_setPipelineLayout",value:function(e){this._pipelineLayout=e}},{key:"_initPassFromTarget",value:function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(Fm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Fm.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}],[{key:"fillPipelineInfo",value:function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(Hv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)}},{key:"getPassHash",value:function(e){var t,n=Fm.getKey(e.program,e.defines),i="".concat(n,",").concat(e._primitive,",").concat(e._dynamicStates);return i+=function(e){for(var t,n=",bs,".concat(e.isA2C),i=ge(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,".concat(r.blend,",").concat(r.blendEq,",").concat(r.blendAlphaEq,",").concat(r.blendColorMask),n+=",".concat(r.blendSrc,",").concat(r.blendDst,",").concat(r.blendSrcAlpha,",").concat(r.blendDstAlpha)}return n}(e._bs),i+=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),(t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack))+",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)}(e._dss),wa(i+=(t=e._rs,",rs,".concat(t.cullMode,",").concat(t.depthBias,",").concat(t.isFrontFaceCCW)),666)}}]),e}();Kv.getTypeFromHandle=fm,Kv.getBindingFromHandle=dm,Kv.getCountFromHandle=pm,Kv.getOffsetFromHandle=mm;var Qv=e("PipelineStateManager",function(){function e(){K(this,e)}return Z(e,null,[{key:"getOrCreatePipelineState",value:function(e,t,n,i,r){var a=t.hash^i.hash^r.attributesHash^n.typedID,o=this._PSOHashMap.get(a);if(!o){var s=t.pipelineLayout,c=new ea(r.attributes),l=new La(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);o=e.createPipelineState(l),this._PSOHashMap.set(a,o)}return o}}]),e}());Qv._PSOHashMap=new Map;var Zv=new vr,Jv=new ur;function $v(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var eg,tg,ng,ig,rg,ag,og,sg,cg,lg,ug=null;function hg(e,t,n,i,r){if(i&&i.enabled&&r===ug){var a=i.subModels[0],o=a.inputAssembler,s=a.passes,c=a.shaders,l=a.descriptorSet;Zv.width=Jv.width=r.window.width,Zv.height=Jv.height=r.window.height;var u=Qv.getOrCreatePipelineState(e,s[0],c[0],t,o);n.setViewport(Zv),n.setScissor(Jv),n.bindPipelineState(u),n.bindDescriptorSet(np.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(np.LOCAL,l),n.bindInputAssembler(o),n.draw(o)}}var _g,fg,dg,pg,mg,vg=new ci,gg=e("Material",(eg=Cc("cc.Material"),tg=rl(zm),eg((lg=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"_effectAsset",rg,se(e)),ye(e,"_techIdx",ag,se(e)),ye(e,"_defines",og,se(e)),ye(e,"_states",sg,se(e)),ye(e,"_props",cg,se(e)),e._passes=[],e._hash=0,e}return Z(n,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}},{key:"initialize",value:function(e){this._passes.length?P(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){return this._doDestroy(),he(ne(n.prototype),"destroy",this).call(this)}},{key:"recompileShaders",value:function(){console.warn("Shaders in material asset '".concat(this.name,"' cannot be modified at runtime, please instantiate the material first."))}},{key:"overridePipelineStates",value:function(){console.warn("Pipeline states in material asset '".concat(this.name,"' cannot be modified at runtime, please instantiate the material first."))}},{key:"onLoaded",value:function(){this._update()}},{key:"resetUniforms",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=ge(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}}},{key:"setProperty",value:function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,a=r.length,o=0;o<a;o++){var s=r[o];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: ".concat(n,"."));var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var a=n[r];if(e in a)return a[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;var o=this._props[this._passes[t].propertyIndex];if(e in o)return o[e]}return null}},{key:"copy",value:function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var n=0;n<e._props.length;n++)this._props[n]=ee({},e._props[n]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=ee({},e._defines[i]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=ee({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()}},{key:"_fillInfo",value:function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=zm.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)}},{key:"_prepareInfo",value:function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])}},{key:"_createPasses",value:function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var r=e.passes[i],a=r.passIndex=i,o=r.defines=this._defines[a]||(this._defines[a]={});if(r.stateOverrides=this._states[a]||(this._states[a]={}),void 0!==r.propertyIndex&&Object.assign(o,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(o,r.embeddedMacros),!r.switch||o[r.switch]){var s=new Kv(c.director.root);s.initialize(r),n.push(s)}}return n}},{key:"_update",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,t)this._passes.forEach((function(t,n){var i=e._props[n];for(var r in i||(i=e._props[n]={}),void 0!==t.propertyIndex&&Object.assign(i,e._props[t.propertyIndex]),i)e._uploadProperty(t,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=n.getHash(this)}},{key:"_uploadProperty",value:function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(Kv.getTypeFromHandle(i)<Ai.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var a=n;$v(vg,a),vg.w=a.w,n=vg}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var o=0;o<n.length;o++)this._bindTexture(e,i,n[o],o);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0}},{key:"_bindTexture",value:function(e,t,n,i){var r=Kv.getBindingFromHandle(t);if(n instanceof Ha)e.bindTexture(r,n,i);else if(n instanceof sv){var a=n.getGFXTexture();if(!a||!a.width||!a.height)return;e.bindTexture(r,a,i),e.bindSampler(r,n.getGFXSampler(),i)}}},{key:"_doDestroy",value:function(){if(this._passes&&this._passes.length)for(var e,t=ge(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0}},{key:"initDefault",value:function(e){he(ne(n.prototype),"initDefault",this).call(this,e),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new Bn("#ff00ff"))}},{key:"validate",value:function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0}}],[{key:"getHash",value:function(e){for(var t,n=0,i=ge(e.passes);!(t=i()).done;)n^=t.value.hash;return n}}]),n}(Uu),rg=xe((ig=lg).prototype,"_effectAsset",[tg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ag=xe(ig.prototype,"_techIdx",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),og=xe(ig.prototype,"_defines",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sg=xe(ig.prototype,"_states",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cg=xe(ig.prototype,"_props",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ng=ig))||ng));c.Material=gg,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(_g||(_g={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(fg||(fg={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(dg||(dg={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(pg||(pg={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(mg||(mg={}));var yg=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],xg=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],Sg=[100,200,400,800],Tg=new zn,Eg=new zn,Cg=new ei,Ag=rr.STENCIL<<1,bg=[],wg=function(){function e(t){if(K(this,e),this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=_g.VERTICAL,this._fov=Sn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new gr(.2,.2,.2,1),this._viewport=new fi(0,0,1,1),this._orientedViewport=new fi(0,0,1,1),this._curTransform=Si.IDENTITY,this._isProjDirty=!0,this._matView=new ei,this._matProj=new ei,this._matProjInv=new ei,this._matViewProj=new ei,this._matViewProjInv=new ei,this._frustum=new fc,this._forward=new zn,this._position=new zn,this._priority=0,this._aperture=dg.F16_0,this._apertureValue=void 0,this._shutter=mg.D125,this._shutterValue=0,this._iso=pg.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=rr.NONE,this._clearDepth=1,this._visibility=rm,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=yg[this._aperture],this._shutterValue=xg[this._shutter],this._isoValue=Sg[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!bg.length){var n=t.capabilities.clipSpaceSignY;bg[Si.IDENTITY]=new ei(1,0,0,0,0,n),bg[Si.ROTATE_90]=new ei(0,1,0,0,-n,0),bg[Si.ROTATE_180]=new ei(-1,0,0,0,0,-n),bg[Si.ROTATE_270]=new ei(0,-1,0,0,n,0)}}return Z(e,[{key:"_setWidth",value:function(e){this._width=e}},{key:"_setHeight",value:function(e){this._height=e}},{key:"_setScene",value:function(e){this._scene=e}},{key:"_updateAspect",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain,n=t&&t.surfaceTransform||Si.IDENTITY;n%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0}},{key:"_init",value:function(){}},{key:"initialize",value:function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=rr.NONE,this.clearDepth=1,this.visibility=rm,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()}},{key:"attachToScene",value:function(e){this._enabled=!0,this._setScene(e)}},{key:"detachFromScene",value:function(){this._enabled=!1,this._setScene(null)}},{key:"resize",value:function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())}},{key:"setFixedSize",value:function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1}},{key:"syncCameraEditor",value:function(){}},{key:"update",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._node){var n=!1;(this._node.hasChangedFlags||t)&&(ei.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(e=this.window)||void 0===e?void 0:e.swapchain,r=i&&i.surfaceTransform||Si.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var a=this._device.capabilities.clipSpaceSignY;if(this._proj===fg.PERSPECTIVE)ei.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===_g.VERTICAL,this._device.capabilities.clipSpaceMinZ,a,r);else{var o=this._orthoHeight*this._aspect,s=this._orthoHeight;ei.ortho(this._matProj,-o,o,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,a,r)}ei.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(ei.multiply(this._matViewProj,this._matProj,this._matView),ei.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"viewport",get:function(){return this._viewport},set:function(e){P(8302),this.setViewportInOrientedSpace(e)}},{key:"setViewportInOrientedSpace",value:function(e){var t,n=e.x,i=e.width,r=e.height,a=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,o=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(o&&o.surfaceTransform||Si.IDENTITY){case Si.ROTATE_90:this._viewport.x=1-a-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case Si.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-a-r,this._viewport.width=i,this._viewport.height=r;break;case Si.ROTATE_270:this._viewport.x=a,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case Si.IDENTITY:this._viewport.x=n,this._viewport.y=a,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=a,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=yg[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=xg[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=Sg[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"native",get:function(){return this._nativeObj}},{key:"changeTargetWindow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._window&&this._window.detachCamera(this);var t=e||c.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain,i=n&&n.surfaceTransform||Si.IDENTITY;i%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}}},{key:"detachCamera",value:function(){this._window&&this._window.detachCamera(this)}},{key:"screenPointToRay",value:function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,a=this._orientedViewport.x*i,o=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===fg.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=$n[this._curTransform];zn.set(Tg,(t-a)/s*2-1,(n-o)/c*2-1,l?1:-1);var _=Tg.x,f=Tg.y;return Tg.x=_*h[0]+f*h[2]*u,Tg.y=_*h[1]+f*h[3]*u,zn.transformMat4(l?Tg:e.o,Tg,this._matViewProjInv),l?(this._node.getWorldPosition(Eg),lo.fromPoints(e,Eg,Tg)):zn.transformQuat(e.d,zn.FORWARD,this._node.worldRotation),e}},{key:"screenToWorld",value:function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,a=this._orientedViewport.y*i,o=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=$n[this._curTransform];if(this._proj===fg.PERSPECTIVE){zn.set(e,(t.x-r)/o*2-1,(t.y-a)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,zn.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(Tg),zn.lerp(e,Tg,e,xn(this._nearClip/this._farClip,1,t.z))}else{zn.set(e,(t.x-r)/o*2-1,(t.y-a)/s*2-1,2*t.z-1);var _=e.x,f=e.y;e.x=_*l[0]+f*l[2]*c,e.y=_*l[1]+f*l[3]*c,zn.transformMat4(e,e,this._matViewProjInv)}return e}},{key:"worldToScreen",value:function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=$n[this._curTransform];zn.transformMat4(e,t,this._matViewProj);var r=e.x,a=e.y;e.x=r*i[0]+a*i[2]*n,e.y=r*i[1]+a*i[3]*n;var o=this.width,s=this.height,c=this._orientedViewport.x*o,l=this._orientedViewport.y*s,u=this._orientedViewport.width*o,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e}},{key:"worldMatrixToScreen",value:function(e,t,n,i){ei.multiply(e,this._matViewProj,t),ei.multiply(e,bg[this._curTransform],e);var r=n/2,a=i/2;return ei.identity(Cg),ei.transform(Cg,Cg,zn.set(Tg,r,a,0)),ei.scale(Cg,Cg,zn.set(Tg,r,a,1)),ei.multiply(e,Cg,e),e}},{key:"setExposure",value:function(e){this._exposure=.833333/Math.pow(2,e)}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),Rg=mt({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Pg=mt({Planar:0,ShadowMap:1}),Ig=mt({HARD:0,SOFT:1,SOFT_2X:2}),Dg=Pg.ShadowMap+1,Og=function(){function e(){K(this,e),this.fixedSphere=new vo(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new ei,this.matShadowProj=new ei,this.matShadowViewProj=new ei,this._normal=new zn(0,1,0),this._shadowColor=new Bn(0,0,0,76),this._matLight=new ei,this._material=null,this._instancingMaterial=null,this._size=new ri(512,512),this._enabled=!1,this._distance=0,this._type=Dg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}return Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){zn.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"near",get:function(){return this._near},set:function(e){this._near=e}},{key:"far",get:function(){return this._far},set:function(e){this._far=e}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e}},{key:"saturation",get:function(){return this._saturation},set:function(e){this._saturation=e}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}},{key:"getPlanarShader",value:function(e){return this._material||(this._material=new gg,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)}},{key:"getPlanarInstanceShader",value:function(e){return this._instancingMaterial||(this._instancingMaterial=new gg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)}},{key:"_setEnable",value:function(e){this._enabled=e}},{key:"_setType",value:function(e){this._type=this.enabled?e:Dg}},{key:"initialize",value:function(e){this.near=e.near,this.far=e.far,this.invisibleOcclusionRange=e.invisibleOcclusionRange,this.shadowDistance=e.shadowDistance,this.orthoSize=e.orthoSize,this.size=e.size,this.pcf=e.pcf,this.normal=e.normal,this.distance=e.distance,this.shadowColor=e.shadowColor,this.bias=e.bias,this.normalBias=e.normalBias,this.maxReceived=e.maxReceived,this.fixedArea=e.fixedArea,this._setEnable(e.enabled),this._setType(e.type),this.saturation=e.saturation}},{key:"activate",value:function(){this.enabled&&this.type===Pg.Planar&&this._updatePlanarInfo()}},{key:"_updatePlanarInfo",value:function(){this._material||(this._material=new gg,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new gg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()}}]),e}();Og.MAX_FAR=2e3,Og.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),c.Shadows=Og;var Ng=new zn,Mg=(new zn,new zn,new zn),kg=new ei,Lg=new tc,Bg=new tc,Fg=!1,zg=vo.create(0,0,0,1),Ug=new vo,Gg=new fc;Gg.accurate=!0;var Hg=new fc;Hg.accurate=!0;var Vg=new fc,jg=new ei,Wg=new ei,qg=new ei,Xg=new ei,Yg=new ei,Kg=new ei,Qg=new ei,Zg=new zn,Jg=new ri,$g=new zn,ey=new zn,ty=new zn(0,0,0),ny=(new tc,new Jl((function(){return{model:null,depth:0}}),128)),iy=new Jl((function(){return{model:null,depth:0}}),128),ry=new Jl((function(){return{model:null,depth:0}}),128);function ay(e,t){var n=0;e.node&&(zn.subtract(Ng,e.node.worldPosition,t.position),n=zn.dot(Ng,t.forward));var i=ny.alloc();return i.model=e,i.depth=n,i}function oy(e,t){var n=0;e.node&&(zn.subtract(Ng,e.node.worldPosition,t.position),n=zn.dot(Ng,t.forward));var i=iy.alloc();return i.model=e,i.depth=n,i}function sy(e,t){var n=0;e.node&&(zn.subtract(Ng,e.node.worldPosition,t.position),n=zn.dot(Ng,t.forward));var i=ry.alloc();return i.model=e,i.depth=n,i}function cy(e,t,n){var i=t.direction,r=e.normal,a=e.distance+.001,o=1/zn.dot(r,i),s=i.x*o,c=i.y*o,l=i.z*o,u=r.x,h=r.y,_=r.z,f=e.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*a,f.m13=c*a,f.m14=l*a,f.m15=1,ei.toArray(n,f,cp.MAT_LIGHT_PLANE_PROJ_OFFSET)}function ly(e,t){zn.normalize(Ng,e.normal),t[cp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Ng.x,t[cp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Ng.y,t[cp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Ng.z,t[cp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=e.distance}function uy(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var a=i[r];a.baked||(vo.set(zg,a.position.x,a.position.y,a.position.z,a.range),Ss.sphereFrustum(zg,t.frustum)&&n.push(a))}for(var o=t.scene.sphereLights,s=0;s<o.length;s++){var c=o[s];c.baked||(vo.set(zg,c.position.x,c.position.y,c.position.z,c.range),Ss.sphereFrustum(zg,t.frustum)&&n.push(c))}}function hy(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,a=r.shadows,o=r.skybox,s=r.renderObjects;ny.freeArray(s),s.length=0;var c=r.castShadowObjects;ry.freeArray(c),c.length=0,Fg=!1;var l=null;if(a.enabled&&(e.pipelineUBO.updateShadowUBORange(cp.SHADOW_COLOR_OFFSET,a.shadowColor),a.type===Pg.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,iy.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var a=t.device;if(r.fixedArea){var o=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;ei.fromRT(jg,n.node.getWorldRotation(),n.node.getWorldPosition()),ei.invert(Wg,jg),ei.ortho(Xg,-o,o,-s,s,c,l,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY),ei.multiply(Yg,Xg,Wg),ei.invert(qg,Wg),r.matShadowView=Wg,r.matShadowProj=Xg,r.matShadowViewProj=Yg,fc.createOrtho(e,2*o,2*s,c,l,qg)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();ei.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(kg,i),fc.split(Gg,i,kg,.1,r.shadowDistance),Hg=fc.clone(Gg),ei.fromRT(jg,n.node.rotation,ty),ei.invert(Wg,jg),ei.invert(qg,Wg);var _=Wg.clone();Hg.transform(Wg),tc.fromPoints(Lg,new zn(1e7,1e7,1e7),new zn(-1e7,-1e7,-1e7)),Lg.mergeFrustum(Hg);var f=2*Lg.halfExtents.z;Mg.set(Lg.center.x,Lg.center.y,Lg.center.z+Lg.halfExtents.z+u),zn.transformMat4(Mg,Mg,qg),ei.fromRT(jg,n.node.rotation,Mg),ei.invert(Wg,jg),ei.invert(qg,Wg);var d=zn.distance(Gg.vertices[0],Gg.vertices[6]);Ug.center.set(0,0,0),Ug.radius=-1,Ug.mergePoints(Gg.vertices);var p=.8*d+.4*Ug.radius;r.shadowCameraFar=f+u;var m=.5*p;if(ei.ortho(Xg,-m,m,-m,m,.1,r.shadowCameraFar,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY),h>0){ei.multiply(Kg,Xg,_),zn.transformMat4(Zg,Mg,Kg);var v=2/h;Jg.set(v,v);var g=Zg.x%Jg.x,y=Zg.y%Jg.y;$g.set(Zg.x-g,Zg.y-y,Zg.z),ei.invert(Qg,Kg),zn.transformMat4(ey,$g,Qg),ei.fromRT(jg,n.node.rotation,ey),ei.invert(Wg,jg),ei.invert(qg,Wg),fc.createOrtho(e,p,p,.1,r.shadowCameraFar,qg)}else{for(var x=0;x<8;x++)e.vertices[x].set(0,0,0);e.updatePlanes()}ei.multiply(Yg,Xg,Wg),r.matShadowView=Wg,r.matShadowProj=Xg,r.matShadowViewProj=Yg}}(Vg,e,i,t,a);else{for(var u=0;u<8;u++)Vg.vertices[u].set(0,0,0);Vg.updatePlanes()}i&&a.type===Pg.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,a=n.distance+.001,o=1/zn.dot(r,i),s=i.x*o,c=i.y*o,l=i.z*o,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*a,f.m13=c*a,f.m14=l*a,f.m15=1,e.pipelineUBO.updateShadowUBORange(cp.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),o.enabled&&o.model&&t.clearFlag&Ag&&s.push(ay(o.model,t));for(var h=n.models,_=t.visibility,f=0;f<h.length;f++){var d=h[f];if(d.enabled&&(d.castShadow&&c.push(sy(d,t)),a.firstSetCSM&&d.worldBounds&&(Fg||(Bg.copy(d.worldBounds),Fg=!0),tc.merge(Bg,Bg,d.worldBounds)),d.node&&(_&d.node.layer)===d.node.layer||_&d.visFlags)){if(null!=l&&d.castShadow&&d.worldBounds&&Ss.aabbFrustum(d.worldBounds,Vg)&&l.push(oy(d,t)),d.worldBounds&&!Ss.aabbFrustum(d.worldBounds,t.frustum))continue;s.push(ay(d,t))}}a.firstSetCSM&&(a.shadowDistance=2*Bg.halfExtents.length(),a.firstSetCSM=!1)}var _y,fy,dy,py=new Pr(ki.LINEAR,ki.LINEAR,ki.NONE,Li.CLAMP,Li.CLAMP,Li.CLAMP),my=new Pr(ki.POINT,ki.POINT,ki.NONE,Li.CLAMP,Li.CLAMP,Li.CLAMP),vy=function(){function e(t){K(this,e),this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t.device,this._linearSampler=this._device.getSampler(py),this._pointSampler=this._device.getSampler(my);var n=new Zr(Zd.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(n),this._globalDescriptorSet=this._device.createDescriptorSet(new Jr(this._descriptorSetLayout))}return Z(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}},{key:"bindBuffer",value:function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()}},{key:"bindSampler",value:function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()}},{key:"bindTexture",value:function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()}},{key:"update",value:function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()}},{key:"getOrCreateDescriptorSet",value:function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new Jr(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=Qd.UBO_GLOBAL;r<Qd.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var a=t.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,cp.SIZE,cp.SIZE));i.bindBuffer(cp.BINDING,a),i.update()}return this._descriptorSetMap.get(e)}},{key:"destroy",value:function(){this._descriptorSetLayout.destroy()}}]),e}();function gy(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),a=2*i-8*r+4,o=3*i/a,s=2*r/a,c=1/s*o,l=1/s*(1-o-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(_y||(_y={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(fy||(fy={})),c.internal.TransformBit=fy,function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(dy||(dy={}));var yy,xy,Sy,Ty,Ey,Cy,Ay,by,wy,Ry,Py=function(e){return 4*Math.PI*Math.PI*e*e},Iy=function(){function e(){K(this,e),this._baked=!1,this._color=new zn(1,1,1),this._colorTemp=6550,this._colorTempRGB=new zn(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=dy.UNKNOWN}return Z(e,[{key:"_init",value:function(){}},{key:"_destroy",value:function(){}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,gy(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=fy.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}},{key:"initialize",value:function(){this._init(),this.color=new zn(1,1,1),this.colorTemperature=6550}},{key:"attachToScene",value:function(e){this._scene=e}},{key:"detachFromScene",value:function(){this._scene=null}},{key:"destroy",value:function(){this._name=null,this._node=null,this._destroy()}},{key:"update",value:function(){}}]),e}(),Dy=new ei,Oy=new ei,Ny=new ei,My=new ci,ky=new ci(0,0,1,0),Ly=function(){function e(){K(this,e),this._globalUBO=new Float32Array(op.COUNT),this._cameraUBO=new Float32Array(sp.COUNT),this._shadowUBO=new Float32Array(cp.COUNT)}return Z(e,[{key:"_initCombineSignY",value:function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5}},{key:"activate",value:function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,op.SIZE,op.SIZE));n.bindBuffer(op.BINDING,i);var r=e.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,sp.SIZE,sp.SIZE));n.bindBuffer(sp.BINDING,r);var a=e.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,cp.SIZE,cp.SIZE));n.bindBuffer(cp.BINDING,a)}},{key:"updateGlobalUBO",value:function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer(op.BINDING),this._globalUBO),n.bindBuffer(op.BINDING,i.getBuffer(op.BINDING)),n.update()}},{key:"updateCameraUBO",value:function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(sp.BINDING),this._cameraUBO),n.bindBuffer(sp.BINDING,i.getBuffer(sp.BINDING)),n.update()}},{key:"updateShadowUBO",value:function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,a=n.shadowFrameBufferMap,o=t.scene.mainLight;o&&a.has(o)&&i.bindTexture(lp,a.get(o).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(cp.BINDING),this._shadowUBO)}}},{key:"updateShadowUBOLight",value:function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(lp,Gv.get("default-texture").getGFXTexture()),t.bindTexture(gp,Gv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(cp.BINDING).update(this._shadowUBO)}},{key:"updateShadowUBORange",value:function(e,t){t instanceof ei?ei.toArray(this._shadowUBO,t,e):t instanceof Bn&&Bn.toArray(this._shadowUBO,t,e)}},{key:"destroy",value:function(){}}],[{key:"updateGlobalUBOView",value:function(e,t){var n=c.director.root,i=t,r=Math.floor(e.width),a=Math.floor(e.height);i[op.TIME_OFFSET]=n.cumulativeTime,i[op.TIME_OFFSET+1]=n.frameTime,i[op.TIME_OFFSET+2]=c.director.getTotalFrames(),i[op.SCREEN_SIZE_OFFSET]=r,i[op.SCREEN_SIZE_OFFSET+1]=a,i[op.SCREEN_SIZE_OFFSET+2]=1/r,i[op.SCREEN_SIZE_OFFSET+3]=1/a,i[op.NATIVE_SIZE_OFFSET]=r,i[op.NATIVE_SIZE_OFFSET+1]=a,i[op.NATIVE_SIZE_OFFSET+2]=1/i[op.NATIVE_SIZE_OFFSET],i[op.NATIVE_SIZE_OFFSET+3]=1/i[op.NATIVE_SIZE_OFFSET+1]}},{key:"updateCameraUBOView",value:function(e,t,n){var i=(n.scene?n.scene:c.director.getScene().renderScene).mainLight,r=e.pipelineSceneData,a=r.ambient,o=r.fog,s=r.shadows,l=t,u=n.exposure,h=r.isHDR;if(l[sp.SCREEN_SCALE_OFFSET]=r.shadingScale,l[sp.SCREEN_SCALE_OFFSET+1]=r.shadingScale,l[sp.SCREEN_SCALE_OFFSET+2]=1/l[sp.SCREEN_SCALE_OFFSET],l[sp.SCREEN_SCALE_OFFSET+3]=1/l[sp.SCREEN_SCALE_OFFSET+1],l[sp.EXPOSURE_OFFSET]=u,l[sp.EXPOSURE_OFFSET+1]=1/u,l[sp.EXPOSURE_OFFSET+2]=h?1:0,l[sp.EXPOSURE_OFFSET+3]=0,i){var _=s.enabled&&s.type===Pg.ShadowMap?1:0,f=i.direction;if(ky.set(f.x,f.y,f.z,_),ci.toArray(l,ky,sp.MAIN_LIT_DIR_OFFSET),zn.toArray(l,i.color,sp.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var d=i.colorTemperatureRGB;l[sp.MAIN_LIT_COLOR_OFFSET]*=d.x,l[sp.MAIN_LIT_COLOR_OFFSET+1]*=d.y,l[sp.MAIN_LIT_COLOR_OFFSET+2]*=d.z}l[sp.MAIN_LIT_COLOR_OFFSET+3]=h?i.illuminance*u:i.illuminance}else ky.set(0,0,1,0),ci.toArray(l,ky,sp.MAIN_LIT_DIR_OFFSET),ci.toArray(l,ci.ZERO,sp.MAIN_LIT_COLOR_OFFSET);var p=a.skyColor;p.w=h?a.skyIllum*u:a.skyIllum,l[sp.AMBIENT_SKY_OFFSET+0]=p.x,l[sp.AMBIENT_SKY_OFFSET+1]=p.y,l[sp.AMBIENT_SKY_OFFSET+2]=p.z,l[sp.AMBIENT_SKY_OFFSET+3]=p.w,l[sp.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,l[sp.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,l[sp.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,l[sp.AMBIENT_GROUND_OFFSET+3]=a.mipmapCount,ei.toArray(l,n.matView,sp.MAT_VIEW_OFFSET),ei.toArray(l,n.node.worldMatrix,sp.MAT_VIEW_INV_OFFSET),zn.toArray(l,n.position,sp.CAMERA_POS_OFFSET),ei.toArray(l,n.matProj,sp.MAT_PROJ_OFFSET),ei.toArray(l,n.matProjInv,sp.MAT_PROJ_INV_OFFSET),ei.toArray(l,n.matViewProj,sp.MAT_VIEW_PROJ_OFFSET),ei.toArray(l,n.matViewProjInv,sp.MAT_VIEW_PROJ_INV_OFFSET),l[sp.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var m=o.colorArray;l[sp.GLOBAL_FOG_COLOR_OFFSET]=m.x,l[sp.GLOBAL_FOG_COLOR_OFFSET+1]=m.y,l[sp.GLOBAL_FOG_COLOR_OFFSET+2]=m.z,l[sp.GLOBAL_FOG_COLOR_OFFSET+3]=m.z,l[sp.GLOBAL_FOG_BASE_OFFSET]=o.fogStart,l[sp.GLOBAL_FOG_BASE_OFFSET+1]=o.fogEnd,l[sp.GLOBAL_FOG_BASE_OFFSET+2]=o.fogDensity,l[sp.GLOBAL_FOG_ADD_OFFSET]=o.fogTop,l[sp.GLOBAL_FOG_ADD_OFFSET+1]=o.fogRange,l[sp.GLOBAL_FOG_ADD_OFFSET+2]=o.fogAtten,l[sp.NEAR_FAR_OFFSET]=n.nearClip,l[sp.NEAR_FAR_OFFSET+1]=n.farClip,l[sp.VIEW_PORT_OFFSET]=r.shadingScale*n.window.width*n.viewport.x,l[sp.VIEW_PORT_OFFSET+1]=r.shadingScale*n.window.height*n.viewport.y,l[sp.VIEW_PORT_OFFSET+2]=r.shadingScale*n.window.width*n.viewport.z,l[sp.VIEW_PORT_OFFSET+3]=r.shadingScale*n.window.height*n.viewport.w}},{key:"updateShadowUBOView",value:function(e,t,n){var i=e.device,r=n.scene.mainLight,a=e.pipelineSceneData.shadows,o=t;if(a.enabled){if(r&&a.type===Pg.ShadowMap){var s=.1,c=0,l=a.matShadowView,u=a.matShadowProj,h=a.matShadowViewProj;a.fixedArea?(s=a.near,c=a.far):(s=.1,c=a.shadowCameraFar),ei.toArray(t,l,cp.MAT_LIGHT_VIEW_OFFSET),o[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[cp.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[cp.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[cp.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[cp.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,ei.toArray(t,h,cp.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=sm(i)?0:1;o[cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,o[cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,o[cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,o[cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-a.saturation,o[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,o[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,o[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=a.pcf,o[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=a.bias,o[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,o[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,o[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=a.normalBias,o[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&a.type===Pg.Planar&&(cy(a,r,o),ly(a,o));Bn.toArray(o,a.shadowColor,cp.SHADOW_COLOR_OFFSET)}}},{key:"updateShadowUBOLightView",value:function(e,t,n){var i=e.device,r=e.pipelineSceneData.shadows,a=t,o=sm(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case dy.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),ei.toArray(t,l,cp.MAT_LIGHT_VIEW_OFFSET),a[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[cp.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[cp.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[cp.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[cp.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,ei.toArray(t,h,cp.MAT_LIGHT_VIEW_PROJ_OFFSET),My.set(s,c,0,1-r.saturation),ci.toArray(a,My,cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),My.set(0,o,r.normalBias,0),ci.toArray(a,My,cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case dy.SPOT:ei.invert(Dy,n.node.getWorldMatrix()),ei.toArray(a,Dy,cp.MAT_LIGHT_VIEW_OFFSET),ei.perspective(Oy,n.angle,n.aspect,.001,n.range),ei.multiply(Ny,Oy,Dy),ei.toArray(a,Ny,cp.MAT_LIGHT_VIEW_PROJ_OFFSET),My.set(.01,n.range,0,1-r.saturation),ci.toArray(a,My,cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),My.set(1,o,r.normalBias,0),ci.toArray(a,My,cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}My.set(r.size.x,r.size.y,r.pcf,r.bias),ci.toArray(a,My,cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Bn.toArray(a,r.shadowColor,cp.SHADOW_COLOR_OFFSET)}},{key:"getCombineSignY",value:function(){return e._combineSignY}}]),e}();Ly._combineSignY=0;var By,Fy,zy,Uy,Gy,Hy,Vy,jy,Wy,qy,Xy,Yy,Ky,Qy=e("RenderStage",(yy=Cc("RenderStage"),xy=Zc(),Sy=Zc(),Ty=Zc(),yy((Ry=function(){function e(){K(this,e),ye(this,"_name",Ay,this),ye(this,"_priority",by,this),this._enabled=!0,ye(this,"_tag",wy,this)}return Z(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e,t){this._pipeline=e,this._flow=t}}]),e}(),Ay=xe((Cy=Ry).prototype,"_name",[xy,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),by=xe(Cy.prototype,"_priority",[Sy,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wy=xe(Cy.prototype,"_tag",[Ty,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ey=Cy))||Ey));c.RenderStage=Qy;var Zy,Jy=e("RenderFlow",(By=Cc("RenderFlow"),Fy=Zc(),zy=Zc(),Uy=Zc(),Gy=Zc(),Hy=rl([Qy]),By((Ky=function(){function e(){K(this,e),ye(this,"_name",Wy,this),ye(this,"_priority",qy,this),ye(this,"_tag",Xy,this),ye(this,"_stages",Yy,this)}return Z(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}},{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)}},{key:"render",value:function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)}},{key:"destroy",value:function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0}}]),e}(),Wy=xe((jy=Ky).prototype,"_name",[Fy,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qy=xe(jy.prototype,"_priority",[zy,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xy=xe(jy.prototype,"_tag",[Uy,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yy=xe(jy.prototype,"_stages",[Gy,Hy,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vy=jy))||Vy));c.RenderFlow=Jy,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(Zy||(Zy=e("PipelineEventType",{})));var $y,ex,tx,nx,ix,rx,ax,ox,sx,cx,lx,ux,hx,_x,fx,dx=e("PipelineEventProcessor",function(e){te(n,e);var t=le(n);function n(){var e,i,r;K(this,n);for(var a=arguments.length,o=new Array(a),s=0;s<a;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))).eventTargetOn=he((e=se(r),ne(n.prototype)),"on",e),r.eventTargetOnce=he((i=se(r),ne(n.prototype)),"once",i),r}return Z(n,[{key:"on",value:function(e,t,n,i){return this.eventTargetOn(e,t,n,i)}},{key:"once",value:function(e,t,n){return this.eventTargetOnce(e,t,n)}}]),n}(lu)),px=new ur,mx=new vr,vx=function e(){K(this,e),this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},gx=function e(){K(this,e),this.quadIB=null,this.quadVB=null,this.quadIA=null},yx=e("RenderPipeline",($y=Cc("cc.RenderPipeline"),ex=Zc(),tx=Zc(),nx=rl([Jy]),$y((sx=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_tag",ax,se(e)),ye(e,"_flows",ox,se(e)),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new dx,e._commandBuffers=[],e._pipelineUBO=new Ly,e._macros={},e._constantMacros="",e._profiler=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new ur,e._clusterEnabled=!1,e._bloomEnabled=!1,e}return Z(n,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"getPipelineRenderData",value:function(){return this._pipelineRenderData}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}},{key:"initialize",value:function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0}},{key:"createRenderPass",value:function(e,t,n){var i=this._device,r=new Hr,a=new Vr;r.format=t,a.format=n,a.stencilStoreOp=ji.DISCARD,a.depthStoreOp=ji.DISCARD,e&rr.COLOR||(e&Ag?r.loadOp=Vi.DISCARD:(r.loadOp=Vi.LOAD,r.beginAccesses=[Wi.COLOR_ATTACHMENT_WRITE])),(e&rr.DEPTH_STENCIL)!==rr.DEPTH_STENCIL&&(e&rr.DEPTH||(a.depthLoadOp=Vi.LOAD),e&rr.STENCIL||(a.stencilLoadOp=Vi.LOAD)),a.beginAccesses=[Wi.DEPTH_STENCIL_ATTACHMENT_WRITE];var o=new qr([r],a);return i.createRenderPass(o)}},{key:"getRenderPass",value:function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)}},{key:"applyFramebufferRatio",value:function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,a=0;a<r.length;a++)r[a].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new Kr(e.renderPass,r,e.depthStencilTexture))}},{key:"generateRenderArea",value:function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r}},{key:"generateViewport",value:function(e,t){this.generateRenderArea(e,px),t||(t=mx);var n=this.pipelineSceneData.shadingScale;return t.left=px.x*n,t.top=px.y*n,t.width=px.width*n,t.height=px.height*n,t}},{key:"generateScissor",value:function(e,t){t||(t=px),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t}},{key:"activate",value:function(){var e=c.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new vy(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0}},{key:"_ensureEnoughSize",value:function(){}},{key:"render",value:function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(Zy.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(ug=n)}ug=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(Zy.RENDER_CAMERA_BEGIN,n),uy(this,n),hy(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(Zy.RENDER_CAMERA_END,n)}}this.emit(Zy.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}}},{key:"_destroyQuadInputAssembler",value:function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)}},{key:"_destroyBloomData",value:function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}}},{key:"_genQuadVertexData",value:function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,a=t.y/this._height,o=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=o;o=a,a=s}var c=0;switch(e){case Si.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case Si.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=a;break;case Si.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case Si.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o}return n}},{key:"_createQuadInputAssembler",value:function(){var e=new gx,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.DEVICE|Pi.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r,o=this._device.createBuffer(new Tr(bi.INDEX|bi.TRANSFER_DST,Pi.DEVICE,a,r));if(!o)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,o.update(s);var c=new Array(2);c[0]=new zr("a_position",Ei.RG32F),c[1]=new zr("a_texCoord",Ei.RG32F);var l=this._device.createInputAssembler(new Gr(c,[i],o));return e.quadIB=o,e.quadVB=i,e.quadIA=l,e}},{key:"updateQuadVertexData",value:function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData(Si.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||Si.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}}},{key:"destroy",value:function(){for(var e,t,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(t=this._pipelineSceneData)||void 0===t||t.destroy(),he(ne(n.prototype),"destroy",this).call(this)}},{key:"_generateConstantMacros",value:function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE ".concat(this.device.hasFeature(Ti.TEXTURE_FLOAT)?1:0,"\n"),e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING ".concat(this._clusterEnabled?1:0,"\n"),e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS ".concat(this.device.capabilities.maxVertexUniformVectors,"\n"),e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS ".concat(this.device.capabilities.maxFragmentUniformVectors,"\n"),e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT ".concat(this.device.hasFeature(Ti.INPUT_ATTACHMENT_BENEFIT)?1:0,"\n"),e+="#define CC_PLATFORM_ANDROID_AND_WEBGL ".concat(Eu.os===du.ANDROID&&Eu.isBrowser?1:0,"\n"),e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES ".concat(St.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0,"\n"),this._constantMacros=e}},{key:"generateBloomRenderData",value:function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new vx,t=this.device,n=new Hr;n.format=Ei.RGBA8,n.loadOp=Vi.CLEAR,n.storeOp=ji.STORE,n.endAccesses=[Wi.COLOR_ATTACHMENT_WRITE],e.renderPass=t.createRenderPass(new qr([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new wr(Ii.TEX2D,Di.COLOR_ATTACHMENT|Di.SAMPLED,Ei.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Kr(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var a=0;a<6;++a)e.downsampleTexs.push(t.createTexture(new wr(Ii.TEX2D,Di.COLOR_ATTACHMENT|Di.SAMPLED,Ei.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[a]=t.createFramebuffer(new Kr(e.renderPass,[e.downsampleTexs[a]])),e.upsampleTexs.push(t.createTexture(new wr(Ii.TEX2D,Di.COLOR_ATTACHMENT|Di.SAMPLED,Ei.RGBA8,i,r))),e.upsampleFramebuffers[a]=t.createFramebuffer(new Kr(e.renderPass,[e.upsampleTexs[a]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new wr(Ii.TEX2D,Di.COLOR_ATTACHMENT|Di.SAMPLED,Ei.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Kr(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}}},{key:"on",value:function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)}},{key:"once",value:function(e,t,n){return this._eventProcessor.once(e,t,n)}},{key:"off",value:function(e,t,n){this._eventProcessor.off(e,t,n)}},{key:"emit",value:function(e,t,n,i,r,a){this._eventProcessor.emit(e,t,n,i,r,a)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e)}},{key:"removeAll",value:function(e){this._eventProcessor.removeAll(e)}},{key:"hasEventListener",value:function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)}}]),n}(Uu),ax=xe((rx=sx).prototype,"_tag",[ex,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ox=xe(rx.prototype,"_flows",[tx,nx,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ix=rx))||ix));c.RenderPipeline=yx,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(cx||(cx={})),function(e){e[e.FORWARD=10]="FORWARD"}(lx||(lx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(ux||(ux={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(hx||(hx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(_x||(_x={}));var xx=new Hr;xx.format=Ei.RGBA8,xx.beginAccesses=[Wi.FRAGMENT_SHADER_READ_TEXTURE],xx.endAccesses=[Wi.FRAGMENT_SHADER_READ_TEXTURE];var Sx=new Vr;Sx.format=Ei.DEPTH_STENCIL;var Tx,Ex,Cx,Ax,bx,wx,Rx,Px,Ix,Dx,Ox,Nx,Mx,kx,Lx,Bx,Fx,zx,Ux,Gx,Hx,Vx,jx,Wx,qx,Xx,Yx,Kx,Qx,Zx,Jx,$x,eS,tS,nS,iS,rS,aS,oS,sS,cS,lS,uS,hS,_S,fS,dS,pS,mS,vS,gS,yS,xS,SS,TS,ES,CS,AS,bS,wS,RS,PS,IS,DS,OS,NS,MS,kS,LS,BS,FS,zS,US,GS,HS,VS,jS,WS,qS,XS=new qr([xx],Sx),YS={width:1,height:1,renderPassInfo:XS},KS=e("RenderTexture",Cc("cc.RenderTexture")(fx=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._window=null,e}return Z(n,[{key:"window",get:function(){return this._window}},{key:"initialize",value:function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){if(this._window){var e=c.director.root;null==e||e.destroyWindow(this._window),this._window=null}return he(ne(n.prototype),"destroy",this).call(this)}},{key:"resize",value:function(e,t){this._width=Math.floor(gn(e,1,2048)),this._height=Math.floor(gn(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)}},{key:"_serialize",value:function(){return{}}},{key:"_deserialize",value:function(e,t){var i=e;this._width=i.w,this._height=i.h,this._name=i.n,he(ne(n.prototype),"_deserialize",this).call(this,i.base,t)}},{key:"getGFXTexture",value:function(){return this._window&&this._window.framebuffer.colorTextures[0]}},{key:"onLoaded",value:function(){this._initWindow()}},{key:"_initWindow",value:function(e){var t=c.director.root;YS.title=this._name,YS.width=this._width,YS.height=this._height,YS.renderPassInfo=e&&e.passInfo?e.passInfo:XS,this._window?(this._window.destroy(),this._window.initialize(t.device,YS)):this._window=t.createWindow(YS)}},{key:"initDefault",value:function(e){he(ne(n.prototype),"initDefault",this).call(this,e),this._width=this._height=1,this._initWindow()}},{key:"validate",value:function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048}},{key:"readPixels",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;n=n||this.width,i=i||this.height;var a=this.getGFXTexture();if(!a)return D(7606),null;var o=4*n*i;if(void 0===r)r=new Uint8Array(o);else if(r.length<o)return D(7607,o),null;var s=this._getGFXDevice(),c=[],l=[],u=new mr;return u.texOffset.x=e,u.texOffset.y=t,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(a,c,l),r}}]),n}(sv))||fx);c.RenderTexture=KS,yt(Ii),yt(Di),yt(ji),yt(Vi),yt(Wi),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(qS||(qS={})),yt(qS),Tx=Cc("RenderTextureDesc"),Ex=rl(Ii),Cx=rl(Di),Ax=rl(Ei),Tx((wx=xe((bx=function e(){K(this,e),ye(this,"name",wx,this),ye(this,"type",Rx,this),ye(this,"usage",Px,this),ye(this,"format",Ix,this),ye(this,"width",Dx,this),ye(this,"height",Ox,this)}).prototype,"name",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Rx=xe(bx.prototype,"type",[Ex],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ii.TEX2D}}),Px=xe(bx.prototype,"usage",[Cx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.COLOR_ATTACHMENT}}),Ix=xe(bx.prototype,"format",[Ax],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ei.UNKNOWN}}),Dx=xe(bx.prototype,"width",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ox=xe(bx.prototype,"height",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),bx));var QS,ZS=(Nx=Cc("RenderTextureConfig"),Mx=rl(KS),Nx((Bx=xe((Lx=function e(){K(this,e),ye(this,"name",Bx,this),ye(this,"texture",Fx,this)}).prototype,"name",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Fx=xe(Lx.prototype,"texture",[Mx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kx=Lx))||kx),JS=(zx=Cc("MaterialConfig"),Ux=rl(gg),zx((Hx=xe((Gx=function e(){K(this,e),ye(this,"name",Hx,this),ye(this,"material",Vx,this)}).prototype,"name",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Vx=xe(Gx.prototype,"material",[Ux],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gx)),jx=Cc("FrameBufferDesc"),Wx=rl([qt]),qx=rl(KS),jx((Yx=xe((Xx=function e(){K(this,e),ye(this,"name",Yx,this),ye(this,"renderPass",Kx,this),ye(this,"colorTextures",Qx,this),ye(this,"depthStencilTexture",Zx,this),ye(this,"texture",Jx,this)}).prototype,"name",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Kx=xe(Xx.prototype,"renderPass",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qx=xe(Xx.prototype,"colorTextures",[Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zx=xe(Xx.prototype,"depthStencilTexture",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Jx=xe(Xx.prototype,"texture",[qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xx)),$x=Cc("ColorDesc"),eS=rl(Ei),tS=rl(Vi),nS=rl(ji),iS=rl([Wi]),rS=rl([Wi]),$x((sS=xe((oS=function e(){K(this,e),ye(this,"format",sS,this),ye(this,"loadOp",cS,this),ye(this,"storeOp",lS,this),ye(this,"sampleCount",uS,this),ye(this,"beginAccesses",hS,this),ye(this,"endAccesses",_S,this)}).prototype,"format",[eS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ei.UNKNOWN}}),cS=xe(oS.prototype,"loadOp",[tS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vi.CLEAR}}),lS=xe(oS.prototype,"storeOp",[nS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ji.STORE}}),uS=xe(oS.prototype,"sampleCount",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),hS=xe(oS.prototype,"beginAccesses",[iS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_S=xe(oS.prototype,"endAccesses",[rS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Wi.COLOR_ATTACHMENT_WRITE]}}),aS=oS))||aS),$S=(fS=Cc("DepthStencilDesc"),dS=rl(Ei),pS=rl(Vi),mS=rl(ji),vS=rl(Vi),gS=rl(ji),yS=rl([Wi]),xS=rl([Wi]),fS((ES=xe((TS=function e(){K(this,e),ye(this,"format",ES,this),ye(this,"depthLoadOp",CS,this),ye(this,"depthStoreOp",AS,this),ye(this,"stencilLoadOp",bS,this),ye(this,"stencilStoreOp",wS,this),ye(this,"sampleCount",RS,this),ye(this,"beginAccesses",PS,this),ye(this,"endAccesses",IS,this)}).prototype,"format",[dS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ei.UNKNOWN}}),CS=xe(TS.prototype,"depthLoadOp",[pS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vi.CLEAR}}),AS=xe(TS.prototype,"depthStoreOp",[mS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ji.STORE}}),bS=xe(TS.prototype,"stencilLoadOp",[vS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vi.CLEAR}}),wS=xe(TS.prototype,"stencilStoreOp",[gS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ji.STORE}}),RS=xe(TS.prototype,"sampleCount",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),PS=xe(TS.prototype,"beginAccesses",[yS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IS=xe(TS.prototype,"endAccesses",[xS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Wi.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),SS=TS))||SS);DS=Cc("RenderPassDesc"),OS=rl([JS]),NS=rl($S),DS((kS=xe((MS=function e(){K(this,e),ye(this,"index",kS,this),ye(this,"colorAttachments",LS,this),ye(this,"depthStencilAttachment",BS,this)}).prototype,"index",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),LS=xe(MS.prototype,"colorAttachments",[OS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BS=xe(MS.prototype,"depthStencilAttachment",[NS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $S}}),MS)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(QS||(QS={})),yt(QS);var eT=(FS=Cc("RenderQueueDesc"),zS=rl(QS),US=rl([qt]),FS((VS=xe((HS=function e(){K(this,e),ye(this,"isTransparent",VS,this),ye(this,"sortMode",jS,this),ye(this,"stages",WS,this)}).prototype,"isTransparent",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jS=xe(HS.prototype,"sortMode",[zS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QS.FRONT_TO_BACK}}),WS=xe(HS.prototype,"stages",[US],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),GS=HS))||GS);function tT(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function nT(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var iT=function(){function e(t){K(this,e),this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new $l((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new eu(64,this._passDesc.sortFunc)}return Z(e,[{key:"clear",value:function(){this.queue.clear(),this._passPool.reset()}},{key:"insertRenderPass",value:function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],a=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var o=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=o,s.depth=e.depth||0,s.shaderId=a.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0}},{key:"sort",value:function(){this.queue.sort()}},{key:"recordCommandBuffer",value:function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],a=r.subModel,o=r.passIdx,s=a.inputAssembler,c=a.passes[o],l=a.shaders[o],u=Qv.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(np.MATERIAL,c.descriptorSet),n.bindDescriptorSet(np.LOCAL,a.descriptorSet),n.bindInputAssembler(s),n.draw(s)}}}]),e}();function rT(e){for(var t=0,n=0;n<e.stages.length;n++)t|=Hv(e.stages[n]);var i=tT;switch(e.sortMode){case QS.BACK_TO_FRONT:i=nT;break;case QS.FRONT_TO_BACK:i=tT}return new iT({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function aT(e){e.clear()}function oT(e){e.sort()}var sT=function(){function e(){K(this,e),this.queue=new Set}return Z(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"uploadBuffers",value:function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var a=0;a<r.vbs.length;++a)r.vbs[a].update(r.vbDatas[a]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}}},{key:"recordCommandBuffer",value:function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var a=!1,o=0;o<r.value.batches.length;++o){var s=r.value.batches[o];if(s.mergeCount){if(!a){var c=s.shader,l=Qv.getOrCreatePipelineState(e,s.pass,c,t,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(np.MATERIAL,s.pass.descriptorSet),a=!0}n.bindDescriptorSet(np.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}}}]),e}(),cT=function(){function e(){K(this,e),this.queue=new Set}return Z(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"uploadBuffers",value:function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()}},{key:"recordCommandBuffer",value:function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){var a=r.value,o=a.instances,s=a.pass;if(a.hasPendingModels){n.bindDescriptorSet(np.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<o.length;++l){var u=o[l];if(u.count){var h=u.shader,_=Qv.getOrCreatePipelineState(e,s,h,t,u.ia);c!==_&&(n.bindPipelineState(_),c=_),n.bindDescriptorSet(np.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}}}]),e}(),lT=function(){function e(){K(this,e),this._groundAlbedoHDR=new ci(.2,.2,.2,1),this._skyColorHDR=new ci(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new ci(.2,.2,.2,1),this._skyColorLDR=new ci(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}return Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(e){this._mipmapCount=e}},{key:"native",get:function(){return this._nativeObj}},{key:"initialize",value:function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){this._destroy()}}]),e}();lT.SUN_ILLUM=65e3,lT.SKY_ILLUM=2e4,c.Ambient=lT;var uT,hT=function(){function e(){K(this,e),this._enabled=!1,this._minPos=new zn(0,0,0),this._maxPos=new zn(0,0,0),this._depth=0}return Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}},{key:"initialize",value:function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){this._destroy()}}]),e}(),_T=new Jr(null),fT=function(){function e(){K(this,e),this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=qd.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}return Z(e,[{key:"_destroyDescriptorSet",value:function(){this._descriptorSet.destroy(),this._descriptorSet=null}},{key:"_destroyWorldBoundDescriptorSet",value:function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null}},{key:"_destroyInputAssembler",value:function(){this._inputAssembler.destroy(),this._inputAssembler=null}},{key:"_createDescriptorSet",value:function(e){this._descriptorSet=this._device.createDescriptorSet(e)}},{key:"_createWorldBoundDescriptorSet",value:function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)}},{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?D(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===Bv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),_T.layout=e[0].localSetLayout,this._createDescriptorSet(_T)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===Bv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"_setInputAssembler",value:function(e){this._inputAssembler=this._device.createInputAssembler(e)}},{key:"_setSubMesh",value:function(e){this._subMesh=e}},{key:"native",get:function(){return this._nativeObj}},{key:"_init",value:function(){}},{key:"initialize",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=c.director.root;this._device=i.device,_T.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(_T);var r=c.director.root.pipeline,a=r.pipelineSceneData.getOcclusionQueryPass(),o=new Jr(null);if(o.layout=a.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===Bv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=qd.DEFAULT,t[0].phase===Hv("reflection")){var s=i.mainWindow.width,l=i.mainWindow.height,u=512;l<s?(s=u*s/l,l=u):l=u*l/(s=u),this._reflectionTex=this._device.createTexture(new wr(Ii.TEX2D,Di.STORAGE|Di.TRANSFER_SRC|Di.SAMPLED,Ei.RGBA8,s,l)),this.descriptorSet.bindTexture(Qp,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new Pr(ki.LINEAR,ki.LINEAR,ki.NONE,Li.CLAMP,Li.CLAMP,Li.CLAMP)),this.descriptorSet.bindSampler(Qp,this._reflectionSampler),this.descriptorSet.bindTexture($p,this._reflectionTex)}}},{key:"_initNativePlanarShadowShader",value:function(e){this._planarShader=e.getPlanarShader(this._patches)}},{key:"initPlanarShadowShader",value:function(){var e=c.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)}},{key:"_initNativePlanarShadowInstanceShader",value:function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)}},{key:"initPlanarShadowInstanceShader",value:function(){var e=c.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=qd.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()}},{key:"update",value:function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()}},{key:"onPipelineStateChanged",value:function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}}},{key:"onMacroPatchesStateChanged",value:function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}},{key:"_flushPassInfo",value:function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}}}]),e}(),dT=new ei,pT=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(uT||(uT={}));var mT=new Pr(ki.LINEAR,ki.LINEAR,ki.NONE,Li.CLAMP,Li.CLAMP,Li.CLAMP),vT=new Pr(ki.LINEAR,ki.LINEAR,ki.LINEAR,Li.CLAMP,Li.CLAMP,Li.CLAMP),gT=function(){function e(){K(this,e),this.type=uT.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(Sp.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new ci,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=jd.Enum.NONE,this._device=c.director.root.device}return Z(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}},{key:"_setReceiveShadow",value:function(e){this._receiveShadow=e}},{key:"_init",value:function(){}},{key:"initialize",value:function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=jd.Enum.NONE,this._inited=!0)}},{key:"_destroySubmodel",value:function(e){e.destroy()}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()}},{key:"attachToScene",value:function(e){this.scene=e,this._localDataUpdated=!0}},{key:"detachFromScene",value:function(){this.scene=null}},{key:"updateTransform",value:function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}}},{key:"updateWorldBound",value:function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}}},{key:"_applyLocalData",value:function(){}},{key:"_applyLocalBuffer",value:function(){}},{key:"_applyWorldBoundBuffer",value:function(){}},{key:"updateUBOs",value:function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var a=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,a[r],a[r+1],a[r+2])}else if(this._localBuffer){ei.toArray(this._localData,i,Sp.MAT_WORLD_OFFSET),ei.inverseTranspose(dT,i);var o=Math.abs(ei.determinant(dT)),s=1/Math.sqrt(o);ei.multiplyScalar(dT,dT,s),ei.toArray(this._localData,dT,Sp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}}},{key:"_updateNativeBounds",value:function(){}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=tc.fromPoints(tc.create(),e,t),this._worldBounds=tc.clone(this._modelBounds),this._updateNativeBounds())}},{key:"_createSubModel",value:function(){return new fT}},{key:"initSubModel",value:function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)}},{key:"setSubModelMesh",value:function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)}},{key:"setSubModelMaterial",value:function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()}},{key:"onMacroPatchesStateChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))}},{key:"updateLightingmap",value:function(e,t){ci.toArray(this._localData,t,Sp.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=Gv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?vT:mT),r=this._subModels,a=0;a<r.length;a++){var o=r[a].descriptorSet;o.bindTexture(jp,n),o.bindSampler(jp,i),o.update()}}},{key:"getMacroPatches",value:function(){return this.receiveShadow?pT:null}},{key:"_updateAttributesAndBinding",value:function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}}},{key:"_getInstancedAttributeIndex",value:function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1}},{key:"_setInstMatWorldIdx",value:function(e){this._instMatWorldIdx=e}},{key:"_updateInstancedAttributes",value:function(e,t){if(t.device.hasFeature(Ti.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=la[r.format].size)}var a=this.instancedAttributes;a.buffer=new Uint8Array(n),a.views.length=a.attributes.length=0;for(var o=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new zr;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,a.attributes.push(l);var u=la[c.format],h=new(ga(u))(a.buffer.buffer,o,u.count);a.views.push(h),o+=u.size}}t.batchingScheme===Bv.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(Ep)),this._localDataUpdated=!0}}},{key:"_initLocalDescriptors",value:function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.DEVICE,Sp.SIZE,Sp.SIZE)),this._applyLocalBuffer())}},{key:"_initWorldBoundDescriptors",value:function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.DEVICE,Tp.SIZE,Tp.SIZE)),this._applyWorldBoundBuffer())}},{key:"_updateLocalDescriptors",value:function(e,t){this._localBuffer&&t.bindBuffer(Sp.BINDING,this._localBuffer)}},{key:"_updateWorldBoundDescriptors",value:function(e,t){this._worldBoundBuffer&&t.bindBuffer(Tp.BINDING,this._worldBoundBuffer)}}]),e}(),yT=function(){function e(t){K(this,e),this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}return Z(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}},{key:"initialize",value:function(e){return this._name=e.name,!0}},{key:"activate",value:function(){}},{key:"update",value:function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,a=0;a<r.length;a++)r[a].update();for(var o=this._models,s=0;s<o.length;s++){var c=o[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()}},{key:"addCamera",value:function(e){e.attachToScene(this),this._cameras.push(e)}},{key:"removeCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()}},{key:"removeCameras",value:function(){for(var e,t=ge(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)}},{key:"setMainLight",value:function(e){this._mainLight=e}},{key:"unsetMainLight",value:function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=fy.ROTATION));this.setMainLight(null)}}},{key:"addDirectionalLight",value:function(e){e.attachToScene(this),this._directionalLights.push(e)}},{key:"removeDirectionalLight",value:function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)}},{key:"addSphereLight",value:function(e){e.attachToScene(this),this._sphereLights.push(e)}},{key:"removeSphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)}},{key:"addSpotLight",value:function(e){e.attachToScene(this),this._spotLights.push(e)}},{key:"removeSpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)}},{key:"removeSphereLights",value:function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0}},{key:"removeSpotLights",value:function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]}},{key:"addModel",value:function(e){e.attachToScene(this),this._models.push(e)}},{key:"removeModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)}},{key:"removeModels",value:function(){for(var e,t=ge(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0}},{key:"addBatch",value:function(e){this._batches.push(e)}},{key:"removeBatch",value:function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)}},{key:"removeBatches",value:function(){this._batches.length=0}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e,t=ge(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"_createNativeObject",value:function(){}}],[{key:"registerCreateFunc",value:function(t){t._createSceneFun=function(t){return new e(t)}}}]),e}();z(yT.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),z(yT.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var xT={};z(xT,"CameraVisFlags",[{name:"GENERAL"}]),F(xT,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:jd.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:jd.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:jd.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:jd.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:jd.BitMask,targetName:"UI_2D"}]),c.CameraVisFlags=xT;var ST={};z(ST,"VisibilityFlags",[{name:"GENERAL"}]),F(ST,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:jd.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:jd.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:jd.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:jd.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:jd.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:jd.Enum,targetName:"UI_2D"}]),c.VisibilityFlags=ST,F(Kv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),z(wg.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),z(Og.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]);var TT=new zn(0,0,-1),ET=new zn,CT=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this))._dir=new zn(1,-1,-1),e._illuminanceHDR=lT.SUN_ILLUM,e._illuminanceLDR=1,e._type=dy.DIRECTIONAL,e}return Z(n,[{key:"direction",get:function(){return this._dir},set:function(e){zn.normalize(this._dir,e)}},{key:"illuminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}},{key:"initialize",value:function(){he(ne(n.prototype),"initialize",this).call(this),this.illuminance=lT.SUN_ILLUM,this.direction=new zn(1,-1,-1)}},{key:"update",value:function(){this._node&&this._node.hasChangedFlags&&(this.direction=zn.transformQuat(ET,TT,this._node.worldRotation))}}]),n}(Iy),AT=function(e){te(n,e);var t=le(n);function n(e,i){var r,a;K(this,n),(a=t.call(this,e.root))._parent=void 0,a._owner=void 0,a._dontNotify=!1,a._parent=e,a._owner=i,a._doInit(a._parent,!0);for(var o=0;o<a._shaderInfo.blocks.length;o++){var s=a._shaderInfo.blocks[o],c=a._blocks[s.binding],l=a._parent.blocks[s.binding];c.set(l)}a._setRootBufferDirty(!0);for(var u=a._parent,h=0;h<a._shaderInfo.samplerTextures.length;h++)for(var _=a._shaderInfo.samplerTextures[h],f=0;f<_.count;f++){var d=u._descriptorSet.getSampler(_.binding,f),p=u._descriptorSet.getTexture(_.binding,f);a._descriptorSet.bindSampler(_.binding,d,f),a._descriptorSet.bindTexture(_.binding,p,f)}return he((r=se(a),ne(n.prototype)),"tryCompile",r).call(r),a}return Z(n,[{key:"parent",get:function(){return this._parent}},{key:"overridePipelineStates",value:function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Kv.fillPipelineInfo(this,e),Kv.fillPipelineInfo(this,t),this._onStateChange()}},{key:"tryCompile",value:function(e){if(e&&!Tm(this._defines,e))return!1;var t=he(ne(n.prototype),"tryCompile",this).call(this);return this._onStateChange(),t}},{key:"beginChangeStatesSilently",value:function(){this._dontNotify=!0}},{key:"endChangeStatesSilently",value:function(){this._dontNotify=!1}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Bv.NONE)}},{key:"_onStateChange",value:function(){this._setHash(Kv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)}}]),n}(Kv),bT=function(e){te(n,e);var t=le(n);function n(e){var i;return K(this,n),(i=t.call(this))._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=e.parent,i._owner=e.owner||null,i._subModelIdx=e.subModelIdx||0,i.copy(i._parent),i}return Z(n,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}},{key:"recompileShaders",value:function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=ge(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],a=this._states[i]||(this._states[i]={});for(var o in e)a[o]=e[o];r.overridePipelineStates(n[r.passIndex],a)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}}},{key:"destroy",value:function(){return this._doDestroy(),!0}},{key:"onPassStateChange",value:function(e){this._hash=gg.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}},{key:"_createPasses",value:function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new AT(t[n],this));return e}}]),n}(gg),wT=null,RT=null,PT=function(){function e(){K(this,e),this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}return Z(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}},{key:"_setEnabled",value:function(e){this._enabled=e}},{key:"_setUseIBL",value:function(e){this._useIBL=e}},{key:"_setUseHDR",value:function(e){this._useHDR=e}},{key:"_setUseDiffuseMap",value:function(e){this._useDiffuseMap=e}},{key:"initialize",value:function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)}},{key:"setEnvMaps",value:function(e,t){this._envmapHDR=e,this._envmapLDR=t;var n=c.director.root;n.pipeline.pipelineSceneData.isHDR?e&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel):t&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()}},{key:"setDiffuseMaps",value:function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()}},{key:"activate",value:function(){var e=c.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=Gv.get("default-cube-texture"),this._model||(this._model=c.director.root.createModel(c.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!RT){var n=new gg;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),RT=new bT({parent:n})}this.enabled&&(wT||(wT=c.utils.createMesh(c.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,wT.renderingSubMeshes[0],RT)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()}},{key:"_updatePipeline",value:function(){var e=c.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===i&&t.macros.CC_USE_HDR===r||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=i,t.macros.CC_USE_HDR=r,e.onGlobalPipelineStateChanged()),this.enabled&&RT&&RT.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,RT)}},{key:"_updateGlobalBinding",value:function(){if(this._globalDSManager){var e=c.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),i=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(_p,i),this._globalDSManager.bindTexture(_p,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var a=r.getGFXTexture(),o=e.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(pp,o),this._globalDSManager.bindTexture(pp,a)}this._globalDSManager.update()}}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){this._destroy()}}]),e}();c.Skybox=PT;var IT=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this))._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=tc.create(),e._pos=new zn,e._type=dy.SPHERE,e}return Z(n,[{key:"_init",value:function(){he(ne(n.prototype),"_init",this).call(this)}},{key:"_destroy",value:function(){he(ne(n.prototype),"_destroy",this).call(this)}},{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}},{key:"initialize",value:function(){he(ne(n.prototype),"initialize",this).call(this),this.size=.15,this.range=1,this.luminance=1700/Py(.15),this.luminanceLDR=1}},{key:"update",value:function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;tc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}}}]),n}(Iy),DT=new zn(0,0,-1),OT=new qn,NT=new ei,MT=new ei,kT=new ei,LT=new ei,BT=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this))._dir=new zn(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._aspect=0,e._aabb=tc.create(),e._frustum=fc.create(),e._pos=new zn,e._type=dy.SPOT,e}return Z(n,[{key:"_init",value:function(){he(ne(n.prototype),"_init",this).call(this)}},{key:"_destroy",value:function(){he(ne(n.prototype),"_destroy",this).call(this)}},{key:"_setDirection",value:function(e){this._dir.set(e)}},{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"initialize",value:function(){he(ne(n.prototype),"initialize",this).call(this),this.size=.15,this.aspect=1,this.luminance=1700/Py(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new zn(1,-1,-1))}},{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),zn.transformQuat(this._dir,DT,this._node.getWorldRotation(OT)),zn.normalize(this._dir,this._dir),tc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(NT),ei.invert(NT,NT),ei.perspective(MT,this._angle,1,.001,this._range),ei.multiply(kT,MT,NT),this._frustum.update(kT,LT),this._needUpdate=!1)}}]),n}(Iy),FT=Object.freeze({__proto__:null,Ambient:lT,Octree:hT,get CameraFOVAxis(){return _g},get CameraProjection(){return fg},get CameraAperture(){return dg},get CameraISO(){return pg},get CameraShutter(){return mg},SKYBOX_FLAG:Ag,Camera:wg,CameraVisFlags:xT,VisibilityFlags:ST,DirectionalLight:CT,ColorTemperatureToRGB:gy,get LightType(){return dy},nt2lm:Py,Light:Iy,get ModelType(){return uT},Model:gT,ShadowSize:Rg,ShadowType:Pg,PCFType:Ig,Shadows:Og,RenderScene:yT,Skybox:PT,SphereLight:IT,SpotLight:BT,SubModel:fT,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null}),zT=new Jl((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),UT=new Float32Array(4),GT=[],HT=[],VT=new ei,jT=new ei;function WT(e,t){return!(!t.worldBounds||Ss.aabbWithAABB(t.worldBounds,e.aabb))}function qT(e,t){return!(!t.worldBounds||Ss.aabbWithAABB(t.worldBounds,e.aabb)&&Ss.aabbFrustum(t.worldBounds,e.frustum))}var XT=Hv("forward-add"),YT=[];function KT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,a=-1,o=0;o<r.length;o++)if(r[o].phase===XT){a=o,n=!0;break}t.push(a)}return n}var QT,ZT,JT,$T,eE,tE,nE,iE,rE,aE,oE,sE=function(){function e(t){K(this,e),this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(cp.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=t,this._device=t.device,this._instancedQueue=new cT,this._batchedQueue=new sT;var n=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Ap.SIZE/n)*n,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new Er(this._lightBuffer,0,Ap.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}return Z(e,[{key:"clear",value:function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}zT.freeArray(this._lightPasses),this._lightPasses.length=0}},{key:"destroy",value:function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(cp.BINDING).destroy(),r.getTexture(lp).destroy(),r.getTexture(gp).destroy(),r.destroy()),e.delete(i)}}},{key:"gatherLightPasses",value:function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var a=i[r].model,o=a.subModels;if(KT(o,YT)&&(HT.length=0,this._lightCulling(a,n),HT.length))for(var s=0;s<o.length;s++){var c=YT[s];if(!(c<0)){var l=o[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(Ap.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,a,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}}},{key:"recordCommandBuffer",value:function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var a=this._lightPasses[r],o=a.subModel,s=a.passIdx,c=a.dynamicOffsets,l=a.lights,u=o.passes[s],h=o.shaders[s],_=o.inputAssembler,f=Qv.getOrCreatePipelineState(e,u,h,t,_),d=u.descriptorSet,p=o.descriptorSet;n.bindPipelineState(f),n.bindDescriptorSet(np.MATERIAL,d),n.bindInputAssembler(_);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);GT[0]=c[m],n.bindDescriptorSet(np.GLOBAL,g),n.bindDescriptorSet(np.LOCAL,p,GT),n.draw(_)}}}},{key:"_lightCulling",value:function(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=!1;switch(i.type){case dy.SPHERE:r=WT(i,e);break;case dy.SPOT:r=qT(i,e)}r||HT.push(n)}}},{key:"_addRenderQueue",value:function(e,t,n,i){var r=e.batchingScheme;if(r===Bv.INSTANCING)for(var a=0;a<HT.length;a++){var o=HT[a],s=e.getInstancedBuffer(o);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*o,this._instancedQueue.queue.add(s)}else if(r===Bv.VB_MERGING)for(var c=0;c<HT.length;c++){var l=HT[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=zT.alloc();h.subModel=t,h.passIdx=i;for(var _=0;_<HT.length;_++){var f=HT[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}}},{key:"_updateLightDescriptorSet",value:function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,a=i.shadowFrameBufferMap,o=e.scene.mainLight,s=sm(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,d=void 0;switch(h.type){case dy.SPHERE:o&&(cy(r,o,this._shadowUBO),ly(r,this._shadowUBO)),this._shadowUBO[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Bn.toArray(this._shadowUBO,r.shadowColor,cp.SHADOW_COLOR_OFFSET);break;case dy.SPOT:if(o&&(cy(r,o,this._shadowUBO),ly(r,this._shadowUBO)),ei.invert(VT,h.node.getWorldMatrix()),ei.perspective(jT,h.angle,h.aspect,.001,h.range),f=jT.clone(),d=jT.clone().invert(),ei.multiply(jT,jT,VT),ei.toArray(this._shadowUBO,VT,cp.MAT_LIGHT_VIEW_OFFSET),ei.toArray(this._shadowUBO,jT,cp.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[cp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[cp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[cp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[cp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[cp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[cp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[cp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[cp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[cp.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[cp.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[cp.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[cp.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,Bn.toArray(this._shadowUBO,r.shadowColor,cp.SHADOW_COLOR_OFFSET),a.has(h)){var p,m=null===(p=a.get(h))||void 0===p?void 0:p.colorTextures[0];m&&_.bindTexture(gp,m)}}_.update(),t.updateBuffer(_.getBuffer(cp.BINDING),this._shadowUBO)}}}},{key:"_updateUBOs",value:function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,a=i.shadows,o=i.validPunctualLights;o.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=Pn(o.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new Er(this._lightBuffer,0,Ap.SIZE)));for(var s=0,c=0;s<o.length;s++,c+=this._lightBufferElementCount){var l=o[s];switch(l.type){case dy.SPHERE:if(zn.toArray(UT,l.position),UT[3]=0,this._lightBufferData.set(UT,c+Ap.LIGHT_POS_OFFSET),UT[0]=l.size,UT[1]=l.range,UT[2]=0,UT[3]=a.enabled&&a.type===Pg.ShadowMap?1:0,this._lightBufferData.set(UT,c+Ap.LIGHT_SIZE_RANGE_ANGLE_OFFSET),zn.toArray(UT,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;UT[0]*=u.x,UT[1]*=u.y,UT[2]*=u.z}UT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(UT,c+Ap.LIGHT_COLOR_OFFSET);break;case dy.SPOT:if(zn.toArray(UT,l.position),UT[3]=1,this._lightBufferData.set(UT,c+Ap.LIGHT_POS_OFFSET),UT[0]=l.size,UT[1]=l.range,UT[2]=l.spotAngle,UT[3]=a.enabled&&a.type===Pg.ShadowMap?1:0,this._lightBufferData.set(UT,c+Ap.LIGHT_SIZE_RANGE_ANGLE_OFFSET),zn.toArray(UT,l.direction),this._lightBufferData.set(UT,c+Ap.LIGHT_DIR_OFFSET),zn.toArray(UT,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;UT[0]*=h.x,UT[1]*=h.y,UT[2]*=h.z}UT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(UT,c+Ap.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)}}]),e}(),cE=new tc,lE=function(){function e(t){K(this,e),this._pendingModels=[],this._castModels=[],this._instancedQueue=new cT,this._pipeline=void 0,this._pipeline=t}return Z(e,[{key:"gatherShadowPasses",value:function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===Pg.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,a=e.frustum,o=0!=(e.visibility&jd.BitMask.DEFAULT);if(r.mainLight&&o){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(tc.transform(cE,_.worldBounds,i.matLight),Ss.aabbFrustum(cE,a)))if(_.isInstancingEnabled)for(var f=_.subModels,d=0;d<f.length;d++){var p=f[d];u.merge(p,_.instancedAttributes,0,p.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(t)}}}},{key:"recordCommandBuffer",value:function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Pg.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],a=r.descriptorSet;n.bindDescriptorSet(np.MATERIAL,a);for(var o=this._pendingModels.length,s=0;s<o;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=Qv.getOrCreatePipelineState(e,r,h,t,_);n.bindPipelineState(f),n.bindDescriptorSet(np.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}}}]),e}(),uE=function(){function e(){K(this,e),this._phaseID=Hv("default")}return Z(e,[{key:"activate",value:function(e){this._pipeline=e}},{key:"render",value:function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],a=e.scene.batches,o=0;o<a.length;o++){var s=a[o],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,d=Qv.getOrCreatePipelineState(i,h,_,t,f);r.bindPipelineState(d),r.bindDescriptorSet(np.MATERIAL,h.descriptorSet);var p=s.descriptorSet;r.bindDescriptorSet(np.LOCAL,p),r.bindInputAssembler(f),r.draw(f)}}}}}]),e}(),hE=[new gr(0,0,0,1)],_E=e("ForwardStage",(QT=Cc("ForwardStage"),ZT=rl([eT]),JT=Zc(),QT((iE=nE=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"renderQueues",tE,se(e)),e._renderQueues=[],e._renderArea=new ur,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Hv("default"),e._clearFlag=4294967295,e._batchedQueue=new sT,e._instancedQueue=new cT,e._uiPhase=new uE,e}return Z(n,[{key:"initialize",value:function(e){return he(ne(n.prototype),"initialize",this).call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e,t){he(ne(n.prototype),"activate",this).call(this,e,t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=rT(this.renderQueues[i]);this._additiveLightQueue=new sE(this._pipeline),this._planarQueue=new lE(this._pipeline),this._uiPhase.activate(e)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(aT);for(var i=t.pipelineSceneData.renderObjects,r=0,a=0,o=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(a=0;a<h.length;++a){var _=h[a];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Bv.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,a),this._instancedQueue.queue.add(d)}else if(f===Bv.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,a,c.model),this._batchedQueue.queue.add(p)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(c,r,a)}}}}this._renderQueues.forEach(oT);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&rr.COLOR&&(hE[0].x=e.clearColor.x,hE[0].y=e.clearColor.y,hE[0].z=e.clearColor.z,hE[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.framebuffer,g=t.getRenderPass(e.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,hE,e.clearDepth,e.clearStencil),m.bindDescriptorSet(np.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(np.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._uiPhase.render(e,g),hg(n,g,m,t.profiler,e),m.endRenderPass()}}]),n}(Qy),nE.initInfo={name:"ForwardStage",priority:lx.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:QS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:QS.BACK_TO_FRONT,stages:["default","planarShadow"]}]},tE=xe((eE=iE).prototype,"renderQueues",[ZT,Ic,JT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$T=eE))||$T)),fE=e("ForwardFlow",Cc("ForwardFlow")((oE=aE=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"initialize",value:function(e){if(he(ne(n.prototype),"initialize",this).call(this,e),0===this._stages.length){var t=new _E;t.initialize(_E.initInfo),this._stages.push(t)}return!0}},{key:"activate",value:function(e){he(ne(n.prototype),"activate",this).call(this,e)}},{key:"render",value:function(e){he(ne(n.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){he(ne(n.prototype),"destroy",this).call(this)}}]),n}(Jy),aE.initInfo={name:Yd,priority:ux.FORWARD,stages:[]},rE=oE))||rE),dE=new ei,pE=new ei,mE=new ei,vE=new tc,gE=Hv("shadow-caster"),yE=[];function xE(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,a=-1,o=0;o<r.length;o++)if(r[o].phase===gE){a=o,n=!0;break}t.push(a)}return n}var SE,TE,EE,CE,AE,bE,wE=function(){function e(t){K(this,e),this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new cT,this._batchedQueue=new sT}return Z(e,[{key:"gatherLightPasses",value:function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,a=r.shadows;if(n&&a.enabled&&a.type===Pg.ShadowMap){var o=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case dy.DIRECTIONAL:for(var c=0;c<o.length;c++){var l=o[c].model;xE(l.subModels,yE)&&this.add(l,yE)}break;case dy.SPOT:ei.invert(dE,n.node.getWorldMatrix()),ei.perspective(pE,n.angle,n.aspect,.001,n.range),ei.multiply(mE,pE,dE);for(var u=0;u<s.length;u++){var h=s[u].model;xE(h.subModels,yE)&&(h.worldBounds&&(tc.transform(vE,h.worldBounds,mE),!Ss.aabbFrustum(vE,t.frustum))||this.add(h,yE))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}}},{key:"clear",value:function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()}},{key:"add",value:function(e,t){for(var n=e.subModels,i=0;i<n.length;i++){var r=n[i],a=t[i],o=r.passes[a];if(o.batchingScheme===Bv.INSTANCING){var s=o.getInstancedBuffer();s.merge(r,e.instancedAttributes,a),this._instancedQueue.queue.add(s)}else if(o.batchingScheme===Bv.VB_MERGING){var c=o.getBatchedBuffer();c.merge(r,a,e),this._batchedQueue.queue.add(c)}else{var l=r.shaders[a];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(o)}}}},{key:"recordCommandBuffer",value:function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],a=this._shaderArray[i],o=this._passArray[i],s=r.inputAssembler,c=Qv.getOrCreatePipelineState(e,o,a,t,s),l=o.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(np.MATERIAL,l),n.bindDescriptorSet(np.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}}}]),e}(),RE=[new gr(1,1,1,1)],PE=e("ShadowStage",Cc("ShadowStage")((EE=TE=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._shadowFrameBuffer=null,e._renderArea=new ur,e._light=null,e._globalDS=null,e}return Z(n,[{key:"setUsage",value:function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n}},{key:"destroy",value:function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()}},{key:"clearFramebuffer",value:function(e){if(this._light&&this._shadowFrameBuffer){RE[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,RE,e.clearDepth,e.clearStencil),t.endRenderPass()}}},{key:"render",value:function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,a=this._globalDS,o=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(a,this._light),this._additiveShadowQueue.gatherLightPasses(a,e,this._light,o);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;o.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,RE,e.clearDepth,e.clearStencil),o.bindDescriptorSet(np.GLOBAL,a),this._additiveShadowQueue.recordCommandBuffer(l,u,o),o.endRenderPass()}}},{key:"activate",value:function(e,t){he(ne(n.prototype),"activate",this).call(this,e,t),this._additiveShadowQueue=new wE(e)}}]),n}(Qy),TE.initInfo={name:"ShadowStage",priority:lx.FORWARD,tag:0},SE=EE))||SE),IE=[],DE=e("ShadowFlow",Cc("ShadowFlow")((bE=AE=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._shadowRenderPass=null,e}return Z(n,[{key:"initialize",value:function(e){if(he(ne(n.prototype),"initialize",this).call(this,e),0===this._stages.length){var t=new PE;t.initialize(PE.initInfo),this._stages.push(t)}return!0}},{key:"render",value:function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,a=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===Pg.ShadowMap){for(var o=0,s=0;o<n.maxReceived&&s<a.length;){var c=a[s];c.type===dy.SPOT&&(IE.push(c),o++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(e)}}for(var d=0;d<IE.length;d++){var p=IE[d],m=t.globalDSManager.getOrCreateDescriptorSet(d);i.has(p)||this._initShadowFrameBuffer(t,p,e.window.swapchain);for(var v=i.get(p),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,p,v),y.render(e)}}IE.length=0}else this.clearShadowMap(IE,e)}}},{key:"destroy",value:function(){if(he(ne(n.prototype),"destroy",this).call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,t=Array.from(e.values()),i=0;i<t.length;i++){var r=t[i];if(r){for(var a=r.colorTextures,o=0;o<a.length;o++){var s=a[i];s&&s.destroy()}a.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()}},{key:"_initShadowFrameBuffer",value:function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,a=sm(n)?Ei.R32F:Ei.RGBA8;if(!this._shadowRenderPass){var o=new Hr;o.format=a,o.loadOp=Vi.CLEAR,o.storeOp=ji.STORE,o.sampleCount=1;var s=new Vr;s.format=Ei.DEPTH_STENCIL,s.depthLoadOp=Vi.CLEAR,s.depthStoreOp=ji.DISCARD,s.stencilLoadOp=Vi.CLEAR,s.stencilStoreOp=ji.DISCARD,s.sampleCount=1;var c=new qr([o],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new wr(Ii.TEX2D,Di.COLOR_ATTACHMENT|Di.SAMPLED,a,i.x,i.y)));var u=n.createTexture(new wr(Ii.TEX2D,Di.DEPTH_STENCIL_ATTACHMENT,Ei.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new Kr(this._shadowRenderPass,l,u));r.set(t,h)}},{key:"clearShadowMap",value:function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var a=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var o=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(a,r,o),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var d=this._stages[f];d.setUsage(_,u,h),d.clearFramebuffer(t)}}}},{key:"resizeShadowMap",value:function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,a=sm(i)?Ei.R32F:Ei.RGBA8,o=r.values(),s=o.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new wr(Ii.TEX2D,Di.COLOR_ATTACHMENT|Di.SAMPLED,a,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new Kr(h,l,u)),s=o.next()}else s=o.next()}e.shadowMapDirty=!1}}]),n}(Jy),AE.initInfo={name:Kd,priority:ux.SHADOW,tag:qS.SCENE,stages:[]},CE=bE))||CE),OE=new ci,NE=mt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),ME=NE.LAYERED+1,kE=function(){function e(){K(this,e),this._fogColor=new Bn("#C8C8C8"),this._colorArray=new ci(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}return Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=ME,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),OE.set(e.x,e.y,e.z,e.w),$v(this._colorArray,OE)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}},{key:"_setType",value:function(e){this._type=this.enabled?e:ME}},{key:"_setEnable",value:function(e){this._enabled=e}},{key:"_setAccurate",value:function(e){this._accurate=e}},{key:"initialize",value:function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange}},{key:"activate",value:function(){this._updatePipeline()}},{key:"_updatePipeline",value:function(){var e=c.director.root,t=this.enabled?this.type:ME,n=this.accurate?1:0,i=e.pipeline;i.macros.CC_USE_FOG===t&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=t,i.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())}},{key:"_destroy",value:function(){}},{key:"destroy",value:function(){this._destroy()}}]),e}();function LE(e,t){for(var n,i=ge(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?LE(e,r):e.push(r)}}function BE(e){var t=[];return LE(t,e),t.join("")}c.Fog=kE;var FE=Tl.Flags.Destroyed,zE=Tl.Flags.PersistentMask,UE="".concat(Lt,"default"),GE=un.IDENTIFIER_RE,HE="var ",VE="o",jE={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},WE=un.escapeForJS,qE=function(){function e(t,n){K(this,e),this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=n}return Z(e,[{key:"toString",value:function(){return"".concat(HE+this.varName,"=").concat(this.expression,";")}}]),e}();function XE(e,t){return t instanceof qE?new qE(t.varName,e+t.expression):e+t}function YE(e,t,n){Array.isArray(n)?(n[0]=XE(t,n[0]),e.push(n)):e.push("".concat(XE(t,n),";"))}var KE=function(){function e(t){K(this,e),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}return Z(e,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(this._exps.length>1)e.push("".concat("t","=").concat(this._targetExp,";")),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];YE(e,"".concat(t+QE(i[0]),"="),i[1])}}}]),e}();function QE(e){return GE.test(e)?".".concat(e):"[".concat(WE(e),"]")}KE.pool=void 0,KE.pool=new _t((function(e){e._exps.length=0,e._targetExp=null}),1),KE.pool.get=function(e){var t=this._get()||new KE;return t._targetExp=e,t};var ZE=function(){function e(t,n){var i;K(this,e),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=n,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ze(),Qe(this.funcModuleCache,jE),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("".concat("var o",",").concat("t",";"),"if(R){","".concat(VE,"=R;"),"}else{","".concat(VE,"=R=new ").concat(this.getFuncModule(t.constructor,!0),"();"),"}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(i="".concat(HE+this.globalVariables.join(","),";"));var r=BE(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",r)(this.objs,this.funcs);for(var a=0,o=this.objsToClear_iN$t.length;a<o;++a)this.objsToClear_iN$t[a]._iN$t=null;this.objsToClear_iN$t.length=0}return Z(e,[{key:"getFuncModule",value:function(e,t){var n=Ue(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return ".concat(n))())return this.funcModuleCache[n]=n,n}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var o="F[".concat(a,"]");return t&&(o="(".concat(o,")")),this.funcModuleCache[n]=o,o}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O[".concat(t,"]")}},{key:"setValueType",value:function(e,t,n,i){var r=KE.pool.get(i),a=t.constructor.__props__;a||(a=Object.keys(t));for(var o=0;o<a.length;o++){var s=a[o],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),KE.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,n){for(var i=n.__values__,r=Ut(n),a=0;a<i.length;a++){var o=i[a],s=t[o],l=r[o+UE];if(!JE(l,s))if("object"===Y(s)&&s instanceof c.ValueType&&(l=un.getDefault(l))&&l.constructor===s.constructor){var u=VE+QE(o);this.setValueType(e,l,s,u)}else this.setObjProp(e,t,o,s)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new qE(t,"new Array(".concat(e.length,")"))];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)YE(n,"".concat(t,"[").concat(i,"]="),this.enumerateField(e,i,e[i]));return n}},{key:"instantiateTypedArray",value:function(e){var t=e.constructor.name;if(0===e.length)return"new ".concat(t);var n="a"+ ++this.localVariableId,i=[new qE(n,"new ".concat(t,"(").concat(e.length,")"))];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&YE(i,"".concat(n,"[").concat(r,"]="),e[r]);return i}},{key:"enumerateField",value:function(e,t,n){if("object"===Y(n)&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v".concat(++this.globalVariableId),this.globalVariables.push(r);var a=i.source[0];i.source[0]=XE("".concat(r,"="),a)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?WE(n):("_objFlags"===t&&e instanceof Tl&&(n&=zE),n)}},{key:"setObjProp",value:function(e,t,n,i){YE(e,"".concat(VE+QE(n),"="),this.enumerateField(t,n,i))}},{key:"enumerateObject",value:function(e,t){var n=t.constructor;if(c.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=t[i];"object"===Y(r)&&r&&r===t._iN$t||this.setObjProp(e,t,i,r)}}},{key:"instantiateObj",value:function(e){if(e instanceof c.ValueType)return un.getNewValueTypeCode(e);if(e instanceof c.Asset)return this.getObjRef(e);if(e._objFlags&FE)return null;var t,n=e.constructor;if(c.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof c.Component){if(e instanceof c._BaseNode||e instanceof c.Component)return this.getObjRef(e)}else if(this.parent instanceof c._BaseNode)if(e instanceof c._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof c.Component){var i;if(!(null===(i=e.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(e)}t=new qE(VE,"new ".concat(this.getFuncModule(n,!0),"()"))}else if(n===Object)t=new qE(VE,"{}");else{if(n)return this.getObjRef(e);t=new qE(VE,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]}}]),e}();function JE(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"===Y(e)&&"object"===Y(t)&&e.constructor===t.constructor)if(e instanceof c.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return Ne(e)&&Ne(t)}return!1}var $E,eC,tC,nC,iC,rC,aC,oC,sC,cC,lC=function(){function e(t){K(this,e),this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}return Z(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?P(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}},{key:"applyOpacity",value:function(e){this._opacity=this._localOpacity*e}}],[{key:"markOpacityTree",value:function(){}}]),e}();Tl.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}($E||($E={}));var uC=Tl.Flags.Destroying,hC=Tl.Flags.DontDestroy,_C=Tl.Flags.Deactivating,fC=new we("Node");function dC(e){return e?"string"==typeof e?ut(e):e:(D(3804),null)}var pC,mC,vC,gC,yC,xC,SC,TC,EC,CC,AC,bC=e("BaseNode",Cc("cc.BaseNode")((cC=sC=function(e){te(n,e);var t=le(n);function n(e){var i;return K(this,n),ye(i=t.call(this,e),"_parent",nC,se(i)),ye(i,"_children",iC,se(i)),ye(i,"_active",rC,se(i)),ye(i,"_components",aC,se(i)),ye(i,"_prefab",oC,se(i)),i._scene=null,i._activeInHierarchy=!1,i._id=fC.getNewId(),i._name=void 0,i._eventProcessor=new c.NodeEventProcessor(se(i)),i._eventMask=0,i._siblingIndex=0,i._originalSceneId="",i._registerIfAttached=void 0,i._name=void 0!==e?e:"New Node",i}return Z(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&hC)>0},set:function(e){e?this._objFlags|=hC:this._objFlags&=~hC}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&c.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}},{key:"_updateScene",value:function(){null==this._parent?x("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene}},{key:"attr",value:function(e){Qe(this,e)}},{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit($E.PARENT_CHANGED,n),n&&!(n._objFlags&uC)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit($E.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit($E.CHILD_ADDED,this)),this._onHierarchyChanged(n)}}},{key:"getChildByUuid",value:function(e){if(!e)return g("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null}},{key:"getChildByName",value:function(e){if(!e)return g("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null}},{key:"getChildByPath",value:function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var a=i(r);if("continue"!==a&&"object"===Y(a))return a.v}return n}},{key:"addChild",value:function(e){e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&_C)D(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,t){var i=1,r=null,a=null,o=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(a=s[--i])if(!l&&e?e(a):l&&t&&t(a),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++o])s[i]=r[o],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(o=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),o<0))break}else a._children.length>0?(c=a,r=a._children,o=0,s[i]=r[o],i++):(s[i]=a,i++,l=!0);s.length=0,n._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){this._children.indexOf(e)>-1&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=dC(e);return t?n._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=dC(e),i=[];return t&&n._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=dC(e);return t?n._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=dC(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=ut(e)))throw c._RF.peek()&&D(3808,e),TypeError(k(3807,e))}else{if(!e)throw TypeError(k(3804));t=e}if("function"!=typeof t)throw TypeError(k(3809));if(!$e(t,c.Component))throw TypeError(k(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var a=n;this.getComponent(a)||this.addComponent(a)}var o=new t;return o.node=this,this._components.push(o),this._activeInHierarchy&&c.director._nodeActivator.activateComp(o),o}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof sh?e:this.getComponent(e))&&t.destroy()}else D(3813)}},{key:"on",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(e){case $E.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)}},{key:"off",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this._eventProcessor.off(e,t,n,i);var r=this._eventProcessor.hasEventListener(e);if(!r)switch(e){case $E.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,n,i){this._eventProcessor.once(e,t,n,i)}},{key:"emit",value:function(e,t,n,i,r,a){this._eventProcessor.emit(e,t,n,i,r,a)}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener($E.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"destroy",value:function(){return!!he(ne(n.prototype),"destroy",this).call(this)&&(this.active=!1,!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&uC)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&D(3815)}}else D(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit($E.SIBLING_ORDER_CHANGED)}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))}},{key:"_onPostActivated",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e,t){return e||(e=c.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e}},{key:"_onHierarchyChangedBase",value:function(){var e=this._parent;!this._persistNode||e instanceof c.Scene||c.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&c.director._nodeActivator.activateNode(this,t)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=uC;var e=this._parent,t=!!e&&0!=(e._objFlags&uC);if(this._persistNode&&c.game.removePersistRootNode(this),!t&&e){this.emit($E.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit($E.CHILD_REMOVED,this)}this.emit($E.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var a=this._components,o=0;o<a.length;++o)a[o]._destroyImmediate();return t}}],[{key:"_setScene",value:function(e){e._updateScene()}},{key:"_findComponent",value:function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var a=i[r];if(a.constructor===t)return a}else for(var o=0;o<i.length;++o){var s=i[o];if(s instanceof t)return s}return null}},{key:"_findComponents",value:function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var a=0;a<r.length;++a){var o=r[a];o.constructor===t&&n.push(o)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}}},{key:"_findChildComponent",value:function(e,t){for(var i=0;i<e.length;++i){var r=e[i],a=n._findComponent(r,t);if(a)return a;if(r._children.length>0&&(a=n._findChildComponent(r._children,t)))return a}return null}},{key:"_findChildComponents",value:function(e,t,i){for(var r=0;r<e.length;++r){var a=e[r];n._findComponents(a,t,i),a._children.length>0&&n._findChildComponents(a._children,t,i)}}}]),n}(Tl),sC.idGenerator=fC,sC._stacks=[[]],sC._stackId=0,xe((tC=cC).prototype,"_persistNode",[Rc],Object.getOwnPropertyDescriptor(tC.prototype,"_persistNode"),tC.prototype),xe(tC.prototype,"name",[Gc],Object.getOwnPropertyDescriptor(tC.prototype,"name"),tC.prototype),xe(tC.prototype,"children",[Gc],Object.getOwnPropertyDescriptor(tC.prototype,"children"),tC.prototype),xe(tC.prototype,"active",[Gc],Object.getOwnPropertyDescriptor(tC.prototype,"active"),tC.prototype),xe(tC.prototype,"activeInHierarchy",[Gc],Object.getOwnPropertyDescriptor(tC.prototype,"activeInHierarchy"),tC.prototype),xe(tC.prototype,"parent",[Gc],Object.getOwnPropertyDescriptor(tC.prototype,"parent"),tC.prototype),nC=xe(tC.prototype,"_parent",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iC=xe(tC.prototype,"_children",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rC=xe(tC.prototype,"_active",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),aC=xe(tC.prototype,"_components",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oC=xe(tC.prototype,"_prefab",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eC=tC))||eC);c._BaseNode=bC;var wC=new zn,RC=new qn,PC=new qn,IC=new qn,DC=new Vn,OC=new Vn,NC=new ei,MC=[],kC=[],LC=[],BC=function(){function e(){K(this,e),this._chunks=[],this._freelists=[],this._createChunk()}return Z(e,[{key:"alloc",value:function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)}},{key:"free",value:function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)}},{key:"clear",value:function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)}},{key:"_createChunk",value:function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)}},{key:"_createView",value:function(e){return LC[0]=this._chunks[e],LC[1]=this._freelists[e].pop(),LC}}]),e}();BC.CAPACITY_PER_CHUNK=256;var FC,zC,UC,GC,HC,VC,jC,WC,qC,XC,YC,KC,QC,ZC,JC,$C,eA,tA,nA,iA,rA,aA,oA,sA,cA,lA,uA,hA,_A,fA,dA,pA,mA,vA,gA,yA,xA,SA,TA,EA,CA,AA,bA,wA,RA,PA,IA,DA,OA,NA,MA,kA,LA,BA,FA,zA,UA,GA,HA,VA,jA,WA,qA,XA,YA,KA,QA,ZA,JA,$A=new BC,eb=Symbol("ReserveContentsForAllSyncablePrefab"),tb=e("Node",(pC=Cc("cc.Node"),mC=rl(zn),pC((AC=CC=function(e){te(n,e);var t=le(n);function n(e){var i;return K(this,n),(i=t.call(this,e))._uiProps=new lC(se(i)),i._static=!1,ye(i,"_lpos",yC,se(i)),ye(i,"_lrot",xC,se(i)),ye(i,"_lscale",SC,se(i)),ye(i,"_layer",TC,se(i)),ye(i,"_euler",EC,se(i)),i._dirtyFlagsPri=fy.NONE,i._eulerDirty=!1,i._nodeHandle=0,i._init(),i}return Z(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"_init",value:function(){var e=de($A.alloc(),2),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new zn,this._rot=new qn,this._scale=new zn(1,1,1),this._mat=new ei}},{key:"_onPreDestroy",value:function(){var e=this._onPreDestroyBase();return $A.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(qn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){zn.set(this._euler,0,0,e),qn.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(fy.ROTATION),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){ei.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(fy.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return zn.transformQuat(new zn,zn.FORWARD,this.worldRotation)},set:function(e){var t=e.length();zn.multiplyScalar(wC,e,-1/t),qn.fromViewUp(RC,wC),this.setWorldRotation(RC)}},{key:"up",get:function(){return zn.transformQuat(new zn,zn.UP,this.worldRotation)}},{key:"right",get:function(){return zn.transformQuat(new zn,zn.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit($E.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}},{key:gh,value:function(e){e.writeThis()}},{key:"setParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t&&this.updateWorldTransform(),he(ne(n.prototype),"setParent",this).call(this,e,t)}},{key:"_onSetParent",value:function(e,t){if(he(ne(n.prototype),"_onSetParent",this).call(this,e,t),t){var i=this._parent;i?(i.updateWorldTransform(),ei.multiply(NC,ei.invert(NC,i._mat),this._mat),ei.toRTS(NC,this._lrot,this._lpos,this._lscale)):(zn.copy(this._lpos,this._pos),qn.copy(this._lrot,this._rot),zn.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(fy.TRS)}},{key:"_onHierarchyChanged",value:function(e){this.eventProcessor.reattach(),he(ne(n.prototype),"_onHierarchyChangedBase",this).call(this,e)}},{key:"_onBatchCreated",value:function(e){this.hasChangedFlags=fy.TRS,this._dirtyFlags|=fy.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"_onPostActivated",value:function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(fy.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)}},{key:"translate",value:function(e,t){var n=t||_y.LOCAL;if(n===_y.LOCAL)zn.transformQuat(wC,e,this._lrot),this._lpos.x+=wC.x,this._lpos.y+=wC.y,this._lpos.z+=wC.z;else if(n===_y.WORLD)if(this._parent){qn.invert(RC,this._parent.worldRotation),zn.transformQuat(wC,e,RC);var i=this.worldScale;this._lpos.x+=wC.x/i.x,this._lpos.y+=wC.y/i.y,this._lpos.z+=wC.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(fy.POSITION),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.POSITION)}},{key:"rotate",value:function(e,t){var n=t||_y.LOCAL;if(qn.normalize(RC,e),n===_y.LOCAL)qn.multiply(this._lrot,this._lrot,RC);else if(n===_y.WORLD){var i=this.worldRotation;qn.multiply(PC,RC,i),qn.invert(RC,i),qn.multiply(PC,RC,PC),qn.multiply(this._lrot,this._lrot,PC)}this._eulerDirty=!0,this.invalidateChildren(fy.ROTATION),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.ROTATION)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(wC),zn.subtract(wC,wC,e),zn.normalize(wC,wC),qn.fromViewUp(RC,wC,t),this.setWorldRotation(RC)}},{key:"_setDirtyNode",value:function(e,t){MC[e]=t}},{key:"invalidateChildren",value:function(e){var t,n,i,r=0,a=0,o=0,s=0,c=0,l=e|fy.POSITION;for(MC[0]=this;r>=0;){if(c=(t=MC[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,o=(i=t._children).length,a=0;a<o;a++)n=i[a],MC[++r]=n;e=l}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=MC[--n])._dirtyFlags,t?(i&fy.POSITION&&(zn.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&fy.RS&&(ei.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),ei.multiply(e._mat,t._mat,e._mat),i&fy.ROTATION&&qn.multiply(e._rot,t._rot,e._lrot),Vn.fromQuat(DC,qn.conjugate(IC,e._rot)),Vn.multiplyMat4(DC,DC,e._mat),e._scale.x=DC.m00,e._scale.y=DC.m04,e._scale.z=DC.m08)):(i&fy.POSITION&&(zn.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&fy.RS&&(i&fy.ROTATION&&qn.copy(e._rot,e._lrot),i&fy.SCALE&&(zn.copy(e._scale,e._lscale),ei.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=fy.NONE,t=e}}},{key:"setPosition",value:function(e,t,n){void 0===t&&void 0===n?zn.copy(this._lpos,e):void 0===n?zn.set(this._lpos,e,t,this._lpos.z):zn.set(this._lpos,e,t,n),this.invalidateChildren(fy.POSITION),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.POSITION)}},{key:"getPosition",value:function(e){return e?zn.set(e,this._lpos.x,this._lpos.y,this._lpos.z):zn.copy(new zn,this._lpos)}},{key:"setRotation",value:function(e,t,n,i){void 0===t||void 0===n||void 0===i?qn.copy(this._lrot,e):qn.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(fy.ROTATION),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.ROTATION)}},{key:"setRotationFromEuler",value:function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(zn.copy(this._euler,e),qn.fromEuler(this._lrot,e.x,e.y,e.z)):(zn.set(this._euler,e,t,i),qn.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(fy.ROTATION),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.ROTATION)}},{key:"getRotation",value:function(e){return e?qn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):qn.copy(new qn,this._lrot)}},{key:"setScale",value:function(e,t,n){void 0===t&&void 0===n?zn.copy(this._lscale,e):void 0===n?zn.set(this._lscale,e,t,this._lscale.z):zn.set(this._lscale,e,t,n),this.invalidateChildren(fy.SCALE),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.SCALE)}},{key:"getScale",value:function(e){return e?zn.set(e,this._lscale.x,this._lscale.y,this._lscale.z):zn.copy(new zn,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){zn.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)zn.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=MC[--i];return e}},{key:"setWorldPosition",value:function(e,t,n){void 0===t||void 0===n?zn.copy(this._pos,e):zn.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),zn.transformMat4(r,this._pos,ei.invert(NC,i._mat))):zn.copy(r,this._pos),this.invalidateChildren(fy.POSITION),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.POSITION)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?zn.copy(e,this._pos):zn.copy(new zn,this._pos)}},{key:"setWorldRotation",value:function(e,t,n,i){void 0===t||void 0===n||void 0===i?qn.copy(this._rot,e):qn.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),qn.multiply(this._lrot,qn.conjugate(this._lrot,this._parent._rot),this._rot)):qn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(fy.ROTATION),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.ROTATION)}},{key:"setWorldRotationFromEuler",value:function(e,t,n){qn.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),qn.multiply(this._lrot,qn.conjugate(this._lrot,this._parent._rot),this._rot)):qn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(fy.ROTATION),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.ROTATION)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?qn.copy(e,this._rot):qn.copy(new qn,this._rot)}},{key:"setWorldScale",value:function(e,t,n){void 0===t||void 0===n?zn.copy(this._scale,e):zn.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),Vn.fromQuat(DC,qn.conjugate(IC,i._rot)),Vn.multiplyMat4(DC,DC,i._mat),OC.m00=this._scale.x,OC.m04=this._scale.y,OC.m08=this._scale.z,Vn.multiply(DC,OC,Vn.invert(DC,DC)),this._lscale.x=zn.set(wC,DC.m00,DC.m01,DC.m02).length(),this._lscale.y=zn.set(wC,DC.m03,DC.m04,DC.m05).length(),this._lscale.z=zn.set(wC,DC.m06,DC.m07,DC.m08).length()):zn.copy(this._lscale,this._scale),this.invalidateChildren(fy.SCALE),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,fy.SCALE)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?zn.copy(e,this._scale):zn.copy(new zn,this._scale)}},{key:"getWorldMatrix",value:function(e){this.updateWorldTransform();var t=e||new ei;return ei.copy(t,this._mat)}},{key:"getWorldRS",value:function(e){this.updateWorldTransform();var t=e||new ei;return ei.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t}},{key:"getWorldRT",value:function(e){this.updateWorldTransform();var t=e||new ei;return ei.fromRT(t,this._rot,this._pos)}},{key:"setRTS",value:function(e,t,n){var i=0;e&&(i|=fy.ROTATION,void 0!==e.w?(qn.copy(this._lrot,e),this._eulerDirty=!0):(zn.copy(this._euler,e),qn.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(zn.copy(this._lpos,t),i|=fy.POSITION),n&&(zn.copy(this._lscale,n),i|=fy.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit($E.TRANSFORM_CHANGED,i))}},{key:"pauseSystemEvents",value:function(e){this._eventProcessor.setEnabled(!1,e)}},{key:"resumeSystemEvents",value:function(e){this._eventProcessor.setEnabled(!0,e)}}],[{key:"isNode",value:function(e){return e instanceof n&&(e.constructor===n||!(e instanceof c.Scene))}},{key:"resetHasChangedFlags",value:function(){$A.clear()}},{key:"clearNodeArray",value:function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,MC.length=0,kC.length=0)}}]),n}(bC),CC.EventType=$E,CC.NodeSpace=_y,CC.TransformDirtyBit=fy,CC.TransformBit=fy,CC.reserveContentsForAllSyncablePrefabTag=eb,CC.ClearFrame=0,CC.ClearRound=1e3,yC=xe((gC=AC).prototype,"_lpos",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zn}}),xC=xe(gC.prototype,"_lrot",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qn}}),SC=xe(gC.prototype,"_lscale",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zn(1,1,1)}}),TC=xe(gC.prototype,"_layer",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jd.Enum.DEFAULT}}),EC=xe(gC.prototype,"_euler",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zn}}),xe(gC.prototype,"eulerAngles",[mC],Object.getOwnPropertyDescriptor(gC.prototype,"eulerAngles"),gC.prototype),xe(gC.prototype,"angle",[Gc],Object.getOwnPropertyDescriptor(gC.prototype,"angle"),gC.prototype),xe(gC.prototype,"layer",[Gc],Object.getOwnPropertyDescriptor(gC.prototype,"layer"),gC.prototype),vC=gC))||vC));c.Node=tb;var nb=Cc("cc.TargetInfo")((UC=xe((zC=function e(){K(this,e),ye(this,"localID",UC,this)}).prototype,"localID",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FC=zC))||FC,ib=(GC=Cc("cc.TargetOverrideInfo"),HC=rl(Tl),VC=rl(nb),jC=rl(tb),WC=rl(nb),GC((YC=xe((XC=function e(){K(this,e),ye(this,"source",YC,this),ye(this,"sourceInfo",KC,this),ye(this,"propertyPath",QC,this),ye(this,"target",ZC,this),ye(this,"targetInfo",JC,this)}).prototype,"source",[Ic,HC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KC=xe(XC.prototype,"sourceInfo",[Ic,VC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QC=xe(XC.prototype,"propertyPath",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZC=xe(XC.prototype,"target",[Ic,jC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JC=xe(XC.prototype,"targetInfo",[Ic,WC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qC=XC))||qC),rb=Cc("cc.CompPrefabInfo")((tA=xe((eA=function e(){K(this,e),ye(this,"fileId",tA,this)}).prototype,"fileId",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$C=eA))||$C,ab=(nA=Cc("CCPropertyOverrideInfo"),iA=rl(nb),nA((lA=function(){function e(){K(this,e),ye(this,"targetInfo",oA,this),ye(this,"propertyPath",sA,this),ye(this,"value",cA,this)}return Z(e,[{key:"isTarget",value:function(){}}]),e}(),oA=xe((aA=lA).prototype,"targetInfo",[Ic,iA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sA=xe(aA.prototype,"propertyPath",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cA=xe(aA.prototype,"value",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rA=aA))||rA),ob=(uA=Cc("cc.MountedChildrenInfo"),hA=rl(nb),_A=rl([tb]),uA((vA=function(){function e(){K(this,e),ye(this,"targetInfo",pA,this),ye(this,"nodes",mA,this)}return Z(e,[{key:"isTarget",value:function(){}}]),e}(),pA=xe((dA=vA).prototype,"targetInfo",[Ic,hA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mA=xe(dA.prototype,"nodes",[Ic,_A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fA=dA))||fA),sb=(gA=Cc("cc.MountedComponentsInfo"),yA=rl(nb),xA=rl([sh]),gA((AA=function(){function e(){K(this,e),ye(this,"targetInfo",EA,this),ye(this,"components",CA,this)}return Z(e,[{key:"isTarget",value:function(){}}]),e}(),EA=xe((TA=AA).prototype,"targetInfo",[Ic,yA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),CA=xe(TA.prototype,"components",[Ic,xA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SA=TA))||SA),cb=(bA=Cc("cc.PrefabInstance"),wA=rl(tb),RA=rl([ob]),PA=rl([sb]),IA=rl([ab]),DA=rl([nb]),bA((UA=function(){function e(){K(this,e),ye(this,"fileId",MA,this),ye(this,"prefabRootNode",kA,this),ye(this,"mountedChildren",LA,this),ye(this,"mountedComponents",BA,this),ye(this,"propertyOverrides",FA,this),ye(this,"removedComponents",zA,this),this.targetMap={}}return Z(e,[{key:"findPropertyOverride",value:function(){}},{key:"removePropertyOverride",value:function(){}}]),e}(),MA=xe((NA=UA).prototype,"fileId",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kA=xe(NA.prototype,"prefabRootNode",[Ic,wA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),LA=xe(NA.prototype,"mountedChildren",[Ic,RA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BA=xe(NA.prototype,"mountedComponents",[Ic,PA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FA=xe(NA.prototype,"propertyOverrides",[Ic,IA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zA=xe(NA.prototype,"removedComponents",[Ic,DA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OA=NA))||OA),lb=(GA=Cc("cc.PrefabInfo"),HA=rl(tb),VA=rl(cb),jA=rl([ib]),GA((XA=xe((qA=function e(){K(this,e),ye(this,"root",XA,this),ye(this,"asset",YA,this),ye(this,"fileId",KA,this),ye(this,"instance",QA,this),ye(this,"targetOverrides",ZA,this),ye(this,"nestedPrefabInstanceRoots",JA,this)}).prototype,"root",[Ic,HA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YA=xe(qA.prototype,"asset",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KA=xe(qA.prototype,"fileId",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),QA=xe(qA.prototype,"instance",[Ic,VA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ZA=xe(qA.prototype,"targetOverrides",[Ic,jA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),JA=xe(qA.prototype,"nestedPrefabInstanceRoots",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),WA=qA))||WA);function ub(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return D(3701,e.name),void(t.instance=void 0);var n=e._objFlags,i=e._parent,r=e._id,a=e._prefab;e[vl],c.game._isCloning=!0,t.asset._doInstantiate(e),c.game._isCloning=!1,e._objFlags=n,e._parent=i,e._id=r,e._prefab&&(e._prefab.instance=null==a?void 0:a.instance)}}function hb(e,t,n){var i;if(t&&e){var r=t,a=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&a&&(t[a.fileId]={},r=t[a.fileId]);var o=e._prefab;o&&(r[o.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)hb(e.children[u],r,!1)}}function _b(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function fb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var a=_b(r.targetInfo.localID,n);if(!a)continue;var o=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)o=o[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(a._children.push(u),u._parent=a,hb(u,o,!1),u._siblingIndex=a._children.length-1,gb(u,!0))}}}}function db(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var a=_b(r.targetInfo.localID,n);if(!a)continue;if(r.components)for(var o=0;o<r.components.length;o++){var s=r.components[o];s&&(s.node=a,a._components.push(s))}}}}function pb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var a=_b(r.localID,n);if(!a||!a.node)continue;var o=a.node.components.indexOf(a);o>=0&&a.node._components.splice(o,1)}}}function mb(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var a=t[r];if(a&&a.targetInfo){if(!(i=_b(a.targetInfo.localID,n)))continue;var o=i,s=a.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(o=o[s[l]]);l++);if(!o)continue;if(Array.isArray(o))if("length"===c)o[c]=a.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<o.length&&(o[c]=a.value)}else o[c]instanceof xt?o[c].set(a.value):o[c]=a.value}}}}function vb(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,a,o=n[i],s=o.source,c=o.sourceInfo;if(c){var l,u,h=null===(l=o.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=_b(c.localID,h.targetMap))}if(s){var _,f=o.targetInfo;if(f){var d=null===(r=o.target)||void 0===r||null===(a=r._prefab)||void 0===a?void 0:a.instance;if(d&&d.targetMap&&(_=_b(f.localID,d.targetMap))){var p=o.propertyPath.slice(),m=s;if(p.length>0){var v=p.pop();if(!v)return;for(var g=0;g<p.length&&(m=m[p[g]]);g++);if(!m)continue;m[v]=_}}}}}}function gb(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e._prefab,i=null==n?void 0:n.instance;if(i){ub(e);var r={};i.targetMap=r,hb(e,r,!0),fb(0,i.mountedChildren,r),pb(0,i.removedComponents,r),db(0,i.mountedComponents,r),mb(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){gb(e,!0)}))}function yb(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){gb(e)}))}c._PrefabInfo=lb;var xb,Sb,Tb,Eb,Cb,Ab,bb,wb,Rb,Pb,Ib,Db,Ob,Nb,Mb=Object.freeze({__proto__:null,TargetInfo:nb,TargetOverrideInfo:ib,CompPrefabInfo:rb,PropertyOverrideInfo:ab,MountedChildrenInfo:ob,MountedComponentsInfo:sb,PrefabInstance:cb,PrefabInfo:lb,createNodeWithPrefab:ub,generateTargetMap:hb,getTarget:_b,applyMountedChildren:fb,applyMountedComponents:db,applyRemovedComponents:pb,applyPropertyOverrides:mb,applyTargetOverrides:vb,expandPrefabInstanceNode:gb,expandNestedPrefabInstanceNode:yb}),kb=mt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Lb=e("Prefab",Cc("cc.Prefab")((bb=Ab=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"data",Tb,se(e)),ye(e,"optimizationPolicy",Eb,se(e)),ye(e,"persistent",Cb,se(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return Z(n,[{key:"createNode",value:function(e){var t=c.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){var e,t;this._createFunction=(t=(e=this.data)instanceof c._BaseNode&&e,new ZE(e,t).result)}},{key:"_doInstantiate",value:function(e){return this.data._prefab||P(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e;return this.optimizationPolicy!==kb.SINGLE_INSTANCE&&(this.optimizationPolicy===kb.MULTI_INSTANCE||this._instantiatedTimes+1>=n.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e}},{key:"initDefault",value:function(e){he(ne(n.prototype),"initDefault",this).call(this,e),this.data=new tb,this.data.name="(Missing Node)";var t=new c._PrefabInfo;t.asset=this,t.root=this.data,this.data._prefab=t}},{key:"validate",value:function(){return!!this.data}},{key:"onLoaded",value:function(){var e=this.data;yb(e),vb(e)}}]),n}(Uu),Ab.OptimizationPolicy=kb,Ab.OptimizationPolicyThreshold=3,Tb=xe((Sb=bb).prototype,"data",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Eb=xe(Sb.prototype,"optimizationPolicy",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kb.AUTO}}),Cb=xe(Sb.prototype,"persistent",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xb=Sb))||xb);dt.value(Lb,"_utils",Mb),c.Prefab=Lb,Ge(c,"cc._Prefab","Prefab"),e("PrefabLink",(wb=Cc("cc.PrefabLink"),Rb=rl(Lb),Pb=Hc(),wb((Nb=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"prefab",Ob,se(e)),e}return n}(sh),Ob=xe((Db=Nb).prototype,"prefab",[Rb,Ic,Pb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ib=Db))||Ib));var Bb=new zn;function Fb(e,t,n,i){i||(i=new zn),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function zb(e,t,n){return n||(n=new zn),e.worldToScreen(t,n),n.x/=c.view.getScaleX(),n.y/=c.view.getScaleY(),n}var Ub,Gb,Hb=e("convertUtils",{WorldNode3DToLocalNodeUI:Fb,WorldNode3DToWorldNodeUI:zb});c.pipelineUtils=Hb,F(c.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||Bb;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),z(sv.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),F(KS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var Vb,jb=e("BufferAsset",Cc("cc.BufferAsset")((xe((Gb=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._buffer=null,e}return Z(n,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}},{key:"buffer",value:function(){return this._buffer}},{key:"validate",value:function(){return!!this.buffer}}]),n}(Uu)).prototype,"_nativeAsset",[dl],Object.getOwnPropertyDescriptor(Gb.prototype,"_nativeAsset"),Gb.prototype),Ub=Gb))||Ub);c.BufferAsset=jb;var Wb=(J(Vb={},Ci.UNORM,"Uint"),J(Vb,Ci.SNORM,"Int"),J(Vb,Ci.UINT,"Uint"),J(Vb,Ci.INT,"Int"),J(Vb,Ci.UFLOAT,"Float"),J(Vb,Ci.FLOAT,"Float"),J(Vb,"default","Uint"),Vb);function qb(e){var t=Wb[e.type]||Wb.default,n=e.size/e.count*8;return"".concat(t).concat(n)}function Xb(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ei.R32F,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=la[n];r||(r=a.size);for(var o="set".concat(qb(a)),s=a.size/a.count,c=Math.floor(t.length/a.count),l=vh.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,_=0;_<a.count;++_){var f=h+s*_;e[o](f,t[a.count*u+_],l)}}function Yb(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ei.R32F,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.byteLength-i,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6?arguments[6]:void 0;o||(o=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=la[n];a||(a=s.size);for(var c="set".concat(qb(s)),l="get".concat(qb(s)),u=s.size/s.count,h=Math.floor(r/a),_=vh.isLittleEndian,f=0;f<h;++f)for(var d=i+a*f,p=0;p<s.count;++p){var m=d+u*p,v=e[l](m,_);o[c](m,t(v,p,e),_)}return o}var Kb,Qb,Zb=e("RenderingSubMesh",function(){function e(t,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;K(this,e),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=n,this._vertexBuffers=t,this._indexBuffer=r,this._indirectBuffer=a,this._primitiveMode=i,this._iaInfo=new Gr(n,t,r,a),this._init()}return Z(e,[{key:"_init",value:function(){}},{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:zn.ZERO,max:zn.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:zn.ZERO,max:zn.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,or.ATTR_POSITION),i=e.readIndices(t),r=new zn,a=new zn,o=this.attributes.find((function(e){return e.name===or.ATTR_POSITION}));if(o){var s=la[o.format].count;2===s?(r.set(n[0],n[1],0),a.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),a.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,a.x=n[c]<a.x?n[c]:a.x,a.y=n[c+1]<a.y?n[c+1]:a.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,a.x=n[c]<a.x?n[c]:a.x,a.y=n[c+1]<a.y?n[c+1]:a.y,a.z=n[c+2]<a.z?n[c+2]:a.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:a}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"genFlatBuffers",value:function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],a=e.struct.vertexBundles[r],o=n.indexView?n.indexView.count:a.view.count,s=a.view.stride,c=s*o,l=new Uint8Array(e.data.buffer,a.view.offset,a.view.length),u=new Uint8Array(n.indexView?c:a.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),_=0;_<t;++_)for(var f=_*s,d=h[_]*s,p=0;p<s;++p)u[f+p]=l[d+p];this._flatBuffers.push({stride:s,count:o,buffer:u})}else u.set(e.data.subarray(a.view.offset,a.view.offset+a.view.length)),this._flatBuffers.push({stride:s,count:o,buffer:u})}}}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,a=this.mesh.struct,o=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===o.jointMapIndex||!a.jointMaps[o.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=c.director.root.device,l=0;l<o.vertexBundelIndices.length;l++){var u=a.vertexBundles[o.vertexBundelIndices[l]];r=0,i=Ei.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===or.ATTR_JOINTS){i=_.format;break}r+=la[_.format].size}i?function(){var c=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(c.slice().buffer),_=a.jointMaps[o.jointMapIndex];Yb(h,(function(e){return _.indexOf(e)}),i,r,u.view.length,u.view.stride,h);var f=s.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.DEVICE,u.view.length,u.view.stride));f.update(h.buffer),t.push(f),n.push(l)}():t.push(this.vertexBuffers[o.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(s)),t}},{key:"iaInfo",get:function(){return this._iaInfo}},{key:"destroy",value:function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)}},{key:"enableVertexIdChannel",value:function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new zr("a_vertexId",Ei.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}}},{key:"_allocVertexIdBuffer",value:function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r}}]),e}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Kb||(Kb=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}(Qb||(Qb={})),c.SystemEventType=Kb;var Jb,$b=new Array(16),ew=null,tw=new ri,nw=[$E.TOUCH_START,$E.TOUCH_MOVE,$E.TOUCH_END,$E.TOUCH_CANCEL],iw=[$E.MOUSE_DOWN,$E.MOUSE_ENTER,$E.MOUSE_MOVE,$E.MOUSE_LEAVE,$E.MOUSE_UP,$E.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(Jb||(Jb={}));var rw,aw,ow,sw,cw,lw,uw,hw,_w,fw,dw,pw,mw,vw,gw,yw,xw,Sw,Tw,Ew,Cw,Aw,bw,ww,Rw,Pw,Iw,Dw,Ow,Nw,Mw,kw,Lw,Bw,Fw,zw,Uw,Gw,Hw,Vw,jw,Ww,qw,Xw,Yw,Kw,Qw,Zw,Jw,$w,eR,tR,nR,iR,rR,aR,oR,sR,cR,lR,uR,hR,_R,fR,dR,pR,mR,vR,gR,yR,xR,SR,TR,ER,CR,AR,bR,wR,RR,PR,IR,DR,OR,NR,MR,kR,LR,BR,FR,zR,UR,GR,HR,VR,jR,WR,qR,XR,YR,KR,QR,ZR,JR,$R,eP,tP,nP,iP,rP,aP,oP,sP,cP,lP,uP,hP,_P,fP,dP,pP,mP,vP,gP,yP,xP,SP,TP,EP,CP,AP,bP,wP,RP,PP,IP,DP,OP,NP,MP,kP,LP,BP,FP,zP,UP,GP,HP,VP,jP,WP,qP,XP,YP,KP,QP,ZP,JP,$P,eI,tI,nI,iI,rI,aI,oI,sI,cI,lI,uI,hI,_I,fI,dI,pI,mI,vI,gI,yI,xI,SI,TI,EI,CI,AI,bI,wI,RI,PI,II,DI,OI,NI,MI,kI,LI,BI=function(){function e(t){K(this,e),this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=t}return Z(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"setEnabled",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._isEnabled!==t){this._isEnabled=t;var i=this.node,r=i.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(Jb.MARK_LIST_DIRTY),n&&r.length>0)for(var a=0;a<r.length;++a){var o=r[a];o._eventProcessor.setEnabled(t,!0)}}}},{key:"node",get:function(){return this._node}},{key:"_searchComponentsInParent",value:function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&tb.isNode(r);r=r.parent,++n){var a=r.getComponent(e);if(a){var o={index:n,comp:a};i?i.push(o):i=[o]}}return i.length>0?i:null}return null}},{key:"_attachMask",value:function(){this.maskList=this._searchComponentsInParent(e._maskComp)}},{key:"reattach",value:function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))}},{key:"destroy",value:function(){ew===this._node&&(ew=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(Jb.REMOVE_POINTER_EVENT_PROCESSOR,this)}},{key:"_isTouchEvent",value:function(e){return-1!==nw.indexOf(e)}},{key:"_isMouseEvent",value:function(e){return-1!==iw.indexOf(e)}},{key:"_hasTouchListeners",value:function(){for(var e=0;e<nw.length;++e){var t=nw[e];if(this.hasEventListener(t))return!0}return!1}},{key:"_hasMouseListeners",value:function(){for(var e=0;e<iw.length;++e){var t=iw[e];if(this.hasEventListener(t))return!0}return!1}},{key:"_hasPointerListeners",value:function(){return!!this._hasTouchListeners()||this._hasMouseListeners()}},{key:"_tryEmittingAddEvent",value:function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(Jb.ADD_POINTER_EVENT_PROCESSOR,this)}},{key:"_newCallbacksInvoker",value:function(){var t=this,n=new su;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(Jb.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n}},{key:"on",value:function(e,t,n,i){var r,a;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(a=this.bubblingTarget)&&void 0!==a?a:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t}},{key:"once",value:function(e,t,n,i){var r,a;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(a=this.bubblingTarget)&&void 0!==a?a:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t}},{key:"off",value:function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)}},{key:"targetOff",value:function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(Jb.REMOVE_POINTER_EVENT_PROCESSOR,this)}},{key:"emit",value:function(e,t,n,i,r,a){var o;null===(o=this.bubblingTarget)||void 0===o||o.emit(e,t,n,i,r,a)}},{key:"dispatchEvent",value:function(e){var t,n=this.node,i=0;for(e.target=n,$b.length=0,this.getCapturingTargets(e.type,$b),e.eventPhase=1,i=$b.length-1;i>=0;--i)if((t=$b[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,$b),e.propagationStopped))return void($b.length=0);if($b.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,$b),e.eventPhase=3,i=0;i<$b.length;++i)if((t=$b[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void($b.length=0);$b.length=0}},{key:"hasEventListener",value:function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i}},{key:"getCapturingTargets",value:function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}}},{key:"getBubblingTargets",value:function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}}},{key:"_handleEventMouse",value:function(e){switch(e.type){case Qb.MOUSE_DOWN:return this._handleMouseDown(e);case Qb.MOUSE_MOVE:return this._handleMouseMove(e);case Qb.MOUSE_UP:return this._handleMouseUp(e);case Qb.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}}},{key:"_handleMouseDown",value:function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(tw=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(tw)||(e.type=$E.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))}},{key:"_handleMouseMove",value:function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(tw=e.getUILocation(),t._uiProps.uiTransformComp.isHit(tw)?(this.previousMouseIn||(ew&&ew!==t&&(e.type=$E.MOUSE_LEAVE,ew.dispatchEvent(e),ew.eventProcessor.previousMouseIn=!1),ew=t,e.type=$E.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=$E.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=$E.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,ew=null),1)))}},{key:"_handleMouseUp",value:function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(tw=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(tw)||(e.type=$E.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))}},{key:"_handleMouseWheel",value:function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(tw=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(tw)||(e.type=$E.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))}},{key:"_handleEventTouch",value:function(e){switch(e.type){case Qb.TOUCH_START:return this._handleTouchStart(e);case Qb.TOUCH_MOVE:return this._handleTouchMove(e);case Qb.TOUCH_END:return this._handleTouchEnd(e);case Qb.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}}},{key:"_handleTouchStart",value:function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getUILocation(tw),!t._uiProps.uiTransformComp.isHit(tw)||(e.type=$E.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))}},{key:"_handleTouchMove",value:function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=$E.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))}},{key:"_handleTouchEnd",value:function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getUILocation(tw),t._uiProps.uiTransformComp.isHit(tw)?e.type=$E.TOUCH_END:e.type=$E.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))}},{key:"_handleTouchCancel",value:function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=$E.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))}}]),e}();BI._maskComp=null,BI.callbacksInvoker=new su,c.NodeEventProcessor=BI;var FI=new zn(0,1,0),zI=new zn,UI=new ci,GI=new Bn,HI=new qn,VI=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},jI=(rw=Cc("cc.AmbientInfo"),aw=Uc(),ow=Dc("_skyColor"),sw=Dc("_skyIllum"),cw=Dc("_groundAlbedo"),lw=Hc(),uw=Wc(),hw=rl(jt),_w=Wc(),fw=Hc(),dw=Wc(),rw(pw=aw((Ew=function(){function e(){K(this,e),ye(this,"_skyColorHDR",vw,this),ye(this,"_skyIllumHDR",gw,this),ye(this,"_groundAlbedoHDR",yw,this),ye(this,"_skyColorLDR",xw,this),ye(this,"_skyIllumLDR",Sw,this),ye(this,"_groundAlbedoLDR",Tw,this),this._resource=null}return Z(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=c.director.root.pipeline.pipelineSceneData.isHDR;return UI.set(e?this._skyColorHDR:this._skyColorLDR),VI(UI),GI.set(255*UI.x,255*UI.y,255*UI.z,255)},set:function(e){UI.set(e.x,e.y,e.z,e.w),c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(UI):this._skyColorLDR.set(UI),this._resource&&this._resource.skyColor.set(UI)}},{key:"skyColor",set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=c.director.root.pipeline.pipelineSceneData.isHDR;return UI.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),VI(UI),GI.set(255*UI.x,255*UI.y,255*UI.z,255)},set:function(e){UI.set(e.x,e.y,e.z,e.w),c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(UI):this._groundAlbedoLDR.set(UI),this._resource&&this._resource.groundAlbedo.set(UI)}},{key:"groundAlbedo",set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}},{key:"activate",value:function(e){this._resource=e,this._resource.initialize(this)}}]),e}(),vw=xe((mw=Ew).prototype,"_skyColorHDR",[Ic,ow],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci(.2,.5,.8,1)}}),gw=xe(mw.prototype,"_skyIllumHDR",[Ic,sw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lT.SKY_ILLUM}}),yw=xe(mw.prototype,"_groundAlbedoHDR",[Ic,cw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci(.2,.2,.2,1)}}),xw=xe(mw.prototype,"_skyColorLDR",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci(.2,.5,.8,1)}}),Sw=xe(mw.prototype,"_skyIllumLDR",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lT.SKY_ILLUM}}),Tw=xe(mw.prototype,"_groundAlbedoLDR",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci(.2,.2,.2,1)}}),xe(mw.prototype,"skyLightingColor",[lw,Gc,uw],Object.getOwnPropertyDescriptor(mw.prototype,"skyLightingColor"),mw.prototype),xe(mw.prototype,"skyIllum",[Gc,hw,_w],Object.getOwnPropertyDescriptor(mw.prototype,"skyIllum"),mw.prototype),xe(mw.prototype,"groundLightingColor",[fw,Gc,dw],Object.getOwnPropertyDescriptor(mw.prototype,"groundLightingColor"),mw.prototype),pw=mw))||pw)||pw);c.AmbientInfo=jI;var WI=(Cw=Cc("cc.SkyboxInfo"),Aw=Uc(),bw=rl(Nv),ww=Dc("_envmap"),Rw=rl(Nv),Pw=rl(Nv),Iw=rl(Nv),Dw=Hc(),Ow=Wc(),Nw=Zc(),Mw=Wc(),kw=Wc(),Lw=Wc(),Bw=rl(Nv),Fw=Wc(),zw=Hc(),Uw=rl(Nv),Gw=Zc(),Cw(Hw=Aw((Jw=function(){function e(){K(this,e),ye(this,"_applyDiffuseMap",jw,this),ye(this,"_envmapHDR",Ww,this),ye(this,"_envmapLDR",qw,this),ye(this,"_diffuseMapHDR",Xw,this),ye(this,"_diffuseMapLDR",Yw,this),ye(this,"_enabled",Kw,this),ye(this,"_useIBL",Qw,this),ye(this,"_useHDR",Zw,this),this._resource=null}return Z(e,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(e){this._applyDiffuseMap=e,this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=e:this._envmapLDR=e,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){c.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}},{key:"activate",value:function(e){this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()}}]),e}(),jw=xe((Vw=Jw).prototype,"_applyDiffuseMap",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ww=xe(Vw.prototype,"_envmapHDR",[Ic,bw,ww],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qw=xe(Vw.prototype,"_envmapLDR",[Ic,Rw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xw=xe(Vw.prototype,"_diffuseMapHDR",[Ic,Pw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yw=xe(Vw.prototype,"_diffuseMapLDR",[Ic,Iw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kw=xe(Vw.prototype,"_enabled",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qw=xe(Vw.prototype,"_useIBL",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zw=xe(Vw.prototype,"_useHDR",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xe(Vw.prototype,"applyDiffuseMap",[Dw,Gc,Ow,Nw],Object.getOwnPropertyDescriptor(Vw.prototype,"applyDiffuseMap"),Vw.prototype),xe(Vw.prototype,"enabled",[Gc,Mw],Object.getOwnPropertyDescriptor(Vw.prototype,"enabled"),Vw.prototype),xe(Vw.prototype,"useIBL",[Gc,kw],Object.getOwnPropertyDescriptor(Vw.prototype,"useIBL"),Vw.prototype),xe(Vw.prototype,"useHDR",[Gc,Lw],Object.getOwnPropertyDescriptor(Vw.prototype,"useHDR"),Vw.prototype),xe(Vw.prototype,"envmap",[Gc,Bw,Fw],Object.getOwnPropertyDescriptor(Vw.prototype,"envmap"),Vw.prototype),xe(Vw.prototype,"diffuseMap",[zw,Gc,Vc,Uw,Gw],Object.getOwnPropertyDescriptor(Vw.prototype,"diffuseMap"),Vw.prototype),Hw=Vw))||Hw)||Hw);c.SkyboxInfo=WI;var qI=($w=Cc("cc.FogInfo"),eR=Uc(),tR=Wc(),nR=Zc(),iR=Wc(),rR=Zc(),aR=Wc(),oR=rl(NE),sR=Zc(),cR=Wc(),lR=Hc(),uR=rl(jt),hR=qc(),_R=Kc(),fR=Wc(),dR=Hc(),pR=rl(jt),mR=Kc(),vR=Wc(),gR=Hc(),yR=rl(jt),xR=Kc(),SR=Wc(),TR=Hc(),ER=rl(jt),CR=Xc(),AR=Kc(),bR=Wc(),wR=Hc(),RR=rl(jt),PR=Kc(),IR=Wc(),DR=Hc(),OR=rl(jt),NR=Kc(),MR=Wc(),$w(kR=eR((YR=XR=function(){function e(){K(this,e),ye(this,"_type",BR,this),ye(this,"_fogColor",FR,this),ye(this,"_enabled",zR,this),ye(this,"_fogDensity",UR,this),ye(this,"_fogStart",GR,this),ye(this,"_fogEnd",HR,this),ye(this,"_fogAtten",VR,this),ye(this,"_fogTop",jR,this),ye(this,"_fogRange",WR,this),ye(this,"_accurate",qR,this),this._resource=null}return Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}},{key:"activate",value:function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()}}]),e}(),XR.FogType=NE,BR=xe((LR=YR).prototype,"_type",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NE.LINEAR}}),FR=xe(LR.prototype,"_fogColor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bn("#C8C8C8")}}),zR=xe(LR.prototype,"_enabled",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UR=xe(LR.prototype,"_fogDensity",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),GR=xe(LR.prototype,"_fogStart",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),HR=xe(LR.prototype,"_fogEnd",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),VR=xe(LR.prototype,"_fogAtten",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),jR=xe(LR.prototype,"_fogTop",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),WR=xe(LR.prototype,"_fogRange",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),qR=xe(LR.prototype,"_accurate",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xe(LR.prototype,"enabled",[Gc,tR,nR],Object.getOwnPropertyDescriptor(LR.prototype,"enabled"),LR.prototype),xe(LR.prototype,"accurate",[Gc,iR,rR],Object.getOwnPropertyDescriptor(LR.prototype,"accurate"),LR.prototype),xe(LR.prototype,"fogColor",[Gc,aR],Object.getOwnPropertyDescriptor(LR.prototype,"fogColor"),LR.prototype),xe(LR.prototype,"type",[Gc,oR,sR,cR],Object.getOwnPropertyDescriptor(LR.prototype,"type"),LR.prototype),xe(LR.prototype,"fogDensity",[lR,uR,hR,_R,Qc,fR],Object.getOwnPropertyDescriptor(LR.prototype,"fogDensity"),LR.prototype),xe(LR.prototype,"fogStart",[dR,pR,mR,vR],Object.getOwnPropertyDescriptor(LR.prototype,"fogStart"),LR.prototype),xe(LR.prototype,"fogEnd",[gR,yR,xR,SR],Object.getOwnPropertyDescriptor(LR.prototype,"fogEnd"),LR.prototype),xe(LR.prototype,"fogAtten",[TR,ER,CR,AR,bR],Object.getOwnPropertyDescriptor(LR.prototype,"fogAtten"),LR.prototype),xe(LR.prototype,"fogTop",[wR,RR,PR,IR],Object.getOwnPropertyDescriptor(LR.prototype,"fogTop"),LR.prototype),xe(LR.prototype,"fogRange",[DR,OR,NR,MR],Object.getOwnPropertyDescriptor(LR.prototype,"fogRange"),LR.prototype),kR=LR))||kR)||kR),XI=(KR=Cc("cc.ShadowsInfo"),QR=Uc(),ZR=Wc(),JR=rl(Pg),$R=Hc(),eP=Hc(),tP=Wc(),nP=rl(jt),iP=Wc(),rP=Hc(),aP=qc(),oP=rl(jt),sP=Wc(),cP=Hc(),lP=rl(Ig),uP=Wc(),hP=Hc(),_P=rl(Vt),fP=Hc(),dP=rl(jt),pP=Wc(),mP=Hc(),vP=rl(jt),gP=Wc(),yP=Hc(),xP=rl(Rg),SP=Wc(),TP=Hc(),EP=rl(Wt),CP=Wc(),AP=Hc(),bP=rl(jt),wP=Wc(),RP=Hc(),PP=rl(jt),IP=Wc(),DP=Hc(),OP=qc(),NP=rl(jt),MP=Wc(),kP=Hc(),LP=qc(),BP=rl(jt),FP=Wc(),zP=Hc(),UP=rl(jt),GP=Wc(),HP=Hc(),KR(VP=QR((lI=function(){function e(){K(this,e),ye(this,"_type",WP,this),ye(this,"_enabled",qP,this),ye(this,"_normal",XP,this),ye(this,"_distance",YP,this),ye(this,"_shadowColor",KP,this),ye(this,"_firstSetCSM",QP,this),ye(this,"_fixedArea",ZP,this),ye(this,"_pcf",JP,this),ye(this,"_bias",$P,this),ye(this,"_normalBias",eI,this),ye(this,"_near",tI,this),ye(this,"_far",nI,this),ye(this,"_shadowDistance",iI,this),ye(this,"_invisibleOcclusionRange",rI,this),ye(this,"_orthoSize",aI,this),ye(this,"_maxReceived",oI,this),ye(this,"_size",sI,this),ye(this,"_saturation",cI,this),this._resource=null}return Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"normal",get:function(){return this._normal},set:function(e){zn.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"saturation",get:function(){return this._saturation},set:function(e){e>1?(this._saturation=e/e,this._resource&&(this._resource.saturation=e/e)):(this._saturation=e,this._resource&&(this._resource.saturation=e))}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e,this._resource&&(this._resource.bias=e)}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e,this._resource&&(this._resource.fixedArea=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._resource&&(this._resource.near=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=Math.min(e,Og.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=Math.min(e,Og.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,Og.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}},{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(HI),this.normal=zn.transformQuat(zI,FI,HI),e.getWorldPosition(zI),this.distance=zn.dot(this._normal,zI)}},{key:"activate",value:function(e){this.pcf=Math.min(this._pcf,Ig.SOFT_2X),this._resource=e,this._resource.initialize(this),this._resource.activate()}}]),e}(),WP=xe((jP=lI).prototype,"_type",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pg.Planar}}),qP=xe(jP.prototype,"_enabled",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),XP=xe(jP.prototype,"_normal",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zn(0,1,0)}}),YP=xe(jP.prototype,"_distance",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KP=xe(jP.prototype,"_shadowColor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bn(0,0,0,76)}}),QP=xe(jP.prototype,"_firstSetCSM",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZP=xe(jP.prototype,"_fixedArea",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JP=xe(jP.prototype,"_pcf",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ig.HARD}}),$P=xe(jP.prototype,"_bias",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),eI=xe(jP.prototype,"_normalBias",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tI=xe(jP.prototype,"_near",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),nI=xe(jP.prototype,"_far",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),iI=xe(jP.prototype,"_shadowDistance",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),rI=xe(jP.prototype,"_invisibleOcclusionRange",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),aI=xe(jP.prototype,"_orthoSize",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),oI=xe(jP.prototype,"_maxReceived",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),sI=xe(jP.prototype,"_size",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri(512,512)}}),cI=xe(jP.prototype,"_saturation",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),xe(jP.prototype,"enabled",[Gc,ZR],Object.getOwnPropertyDescriptor(jP.prototype,"enabled"),jP.prototype),xe(jP.prototype,"type",[Gc,JR],Object.getOwnPropertyDescriptor(jP.prototype,"type"),jP.prototype),xe(jP.prototype,"shadowColor",[$R],Object.getOwnPropertyDescriptor(jP.prototype,"shadowColor"),jP.prototype),xe(jP.prototype,"normal",[eP,tP],Object.getOwnPropertyDescriptor(jP.prototype,"normal"),jP.prototype),xe(jP.prototype,"distance",[nP,iP,rP],Object.getOwnPropertyDescriptor(jP.prototype,"distance"),jP.prototype),xe(jP.prototype,"saturation",[Gc,aP,Qc,oP,sP,cP],Object.getOwnPropertyDescriptor(jP.prototype,"saturation"),jP.prototype),xe(jP.prototype,"pcf",[lP,uP,hP],Object.getOwnPropertyDescriptor(jP.prototype,"pcf"),jP.prototype),xe(jP.prototype,"maxReceived",[_P,fP],Object.getOwnPropertyDescriptor(jP.prototype,"maxReceived"),jP.prototype),xe(jP.prototype,"bias",[dP,pP,mP],Object.getOwnPropertyDescriptor(jP.prototype,"bias"),jP.prototype),xe(jP.prototype,"normalBias",[vP,gP,yP],Object.getOwnPropertyDescriptor(jP.prototype,"normalBias"),jP.prototype),xe(jP.prototype,"shadowMapSize",[xP,SP,TP],Object.getOwnPropertyDescriptor(jP.prototype,"shadowMapSize"),jP.prototype),xe(jP.prototype,"fixedArea",[EP,CP,AP],Object.getOwnPropertyDescriptor(jP.prototype,"fixedArea"),jP.prototype),xe(jP.prototype,"near",[bP,wP,RP],Object.getOwnPropertyDescriptor(jP.prototype,"near"),jP.prototype),xe(jP.prototype,"far",[PP,IP,DP],Object.getOwnPropertyDescriptor(jP.prototype,"far"),jP.prototype),xe(jP.prototype,"invisibleOcclusionRange",[Gc,OP,Qc,NP,MP,kP],Object.getOwnPropertyDescriptor(jP.prototype,"invisibleOcclusionRange"),jP.prototype),xe(jP.prototype,"shadowDistance",[Gc,LP,Qc,BP,FP,zP],Object.getOwnPropertyDescriptor(jP.prototype,"shadowDistance"),jP.prototype),xe(jP.prototype,"orthoSize",[UP,GP,HP],Object.getOwnPropertyDescriptor(jP.prototype,"orthoSize"),jP.prototype),VP=jP))||VP)||VP);c.ShadowsInfo=XI;var YI=new zn(-1024,-1024,-1024),KI=new zn(1024,1024,1024),QI=(uI=Cc("cc.OctreeInfo"),hI=Uc(),_I=Wc(),fI=Wc(),dI=jc(),pI=Wc(),mI=jc(),vI=qc(),gI=rl(Vt),yI=Wc(),uI(xI=hI((bI=function(){function e(){K(this,e),ye(this,"_enabled",TI,this),ye(this,"_minPos",EI,this),ye(this,"_maxPos",CI,this),ye(this,"_depth",AI,this),this._resource=null}return Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}},{key:"activate",value:function(e){this._resource=e,this._resource.initialize(this)}}]),e}(),TI=xe((SI=bI).prototype,"_enabled",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),EI=xe(SI.prototype,"_minPos",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zn(YI)}}),CI=xe(SI.prototype,"_maxPos",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zn(KI)}}),AI=xe(SI.prototype,"_depth",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),xe(SI.prototype,"enabled",[Gc,_I],Object.getOwnPropertyDescriptor(SI.prototype,"enabled"),SI.prototype),xe(SI.prototype,"minPos",[Gc,fI,dI],Object.getOwnPropertyDescriptor(SI.prototype,"minPos"),SI.prototype),xe(SI.prototype,"maxPos",[Gc,pI,mI],Object.getOwnPropertyDescriptor(SI.prototype,"maxPos"),SI.prototype),xe(SI.prototype,"depth",[Gc,vI,gI,yI],Object.getOwnPropertyDescriptor(SI.prototype,"depth"),SI.prototype),xI=SI))||xI)||xI),ZI=(wI=Cc("cc.SceneGlobals"),RI=rl(WI),wI((LI=function(){function e(){K(this,e),ye(this,"ambient",DI,this),ye(this,"shadows",OI,this),ye(this,"_skybox",NI,this),ye(this,"fog",MI,this),ye(this,"octree",kI,this)}return Z(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}},{key:"activate",value:function(){var e=c.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)}}]),e}(),DI=xe((II=LI).prototype,"ambient",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jI}}),OI=xe(II.prototype,"shadows",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new XI}}),NI=xe(II.prototype,"_skybox",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new WI}}),MI=xe(II.prototype,"fog",[Gc,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qI}}),xe(II.prototype,"skybox",[Gc,RI],Object.getOwnPropertyDescriptor(II.prototype,"skybox"),II.prototype),kI=xe(II.prototype,"octree",[Gc,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QI}}),PI=II))||PI);c.SceneGlobals=ZI;var JI=e("Event",function(){function e(t,n){K(this,e),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!n}return Z(e,[{key:"unuse",value:function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),e}());JI.NO_TYPE="no_type",JI.TOUCH="touch",JI.MOUSE="mouse",JI.KEYBOARD="keyboard",JI.ACCELERATION="acceleration",JI.NONE=0,JI.CAPTURING_PHASE=1,JI.AT_TARGET=2,JI.BUBBLING_PHASE=3,c.Event=JI;var $I=e("EventAcceleration",function(e){te(n,e);var t=le(n);function n(e,i){var r;return K(this,n),(r=t.call(this,Kb.DEVICEMOTION,i)).acc=void 0,r.acc=e,r}return n}(JI));JI.EventAcceleration=$I;var eD=e("EventKeyboard",function(e){te(n,e);var t=le(n);function n(e,i,r){var a;return K(this,n),"boolean"==typeof i&&(i=i?Kb.KEY_DOWN:Kb.KEY_UP),(a=t.call(this,i,r)).keyCode=void 0,a.rawEvent=void 0,a._isPressed=void 0,a._isPressed=i!==Kb.KEY_UP,"number"==typeof e?a.keyCode=e:(a.keyCode=e.keyCode,a.rawEvent=e),a}return Z(n,[{key:"isPressed",get:function(){return this._isPressed}}]),n}(JI));JI.EventKeyboard=eD;var tD=e("EventMouse",function(e){te(n,e);var t=le(n);function n(e,i,r){var a;return K(this,n),(a=t.call(this,e,i)).movementX=0,a.movementY=0,a.preventSwallow=!1,a._eventType=void 0,a._button=n.BUTTON_MISSING,a._x=0,a._y=0,a._prevX=0,a._prevY=0,a._scrollX=0,a._scrollY=0,a._eventType=e,r&&(a._prevX=r.x,a._prevY=r.y),a}return Z(n,[{key:"eventType",get:function(){return this._eventType}},{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e||(e=new ri),ri.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e||(e=new ri),ri.set(e,this._x,c.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e||(e=new ri),ri.set(e,this._x,this._y),c.view._convertToUISpace(e),e}},{key:"getPreviousLocation",value:function(e){return e||(e=new ri),ri.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new ri),ri.set(e,this._prevX,this._prevY),c.view._convertToUISpace(e),e}},{key:"getDelta",value:function(e){return e||(e=new ri),ri.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e||(e=new ri),ri.set(e,(this._x-this._prevX)/c.view.getScaleX(),(this._y-this._prevY)/c.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/c.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/c.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=c.view.getViewportRect();return(this._x-e.x)/c.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=c.view.getViewportRect();return(this._y-e.y)/c.view.getScaleY()}}]),n}(JI));tD.BUTTON_MISSING=-1,tD.BUTTON_LEFT=0,tD.BUTTON_RIGHT=2,tD.BUTTON_MIDDLE=1,tD.BUTTON_4=3,tD.BUTTON_5=4,tD.BUTTON_6=5,tD.BUTTON_7=6,tD.BUTTON_8=7,JI.EventMouse=tD;var nD=new ri,iD=e("EventTouch",function(e){te(n,e);var t=le(n);function n(e,i,r){var a,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return K(this,n),(a=t.call(this,r,i)).touch=null,a.simulate=!1,a.preventSwallow=!1,a._eventCode=void 0,a._touches=void 0,a._allTouches=void 0,a._eventCode=r,a._touches=e||[],a._allTouches=o,a}return Z(n,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"getAllTouches",value:function(){return this._allTouches}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new ri}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new ri}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new ri}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new ri}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new ri}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new ri}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new ri}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new ri}},{key:"getDeltaX",value:function(){return this.touch?this.touch.getDelta(nD).x:0}},{key:"getDeltaY",value:function(){return this.touch?this.touch.getDelta(nD).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),n}(JI));iD.MAX_TOUCHES=5,JI.EventTouch=iD;var rD,aD=e("Acceleration",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;K(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=n,this.z=i,this.timestamp=r}));!function(e){e[e.NONE=0]="NONE",e[e.MOBILE_BACK=6]="MOBILE_BACK",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(rD||(rD=e("KeyCode",{})));var oD=new ri,sD=e("Touch",function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;K(this,e),this._point=new ri,this._prevPoint=new ri,this._lastModified=0,this._id=0,this._startPoint=new ri,this._startPointCaptured=!1,this.setTouchInfo(i,t,n)}return Z(e,[{key:"lastModified",get:function(){return this._lastModified}},{key:"getLocation",value:function(e){return e||(e=new ri),e.set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return e||(e=new ri),e.set(this._point.x,this._point.y),c.view._convertToUISpace(e),e}},{key:"getUILocationX",value:function(){var e=c.view.getViewportRect();return(this._point.x-e.x)/c.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=c.view.getViewportRect();return(this._point.y-e.y)/c.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return e||(e=new ri),e.set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new ri),e.set(this._prevPoint.x,this._prevPoint.y),c.view._convertToUISpace(e),e}},{key:"getStartLocation",value:function(e){return e||(e=new ri),e.set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return e||(e=new ri),e.set(this._startPoint.x,this._startPoint.y),c.view._convertToUISpace(e),e}},{key:"getDelta",value:function(e){return e||(e=new ri),e.set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e||(e=new ri),oD.set(this._point),oD.subtract(this._prevPoint),e.set(c.view.getScaleX(),c.view.getScaleY()),ri.divide(e,oD,e),e}},{key:"getLocationInView",value:function(e){return e||(e=new ri),e.set(this._point.x,c.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return e||(e=new ri),e.set(this._prevPoint.x,c.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return e||(e=new ri),e.set(this._startPoint.x,c.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this._prevPoint=this._point,this._point=new ri(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new ri(this._point),this._startPointCaptured=!0)}},{key:"setPoint",value:function(e,t){"object"===Y(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=c.game.frameStartTime}},{key:"setPrevPoint",value:function(e,t){"object"===Y(e)?this._prevPoint=new ri(e.x,e.y):this._prevPoint=new ri(e||0,t||0),this._lastModified=c.game.frameStartTime}}]),e}());c.Touch=sD;var cD,lD,uD=function(){function e(){K(this,e),this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new lu,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,Eu.browserType===hu.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}return Z(e,[{key:"_registerEvent",value:function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)}},{key:"_unregisterEvent",value:function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)}},{key:"_didAccelerate",value:function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;n=.1*((null==a?void 0:a.x)||0),i=.1*((null==a?void 0:a.y)||0),r=.1*((null==a?void 0:a.z)||0)}else{var o=e;n=(o.gamma||0)/90*.981,i=-(o.beta||0)/90*.981,r=(o.alpha||0)/90*.981}if(dh.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),Eu.os===du.ANDROID&&Eu.browserType!==hu.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new aD(n,i,r,l),h=new $I(u);this._eventTarget.emit(Qb.DEVICEMOTION,h)}}},{key:"start",value:function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()}},{key:"stop",value:function(){this._unregisterEvent()}},{key:"setInterval",value:function(e){this._intervalInMileSeconds=e}},{key:"on",value:function(e,t,n){this._eventTarget.on(e,t,n)}}]),e}(),hD={Backspace:rD.BACKSPACE,Tab:rD.TAB,Enter:rD.ENTER,ShiftLeft:rD.SHIFT_LEFT,ControlLeft:rD.CTRL_LEFT,AltLeft:rD.ALT_LEFT,ShiftRight:rD.SHIFT_RIGHT,ControlRight:rD.CTRL_RIGHT,AltRight:rD.ALT_RIGHT,Pause:rD.PAUSE,CapsLock:rD.CAPS_LOCK,Escape:rD.ESCAPE,Space:rD.SPACE,PageUp:rD.PAGE_UP,PageDown:rD.PAGE_DOWN,End:rD.END,Home:rD.HOME,ArrowLeft:rD.ARROW_LEFT,ArrowUp:rD.ARROW_UP,ArrowRight:rD.ARROW_RIGHT,ArrowDown:rD.ARROW_DOWN,Insert:rD.INSERT,Delete:rD.DELETE,Digit0:rD.DIGIT_0,Digit1:rD.DIGIT_1,Digit2:rD.DIGIT_2,Digit3:rD.DIGIT_3,Digit4:rD.DIGIT_4,Digit5:rD.DIGIT_5,Digit6:rD.DIGIT_6,Digit7:rD.DIGIT_7,Digit8:rD.DIGIT_8,Digit9:rD.DIGIT_9,KeyA:rD.KEY_A,KeyB:rD.KEY_B,KeyC:rD.KEY_C,KeyD:rD.KEY_D,KeyE:rD.KEY_E,KeyF:rD.KEY_F,KeyG:rD.KEY_G,KeyH:rD.KEY_H,KeyI:rD.KEY_I,KeyJ:rD.KEY_J,KeyK:rD.KEY_K,KeyL:rD.KEY_L,KeyM:rD.KEY_M,KeyN:rD.KEY_N,KeyO:rD.KEY_O,KeyP:rD.KEY_P,KeyQ:rD.KEY_Q,KeyR:rD.KEY_R,KeyS:rD.KEY_S,KeyT:rD.KEY_T,KeyU:rD.KEY_U,KeyV:rD.KEY_V,KeyW:rD.KEY_W,KeyX:rD.KEY_X,KeyY:rD.KEY_Y,KeyZ:rD.KEY_Z,Numpad0:rD.NUM_0,Numpad1:rD.NUM_1,Numpad2:rD.NUM_2,Numpad3:rD.NUM_3,Numpad4:rD.NUM_4,Numpad5:rD.NUM_5,Numpad6:rD.NUM_6,Numpad7:rD.NUM_7,Numpad8:rD.NUM_8,Numpad9:rD.NUM_9,NumpadMultiply:rD.NUM_MULTIPLY,NumpadAdd:rD.NUM_PLUS,NumpadSubtract:rD.NUM_SUBTRACT,NumpadDecimal:rD.NUM_DECIMAL,NumpadDivide:rD.NUM_DIVIDE,NumpadEnter:rD.NUM_ENTER,F1:rD.F1,F2:rD.F2,F3:rD.F3,F4:rD.F4,F5:rD.F5,F6:rD.F6,F7:rD.F7,F8:rD.F8,F9:rD.F9,F10:rD.F10,F11:rD.F11,F12:rD.F12,NumLock:rD.NUM_LOCK,ScrollLock:rD.SCROLL_LOCK,Semicolon:rD.SEMICOLON,Equal:rD.EQUAL,Comma:rD.COMMA,Minus:rD.DASH,Period:rD.PERIOD,Slash:rD.SLASH,Backquote:rD.BACK_QUOTE,BracketLeft:rD.BRACKET_LEFT,Backslash:rD.BACKSLASH,BracketRight:rD.BRACKET_RIGHT,Quote:rD.QUOTE},_D=function(){function e(){K(this,e),this._eventTarget=new lu,this._registerEvent()}return Z(e,[{key:"_registerEvent",value:function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,Qb.KEY_PRESSING);e._eventTarget.emit(Qb.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,Qb.KEY_DOWN);e._eventTarget.emit(Qb.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,Qb.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(Qb.KEY_UP,n)}))}},{key:"_getInputEvent",value:function(e,t){var n,i=(n=e.code,hD[n]||rD.NONE);return new eD(i,t)}},{key:"on",value:function(e,t,n){this._eventTarget.on(e,t,n)}}]),e}(),fD=function(){function e(){K(this,e),this._canvas=void 0,this._eventTarget=new lu,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new ri,Eu.hasFeature(mu.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}return Z(e,[{key:"_getCanvasRect",value:function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new fi(t.x,t.y,t.width,t.height):new fi(0,0,0,0)}},{key:"_getLocation",value:function(e){var t=this._getCanvasRect(),n=dh.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;return new ri(i*=n,r*=n)}},{key:"_registerEvent",value:function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(Qb.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(Qb.MOUSE_MOVE));var a=this._createCallback(Qb.MOUSE_UP);window.addEventListener("mouseup",a),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",a),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()}},{key:"_registerPointerLockEvent",value:function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)}},{key:"_createCallback",value:function(e){var t=this;return function(n){var i,r=t._getLocation(n),a=n.button;switch(e){case Qb.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case Qb.MOUSE_UP:t._isPressed=!1;break;case Qb.MOUSE_MOVE:t._isPressed||(a=tD.BUTTON_MISSING)}var o=new tD(e,!1,t._preMousePos);o.setLocation(r.x,r.y),o.setButton(a),o.movementX=n.movementX,o.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,o)}}},{key:"_handleMouseWheel",value:function(e){var t=Qb.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new tD(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)}},{key:"on",value:function(e,t,n){this._eventTarget.on(e,t,n)}}]),e}(),dD=new ri,pD=new(function(){function e(){K(this,e),this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}return Z(e,[{key:"_cloneTouch",value:function(e){var t=e.getID();e.getStartLocation(dD);var n=new sD(dD.x,dD.y,t);return e.getLocation(dD),n.setPoint(dD.x,dD.y),e.getPreviousLocation(dD),n.setPrevPoint(dD),n}},{key:"_createTouch",value:function(e,t,n){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var i=new sD(t,n,e);return this._touchMap.set(e,i),this._updateTouch(i,t,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}}},{key:"releaseTouch",value:function(e){this._touchMap.has(e)&&this._touchMap.delete(e)}},{key:"getTouch",value:function(e,t,n){var i=this._touchMap.get(e);return i?this._updateTouch(i,t,n):i=this._createTouch(e,t,n),i?this._cloneTouch(i):void 0}},{key:"getAllTouches",value:function(){var e=this,t=[];return this._touchMap.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t}},{key:"_updateTouch",value:function(e,t,n){e.getLocation(dD),e.setPrevPoint(dD),e.setPoint(t,n)}},{key:"_checkTouchMapSizeMoreThanMax",value:function(e){var t=this;if(this._touchMap.has(e))return!1;var n=St.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(e){i-e.lastModified>St.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id ".concat(e.getID(),".")),t.releaseTouch(e.getID()))})),n>=this._touchMap.size}}]),e}()),mD=function(){function e(){K(this,e),this._canvas=void 0,this._eventTarget=new lu,Eu.hasFeature(mu.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}return Z(e,[{key:"_registerEvent",value:function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(Qb.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(Qb.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(Qb.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(Qb.TOUCH_CANCEL))}},{key:"_createCallback",value:function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),a=[],o=n.changedTouches.length,s=0;s<o;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=pD.getTouch(l,u.x,u.y);h&&(e!==Qb.TOUCH_END&&e!==Qb.TOUCH_CANCEL||pD.releaseTouch(l),a.push(h))}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===Qb.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),a.length>0){var _=new iD(a,!1,e,St.ENABLE_MULTI_TOUCH?pD.getAllTouches():a);t._eventTarget.emit(e,_)}}}},{key:"_getCanvasRect",value:function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new fi(t.x,t.y,t.width,t.height):new fi(0,0,0,0)}},{key:"_getLocation",value:function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(dh.isFrameRotated){var r=n;n=t.height-i,i=r}var a=dh.devicePixelRatio;return new ri(n*=a,i*=a)}},{key:"on",value:function(e,t,n){this._eventTarget.on(e,t,n)}}]),e}();!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(lD||(lD={}));var vD=function(){function e(t){K(this,e),this.priority=lD.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}return Z(e,[{key:"dispatchEvent",value:function(e){return this._inputEventTarget.emit(e.type,e),!0}}]),e}(),gD=(J(cD={},Qb.MOUSE_DOWN,Qb.TOUCH_START),J(cD,Qb.MOUSE_MOVE,Qb.TOUCH_MOVE),J(cD,Qb.MOUSE_UP,Qb.TOUCH_END),cD),yD=e("Input",function(){function e(){K(this,e),this._dispatchImmediately=!0,this._eventTarget=new lu,this._touchInput=new mD,this._mouseInput=new fD,this._keyboardInput=new _D,this._accelerometerInput=new uD,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new vD(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}return Z(e,[{key:"on",value:function(e,t,n){return this._eventTarget.on(e,t,n),t}},{key:"once",value:function(e,t,n){return this._eventTarget.once(e,t,n),t}},{key:"off",value:function(e,t,n){this._eventTarget.off(e,t,n)}},{key:"setAccelerometerEnabled",value:function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()}},{key:"setAccelerometerInterval",value:function(e){this._accelerometerInput.setInterval(e)}},{key:"_simulateEventTouch",value:function(e){var t=gD[e.type],n=pD.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new iD(i,!1,t,i);t===Qb.TOUCH_END&&pD.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}}},{key:"_registerEventDispatcher",value:function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))}},{key:"_emitEvent",value:function(e){for(var t=this._eventDispatcherList.length,n=0;n<t&&this._eventDispatcherList[n].dispatchEvent(e);++n);}},{key:"_registerEvent",value:function(){var e=this;if(vh.hasFeature(vh.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(Qb.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(Qb.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(Qb.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(Qb.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(vh.hasFeature(vh.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(Qb.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(Qb.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(Qb.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(Qb.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(vh.hasFeature(vh.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(Qb.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(Qb.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(Qb.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(vh.hasFeature(vh.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(Qb.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}}},{key:"_clearEvents",value:function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0}},{key:"_dispatchOrPushEvent",value:function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)}},{key:"_dispatchOrPushEventTouch",value:function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)}},{key:"_frameDispatchEvents",value:function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._emitEvent(i)}for(var r=this._eventTouchList,a=0,o=r.length;a<o;++a)for(var s=r[a],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var d=h[_];this._emitEvent(d)}for(var p=this._eventAccelerationList,m=0,v=p.length;m<v;++m){var g=p[m];this._emitEvent(g)}this._clearEvents()}}]),e}());yD.EventType=Qb;var xD=e("input",new yD),SD=e("SystemEvent",function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),e=t.call(this),xD.on(Qb.MOUSE_DOWN,(function(t){e.emit(Kb.MOUSE_DOWN,t)})),xD.on(Qb.MOUSE_MOVE,(function(t){e.emit(Kb.MOUSE_MOVE,t)})),xD.on(Qb.MOUSE_UP,(function(t){e.emit(Kb.MOUSE_UP,t)})),xD.on(Qb.MOUSE_WHEEL,(function(t){e.emit(Kb.MOUSE_WHEEL,t)})),xD.on(Qb.TOUCH_START,(function(t){e.emit(Kb.TOUCH_START,t.touch,t)})),xD.on(Qb.TOUCH_MOVE,(function(t){e.emit(Kb.TOUCH_MOVE,t.touch,t)})),xD.on(Qb.TOUCH_END,(function(t){e.emit(Kb.TOUCH_END,t.touch,t)})),xD.on(Qb.TOUCH_CANCEL,(function(t){e.emit(Kb.TOUCH_CANCEL,t.touch,t)})),xD.on(Qb.KEY_DOWN,(function(t){e.emit(Kb.KEY_DOWN,t)})),xD.on(Qb.KEY_PRESSING,(function(t){e.emit(Kb.KEY_DOWN,t)})),xD.on(Qb.KEY_UP,(function(t){e.emit(Kb.KEY_UP,t)})),xD.on(Qb.DEVICEMOTION,(function(t){e.emit(Kb.DEVICEMOTION,t)})),e}return Z(n,[{key:"setAccelerometerEnabled",value:function(e){xD.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){xD.setAccelerometerInterval(e)}},{key:"on",value:function(e,t,i,r){return he(ne(n.prototype),"on",this).call(this,e,t,i,r),t}},{key:"off",value:function(e,t,i){he(ne(n.prototype),"off",this).call(this,e,t,i)}}]),n}(lu));SD.EventType=Kb,c.SystemEvent=SD;var TD,ED=e("systemEvent",new SD);c.systemEvent=ED,F(Kb,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),F(JI,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:SD.EventType,targetName:"SystemEvent.EventType"}]),U(JI,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),F(tD,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_".concat(e),target:SD.EventType,targetName:"SystemEvent.EventType"}}))),F(tD,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:SD.EventType,targetName:"SystemEvent.EventType"}]),U(tD.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),F(iD,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:SD.EventType,targetName:"SystemEvent.EventType"}]),F(iD,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:SD.EventType,targetName:"SystemEvent.EventType"}]),F(iD,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:SD.EventType,targetName:"SystemEvent.EventType"}]),F(iD,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:SD.EventType,targetName:"SystemEvent.EventType"}]),U(iD.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),F(iD.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:iD,targetName:"EventTouch"}]),U(St.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),U(St.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),U(St.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),U(St.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),U(St,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),F(bC.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),F(tb.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new ri),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new hi),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),z(ZI.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),z(tb.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),F(lC.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),z(jd,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),F(jd,"Layers",[{name:"Default",newName:"DEFAULT",target:jd.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:jd.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:jd.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:jd.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:jd.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:jd.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:jd.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:jd.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:jd,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:jd,targetName:"Layers"}]),z(jd.Enum,"Layers.Enum",[{name:"ALWAYS"}]),z(jd.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var CD,AD,bD,wD,RD=Tl.Flags.HideInHierarchy,PD=Tl.Flags.DontSave,ID=e("PrivateNode",Cc("cc.PrivateNode")(TD=function(e){te(n,e);var t=le(n);function n(e){var i;return K(this,n),P(12003,(i=t.call(this,e)).name),i.hideFlags|=PD|RD,i}return n}(tb))||TD);F(Kb,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:tb.EventType,targetName:"Node.EventType"}}))),F(tb.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:SD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:SD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:SD.EventType,targetName:"SystemEvent.EventType"}]),c.PrivateNode=ID;var DD=e("Scene",Cc("cc.Scene")((xe((AD=function(e){te(n,e);var t=le(n);function n(e){var i;return K(this,n),ye(i=t.call(this,e),"autoReleaseAssets",bD,se(i)),ye(i,"_globals",wD,se(i)),i.dependAssets=null,i._renderScene=null,i._inited=void 0,i._prefabSyncedInLiveReload=!1,i._pos=zn.ZERO,i._rot=qn.IDENTITY,i._scale=zn.ONE,i._mat=ei.IDENTITY,i._dirtyFlags=0,i._lpos=zn.ZERO,i._lrot=qn.IDENTITY,i._lscale=zn.ONE,i._activeInHierarchy=!1,c.director&&c.director.root&&(i._renderScene=c.director.root.createScene({})),i._inited=!c.game||!c.game._isCloning,i._init(),i}return Z(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"_updateScene",value:function(){this._scene=this}},{key:"native",get:function(){return this._nativeObj}},{key:"_init",value:function(){}},{key:"destroy",value:function(){var e=Tl.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&c.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e}},{key:"addComponent",value:function(){throw new Error(k(3822))}},{key:"_onHierarchyChanged",value:function(){}},{key:"_onBatchCreated",value:function(e){he(ne(n.prototype),"_onBatchCreated",this).call(this,e);for(var t=this._children.length,i=0;i<t;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)}},{key:"getPosition",value:function(e){return zn.copy(e||new zn,zn.ZERO)}},{key:"getRotation",value:function(e){return qn.copy(e||new qn,qn.IDENTITY)}},{key:"getScale",value:function(e){return zn.copy(e||new zn,zn.ONE)}},{key:"getWorldPosition",value:function(e){return zn.copy(e||new zn,zn.ZERO)}},{key:"getWorldRotation",value:function(e){return qn.copy(e||new qn,qn.IDENTITY)}},{key:"getWorldScale",value:function(e){return zn.copy(e||new zn,zn.ONE)}},{key:"getWorldMatrix",value:function(e){return ei.copy(e||new ei,ei.IDENTITY)}},{key:"getWorldRS",value:function(e){return ei.copy(e||new ei,ei.IDENTITY)}},{key:"getWorldRT",value:function(e){return ei.copy(e||new ei,ei.IDENTITY)}},{key:"position",get:function(){return zn.ZERO}},{key:"worldPosition",get:function(){return zn.ZERO}},{key:"rotation",get:function(){return qn.IDENTITY}},{key:"worldRotation",get:function(){return qn.IDENTITY}},{key:"scale",get:function(){return zn.ONE}},{key:"worldScale",get:function(){return zn.ONE}},{key:"eulerAngles",get:function(){return zn.ZERO}},{key:"worldMatrix",get:function(){return ei.IDENTITY}},{key:"updateWorldTransform",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(yb(this),vb(this),this._onBatchCreated(false),this._inited=!0),this.walk(bC._setScene)}},{key:"_activate",value:function(e){e=!1!==e,c.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()}}]),n}(bC)).prototype,"globals",[Gc],Object.getOwnPropertyDescriptor(AD.prototype,"globals"),AD.prototype),bD=xe(AD.prototype,"autoReleaseAssets",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wD=xe(AD.prototype,"_globals",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ZI}}),CD=AD))||CD);function OD(e,t){if(!t){var n=c.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}c.Scene=DD,c.find=OD;var ND=ft.fastRemoveAt,MD=Tl.Flags.IsStartCalled,kD=Tl.Flags.IsOnEnableCalled;function LD(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,a=e.length-1,o=a>>>1;r<=a;o=r+a>>>1){var s=e[o],c=s.constructor._executionOrder;if(c>n)a=o-1;else if(c<n)r=o+1;else{var l=s._id;if(l>i)a=o-1;else{if(!(l<i))return o;r=o+1}}}return~r}function BD(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}Tl.Flags.IsEditorOnEnableCalled;var FD=function e(t){K(this,e),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var n=Se;this._zero=new n([]),this._neg=new n([]),this._pos=new n([]),this._invoke=t};function zD(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}FD.stableRemoveInactive=BD;var UD=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){BD(this._zero,e),BD(this._neg,e),BD(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;e.array.length>0&&(e.array.sort(zD),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(zD),this._invoke(t),t.array.length=0)}}]),n}(FD),GD=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=LD(n,e);i<0&&n.splice(~i,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=LD(n.array,e);i>=0&&n.removeAt(i)}}},{key:"invoke",value:function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)}}]),n}(FD);function HD(e,t,n){var i="".concat("var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];").concat(e,"}"),r=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,r){try{t(i,r)}catch(t){c._throw(t);var a=i.array;for(n&&(a[i.i]._objFlags|=n),++i.i;i.i<a.length;++i.i)try{e(a[i.i],r)}catch(e){c._throw(e),n&&(a[i.i]._objFlags|=n)}}}}(Function("c","dt",e),r,n)}var VD=HD("c.start();c._objFlags|=".concat(MD),!1,MD),jD=HD("c.update(dt)",!0),WD=HD("c.lateUpdate(dt)",!0),qD=function(e){var t=c.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i))}},XD=function(){function e(){K(this,e),this._deferredComps=[],this.unscheduleAll()}return Z(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new UD(VD),this.updateInvoker=new GD(jD),this.lateUpdateInvoker=new GD(WD),this._updating=!1}},{key:"_onEnabled",value:function(e){c.director.getScheduler().resumeTarget(e),e._objFlags|=kD,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){c.director.getScheduler().pauseTarget(e),e._objFlags&=~kD;var t=this._deferredComps.indexOf(e);t>=0?ND(this._deferredComps,t):(!e.start||e._objFlags&MD||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&kD)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&kD&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()}},{key:"_startForNewComps",value:function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}},{key:"_scheduleImmediate",value:function(e){"function"!=typeof e.start||e._objFlags&MD||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0}}]),e}(),YD=Tl.Flags.IsPreloadStarted,KD=Tl.Flags.IsOnLoadStarted,QD=Tl.Flags.IsOnLoadCalled,ZD=Tl.Flags.Deactivating,JD=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){FD.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),n}(FD),$D=HD("c.__preload();"),eO=HD("c.onLoad();c._objFlags|=".concat(QD),!1,QD),tO=new _t(4);function nO(e,t,n){D(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):ft.removeAt(e._components,n)}tO.get=function(){var e=this._get()||{preload:new JD($D),onLoad:new UD(eO),onEnable:new UD(qD)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var iO,rO,aO,oO,sO,cO,lO,uO,hO=e("NodeActivator",function(){function e(){K(this,e),this.resetComp=void 0,this.reset()}return Z(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var n=tO.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),tO.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=ge(this._activatingStack);!(i=r()).done;){var a=i.value;a.preload.cancelInactive(YD),a.onLoad.cancelInactive(KD),a.onEnable.cancelInactive()}}e.emit($E.ACTIVE_IN_HIERARCHY_CHANGED,e)}},{key:"activateComp",value:function(e,t,n,i){if(Cl(e,!0)&&(e._objFlags&YD||(e._objFlags|=YD,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&KD||(e._objFlags|=KD,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=QD):e._objFlags|=QD),e._enabled)){if(!e.node._activeInHierarchy)return;c.director._compScheduler.enableComp(e,i)}}},{key:"destroyComp",value:function(e){c.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&QD&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,n,i){if(e._objFlags&ZD)D(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,a=0;a<r;++a){var o=e._components[a];o instanceof c.Component?this.activateComp(o,t,n,i):(nO(e,o,a),--a,--r)}for(var s=0,l=e._children.length;s<l;++s){var u=e._children[s];u._active&&this._activateNodeRecursively(u,t,n,i)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=ZD,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(c.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~ZD)}for(var r=0,a=e._children.length;r<a;++r){var o=e._children[r];if(o._activeInHierarchy&&(this._deactivateNodeRecursively(o),e._activeInHierarchy))return void(e._objFlags&=~ZD)}e._onPostActivated(!1),e._objFlags&=~ZD}}]),e}()),_O=e("SceneAsset",Cc("cc.SceneAsset")((oO=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"scene",aO,se(e)),e}return Z(n,[{key:"initDefault",value:function(e){he(ne(n.prototype),"initDefault",this).call(this,e),this.scene=new DD("New Scene")}},{key:"validate",value:function(){return!!this.scene}}]),n}(Uu),aO=xe((rO=oO).prototype,"scene",[Gc,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iO=rO))||iO);c.SceneAsset=_O;var fO,dO,pO,mO,vO=e("TextAsset",Cc("cc.TextAsset")((uO=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"text",lO,se(e)),e}return Z(n,[{key:"toString",value:function(){return this.text}}]),n}(Uu),lO=xe((cO=uO).prototype,"text",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sO=cO))||sO);c.TextAsset=vO;var gO=e("JsonAsset",Cc("cc.JsonAsset")((mO=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"json",pO,se(e)),e}return n}(Uu),pO=xe((dO=mO).prototype,"json",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fO=dO))||fO);c.JsonAsset=gO;var yO,xO,SO,TO,EO,CO,AO,bO,wO,RO,PO,IO,DO,OO,NO,MO,kO,LO,BO,FO,zO,UO,GO,HO,VO,jO,WO,qO,XO,YO,KO,QO,ZO,JO,$O,eN,tN,nN,iN=function(){function e(){K(this,e),this.fog=new kE,this.ambient=new lT,this.skybox=new PT,this.shadows=new Og,this.octree=new hT,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return Z(e,[{key:"_init",value:function(){}},{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(Zy.ATTACHMENT_SCALE_CAHNGED,e))}},{key:"activate",value:function(e,t){return this._device=e,this._pipeline=t,this.initOcclusionQuery(),!0}},{key:"initOcclusionQuery",value:function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new gg;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}}},{key:"getOcclusionQueryPass",value:function(){return this._occlusionQueryMaterial.passes[0]}},{key:"onGlobalPipelineStateChanged",value:function(){}},{key:"destroy",value:function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null}},{key:"_createOcclusionQueryIA",value:function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),a=Uint16Array.BYTES_PER_ELEMENT,o=36*a;this._occlusionQueryIndicesBuffer=e.createBuffer(new Tr(bi.INDEX|bi.TRANSFER_DST,Pi.DEVICE,o,a)),this._occlusionQueryIndicesBuffer.update(r);var s=[new zr("a_position",Ei.RGB32F)],c=new Gr(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)}}]),e}(),rN=e("ForwardPipeline",(yO=Cc("ForwardPipeline"),xO=rl([ZS]),SO=Zc(),yO((AO=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"renderTextures",CO,se(e)),e._postRenderPass=null,e}return Z(n,[{key:"postRenderPass",get:function(){return this._postRenderPass}},{key:"initialize",value:function(e){if(he(ne(n.prototype),"initialize",this).call(this,e),0===this._flows.length){var t=new DE;t.initialize(DE.initInfo),this._flows.push(t);var i=new fE;i.initialize(fE.initInfo),this._flows.push(i)}return!0}},{key:"activate",value:function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new iN,!(!he(ne(n.prototype),"activate",this).call(this,e)||!this._activeRenderer(e)&&(D(2402),1))}},{key:"_ensureEnoughSize",value:function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)}},{key:"destroy",value:function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();return this._commandBuffers.length=0,he(ne(n.prototype),"destroy",this).call(this)}},{key:"_activeRenderer",value:function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(lp,t),this._descriptorSet.bindTexture(lp,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(gp,t),this._descriptorSet.bindTexture(gp,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0}},{key:"_destroyUBOs",value:function(){this._descriptorSet&&(this._descriptorSet.getBuffer(op.BINDING).destroy(),this._descriptorSet.getBuffer(cp.BINDING).destroy(),this._descriptorSet.getBuffer(sp.BINDING).destroy(),this._descriptorSet.getTexture(lp).destroy(),this._descriptorSet.getTexture(gp).destroy())}}]),n}(yx),CO=xe((EO=AO).prototype,"renderTextures",[xO,Ic,SO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TO=EO))||TO)),aN=[new gr(0,0,0,0),new gr(0,0,0,0),new gr(0,0,0,0)],oN=e("GbufferStage",(bO=Cc("GbufferStage"),wO=rl([eT]),RO=Zc(),bO((NO=OO=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"renderQueues",DO,se(e)),e._renderQueues=[],e._renderArea=new ur,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Hv("default"),e._batchedQueue=new sT,e._instancedQueue=new cT,e}return Z(n,[{key:"initialize",value:function(e){return he(ne(n.prototype),"initialize",this).call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e,t){he(ne(n.prototype),"activate",this).call(this,e,t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=rT(this.renderQueues[i])}},{key:"destroy",value:function(){}},{key:"render",value:function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(aT),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,a=0,o=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(a=0;a<h.length;++a){var _=h[a];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Bv.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,a),this._instancedQueue.queue.add(d)}else if(f===Bv.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,a,c.model),this._batchedQueue.queue.add(p)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(c,r,a)}}}}this._renderQueues.forEach(oT);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&rr.COLOR&&(t.pipelineSceneData.isHDR?$v(aN[0],e.clearColor):(aN[0].x=e.clearColor.x,aN[0].y=e.clearColor.y,aN[0].z=e.clearColor.z)),aN[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,aN,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet(np.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()}}]),n}(Qy),OO.initInfo={name:"GbufferStage",priority:hx.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:QS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:QS.BACK_TO_FRONT,stages:["default"]}]},DO=xe((IO=NO).prototype,"renderQueues",[wO,Ic,RO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PO=IO))||PO)),sN=[new gr(0,0,0,1)],cN=e("LightingStage",(MO=Cc("LightingStage"),kO=rl(gg),LO=Zc(),BO=rl([eT]),FO=Zc(),MO((jO=VO=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this))._deferredLitsBufs=null,e._maxDeferredLights=bp.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new ur,e._uiPhase=void 0,ye(e,"_deferredMaterial",GO,se(e)),ye(e,"renderQueues",HO,se(e)),e._phaseID=Hv("default"),e._renderQueues=[],e._uiPhase=new uE,e}return Z(n,[{key:"initialize",value:function(e){return he(ne(n.prototype),"initialize",this).call(this,e),!0}},{key:"gatherLights",value:function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,a=vo.create(0,0,0,1),o=new Float32Array(4),s=e.exposure,c=0,l=ci.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(vo.set(a,_.position.x,_.position.y,_.position.z,_.range),Ss.sphereFrustum(a,e.frustum)){if(zn.toArray(o,_.position),o[3]=0,this._lightBufferData.set(o,c*l),zn.toArray(o,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;o[0]*=f.x,o[1]*=f.y,o[2]*=f.z}t.pipelineSceneData.isHDR?o[3]=_.luminance*s*this._lightMeterScale:o[3]=_.luminance,this._lightBufferData.set(o,c*l+1*u),o[0]=_.size,o[1]=_.range,o[2]=0,this._lightBufferData.set(o,c*l+2*u)}}for(var d=0;d<r.length&&c<this._maxDeferredLights;d++,++c){var p=r[d];if(vo.set(a,p.position.x,p.position.y,p.position.z,p.range),Ss.sphereFrustum(a,e.frustum)){if(zn.toArray(o,p.position),o[3]=1,this._lightBufferData.set(o,c*l+0*u),zn.toArray(o,p.color),p.useColorTemperature){var m=p.colorTemperatureRGB;o[0]*=m.x,o[1]*=m.y,o[2]*=m.z}t.pipelineSceneData.isHDR?o[3]=p.luminance*s*this._lightMeterScale:o[3]=p.luminance,this._lightBufferData.set(o,c*l+1*u),o[0]=p.size,o[1]=p.range,o[2]=p.spotAngle,this._lightBufferData.set(o,c*l+2*u),zn.toArray(o,p.direction),this._lightBufferData.set(o,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)}},{key:"activate",value:function(e,t){he(ne(n.prototype),"activate",this).call(this,e,t),this._uiPhase.activate(e);for(var i=e.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=rT(this.renderQueues[r]);var a=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;a=Math.ceil(a/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,a,i.capabilities.uboOffsetAlignment));var o=i.createBuffer(new Er(this._deferredLitsBufs,0,a));this._lightBufferData=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT);var s=new Zr(Jd.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Jr(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(Ap.BINDING,o),this._planarQueue=new lE(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)}},{key:"destroy",value:function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null}},{key:"render",value:function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,a=r.renderObjects;this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,i),i.bindDescriptorSet(np.LOCAL,this._descriptorSet,[0]),t.generateRenderArea(e,this._renderArea),e.clearFlag&rr.COLOR&&(sN[0].x=e.clearColor.x,sN[0].y=e.clearColor.y,sN[0].z=e.clearColor.z),sN[0].w=0;var o=t.getPipelineRenderData(),s=o.outputFrameBuffer,c=s.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(c,s,this._renderArea,sN,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet(np.GLOBAL,t.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,o.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,o.sampler);l.descriptorSet.bindTexture(3,o.outputDepth),l.descriptorSet.bindSampler(3,o.sampler),l.descriptorSet.update(),i.bindDescriptorSet(np.MATERIAL,l.descriptorSet);var _=t.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=_&&(f=Qv.getOrCreatePipelineState(n,l,u,c,_)),null!=f&&(i.bindPipelineState(f),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(aT);for(var d=0,p=0,m=0,v=0;v<a.length;++v){var g=a[v],y=g.model.subModels;for(d=0;d<y.length;++d){var x=y[d].passes;for(p=0;p<x.length;++p)if(x[p].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,d,p)}}if(a.length>0){this._renderQueues.forEach(oT);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(e,c),i.endRenderPass()}}]),n}(Qy),VO.initInfo={name:"LightingStage",priority:hx.LIGHTING,tag:0},GO=xe((UO=jO).prototype,"_deferredMaterial",[kO,Ic,LO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HO=xe(UO.prototype,"renderQueues",[BO,Ic,FO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zO=UO))||zO)),lN=[new gr(0,0,0,1)],uN=e("PostProcessStage",(WO=Cc("PostProcessStage"),qO=rl(gg),XO=Zc(),YO=rl([eT]),KO=Zc(),WO((tN=eN=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"_postProcessMaterial",JO,se(e)),ye(e,"renderQueues",$O,se(e)),e._renderArea=new ur,e._uiPhase=new uE,e}return Z(n,[{key:"initialize",value:function(e){return he(ne(n.prototype),"initialize",this).call(this,e),!0}},{key:"activate",value:function(e,t){he(ne(n.prototype),"activate",this).call(this,e,t),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var a=e.viewport;this._renderArea.x=a.x*e.window.width,this._renderArea.y=a.y*e.window.height,this._renderArea.width=a.width*e.window.width,this._renderArea.height=a.height*e.window.height;var o=t.getPipelineRenderData(),s=e.window.framebuffer,c=t.getRenderPass(e.clearFlag,s);e.clearFlag&rr.COLOR&&(lN[0].x=e.clearColor.x,lN[0].y=e.clearColor.y,lN[0].z=e.clearColor.z),lN[0].w=e.clearColor.w,r.beginRenderPass(c,s,this._renderArea,lN,e.clearDepth,e.clearStencil),r.bindDescriptorSet(np.GLOBAL,t.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();t.bloomEnabled?l.descriptorSet.bindTexture(0,o.bloom.combineTex):l.descriptorSet.bindTexture(0,o.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,o.sampler),l.descriptorSet.update(),r.bindDescriptorSet(np.MATERIAL,l.descriptorSet);var h=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=Qv.getOrCreatePipelineState(n,l,u,c,h));var f=t.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(r.bindPipelineState(_),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(e,c),hg(n,c,r,t.profiler,e),r.endRenderPass()}}]),n}(Qy),eN.initInfo={name:"PostProcessStage",priority:cx.POST_PROCESS,tag:0},JO=xe((ZO=tN).prototype,"_postProcessMaterial",[qO,Ic,XO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$O=xe(ZO.prototype,"renderQueues",[YO,Ic,KO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QO=ZO))||QO));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(nN||(nN={}));var hN,_N,fN,dN,pN,mN,vN,gN,yN=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._antiAliasing=nN.NONE,e}return Z(n,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new gg;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"onGlobalPipelineStateChanged",value:function(){this.updatePipelinePassInfo()}},{key:"updateBloomPass",value:function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var a=this._bloomMaterial.passes[7+i];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently(),t.push(r.native),n.push(a.native)}var o=this._bloomMaterial.passes[13];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently()}}},{key:"updatePostProcessPass",value:function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}}},{key:"initPipelinePassInfo",value:function(){var e=new gg;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new gg;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new gg;r._uuid="builtin-post-process-material",St.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=nN.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var a=0;a<r.passes.length;++a)r.passes[a].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}},{key:"updatePipelinePassInfo",value:function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()}},{key:"activate",value:function(e,t){return he(ne(n.prototype),"activate",this).call(this,e,t),this.initPipelinePassInfo(),!0}},{key:"updateDeferredPassInfo",value:function(){this.updateDeferredLightPass()}},{key:"updateDeferredLightPass",value:function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}}}]),n}(iN),xN=[new gr(0,0,0,1)],SN=function e(){K(this,e)};SN.SIZE=4*(SN.COUNT=4+(SN.TEXTURE_SIZE_OFFSET=0));var TN,EN,CN,AN,bN,wN,RN,PN,IN,DN,ON=e("BloomStage",(hN=Cc("BloomStage"),_N=rl(gg),fN=Zc(),hN((gN=vN=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this)).threshold=1,e.intensity=.8,e.iterations=2,ye(e,"_bloomMaterial",mN,se(e)),e._renderArea=new ur,e._bloomUBO=[],e}return Z(n,[{key:"initialize",value:function(e){return he(ne(n.prototype),"initialize",this).call(this,e),!0}},{key:"activate",value:function(e,t){he(ne(n.prototype),"activate",this).call(this,e,t),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,SN.SIZE,SN.SIZE));e.clearFlag&rr.COLOR&&(xN[0].x=e.clearColor.x,xN[0].y=e.clearColor.y,xN[0].z=e.clearColor.z),xN[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}}},{key:"_prefilterPass",value:function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),a=r.bloom,o=new Float32Array(SN.COUNT);o[SN.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],o),n.beginRenderPass(a.renderPass,a.prefilterFramebuffer,this._renderArea,xN,0,0),n.bindDescriptorSet(np.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,a.sampler),i.descriptorSet.update(),n.bindDescriptorSet(np.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=Qv.getOrCreatePipelineState(t.device,i,l,a.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()}},{key:"_downsamplePass",value:function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,a=new Float32Array(SN.COUNT),o=0;o<this.iterations;++o){a[SN.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[SN.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[o+1],a),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[o],this._renderArea,xN,0,0);var s=i.passes[1+o],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[o+1]),0===o?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[o-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(np.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=Qv.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}}},{key:"_upsamplePass",value:function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,a=new Float32Array(SN.COUNT),o=0;o<this.iterations;++o){var s=o+6+1;a[SN.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[SN.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],a),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-o],this._renderArea,xN,0,0);var c=r.passes[7+o],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===o?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-o]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(np.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=Qv.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}}},{key:"_combinePass",value:function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),a=r.bloom,o=new Float32Array(SN.COUNT);o[SN.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],o),n.beginRenderPass(a.renderPass,a.combineFramebuffer,this._renderArea,xN,0,0),n.bindDescriptorSet(np.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,a.upsampleTexs[0]),s.descriptorSet.bindSampler(1,a.sampler),s.descriptorSet.bindSampler(2,a.sampler),s.descriptorSet.update(),n.bindDescriptorSet(np.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=Qv.getOrCreatePipelineState(t.device,s,u,a.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()}}]),n}(Qy),vN.initInfo={name:"BloomStage",priority:cx.BLOOM,tag:0},mN=xe((pN=gN).prototype,"_bloomMaterial",[_N,Ic,fN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dN=pN))||dN)),NN=e("MainFlow",Cc("MainFlow")((CN=EN=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"initialize",value:function(e){if(he(ne(n.prototype),"initialize",this).call(this,e),0===this._stages.length){var t=new oN;t.initialize(oN.initInfo),this._stages.push(t);var i=new cN;i.initialize(cN.initInfo),this._stages.push(i);var r=new ON;r.initialize(ON.initInfo),this._stages.push(r);var a=new uN;a.initialize(uN.initInfo),this._stages.push(a)}return!0}},{key:"activate",value:function(e){he(ne(n.prototype),"activate",this).call(this,e)}},{key:"render",value:function(e){he(ne(n.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){he(ne(n.prototype),"destroy",this).call(this)}}]),n}(Jy),EN.initInfo={name:Xd,priority:_x.MAIN,stages:[]},TN=CN))||TN),MN=function(){te(t,(function e(){K(this,e),this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null}));var e=le(t);function t(){var n;K(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=e.call.apply(e,[this].concat(r))).gbufferFrameBuffer=null,n.gbufferRenderTargets=[],n}return t}(),kN=e("DeferredPipeline",(AN=Cc("DeferredPipeline"),bN=rl([ZS]),wN=Zc(),AN((DN=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gbufferRenderPass=null,e._lightingRenderPass=null,ye(e,"renderTextures",IN,se(e)),e}return Z(n,[{key:"initialize",value:function(e){if(he(ne(n.prototype),"initialize",this).call(this,e),0===this._flows.length){var t=new DE;t.initialize(DE.initInfo),this._flows.push(t);var i=new NN;i.initialize(NN.initInfo),this._flows.push(i)}return!0}},{key:"activate",value:function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new yN,!(!he(ne(n.prototype),"activate",this).call(this,e)||!this._activeRenderer(e)&&(D(2402),1))}},{key:"destroy",value:function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();return this._commandBuffers.length=0,he(ne(n.prototype),"destroy",this).call(this)}},{key:"getPipelineRenderData",value:function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData}},{key:"_activeRenderer",value:function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(lp,n),this._descriptorSet.bindTexture(lp,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(gp,n),this._descriptorSet.bindTexture(gp,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new gx;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var a=new Hr;a.format=Ei.RGBA16F,a.loadOp=Vi.CLEAR,a.storeOp=ji.STORE;var o=new Hr;o.format=Ei.RGBA16F,o.loadOp=Vi.CLEAR,o.storeOp=ji.STORE;var s=new Hr;s.format=Ei.RGBA16F,s.loadOp=Vi.CLEAR,s.storeOp=ji.STORE;var c=new Vr;c.format=Ei.DEPTH_STENCIL,c.depthLoadOp=Vi.CLEAR,c.depthStoreOp=ji.STORE,c.stencilLoadOp=Vi.CLEAR,c.stencilStoreOp=ji.STORE;var l=new qr([a,o,s],c);this._gbufferRenderPass=t.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Hr;u.format=Ei.RGBA8,u.loadOp=Vi.CLEAR,u.storeOp=ji.STORE,u.endAccesses=[Wi.COLOR_ATTACHMENT_WRITE];var h=new Vr;h.format=Ei.DEPTH_STENCIL,h.depthLoadOp=Vi.LOAD,h.depthStoreOp=ji.DISCARD,h.stencilLoadOp=Vi.LOAD,h.stencilStoreOp=ji.DISCARD,h.beginAccesses=[Wi.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Wi.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new qr([u],h);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0}},{key:"_destroyUBOs",value:function(){this._descriptorSet&&(this._descriptorSet.getBuffer(op.BINDING).destroy(),this._descriptorSet.getBuffer(cp.BINDING).destroy(),this._descriptorSet.getBuffer(sp.BINDING).destroy(),this._descriptorSet.getTexture(lp).destroy(),this._descriptorSet.getTexture(gp).destroy())}},{key:"_destroyDeferredData",value:function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null}},{key:"_ensureEnoughSize",value:function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())}},{key:"_generateDeferredRenderData",value:function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new MN,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(t.createTexture(new wr(Ii.TEX2D,Di.COLOR_ATTACHMENT|Di.SAMPLED,Ei.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new wr(Ii.TEX2D,Di.DEPTH_STENCIL_ATTACHMENT|Di.SAMPLED,Ei.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new Kr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new wr(Ii.TEX2D,Di.COLOR_ATTACHMENT|Di.SAMPLED,Ei.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new Kr(this._lightingRenderPass,n.outputRenderTargets,null)),this.on(Zy.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler}}]),n}(yx),IN=xe((PN=DN).prototype,"renderTextures",[bN,Ic,wN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RN=PN))||RN));function LN(){var e=new rN;return e.initialize({flows:[]}),e}var BN=new ri,FN=function(){function e(){K(this,e),this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return Z(e,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}},{key:"pauseRendering",value:function(){this.isPause=!0}},{key:"resumeRendering",value:function(){this.isPause=!1}},{key:"main",value:function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new gr(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new gr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{c.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?c.view.setDesignResolutionSize(n.width,n.height,n.policy):c.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,c.game.once(c.Game.EVENT_GAME_INITED,(function(){c.director._lateUpdate=performance.now()}),c.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else x("RENDER ROOT IS NULL.")}},{key:"setOnFinish",value:function(t){if(this._directCall&&t)return e._ins=void 0,void t();this.callBack=t}},{key:"_tryToStart",value:function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),c.game.resume())}},{key:"preInit",value:function(){var e=this.settings.clearColor;this.clearColors=[new gr(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new ur(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,a=4*r;this.vertexBuffers=t.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.DEVICE,a,r)),this.vertexBuffers.update(i);var o=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new Tr(bi.INDEX|bi.TRANSFER_DST,Pi.DEVICE,c,s)),this.indicesBuffers.update(o);var l=[new zr("a_position",Ei.RG32F),new zr("a_texCoord",Ei.RG32F)],u=new Gr(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new ei,ei.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)}},{key:"init",value:function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),c.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,a=e.swapchain;ei.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,a.surfaceTransform);var o=a.width,s=a.height,c=o<s?o:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=E_(yn(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,_=e.logoTexture.height,f=c*i.displayRatio,d=f*h/_,p=f;if(a.surfaceTransform!==Si.ROTATE_90&&a.surfaceTransform!==Si.ROTATE_270||(d=f*o/s,p=f*_/h*s/o),e.logoMat.setProperty("resolution",BN.set(o,s),0),e.logoMat.setProperty("scale",BN.set(d,p),0),e.logoMat.setProperty("translate",BN.set(.5*o,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;a.surfaceTransform!==Si.ROTATE_90&&a.surfaceTransform!==Si.ROTATE_270||(g=.5*m,y=m*o/s*.5),e.watermarkMat.setProperty("resolution",BN.set(o,s),0),e.watermarkMat.setProperty("scale",BN.set(g,y),0),e.watermarkMat.setProperty("translate",BN.set(.5*o,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))}},{key:"hide",value:function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))}},{key:"initLogo",value:function(){var e=this.device;this.logoMat=new gg,this.logoMat.initialize({effectName:"splash-screen"});var t=new Pr;t.addressU=Li.CLAMP,t.addressV=Li.CLAMP,t.addressW=Li.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new wr(Ii.TEX2D,Di.SAMPLED|Di.TRANSFER_DST,Ei.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var a=new mr;a.texExtent.width=this.logoImage.width,a.texExtent.height=this.logoImage.height,a.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[a])}},{key:"initWarterMark",value:function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width="".concat(e.width),e.style.height="".concat(e.height);var t=e.getContext("2d");t.font="".concat(18,"px Arial"),t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new mr;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new wr(Ii.TEX2D,Di.SAMPLED|Di.TRANSFER_DST,Ei.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new gg,this.watermarkMat.initialize({effectName:"splash-screen"});var a=this.watermarkMat.passes[0],o=a.getBinding("mainTexture");a.bindTexture(o,this.watermarkTexture),a.descriptorSet.update()}},{key:"frame",value:function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var a=this.logoMat.passes[0],o=Qv.getOrCreatePipelineState(e,a,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(o),n.bindDescriptorSet(np.MATERIAL,a.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=Qv.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(np.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()}},{key:"destroy",value:function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,e._ins=void 0}}],[{key:"instance",get:function(){return e._ins||(e._ins=new e),e._ins}}]),e}();FN._ins=void 0,c.internal.SplashScreen=FN;var zN=e("System",function(){function e(){K(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return Z(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}},{key:"init",value:function(){}},{key:"update",value:function(){}},{key:"postUpdate",value:function(){}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}());zN.Priority=mt({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var UN=new we("Scheduler"),GN=function e(t,n,i,r){K(this,e),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=n,this.paused=i,this.markedForDeletion=r};GN.get=function(e,t,n,i){var r=GN._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new GN(e,t,n,i),r},GN.put=function(e){GN._listEntries.length<20&&(e.target=null,GN._listEntries.push(e))},GN._listEntries=[];var HN=function e(t,n,i,r){K(this,e),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=n,this.target=i,this.callback=r};HN.get=function(e,t,n,i){var r=HN._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new HN(e,t,n,i),r},HN.put=function(e){HN._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,HN._hashUpdateEntries.push(e))},HN._hashUpdateEntries=[];var VN=function e(t,n,i,r,a,o){K(this,e),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=n,this.timerIndex=i,this.currentTimer=r,this.currentTimerSalvaged=a,this.paused=o};VN.get=function(e,t,n,i,r,a){var o=VN._hashTimerEntries.pop();return o?(o.timers=e,o.target=t,o.timerIndex=n,o.currentTimer=i,o.currentTimerSalvaged=r,o.paused=a):o=new VN(e,t,n,i,r,a),o},VN.put=function(e){VN._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,VN._hashTimerEntries.push(e))},VN._hashTimerEntries=[];var jN=function(){function e(){K(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return Z(e,[{key:"initWithCallback",value:function(e,t,n,i,r,a){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=i,this._delay=a,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===c.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();jN._timers=[],jN.get=function(){return jN._timers.pop()||new jN},jN.put=function(e){jN._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,jN._timers.push(e))};var WN,qN=e("Scheduler",function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this))._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=ze(!0),e._hashForTimers=ze(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return Z(n,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,n,i,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var o=this._arrayForTimers;for(t=0;t<o.length;t++){if(a=o[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,n,i,r,a){if("function"!=typeof e){var o=e;e=t,t=o}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!i,i=c.macro.REPEAT_FOREVER,r=0),M(t,1502);var s=t.uuid||t.id;if(s){var l,u,h=this._hashForTimers[s];if(h?h.paused!==a&&P(1511):(h=VN.get(null,t,0,null,null,a),this._arrayForTimers.push(h),this._hashForTimers[s]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&e===l._callback)return w(1507,l.getInterval(),n),void(l._interval=n);(l=jN.get()).initWithCallback(this,e,t,n,i,r),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else D(1510)}},{key:"scheduleUpdate",value:function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return w(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var a,o=GN.get(e,t,n,!1);0===t?(a=this._updates0List,this._appendIn(a,o)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,o,t)),this._hashForUpdates[i]=HN.get(a,o,e,null)}else D(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,a=0,o=r.length;a<o;a++){var s=r[a];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(a,1),jN.put(s),i.timerIndex>=a&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else D(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else D(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,a=i.length;r<a;r++)jN.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else D(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(zN.Priority.SCHEDULER)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){M(e,1508),M(t,1509);var n=t.uuid||t.id;if(!n)return D(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,a=0;a<r.length;++a)if(e===r[a]._callback)return!0;return!1}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(zN.Priority.SCHEDULER)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,n,i,r,a=[],o=this._arrayForTimers;for(n=0,i=o.length;n<i;n++)(t=o[n])&&(t.paused=!0,a.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,a.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){M(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else D(1510)}},{key:"resumeTarget",value:function(e){M(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else D(1510)}},{key:"isTargetPaused",value:function(e){M(e,1505);var t=e.uuid||e.id;if(!t)return D(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}VN.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,a=0,o=i.length;a<o;a++)if(i[a]===r){i.splice(a,1);break}delete this._hashForUpdates[t],GN.put(r),HN.put(n)}}},{key:"_priorityIn",value:function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}],[{key:"enableForTarget",value:function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?P(1513):e.id=UN.getNewId())}}]),n}(zN));qN.ID="scheduler",c.Scheduler=qN;var XN=(J(WN={},lh.PORTRAIT,Si.IDENTITY),J(WN,lh.LANDSCAPE_RIGHT,Si.ROTATE_90),J(WN,lh.PORTRAIT_UPSIDE_DOWN,Si.ROTATE_180),J(WN,lh.LANDSCAPE_LEFT,Si.ROTATE_270),WN),YN=function(){function e(){K(this,e),this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}return Z(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}},{key:"initialize",value:function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new wr(Ii.TEX2D,Di.COLOR_ATTACHMENT|Di.SAMPLED|Di.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==Ei.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new wr(Ii.TEX2D,Di.DEPTH_STENCIL_ATTACHMENT|Di.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new Kr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0}},{key:"destroy",value:function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()}},{key:"resize",value:function(e,t){if(this._swapchain)this._swapchain.resize(e,t,XN[dh.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new Kr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=ge(this._cameras);!(i=r()).done;)i.value.resize(e,t)}},{key:"extractRenderCameras",value:function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}}},{key:"attachCamera",value:function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()}},{key:"detachCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)}},{key:"clearCameras",value:function(){this._cameras.length=0}},{key:"sortCameras",value:function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))}},{key:"_init",value:function(){}},{key:"_destroy",value:function(){}},{key:"_setSwapchain",value:function(e){this._swapchain=e}},{key:"_setFrameBuffer",value:function(e){this._framebuffer=e}}],[{key:"registerCreateFunc",value:function(t){t._createWindowFun=function(t){return new e(t)}}}]),e}(),KN=function(){function e(t){var n=this;K(this,e),this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=c.internal.DataPoolManager&&new c.internal.DataPoolManager(t),yT.registerCreateFunc(this),YN.registerCreateFunc(this),this._cameraPool=new Jl((function(){return new wg(n._device)}),4,(function(e){return e.destroy()}))}return Z(e,[{key:"_init",value:function(){}},{key:"_destroy",value:function(){}},{key:"_setCumulativeTime",value:function(e){this._cumulativeTime+=e}},{key:"_setFrameTime",value:function(e){this._frameTime=e}},{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}},{key:"initialize",value:function(){this._init();var e=c.game._swapchain,t=new Hr;t.format=e.colorTexture.format;var n=new Vr;n.format=e.depthStencilTexture.format,n.depthStoreOp=ji.DISCARD,n.stencilStoreOp=ji.DISCARD;var i=new qr([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:i,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(Gv.initBuiltinRes(this._device))}},{key:"destroy",value:function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()}},{key:"resize",value:function(e,t){for(var n,i=ge(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}}},{key:"setRenderPipeline",value:function(e){e instanceof kN&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=LN(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(Ti.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=c.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&c.internal.Batcher2D&&(this._batcher=new c.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._setCumulativeTime(0)}},{key:"frameMove",value:function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([c.game._swapchain]);var a=this._scenes,o=c.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<a.length;s++)a[s].update(o);c.director.emit(c.Director.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()}},{key:"createWindow",value:function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){for(var e,t=ge(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){for(var e,t=ge(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0}},{key:"createModel",value:function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new Jl((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n}},{key:"destroyModel",value:function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):P(1300,e.constructor.name),e.destroy()}},{key:"createCamera",value:function(){return this._cameraPool.alloc()}},{key:"createLight",value:function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new Jl((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n}},{key:"destroyLight",value:function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case dy.SPHERE:e.scene.removeSphereLight(e);break;case dy.SPOT:e.scene.removeSpotLight(e)}e.destroy()}}]),e}();c.Root=KN;var QN=e("Game",function(e){te(i,e);var t=le(i);function i(){var e,n,r;K(this,i);for(var a=arguments.length,o=new Array(a),s=0;s<a;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))).frame=null,r.container=null,r.canvas=null,r.renderType=-1,r.eventTargetOn=he((e=se(r),ne(i.prototype)),"on",e),r.eventTargetOnce=he((n=se(r),ne(i.prototype)),"once",n),r.config={},r.onStart=null,r.frameTime=1e3/60,r.collisionMatrix=[],r.groupList=[],r._persistRootNodes={},r._gfxDevice=null,r._swapchain=null,r._configLoaded=!1,r._isCloning=!1,r._inited=!1,r._engineInited=!1,r._rendererInitialized=!1,r._paused=!0,r._frameRate=60,r._intervalId=0,r._initTime=0,r._startTime=0,r._deltaTime=0,r._onEngineInitedCallback=[],r}return Z(i,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}},{key:"setFrameRate",value:function(e){this.frameRate=e}},{key:"getFrameRate",value:function(){return this.frameRate}},{key:"step",value:function(){c.director.tick(this.frameTime/1e3)}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}},{key:"resume",value:function(){this._paused&&(xD._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){var e=this;return new Promise((function(e){return c.director.once(c.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var t in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[t]);return c.director.getScene().destroy(),c.Object._deferredDestroy(),c.director.reset(),c.profiler.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(i.EVENT_RESTART)}))}))}},{key:"end",value:function(){Eu.close()}},{key:"on",value:function(e,t,n,r){return(this._engineInited&&e===i.EVENT_ENGINE_INITED||this._inited&&e===i.EVENT_GAME_INITED||this._rendererInitialized&&e===i.EVENT_RENDERER_INITED)&&t.call(n),this.eventTargetOn(e,t,n,r)}},{key:"once",value:function(e,t,n){return this._engineInited&&e===i.EVENT_ENGINE_INITED?t.call(n):this.eventTargetOnce(e,t,n)}},{key:"init",value:function(e){var t=this;if(this._initConfig(e),mh._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&c.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,r=0;r<i.length;r++){var a=i[r],o=n(a.value);jd.addLayer(a.name,o)}return this._initEngine().then((function(){return t._initEvents(),c.director.root&&c.director.root.dataPoolManager&&c.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))}},{key:"run",value:function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,vu.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))}},{key:"addPersistRootNode",value:function(e){if(c.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=c.director._scene;if(c.isValid(n))if(e.parent){if(!(e.parent instanceof c.Scene))return void P(3801);if(e.parent!==n)return void P(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,c.assetManager._releaseManager._addPersistNodeRef(e)}}else P(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",c.assetManager._releaseManager._removePersistNodeRef(e))}},{key:"isPersistRootNode",value:function(e){return!!e._persistNode}},{key:"onEngineInitedAsync",value:function(e){this._onEngineInitedCallback.push(e)}},{key:"_initEngine",value:function(){var e=this;this._initDevice();var t=c.director;return Promise.resolve(t._init()).then((function(){c.view.init(),g("Cocos Creator v".concat(l)),e.emit(i.EVENT_ENGINE_INITED),e._engineInited=!0,c.internal.dynamicAtlasManager&&(c.internal.dynamicAtlasManager.enabled=!St.CLEANUP_IMAGE_CACHE)})).then((function(){var t=e._onEngineInitedCallback.map((function(e){return e()})).filter(Boolean);return e._onEngineInitedCallback.length=0,Promise.all(t)}))}},{key:"_setAnimFrame",value:function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())}},{key:"_stTime",value:function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_calculateDT",value:function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>i.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime}},{key:"_updateCallback",value:function(){var e,t=this,n=c.director;if(30===this._frameRate){var i=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(i=!i)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e}},{key:"_runMainLoop",value:function(){if(this._inited){var e=this.config,t=c.director;B(!!e.showFPS),t.startAnimation(),this.resume()}}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=O.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,E(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate}},{key:"_determineRenderType",value:function(){var e=this.config,t=parseInt(e.renderMode,10);this.renderType=i.RENDER_TYPE_CANVAS;var n=!1;if(1===t?(this.renderType=i.RENDER_TYPE_CANVAS,n=!0):0===t||2===t?(this.renderType=i.RENDER_TYPE_WEBGL,n=!0):3===t&&(this.renderType=i.RENDER_TYPE_HEADLESS,n=!0),!n)throw new Error(k(3820,t))}},{key:"_initDevice",value:function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===i.RENDER_TYPE_WEBGL){var t=new Sr(ap),n=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||vh.browserType===hu.UC)&&(n=!1);var a=[];n&&c.WebGL2Device&&a.push(c.WebGL2Device),c.WebGLDevice&&a.push(c.WebGLDevice),c.EmptyDevice&&a.push(c.EmptyDevice),Ta.canvas=this.canvas;for(var o=0;o<a.length&&(this._gfxDevice=new a[o],!this._gfxDevice.initialize(t));o++);}else this.renderType===i.RENDER_TYPE_HEADLESS&&c.EmptyDevice&&(this._gfxDevice=new c.EmptyDevice,this._gfxDevice.initialize(new Sr(ap)));if(!this._gfxDevice)return x("can not support canvas rendering in 3D"),void(this.renderType=i.RENDER_TYPE_CANVAS);var s=new xr(this.canvas),l=mh.windowSize;s.width=l.width,s.height=l.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}}},{key:"_initEvents",value:function(){Eu.on("show",this._onShow,this),Eu.on("hide",this._onHide,this)}},{key:"_onHide",value:function(){this.emit(i.EVENT_HIDE),this.pause()}},{key:"_onShow",value:function(){this.emit(i.EVENT_SHOW),this.resume()}},{key:"_setRenderPipelineNShowSplash",value:function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(i.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))}},{key:"_setupRenderPipeline",value:function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){c.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof yx?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){y(n),y("Failed load render pipeline: ".concat(t,", engine failed to initialize, will fallback to default pipeline")),e._setRenderPipeline()})):this._setRenderPipeline()}},{key:"_showSplashScreen",value:function(){if(c.internal.SplashScreen){var e=c.internal.SplashScreen.instance;return e.main(c.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null}},{key:"_setRenderPipeline",value:function(e){c.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(i.EVENT_RENDERER_INITED)}},{key:"_safeEmit",value:function(e){this.emit(e)}}]),i}(lu));QN.EVENT_HIDE="game_on_hide",QN.EVENT_SHOW="game_on_show",QN.EVENT_LOW_MEMORY="game_on_low_memory",QN.EVENT_GAME_INITED="game_inited",QN.EVENT_ENGINE_INITED="engine_inited",QN.EVENT_RENDERER_INITED="renderer_inited",QN.EVENT_RESTART="game_on_restart",QN.RENDER_TYPE_CANVAS=0,QN.RENDER_TYPE_WEBGL=1,QN.RENDER_TYPE_OPENGL=2,QN.RENDER_TYPE_HEADLESS=3,QN.DEBUG_DT_THRESHOLD=1,c.Game=QN;var ZN=e("game",c.game=new QN),JN=e("Director",function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this))._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new qN,e._compScheduler=new XD,e._nodeActivator=new hO,e._systems=[],ZN.once(QN.EVENT_RENDERER_INITED,e._initOnRendererInitialized,se(e)),e}return Z(n,[{key:"calculateDeltaTime",value:function(){}},{key:"end",value:function(){var e=this;this.once(n.EVENT_END_FRAME,(function(){e.purgeDirector()}))}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),c.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),c.assetManager.releaseAll()}},{key:"reset",value:function(){this.purgeDirector(),this.emit(n.EVENT_RESET),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,n){e instanceof _O&&(e=e.scene),M(e instanceof DD,1216),e._load();for(var i=Object.keys(ZN._persistRootNodes).map((function(e){return ZN._persistRootNodes[e]})),r=0;r<i.length;r++){var a=i[r];a.emit(c.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var o=e.uuid===a._originalSceneId&&e.getChildByUuid(a.uuid);if(o){var s=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(a,s)}else a.parent=e}var l=this._scene;c.isValid(l)&&l.destroy(),c.assetManager._releaseManager._autoRelease(l,e,ZN._persistRootNodes),this._scene=null,Tl._deferredDestroy(),t&&t(),this.emit(c.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(c.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,n){var i=this;e instanceof _O&&(e=e.scene),M(e,1205),M(e instanceof DD,1216),e._load(),this.once(c.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(e,t,n)}))}},{key:"loadScene",value:function(e,t,n){var i=this;if(this._loadingScene)return P(1208,e,this._loadingScene),!1;var r=c.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return r?(this.emit(c.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene ".concat(e)),r.loadScene(e,(function(r,a){console.timeEnd("LoadScene ".concat(e)),i._loadingScene="",r?(x(r),t&&t(r)):i.runSceneImmediate(a,n,t)})),!0):(D(1209,e),!1)}},{key:"preloadScene",value:function(e,t,n){var i=c.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(i)i.preloadScene(e,null,t,n);else{var r='Can not preload the scene "'.concat(e,'" because it is not in the build settings.');n&&n(new Error(r)),x("preloadScene: ".concat(r))}}},{key:"resume",value:function(){this._paused&&(this._paused=!1)}},{key:"root",get:function(){return this._root}},{key:"getScene",value:function(){return this._scene}},{key:"getDeltaTime",value:function(){return ZN.deltaTime}},{key:"getTotalTime",value:function(){return ZN.totalTime}},{key:"getCurrentTime",value:function(){return ZN.frameStartTime}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(qN.ID,e,200))}},{key:"registerSystem",value:function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(zN.sortByPriority)}},{key:"unregisterSystem",value:function(e){ft.fastRemove(this._systems,e),this._systems.sort(zN.sortByPriority)}},{key:"getSystem",value:function(e){return this._systems.find((function(t){return t.id===e}))}},{key:"getAnimationManager",value:function(){return this.getSystem(c.AnimationManager.ID)}},{key:"startAnimation",value:function(){this._invalid=!1}},{key:"stopAnimation",value:function(){this._invalid=!0}},{key:"mainLoop",value:function(e){var t;t=ZN._calculateDT(e),this.tick(t)}},{key:"tick",value:function(e){if(!this._invalid){if(this.emit(n.EVENT_BEGIN_FRAME),xD._frameDispatchEvents(),!this._paused){this.emit(n.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(n.EVENT_AFTER_UPDATE),Tl._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(n.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(n.EVENT_AFTER_DRAW),tb.resetHasChangedFlags(),tb.clearNodeArray(),Ql.update(e),this.emit(n.EVENT_END_FRAME),this._totalFrames++}}},{key:"_initOnRendererInitialized",value:function(){this._totalFrames=0,this._paused=!1,this.registerSystem(qN.ID,this._scheduler,200),this.emit(n.EVENT_INIT)}},{key:"_init",value:function(){return this._root=new KN(ZN._gfxDevice),this._root.initialize({}).catch((function(e){return D(1217),Promise.reject(e)}))}}]),n}(lu));JN.EVENT_INIT="director_init",JN.EVENT_RESET="director_reset",JN.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",JN.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",JN.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",JN.EVENT_BEFORE_UPDATE="director_before_update",JN.EVENT_AFTER_UPDATE="director_after_update",JN.EVENT_BEFORE_DRAW="director_before_draw",JN.EVENT_AFTER_DRAW="director_after_draw",JN.EVENT_BEFORE_COMMIT="director_before_commit",JN.EVENT_BEFORE_PHYSICS="director_before_physics",JN.EVENT_AFTER_PHYSICS="director_after_physics",JN.EVENT_BEGIN_FRAME="director_begin_frame",JN.EVENT_END_FRAME="director_end_frame",JN.instance=void 0,c.Director=JN;var $N=e("director",JN.instance=c.director=new JN),eM={};F(eM,"vmath",[{name:"vec2",newName:"Vec2",target:vi,targetName:"math"},{name:"vec3",newName:"Vec3",target:vi,targetName:"math"},{name:"vec4",newName:"Vec4",target:vi,targetName:"math"},{name:"quat",newName:"Quat",target:vi,targetName:"math"},{name:"mat3",newName:"Mat3",target:vi,targetName:"math"},{name:"mat4",newName:"Mat4",target:vi,targetName:"math"},{name:"color4",newName:"Color",target:vi,targetName:"math"},{name:"rect",newName:"Rect",target:vi,targetName:"math"},{name:"approx",newName:"approx",target:vi,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:vi,targetName:"math"},{name:"equals",newName:"equals",target:vi,targetName:"math"},{name:"clamp",newName:"clamp",target:vi,targetName:"math"},{name:"clamp01",newName:"clamp01",target:vi,targetName:"math"},{name:"lerp",newName:"lerp",target:vi,targetName:"math"},{name:"toRadian",newName:"toRadian",target:vi,targetName:"math"},{name:"toDegree",newName:"toDegree",target:vi,targetName:"math"},{name:"random",newName:"random",target:vi,targetName:"math"},{name:"randomRange",newName:"randomRange",target:vi,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:vi,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:vi,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:vi,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:vi,targetName:"math"},{name:"repeat",newName:"repeat",target:vi,targetName:"math"},{name:"pingPong",newName:"pingPong",target:vi,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:vi,targetName:"math"}]),c.vmath=eM,F(qN.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:qN,targetName:"Scheduler"}]),F(qN,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return zN.Priority.SCHEDULER}}]),z(qN,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),F(fT.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),z(fT.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),F(KN.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),U(ZN,"game",[{name:"collisionMatrix"},{name:"groupList"}]),U(JN.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),z(JN.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var tM,nM={topLeft:c.v2(0,0),topRight:c.v2(0,0),top:c.v2(0,0),bottomLeft:c.v2(0,0),bottomRight:c.v2(0,0),bottom:c.v2(0,0),center:c.v2(0,0),left:c.v2(0,0),right:c.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,a=r+n,o=i+t;this.topLeft.x=i,this.topLeft.y=a,this.topRight.x=o,this.topRight.y=a,this.top.x=i+t/2,this.top.y=a,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=o,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=o,this.right.y=r+n/2}};c.visibleRect=nM;var iM=new hi,rM=(J(tM={},St.ORIENTATION_AUTO,lh.AUTO),J(tM,St.ORIENTATION_LANDSCAPE,lh.LANDSCAPE),J(tM,St.ORIENTATION_PORTRAIT,lh.PORTRAIT),tM),aM=e("View",function(e){te(n,e);var t=le(n);function n(){var e;K(this,n),(e=t.call(this))._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var i=oM,r=sM;return e._designResolutionSize=new hi(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new fi(0,0,0,0),e._visibleRect=new fi(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new cM(i.EQUAL_TO_FRAME,r.EXACT_FIT),e._rpShowAll=new cM(i.EQUAL_TO_FRAME,r.SHOW_ALL),e._rpNoBorder=new cM(i.EQUAL_TO_FRAME,r.NO_BORDER),e._rpFixedHeight=new cM(i.EQUAL_TO_FRAME,r.FIXED_HEIGHT),e._rpFixedWidth=new cM(i.EQUAL_TO_FRAME,r.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}return Z(n,[{key:"init",value:function(){var e=mh.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,iM.width=this._visibleRect.width,iM.height=this._visibleRect.height,nM&&nM.init(this._visibleRect),dh.on("window-resize",this._updateAdaptResult,this),dh.on("orientation-change",this._updateAdaptResult,this),dh.on("fullscreen-change",this._updateAdaptResult,this)}},{key:"resizeWithBrowserSize",value:function(e){dh.handleResizeEvent=e}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){dh.orientation=rM[e]}},{key:"adjustViewportMeta",value:function(){}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAutoFullScreen",value:function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&mh.requestFullScreen().catch((function(){})))}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){dh.resolutionScale=1;var n=dh.devicePixelRatio,i=new hi(e*n,t*n);mh.windowSize=i}},{key:"getCanvasSize",value:function(){return mh.windowSize}},{key:"getFrameSize",value:function(){var e=dh.devicePixelRatio,t=mh.windowSize;return t.width/=e,t.height/=e,t}},{key:"setFrameSize",value:function(e,t){var n=dh.devicePixelRatio;mh.windowSize=new hi(e*n,t*n)}},{key:"getVisibleSize",value:function(){return new hi(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return new hi(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return new ri(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return new ri(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"_updateResolutionPolicy",value:function(e){if(e instanceof cM)this._resolutionPolicy=e;else{var t=cM;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}}},{key:"setResolutionPolicy",value:function(e){this._updateResolutionPolicy(e);var t=lM.getDesignResolutionSize();lM.setDesignResolutionSize(t.width,t.height,e)}},{key:"setDesignResolutionSize",value:function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,o=this._visibleRect,s=r.viewport;a.x=s.x,a.y=s.y,a.width=s.width,a.height=s.height,o.x=0,o.y=0,o.width=s.width/this._scaleX,o.height=s.height/this._scaleY}i.postApply(this),iM.width=this._visibleRect.width,iM.height=this._visibleRect.height,nM&&nM.init(this._visibleRect),this.emit("design-resolution-changed")}else D(2200)}},{key:"getDesignResolutionSize",value:function(){return new hi(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,n){document.documentElement.style.width="".concat(e,"px"),document.body.style.width="".concat(e,"px"),document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return dh.devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new ri,r=dh.devicePixelRatio*(e-n.left),a=dh.devicePixelRatio*(n.top+n.height-t);return dh.isFrameRotated?(i.x=mh.windowSize.width-a,i.y=r):(i.x=r,i.y=a),i}},{key:"_convertToUISpace",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_updateAdaptResult",value:function(){var e;c.director.root.resize(mh.windowSize.width,mh.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)}}]),n}(lu));aM.instance=void 0;var oM=function(){function e(){K(this,e),this.name="ContainerStrategy"}return Z(e,[{key:"preApply",value:function(){}},{key:"apply",value:function(){}},{key:"postApply",value:function(){}},{key:"_setupCanvas",value:function(){var e=ZN.canvas;if(e){var t=mh.windowSize;e.width=t.width,e.height=t.height}}}]),e}();oM.EQUAL_TO_FRAME=void 0,oM.PROPORTION_TO_FRAME=void 0;var sM=function(){function e(){K(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return Z(e,[{key:"preApply",value:function(){}},{key:"apply",value:function(){return{scale:[1,1]}}},{key:"postApply",value:function(){}},{key:"_buildResult",value:function(e,t,n,i,r,a){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var o=new fi(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,a],this._result.viewport=o,this._result}}]),e}();sM.EXACT_FIT=void 0,sM.SHOW_ALL=void 0,sM.NO_BORDER=void 0,sM.FIXED_HEIGHT=void 0,sM.FIXED_WIDTH=void 0,function(){var e=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).name="EqualToFrame",e}return Z(n,[{key:"apply",value:function(){dh.isProportionalToFrame=!1,this._setupCanvas()}}]),n}(oM),t=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).name="ProportionalToFrame",e}return Z(n,[{key:"apply",value:function(){dh.isProportionalToFrame=!0,this._setupCanvas()}}]),n}(oM);oM.EQUAL_TO_FRAME=new e,oM.PROPORTION_TO_FRAME=new t;var n=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).name="ExactFit",e}return Z(n,[{key:"apply",value:function(e,t){var n=mh.windowSize,i=n.width,r=n.height,a=i/t.width,o=r/t.height;return this._buildResult(i,r,i,r,a,o)}}]),n}(sM),i=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).name="ShowAll",e}return Z(n,[{key:"apply",value:function(e,t){var n,i,r=mh.windowSize,a=r.width,o=r.height,s=t.width,c=t.height,l=a/s,u=o/c,h=0;return l<u?(n=a,i=c*(h=l)):(n=s*(h=u),i=o),this._buildResult(a,o,n,i,h,h)}}]),n}(sM),r=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).name="NoBorder",e}return Z(n,[{key:"apply",value:function(e,t){var n,i,r,a=mh.windowSize,o=a.width,s=a.height,c=t.width,l=t.height,u=o/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=o,r=l*(n=u)),this._buildResult(o,s,i,r,n,n)}}]),n}(sM),a=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).name="FixedHeight",e}return Z(n,[{key:"apply",value:function(e,t){var n=mh.windowSize,i=n.width,r=n.height,a=r/t.height,o=i,s=r;return this._buildResult(i,r,o,s,a,a)}}]),n}(sM),o=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).name="FixedWidth",e}return Z(n,[{key:"apply",value:function(e,t){var n=mh.windowSize,i=n.width,r=n.height,a=i/t.width,o=i,s=r;return this._buildResult(i,r,o,s,a,a)}}]),n}(sM);sM.EXACT_FIT=new n,sM.SHOW_ALL=new i,sM.NO_BORDER=new r,sM.FIXED_HEIGHT=new a,sM.FIXED_WIDTH=new o}();var cM=e("ResolutionPolicy",function(){function e(t,n){K(this,e),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(n)}return Z(e,[{key:"canvasSize",get:function(){return mh.windowSize}},{key:"preApply",value:function(e){this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof oM&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof sM&&(this._contentStrategy=e)}}]),e}());cM.EXACT_FIT=0,cM.NO_BORDER=1,cM.SHOW_ALL=2,cM.FIXED_HEIGHT=3,cM.FIXED_WIDTH=4,cM.UNKNOWN=5,cM.ContainerStrategy=oM,cM.ContentStrategy=sM,c.ResolutionPolicy=cM;var lM=e("view",aM.instance=c.view=new aM);c.winSize=iM,z(aM.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),U(aM.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),U(c,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),U(vh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),F(vh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_".concat(e),newName:e,target:vh.Language,targetName:"sys.Language"}}))),F(vh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_".concat(e),newName:e,target:vh.OS,targetName:"sys.OS"}}))),F(vh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_".concat(e),newName:e,target:vh.BrowserType,targetName:"sys.BrowserType"}}))),F(vh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:vh.BrowserType,targetName:"sys.BrowserType"}]),F(vh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:vh.Platform,targetName:"sys.Platform"}}))),F(vh,"sys",[{name:"IPHONE",newName:"IOS",target:vh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:vh.Platform,targetName:"sys.Platform"}]),z(vh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),F(vh,"sys",[{name:"windowPixelResolution",target:mh,targetName:"screen",newName:"windowSize"}]),U(mh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var uM=function(){function e(){K(this,e),this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new Al,this.scenes=new Al,this.paths=new Al}return Z(e,[{key:"init",value:function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,a=e.paths=Object.create(null);if(!1===e.debug){for(var o=0,s=t.length;o<s;o++)t[o]=Hl(t[o]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=t.length;_<f;_++){var d=t[_];t[_]=h[d]=Hl(d)}t=h}for(var p in n){var m=n[p];a[t[p]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var x=e.packs;for(var S in x)for(var T=x[S],E=0;E<T.length;++E)T[E]=t[T[E]];var C=e.versions;if(C)for(var A in C)for(var b=C[A],w=0;w<b.length;w+=2){var R=b[w];b[w]=t[R]||R}var P=e.redirect;if(P)for(var I=0;I<P.length;I+=2)P[I]=t[P[I]],P[I+1]=r[P[I+1]];if(e.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var O in e.extensionMap)D(O)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)}},{key:"getInfoWithPath",value:function(e,t){if(!e)return null;e=Xl(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var a=n[i];if(dt.isChildClassOf(a.ctor,t))return a}}return null}},{key:"getDirWithPath",value:function(e,t,n){"/"===(e=Xl(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var a=0,o=n.length;a<o;a++){var s=n[a];t&&!dt.isChildClassOf(s.ctor,t)||i.push(s)}})),i}},{key:"getAssetInfo",value:function(e){return this.assetInfos.get(e)||null}},{key:"getSceneInfo",value:function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/".concat(e)),this.scenes.find((function(t,n){return n.endsWith(e)}))}},{key:"destroy",value:function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()}},{key:"_initUuid",value:function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}}},{key:"_initPath",value:function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],a=i[1],o=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=dt._getClassById(a),t.has(r)?o?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}}},{key:"_initScene",value:function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],a=n.get(r);a.url=i,t.add(i,a)}}}},{key:"_initPackage",value:function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var a=0,o=i.length;a<o;a++){var s=i[a],c=t.get(s),l=c.packs;l?1===o?l.unshift(r):l.push(r):c.packs=[r]}}}}},{key:"_initVersion",value:function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var a=n[i];t.get(a).ver=n[i+1]}if(n=e.native)for(var o=0,s=n.length;o<s;o+=2){var c=n[o];t.get(c).nativeVer=n[o+1]}}}},{key:"_initRedirect",value:function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}}}]),e}();function hM(e,t){e._uuid&&t.push(e._uuid)}function _M(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var a=e[r];if("object"===Y(a)&&a)if(Array.isArray(a))for(var o=0;o<a.length;o++){var s=a[o];s instanceof Uu&&hM(s,t)}else if(a.constructor&&a.constructor!==Object)a instanceof Uu&&hM(a,t);else for(var c=Object.getOwnPropertyNames(a),l=0;l<c.length;l++){var u=a[c[l]];u instanceof Uu&&hM(u,t)}}}}function fM(e,t){for(var n=0;n<e._components.length;n++)_M(e._components[n],t);for(var i=0;i<e._children.length;i++)fM(e._children[i],t)}function dM(e,t,n,i){n.push(e._uuid);for(var r=pv.getDeps(e._uuid),a=0,o=r.length;a<o;a++){var s=Rl.get(r[a]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||dM(s,t,n,i)}}}var pM=[];function mM(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,dM(e,t,pM,-1),pM.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&dM(Rl.get(n),t,pM,1);return pM.length=0,t[e._uuid]}var vM=new(function(){function e(){K(this,e),this._persistNodeDeps=new Al,this._toDelete=new Al,this._eventListener=!1}return Z(e,[{key:"init",value:function(){this._persistNodeDeps.clear(),this._toDelete.clear()}},{key:"_addPersistNodeRef",value:function(e){var t=[];fM(e,t);for(var n=0,i=t.length;n<i;n++){var r=Rl.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)}},{key:"_removePersistNodeRef",value:function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=Rl.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}}},{key:"_autoRelease",value:function(e,t,n){if(e){for(var i=pv.getDeps(e.uuid),r=0,a=i.length;r<a;r++){var o=Rl.get(i[r]);o&&o.decRef(e.autoReleaseAssets)}var s=pv._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=Rl.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&pv.remove(e.uuid)}var _=pv._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var d,p,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=ge(v);!(p=g()).done;){var y=p.value,x=Rl.get(y);x&&x.addRef()}_&&(d=_.persistDeps).push.apply(d,pe(v))}}},{key:"tryRelease",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e instanceof Uu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,Dt(this._freeAssets.bind(this)))))}},{key:"_freeAssets",value:function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()}},{key:"_free",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e._uuid;if(this._toDelete.remove(n),Cl(e,!0)&&!(!t&&e.refCount>0&&mM(e)>0)){Rl.remove(n);for(var i=pv.getDeps(n),r=0,a=i.length;r<a;r++){var o=Rl.get(i[r]);o&&(o.decRef(!1),this._free(o,!1))}e.destroy(),pv.remove(n)}}}]),e}()),gM=null;function yM(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof Uu&&r.content.decRef(!1),r.recycle()}e.input=null}function xM(e,t){return t?/\?/.test(e)?"".concat(e,"&_t=").concat(Date.now()):"".concat(e,"?_t=").concat(Date.now()):e}function SM(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;e(r,(function(a,o){r++,!a||r>t?i&&i(a,o):setTimeout((function(){SM(e,t,n,i,r)}),n)}))}function TM(e,t,n,i,r){try{for(var a=pv.parse(e,t),o=0,s=a.deps.length;o<s;o++){var c=a.deps[o];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}a.nativeDep&&(r&&(a.nativeDep.bundle=r.name),i.push(ee({},a.nativeDep)))}catch(e){x(e.message,e.stack)}}function EM(e,t,n){t&&(n=void 0!==n?n:c.assetManager.cacheAsset,ql(t)||!n||t.isDefault||Rl.add(e,t))}function CM(e,t,n){var i=0,r=[],a=e.length;0===a&&n&&n(r);for(var o=function(e){e&&r.push(e),++i===a&&n&&n(r)},s=0;s<a;s++)t(e[s],o)}function AM(e,t,n){var i=e,r=t,a=n;if(void 0===n){var o="function"==typeof e;t?(a=t,o||(r=null)):void 0===t&&o&&(a=e,i=null,r=null),void 0!==t&&o&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:a}}function bM(e,t,n){var i=e,r=t,a=n;if(void 0===n){var o=dt.isChildClassOf(e,Uu);t?(a=t,o&&(r=null)):void 0!==t||o||(a=e,r=null,i=null),void 0===t||o||(r=e,i=null)}return{type:i,onProgress:r||gM,onComplete:a}}function wM(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=n[t];if(!r||i[t])return!1;i[t]=!0;var a=!1,o=pv.getDeps(t);if(o)for(var s=0,c=o.length;s<c;s++){var l=o[s];if(l===e||wM(e,l,n,i)){a=!0;break}}return a}function RM(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof Uu&&i.push(e.addRef())})):n instanceof Uu&&i.push(n.addRef()),Dt((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var PM=function(){function e(){K(this,e),this._config=new uM}return Z(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}},{key:"getInfoWithPath",value:function(e,t){return this._config.getInfoWithPath(e,t)}},{key:"getDirWithPath",value:function(e,t,n){return this._config.getDirWithPath(e,t,n)}},{key:"getAssetInfo",value:function(e){return this._config.getAssetInfo(e)}},{key:"getSceneInfo",value:function(e){return this._config.getSceneInfo(e)}},{key:"init",value:function(e){this._config.init(e),Dl.add(e.name,this)}},{key:"load",value:function(e,t,n,i){var r=bM(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete,l={__requestType__:wl.PATH,type:a,bundle:this.name,__outputAsArray__:Array.isArray(e)};c.assetManager.loadAny(e,l,o,s)}},{key:"preload",value:function(e,t,n,i){var r=bM(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;c.assetManager.preloadAny(e,{__requestType__:wl.PATH,type:a,bundle:this.name},o,s)}},{key:"loadDir",value:function(e,t,n,i){var r=bM(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;c.assetManager.loadAny(e,{__requestType__:wl.DIR,type:a,bundle:this.name,__outputAsArray__:!0},o,s)}},{key:"preloadDir",value:function(e,t,n,i){var r=bM(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;c.assetManager.preloadAny(e,{__requestType__:wl.DIR,type:a,bundle:this.name},o,s)}},{key:"loadScene",value:function(e,t,n,i){var r=AM(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.preset=a.preset||"scene",a.bundle=this.name,c.assetManager.loadAny({scene:e},a,o,(function(e,t){if(e)x(e.message,e.stack);else if(t instanceof _O&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset ".concat(t._uuid," is not a scene"));s&&s(e,t)}))}},{key:"preloadScene",value:function(e,t,n,i){var r=AM(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.bundle=this.name,c.assetManager.preloadAny({scene:e},a,o,(function(t){t&&D(1210,e,t.message),s&&s(t)}))}},{key:"get",value:function(e,t){var n=this.getInfoWithPath(e,t);return n&&Rl.get(n.uuid)||null}},{key:"release",value:function(e,t){var n=this.get(e,t);n&&vM.tryRelease(n,!0)}},{key:"releaseUnusedAssets",value:function(){var e=this;Rl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&vM.tryRelease(t)}))}},{key:"releaseAll",value:function(){var e=this;Rl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&vM.tryRelease(t,!0)}))}},{key:"_destroy",value:function(){this._config.destroy()}}]),e}(),IM=e("resources",new PM);function DM(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",a),n&&n(null,i)}function a(){i.removeEventListener("load",r),i.removeEventListener("error",a),n&&n(new Error(k(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",a),i.src=e,i}function OM(e,t,n,i){var r=new XMLHttpRequest,a="download failed: ".concat(e,", status: ");if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var o in t.xhrHeader)r.setRequestHeader(o,t.xhrHeader[o]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error("".concat(a).concat(r.status,"(no response)")))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error("".concat(a).concat(r.status,"(error)")))},r.ontimeout=function(){i&&i(new Error("".concat(a).concat(r.status,"(time out)")))},r.onabort=function(){i&&i(new Error("".concat(a).concat(r.status,"(abort)")))},r.send(null),r}c.resources=IM;var NM={};function MM(e,t,n){if(NM[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",a,!1),NM[e]=!0,n&&n(null)}function a(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",a,!1),n&&n(new Error(k(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",a,!1),document.body.appendChild(i),i}var kM=/^(?:\w+:\/\/|\.+\/).+/,LM=function(e,t,n){(vh.hasFeature(vh.Feature.IMAGE_BITMAP)&&c.assetManager.allowImageBitmap?BM:DM)(e,t,n)},BM=function(e,t,n){t.xhrResponseType="blob",OM(e,t,t.onFileProgress,n)},FM=function(e,t,n){t.xhrResponseType="json",OM(e,t,t.onFileProgress,n)},zM=function(e,t,n){t.xhrResponseType="arraybuffer",OM(e,t,t.onFileProgress,n)},UM=function(e,t,n){FM(e,t,(function(t,i){if(t)n(t);else{var r=Sh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){zM("".concat(Pu(e)).concat(n),{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new xh(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},GM=function(e,t,n){zM(e,t,(function(e,t){if(e)n(e);else try{var i=Th(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},HM=function(e,t,n){t.xhrResponseType="text",OM(e,t,t.onFileProgress,n)},VM=function(e,t,n){var i=Iu(e),r=e;kM.test(r)||(r=-1!==jM.remoteBundles.indexOf(i)?"".concat(jM.remoteServerAddress,"remote/").concat(i):"assets/".concat(i));var a=t.version||jM.bundleVers[i],o=0,s="".concat(r,"/config.").concat(a?"".concat(a,"."):"","json"),c=null,l=null;FM(s,t,(function(e,t){l=e,(c=t)&&(c.base="".concat(r,"/")),2==++o&&n(l,c)})),MM("".concat(r,"/index.").concat(a?"".concat(a,"."):"","js"),t,(function(e){l=e,2==++o&&n(e,c)}))},jM=new(function(){function e(){K(this,e),this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=DM,this.downloadDomAudio=null,this.downloadFile=OM,this.downloadScript=MM,this._downloaders={".png":LM,".jpg":LM,".bmp":LM,".jpeg":LM,".gif":LM,".ico":LM,".tiff":LM,".webp":LM,".image":LM,".pvr":zM,".pkm":zM,".astc":zM,".txt":HM,".xml":HM,".vsh":HM,".fsh":HM,".atlas":HM,".tmx":HM,".tsx":HM,".json":FM,".ExportJson":FM,".plist":HM,".ccon":UM,".cconb":GM,".fnt":HM,".binary":zM,".bin":zM,".dbbin":zM,".skel":zM,".js":MM,bundle:VM,default:HM},this._downloading=new Al,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}return Z(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n}},{key:"register",value:function(e,t){"object"===Y(e)?Qe(this._downloaders,e):this._downloaders[e]=t}},{key:"download",value:function(e,t,n,i,r){var a=this,o=Pl.get(e);if(o)r(null,o);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;SM((function(n,o){if(0===n&&a._downloading.add(e,[r]),a.limited){a._updateTime();var s=function(e,t){a._totalNum--,a._handleQueueInNextFrame(h,_),o(e,t)};a._totalNum<h&&a._totalNumThisPeriod<_?(f(xM(t,a.appendTimeStamp),i,s),a._totalNum++,a._totalNumThisPeriod++):(a._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:f}),a._queueDirty=!0,a._totalNum<h&&a._handleQueueInNextFrame(h,_))}else f(xM(t,a.appendTimeStamp),i,o)}),u,this.retryInterval,(function(t,n){t||Pl.add(e,n);for(var i=a._downloading.remove(e),r=0,o=i.length;r<o;r++)i[r](t,n)}))}}}},{key:"loadSubpackage",value:function(e,t){c.assetManager.loadBundle(e,null,t)}},{key:"_updateTime",value:function(){var e=performance.now(),t=c.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)}},{key:"_handleQueue",value:function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(xM(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)}},{key:"_handleQueueInNextFrame",value:function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(Dt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)}}]),e}());function WM(e,t,n,i){var r=null,a=null;try{(r=new lv)._nativeUrl=e,r._nativeAsset=t}catch(e){a=e}i(a,r)}function qM(e,t,n,i){var r=new gO;r.json=t,i(null,r)}function XM(e,t,n,i){var r=new vO;r.text=t,i(null,r)}function YM(e,t,n,i){var r=new jb;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function KM(e,t,n,i){var r=new Uu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function QM(e,n,i,r){var a=Dl.get(n.name);a||(a=n.name===kl.RESOURCES?IM:new PM,n.base=n.base||"".concat(e,"/"),a.init(n)),t.import("virtual:///prerequisite-imports/".concat(a.name)).then((function(){r(null,a)})).catch(r)}var ZM=new(function(){function e(){K(this,e),this._creating=new Al,this._producers={".png":WM,".jpg":WM,".bmp":WM,".jpeg":WM,".gif":WM,".ico":WM,".tiff":WM,".webp":WM,".image":WM,".pvr":WM,".pkm":WM,".txt":XM,".xml":XM,".vsh":XM,".fsh":XM,".atlas":XM,".tmx":XM,".tsx":XM,".fnt":XM,".json":qM,".ExportJson":qM,".binary":YM,".bin":YM,".dbbin":YM,".skel":YM,bundle:QM,default:KM}}return Z(e,[{key:"register",value:function(e,t){"object"===Y(e)?dt.mixin(this._producers,e):this._producers[e]=t}},{key:"create",value:function(e,t,n,i,r){var a=this,o=this._producers[n]||this._producers.default,s=Rl.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),o(e,t,i,(function(t,n){!t&&n instanceof Uu&&(n._uuid=e,EM(e,n,i.cacheAsset));for(var r=a._creating.remove(e),o=0,s=r.length;o<s;o++)r[o](t,n)})))}else r(null,s)}}]),e}()),JM=new(function(){function e(){K(this,e),this._loading=new Al,this._unpackers={".json":this.unpackJson}}return Z(e,[{key:"unpackJson",value:function(e,t,n,i){var r=dt.createMap(!0),a=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(k(5304,e[0]));jh(e,!0,void 0,qh.reportMissingClass),Wh(e);for(var t=new Xh(e[0]),n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=0;s<o.length;++s)o[s].unshift(t,n,i,r,a);return o}(t)).length!==e.length&&D(4915);for(var o=0;o<e.length;o++)r["".concat(e[o],"@import")]=t[o]}else{var s=dt._getClassId(Ov),c=dt._getClassId(lv);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&D(4915);for(var u=0;u<e.length;u++)r["".concat(e[u],"@import")]=Yh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&D(4915);for(var _=0;_<e.length;_++)r["".concat(e[_],"@import")]=h[_]}else a=new Error("unmatched type pack!"),r=null}i(a,r)}},{key:"init",value:function(){this._loading.clear()}},{key:"register",value:function(e,t){"object"===Y(e)?dt.mixin(this._unpackers,e):this._unpackers[e]=t}},{key:"unpack",value:function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))}},{key:"load",value:function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(Pl.has(e.id))n(null,Pl.get(e.id));else{var r=e.info.packs,a=r.find((function(e){return i._loading.has(e.uuid)}));if(a)this._loading.get(a.uuid).push({onComplete:n,id:e.id});else{a=r[0],this._loading.add(a.uuid,[{onComplete:n,id:e.id}]);var o=Yl(a.uuid,{ext:a.ext,bundle:e.config.name});jM.download(a.uuid,o,a.ext,e.options,(function(t,n){Pl.remove(a.uuid),t&&x(t.message,t.stack),i.unpack(a.packedUuids,n,a.ext,e.options,(function(e,n){if(!e)for(var r in n)Pl.add(r,n[r]);for(var o=i._loading.remove(a.uuid),s=0,c=o.length;s<c;s++){var l=o[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else jM.download(e.id,e.url,e.ext,e.options,n)}}]),e}());function $M(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress,a=[],o=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);e.output=[],CM(e.input,(function(i,l){if(!i.isNative&&Rl.has(i.uuid)){var u=Rl.get(i.uuid);return i.content=u.addRef(),e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i),void l()}JM.load(i,e.options,(function(u,h){u?e.isFinish||(!c.assetManager.force||n?(x(u.message,u.stack),r.canInvoke=!1,t(u)):(e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i))):e.isFinish||(i.file=h,e.output.push(i),i.isNative||(s[i.uuid]=!0,TM(i.uuid,h,s,a,i.config),r.total=o+a.length),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i)),l()}))}),(function(){if(e.isFinish)return yM(e,!0),void e.dispatch("error");if(a.length>0){var o=Bl.create({input:a,progress:r,options:i,onProgress:e.onProgress,onError:Bl.prototype.recycle,onComplete:function(i){var r;i||((r=e.output).push.apply(r,pe(o.output)),o.recycle()),n&&ek(e),t(i)}});Nl.async(o)}else n&&ek(e),t()}))}function ek(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var tk=new(function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"parse",value:function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return P(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)}},{key:"_parseNode",value:function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var a=e.childNodes[i];1===a.nodeType&&("key"===a.tagName?n=a.firstChild.nodeValue:t[n]=this._parseNode(a))}return t}}]),n}(function(){function e(){K(this,e),this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}return Z(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")}}]),e}()));function nk(e,t){return e[t]<<8|e[t+1]}var ik=new(function(){function e(){K(this,e),this._parsing=new Al,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}return Z(e,[{key:"parseImage",value:function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))}},{key:"parsePVRTex",value:function(e,t,n){var i=null,r=null;try{var a=e instanceof ArrayBuffer?e:e.buffer,o=new Int32Array(a,0,13);if(55727696===o[0]){var s=o[7],c=o[6],l=o[12]+52;r={_data:new Uint8Array(a,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==o[11])throw new Error("Invalid magic number in PVR header");var u=o[0],h=o[1],_=o[2];r={_data:new Uint8Array(a,u),_compressed:!0,width:_,height:h,format:0}}}catch(e){i=e}n(i,r)}},{key:"parsePKMTex",value:function(e,t,n){var i=null,r=null;try{var a=e instanceof ArrayBuffer?e:e.buffer,o=new Uint8Array(a),s=nk(o,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=nk(o,12),l=nk(o,14);nk(o,8),nk(o,10),r={_data:new Uint8Array(a,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)}},{key:"parseASTCTex",value:function(e,t,n){var i=null,r=null;try{var a=e instanceof ArrayBuffer?e:e.buffer,o=new Uint8Array(a);if(1554098963!==o[0]+(o[1]<<8)+(o[2]<<16)+(o[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=o[4],c=o[5],l=o[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?Um.RGBA_ASTC_4x4:5===e?4===t?Um.RGBA_ASTC_5x4:Um.RGBA_ASTC_5x5:6===e?5===t?Um.RGBA_ASTC_6x5:Um.RGBA_ASTC_6x6:8===e?5===t?Um.RGBA_ASTC_8x5:6===t?Um.RGBA_ASTC_8x6:Um.RGBA_ASTC_8x8:10===e?5===t?Um.RGBA_ASTC_10x5:6===t?Um.RGBA_ASTC_10x6:8===t?Um.RGBA_ASTC_10x8:Um.RGBA_ASTC_10x10:10===t?Um.RGBA_ASTC_12x10:Um.RGBA_ASTC_12x12}(s,c),h=o[7]+(o[8]<<8)+(o[9]<<16),_=o[10]+(o[11]<<8)+(o[12]<<16);o[13],o[14],o[15],r={_data:new Uint8Array(a,16),_compressed:!0,width:h,height:_,format:u}}catch(e){i=e}n(i,r)}},{key:"parsePlist",value:function(e,t,n){var i=null,r=tk.parse(e);r||(i=new Error("parse failed")),n(i,r)}},{key:"parseImport",value:function(e,t,n){if(e){var i=null,r=null;try{i=fv(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset ".concat(t.__uuid__," is empty or missing")))}},{key:"init",value:function(){this._parsing.clear()}},{key:"register",value:function(e,t){"object"===Y(e)?Qe(this._parsers,e):this._parsers[e]=t}},{key:"parse",value:function(e,t,n,i,r){var a=this,o=Il.get(e);if(o)r(null,o);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?Pl.remove(e):ql(n)||Il.add(e,n);for(var i=a._parsing.remove(e),r=0,o=i.length;r<o;r++)i[r](t,n)}))):r(null,t)}}}}]),e}());function rk(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress;i.__exclude__=i.__exclude__||Object.create(null),e.output=[],CM(e.input,(function(a,o){var s=Bl.create({input:a,onProgress:e.onProgress,options:i,progress:r,onComplete:function(i,l){i&&!e.isFinish&&(!c.assetManager.force||n?(x(i.message,i.stack),r.canInvoke=!1,t(i)):r.canInvoke&&e.dispatch("progress",++r.finish,r.total,a)),e.output.push(l),s.recycle(),o(null)}});ak.async(s)}),(function(){if(i.__exclude__=null,e.isFinish)return yM(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),yM(e,!0),t()}))}var ak=new bl("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,a=n.uuid,o=n.file,s=i.reloadAsset;o||!s&&!r&&Rl.has(a)?t():JM.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,a=n.id,o=n.file,s=n.options;if(n.isNative)ik.parse(a,o,n.ext,s,(function(r,o){r?t(r):(n.content=o,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),Pl.remove(a),Il.remove(a),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||wM(c,c,r)?(h&&h.addRef(),n.content=h,t(_)):f.push({done:t,item:n})}else if(!s.reloadAsset&&Rl.has(c)){var d=Rl.get(c);n.content=d.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,ik.parse(a,o,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,a=i,o=a.uuid,s=a.id,c=a.options,l=a.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),TM(o,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var _=e.options.__exclude__[o]={content:t,finish:!1,callbacks:[{done:n,item:i}]},f=Bl.create({input:h,options:e.options,onProgress:e.onProgress,onError:Bl.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),a=ge(i);!(n=a()).done;){var c=n.value;c&&(r[c instanceof Uu?"".concat(c._uuid,"@import"):"".concat(o,"@native")]=c)}!function(e,t,n){var i=uv.get(t);if(i){for(var r=0,a=i.length;r<a;r++){var o=i[r],s=n["".concat(o.uuid,"@import")];if(s)o.owner[o.prop]=s.addRef();else{if(x("The asset ".concat(o.uuid," is missing!")),o.type&&o.type!==Uu){var c=new o.type;c.initDefault(o.uuid),o.owner[o.prop]=c}!0}}uv.delete(t)}hv.has(t)&&(n["".concat(e,"@native")]?t._nativeAsset=n["".concat(e,"@native")]:(!0,console.error("the native asset of ".concat(e," is missing!"))),hv.delete(t))}(o,t,r);try{"function"!=typeof t.onLoaded||_v.has(t)||hv.has(t)||(t.onLoaded(),_v.add(t))}catch(e){x("The asset ".concat(o," is invalid for some reason, detail message: ").concat(e.message,", stack: ").concat(e.stack))}Pl.remove(s),Il.remove(s),EM(o,t,u),f.recycle()}for(var l=_.callbacks,h=0,d=l.length;h<d;h++){var p=l[h];t.addRef&&t.addRef(),p.item.content=t,p.done(e)}l.length=0}});Ol.async(f)}(e,i,t)}))}}]);function ok(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var a in n)switch(a){case wl.PATH:case wl.UUID:case wl.DIR:case wl.SCENE:case wl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[a]=n[a];break;case"__exclude__":case"__outputAsArray__":r[a]=n[a];break;default:i[a]=n[a],r[a]=n[a]}e.options=r;var o=Bl.create({input:e.input,options:i}),s=null;try{e.output=e.source=Ml.sync(o)}catch(e){s=e;for(var c=0,l=o.output.length;c<l;c++)o.output[c].recycle()}o.recycle(),t(s)}var sk=function(){function e(){K(this,e),this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return Z(e,[{key:"id",get:function(){return this._id||(this._id="".concat(this.uuid,"@").concat(this.isNative?"native":"import")),this._id}},{key:"recycle",value:function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))}}],[{key:"create",value:function(){return 0!==e._deadPool.length?e._deadPool.pop():new e}}]),e}();sk.MAX_DEAD_NUM=500,sk._deadPool=[];var ck=[];function lk(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,a=n[i],o=sk.create(),s=null,c=null;if("string"==typeof a&&((a=Object.create(null))[t.__requestType__||wl.UUID]=n[i]),"object"===Y(a))for(var l in Ke(a,t),a.preset&&Ke(a,Ll[a.preset]),a){switch(l){case wl.UUID:if("break"===function(){var e,t=o.uuid=Hl(a.uuid);if(!a.bundle){var n=Dl.find((function(e){return!!e.getAssetInfo(t)}));a.bundle=n&&n.name}if(Dl.has(a.bundle)){if(s=Dl.get(a.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!Dl.has(c.redirect))throw new Error("Please load bundle ".concat(c.redirect," first"));s=Dl.get(c.redirect).config,c=s.getAssetInfo(t)}o.config=s,o.info=c}return o.ext=a.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case wl.DIR:if(Dl.has(a.bundle)){Dl.get(a.bundle).config.getDirWithPath(a.dir,a.type,ck);for(var u,h=ge(ck);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:a.bundle})}ck.length=0}o.recycle(),o=null;break;case wl.PATH:if(Dl.has(a.bundle)){if(s=Dl.get(a.bundle).config,(c=s.getInfoWithPath(a.path,a.type))&&c.redirect){if(!Dl.has(c.redirect))throw new Error("you need to load bundle ".concat(c.redirect," first"));s=Dl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw o.recycle(),new Error("Bundle ".concat(a.bundle," doesn't contain ").concat(a.path));o.config=s,o.uuid=c.uuid,o.info=c}o.ext=a.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case wl.SCENE:if(!a.bundle){var f=Dl.find((function(e){return!!e.getSceneInfo(a.scene)}));a.bundle=f&&f.name}if(Dl.has(a.bundle)){if(s=Dl.get(a.bundle).config,(c=s.getSceneInfo(a.scene))&&c.redirect){if(!Dl.has(c.redirect))throw new Error("you need to load bundle ".concat(c.redirect," first"));s=Dl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw o.recycle(),new Error("Bundle ".concat(s.name," doesn't contain scene ").concat(a.scene));o.config=s,o.uuid=c.uuid,o.info=c}break;case"__isNative__":o.isNative=a.__isNative__;break;case wl.URL:o.url=a.url,o.uuid=a.uuid||a.url,o.ext=a.ext||Ru(a.url),o.isNative=void 0===a.__isNative__||a.__isNative__;break;default:o.options[l]=a[l]}if(!o)break}if(!o)return"continue";if(e.output.push(o),!o.uuid&&!o.url)throw new Error("Can not parse this input:".concat(JSON.stringify(a)))},r=0;r<n.length;r++)i(r);return null}function uk(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var i=t[n];if(!i.url){var r,a,o=i.config;a=i.isNative?o&&o.nativeBase?o.base+o.nativeBase:c.assetManager.generalNativeBase:o&&o.importBase?o.base+o.importBase:c.assetManager.generalImportBase;var s=i.uuid,l="";i.info&&(l=i.isNative?i.info.nativeVer?".".concat(i.info.nativeVer):"":i.info.ver?".".concat(i.info.ver):""),r=".ttf"===i.ext?"".concat(a,"/").concat(s.slice(0,2),"/").concat(s).concat(l,"/").concat(i.options.__nativeName__):"".concat(a,"/").concat(s.slice(0,2),"/").concat(s).concat(l).concat(i.ext),i.url=r}}return null}var hk=e("AssetManager",function(){function e(){K(this,e),this.pipeline=Ol.append(ok).append(rk),this.fetchPipeline=Nl.append(ok).append($M),this.transformPipeline=Ml.append(lk).append(uk),this.bundles=Dl,this.assets=Rl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=pv,this.force=!1,this.allowImageBitmap=!vh.isMobile,this.utils=Kl,this.downloader=jM,this.parser=ik,this.packManager=JM,this.cacheAsset=!0,this.cacheManager=null,this.presets=Ll,this.factory=ZM,this.preprocessPipe=ok,this.fetchPipe=$M,this.loadPipe=rk,this.references=null,this._releaseManager=vM,this._files=Pl,this._parsed=Il,this._parsePipeline=null}return Z(e,[{key:"main",get:function(){return Dl.get(kl.MAIN)||null}},{key:"resources",get:function(){return Dl.get(kl.RESOURCES)||null}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n}},{key:"getBundle",value:function(e){return Dl.get(e)||null}},{key:"removeBundle",value:function(e){e._destroy(),Dl.remove(e.name)}},{key:"loadAny",value:function(e,t,n,i){var r=AM(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.preset=a.preset||"default",e=Array.isArray(e)?e.slice():e;var c=Bl.create({input:e,onProgress:o,onComplete:RM(s),options:a});Ol.async(c)}},{key:"preloadAny",value:function(e,t,n,i){var r=AM(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.preset=a.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=Bl.create({input:e,onProgress:o,onComplete:RM(s),options:a});Nl.async(c)}},{key:"loadRemote",value:function(e,t,n){var i=AM(t,void 0,n),r=i.options,a=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(x(t.message,t.stack),a&&a(t,n)):ZM.create(e,n,r.ext||Ru(e),r,(function(e,t){a&&a(e,t)}))}))):RM(a)(null,this.assets.get(e))}},{key:"loadBundle",value:function(e,t,n){var i=AM(t,void 0,n),r=i.options,a=i.onComplete,o=Iu(e);this.bundles.has(o)?RM(a)(null,this.getBundle(o)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(x(t.message,t.stack),a&&a(t,n)):ZM.create(e,n,"bundle",r,(function(e,t){a&&a(e,t)}))})))}},{key:"releaseAsset",value:function(e){vM.tryRelease(e,!0)}},{key:"releaseUnusedAssets",value:function(){Rl.forEach((function(e){vM.tryRelease(e)}))}},{key:"releaseAll",value:function(){Rl.forEach((function(e){vM.tryRelease(e,!0)}))}},{key:"loadWithJson",value:function(){throw new Error("Only valid in Editor")}}]),e}());hk.Pipeline=bl,hk.Task=Bl,hk.Cache=Al,hk.RequestItem=sk,hk.Bundle=PM,hk.BuiltinBundleName=kl;var _k=e("assetManager",c.assetManager=new hk);c.AssetManager=hk;var fk=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],dk=[".mp3",".ogg",".wav",".m4a"];function pk(){return!0}var mk={transformURL:function(e){var t=jl(e);if(!t)return e;var n=Dl.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,r=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(i))return e;var a=!1;if(".ttf"===Ru(e)&&(a=!0),a){var o=Du(e),s=Iu(e);e="".concat(o,".").concat(i,"/").concat(s)}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return"".concat(e,".").concat(i)}));return e}},vk=e("CCLoader",function(){function e(){K(this,e),this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=bM}return Z(e,[{key:"onProgress",set:function(e){gM=e}},{key:"_cache",get:function(){if(Rl instanceof Al)return Rl._map;var e={};return Rl.forEach((function(t,n){e[n]=t})),e}},{key:"load",value:function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],r=0;r<i.length;r++){var a=i[r];"string"==typeof a?i[r]={url:a,__isNative__:!0}:(a.type&&(a.ext=".".concat(a.type),a.type=void 0),a.url&&(a.__isNative__=!0))}var o=[],s=[];_k.loadAny(i,null,(function(e,n,i){i.content&&(fk.includes(i.ext)?o.push(i.content):dk.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var a=function(e){var n=t[e];if(!(n instanceof Uu)){var r=n,a=i[e].url;o.includes(r)?ZM.create(a,n,".png",{},(function(n,i){r=t[e]=i})):s.includes(r)&&ZM.create(a,n,".mp3",{},(function(n,i){r=t[e]=i})),Rl.add(a,r)}},c=0;c<t.length;c++)a(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),r={isCompleted:pk,_map:l}}else r=t[0]}n&&n(e,r)}))}},{key:"getXMLHttpRequest",value:function(){return new XMLHttpRequest}},{key:"getItem",value:function(e){return _k.assets.has(e)?{content:_k.assets.get(e)}:null}},{key:"loadRes",value:function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete,c=Ru(e);c&&!IM.getInfoWithPath(e,a)&&(e=e.slice(0,-c.length)),IM.load(e,a,o,s)}},{key:"loadResArray",value:function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;e.forEach((function(t,n){var i=Ru(t);i&&!IM.getInfoWithPath(t,a)&&(e[n]=t.slice(0,-i.length))})),IM.load(e,a,o,s)}},{key:"loadResDir",value:function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;IM.loadDir(e,a,o,(function(t,n){var i=[];t||(i=IM.getDirWithPath(e,a).map((function(e){return e.path}))),s&&s(t,n,i)}))}},{key:"getRes",value:function(e,t){return Rl.has(e)?Rl.get(e):IM.get(e,t)}},{key:"getResCount",value:function(){return Rl.count}},{key:"getDependsRecursively",value:function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return pv.getDepsRecursively(t).concat([t])}},{key:"md5Pipe",get:function(){return mk}},{key:"downloader",get:function(){return jM}},{key:"loader",get:function(){return _k.parser}},{key:"addDownloadHandlers",value:function(e){var t=Object.create(null),n=function(n){var i=e[n];t[".".concat(n)]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);jM.register(t)}},{key:"addLoadHandlers",value:function(e){var t=Object.create(null),n=function(n){var i=e[n];t[".".concat(n)]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);ik.register(t)}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=Rl.get(n)),_k.releaseAsset(n)}else e&&("string"==typeof e&&(e=Rl.get(e)),_k.releaseAsset(e))}},{key:"releaseAsset",value:function(e){_k.releaseAsset(e)}},{key:"releaseRes",value:function(e,t){IM.release(e,t)}},{key:"releaseAll",value:function(){_k.releaseAll(),Rl.clear()}},{key:"removeItem",value:function(e){return!!Rl.remove(e)}},{key:"setAutoRelease",value:function(e,t){"object"===Y(e)&&(e=e._uuid),this._autoReleaseSetting[e]=!!t}},{key:"setAutoReleaseRecursively",value:function(e,t){"object"===Y(e)&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=pv.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t}},{key:"isAutoRelease",value:function(e){return"object"===Y(e)&&(e=e._uuid),!!this._autoReleaseSetting[e]}}]),e}()),gk=e("loader",new vk),yk=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,_k.init(e),e.rawAssets&&IM.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:kl.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){_k.loadAny(e,t)}}),xk=e("url",{});F(xk,"url",[{name:"normalize",target:_k.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?Yl({path:Ou(e.substr(10)),bundle:kl.RESOURCES,__isNative__:!0,ext:Ru(e)}):""}}]),z(yk,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),z(gk,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),F(c,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return gk}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return yk}},{name:"Pipeline",target:hk,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return xk}}]),z(c,"cc",[{name:"LoadingItems",suggest:k(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),F(St,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:jM,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),F($N,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return _k.main?null===(t=_k.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),F(ZN,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return _k.main&&_k.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var Sk,Tk,Ek,Ck,Ak,bk,wk,Rk,Pk,Ik,Dk,Ok,Nk,Mk,kk=vM._autoRelease;vM._autoRelease=function(e,t,n){kk.call(vM,e,t,n);for(var i=gk._autoReleaseSetting,r=Object.keys(i),a=0;a<r.length;a++){var o=r[a];if(!0===i[o]){var s=Rl.get(o);s&&vM.tryRelease(s)}}};var Lk,Bk,Fk,zk,Uk,Gk,Hk,Vk,jk,Wk,qk,Xk,Yk,Kk,Qk,Zk,Jk,$k,eL,tL,nL,iL,rL,aL,oL,sL,cL,lL,uL,hL,_L,fL,dL,pL,mL,vL,gL,yL,xL,SL,TL,EL,CL,AL,bL,wL,RL,PL,IL,DL,OL,NL,ML,kL,LL,BL,FL,zL,UL,GL,HL,VL,jL,WL,qL,XL,YL,KL=e("EventHandler",(Sk=Cc("cc.ClickEvent"),Tk=rl(c.Node),Ek=Wc(),Ck=Wc(),Ak=Wc(),bk=Wc(),Sk((Mk=function(){function e(){K(this,e),ye(this,"target",Pk,this),ye(this,"component",Ik,this),ye(this,"_componentId",Dk,this),ye(this,"handler",Ok,this),ye(this,"customEventData",Nk,this)}return Z(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}},{key:"emit",value:function(e){var t=this.target;if(c.isValid(t)){this._genCompIdIfNeeded();var n=c.js._getClassById(this._componentId),i=t.getComponent(n);if(c.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(i,e))}}}},{key:"_compName2Id",value:function(e){var t=c.js.getClassByName(e);return c.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=c.js._getClassById(e);return c.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}}],[{key:"emitEvents",value:function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var a=0,o=t.length;a<o;a++){var s=t[a];s instanceof e&&s.emit(i)}}}]),e}(),Pk=xe((Rk=Mk).prototype,"target",[Ic,Tk,Ic,Ek],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ik=xe(Rk.prototype,"component",[Ic,Gc,Ck],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Dk=xe(Rk.prototype,"_componentId",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ok=xe(Rk.prototype,"handler",[Ic,Gc,Ak],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Nk=xe(Rk.prototype,"customEventData",[Ic,Gc,bk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wk=Rk))||wk));c.Component.EventHandler=KL;var QL,ZL,JL,$L,eB,tB,nB,iB,rB,aB,oB,sB=new zn,cB=mt(fg),lB=mt(_g),uB=mt(dg),hB=mt(mg),_B=mt(pg),fB=mt({SKYBOX:Ag|rr.DEPTH_STENCIL,SOLID_COLOR:rr.ALL,DEPTH_ONLY:rr.DEPTH_STENCIL,DONT_CLEAR:rr.NONE}),dB=(Lk=Cc("cc.Camera"),Bk=Uc(),Fk=Lc(),zk=Zc(),Uk=Wc(),Gk=rl(jd.BitMask),Hk=Zc(),Vk=Wc(),jk=rl(fB),Wk=Zc(),qk=Wc(),Xk=Zc(),Yk=Wc(),Kk=Zc(),Qk=Wc(),Zk=Zc(),Jk=Wc(),$k=rl(cB),eL=Zc(),tL=Wc(),nL=rl(lB),iL=Zc(),rL=Wc(),aL=Zc(),oL=Wc(),sL=Zc(),cL=Wc(),lL=Zc(),uL=Wc(),hL=Zc(),_L=Wc(),fL=rl(uB),dL=Zc(),pL=Wc(),mL=rl(hB),vL=Zc(),gL=Wc(),yL=rl(_B),xL=Zc(),SL=Wc(),TL=Zc(),EL=Wc(),CL=rl(KS),AL=Zc(),bL=Wc(),QL=Lk(wL=Bk(wL=Fk(wL=kc((YL=XL=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_projection",PL,se(e)),ye(e,"_priority",IL,se(e)),ye(e,"_fov",DL,se(e)),ye(e,"_fovAxis",OL,se(e)),ye(e,"_orthoHeight",NL,se(e)),ye(e,"_near",ML,se(e)),ye(e,"_far",kL,se(e)),ye(e,"_color",LL,se(e)),ye(e,"_depth",BL,se(e)),ye(e,"_stencil",FL,se(e)),ye(e,"_clearFlags",zL,se(e)),ye(e,"_rect",UL,se(e)),ye(e,"_aperture",GL,se(e)),ye(e,"_shutter",HL,se(e)),ye(e,"_iso",VL,se(e)),ye(e,"_screenScale",jL,se(e)),ye(e,"_visibility",WL,se(e)),ye(e,"_targetTexture",qL,se(e)),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e}return Z(n,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===_g.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=Sn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(n.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?c.director.root&&c.director.root.mainWindow:c.director.root&&c.director.root.tempWindow)}},{key:"onLoad",value:function(){this._createCamera()}},{key:"onEnable",value:function(){this.node.hasChangedFlags|=fy.POSITION,this._camera&&this._attachToScene()}},{key:"onDisable",value:function(){this._camera&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,n){return n||(n=lo.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n}},{key:"worldToScreen",value:function(e,t){return t||(t=new zn),this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"convertToUINode",value:function(e,t,n){if(n||(n=new zn),!this._camera)return n;this.worldToScreen(e,sB);var i=t.getComponent("cc.UITransform"),r=lM.getVisibleSize(),a=sB.x-.5*this._camera.width,o=sB.y-.5*this._camera.height;return sB.x=a/c.view.getScaleX()+.5*r.width,sB.y=o/c.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(sB,n),n}},{key:"_createCamera",value:function(){this._camera||(this._camera=c.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?c.director.root&&c.director.root.mainWindow:c.director.root&&c.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=Sn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()}},{key:"_attachToScene",value:function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}},{key:"_detachFromScene",value:function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}},{key:"_checkTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)}},{key:"_updateTargetTexture",value:function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}}]),n}(sh),XL.ProjectionType=cB,XL.FOVAxis=lB,XL.ClearFlag=fB,XL.Aperture=uB,XL.Shutter=hB,XL.ISO=_B,XL.TARGET_TEXTURE_CHANGE="tex-change",PL=xe((RL=YL).prototype,"_projection",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cB.PERSPECTIVE}}),IL=xe(RL.prototype,"_priority",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DL=xe(RL.prototype,"_fov",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),OL=xe(RL.prototype,"_fovAxis",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lB.VERTICAL}}),NL=xe(RL.prototype,"_orthoHeight",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),ML=xe(RL.prototype,"_near",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kL=xe(RL.prototype,"_far",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),LL=xe(RL.prototype,"_color",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bn("#333333")}}),BL=xe(RL.prototype,"_depth",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),FL=xe(RL.prototype,"_stencil",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zL=xe(RL.prototype,"_clearFlags",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fB.SOLID_COLOR}}),UL=xe(RL.prototype,"_rect",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi(0,0,1,1)}}),GL=xe(RL.prototype,"_aperture",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uB.F16_0}}),HL=xe(RL.prototype,"_shutter",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hB.D125}}),VL=xe(RL.prototype,"_iso",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _B.ISO100}}),jL=xe(RL.prototype,"_screenScale",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),WL=xe(RL.prototype,"_visibility",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rm}}),qL=xe(RL.prototype,"_targetTexture",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xe(RL.prototype,"priority",[zk,Uk],Object.getOwnPropertyDescriptor(RL.prototype,"priority"),RL.prototype),xe(RL.prototype,"visibility",[Gk,Hk,Vk],Object.getOwnPropertyDescriptor(RL.prototype,"visibility"),RL.prototype),xe(RL.prototype,"clearFlags",[jk,Wk,qk],Object.getOwnPropertyDescriptor(RL.prototype,"clearFlags"),RL.prototype),xe(RL.prototype,"clearColor",[Xk,Yk],Object.getOwnPropertyDescriptor(RL.prototype,"clearColor"),RL.prototype),xe(RL.prototype,"clearDepth",[Kk,Qk],Object.getOwnPropertyDescriptor(RL.prototype,"clearDepth"),RL.prototype),xe(RL.prototype,"clearStencil",[Zk,Jk],Object.getOwnPropertyDescriptor(RL.prototype,"clearStencil"),RL.prototype),xe(RL.prototype,"projection",[$k,eL,tL],Object.getOwnPropertyDescriptor(RL.prototype,"projection"),RL.prototype),xe(RL.prototype,"fovAxis",[nL,iL,rL],Object.getOwnPropertyDescriptor(RL.prototype,"fovAxis"),RL.prototype),xe(RL.prototype,"fov",[aL,oL],Object.getOwnPropertyDescriptor(RL.prototype,"fov"),RL.prototype),xe(RL.prototype,"orthoHeight",[sL,cL],Object.getOwnPropertyDescriptor(RL.prototype,"orthoHeight"),RL.prototype),xe(RL.prototype,"near",[lL,uL],Object.getOwnPropertyDescriptor(RL.prototype,"near"),RL.prototype),xe(RL.prototype,"far",[hL,_L],Object.getOwnPropertyDescriptor(RL.prototype,"far"),RL.prototype),xe(RL.prototype,"aperture",[fL,dL,pL],Object.getOwnPropertyDescriptor(RL.prototype,"aperture"),RL.prototype),xe(RL.prototype,"shutter",[mL,vL,gL],Object.getOwnPropertyDescriptor(RL.prototype,"shutter"),RL.prototype),xe(RL.prototype,"iso",[yL,xL,SL],Object.getOwnPropertyDescriptor(RL.prototype,"iso"),RL.prototype),xe(RL.prototype,"rect",[TL,EL],Object.getOwnPropertyDescriptor(RL.prototype,"rect"),RL.prototype),xe(RL.prototype,"targetTexture",[CL,AL,bL],Object.getOwnPropertyDescriptor(RL.prototype,"targetTexture"),RL.prototype),wL=RL))||wL)||wL)||wL)||wL,e({Camera:QL,CameraComponent:QL}),QL);c.Camera=dB;var pB,mB,vB,gB,yB,xB,SB,TB,EB={parent:null,owner:null,subModelIdx:0},CB=e("RenderableComponent",(ZL=Cc("cc.RenderableComponent"),JL=rl([gg]),$L=rl(gg),eB=Zc(),tB=jc(),ZL((oB=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_materials",rB,se(e)),ye(e,"_visFlags",aB,se(e)),e._materialInstances=[],e._models=[],e}return Z(n,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(e[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"getMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t){e&&e instanceof bT&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}},{key:"getMaterialInstance",value:function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){EB.parent=this._materials[e],EB.owner=this,EB.subModelIdx=e;var t=new bT(EB);EB.parent=null,EB.owner=null,EB.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]}},{key:"setMaterialInstance",value:function(e,t){if("number"==typeof e){P(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)}},{key:"getRenderMaterial",value:function(e){return this._materialInstances[e]||this._materials[e]}},{key:"_collectModels",value:function(){return this._models}},{key:"_attachToScene",value:function(){}},{key:"_detachFromScene",value:function(){}},{key:"_onMaterialModified",value:function(){}},{key:"_onRebuildPSO",value:function(){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisibilityChange",value:function(){}}]),n}(sh),rB=xe((iB=oB).prototype,"_materials",[JL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aB=xe(iB.prototype,"_visFlags",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jd.Enum.NONE}}),xe(iB.prototype,"sharedMaterials",[$L,eB,tB],Object.getOwnPropertyDescriptor(iB.prototype,"sharedMaterials"),iB.prototype),nB=iB))||nB));function AB(e){return"string"==typeof e||"number"==typeof e}c.RenderableComponent=CB,F(dB,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),F(dB.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),c.CameraComponent=dB,dt.setClassAlias(dB,"cc.CameraComponent");var bB,wB,RB,PB,IB,DB,OB,NB,MB,kB,LB,BB,FB,zB,UB,GB,HB,VB,jB,WB,qB,XB,YB=Cc("cc.animation.HierarchyPath")((gB=function(){function e(t){K(this,e),ye(this,"path",vB,this),this.path=t||""}return Z(e,[{key:"get",value:function(e){return e instanceof tb?e.getChildByPath(this.path)||(P(3926,e.name,this.path),null):(P(3925),null)}}]),e}(),vB=xe((mB=gB).prototype,"path",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pB=mB))||pB,KB=Cc("cc.animation.ComponentPath")((TB=function(){function e(t){K(this,e),ye(this,"component",SB,this),this.component=t||""}return Z(e,[{key:"get",value:function(e){return e instanceof tb?e.getComponent(this.component)||(P(3928,e.name,this.component),null):(P(3927),null)}}]),e}(),SB=xe((xB=TB).prototype,"component",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yB=xB))||yB,QB=Cc("cc.animation.UniformProxyFactory")((DB=function(){function e(t,n){K(this,e),ye(this,"passIndex",RB,this),ye(this,"uniformName",PB,this),ye(this,"channelIndex",IB,this),this.passIndex=n||0,this.uniformName=t||""}return Z(e,[{key:"forTarget",value:function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));if(Kv.getTypeFromHandle(n)<Ai.SAMPLER1D){var i=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,Ai.FLOAT);if(!i)throw new Error('Uniform "'.concat(this.uniformName," (in material ").concat(e.name,") has no channel ").concat(this.channelIndex,'"'));return function(e,t){for(var n,i=ge(e.shaderInfo.blocks);!(n=i()).done;)for(var r,a=ge(n.value.members);!(r=a()).done;){var o=r.value;if(o.name===t)return o.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(i,e)}}:{set:function(e){t.setUniform(i,e)}}}var r=Kv.getBindingFromHandle(n),a=t.properties[this.uniformName],o=a&&a.value?"".concat(a.value,"-texture"):Sm(a.type),s=Gv.get(o);return s||(y("Illegal texture default value: ".concat(o,".")),s=Gv.get("default-texture")),{set:function(e){e||(e=s);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(r,n),e instanceof sv&&t.bindSampler(r,c.game._gfxDevice.getSampler(e.getSamplerInfo())))}}}}]),e}(),RB=xe((wB=DB).prototype,"passIndex",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PB=xe(wB.prototype,"uniformName",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),IB=xe(wB.prototype,"channelIndex",[tl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),bB=wB))||bB,ZB=Cc("cc.animation.MorphWeightValueProxy")((LB=function(){function e(){K(this,e),ye(this,"subMeshIndex",MB,this),ye(this,"shapeIndex",kB,this)}return Z(e,[{key:"forTarget",value:function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}}}]),e}(),MB=xe((NB=LB).prototype,"subMeshIndex",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kB=xe(NB.prototype,"shapeIndex",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OB=NB))||OB,JB=Cc("cc.animation.MorphWeightsValueProxy")((UB=function(){function e(){K(this,e),ye(this,"subMeshIndex",zB,this)}return Z(e,[{key:"forTarget",value:function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}}}]),e}(),zB=xe((FB=UB).prototype,"subMeshIndex",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BB=FB))||BB,$B=Cc("cc.animation.MorphWeightsAllValueProxy")(GB=function(){function e(){K(this,e)}return Z(e,[{key:"forTarget",value:function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,a=0;a<r;++a)e.setWeights(t,a)}}}}]),e}())||GB;function eF(e,t,n,i){var r,a,o,s,c,l,u=new t,h=new t,_=new t,f=Cc(e)((l=function(){function e(n,i,r){K(this,e),ye(this,"dataPoint",o,this),ye(this,"inTangent",s,this),ye(this,"outTangent",c,this),this.dataPoint=n||new t,this.inTangent=i||new t,this.outTangent=r||new t}return Z(e,[{key:"lerp",value:function(e,t,r){var a=this.dataPoint,o=e.dataPoint;h=n(h,this.inTangent,r),_=n(_,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,f=-2*s+3*c,d=s-c;return u=n(u,a,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,o,f),u=i(u,u,_,d)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}(),o=xe((a=l).prototype,"dataPoint",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=xe(a.prototype,"inTangent",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=xe(a.prototype,"outTangent",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=a))||r;if(t===qn){var d=f.prototype.lerp;f.prototype.lerp=function(e,t,n){var i=d.call(this,e,t,n);return qn.normalize(i,i),i}}return f}var tF=e("CubicSplineVec2Value",eF("cc.CubicSplineVec2Value",ri,ri.multiplyScalar,ri.scaleAndAdd));c.CubicSplineVec2Value=tF;var nF=e("CubicSplineVec3Value",eF("cc.CubicSplineVec3Value",zn,zn.multiplyScalar,zn.scaleAndAdd));c.CubicSplineVec3Value=nF;var iF=e("CubicSplineVec4Value",eF("cc.CubicSplineVec4Value",ci,ci.multiplyScalar,ci.scaleAndAdd));c.CubicSplineVec4Value=iF;var rF=e("CubicSplineQuatValue",eF("cc.CubicSplineQuatValue",qn,qn.multiplyScalar,qn.scaleAndAdd));c.CubicSplineQuatValue=rF;var aF=e("CubicSplineNumberValue",Cc("cc.CubicSplineNumberValue")((XB=function(){function e(t,n,i){K(this,e),ye(this,"dataPoint",jB,this),ye(this,"inTangent",WB,this),ye(this,"outTangent",qB,this),this.dataPoint=t,this.inTangent=n,this.outTangent=i}return Z(e,[{key:"lerp",value:function(e,t,n){var i=this.dataPoint,r=e.dataPoint,a=t*t*t,o=t*t;return i*(2*a-3*o+1)+this.outTangent*n*(a-2*o+t)+r*(-2*a+3*o)+e.inTangent*n*(a-o)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}(),jB=xe((VB=XB).prototype,"dataPoint",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WB=xe(VB.prototype,"inTangent",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qB=xe(VB.prototype,"outTangent",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HB=VB))||HB);c.CubicSplineNumberValue=aF;var oF,sF,cF,lF,uF,hF,_F,fF,dF,pF,mF,vF,gF,yF,xF,SF,TF,EF,CF,AF,bF,wF,RF,PF,IF,DF,OF,NF="cc.animation.",MF=Symbol("CreateEval"),kF=Symbol("NormalizedFollow"),LF=Symbol("ConvertAsTrsPath"),BF=Symbol("TrackBinding"),FF=Cc("".concat(NF,"TrackPath"))((lF=function(){function e(){K(this,e),ye(this,"_paths",cF,this)}return Z(e,[{key:"length",get:function(){return this._paths.length}},{key:"toProperty",value:function(e){return this._paths.push(e),this}},{key:"toElement",value:function(e){return this._paths.push(e),this}},{key:"toHierarchy",value:function(e){return this._paths.push(new YB(e)),this}},{key:"toComponent",value:function(e){var t=new KB("string"==typeof e?e:dt.getClassName(e));return this._paths.push(t),this}},{key:"toCustomized",value:function(e){return this._paths.push(e),this}},{key:"append",value:function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,pe(n.map((function(e){return e._paths}))));return this._paths=r,this}},{key:"isPropertyAt",value:function(e){return"string"==typeof this._paths[e]}},{key:"parsePropertyAt",value:function(e){return this._paths[e]}},{key:"isElementAt",value:function(e){return"number"==typeof this._paths[e]}},{key:"parseElementAt",value:function(e){return this._paths[e]}},{key:"isHierarchyAt",value:function(e){return this._paths[e]instanceof YB}},{key:"parseHierarchyAt",value:function(e){return this.isHierarchyAt(e),this._paths[e].path}},{key:"isComponentAt",value:function(e){return this._paths[e]instanceof KB}},{key:"parseComponentAt",value:function(e){return this.isComponentAt(e),this._paths[e].component}},{key:"slice",value:function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i}},{key:"trace",value:function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[kF](e,t,n)}},{key:LF,value:function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var a=t[i];if(!(a instanceof YB))break;a.path&&(r?r+="/".concat(a.path):r=a.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}}},{key:kF,value:function(e,t,n){for(var i=this._paths,r=e,a=t;a<n;++a){var o=i[a];if(AB(o)){if(!(o in r))return P(3929,o),null;r=r[o]}else r=o.get(r);if(null===r)break}return r}}]),e}(),cF=xe((sF=lF).prototype,"_paths",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oF=sF))||oF,zF=Cc("".concat(NF,"TrackBinding"))(uF=Mc((dF=function(){function e(){K(this,e),ye(this,"path",_F,this),ye(this,"proxy",fF,this)}return Z(e,[{key:"parseTrsPath",value:function(){return this.proxy?null:this.path[LF]()}},{key:"createRuntimeBinding",value:function(e,t,n){var i=this.path,r=this.proxy,a=i.length,o=a-1;if(0===a||!i.isPropertyAt(o)&&!i.isElementAt(o)||r){if(r){var s=i[kF](e,0,a);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return D(3921),null}var h,_=i.isPropertyAt(o)?i.parsePropertyAt(o):i.parseElementAt(o),f=i[kF](e,0,a-1);return null===f?null:t&&f instanceof tb&&("position"===(h=_)||"rotation"===h||"scale"===h||"eulerAngles"===h)?t.createPoseWriter(f,_,n):{setValue:function(e){f[_]=e},getValue:function(){return f[_]}}}}]),e}(),_F=xe((hF=dF).prototype,"path",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new FF}}),fF=xe(hF.prototype,"proxy",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uF=hF))||uF)||uF,UF=Cc("".concat(NF,"Track"))((gF=function(){function e(){K(this,e),ye(this,"_binding",vF,this)}return Z(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:BF,get:function(){return this._binding}},{key:"channels",value:function(){return[]}},{key:"range",value:function(){for(var e,t={min:1/0,max:-1/0},n=ge(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t}}]),e}(),vF=xe((mF=gF).prototype,"_binding",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zF}}),pF=mF))||pF,GF=Cc("".concat(NF,"Channel"))((TF=function(){function e(t){K(this,e),this.name="",ye(this,"_curve",SF,this),this._curve=t}return Z(e,[{key:"curve",get:function(){return this._curve}}]),e}(),SF=xe((xF=TF).prototype,"_curve",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yF=xF))||yF,HF=Cc("".concat(NF,"SingleChannelTrack"))((bF=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"_channel",AF,se(e)),e._channel=new GF(e.createCurve()),e}return Z(n,[{key:"channel",get:function(){return this._channel}},{key:"channels",value:function(){return[this._channel]}},{key:"createCurve",value:function(){throw new Error("Not impl")}},{key:MF,value:function(){var e=this._channel.curve;return new VF(e)}}]),n}(UF),AF=xe((CF=bF).prototype,"_channel",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),EF=CF))||EF,VF=function(){function e(t){K(this,e),this._curve=t}return Z(e,[{key:"evaluate",value:function(e){return this._curve.evaluate(e)}}]),e}(),jF=Cc("".concat(NF,"RealTrack"))(wF=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"createCurve",value:function(){return new Af}}]),n}(HF))||wF;function WF(e){return 0===e.keyFramesCount?void 0:e}var qF,XF,YF,KF,QF,ZF,JF,$F,ez,tz,nz=["X","Y","Z","W"],iz=Cc("".concat(NF,"VectorTrack"))((OF=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n),ye(e=t.call(this),"_channels",IF,se(e)),ye(e,"_nComponents",DF,se(e)),e._channels=new Array(4);for(var i=0;i<e._channels.length;++i){var r=new GF(new Af);r.name=nz[i],e._channels[i]=r}return e}return Z(n,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}},{key:"channels",value:function(){return this._channels}},{key:MF,value:function(){switch(this._nComponents){default:case 2:return new rz(WF(this._channels[0].curve),WF(this._channels[1].curve));case 3:return new az(WF(this._channels[0].curve),WF(this._channels[1].curve),WF(this._channels[2].curve));case 4:return new oz(WF(this._channels[0].curve),WF(this._channels[1].curve),WF(this._channels[2].curve),WF(this._channels[3].curve))}}}]),n}(UF),IF=xe((PF=OF).prototype,"_channels",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),DF=xe(PF.prototype,"_nComponents",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),RF=PF))||RF,rz=function(){function e(t,n){K(this,e),this._result=new ri,this._x=t,this._y=n}return Z(e,[{key:"evaluate",value:function(e,t){return this._x&&this._y||!t.getValue||ri.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result}}]),e}(),az=function(){function e(t,n,i){K(this,e),this._result=new zn,this._x=t,this._y=n,this._z=i}return Z(e,[{key:"evaluate",value:function(e,t){return this._x&&this._y&&this._z||!t.getValue||zn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result}}]),e}(),oz=function(){function e(t,n,i,r){K(this,e),this._result=new ci,this._x=t,this._y=n,this._z=i,this._w=r}return Z(e,[{key:"evaluate",value:function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||ci.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result}}]),e}(),sz=Cc("".concat(NF,"QuatTrack"))(qF=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"createCurve",value:function(){return new hd}},{key:MF,value:function(){return new cz(this.channels()[0].curve)}}]),n}(HF))||qF,cz=function(){function e(t){K(this,e),this._result=new qn,this._curve=t}return Z(e,[{key:"evaluate",value:function(e){return this._curve.evaluate(e,this._result),this._result}}]),e}(),lz=["Red","Green","Blue","Alpha"],uz=Cc("".concat(NF,"ColorTrack"))((QF=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n),ye(e=t.call(this),"_channels",KF,se(e)),e._channels=new Array(4);for(var i=0;i<e._channels.length;++i){var r=new GF(new Af);r.name=lz[i],e._channels[i]=r}return e}return Z(n,[{key:"channels",value:function(){return this._channels}},{key:MF,value:function(){return new hz(WF(this._channels[0].curve),WF(this._channels[1].curve),WF(this._channels[2].curve),WF(this._channels[3].curve))}}]),n}(UF),KF=xe((YF=QF).prototype,"_channels",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XF=YF))||XF,hz=function(){function e(t,n,i,r){K(this,e),this._result=new Bn,this._x=t,this._y=n,this._z=i,this._w=r}return Z(e,[{key:"evaluate",value:function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Bn.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result}}]),e}(),_z=["Width","Height"],fz=Cc("".concat(NF,"SizeTrack"))((ez=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n),ye(e=t.call(this),"_channels",$F,se(e)),e._channels=new Array(2);for(var i=0;i<e._channels.length;++i){var r=new GF(new Af);r.name=_z[i],e._channels[i]=r}return e}return Z(n,[{key:"channels",value:function(){return this._channels}},{key:MF,value:function(){return new dz(WF(this._channels[0].curve),WF(this._channels[1].curve))}}]),n}(UF),$F=xe((JF=ez).prototype,"_channels",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ZF=JF))||ZF,dz=function(){function e(t,n){K(this,e),this._result=new hi,this._width=t,this._height=n}return Z(e,[{key:"evaluate",value:function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result}}]),e}(),pz=Cc("".concat(NF,"ObjectTrack"))(tz=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"createCurve",value:function(){return new bd}}]),n}(HF))||tz;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:QB,MorphWeightValueProxy:ZB,MorphWeightsValueProxy:JB,MorphWeightsAllValueProxy:$B,Track:UF,TrackPath:FF,RealTrack:jF,VectorTrack:iz,QuatTrack:sz,ColorTrack:uz,SizeTrack:fz,ObjectTrack:pz,isPropertyPath:AB,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:YB,ComponentPath:KB,CubicSplineVec2Value:tF,CubicSplineVec3Value:nF,CubicSplineVec4Value:iF,CubicSplineQuatValue:rF,CubicSplineNumberValue:aF}));var mz=Symbol("BakeNodeCurves"),vz=function(){function e(){K(this,e)}return Z(e,null,[{key:"getOrExtract",value:function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&c.director.root.dataPoolManager.releaseAnimationClip(t);var i=Math.ceil(t.sample*t.duration)+1,r=t.sample;n=t[mz](0,r,i),e.pool.set(t,n)}return n}},{key:"destroy",value:function(t){e.pool.delete(t)}}]),e}();vz.pool=new Map;var gz=e("RatioSampler",function(){function e(t){var n,i;K(this,e),this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var r=!0,a=1,o=t.length;a<o;a++)if(n=t[a]-t[a-1],1===a)i=n;else if(Math.abs(n-i)>1e-6){r=!1;break}this._findRatio=r?Tz:pc}return Z(e,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),e}());c.RatioSampler=gz;var yz=e("AnimCurve",function(){function e(t,n){K(this,e),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,a=Object.keys(t.easingMethods);r<a.length;r++){var o=a[r];this.types[o]=i(t.easingMethods[o])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=Dz(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}return Z(e,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array}},{key:"valueBetween",value:function(e,t,n,i,r){if(this._lerp){var a=this.types?this.types[t]:this.type,o=r-n,s=(e-n)/o;if(a&&(s=Sz(s,a)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,o*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array}},{key:"empty",value:function(){return 0===this._values.length}},{key:"constant",value:function(){return 1===this._values.length}}],[{key:"Bezier",value:function(e){return e}}]),e}());function xz(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function Sz(e,t){if("string"==typeof t){var n=hf[t];n?e=n(e):D(3906,t)}else Array.isArray(t)&&(e=sd(t,e));return e}function Tz(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var a=(t=(t-i)/(r-i))/(1/n),o=0|a,s=1e-6;return a-o<s?o:o+1-a<s?o+1:~(o+1)}yz.Linear=null,c.AnimCurve=yz,e("EventInfo",function(){function e(){K(this,e),this.events=[]}return Z(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}()),c.sampleAnimationCurve=xz;var Ez,Cz,Az,bz,wz,Rz,Pz,Iz,Dz=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return xn;if("object"===Y(t)&&t.constructor){if(t instanceof qn)return n=new qn,function(e,t,i){return qn.slerp(n,e,t,i)};if(t instanceof xt)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return xn;if("function"==typeof t.lerp)return e}var n}}}(),Oz=Cc("".concat(NF,"UntypedTrackChannel"))((bz=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this,new Af),"property",Az,se(e)),e}return n}(GF),Az=xe((Cz=bz).prototype,"property",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ez=Cz))||Ez,Nz=Cc("".concat(NF,"UntypedTrack"))((Iz=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_channels",Pz,se(e)),e}return Z(n,[{key:"channels",value:function(){return this._channels}},{key:MF,value:function(e){var t=this;if(!e.getValue)throw new Error(k(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(k(3931));case i instanceof ri:return new rz(n("x"),n("y"));case i instanceof zn:return new az(n("x"),n("y"),n("z"));case i instanceof ci:return new oz(n("x"),n("y"),n("z"),n("w"));case i instanceof Bn:return new hz(n("r"),n("g"),n("b"),n("a"));case i instanceof hi:return new dz(n("width"),n("height"))}}},{key:"addChannel",value:function(e){var t=new Oz;return t.property=e,this._channels.push(t),t}},{key:"upgrade",value:function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new iz;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var a=de(r.channels(),4),o=a[0],s=a[1],c=a[2],l=a[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",o),n("y",s)}return r;case"color":var u=new uz,h=de(u.channels(),4),_=h[0],f=h[1],d=h[2],p=h[3];return n("r",_),n("g",f),n("b",d),n("a",p),n("x",_),n("y",f),n("z",d),n("w",p),u;case"size":}return null}}]),n}(UF),Pz=xe((Rz=Iz).prototype,"_channels",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wz=Rz))||wz,Mz=function(){function e(t){K(this,e),this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}return Z(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}},{key:"getPropertyCurves",value:function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"toTracks",value:function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,a=function(e,t,n){for(var i,r=new FF,a=ge(t);!(i=a()).done;){var o=i.value;"string"==typeof o?r.toProperty(o):"number"==typeof o?r.toElement(o):o instanceof YB?r.toHierarchy(o.path):o instanceof KB?r.toComponent(o.component):r.toCustomized(o)}e.path=r,e.proxy=n},o=r.map((function(e){var n=new Nz;return a(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new Lz(s,l.length),f=function(e){a(e,r.modifiers,r.valueAdapter)},d=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return P(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return P(3933),"continue";var p=r.modifiers[0],m=o[r.commonTarget].addChannel(p).curve;d=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void P(3934);var e;if(d)e=d;else{var n=new jF;f(n),t.push(n),e=n.channel.curve}var i=h?hl.LINEAR:hl.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void _.convert(e)}if("object"===Y(u))switch(!0){default:break;case kz(c,ri):case kz(c,zn):case kz(c,ci):var r=u instanceof ri?2:u instanceof zn?3:4,a=new iz;f(a),a.componentsCount=r;var o=de(a.channels(),4),s=o[0].curve,p=o[1].curve,m=o[2].curve,v=o[3].curve,g=h?hl.LINEAR:hl.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),_.convert(s),p.assignSorted(l,c.map((function(e){return y(e.y)}))),_.convert(p)}return void t.push(a);case kz(c,qn):var x=new sz;f(x);var S=h?ed.SLERP:ed.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(e){return{value:qn.clone(e),interpolationMode:S}}))),_.convertQuatCurve(x.channel.curve),void t.push(x);case kz(c,Bn):var T=new uz;f(T);var E=de(T.channels(),4),C=E[0].curve,A=E[1].curve,b=E[2].curve,w=E[3].curve,R=h?hl.LINEAR:hl.CONSTANT,I=function(e){return{value:e,interpolationMode:R}};return C.assignSorted(l,c.map((function(e){return I(e.r)}))),_.convert(C),A.assignSorted(l,c.map((function(e){return I(e.g)}))),_.convert(A),b.assignSorted(l,c.map((function(e){return I(e.b)}))),_.convert(b),w.assignSorted(l,c.map((function(e){return I(e.a)}))),_.convert(w),void t.push(T);case kz(c,hi):var D=new fz;f(D);var O=de(D.channels(),2),N=O[0].curve,M=O[1].curve,k=h?hl.LINEAR:hl.CONSTANT,L=function(e){return{value:e,interpolationMode:k}};return N.assignSorted(l,c.map((function(e){return L(e.width)}))),_.convert(N),M.assignSorted(l,c.map((function(e){return L(e.height)}))),_.convert(M),void t.push(D);case kz(c,aF):var B=new jF;f(B);var F=h?hl.CUBIC:hl.CONSTANT;return B.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:F}}))),void t.push(B);case kz(c,tF):case kz(c,nF):case kz(c,iF):var z=u instanceof tF?2:u instanceof nF?3:4,U=new iz;f(U),U.componentsCount=z;var G=de(U.channels(),4),H=G[0],V=G[1],j=G[2],W=G[3],q=h?hl.LINEAR:hl.CONSTANT,X=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:q}};switch(z){case 4:W.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(U);case c.every((function(e){return e instanceof rF})):P(3935)}var K=new pz;f(K),K.channel.curve.assignSorted(l,c),t.push(K)}()},c=ge(i);!(e=c()).done;)s();return t}},{key:"_createPropertyCurves",value:function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new gz(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new yz(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))}}]),e}();function kz(e,t){return e.every((function(e){return e instanceof t}))}var Lz=function(){function e(t,n){K(this,e),this._easingMethods=void 0;var i=t.easingMethods;Array.isArray(i)?0===i.length&&0!==n?this._easingMethods=new Array(n).fill(null):this._easingMethods=i:this._easingMethods=void 0===i?new Array(n).fill(t.easingMethod):Array.from({length:n},(function(e,t){var n;return null!==(n=i[t])&&void 0!==n?n:null}))}return Z(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}},{key:"convert",value:function(e){var t,n,i,r,a,o,s,c,l,u,h,_,f,d,p,m,v,g,y,x,S,T,E,C=this._easingMethods;if(C){var A=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(C)&&C.length;for(var b=A-1,w=0;w<b;++w){var R=C[w];R&&(Array.isArray(R)?(t=R,n=e.getKeyframeTime(w),i=e.getKeyframeValue(w),r=e.getKeyframeTime(w+1),a=e.getKeyframeValue(w+1),o=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,d=void 0,p=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,T=void 0,E=void 0,s=de(t,4),c=s[0],l=s[1],u=s[2],h=s[3],_=i.value,f=3*(r-n),d=3*(a.value-_),v=(1-u)*f,g=(1-h)*d,y=1/3,x=(m=l*d)/(p=c*f),S=Math.sqrt(p*p+m*m)*y,T=g/v,E=Math.sqrt(v*v+g*g)*y,i.interpolationMode=hl.CUBIC,i.tangentWeightMode=(o=i.tangentWeightMode)===fl.NONE?fl.RIGHT:o===fl.LEFT?fl.BOTH:o,i.rightTangent=x,i.rightTangentWeight=S,a.tangentWeightMode=function(e){return e===fl.NONE?fl.LEFT:e===fl.RIGHT?fl.BOTH:e}(a.tangentWeightMode),a.leftTangent=T,a.leftTangentWeight=E):Bz(R,e,w))}}}}},{key:"convertQuatCurve",value:function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var a=t[r];a&&(Array.isArray(a)?e.getKeyframeValue(r).easingMethod=a.slice():Fz(a,e,r))}}}}}]),e}();function Bz(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=dU[e];r===uf.CONSTANT?i.interpolationMode=hl.CONSTANT:(i.interpolationMode=hl.LINEAR,i.easingMethod=r)}function Fz(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=dU[e];i.easingMethod=r}var zz,Uz,Gz,Hz,Vz,jz,Wz,qz,Xz,Yz,Kz,Qz,Zz,Jz,$z,eU,tU,nU,iU,rU,aU,oU,sU,cU,lU,uU,hU,_U,fU,dU={constant:uf.CONSTANT,linear:uf.LINEAR,quadIn:uf.QUAD_IN,quadOut:uf.QUAD_OUT,quadInOut:uf.QUAD_IN_OUT,quadOutIn:uf.QUAD_OUT_IN,cubicIn:uf.CUBIC_IN,cubicOut:uf.CUBIC_OUT,cubicInOut:uf.CUBIC_IN_OUT,cubicOutIn:uf.CUBIC_OUT_IN,quartIn:uf.QUART_IN,quartOut:uf.QUART_OUT,quartInOut:uf.QUART_IN_OUT,quartOutIn:uf.QUART_OUT_IN,quintIn:uf.QUINT_IN,quintOut:uf.QUINT_OUT,quintInOut:uf.QUINT_IN_OUT,quintOutIn:uf.QUINT_OUT_IN,sineIn:uf.SINE_IN,sineOut:uf.SINE_OUT,sineInOut:uf.SINE_IN_OUT,sineOutIn:uf.SINE_OUT_IN,expoIn:uf.EXPO_IN,expoOut:uf.EXPO_OUT,expoInOut:uf.EXPO_IN_OUT,expoOutIn:uf.EXPO_OUT_IN,circIn:uf.CIRC_IN,circOut:uf.CIRC_OUT,circInOut:uf.CIRC_IN_OUT,circOutIn:uf.CIRC_OUT_IN,elasticIn:uf.ELASTIC_IN,elasticOut:uf.ELASTIC_OUT,elasticInOut:uf.ELASTIC_IN_OUT,elasticOutIn:uf.ELASTIC_OUT_IN,backIn:uf.BACK_IN,backOut:uf.BACK_OUT,backInOut:uf.BACK_IN_OUT,backOutIn:uf.BACK_OUT_IN,bounceIn:uf.BOUNCE_IN,bounceOut:uf.BOUNCE_OUT,bounceInOut:uf.BOUNCE_IN_OUT,bounceOutIn:uf.BOUNCE_OUT_IN,smooth:uf.SMOOTH,fade:uf.FADE};function pU(){throw new Error("split() only valid in Editor.")}Cc("".concat(NF,"ExoticAnimation"))((Gz=function(){function e(){K(this,e),ye(this,"_nodeAnimations",Uz,this)}return Z(e,[{key:"createEvaluator",value:function(e){return new AU(this._nodeAnimations,e)}},{key:"addNodeAnimation",value:function(e){var t=new mU(e);return this._nodeAnimations.push(t),t}},{key:"collectAnimatedJoints",value:function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))}},{key:"split",value:function(){return pU()}},{key:"toHashString",value:function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")}}]),e}(),Uz=xe((zz=Gz).prototype,"_nodeAnimations",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zz));var mU=Cc("".concat(NF,"ExoticNodeAnimation"))((Yz=function(){function e(t){K(this,e),ye(this,"_path",jz,this),ye(this,"_position",Wz,this),ye(this,"_rotation",qz,this),ye(this,"_scale",Xz,this),this._path=t}return Z(e,[{key:"createPosition",value:function(e,t){this._position=new TU(e,new xU(t))}},{key:"createRotation",value:function(e,t){this._rotation=new TU(e,new SU(t))}},{key:"createScale",value:function(e,t){this._scale=new TU(e,new xU(t))}},{key:"createEvaluator",value:function(e){return new bU(this._path,this._position,this._rotation,this._scale,e)}},{key:"split",value:function(){return pU()}},{key:"path",get:function(){return this._path}},{key:"toHashString",value:function(){var e,t,n,i,r,a;return"".concat(this._path,"\n").concat(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"").concat(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"").concat(null!==(r=null===(a=this._rotation)||void 0===a?void 0:a.toHashString())&&void 0!==r?r:"")}}]),e}(),jz=xe((Vz=Yz).prototype,"_path",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Wz=xe(Vz.prototype,"_position",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qz=xe(Vz.prototype,"_rotation",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xz=xe(Vz.prototype,"_scale",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hz=Vz))||Hz;function vU(e){return e.toPrecision(2)}function gU(e){return e.map(vU).join(" ")}var yU=Cc("".concat(NF,"ExoticVectorLikeTrackValues"))(($z=function(){function e(t){K(this,e),ye(this,"_values",Zz,this),ye(this,"_isQuantized",Jz,this),this._values=t,this._isQuantized=!1}return Z(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:PU(this._values)}},{key:"quantize",value:function(e){this._isQuantized,this._values=function(e,t){var n=RU[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),a=Math.max(e,a)}));var o=a-r,s=n.from(e,(function(e){return(e-r)/o*i}));return new VU(PU(e),s,o,r)}(this._values,e),this._isQuantized=!0}},{key:"toHashString",value:function(){var e=this._isQuantized,t=this._values;return"".concat(e," ").concat(e?t.toHashString():gU(t))}}]),e}(),Zz=xe((Qz=$z).prototype,"_values",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Jz=xe(Qz.prototype,"_isQuantized",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Kz=Qz))||Kz,xU=Cc("".concat(NF,"ExoticVec3TrackValues"))(eU=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"get",value:function(e,t){var n=this._values;this._isQuantized?qU(n,e,t):zn.fromArray(t,n,3*e)}},{key:"lerp",value:function(e,t,n,i,r,a){var o=this._values;this._isQuantized?(qU(o,e,i),qU(o,t,r)):(zn.fromArray(i,o,3*e),zn.fromArray(r,o,3*t)),zn.lerp(a,i,r,n)}}],[{key:"imitate",value:function(e,t){var i=new n(e);return t._isQuantized&&i.quantize(t._values.quantizationType),i}}]),n}(yU))||eU,SU=Cc("".concat(NF,"ExoticQuatTrackValues"))(tU=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"get",value:function(e,t){var n=this._values;this._isQuantized?XU(n,e,t):qn.fromArray(t,n,4*e)}},{key:"lerp",value:function(e,t,n,i,r,a){var o=this._values;this._isQuantized?(XU(o,e,i),XU(o,t,r)):(qn.fromArray(i,o,4*e),qn.fromArray(r,o,4*t)),qn.slerp(a,i,r,n)}}],[{key:"imitate",value:function(e,t){var i=new n(e);return t._isQuantized&&i.quantize(t._values.quantizationType),i}}]),n}(yU))||tU,TU=Cc("".concat(NF,"ExoticTrack"))((oU=function(){function e(t,n){K(this,e),ye(this,"times",rU,this),ye(this,"values",aU,this),this.times=t,this.values=n}return Z(e,[{key:"toHashString",value:function(){var e=this.times,t=this.values;return"times: ".concat(gU(e),"; values: ").concat(t.toHashString())}}]),e}(),rU=xe((iU=oU).prototype,"times",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),aU=xe(iU.prototype,"values",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),nU=iU))||nU;function EU(e,t){e.length,e.length;var n=0,i=0,r=pc(e,t);if(r>=0)n=r;else{var a=~r,o=a-1;n=o;var s=e[a],c=e[o];i=(t-c)/(s-c)}return{index:n,ratio:i}}Z((function e(){K(this,e),this._reset()}),[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}},{key:"transformTime",value:function(e){return e-this._timeOffset}},{key:"calculate",value:function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],a=e[i-1],o=gn(t,r,a),s=gn(n,r,a);this._timeOffset=o;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=EU(e,t),a=r.index,o=r.ratio,s=EU(e,n);return{fromIndex:a,fromRatio:o,toIndex:s.index,toRatio:s.ratio}}(e,o,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,d=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,d||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}}},{key:"_reset",value:function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0}}]);var CU,AU=function(){function e(t,n){K(this,e),this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((function(e){return e.createEvaluator(n)}))}return Z(e,[{key:"evaluate",value:function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))}}]),e}(),bU=function(){function e(t,n,i,r,a){K(this,e),this._position=null,this._rotation=null,this._scale=null,n&&(this._position=WU(n.times,n.values,zn,t,"position",a)),i&&(this._rotation=WU(i.times,i.values,qn,t,"rotation",a)),r&&(this._scale=WU(r.times,r.values,zn,t,"scale",a))}return Z(e,[{key:"evaluate",value:function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}}}]),e}(),wU=function(){function e(t,n,i){K(this,e),this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=n,this._prevValue=new i,this._nextValue=new i,this._resultValue=new i}return Z(e,[{key:"evaluate",value:function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],a=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>a)n.just=!0,n.index=i-1;else{var o=pc(e,t);if(o>=0)n.just=!0,n.index=o;else{var s=~o,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i}}]),e}(),RU={uint8:Uint8Array,uint16:Uint16Array};function PU(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return CU.FLOAT_32;case 8:return CU.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(CU||(CU={}));var IU,DU,OU,NU,MU,kU,LU,BU,FU,zU,UU,GU,HU,VU=Cc("".concat(NF,"QuantizedFloatArray"))((fU=function(){function e(t,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;K(this,e),ye(this,"originalPrecision",lU,this),ye(this,"min",uU,this),ye(this,"extent",hU,this),ye(this,"values",_U,this),this.originalPrecision=t,this.values=n,this.extent=i,this.min=r}return Z(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}},{key:"toHashString",value:function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return"".concat(e," ").concat(vU(t)," ").concat(vU(n)," ").concat(i.join(" "))}}]),e}(),lU=xe((cU=fU).prototype,"originalPrecision",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uU=xe(cU.prototype,"min",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hU=xe(cU.prototype,"extent",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_U=xe(cU.prototype,"values",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),sU=cU))||sU;function jU(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function WU(e,t,n,i,r,a){var o=new zF;o.path=(new FF).toHierarchy(i).toProperty(r);var s=a(o);return s?{runtimeBinding:s,evaluator:new wU(e,t,n)}:null}function qU(e,t,n){zn.set(n,jU(e,3*t+0),jU(e,3*t+1),jU(e,3*t+2))}function XU(e,t,n){qn.set(n,jU(e,4*t+0),jU(e,4*t+1),jU(e,4*t+2),jU(e,4*t+3))}var YU=Symbol("SearchForRootBonePath"),KU=Symbol("ExoticAnimation"),QU=e("AnimationClip",Cc("cc.AnimationClip")((HU=GU=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"sample",OU,se(e)),ye(e,"speed",NU,se(e)),ye(e,"wrapMode",MU,se(e)),ye(e,"enableTrsBlending",kU,se(e)),ye(e,"_duration",LU,se(e)),ye(e,"_hash",BU,se(e)),e.frameRate=0,ye(e,"_tracks",FU,se(e)),ye(e,"_exoticAnimation",zU,se(e)),e._legacyData=void 0,e._legacyDataDirty=!1,ye(e,"_events",UU,se(e)),e._runtimeEvents={ratios:[],eventGroups:[]},e}return Z(n,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:".concat(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=wa(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),a=r.length,o=function(e){var a=r[e],o=a.frame/t._duration,s=n.findIndex((function(e){return e===o}));s<0&&(s=n.length,n.push(o),i.push({events:[]})),i[s].events.push({functionName:a.func,parameters:a.params})},s=0;s<a;++s)o(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:KU,get:function(){return this._exoticAnimation}},{key:KU,set:function(e){this._exoticAnimation=e}},{key:"onLoaded",value:function(){this.frameRate=this.sample,this.events=this._events}},{key:"range",value:function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e}},{key:"getTrack",value:function(e){return this._tracks[e]}},{key:"addTrack",value:function(e){var t=this._tracks.length;return this._tracks.push(e),t}},{key:"removeTrack",value:function(e){this._tracks.splice(e,1)}},{key:"clearTracks",value:function(){this._tracks.length=0}},{key:"createEventEvaluator",value:function(e){return new rG(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)}},{key:"createEvaluator",value:function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}),e.rootMotion)}},{key:"destroy",value:function(){var e;return(null===(e=c.director.root)||void 0===e?void 0:e.dataPoolManager)&&c.director.root.dataPoolManager.releaseAnimationClip(this),vz.destroy(this),he(ne(n.prototype),"destroy",this).call(this)}},{key:mz,value:function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),a=r.length,o={},s=0;s<a;++s)o[r[s]]={transforms:Array.from({length:n},(function(){return new ei}))};var c=r.reduce((function(e,t){return e[t]=new $U,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var d=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return iG(n,t.property)}}),void 0),p=0;p<n;++p){var m=e+i*p;d.evaluate(m);for(var v=0;v<a;++v){var g=r[v];ei.copy(o[g].transforms[p],c[g].globalTransform)}for(var y=0;y<a;++y){var x=r[y];c[x].invalidate()}}return{samples:t,frames:n,joints:o}}},{key:"upgradeUntypedTracks",value:function(e){for(var t=[],n=[],i=this._tracks,r=i.length,a=0;a<r;++a){var o=i[a];if(o instanceof Nz){var s=o.upgrade(e);s&&(t.push(s),n.push(o))}}for(var c=n.length,l=0;l<c;++l)ft.remove(i,n[l]);i.push.apply(i,t)}},{key:YU,value:function(){return this._searchForRootBonePath()}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"getPropertyCurves",value:function(){return this._getLegacyData().getPropertyCurves()}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}},{key:"updateEventDatas",value:function(){this.events=this._events}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"syncLegacyData",value:function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)}},{key:"_createEvalWithBinder",value:function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var a,o=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[BF]);if(h){var _=u[MF](h);o.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(a=this._exoticAnimation.createEvaluator(t)),new ZU(o,a,i)}},{key:"_createRootMotionEvaluation",value:function(e,t,n){if(e instanceof tb){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var a=new JU,o=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[BF].parseTrsPath();if(h&&h.node===i){n.push(u);var _=iG(a,h.property);if(_){var f=u[MF](_);o.push({binding:_,trackEval:f})}}}return new tG(r,this._duration,a,o)}P(3924)}else P(3923)}else D(3920)}},{key:"_searchForRootBonePath",value:function(){var e=this._tracks.map((function(e){var t=e[BF].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,a=t+1;a<n;++a){var o=e[a];if(o.rank!==i.rank)break;if(o.path!==i.path){r=!1;break}}return r?i.path:""}},{key:"_getLegacyData",value:function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData}},{key:"_toLegacy",value:function(){var e=new Mz(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e}},{key:"_fromLegacy",value:function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])}},{key:"_collectAnimatedJoints",value:function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][BF].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var a=this._exoticAnimation.collectAnimatedJoints(),o=a.length,s=0;s<o;++s)e.add(a[s]);return Array.from(e)}}],[{key:"createWithSpriteFrames",value:function(e,t){var i=new n;i.sample=t||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,a=new pz;return a.path=(new FF).toComponent("cc.Sprite").toProperty("spriteFrame"),a.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(a),i}}]),n}(Uu),GU.WrapMode=lc,OU=xe((DU=HU).prototype,"sample",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),NU=xe(DU.prototype,"speed",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),MU=xe(DU.prototype,"wrapMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lc.Normal}}),kU=xe(DU.prototype,"enableTrsBlending",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LU=xe(DU.prototype,"_duration",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BU=xe(DU.prototype,"_hash",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FU=xe(DU.prototype,"_tracks",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zU=xe(DU.prototype,"_exoticAnimation",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UU=xe(DU.prototype,"_events",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IU=DU))||IU);c.AnimationClip=QU;var ZU=function(){function e(t,n,i){K(this,e),this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=n,this._rootMotionEvaluation=i}return Z(e,[{key:"evaluate",value:function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var a=t[r],o=a.trackEval,s=a.binding,c=o.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)}},{key:"evaluateRootMotion",value:function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)}}]),e}(),JU=function(){function e(){K(this,e),this.position=new zn,this.scale=new zn(1,1,1),this.rotation=new qn,this.eulerAngles=new zn}return Z(e,[{key:"getTransform",value:function(e){ei.fromRTS(e,this.rotation,this.position,this.scale)}}]),e}(),$U=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).parent=null,e._dirty=!0,e._transform=new ei,e}return Z(n,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,ei.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&ei.multiply(e,this.parent.globalTransform,e)),this._transform}},{key:"invalidate",value:function(){this._dirty=!0}}]),n}(JU),eG=new ei,tG=function(){function e(t,n,i,r){K(this,e),this._initialTransformCache=new ei,this._clipEndTransformCache=new ei,this._startTransformCache=new ei,this._endTransformCache=new ei,this._motionTransformCache=new ei,this._translationMotionCache=new zn,this._rotationMotionCache=new qn,this._scaleMotionCache=new zn,this._rootBone=t,this._duration=n,this._boneTransform=i,this._trackEvalStatuses=r}return Z(e,[{key:"evaluate",value:function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,a=this._scaleMotionCache,o=this._rootBone;ei.toRTS(n,r,i,a),zn.add(i,i,o.position),o.setPosition(i),qn.multiply(r,r,o.rotation),o.setRotation(r),zn.multiply(a,a,o.scale),o.setScale(a)}},{key:"_calcMotionTransform",value:function(e,t,n){var i=this._duration,r=i-e,a=this._evaluateAt(e,this._startTransformCache);if(t<r){var o=this._evaluateAt(e+t,this._endTransformCache);nG(n,a,o)}else{ei.identity(n);var s=function(e,t){nG(eG,e,t),ei.multiply(n,n,eG)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(a,_),nG(eG,h,_);for(var d=0;d<l;++d)ei.multiply(n,n,eG);s(h,f)}return n}},{key:"_evaluateAt",value:function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var a=n[r],o=a.trackEval,s=a.binding,c=o.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t}}]),e}();function nG(e,t,n){ei.invert(e,t),ei.multiply(e,n,e)}function iG(e,t){switch(t){default:return;case"position":return{setValue:function(t){zn.copy(e.position,t)}};case"rotation":return{setValue:function(t){qn.copy(e.rotation,t)}};case"scale":return{setValue:function(t){zn.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){zn.copy(e.eulerAngles,t)}}}}var rG=function(){function e(t,n,i,r){K(this,e),this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=n,this._eventGroups=i,this._wrapMode=r}return Z(e,[{key:"setWrapMode",value:function(e){this._wrapMode=e}},{key:"ignore",value:function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=oG(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)}},{key:"sample",value:function(e,t,n){var i=this._eventGroups.length,r=oG(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var a=this._wrapMode,o=aG(n),s=aG(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&o!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((a&cc.PingPong)===cc.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((a&cc.PingPong)===cc.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>o)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t}},{key:"_doFire",value:function(e,t){t?c.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)}},{key:"_checkAndFire",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,a=0;a<r;++a)for(var o=n.events[a],s=o.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,o.parameters)}}}}]),e}();function aG(e){return e-(0|e)==0&&(e-=1),0|e}function oG(e,t){return pc(t,e)}var sG,cG=function(){function e(){K(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return Z(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}},{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(k(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(){}}]),e}(),lG=function(){function e(t){K(this,e),this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}return Z(e,[{key:"destroy",value:function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0}},{key:"createPoseWriter",value:function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i}}]),e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(sG||(sG={})),yt(sG);var uG=e("AnimationState",function(e){te(n,e);var t=le(n);function n(e){var i,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return K(this,n),(i=t.call(this)).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=lc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new dc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=e,i._name=r||e&&e.name,i._playbackRange={min:0,max:e.duration},i._playbackDuration=e.duration,e.duration||T("Clip ".concat(e.name," has zero duration.")),i}return Z(n,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&cc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&cc.ShouldWrap,n=(this.wrapMode&cc.Reverse)===cc.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}},{key:"initialize",value:function(e,t){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&cc.Loop)===cc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var i,r,a,o=null!==(i=null!=t?t:null===(r=c.director.getAnimationManager())||void 0===r?void 0:r.blendState)&&void 0!==i?i:null;o&&(this._poseOutput=new lG(o)),this._clipEval=n.createEvaluator({target:e,pose:null!==(a=this._poseOutput)&&void 0!==a?a:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}}},{key:"destroy",value:function(){this.isMotionless||c.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0}},{key:"emit",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];c.director.getAnimationManager().pushDelayEvent(this._emit,this,t)}},{key:"on",value:function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null}},{key:"once",value:function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null}},{key:"off",value:function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)}},{key:"allowLastFrameEvent",value:function(e){this._allowLastFrame=e}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)}},{key:"update",value:function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e}},{key:"onPlay",value:function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(sG.PLAY,this)}},{key:"onStop",value:function(){this.isPaused||this._onPauseOrStop(),this.emit(sG.STOP,this)}},{key:"onResume",value:function(){this._onReplayOrResume(),this.emit(sG.RESUME,this)}},{key:"onPause",value:function(){this._onPauseOrStop(),this.emit(sG.PAUSE,this)}},{key:"_sampleCurves",value:function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)}},{key:"_process",value:function(){this._useSimpleProcess?this.simpleProcess():this.process()}},{key:"process",value:function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new dc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(sG.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(sG.FINISHED,this))}},{key:"simpleProcess",value:function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(sG.LASTFRAME,this),this._lastIterations=i)}},{key:"_needReverse",value:function(e){var t=this.wrapMode,n=!1;return(t&cc.PingPong)===cc.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&cc.Reverse)===cc.Reverse&&(n=!n),n}},{key:"getWrappedInfo",value:function(e,t){t=t||new dc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,a=this.repeatCount,o=(e-=n)>0?e/i:-e/i;if(o>=a){o=a,r=!0;var s=a-(0|a);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&cc.ShouldWrap;u&&(l=this._needReverse(o));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=o,t}},{key:"_getPlaybackStart",value:function(){return this._playbackRange.min}},{key:"_getPlaybackEnd",value:function(){return this._playbackRange.max}},{key:"_sampleEvents",value:function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"_onReplayOrResume",value:function(){c.director.getAnimationManager().addAnimation(this)}},{key:"_onPauseOrStop",value:function(){c.director.getAnimationManager().removeAnimation(this)}}]),n}(cG));c.AnimationState=uG;var hG,_G,fG,dG,pG,mG,vG,gG,yG,xG,SG,TG,EG,CG,AG,bG,wG,RG=function(e){te(n,e);var t=le(n);function n(e){var i;return K(this,n),(i=t.call(this))._managedStates=[],i._fadings=[],i._scheduled=!1,i._scheduler=null!=e?e:c.director.getAnimationManager(),i}return Z(n,[{key:"update",value:function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}}},{key:"crossFade",value:function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}},{key:"onPlay",value:function(){he(ne(n.prototype),"onPlay",this).call(this),this._scheduleThis()}},{key:"onPause",value:function(){he(ne(n.prototype),"onPause",this).call(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.pause()}this._unscheduleThis()}},{key:"onResume",value:function(){he(ne(n.prototype),"onResume",this).call(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.resume()}this._scheduleThis()}},{key:"onStop",value:function(){he(ne(n.prototype),"onStop",this).call(this),this.clear()}},{key:"_calculateWeights",value:function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var a=1,o=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:yn(c.easeTime/c.easeDuration),u=l*a;if(a*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){o=s+1,c.easeTime=c.easeDuration;break}}if(o!==n.length){for(var h=o;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),Ce(this._managedStates,_.target))}n.splice(o)}}},{key:"_scheduleThis",value:function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)}},{key:"_unscheduleThis",value:function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)}}]),n}(cG),PG=function(t){return e({AnimationComponent:t,Animation:t}),t}((hG=Cc("cc.Animation"),_G=Uc(),fG=bc(99),dG=Lc(),pG=rl([QU]),mG=Wc(),vG=rl(QU),gG=Wc(),yG=Wc(),xG=rl([QU]),hG(SG=_G(SG=fG(SG=kc(SG=dG((wG=bG=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"playOnLoad",EG,se(e)),e._crossFade=new RG,e._nameToState=ze(!0),ye(e,"_clips",CG,se(e)),ye(e,"_defaultClip",AG,se(e)),e._hasBeenPlayed=!1,e}return Z(n,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=ge(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var a,o=ge(e);!(a=o()).done;){var s=a.value;s&&this.createState(s)}var c=e.find((function(e){return IG(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return IG(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}},{key:"onLoad",value:function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)}},{key:"start",value:function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=ze(!0)}},{key:"play",value:function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3;this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&this.doPlayOrCrossFade(n,t)}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return Ae(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void P(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void P(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]}},{key:"on",value:function(e,t,i,r){var a=he(ne(n.prototype),"on",this).call(this,e,t,i,r);return e===sG.LASTFRAME&&this._syncAllowLastFrameEvent(),a}},{key:"once",value:function(e,t,i){var r=he(ne(n.prototype),"once",this).call(this,e,t,i);return e===sG.LASTFRAME&&this._syncAllowLastFrameEvent(),r}},{key:"off",value:function(e,t,i){he(ne(n.prototype),"off",this).call(this,e,t,i),e===sG.LASTFRAME&&this._syncDisallowLastFrameEvent()}},{key:"_createState",value:function(e,t){return new uG(e,t)}},{key:"_doCreateState",value:function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(sG.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n}},{key:"doPlayOrCrossFade",value:function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var n=this._nameToState[t];IG(e,n.clip)&&(n.stop(),delete this._nameToState[t])}}},{key:"_syncAllowLastFrameEvent",value:function(){if(this.hasEventListener(sG.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)}},{key:"_syncDisallowLastFrameEvent",value:function(){if(!this.hasEventListener(sG.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)}}]),n}(cu(sh)),bG.EventType=sG,xe((TG=wG).prototype,"clips",[pG,mG],Object.getOwnPropertyDescriptor(TG.prototype,"clips"),TG.prototype),xe(TG.prototype,"defaultClip",[vG,gG],Object.getOwnPropertyDescriptor(TG.prototype,"defaultClip"),TG.prototype),EG=xe(TG.prototype,"playOnLoad",[Ic,yG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CG=xe(TG.prototype,"_clips",[xG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AG=xe(TG.prototype,"_defaultClip",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SG=TG))||SG)||SG)||SG)||SG)||SG));function IG(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}c.Animation=PG,F(PG.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return PG.prototype.removeState.call(this,e.name)}}]),c.AnimationComponent=PG,dt.setClassAlias(PG,"cc.AnimationComponent");var DG,OG,NG,MG=function(){function e(){K(this,e),this._nodeBlendStates=new Map}return Z(e,[{key:"createWriter",value:function(e,t,n,i){var r=this.ref(e,t);return new kG(e,t,r,n,i)}},{key:"destroyWriter",value:function(e){var t=e;this.deRef(t.node,t.property)}},{key:"ref",value:function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=new zG,this._nodeBlendStates.set(e,n)),n.refProperty(t)}},{key:"deRef",value:function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))}},{key:"apply",value:function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))}}]),e}(),kG=function(){function e(t,n,i,r,a){K(this,e),this._node=t,this._property=n,this._propertyBlendState=i,this._host=r,this._constants=a}return Z(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}},{key:"getValue",value:function(){return this._node[this._property]}},{key:"setValue",value:function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)}}]),e}(),LG=function e(t){K(this,e),this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=t},BG=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.call(this,new zn)}return Z(n,[{key:"blend",value:function(e,t){var n=this.blendedValue;1===t?zn.copy(n,e):zn.scaleAndAdd(n,n,e,t),this.blendedWeight+=t}},{key:"reset",value:function(){this.blendedWeight=0,zn.zero(this.blendedValue)}}]),n}(LG),FG=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.call(this,new qn)}return Z(n,[{key:"blend",value:function(e,t){if(0!==t){var n=this.blendedValue,i=this.blendedWeight;if(1===t)qn.copy(n,e);else{var r=t/(i+t);qn.slerp(n,n,e,r)}this.blendedWeight+=t}}},{key:"reset",value:function(){this.blendedWeight=0,qn.identity(this.blendedValue)}}]),n}(LG),zG=function(){function e(){K(this,e),this._properties={}}return Z(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}},{key:"refProperty",value:function(e){var t,n,i,r=this._properties;switch(e){default:case"position":case"scale":case"eulerAngles":i=null!==(t=r[e])&&void 0!==t?t:r[e]=new BG;break;case"rotation":i=null!==(n=r[e])&&void 0!==n?n:r[e]=new FG}return++i.refCount,i}},{key:"deRefProperty",value:function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])}},{key:"apply",value:function(e){var t,n,i,r=this._properties,a=r.position,o=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,_=!1;a&&a.blendedWeight&&(l=!0,a.blendedWeight<1&&a.blend(e.position,1-a.blendedWeight),t=a.blendedValue),o&&o.blendedWeight&&(u=!0,o.blendedWeight<1&&o.blend(e.scale,1-o.blendedWeight),n=o.blendedValue),c&&c.blendedWeight&&(_=!0,c.blendedWeight<1&&c.blend(e.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(e.rotation,1-s.blendedWeight),i=s.blendedValue),(i||t||n)&&e.setRTS(i,t,n),l&&a.reset(),u&&o.reset(),h&&s.reset(),_&&c.reset()}}]),e}(),UG=[],GG=new Map;function HG(e,t){for(var n=0,i=ei.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,UG[n++]=e,e=e.parent}for(;n>0;){e=UG[--n],UG[n]=null;var r=e.node;ei.fromRTS(e.local,r.rotation,r.position,r.scale),i=ei.multiply(e.world,i,e.local)}return i}function VG(e){for(var t=GG.get(e.uuid)||null;t;)GG.delete(t.node.uuid),t=t.parent}var jG=e("AnimationManager",Cc((NG=OG=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._anims=new Se([]),e._crossFades=new Se([]),e._delayEvents=[],e._blendStateBuffer=new MG,e._sockets=[],e}return Z(n,[{key:"blendState",get:function(){return this._blendStateBuffer}},{key:"addCrossFade",value:function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):D(3907)}},{key:"update",value:function(e){var t=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(e);var a=this._anims,o=a.array;for(a.i=0;a.i<o.length;++a.i){var s=o[a.i];s.isMotionless||s.update(e)}this._blendStateBuffer.apply();for(var l=c.director.getTotalFrames(),u=0,h=i.length;u<h;u++){var _=i[u],f=_.target,d=_.transform;f.matrix=HG(d,l)}for(var p=0,m=t.length;p<m;p++){var v=t[p];v.fn.apply(v.thisArg,v.args)}t.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):D(3907)}},{key:"pushDelayEvent",value:function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})}},{key:"addSockets",value:function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var a=e.getChildByPath(r.path),o=r.target&&a&&function(e,t){for(var n,i=null,r=0;e!==t;){var a=e.uuid;if(GG.has(a)){i=GG.get(a);break}i={node:e,local:new ei,world:new ei,stamp:-1,parent:null},GG.set(a,i),UG[r++]=i,e=e.parent,i=null}for(;r>0;)n=UG[--r],UG[r]=null,n.parent=i,i=n;return i}(a,e);o&&n._sockets.push({target:r.target,transform:o})},r=0;r<t.length;++r)i(r)}},{key:"removeSockets",value:function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var a=this._sockets[r];if(a.target===i.target){VG(a.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}]),n}(zN),OG.ID="animation",DG=NG))||DG);$N.on(JN.EVENT_INIT,(function(){var e=new jG;$N.registerSystem(jG.ID,e,zN.Priority.HIGH)})),c.AnimationManager=jG;var WG,qG,XG,YG,KG=new ei;c.easing=hf;var QG=e("HierachyModifier",Cc("cc.HierachyModifier")(WG=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(YB))||WG);c.HierachyModifier=QG;var ZG=e("ComponentModifier",Cc("cc.ComponentModifier")(qG=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(KB))||qG);c.ComponentModifier=ZG;var JG=e("CurveValueAdapter",Cc("cc.CurveValueAdapter")(XG=function(){function e(){K(this,e)}return Z(e,[{key:"forTarget",value:function(){return{set:function(){}}}}]),e}())||XG);c.CurveValueAdapter=JG;var $G=e("UniformCurveValueAdapter",Cc("cc.UniformCurveValueAdapter")(YG=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(QB))||YG);function eH(e){return"string"==typeof e}function tH(e){return"number"==typeof e}function nH(e,t){return e instanceof t}c.UniformCurveValueAdapter=$G,c.isPropertyModifier=eH,c.isElementModifier=tH,c.isCustomTargetModifier=nH,c.math=vi,c.geometry=Hd;var iH=new zn,rH=new ei;function aH(e,t,n,i){var r=n.chunk,a=n.data,o=r.vb,s=n.vertexCount;e.getWorldMatrix(rH);for(var c=0,l=0;l<s;l++){var u=a[l];zn.set(iH,u.x,u.y,0),zn.transformMat4(iH,iH,rH),o[c++]=iH.x,o[c++]=iH.y,o[c++]=iH.z,Bn.toArray(o,i,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),d=r.vertexAccessor.getIndexBuffer(h),p=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;d[p++]=g,d[p++]=g+1,d[p++]=g+2,d[p++]=g+1,d[p++]=g+3,d[p++]=g+2}f.indexOffset+=n.indexCount,f.setDirty()}function oH(e,t){for(var n,i,r,a=e.vertexFormat,o=e.chunk.vb,s=0,c=0;c<a.length;++c){if(n=a[c],(i=la[n.format]).hasAlpha)if(r=e.floatStride,i.size/i.count==1)for(var l=~~gn(Math.round(255*t),0,255),u=s;u<o.length;u+=r)o[u]=(4294967040&o[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<o.length;h+=r)o[h]=t;s+=i.size>>2}}var sH=function(){function e(t,n){K(this,e),this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var i=new cH;i.initWithSize(t,n),this._texture=i,this._width=t,this._height=n,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}return Z(e,[{key:"insertSpriteFrame",value:function(e){var t=e.rect,n=e.texture,i=this._innerTextureInfos[n.getId()],r=t.x,a=t.y;if(i)r+=i.x,a+=i.y;else{var o=n.width,s=n.height;if(this._x+o+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;c.internal.dynamicAtlasManager.textureBleeding&&((o<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,a+=this._y,this._x+=o+2}var l={x:r,y:a,texture:this._texture};return this._innerSpriteFrames.push(e),l}},{key:"deleteInnerTexture",value:function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)}},{key:"isEmpty",value:function(){return this._count<=0}},{key:"reset",value:function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}}},{key:"destroy",value:function(){this.reset(),this._texture.destroy()}}]),e}(),cH=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"initWithSize",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Um.RGBA8888;this.reset({width:e,height:t,format:n})}},{key:"drawTextureAt",value:function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var a=new mr;a.texOffset.x=t,a.texOffset.y=n,a.texExtent.width=e.width,a.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[a])}else console.warn("Unable to get device")}}}]),n}(Ov),lH=function(){function e(){K(this,e),this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}return Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),c.director.on(c.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),c.director.off(c.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}},{key:"newAtlas",value:function(){var e=this._atlases[++this._atlasIndex];return e||(e=new sH(this._textureSize,this._textureSize),this._atlases.push(e)),e}},{key:"beforeSceneLoad",value:function(){this.reset()}},{key:"insertSpriteFrame",value:function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==Hm.LINEAR||t.magFilter!==Hm.LINEAR||t.mipFilter!==Hm.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)}},{key:"reset",value:function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1}},{key:"deleteAtlasSpriteFrame",value:function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],dt.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}}},{key:"deleteAtlasTexture",value:function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)}},{key:"packToDynamicAtlas",value:function(e,t){if(t&&!t._original&&t.packable&&t.texture&&t.texture.width>0&&t.texture.height>0){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}}}]),e}();lH.instance=void 0;var uH,hH,_H,fH=e("dynamicAtlasManager",lH.instance=new lH);c.internal.dynamicAtlasManager=fH;var dH,pH,mH,vH,gH=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],yH=e("SpriteFrame",Cc("cc.SpriteFrame")((_H=hH=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this)).vertices=null,e.uv=[],e.unbiasUV=[],e.uvSliced=[],e._rect=new fi,e._offset=new ri,e._originalSize=new hi,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._isFlipUVY=!1,e._isFlipUVX=!1,e._original=null,e._packable=!0,e}return Z(n,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}},{key:"textureLoaded",value:function(){return!!this.texture}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this.rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this.rect=e}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this.originalSize=e}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this.offset=e}},{key:"getGFXTexture",value:function(){return this._texture.getGFXTexture()}},{key:"getGFXSampler",value:function(){return this._texture.getGFXSampler()}},{key:"getHash",value:function(){return this._texture.getHash()}},{key:"getSamplerInfo",value:function(){return this._texture.getSamplerInfo()}},{key:"reset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(D(3300,"".concat(this.name,"/").concat(e.name),n,e.width),!1):!(i>e.height&&(D(3301,"".concat(this.name,"/").concat(e.name),i,e.height),1))}},{key:"destroy",value:function(){return this._packable&&fH&&fH.deleteAtlasSpriteFrame(this),he(ne(n.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,i=t.width,r=t.height,a=this._capInsets[0],o=this._capInsets[2],s=e.width-a-o,c=this._capInsets[1],l=this._capInsets[3],u=e.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){gH[0].u=e.x/i,gH[1].u=(e.x+l)/i,gH[2].u=(e.x+l+u)/i,gH[3].u=(e.x+e.height)/i,gH[3].v=e.y/r,gH[2].v=(e.y+a)/r,gH[1].v=(e.y+a+s)/r,gH[0].v=(e.y+e.width)/r;for(var _=0;_<4;++_)for(var f=gH[_],d=0;d<4;++d){var p=gH[3-d];h.push({u:f.u,v:p.v})}}else{gH[0].u=e.x/i,gH[1].u=(e.x+a)/i,gH[2].u=(e.x+a+s)/i,gH[3].u=(e.x+e.width)/i,gH[3].v=e.y/r,gH[2].v=(e.y+c)/r,gH[1].v=(e.y+c+u)/r,gH[0].v=(e.y+e.height)/r;for(var m=0;m<4;++m)for(var v=gH[m],g=0;g<4;++g){var y=gH[g];h.push({u:y.u,v:v.v})}}this.emit(n.EVENT_UV_UPDATED,this)}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,a=i.height;if(this._rotated){var o=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===a?0:e.y/a,l=0===a?1:(e.y+e.width)/a;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=o,t[5]=l,t[6]=o,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=o,t[5]=c,t[6]=o,t[7]=l):this._isFlipUVY?(t[0]=o,t[1]=l,t[2]=o,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=o,t[1]=c,t[2]=o,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,_=0===a?0:e.y/a,f=0===a?1:(e.y+e.width)/a;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var d=0===r?0:e.x/r,p=0===r?1:(e.x+e.width)/r,m=0===a?1:(e.y+e.height)/a,v=0===a?0:e.y/a;this._isFlipUVX&&this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):this._isFlipUVX?(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v):this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,x=0===a?1:(e.y+e.height)/a,S=0===a?0:e.y/a;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var T=this.vertices;if(T){T.nu.length=0,T.nv.length=0;for(var E=0;E<T.u.length;E++)T.nu[E]=T.u[E]/r,T.nv[E]=T.v[E]/a}this._calculateSlicedUV()}},{key:"_setDynamicAtlasFrame",value:function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())}},{key:"_resetDynamicAtlasFrame",value:function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())}},{key:"_checkPackable",value:function(){var e=fH;if(e){var t=this._texture;if(t instanceof Ov&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}}},{key:"_serialize",value:function(){return null}},{key:"_deserialize",value:function(e){var t=e,n=t.rect;n&&(this._rect=new fi(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new ri(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new hi(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var a=t.capInsets;a&&(this._capInsets[0]=a[0],this._capInsets[1]=a[1],this._capInsets[2]=a[2],this._capInsets[3]=a[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"clone",value:function(){var e,t,i,r,a,o,s,c,l=new n,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(t=u.u)||void 0===t?void 0:t.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(a=l.uv).splice.apply(a,[0,l.uv.length].concat(pe(this.uv))),(o=l.unbiasUV).splice.apply(o,[0,l.unbiasUV.length].concat(pe(this.unbiasUV))),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(pe(this.uvSliced))),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(pe(this._capInsets))),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l}},{key:"_refreshTexture",value:function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new fi(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new hi(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()}},{key:"initDefault",value:function(e){he(ne(n.prototype),"initDefault",this).call(this,e);var t=new Ov;t.initDefault(),this._refreshTexture(t),this._calculateUV()}},{key:"validate",value:function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height}}],[{key:"createWithImage",value:function(e){var t=e instanceof lv?e:new lv(e),i=new Ov;i.image=t;var r=new n;return r.texture=i,r}}]),n}(Uu),hH.EVENT_UV_UPDATED="uv_updated",uH=_H))||uH);c.SpriteFrame=yH;var xH,SH=e("SpriteAtlas",Cc("cc.SpriteAtlas")((vH=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"spriteFrames",mH,se(e)),e}return Z(n,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e}},{key:"_serialize",value:function(){}},{key:"_deserialize",value:function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=ze();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],ht(yH))}}]),n}(Uu),mH=xe((pH=vH).prototype,"spriteFrames",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ze()}}),dH=pH))||dH);c.SpriteAtlas=SH;var TH,EH,CH,AH,bH=e("Font",Cc("cc.Font")(xH=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(Uu))||xH);c.Font=bH;var wH,RH,PH,IH,DH,OH,NH,MH,kH,LH=e("TTFFont",Cc("cc.TTFFont")((AH=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_fontFamily",CH,se(e)),e}return Z(n,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:Ru(this._native),__isNative__:!0}}},{key:"initDefault",value:function(e){this._fontFamily="Arial",he(ne(n.prototype),"initDefault",this).call(this,e)}}]),n}(bH),CH=xe((EH=AH).prototype,"_fontFamily",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xe(EH.prototype,"_nativeAsset",[dl,il],Object.getOwnPropertyDescriptor(EH.prototype,"_nativeAsset"),EH.prototype),xe(EH.prototype,"_nativeDep",[dl],Object.getOwnPropertyDescriptor(EH.prototype,"_nativeDep"),EH.prototype),TH=EH))||TH);c.TTFFont=LH;var BH,FH=function e(){K(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},zH=function(){function e(t){K(this,e),this.letterDefinitions={},this.texture=t}return Z(e,[{key:"addLetterDefinitions",value:function(e,t){this.letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new FH;Qe(r,this.letterDefinitions[i]),e[i]=r}return e}},{key:"getTexture",value:function(){return this.texture}},{key:"getLetter",value:function(e){return this.letterDefinitions[e]}},{key:"getLetterDefinitionForChar",value:function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null}},{key:"clear",value:function(){this.letterDefinitions={}}}]),e}(),UH=e("BitmapFont",(wH=Cc("cc.BitmapFont"),RH=rl(yH),wH((kH=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"fntDataStr",DH,se(e)),ye(e,"spriteFrame",OH,se(e)),ye(e,"fontSize",NH,se(e)),ye(e,"fntConfig",MH,se(e)),e}return Z(n,[{key:"onLoaded",value:function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new zH(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new FH,a=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=a.width,r.h=a.height,r.u=a.x,r.v=a.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else y("The fnt config is not exists!")}}]),n}(bH),DH=xe((IH=kH).prototype,"fntDataStr",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OH=xe(IH.prototype,"spriteFrame",[RH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NH=xe(IH.prototype,"fontSize",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),MH=xe(IH.prototype,"fntConfig",[Ic,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PH=IH))||PH));c.BitmapFont=UH;var GH=e("LabelAtlas",Cc("cc.LabelAtlas")(BH=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(UH))||BH);c.LabelAtlas=GH;var HH=e("BASELINE_RATIO",.26),VH=e("MIDDLE_RATIO",(HH+1)/2-HH);var jH=new _t(2);jH.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var WH,qH=new(function(){function e(t){K(this,e),this.count=0,this.limit=0,this.datas={},this.limit=t}return Z(e,[{key:"moveToHead",value:function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e}},{key:"put",value:function(e,t){var n=jH.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,jH.put(i)}this.moveToHead(n)}},{key:"remove",value:function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--}},{key:"get",value:function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null}},{key:"clear",value:function(){this.count=0,this.datas={},this.head=null,this.tail=null}},{key:"has",value:function(e){return!!this.datas[e]}},{key:"delete",value:function(e){var t=this.datas[e];this.remove(t)}}]),e}())(100),XH=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,YH=/^[!,.:;'}\]%\?>、‘“》？。，！]/,KH=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,QH=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,ZH=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function JH(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function $H(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function eV(e,t,n){var i=n||e.font,r="".concat(i,"🎮").concat(t),a=qH.get(r);if(null!==a)return a;var o=e.measureText(t),s=o&&o.width||0;return qH.put(r,s),s}function tV(e,t,n){var i=t,r=n,a=e[t];if(a>="\udc00"&&a<="\udfff"&&i--,void 0!==n)if(n-1!==t){var o=e[n-1];o>="\ud800"&&o<="\udbff"&&r--}else a>="\ud800"&&a<="\udbff"&&r++;return e.substring(i,r)}function nV(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var a=e;t>n&&a.length>1;){for(var o=a.length*(n/t)|0,s=tV(a,o),c=t-i(s),l=s,u=0,h=0;c>n&&h++<10;)o*=n/c,c=t-i(s=tV(a,o|=0));for(h=0;c<=n&&h++<10;){if(s){var _=XH.exec(s);u=_?_[0].length:1,l=s}c=t-i(s=tV(a,o+=u))}0==(o-=u)?(o=1,l=tV(a,1)):1===o&&a[0]>="\ud800"&&a[0]<="\udbff"&&(o=2,l=tV(a,2));var f=tV(a,0,o),d=void 0;YH.test(l||s)&&(0==(o-=(d=KH.exec(f))?d[0].length:0)&&(o=1),l=tV(a,o),f=tV(a,0,o)),ZH.test(l)&&(d=QH.exec(f))&&f!==d[0]&&(l=tV(a,o-=d[0].length),f=tV(a,0,o)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),t=i(a=l||s)}return(0===r.length||(a=a.trim()).length>0)&&r.push(a),r}var iV=e("CanvasPool",function(){function e(){K(this,e),this.pool=[]}return Z(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e}},{key:"put",value:function(e){this.pool.length>=St.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)}}],[{key:"getInstance",value:function(){return WH||(WH=new e),WH}}]),e}()),rV=Bn.WHITE.clone(),aV=function e(){K(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},oV="rgba(255, 255, 255, ".concat((1/255).toFixed(3),")"),sV=function(){function e(t,n){K(this,e),this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=n,this.hash=t.charCodeAt(0)+n.hash}return Z(e,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.image=null}},{key:"_updateProperties",value:function(){if(this.data=iV.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=eV(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+HH)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*HH/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new lv),this.image.reset(this.canvas)}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=oV,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,a=n/2,o=i/2+r*VH+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(s.r,", ").concat(s.g,", ").concat(s.b,", ",1,")"),t.isOutlined){var c=t.out||rV;e.strokeStyle="rgba(".concat(c.r,", ").concat(c.g,", ").concat(c.b,", ").concat(c.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,a,o)}e.fillText(this.char,a,o)}}}]),e}(),cV=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"initWithSize",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Um.RGBA8888;this.reset({width:e,height:t,format:n})}},{key:"drawTextureAt",value:function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var a=new mr;a.texOffset.x=t,a.texOffset.y=n,a.texExtent.width=e.width,a.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[a])}else console.warn("Unable to get device")}}}]),n}(Ov),lV=function(){function e(t,n){K(this,e),this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var i=new cV;i.initWithSize(t,n),this.fontDefDictionary=new zH(i),this._halfBleed=1,this._width=t,this._height=n,$N.on(JN.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return Z(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"insertLetterTexture",value:function(e){var t=e.image,n=$N.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return P(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new aV;return a.u=this._x+this._halfBleed,a.v=this._y+this._halfBleed,a.texture=this.fontDefDictionary.texture,a.valid=!0,a.w=e.width-2,a.h=e.height-2,a.xAdvance=a.w,a.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,a),a}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()}},{key:"destroy",value:function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)}},{key:"getTexture",value:function(){return this.fontDefDictionary.getTexture()}},{key:"beforeSceneLoad",value:function(){this.clearAllCache()}},{key:"clearAllCache",value:function(){this.destroy();var e=new cV;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e}},{key:"getLetter",value:function(e){return this.fontDefDictionary.letterDefinitions[e]}},{key:"getLetterDefinitionForChar",value:function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new sV(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i}}]),e}(),uV={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Bn.WHITE.clone(),isOutlined:!1,out:Bn.WHITE.clone(),margin:0},hV=[new zr(or.ATTR_POSITION,Ei.RGB32F)],_V=[new zr(or.ATTR_POSITION,Ei.RGB32F),new zr(or.ATTR_COLOR,Ei.RGBA32F)],fV=[new zr(or.ATTR_POSITION,Ei.RGB32F),new zr(or.ATTR_TEX_COORD,Ei.RG32F),new zr(or.ATTR_COLOR,Ei.RGBA32F)],dV=[new zr(or.ATTR_POSITION,Ei.RGB32F),new zr(or.ATTR_TEX_COORD,Ei.RG32F),new zr(or.ATTR_COLOR,Ei.RGBA32F),new zr(or.ATTR_COLOR2,Ei.RGBA32F)];function pV(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=la[i.format].count}return t}function mV(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=la[i.format].size}return t}c.internal.vfmtPosUvColor=fV,c.internal.vfmtPosUvTwoColor=dV,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:hV,vfmtPosColor:_V,vfmtPosUvColor:fV,vfmtPosUvTwoColor:dV,getComponentPerVertex:pV,getAttributeStride:mV}));var vV,gV,yV,xV,SV,TV,EV,CV,AV,bV,wV,RV,PV,IV,DV,OV=mV(fV)>>2,NV=new Jl((function(){return{x:0,y:0,z:0,u:0,v:0,color:Bn.WHITE.clone()}}),128),MV=null,kV=e("BaseRenderData",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fV;K(this,e),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=fV,this._floatStride=t===fV?OV:mV(t)>>2,this._vertexFormat=t}return Z(e,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}},{key:"isValid",value:function(){return this._ic>0&&this.chunk.vertexAccessor}}]),e}()),LV=e("RenderData",function(e){te(n,e);var t=le(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fV,r=arguments.length>1?arguments[1]:void 0;if(K(this,n),(e=t.call(this,i)).indices=null,e.vertDirty=!0,e.frame=void 0,e.layer=0,e.blendHash=-1,e.textureHash=0,e.nodeDirty=!0,e.passDirty=!0,e.textureDirty=!0,e.hashDirty=!0,e._data=[],e._pivotX=0,e._pivotY=0,e._width=0,e._height=0,e._accessor=null,!r){var a=$N.root.batcher2D;r=a.switchBufferAccessor(e._vertexFormat)}return e._accessor=r,e}return Z(n,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)NV.free(t[i]);for(i=n;i<e;i++)t[i]=NV.alloc();t.length=e}}},{key:"data",get:function(){return this._data}},{key:"resize",value:function(e,t){e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(e,t),this.updateHash())}},{key:"resizeAndCopy",value:function(e,t){if(e!==this._vc||t!==this._ic||!this.chunk){this._vc=e,this._ic=t;var n=this.chunk;this.chunk=this._accessor.allocateChunk(e,t),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}}},{key:"getMeshBuffer",value:function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null}},{key:"updateNode",value:function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0}},{key:"updatePass",value:function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0}},{key:"updateTexture",value:function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0}},{key:"updateHash",value:function(){var e=this.chunk?this.chunk.bufferId:-1,t="".concat(e).concat(this.layer," ").concat(this.blendHash," ").concat(this.textureHash);this.dataHash=wa(t,666),this.hashDirty=!1}},{key:"updateRenderData",value:function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=e.node.scene?e._getRenderScene():null;this.layer=e.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()}},{key:"updateSizeNPivot",value:function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)}},{key:"clear",value:function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0}}],[{key:"add",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fV,t=arguments.length>1?arguments[1]:void 0;MV||(MV=new $l((function(){return new n}),32));var i=MV.add();if(i._floatStride=e===fV?OV:mV(e)>>2,i._vertexFormat=e,!t){var r=$N.root.batcher2D;t=r.switchBufferAccessor(i._vertexFormat)}return i._accessor=t,i}},{key:"remove",value:function(e){var t=MV.data.indexOf(e);-1!==t&&(e.clear(),e._accessor=null,MV.removeAt(t))}}]),n}(kV)),BV=e("MeshRenderData",function(e){te(n,e);var t=le(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fV;return K(this,n),(e=t.call(this,i)).isMeshBuffer=!0,e.vData=void 0,e.iData=void 0,e.vertexStart=0,e.vertexRange=0,e.indexStart=0,e.indexRange=0,e.lastFilledIndex=0,e.lastFilledVertex=0,e._byteLength=0,e._vertexBuffers=[],e._indexBuffer=null,e._iaPool=null,e._iaInfo=null,e.vData=new Float32Array(256*e.stride),e.iData=new Uint16Array(1536),e}return Z(n,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}},{key:"request",value:function(e,t){var n=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)}},{key:"reserve",value:function(e,t){var n=this._byteLength+e*this.stride,i=this.indexCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,a=this.iData.length,o=this.vData.length,s=this.iData.length;if(n>r||i>a){for(;r<n||a<i;)r=4*(o*=2),a=s*=2;this._reallocBuffer(o,s)}return!0}},{key:"resize",value:function(e,t){var n=e*this.stride;e>=0&&t>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=n,this.updateRange(0,e,0,t)}},{key:"updateRange",value:function(e,t,n,i){t>=0&&i>=0&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=n,this.vertexRange=t,this.indexRange=i}},{key:"requestIA",value:function(e){this._initIAInfo(e);var t=this._iaPool.add();return t.firstIndex=this.indexStart,t.indexCount=this.indexRange,t}},{key:"uploadBuffers",value:function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,e),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(t);var r=e<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}}},{key:"freeIAPool",value:function(){this._iaPool&&this._iaPool.reset()}},{key:"reset",value:function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()}},{key:"clear",value:function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)}},{key:"_initIAInfo",value:function(e){var t=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(e.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=e.createBuffer(new Tr(bi.INDEX|bi.TRANSFER_DST,Pi.DEVICE,r,r))),this._iaInfo=new Gr(this._vertexFormat,i,this._indexBuffer),this._iaPool=new $l((function(){return e.createInputAssembler(t._iaInfo)}),1,(function(e){e.destroy()}))}}},{key:"_reallocBuffer",value:function(e,t){var n=this.vData;this.vData=new Float32Array(e),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),i&&this.iData.set(i,0)}}],[{key:"add",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fV,t=FV.add();return t._floatStride=e===fV?OV:mV(e)>>2,t._vertexFormat=e,t}},{key:"remove",value:function(e){var t=FV.data.indexOf(e);-1!==t&&(FV.data[t].clear(),FV.removeAt(t))}}]),n}(kV)),FV=new $l((function(){return new BV}),32),zV=new ri,UV=new ri,GV=(new zn,new ei),HV=new ei,VV=new ei,jV=new ei(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),WV=new fi,qV=function(t){return e({UITransform:t,UITransformComponent:t}),t}((vV=Cc("cc.UITransform"),gV=Uc(),yV=bc(110),xV=Lc(),SV=Zc(),TV=Wc(),EV=Zc(),CV=Wc(),vV(AV=gV(AV=yV(AV=xV(AV=wc(AV=kc((IV=PV=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._priority=0,ye(e,"_contentSize",wV,se(e)),ye(e,"_anchorPoint",RV,se(e)),e}return Z(n,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit($E.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit($E.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit($E.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit($E.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit($E.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit($E.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?P(6706):(this._priority=e,this.node.parent&&n.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=$N.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=$N.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}},{key:"__preload",value:function(){this.node._uiProps.uiTransformComp=this}},{key:"onLoad",value:function(){this.node.parent&&n.insertChangeMap(this.node.parent)}},{key:"onEnable",value:function(){this.node.on($E.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()}},{key:"onDisable",value:function(){this.node.off($E.PARENT_CHANGED,this._parentChanged,this)}},{key:"onDestroy",value:function(){this.node._uiProps.uiTransformComp=null}},{key:"setContentSize",value:function(e,t){var n=this._contentSize;if(void 0===t){if((e=e).width===n.width&&e.height===n.height)return;n.width=e.width,n.height=e.height}else{if(e===n.width&&t===n.height)return;n.width=e,n.height=t}this.node.emit($E.SIZE_CHANGED),this._markRenderDataDirty()}},{key:"setAnchorPoint",value:function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit($E.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()}},{key:"isHit",value:function(e){for(var t,n=this._contentSize.width,i=this._contentSize.height,r=zV,a=UV,o=null===(t=this.node)||void 0===t?void 0:t.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(GV);var u=GV.m12,h=GV.m13,_=nM.center;if(GV.m12=_.x-(GV.m00*u+GV.m04*h),GV.m13=_.y-(GV.m01*u+GV.m05*h),ei.invert(GV,GV),ri.transformMat4(r,e,GV),this.node.getWorldMatrix(VV),ei.invert(GV,VV),!ei.strictEquals(GV,jV)){ri.transformMat4(a,r,GV),a.x+=this._anchorPoint.x*n,a.y+=this._anchorPoint.y*i;var f=!1;if(a.x>=0&&a.y>=0&&a.x<=n&&a.y<=i&&(f=!0,o&&o.maskList))for(var d=o.maskList,p=this.node,m=d?d.length:0,v=0,g=0;p&&g<m;++v,p=p.parent){var y=d[g];if(v===y.index){if(p!==y.comp.node){d.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){f=!1;break}g++}else if(v>y.index){d.length=g;break}}if(f)return!0}}}return!1}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(VV),ei.invert(GV,VV),t||(t=new zn),zn.transformMat4(t,e,GV)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(VV),t||(t=new zn),zn.transformMat4(t,e,VV)}},{key:"getBoundingBox",value:function(){ei.fromRTS(HV,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new fi(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(HV),n}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(VV),this.getBoundingBoxTo(VV)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){ei.fromRTS(HV,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,i=this._contentSize.height,r=new fi(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i);if(ei.multiply(VV,e,HV),r.transformMat4(VV),!this.node.children)return r;for(var a,o=ge(this.node.children);!(a=o()).done;){var s=a.value;if(s&&s.active){var c=s.getComponent(n);if(c){var l=c.getBoundingBoxTo(e);l&&fi.union(r,r,l)}}}return r}},{key:"getComputeAABB",value:function(e){var t=this._contentSize.width,n=this._contentSize.height;WV.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),WV.transformMat4(this.node.worldMatrix);var i=WV.x+.5*WV.width,r=WV.y+.5*WV.height,a=this.node.worldPosition.z,o=WV.width/2,s=WV.height/2;return null!=e?(tc.set(e,i,r,a,o,s,.001),e):new tc(i,r,a,o,s,.001)}},{key:"_parentChanged",value:function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&n.insertChangeMap(this.node.parent)}},{key:"_markRenderDataDirty",value:function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))}}],[{key:"insertChangeMap",value:function(e){var t=e.uuid;n.priorityChangeNodeMap.has(t)||n.priorityChangeNodeMap.set(t,e)}},{key:"_sortChildrenSibling",value:function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))}},{key:"_sortSiblings",value:function(){n.priorityChangeNodeMap.forEach((function(e){n._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),n.priorityChangeNodeMap.clear()}},{key:"_cleanChangeMap",value:function(){n.priorityChangeNodeMap.clear()}}]),n}(sh),PV.EventType=$E,PV.priorityChangeNodeMap=new Map,xe((bV=IV).prototype,"contentSize",[SV,TV],Object.getOwnPropertyDescriptor(bV.prototype,"contentSize"),bV.prototype),xe(bV.prototype,"anchorPoint",[EV,CV],Object.getOwnPropertyDescriptor(bV.prototype,"anchorPoint"),bV.prototype),wV=xe(bV.prototype,"_contentSize",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(100,100)}}),RV=xe(bV.prototype,"_anchorPoint",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri(.5,.5)}}),AV=bV))||AV)||AV)||AV)||AV)||AV)||AV));$N.on(JN.EVENT_AFTER_UPDATE,qV._sortSiblings),$N.on(JN.EVENT_BEFORE_SCENE_LAUNCH,qV._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(DV||(DV={}));var XV,YV,KV,QV,ZV,JV,$V,ej,tj,nj,ij,rj,aj,oj,sj,cj,lj,uj,hj,_j,fj=e("StencilManager",function(){function e(){K(this,e),this.stage=DV.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Bi.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Fi.KEEP,zFailOp:Fi.KEEP,passOp:Fi.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}return Z(e,[{key:"pattern",get:function(){return this._stencilPattern}},{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(e){e.stencilStage=e.inverted?DV.CLEAR_INVERTED:DV.CLEAR}},{key:"enterLevel",value:function(e){e.graphics.stencilStage=e.inverted?DV.ENTER_LEVEL_INVERTED:DV.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=DV.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=DV.DISABLED:this.stage=DV.ENABLED)}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=DV.DISABLED}},{key:"destroy",value:function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()}},{key:"getStencilStage",value:function(e,t){var n=0,i=!1,r=!1,a=Bi.LESS,o=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,a=s.depthFunc,o=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(o&&o.has(n))return o.get(n);this.setStateFromStage(e);var u=new Na(i,r,a,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return o.set(n,u),u}},{key:"getStencilHash",value:function(e){return e<<8|this._maskStack.length}},{key:"setStateFromStage",value:function(e){var t=this._stencilPattern;e===DV.DISABLED?(t.stencilTest=!1,t.func=Bi.ALWAYS,t.failOp=Fi.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===DV.ENABLED?(t.func=Bi.EQUAL,t.failOp=Fi.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===DV.CLEAR?(t.func=Bi.NEVER,t.failOp=Fi.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===DV.CLEAR_INVERTED||e===DV.ENTER_LEVEL?(t.func=Bi.NEVER,t.failOp=Fi.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===DV.ENTER_LEVEL_INVERTED&&(t.func=Bi.NEVER,t.failOp=Fi.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))}}]),e}());fj.sharedManager=null,fj.sharedManager=new fj,yt(zi),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(_j||(_j=e("InstanceMaterialType",{})));var dj,pj,mj,vj,gj,yj,xj,Sj,Tj,Ej,Cj,Aj,bj,wj,Rj,Pj,Ij,Dj,Oj,Nj,Mj,kj,Lj,Bj,Fj,zj,Uj,Gj,Hj,Vj,jj,Wj,qj,Xj,Yj,Kj,Qj,Zj,Jj,$j,eW,tW,nW,iW,rW,aW,oW,sW,cW,lW,uW,hW,_W,fW,dW,pW,mW,vW,gW,yW,xW,SW,TW,EW,CW,AW,bW,wW,RW,PW,IW=function(t){return e({Renderable2D:t,RenderComponent:t,UIRenderable:t}),t}((XV=Cc("cc.Renderable2D"),YV=Ac(qV),KV=Hc(),QV=rl(gg),ZV=rl(gg),JV=Zc(),$V=Wc(),ej=jc(),tj=Zc(),nj=Wc(),XV(ij=YV(ij=wc(ij=kc((hj=uj=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_materials",aj,se(e)),ye(e,"_customMaterial",oj,se(e)),e.stencilStage=DV.DISABLED,ye(e,"_srcBlendFactor",sj,se(e)),ye(e,"_dstBlendFactor",cj,se(e)),ye(e,"_color",lj,se(e)),e._assembler=null,e._postAssembler=null,e._renderData=null,e._renderDataFlag=!0,e._renderFlag=!0,e._delegateSrc=null,e._instanceMaterialType=-1,e._blendState=new ka,e._blendHash=0,e._lastParent=null,e}return Z(n,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&P(12001),this._srcBlendFactor},set:function(e){this._customMaterial?P(12001):this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&P(12001),this._dstBlendFactor},set:function(e){this._customMaterial?P(12001):this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}},{key:"updateBlendHash",value:function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc}},{key:"__preload",value:function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}},{key:"onEnable",value:function(){this.node.on($E.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on($E.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()}},{key:"onRestore",value:function(){this.updateMaterial(),this.markForUpdateRenderData()}},{key:"onDisable",value:function(){this.node.off($E.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off($E.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}},{key:"onDestroy",value:function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}this._blendState&&this._blendState.destroy()}},{key:"markForUpdateRenderData",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._renderFlag=this._canRender(),e){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else this._renderDataFlag=e}},{key:"requestRenderData",value:function(){var e=LV.add();return this._renderData=e,e}},{key:"destroyRenderData",value:function(){this._renderData&&(LV.remove(this._renderData),this._renderData=null)}},{key:"updateAssembler",value:function(e){this._renderDataFlag&&(this._assembler.updateRenderData(this,e),this._renderDataFlag=!1),this._renderFlag&&this._render(e)}},{key:"postUpdateAssembler",value:function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(){}},{key:"_postRender",value:function(){}},{key:"_canRender",value:function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0}},{key:"_postCanRender",value:function(){}},{key:"updateMaterial",value:function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()}},{key:"_updateColor",value:function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())}},{key:"_updateBlendFunc",value:function(){var e=this._blendState.targets[0];e||(e=new Ma,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=zi.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()}},{key:"getBlendState",value:function(){return this._blendState}},{key:"_nodeStateChange",value:function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var t=this.node.children[e].getComponent(n);t&&t.markForUpdateRenderData()}}},{key:"_onMaterialModified",value:function(e,t){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),he(ne(n.prototype),"_onMaterialModified",this).call(this,e,t)}},{key:"_updateBuiltinMaterial",value:function(){var e;switch(this._instanceMaterialType){case _j.ADD_COLOR:e=Gv.get("ui-base-material");break;case _j.GRAYSCALE:e=Gv.get("ui-sprite-gray-material");break;case _j.USE_ALPHA_SEPARATED:e=Gv.get("ui-sprite-alpha-sep-material");break;case _j.USE_ALPHA_SEPARATED_AND_GRAY:e=Gv.get("ui-sprite-gray-alpha-sep-material");break;default:e=Gv.get("ui-sprite-material")}return e}},{key:"setNodeDirty",value:function(){this.renderData&&(this.renderData.nodeDirty=!0)}},{key:"setTextureDirty",value:function(){this.renderData&&(this.renderData.textureDirty=!0)}}]),n}(CB),uj.BlendState=zi,uj.Assembler=null,uj.PostAssembler=null,aj=xe((rj=hj).prototype,"_materials",[dl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xe(rj.prototype,"sharedMaterials",[dl,KV],Object.getOwnPropertyDescriptor(rj.prototype,"sharedMaterials"),rj.prototype),oj=xe(rj.prototype,"_customMaterial",[QV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xe(rj.prototype,"customMaterial",[ZV,JV,$V,ej],Object.getOwnPropertyDescriptor(rj.prototype,"customMaterial"),rj.prototype),xe(rj.prototype,"color",[tj,nj],Object.getOwnPropertyDescriptor(rj.prototype,"color"),rj.prototype),sj=xe(rj.prototype,"_srcBlendFactor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zi.SRC_ALPHA}}),cj=xe(rj.prototype,"_dstBlendFactor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zi.ONE_MINUS_SRC_ALPHA}}),lj=xe(rj.prototype,"_color",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bn.WHITE.clone()}}),ij=rj))||ij)||ij)||ij)||ij));c.internal.Renderable2D=IW,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(bW||(bW=e("HorizontalTextAlignment",{}))),yt(bW),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(wW||(wW=e("VerticalTextAlignment",{}))),yt(wW),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(RW||(RW=e("Overflow",{}))),yt(RW),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(PW||(PW=e("CacheMode",{}))),yt(PW);var DW=function(t){return e({Label:t,LabelComponent:t}),t}((dj=Cc("cc.Label"),pj=Uc(),mj=bc(110),vj=Lc(),gj=Zc(),yj=Wc(),xj=rl(bW),Sj=Zc(),Tj=Wc(),Ej=rl(wW),Cj=Zc(),Aj=Wc(),bj=Zc(),wj=Wc(),Rj=Zc(),Pj=Hc(),Ij=Wc(),Dj=Zc(),Oj=Wc(),Nj=Hc(),Mj=Zc(),kj=Wc(),Lj=rl(RW),Bj=Zc(),Fj=Wc(),zj=Zc(),Uj=Wc(),Gj=rl(bH),Hj=Zc(),Vj=Hc(),jj=Wc(),Wj=Zc(),qj=Wc(),Xj=rl(PW),Yj=Zc(),Kj=Wc(),Qj=Zc(),Zj=Wc(),Jj=Zc(),$j=Wc(),eW=Zc(),tW=Wc(),nW=Hc(),iW=Zc(),rW=Wc(),dj(aW=pj(aW=mj(aW=vj((AW=CW=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"_string",sW,se(e)),ye(e,"_horizontalAlign",cW,se(e)),ye(e,"_verticalAlign",lW,se(e)),ye(e,"_actualFontSize",uW,se(e)),ye(e,"_fontSize",hW,se(e)),ye(e,"_fontFamily",_W,se(e)),ye(e,"_lineHeight",fW,se(e)),ye(e,"_overflow",dW,se(e)),ye(e,"_enableWrapText",pW,se(e)),ye(e,"_font",mW,se(e)),ye(e,"_isSystemFontUsed",vW,se(e)),ye(e,"_spacingX",gW,se(e)),ye(e,"_isItalic",yW,se(e)),ye(e,"_isBold",xW,se(e)),ye(e,"_isUnderline",SW,se(e)),ye(e,"_underlineHeight",TW,se(e)),ye(e,"_cacheMode",EW,se(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}return Z(n,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==PW.BITMAP||this._font instanceof UH||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===PW.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof UH?this._font.fontSize:-1}},{key:"onEnable",value:function(){he(ne(n.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()}},{key:"onDestroy",value:function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var e=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),e){var t=e;t.image&&t.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,he(ne(n.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))}},{key:"_render",value:function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)}},{key:"_updateColor",value:function(){he(ne(n.prototype),"_updateColor",this).call(this),this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!he(ne(n.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof UH){var t=e.spriteFrame;if(!t||!t.texture)return!1}return!0}},{key:"_flushAssembler",value:function(){var e=n.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}},{key:"_applyFontTexture",value:function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof UH){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===PW.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new yH,this._assemblerData=this._assembler.getAssemblerData();var n=new lv(this._assemblerData.canvas),i=new Ov;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==PW.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}}},{key:"changeMaterialForDefine",value:function(){if(this._texture){var e=!1;if(this.cacheMode!==PW.CHAR){var t=this._texture.texture;if(t instanceof sv){var n=t.getPixelFormat();e=n===Um.RGBA_ETC1||n===Um.RGB_A_PVRTC_4BPPV1||n===Um.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?_j.USE_ALPHA_SEPARATED:_j.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}}}]),n}(IW),CW.HorizontalAlign=bW,CW.VerticalAlign=wW,CW.Overflow=RW,CW.CacheMode=PW,CW._canvasPool=iV.getInstance(),xe((oW=AW).prototype,"string",[gj,yj,Jc],Object.getOwnPropertyDescriptor(oW.prototype,"string"),oW.prototype),xe(oW.prototype,"horizontalAlign",[xj,Sj,Tj],Object.getOwnPropertyDescriptor(oW.prototype,"horizontalAlign"),oW.prototype),xe(oW.prototype,"verticalAlign",[Ej,Cj,Aj],Object.getOwnPropertyDescriptor(oW.prototype,"verticalAlign"),oW.prototype),xe(oW.prototype,"fontSize",[bj,wj],Object.getOwnPropertyDescriptor(oW.prototype,"fontSize"),oW.prototype),xe(oW.prototype,"fontFamily",[Rj,Pj,Ij],Object.getOwnPropertyDescriptor(oW.prototype,"fontFamily"),oW.prototype),xe(oW.prototype,"lineHeight",[Dj,Oj],Object.getOwnPropertyDescriptor(oW.prototype,"lineHeight"),oW.prototype),xe(oW.prototype,"spacingX",[Nj,Mj,kj],Object.getOwnPropertyDescriptor(oW.prototype,"spacingX"),oW.prototype),xe(oW.prototype,"overflow",[Lj,Bj,Fj],Object.getOwnPropertyDescriptor(oW.prototype,"overflow"),oW.prototype),xe(oW.prototype,"enableWrapText",[zj,Uj],Object.getOwnPropertyDescriptor(oW.prototype,"enableWrapText"),oW.prototype),xe(oW.prototype,"font",[Gj,Hj,Vj,jj],Object.getOwnPropertyDescriptor(oW.prototype,"font"),oW.prototype),xe(oW.prototype,"useSystemFont",[Wj,qj],Object.getOwnPropertyDescriptor(oW.prototype,"useSystemFont"),oW.prototype),xe(oW.prototype,"cacheMode",[Xj,Yj,Kj],Object.getOwnPropertyDescriptor(oW.prototype,"cacheMode"),oW.prototype),xe(oW.prototype,"isBold",[Qj,Zj],Object.getOwnPropertyDescriptor(oW.prototype,"isBold"),oW.prototype),xe(oW.prototype,"isItalic",[Jj,$j],Object.getOwnPropertyDescriptor(oW.prototype,"isItalic"),oW.prototype),xe(oW.prototype,"isUnderline",[eW,tW],Object.getOwnPropertyDescriptor(oW.prototype,"isUnderline"),oW.prototype),xe(oW.prototype,"underlineHeight",[nW,Gc,iW,rW],Object.getOwnPropertyDescriptor(oW.prototype,"underlineHeight"),oW.prototype),sW=xe(oW.prototype,"_string",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),cW=xe(oW.prototype,"_horizontalAlign",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bW.CENTER}}),lW=xe(oW.prototype,"_verticalAlign",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wW.CENTER}}),uW=xe(oW.prototype,"_actualFontSize",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hW=xe(oW.prototype,"_fontSize",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),_W=xe(oW.prototype,"_fontFamily",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),fW=xe(oW.prototype,"_lineHeight",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),dW=xe(oW.prototype,"_overflow",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RW.NONE}}),pW=xe(oW.prototype,"_enableWrapText",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mW=xe(oW.prototype,"_font",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vW=xe(oW.prototype,"_isSystemFontUsed",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gW=xe(oW.prototype,"_spacingX",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yW=xe(oW.prototype,"_isItalic",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xW=xe(oW.prototype,"_isBold",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SW=xe(oW.prototype,"_isUnderline",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TW=xe(oW.prototype,"_underlineHeight",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),EW=xe(oW.prototype,"_cacheMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PW.NONE}}),aW=oW))||aW)||aW)||aW)||aW));c.Label=DW;var OW,NW,MW=0,kW={};function LW(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function BW(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(OW||(OW={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(NW||(NW={}));var FW,zW,UW,GW=function(){function e(t){K(this,e),this._device=void 0,this._format=Ei.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new mr,this._region1=new mr,this._region2=new mr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}return Z(e,[{key:"initialize",value:function(e){var t=la[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=ga(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0}},{key:"alloc",value:function(e,t){e=BW(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var a=this._chunks[n];a.start+=e;var o={chunkIdx:n,start:i,end:i+e,texture:a.texture};return this._handles.push(o),o}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,LW(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"createChunk",value:function(e){var t=e*e*this._formatSize;T("TextureBufferPool: Allocate chunk ".concat(this._chunkCount,", size: ").concat(t,", format: ").concat(this._format));var n={texture:this._device.createTexture(new wr(Ii.TEX2D,Di.SAMPLED|Di.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++}},{key:"update",value:function(e,t){var n=[],i=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,o=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-o,a),l=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),o=0,s+=1,a-=c,l+=c),a>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=s,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=a,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),o=0,s+=this._region1.texExtent.height,a-=c,l+=c),a>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=s,this._region2.texExtent.width=a,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,a*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)}},{key:"_findAvailableSpace",value:function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var a=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),o=0;o<a.length;o++){var s=a[o];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1}},{key:"_McDonaldAlloc",value:function(e){e=BW(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var a={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(a),a}}var o=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(o,this._formatSize)||Math.max(1024,LW(o)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l}}]),e}(),HW=function(e){if(void 0===kW[e]){var t=1<<MW;kW[e]=t,MW+=1}},VW=Object.freeze({__proto__:null,addStage:HW,scene:FT,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var a=[];a.push(new zr(or.ATTR_POSITION,Ei.RGB32F)),t.normals&&a.push(new zr(or.ATTR_NORMAL,Ei.RGB32F)),t.uvs&&a.push(new zr(or.ATTR_TEX_COORD,Ei.RG32F)),t.colors&&a.push(new zr(or.ATTR_COLOR,Ei.RGB32F));var o=e.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.DEVICE,4*n.length,4*n.length/i));o.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new Tr(bi.INDEX|bi.TRANSFER_DST,Pi.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new Gr(a,[o],s))},get RenderQueue(){return OW},get PassStage(){return NW},genHandle:_m,getTypeFromHandle:fm,getBindingFromHandle:dm,getCountFromHandle:pm,getOffsetFromHandle:mm,customizeType:vm,type2reader:gm,type2writer:ym,getDefaultFromType:Sm,overrideMacros:Tm,get BatchingSchemes(){return Bv},Pass:Kv,getDeviceShaderVersion:Pm,programLib:Fm,nearestPOT:LW,TextureBufferPool:GW,MaterialInstance:bT,PassInstance:AT,get PoolType(){return ks},NULL_HANDLE:0,get NodeView(){return Ls},NodePool:Gs,get PassView(){return Fs},PassPool:Ws,get AABBView(){return Hs},AABBPool:Ys});e("renderer",VW),function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(FW||(FW={})),yt(FW),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(zW||(zW={})),yt(zW),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(UW||(UW={})),yt(UW);var jW=Math.PI,WW=Math.min,qW=Math.max,XW=Math.cos,YW=Math.sin,KW=Math.abs,QW=Math.sign,ZW=.5522847493;function JW(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*ZW,t-i*ZW,n+r,t,n+r),e.bezierCurveTo(t+i*ZW,n+r,t+i,n+r*ZW,t+i,n),e.bezierCurveTo(t+i,n-r*ZW,t+i*ZW,n-r,t,n-r),e.bezierCurveTo(t-i*ZW,n-r,t-i,n-r*ZW,t-i,n),e.close()}function $W(e,t,n,i,r,a,o,s,c,l,u){var h,_,f,d,p,m,v,g,y,x,S,T,E,C,A,b;l>10||(p=.5*(a+s),m=.5*(o+c),v=.5*((h=.5*(t+i))+(f=.5*(i+a))),g=.5*((_=.5*(n+r))+(d=.5*(r+o))),((A=KW((i-s)*(C=c-n)-(r-c)*(E=s-t)))+(b=KW((a-s)*C-(o-c)*E)))*(A+b)<e.tessTol*(E*E+C*C)?e.addPoint(s,c,0===u?u|UW.PT_BEVEL:u):($W(e,t,n,h,_,v,g,S=.5*(v+(y=.5*(f+p))),T=.5*(g+(x=.5*(d+m))),l+1,0),$W(e,S,T,y,x,p,m,s,c,l+1,u)))}var eq,tq,nq,iq,rq,aq,oq,sq,cq,lq,uq,hq,_q,fq,dq,pq,mq,vq,gq,yq,xq,Sq,Tq,Eq,Cq,Aq,bq,wq,Rq,Pq,Iq,Dq,Oq,Nq,Mq,kq,Lq,Bq,Fq,zq,Uq,Gq,Hq,Vq,jq,Wq,qq,Xq=function(e){te(n,e);var t=le(n);function n(e,i){var r;return K(this,n),(r=t.call(this,e,i)).dx=0,r.dy=0,r.dmx=0,r.dmy=0,r.flags=0,r.len=0,r.reset(),r}return Z(n,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),n}(ri),Yq=function(){function e(){K(this,e),this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return Z(e,[{key:"reset",value:function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),Kq=function(){function e(){K(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Bn.WHITE.clone(),this.lineCap=FW.BUTT,this.strokeColor=Bn.BLACK.clone(),this.lineJoin=zW.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}return Z(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,UW.PT_CORNER),this._commandX=e,this._commandY=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,UW.PT_CORNER),this._commandX=e,this._commandY=t}},{key:"bezierCurveTo",value:function(e,t,n,i,r,a){var o=this._curPath,s=o.points[o.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==a?($W(this,s.x,s.y,e,t,n,i,r,a,0,UW.PT_CORNER),this._commandX=r,this._commandY=a):this.lineTo(r,a))}},{key:"quadraticCurveTo",value:function(e,t,n,i){var r=this._commandX,a=this._commandY;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),n+2/3*(e-n),i+2/3*(t-i),n,i)}},{key:"arc",value:function(e,t,n,i,r,a){!function(e,t,n,i,r,a,o){var s,c,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,g=0,y=0,x=0,S=0,T=0;if(u=a-r,o=o||!1)if(KW(u)>=2*jW)u=2*jW;else for(;u<0;)u+=2*jW;else if(KW(u)>=2*jW)u=2*-jW;else for(;u>0;)u-=2*jW;for(c=0|qW(1,WW(KW(u)/(.5*jW)+.5,5)),h=KW(4/3*(1-XW(s=u/c/2))/YW(s)),o||(h=-h),T=0;T<=c;T++)d=t+(_=XW(l=r+u*(T/c)))*i,p=n+(f=YW(l))*i,m=-f*i*h,v=_*i*h,0===T?e.moveTo(d,p):e.bezierCurveTo(g+x,y+S,d-m,p-v,d,p),g=d,y=p,x=m,S=v}(this,e,t,n,i,r,a)}},{key:"ellipse",value:function(e,t,n,i){JW(this,e,t,n,i),this._curPath.complex=!1}},{key:"circle",value:function(e,t,n){JW(this,e,t,n,n),this._curPath.complex=!1}},{key:"rect",value:function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,n,i,r){!function(e,t,n,i,r,a){if(a<.1)e.rect(t,n,i,r);else{var o=WW(a,.5*KW(i))*QW(i),s=WW(a,.5*KW(r))*QW(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-ZW),t+o*(1-ZW),n+r,t+o,n+r),e.lineTo(t+i-o,n+r),e.bezierCurveTo(t+i-o*(1-ZW),n+r,t+i,n+r-s*(1-ZW),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-ZW),t+i-o*(1-ZW),n,t+i-o,n),e.lineTo(t+o,n),e.bezierCurveTo(t+o*(1-ZW),n,t,n+s*(1-ZW),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1}},{key:"clear",value:function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&BV.remove(i)}this._renderDataList.length=0}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=BV.add();return this._renderDataList.push(e),e}},{key:"getRenderDataList",value:function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}},{key:"addPoint",value:function(e,t,n){var i=this._curPath;if(i){var r=this._points,a=i.points,o=r[this.pointsOffset++];o?(o.x=e,o.y=t):(o=new Xq(e,t),r.push(o)),o.flags=n,a.push(o)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new Yq,this.paths.push(t)),this.pathLength++,this._curPath=t,t}}]),e}(),Qq=_V.concat([new zr("a_dist",Ei.R32F)]),Zq=pV(Qq),Jq=mV(Qq),$q=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((eq=Cc("cc.Graphics"),tq=Uc(),nq=bc(110),iq=Lc(),rq=Wc(),aq=rl(zW),oq=Wc(),sq=rl(FW),cq=Wc(),lq=Wc(),uq=Wc(),hq=Wc(),_q=Hc(),eq(fq=tq(fq=nq(fq=iq((Tq=Sq=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this)).impl=null,e.model=null,ye(e,"_lineWidth",pq,se(e)),ye(e,"_strokeColor",mq,se(e)),ye(e,"_lineJoin",vq,se(e)),ye(e,"_lineCap",gq,se(e)),ye(e,"_fillColor",yq,se(e)),ye(e,"_miterLimit",xq,se(e)),e._isDrawing=!1,e._isNeedUploadData=!0,e._graphicsUseSubMeshes=[],e._instanceMaterialType=_j.ADD_COLOR,e.impl=new Kq,e}return Z(n,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}},{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"onLoad",value:function(){this.model=$N.root.createModel(gT),this.model.node=this.model.transform=this.node,this._flushAssembler()}},{key:"onEnable",value:function(){he(ne(n.prototype),"onEnable",this).call(this),this._updateMtlForGraphics()}},{key:"onDisable",value:function(){he(ne(n.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){this._sceneGetter=null,this.model&&($N.root.destroyModel(this.model),this.model=null);var e=this._graphicsUseSubMeshes.length;if(e>0){for(var t=0;t<e;++t)this._graphicsUseSubMeshes[t].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),he(ne(n.prototype),"onDestroy",this).call(this)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,n,i,r,a){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,a)}},{key:"quadraticCurveTo",value:function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)}},{key:"arc",value:function(e,t,n,i,r,a){this.impl&&this.impl.arc(e,t,n,i,r,a)}},{key:"ellipse",value:function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)}},{key:"circle",value:function(e,t,n){this.impl&&this.impl.circle(e,t,n)}},{key:"rect",value:function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)}},{key:"roundRect",value:function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)}},{key:"fillRect",value:function(e,t,n,i){this.rect(e,t,n,i),this.fill()}},{key:"clear",value:function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)}},{key:"fill",value:function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)}},{key:"_updateMtlForGraphics",value:function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=Gv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))}},{key:"activeSubModel",value:function(e){if(this.model){if(this.model.subModels.length<=e){var t=c.director.root.device,n=t.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.DEVICE,65535*Jq,Jq)),i=t.createBuffer(new Tr(bi.INDEX|bi.TRANSFER_DST,Pi.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new Zb([n],Qq,Yi.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(e,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else P(4500,this.node.name)}},{key:"_uploadData",value:function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],a=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var o=new Float32Array(r.vData.buffer,0,r.vertexStart*Zq);a.vertexBuffers[0].update(o),a.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);a.indexBuffer.update(s),a.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}}},{key:"_render",value:function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))}},{key:"_flushAssembler",value:function(){var e=n.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!he(ne(n.prototype),"_canRender",this).call(this)&&!!this.model&&this._isDrawing}}]),n}(IW),Sq.LineJoin=zW,Sq.LineCap=FW,xe((dq=Tq).prototype,"lineWidth",[Gc,rq],Object.getOwnPropertyDescriptor(dq.prototype,"lineWidth"),dq.prototype),xe(dq.prototype,"lineJoin",[aq,oq],Object.getOwnPropertyDescriptor(dq.prototype,"lineJoin"),dq.prototype),xe(dq.prototype,"lineCap",[sq,cq],Object.getOwnPropertyDescriptor(dq.prototype,"lineCap"),dq.prototype),xe(dq.prototype,"strokeColor",[lq],Object.getOwnPropertyDescriptor(dq.prototype,"strokeColor"),dq.prototype),xe(dq.prototype,"fillColor",[uq],Object.getOwnPropertyDescriptor(dq.prototype,"fillColor"),dq.prototype),xe(dq.prototype,"miterLimit",[hq],Object.getOwnPropertyDescriptor(dq.prototype,"miterLimit"),dq.prototype),xe(dq.prototype,"color",[dl,_q],Object.getOwnPropertyDescriptor(dq.prototype,"color"),dq.prototype),pq=xe(dq.prototype,"_lineWidth",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mq=xe(dq.prototype,"_strokeColor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bn.BLACK.clone()}}),vq=xe(dq.prototype,"_lineJoin",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zW.MITER}}),gq=xe(dq.prototype,"_lineCap",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FW.BUTT}}),yq=xe(dq.prototype,"_fillColor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bn.WHITE.clone()}}),xq=xe(dq.prototype,"_miterLimit",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),fq=dq))||fq)||fq)||fq)||fq));c.Graphics=$q;var eX,tX=new ei,nX=new ri,iX=new ei,rX=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(eX||(eX={})),yt(eX);var aX=function(t){return e({Mask:t,MaskComponent:t}),t}((Eq=Cc("cc.Mask"),Cq=Uc(),Aq=bc(110),bq=Lc(),wq=rl(eX),Rq=Wc(),Pq=Zc(),Iq=Wc(),Dq=Hc(),Oq=rl(yH),Nq=Hc(),Mq=Hc(),kq=qc(),Lq=Hc(),Bq=Hc(),Eq(Fq=Cq(Fq=Aq(Fq=bq((qq=Wq=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this))._clearStencilMtl=null,e._clearModel=null,ye(e,"_type",Uq,se(e)),ye(e,"_inverted",Gq,se(e)),ye(e,"_segments",Hq,se(e)),ye(e,"_spriteFrame",Vq,se(e)),ye(e,"_alphaThreshold",jq,se(e)),e._graphics=null,e._clearModelMesh=null,e._instanceMaterialType=_j.ADD_COLOR,e}return Z(n,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==eX.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=DV.DISABLED,this._graphics&&(this._graphics.stencilStage=DV.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=gn(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===eX.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===eX.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}},{key:"onLoad",value:function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()}},{key:"onEnable",value:function(){he(ne(n.prototype),"onEnable",this).call(this),this._updateGraphics(),this._enableGraphics()}},{key:"onRestore",value:function(){this._createGraphics(),he(ne(n.prototype),"updateMaterial",this).call(this),this._updateGraphics(),this._renderFlag=this._canRender()}},{key:"onDisable",value:function(){he(ne(n.prototype),"onDisable",this).call(this),this._disableGraphics()}},{key:"onDestroy",value:function(){this._clearModel&&this._clearModelMesh&&($N.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),he(ne(n.prototype),"onDestroy",this).call(this)}},{key:"isHit",value:function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,a=nX;this.node.getWorldMatrix(tX),ei.invert(iX,tX),ri.transformMat4(a,e,iX);var o=t.anchorPoint;a.x+=o.x*i,a.y+=o.y*r;var s=!1;if(this.type===eX.RECT||this.type===eX.GRAPHICS_STENCIL||this.type===eX.IMAGE_STENCIL)s=a.x>=0&&a.y>=0&&a.x<=i&&a.y<=r;else if(this.type===eX.ELLIPSE){var c=i/2,l=r/2,u=a.x-.5*i,h=a.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s}},{key:"_render",value:function(e){e.commitComp(this,this.renderData,null,this._assembler,null)}},{key:"_postRender",value:function(e){this._postAssembler&&e.commitComp(this,null,null,this._postAssembler,null)}},{key:"_nodeStateChange",value:function(e){he(ne(n.prototype),"_nodeStateChange",this).call(this,e),this._updateGraphics()}},{key:"_canRender",value:function(){return!!he(ne(n.prototype),"_canRender",this).call(this)&&null!==this._graphics&&(this._type!==eX.IMAGE_STENCIL||null!==this._spriteFrame)}},{key:"_flushAssembler",value:function(){var e=n.Assembler.getAssembler(this),t=n.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==t&&(this._postAssembler=t),this._useRenderData()}},{key:"_createGraphics",value:function(){if(!this._graphics){var e=this._graphics=new $q;e._objFlags|=Tl.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=Bn.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()}},{key:"_updateGraphics",value:function(){if(this._graphics&&(this._type===eX.RECT||this._type===eX.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,a=e.anchorPoint,o=-i*a.x,s=-r*a.y;if(this._type===eX.RECT)t.rect(o,s,i,r);else if(this._type===eX.ELLIPSE){for(var c=function(e,t,n){rX.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)rX.push(new zn(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return rX}(new zn(o+i/2,s+r/2,0),new zn(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}}},{key:"_createClearModel",value:function(){if(!this._clearModel){var e=Gv.get("default-clear-stencil");this._clearStencilMtl=new bT({parent:e,owner:this,subModelIdx:0}),this._clearModel=$N.root.createModel(gT),this._clearModel.node=this._clearModel.transform=this.node;var t=mV(hV),n=c.director.root.device,i=n.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.DEVICE,4*t,t)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var a=n.createBuffer(new Tr(bi.INDEX|bi.TRANSFER_DST,Pi.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new Uint16Array([0,1,2,2,1,3]);a.update(o),this._clearModelMesh=new Zb([i],hV,Yi.TRIANGLE_LIST,a),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}}},{key:"_updateMaterial",value:function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=DV.DISABLED,this._type===eX.IMAGE_STENCIL?(e=Gv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=Gv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}}},{key:"_enableGraphics",value:function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)}},{key:"_useRenderData",value:function(){this._type!==eX.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())}}]),n}(IW),Wq.Type=eX,xe((zq=qq).prototype,"type",[wq,Rq],Object.getOwnPropertyDescriptor(zq.prototype,"type"),zq.prototype),xe(zq.prototype,"inverted",[Pq,Iq],Object.getOwnPropertyDescriptor(zq.prototype,"inverted"),zq.prototype),xe(zq.prototype,"segments",[Dq],Object.getOwnPropertyDescriptor(zq.prototype,"segments"),zq.prototype),xe(zq.prototype,"spriteFrame",[Oq,Nq],Object.getOwnPropertyDescriptor(zq.prototype,"spriteFrame"),zq.prototype),xe(zq.prototype,"alphaThreshold",[Mq,kq,Qc],Object.getOwnPropertyDescriptor(zq.prototype,"alphaThreshold"),zq.prototype),xe(zq.prototype,"color",[dl,Lq],Object.getOwnPropertyDescriptor(zq.prototype,"color"),zq.prototype),xe(zq.prototype,"customMaterial",[dl,Bq],Object.getOwnPropertyDescriptor(zq.prototype,"customMaterial"),zq.prototype),Uq=xe(zq.prototype,"_type",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eX.RECT}}),Gq=xe(zq.prototype,"_inverted",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hq=xe(zq.prototype,"_segments",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Vq=xe(zq.prototype,"_spriteFrame",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jq=xe(zq.prototype,"_alphaThreshold",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Fq=zq))||Fq)||Fq)||Fq)||Fq));BI._maskComp=aX,c.Mask=aX;var oX,sX,cX,lX,uX,hX,_X,fX,dX,pX,mX,vX,gX,yX,xX,SX,TX,EX,CX,AX,bX,wX,RX,PX,IX,DX,OX,NX,MX,kX,LX,BX,FX,zX,UX,GX,HX,VX,jX,WX,qX,XX,YX,KX,QX,ZX,JX,$X,eY,tY,nY,iY,rY,aY,oY,sY,cY,lY,uY,hY,_Y,fY,dY=/^(click)(\s)*=|(param)(\s)*=/,pY=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,mY=e("HtmlTextParser",function(){function e(){K(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return Z(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var a=e.substring(t,r),o=e.substring(r+1,i);""===o&&(a=e.substring(t,i+1)),this._processResult(a),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(o),t=i+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,a="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var o="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=pY.exec(e);for(var c=!1;n;){if(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),s=(r=(o=e.substring(i.length).trim()).indexOf(" "))>-1?o.substr(0,r):o,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=o.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}t.isImage=!0,t.src=s}else if("height"===i)t.imageHeight=parseInt(s);else if("width"===i)t.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}t.imageAlign=s.toLowerCase()}else"offset"===i?t.imageOffset=s:"click"===i&&(t.event=this._processEventHandler("".concat(i,"=").concat(s)));t.event&&"param"===i&&(t.event[i]=s.replace(/^"|"$/g,"")),n=pY.exec(e)}return c&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var l={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),u=(r=(o=e.substring(i.length).trim()).indexOf(" "))>-1?o.substr(0,r):o,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=o.substring(r).trim(),"click"===i?t.event=this._processEventHandler("".concat(i,"=").concat(u)):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),t.event&&"param"===i&&(t.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(e)}t.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t={},n=0,i=!1,r=dY.exec(e);r;){var a=r[0],o="";if(i=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(o=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(o=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(o=s?s[0]:"").length}i&&(t[a=a.substring(0,a.length-1).trim()]=o),e=e.substring(n).trim(),r=dY.exec(e)}return t}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){for(var t,n=ge(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],a=i[1];e=e.replace(r,a)}return e}}]),e}()),vY=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((oX=Cc("cc.LabelOutline"),sX=Uc(),cX=bc(110),lX=Lc(),uX=Ac(DW),hX=Wc(),_X=Wc(),oX(fX=sX(fX=cX(fX=lX(fX=uX(fX=kc((vX=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_color",pX,se(e)),ye(e,"_width",mX,se(e)),e}return Z(n,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}},{key:"onEnable",value:function(){this._updateRenderData()}},{key:"onDisable",value:function(){this._updateRenderData()}},{key:"_updateRenderData",value:function(){var e=this.node.getComponent(DW);e&&e.updateRenderData(!0)}}]),n}(sh),pX=xe((dX=vX).prototype,"_color",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bn(0,0,0,255)}}),mX=xe(dX.prototype,"_width",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),xe(dX.prototype,"color",[hX],Object.getOwnPropertyDescriptor(dX.prototype,"color"),dX.prototype),xe(dX.prototype,"width",[_X],Object.getOwnPropertyDescriptor(dX.prototype,"width"),dX.prototype),fX=dX))||fX)||fX)||fX)||fX)||fX)||fX));c.LabelOutline=vY,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(uY||(uY={})),yt(uY),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(hY||(hY={})),yt(hY),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(_Y||(_Y={})),yt(_Y),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(fY||(fY={}));var gY,yY=function(t){return e({Sprite:t,SpriteComponent:t}),t}((gX=Cc("cc.Sprite"),yX=Uc(),xX=bc(110),SX=Lc(),TX=rl(SH),EX=Zc(),CX=Wc(),AX=rl(yH),bX=Zc(),wX=Wc(),RX=rl(uY),PX=Zc(),IX=Wc(),DX=rl(hY),OX=Zc(),NX=Wc(),MX=Zc(),kX=Wc(),LX=qc(),BX=Zc(),FX=Wc(),zX=qc(),UX=Zc(),GX=Wc(),HX=Hc(),VX=Zc(),jX=Wc(),WX=Zc(),qX=Wc(),XX=rl(_Y),YX=Zc(),KX=Wc(),gX(QX=yX(QX=xX(QX=SX((lY=cY=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_spriteFrame",JX,se(e)),ye(e,"_type",$X,se(e)),ye(e,"_fillType",eY,se(e)),ye(e,"_sizeMode",tY,se(e)),ye(e,"_fillCenter",nY,se(e)),ye(e,"_fillStart",iY,se(e)),ye(e,"_fillRange",rY,se(e)),ye(e,"_isTrimmedMode",aY,se(e)),ye(e,"_useGrayscale",oY,se(e)),ye(e,"_atlas",sY,se(e)),e}return Z(n,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===hY.RADIAL||this._fillType===hY.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===uY.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=gn(e,0,1),this._type===uY.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=gn(e,-1,1),this._type===uY.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===uY.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==_Y.CUSTOM&&this._applySpriteSize())}},{key:"__preload",value:function(){this.changeMaterialForDefine(),he(ne(n.prototype),"__preload",this).call(this)}},{key:"onEnable",value:function(){he(ne(n.prototype),"onEnable",this).call(this),this._activateMaterial();var e=this._spriteFrame;e&&(this._updateUVs(),this._type===uY.SLICED&&e.on(yH.EVENT_UV_UPDATED,this._updateUVs,this))}},{key:"onDisable",value:function(){this._spriteFrame&&this._type===uY.SLICED&&this._spriteFrame.off(yH.EVENT_UV_UPDATED,this._updateUVs,this)}},{key:"onDestroy",value:function(){he(ne(n.prototype),"onDestroy",this).call(this)}},{key:"changeSpriteFrameFromAtlas",value:function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")}},{key:"changeMaterialForDefine",value:function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof sv){var i=e.getPixelFormat();n=i===Um.RGBA_ETC1||i===Um.RGB_A_PVRTC_4BPPV1||i===Um.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=_j.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=_j.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=_j.GRAYSCALE:this._instanceMaterialType=_j.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()}},{key:"_updateBuiltinMaterial",value:function(){var e=he(ne(n.prototype),"_updateBuiltinMaterial",this).call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof KS){var t=ee({SAMPLE_FROM_RT:!0},e.passes[0].defines),i=new gg;i.initialize({effectAsset:e.effectAsset,defines:t}),e=i}return e}},{key:"_render",value:function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)}},{key:"_canRender",value:function(){if(!he(ne(n.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.texture)}},{key:"_flushAssembler",value:function(){var e=n.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===uY.SLICED?this._spriteFrame.on(yH.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(yH.EVENT_UV_UPDATED,this._updateUVs,this))}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(_Y.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(_Y.TRIMMED===this._sizeMode){var t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)}},{key:"_updateUVs",value:function(){this._assembler&&this._assembler.updateUVs(this)}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;e&&this._type===uY.SLICED&&e.off(yH.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===uY.SLICED&&t.on(yH.EVENT_UV_UPDATED,this._updateUVs,this))}}]),n}(IW),cY.FillType=hY,cY.Type=uY,cY.SizeMode=_Y,cY.EventType=fY,xe((ZX=lY).prototype,"spriteAtlas",[TX,EX,CX],Object.getOwnPropertyDescriptor(ZX.prototype,"spriteAtlas"),ZX.prototype),xe(ZX.prototype,"spriteFrame",[AX,bX,wX],Object.getOwnPropertyDescriptor(ZX.prototype,"spriteFrame"),ZX.prototype),xe(ZX.prototype,"type",[RX,PX,IX],Object.getOwnPropertyDescriptor(ZX.prototype,"type"),ZX.prototype),xe(ZX.prototype,"fillType",[DX,OX,NX],Object.getOwnPropertyDescriptor(ZX.prototype,"fillType"),ZX.prototype),xe(ZX.prototype,"fillCenter",[MX,kX],Object.getOwnPropertyDescriptor(ZX.prototype,"fillCenter"),ZX.prototype),xe(ZX.prototype,"fillStart",[LX,BX,FX],Object.getOwnPropertyDescriptor(ZX.prototype,"fillStart"),ZX.prototype),xe(ZX.prototype,"fillRange",[zX,UX,GX],Object.getOwnPropertyDescriptor(ZX.prototype,"fillRange"),ZX.prototype),xe(ZX.prototype,"trim",[HX,VX,jX],Object.getOwnPropertyDescriptor(ZX.prototype,"trim"),ZX.prototype),xe(ZX.prototype,"grayscale",[Gc,WX,qX],Object.getOwnPropertyDescriptor(ZX.prototype,"grayscale"),ZX.prototype),xe(ZX.prototype,"sizeMode",[XX,YX,KX],Object.getOwnPropertyDescriptor(ZX.prototype,"sizeMode"),ZX.prototype),JX=xe(ZX.prototype,"_spriteFrame",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$X=xe(ZX.prototype,"_type",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uY.SIMPLE}}),eY=xe(ZX.prototype,"_fillType",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hY.HORIZONTAL}}),tY=xe(ZX.prototype,"_sizeMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _Y.TRIMMED}}),nY=xe(ZX.prototype,"_fillCenter",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri(0,0)}}),iY=xe(ZX.prototype,"_fillStart",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rY=xe(ZX.prototype,"_fillRange",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aY=xe(ZX.prototype,"_isTrimmedMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),oY=xe(ZX.prototype,"_useGrayscale",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sY=xe(ZX.prototype,"_atlas",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QX=ZX))||QX)||QX)||QX)||QX));c.Sprite=yY;var xY,SY,TY,EY,CY,AY,bY,wY,RY,PY,IY,DY,OY,NY,MY,kY,LY,BY,FY,zY,UY,GY,HY,VY,jY,WY,qY,XY,YY,KY,QY,ZY,JY,$Y,eK,tK,nK,iK,rK,aK,oK,sK,cK,lK,uK,hK,_K,fK,dK,pK=e("RenderRoot2D",Cc("cc.RenderRoot2D")(gY=bc(100)(gY=Lc()(gY=Ac(qV)(gY=wc(gY=kc(gY=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"onEnable",value:function(){c.director.root.batcher2D.addScreen(this)}},{key:"onDisable",value:function(){c.director.root.batcher2D.removeScreen(this)}},{key:"onDestroy",value:function(){c.director.root.batcher2D.removeScreen(this)}}]),n}(sh))||gY)||gY)||gY)||gY)||gY)||gY),mK=new zn,vK=mt({OVERLAY:0,INTERSPERSE:1}),gK=function(t){return e({Canvas:t,CanvasComponent:t}),t}((xY=Cc("cc.Canvas"),SY=Uc(),TY=bc(100),EY=Lc(),CY=rl(dB),AY=Wc(),bY=Wc(),wY=rl(dB),xY(RY=SY(RY=TY(RY=EY(RY=kc(RY=wc((xe((PY=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"_cameraComponent",IY,se(e)),ye(e,"_alignCanvasWithScreen",DY,se(e)),e._thisOnCameraResized=void 0,e._fitDesignResolution=void 0,e._pos=new zn,e._renderMode=vK.OVERLAY,e._thisOnCameraResized=e._onResizeCamera.bind(se(e)),e}return Z(n,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}},{key:"__preload",value:function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(dB.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on($E.TRANSFORM_CHANGED,this._thisOnCameraResized)}},{key:"onEnable",value:function(){he(ne(n.prototype),"onEnable",this).call(this),this._cameraComponent&&this._cameraComponent.node.on(dB.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}},{key:"onDisable",value:function(){he(ne(n.prototype),"onDisable",this).call(this),this._cameraComponent&&this._cameraComponent.node.off(dB.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}},{key:"onDestroy",value:function(){he(ne(n.prototype),"onDestroy",this).call(this),this.node.off($E.TRANSFORM_CHANGED,this._thisOnCameraResized)}},{key:"_onResizeCamera",value:function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=nM.height/2;else{var e=mh.windowSize;this._cameraComponent.orthoHeight=e.height/lM.getScaleY()/2}this.node.getWorldPosition(mK),this._cameraComponent.node.setWorldPosition(mK.x,mK.y,1e3)}}},{key:"_getViewPriority",value:function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===vK.OVERLAY?t|1<<30:t&~(1<<30)}return 0}}]),n}(pK)).prototype,"cameraComponent",[CY,AY],Object.getOwnPropertyDescriptor(PY.prototype,"cameraComponent"),PY.prototype),xe(PY.prototype,"alignCanvasWithScreen",[bY],Object.getOwnPropertyDescriptor(PY.prototype,"alignCanvasWithScreen"),PY.prototype),IY=xe(PY.prototype,"_cameraComponent",[wY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DY=xe(PY.prototype,"_alignCanvasWithScreen",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),RY=PY))||RY)||RY)||RY)||RY)||RY)||RY));c.Canvas=gK,z(e("UIComponent",Cc("cc.UIComponent")(OY=Ac(qV)(OY=bc(110)(OY=wc(OY=kc(OY=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._lastParent=null,e.stencilStage=DV.DISABLED,e}return Z(n,[{key:"__preload",value:function(){this.node._uiProps.uiComp=this}},{key:"onEnable",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}},{key:"updateAssembler",value:function(){}},{key:"postUpdateAssembler",value:function(){}},{key:"markForUpdateRenderData",value:function(){}},{key:"setNodeDirty",value:function(){}},{key:"setTextureDirty",value:function(){}}]),n}(sh))||OY)||OY)||OY)||OY)||OY).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),F(gK.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:Bn.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),U(IW.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),U(qV.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),c.UITransformComponent=qV,dt.setClassAlias(qV,"cc.UITransformComponent"),dt.setClassAlias(IW,"cc.RenderComponent"),c.CanvasComponent=gK,dt.setClassAlias(gK,"cc.CanvasComponent");var yK=new mY,xK="RICHTEXT_CHILD",SK="RICHTEXT_Image_CHILD",TK=new _t((function(e){if(!c.isValid(e.node))return!1;var t=e.node.getComponent(vY);return t&&(t.width=0),!0}),20),EK=new _t((function(e){return c.isValid(e.node)}),10);function CK(e){return{node:new tb(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function AK(e,t){var n;e===xK?n=TK._get():e===SK&&(n=EK._get());var i=(n=n||CK(e)).node;return i||(i=new tb(e)),i.hideFlags|=Tl.Flags.DontSave|Tl.Flags.HideInHierarchy,e===SK?(n.comp=i.getComponent(yY)||i.addComponent(yY),n.comp.spriteFrame=t,n.comp.type=yY.Type.SLICED,n.comp.sizeMode=yY.SizeMode.CUSTOM):(n.comp=i.getComponent(DW)||i.addComponent(DW),n.comp.string=t,n.comp.horizontalAlign=bW.LEFT,n.comp.verticalAlign=wW.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var bK,wK=function(t){return e({RichText:t,RichTextComponent:t}),t}((NY=Cc("cc.RichText"),MY=Uc(),kY=bc(110),LY=Lc(),BY=Wc(),FY=rl(bW),zY=Wc(),UY=Wc(),GY=Wc(),HY=rl(bH),VY=Wc(),jY=Wc(),WY=Zc(),qY=rl(PW),XY=Wc(),YY=Wc(),KY=Wc(),QY=rl(SH),ZY=Wc(),JY=Wc(),NY($Y=MY($Y=kY($Y=LY($Y=kc((dK=fK=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"_lineHeight",tK,se(e)),ye(e,"_string",nK,se(e)),ye(e,"_horizontalAlign",iK,se(e)),ye(e,"_fontSize",rK,se(e)),ye(e,"_maxWidth",aK,se(e)),ye(e,"_fontFamily",oK,se(e)),ye(e,"_font",sK,se(e)),ye(e,"_isSystemFontUsed",cK,se(e)),ye(e,"_userDefinedFont",lK,se(e)),ye(e,"_cacheMode",uK,se(e)),ye(e,"_imageAtlas",hK,se(e)),ye(e,"_handleTouchEvent",_K,se(e)),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}return Z(n,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}},{key:"onLoad",value:function(){this.node.on($E.LAYER_CHANGED,this._applyLayer,this)}},{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded(),this.node.on($E.ANCHOR_CHANGED,this._updateRichTextPosition,this)}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){for(var e,t=ge(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===xK?TK.put(n):n.type===SK&&EK.put(n)}this.node.off($E.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off($E.LAYER_CHANGED,this._applyLayer,this)}},{key:"_addEventListeners",value:function(){this.node.on($E.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off($E.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))}},{key:"_createFontLabel",value:function(e){return AK(xK,e)}},{key:"_createImage",value:function(e){return AK(SK,e)}},{key:"_onTTFLoaded",value:function(){this._font,this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(e,t){var n=this,i=function(t){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(t),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(DW).string=t,i.styleIndex=e,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return t?i(t):i}},{key:"_onTouchEnded",value:function(e){for(var t,n=this,i=this.node.getComponents(sh),r=function(){var r=t.value,a=r.clickHandler,o=r.clickParam;a&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[a];t.enabledInHierarchy&&n&&n.call(t,e,o)})),e.propagationStopped=!0)},a=ge(this._segments);!(t=a()).done;)r()}},{key:"_containsTouchLocation",value:function(e,t){var n=e.node.getComponent(qV);return!!n&&n.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===xK||n.name===SK){n.parent===this.node?n.parent=null:e.splice(t,1);var i=CK(n.name);i.node=n,n.name===xK?(i.comp=n.getComponent(DW),TK.put(i)):(i.comp=n.getComponent(yY),EK.put(i))}}e.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==xK&&n.name!==SK||(n.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(DW);i&&(i.string=e)}return n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var a=this._getFirstWordLen(e,r,e.length),o=e.substr(r,a),s=this._measureText(n,o);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=a}if(i>this._maxWidth)for(var l=nV(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,a=i.style;if(r){if(a){if(!!a.outline!=!!r.outline)return!0;if(r.size!==a.size||r.italic!==a.italic||r.isImage!==a.isImage)return!0;if(r.src!==a.src||r.imageAlign!==a.imageAlign||r.imageHeight!==a.imageHeight||r.imageWidth!==a.imageWidth||r.imageOffset!==a.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(a&&(a.size||a.italic||a.isImage||a.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var a=i.rect.clone(),o=1,s=a.width,c=a.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=o=u/c,c*=o):(s*=o=this._lineHeight/c,c*=o),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else P(4400)}}},{key:"_updateRichText",value:function(){if(this.enabledInHierarchy){var e=yK.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var o=a.split("\n"),s=0;s<o.length;++s){var c=o[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),o.length>1&&s<o.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),o.length>1&&s<o.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&s===o.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+HH)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,n){var i=e.charAt(t);if(JH(i)||$H(i))return 1;for(var r=1,a=t+1;a<n&&!$H(i=e.charAt(a))&&!JH(i);++a)r++;return r}},{key:"_updateRichTextPosition",value:function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,a=i.anchorY,o=0;o<this._segments.length;++o){var s=this._segments[o],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case bW.LEFT:break;case bW.CENTER:l-=this._linesWidth[c-1]/2;break;case bW.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*a,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(yY)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+HH);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var d=s.imageOffset.split(",");if(1===d.length&&d[0]){var p=parseFloat(d[0]);Number.isInteger(p)&&(h.y+=p)}else if(2===d.length){var m=parseFloat(d[0]),v=parseFloat(d[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(vY);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return Bn[t]?Bn[t]:(new Bn).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(DW);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(vY);r||(r=e.node.addComponent(vY)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var a=n.event;a&&(e.clickHandler=a.click||"",e.clickParam=a.param||"")}t.cacheMode=this._cacheMode,this._font instanceof bH&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var o=t._assembler;o&&o.updateRenderData(t)}}},{key:"_applyLayer",value:function(){for(var e,t=ge(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer}},{key:"_resetLabelState",value:function(e){e.fontSize=this._fontSize,e.color=Bn.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1}}]),n}(sh),fK.HorizontalAlign=bW,fK.VerticalAlign=wW,xe((eK=dK).prototype,"string",[Jc,BY],Object.getOwnPropertyDescriptor(eK.prototype,"string"),eK.prototype),xe(eK.prototype,"horizontalAlign",[FY,zY],Object.getOwnPropertyDescriptor(eK.prototype,"horizontalAlign"),eK.prototype),xe(eK.prototype,"fontSize",[UY],Object.getOwnPropertyDescriptor(eK.prototype,"fontSize"),eK.prototype),xe(eK.prototype,"fontFamily",[GY],Object.getOwnPropertyDescriptor(eK.prototype,"fontFamily"),eK.prototype),xe(eK.prototype,"font",[HY,VY],Object.getOwnPropertyDescriptor(eK.prototype,"font"),eK.prototype),xe(eK.prototype,"useSystemFont",[jY,WY],Object.getOwnPropertyDescriptor(eK.prototype,"useSystemFont"),eK.prototype),xe(eK.prototype,"cacheMode",[qY,XY],Object.getOwnPropertyDescriptor(eK.prototype,"cacheMode"),eK.prototype),xe(eK.prototype,"maxWidth",[YY],Object.getOwnPropertyDescriptor(eK.prototype,"maxWidth"),eK.prototype),xe(eK.prototype,"lineHeight",[KY],Object.getOwnPropertyDescriptor(eK.prototype,"lineHeight"),eK.prototype),xe(eK.prototype,"imageAtlas",[QY,ZY],Object.getOwnPropertyDescriptor(eK.prototype,"imageAtlas"),eK.prototype),xe(eK.prototype,"handleTouchEvent",[JY],Object.getOwnPropertyDescriptor(eK.prototype,"handleTouchEvent"),eK.prototype),tK=xe(eK.prototype,"_lineHeight",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),nK=xe(eK.prototype,"_string",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),iK=xe(eK.prototype,"_horizontalAlign",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bW.LEFT}}),rK=xe(eK.prototype,"_fontSize",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),aK=xe(eK.prototype,"_maxWidth",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oK=xe(eK.prototype,"_fontFamily",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),sK=xe(eK.prototype,"_font",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cK=xe(eK.prototype,"_isSystemFontUsed",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lK=xe(eK.prototype,"_userDefinedFont",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uK=xe(eK.prototype,"_cacheMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PW.NONE}}),hK=xe(eK.prototype,"_imageAtlas",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_K=xe(eK.prototype,"_handleTouchEvent",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$Y=eK))||$Y)||$Y)||$Y)||$Y)||$Y));c.RichText=wK;var RK=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(Cc("cc.UIMeshRenderer")(bK=Uc()(bK=bc(110)(bK=Lc()(bK=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._models=null,e._modelComponent=null,e.stencilStage=DV.DISABLED,e}return Z(n,[{key:"modelComponent",get:function(){return this._modelComponent}},{key:"__preload",value:function(){this.node._uiProps.uiComp=this}},{key:"onLoad",value:function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '".concat(this.node&&this.node.name,"' doesn't have any renderable component"))}},{key:"onDestroy",value:function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)}},{key:"updateAssembler",value:function(e){if(this._models){this._modelComponent._detachFromScene();for(var t,n=ge(this._models);!(t=n()).done;){var i=t.value;e.commitModel.call(e,this,i,this._modelComponent.material)}return!0}return!1}},{key:"postUpdateAssembler",value:function(){}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,a=0;a<r;a++)i[a]._priority=qd.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},a)}}},{key:"markForUpdateRenderData",value:function(){}},{key:"setNodeDirty",value:function(){}},{key:"setTextureDirty",value:function(){}}]),n}(sh))||bK)||bK)||bK)||bK);c.UIMeshRenderer=RK;var PK,IK,DK,OK,NK,MK,kK,LK,BK,FK,zK,UK,GK,HK,VK,jK,WK,qK,XK,YK,KK,QK,ZK,JK,$K,eQ,tQ,nQ,iQ,rQ=jd.Enum.NONE|jd.Enum.UI_3D,aQ=e("UIDrawBatch",function(){function e(){K(this,e),this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=rQ,this._inputAssembler=null,this._descriptorSet=null}return Z(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}},{key:"destroy",value:function(){this._passes=[]}},{key:"clear",value:function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=rQ,this.renderScene=null}},{key:"fillPasses",value:function(e,t,n,i,r,a){if(e){var o=e.passes;if(!o)return;var s=0;this._shaders.length=o.length;for(var l=0;l<o.length;l++){this._passes[l]||(this._passes[l]=new Kv(c.director.root));var u=o[l],h=this._passes[l];u.update(),t||(t=u.depthStencilState,n=0),i||(i=u.blendState,r=0),-1===r&&(r=0),s=n<<16|r,h._initPassFromTarget(u,t,i,s),this._shaders[l]=h.getShaderVariant(a)}}}}]),e}()),oQ=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((PK=Cc("cc.UIStaticBatch"),IK=Uc(),DK=Lc(),OK=bc(110),NK=Hc(),PK(MK=IK(MK=DK(MK=OK((xe((kK=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._init=!1,e._bufferAccessor=null,e._dirty=!0,e._uiDrawBatchList=[],e}return Z(n,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}},{key:"onLoad",value:function(){}},{key:"onDestroy",value:function(){}},{key:"updateAssembler",value:function(){}},{key:"postUpdateAssembler",value:function(){}},{key:"markAsDirty",value:function(){}},{key:"_requireDrawBatch",value:function(){var e=new aQ;return e.isStatic=!0,this._uiDrawBatchList.push(e),e}},{key:"_clearData",value:function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1}},{key:"_getBatcher",value:function(){return $N.root&&$N.root.batcher2D?$N.root.batcher2D:(P(9301),null)}}]),n}(IW)).prototype,"color",[dl,NK],Object.getOwnPropertyDescriptor(kK.prototype,"color"),kK.prototype),MK=kK))||MK)||MK)||MK)||MK)),sQ=e("LabelShadow",(LK=Cc("cc.LabelShadow"),BK=Uc(),FK=bc(110),zK=Lc(),UK=Ac(DW),GK=Wc(),HK=Wc(),VK=Wc(),LK(jK=BK(jK=FK(jK=zK(jK=UK(jK=kc((KK=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_color",qK,se(e)),ye(e,"_offset",XK,se(e)),ye(e,"_blur",YK,se(e)),e}return Z(n,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}},{key:"onEnable",value:function(){this._updateRenderData()}},{key:"onDisable",value:function(){this._updateRenderData()}},{key:"_updateRenderData",value:function(){var e=this.node.getComponent(DW);e&&e.updateRenderData(!0)}}]),n}(sh),qK=xe((WK=KK).prototype,"_color",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bn(0,0,0,255)}}),XK=xe(WK.prototype,"_offset",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri(2,2)}}),YK=xe(WK.prototype,"_blur",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),xe(WK.prototype,"color",[GK],Object.getOwnPropertyDescriptor(WK.prototype,"color"),WK.prototype),xe(WK.prototype,"offset",[HK],Object.getOwnPropertyDescriptor(WK.prototype,"offset"),WK.prototype),xe(WK.prototype,"blur",[VK],Object.getOwnPropertyDescriptor(WK.prototype,"blur"),WK.prototype),jK=WK))||jK)||jK)||jK)||jK)||jK)||jK)),cQ=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}((QK=Cc("cc.UIOpacity"),ZK=Uc(),JK=bc(110),$K=Lc(),eQ=Wc(),QK(tQ=ZK(tQ=JK(tQ=$K(tQ=kc((xe((nQ=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_opacity",iQ,se(e)),e}return Z(n,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=Nt(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}},{key:"onEnable",value:function(){this.node._uiProps.localOpacity=this._opacity/255}},{key:"onDisable",value:function(){this.node._uiProps.localOpacity=1}}]),n}(sh)).prototype,"opacity",[Gc,eQ],Object.getOwnPropertyDescriptor(nQ.prototype,"opacity"),nQ.prototype),iQ=xe(nQ.prototype,"_opacity",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),tQ=nQ))||tQ)||tQ)||tQ)||tQ)||tQ));c.MaskComponent=aX,dt.setClassAlias(aX,"cc.MaskComponent"),c.LabelComponent=DW,dt.setClassAlias(DW,"cc.LabelComponent"),c.LabelOutlineComponent=vY,dt.setClassAlias(vY,"cc.LabelOutlineComponent"),c.RichTextComponent=wK,dt.setClassAlias(wK,"cc.RichTextComponent"),c.SpriteComponent=yY,dt.setClassAlias(yY,"cc.SpriteComponent"),c.UIModelComponent=RK,dt.setClassAlias(RK,"cc.UIModelComponent"),c.GraphicsComponent=$q,dt.setClassAlias($q,"cc.GraphicsComponent"),dt.setClassAlias(oQ,"cc.UIStaticBatchComponent"),dt.setClassAlias(cQ,"cc.UIOpacityComponent");var lQ=function e(t,n,i){K(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=n,this.y=i};function uQ(e,t,n,i,r){var a=0,o=null;if(r===function(e,t,n,i){for(var r=0,a=t,o=n-i;a<n;a+=i)r+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return r}(e,t,n,i)>0)for(a=t;a<n;a+=i)o=PQ(a,e[a],e[a+1],o);else for(a=n-i;a>=t;a-=i)o=PQ(a,e[a],e[a+1],o);return o&&AQ(o,o.next)&&(IQ(o),o=o.next),o}function hQ(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!AQ(n,n.next)&&0!==CQ(n.prev,n,n.next))n=n.next;else{if(IQ(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function _Q(e,t,n,i,r,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(e){!o&&a&&yQ(e,i,r,a);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,a?dQ(e,i,r,a):fQ(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),IQ(e),e=l.next,s=l.next;else if((e=l)===s){o?1===o?_Q(e=pQ(e,t,n),t,n,i,r,a,2):2===o&&mQ(e,t,n,i,r,a):_Q(hQ(e),t,n,i,r,a,1);break}}}function fQ(e){var t=e.prev,n=e,i=e.next;if(CQ(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(TQ(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&CQ(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function dQ(e,t,n,i){var r=e.prev,a=e,o=e.next;if(CQ(r,a,o)>=0)return!1;for(var s=r.x<a.x?r.x<o.x?r.x:o.x:a.x<o.x?a.x:o.x,c=r.y<a.y?r.y<o.y?r.y:o.y:a.y<o.y?a.y:o.y,l=r.x>a.x?r.x>o.x?r.x:o.x:a.x>o.x?a.x:o.x,u=r.y>a.y?r.y>o.y?r.y:o.y:a.y>o.y?a.y:o.y,h=xQ(s,c,t,n,i),_=xQ(l,u,t,n,i),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&TQ(r.x,r.y,a.x,a.y,o.x,o.y,f.x,f.y)&&CQ(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&TQ(r.x,r.y,a.x,a.y,o.x,o.y,f.x,f.y)&&CQ(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function pQ(e,t,n){var i=e;do{var r=i.prev,a=i.next.next;!AQ(r,a)&&bQ(r,i,i.next,a)&&wQ(r,a)&&wQ(a,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(a.i/n),IQ(i),IQ(i.next),i=e=a),i=i.next}while(i!==e);return i}function mQ(e,t,n,i,r,a){var o=e;do{for(var s=o.next.next;s!==o.prev;){if(o.i!==s.i&&EQ(o,s)){var c=RQ(o,s);return o=hQ(o,o.next),c=hQ(c,c.next),_Q(o,t,n,i,r,a),void _Q(c,t,n,i,r,a)}s=s.next}o=o.next}while(o!==e)}function vQ(e,t){return e.x-t.x}function gQ(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,a=-1/0,o=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>a){if(a=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}o=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!o)return null;if(i===a)return o.prev;var c,l=o,u=o.x,h=o.y,_=1/0;for(n=o.next;n!==l;)i>=n.x&&n.x>=u&&TQ(r<h?i:a,r,u,h,r<h?a:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>o.x)&&wQ(n,e)&&(o=n,_=c),n=n.next;return o}(e,t)){var n=RQ(t,e);hQ(n,n.next)}}function yQ(e,t,n,i){var r=e;do{null===r.z&&(r.z=xQ(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,a=null,o=0,s=0,c=0,l=1;do{for(n=e,e=null,a=null,o=0;n;){for(o++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;n=i}a.nextZ=null,l*=2}while(o>1)}(r)}function xQ(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function SQ(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function TQ(e,t,n,i,r,a,o,s){return(r-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(i-s)-(n-o)*(t-s)>=0&&(n-o)*(a-s)-(r-o)*(i-s)>=0}function EQ(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&bQ(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&wQ(e,t)&&wQ(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;do{n.y>a!=n.next.y>a&&r<(n.next.x-n.x)*(a-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function CQ(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function AQ(e,t){return e.x===t.x&&e.y===t.y}function bQ(e,t,n,i){return!!(AQ(e,t)&&AQ(n,i)||AQ(e,i)&&AQ(n,t))||CQ(e,t,n)>0!=CQ(e,t,i)>0&&CQ(n,i,e)>0!=CQ(n,i,t)>0}function wQ(e,t){return CQ(e.prev,e,e.next)<0?CQ(e,t,e.next)>=0&&CQ(e,e.prev,t)>=0:CQ(e,t,e.prev)<0||CQ(e,e.next,t)<0}function RQ(e,t){var n=new lQ(e.i,e.x,e.y),i=new lQ(t.i,t.x,t.y),r=e.next,a=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,a.next=i,i.prev=a,i}function PQ(e,t,n,i){var r=new lQ(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function IQ(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function DQ(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,a=uQ(e,0,r,n,!0),o=[];if(!a)return o;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(a=function(e,t,n,i){var r,a=[],o=0,s=null;for(o=0,r=t.length;o<r;o++)(s=uQ(e,t[o]*i,o<r-1?t[o+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),a.push(SQ(s)));if(a.sort(vQ),!n)return n;for(o=0;o<a.length;o++)gQ(a[o],n),n=hQ(n,n.next);return n}(e,t,a,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var d=n;d<r;d+=n)(h=e[d])<s&&(s=h),(_=e[d+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return _Q(a,o,n,s,c,f),o}for(var OQ=Math.PI,NQ=Math.min,MQ=Math.max,kQ=Math.ceil,LQ=Math.acos,BQ=Math.cos,FQ=Math.sin,zQ=Math.atan2,UQ=null,GQ=null,HQ=new Bn,VQ=[],jQ=0;jQ<4;jQ++)VQ.push(new zn);function WQ(e,t,n){return e<t?t:e>n?n:e}var qQ={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!GQ)return null;var n=GQ.getRenderDataList(),i=n[GQ.dataOffset];if(!i)return null;var r=i,a=r?r.vertexStart+t:0;return(a>65535||3*a>131070)&&(++GQ.dataOffset,GQ.dataOffset<n.length?i=n[GQ.dataOffset]:(i=GQ.requestRenderData(),n[GQ.dataOffset]=i),r=i),r&&r.vertexCount<a&&r.request(t,3*t),i},stroke:function(e){Bn.copy(HQ,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){Bn.copy(HQ,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t,n,i,r,a=.5*e.lineWidth,o=e.lineCap,s=e.lineJoin,c=e.miterLimit;if(GQ=e.impl){var l=(t=a,n=OQ,i=GQ.tessTol,r=2*LQ(t/(t+i)),MQ(2,kQ(n/r)));this._calculateJoins(GQ,a,s,c);for(var u=GQ.paths,h=0,_=GQ.pathOffset,f=GQ.pathLength;_<f;_++){var d=u[_],p=d.points.length;s===zW.ROUND?h+=2*(p+d.bevel*(l+2)+1):h+=2*(p+5*d.bevel+1),d.closed||(o===FW.ROUND?h+=2*(2*l+2):h+=12)}var m=UQ=this.getRenderData(e,h);if(m){for(var v=m.vData,g=m.iData,y=GQ.pathOffset,x=GQ.pathLength;y<x;y++){var S=u[y],T=S.points,E=T.length,C=m.vertexStart,A=void 0,b=void 0,w=0,R=0,P=S.closed;if(P?(A=T[E-1],b=T[0],w=0,R=E):(A=T[0],b=T[1],w=1,R=E-1),b=b||A,!P){var I=new Xq(b.x,b.y);I.subtract(A),I.normalize();var D=I.x,O=I.y;o===FW.BUTT?this._buttCapStart(A,D,O,a,0):o===FW.SQUARE?this._buttCapStart(A,D,O,a,a):o===FW.ROUND&&this._roundCapStart(A,D,O,a,l)}for(var N=w;N<R;++N)s===zW.ROUND?this._roundJoin(A,b,a,a,l):0!=(b.flags&(UW.PT_BEVEL|UW.PT_INNERBEVEL))?this._bevelJoin(A,b,a,a):(this._vSet(b.x+b.dmx*a,b.y+b.dmy*a,1),this._vSet(b.x-b.dmx*a,b.y-b.dmy*a,-1)),A=b,b=T[N+1];if(P){var M=8*C;this._vSet(v[M],v[M+1],1),this._vSet(v[M+8],v[M+8+1],-1)}else{var k=new Xq(b.x,b.y);k.subtract(A),k.normalize();var L=k.x,B=k.y;o===FW.BUTT?this._buttCapEnd(b,L,B,a,0):o===FW.SQUARE?this._buttCapEnd(b,L,B,a,a):o===FW.ROUND&&this._roundCapEnd(b,L,B,a,l)}for(var F=m.indexStart,z=C+2,U=m.vertexStart;z<U;z++)g[F++]=z-2,g[F++]=z-1,g[F++]=z;m.indexStart=F}UQ=null,GQ=null}}},_expandFill:function(e){if(GQ=e.impl){for(var t=GQ.paths,n=0,i=GQ.pathOffset,r=GQ.pathLength;i<r;i++)n+=t[i].points.length;var a=UQ=this.getRenderData(e,n);if(a){for(var o=a,s=o.vData,c=o.iData,l=GQ.pathOffset,u=GQ.pathLength;l<u;l++){var h=t[l],_=h.points,f=_.length;if(0!==f){for(var d=a.vertexStart,p=0;p<f;++p)this._vSet(_[p].x,_[p].y);var m=a.indexStart;if(h.complex){for(var v=[],g=d,y=a.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=DQ(v,null,3);if(!S||0===S.length)continue;for(var T=0,E=S.length;T<E;T++)c[m++]=S[T]+d}else for(var C=d,A=d+2,b=o.vertexStart;A<b;A++)c[m++]=C,c[m++]=A-1,c[m++]=A;o.indexStart=m}}UQ=null,GQ=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var a=e.paths,o=e.pathOffset,s=e.pathLength;o<s;o++){var c=a[o],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var d,p,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(d=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/d;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=UW.PT_LEFT),d*(p=MQ(11,NQ(h.len,_.len)*r))*p<1&&(_.flags|=UW.PT_INNERBEVEL),_.flags&UW.PT_CORNER&&(d*i*i<1||n===zW.BEVEL||n===zW.ROUND)&&(_.flags|=UW.PT_BEVEL),0!=(_.flags&(UW.PT_BEVEL|UW.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],a=r.points,o=a[a.length-1],s=a[0];a.length>2&&o.equals(s)&&(r.closed=!0,a.pop(),o=a[a.length-1]);for(var c=0,l=a.length;c<l;c++){var u=new Xq(s.x,s.y);u.subtract(o),o.len=u.length(),(u.x||u.y)&&u.normalize(),o.dx=u.x,o.dy=u.y,o=s,s=a[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,a=n.y,o=0,s=0,c=0,l=0;return 0!==e?(o=r+t.dy*i,s=a-t.dx*i,c=r+n.dy*i,l=a-n.dx*i):(o=c=r+n.dmx*i,s=l=a+n.dmy*i),[o,s,c,l]},_buttCapStart:function(e,t,n,i,r){var a=e.x-t*r,o=e.y-n*r,s=n,c=-t;this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var a=e.x+t*r,o=e.y+n*r,s=n,c=-t;this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var a=e.x,o=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*OQ,h=BQ(u)*i,_=FQ(u)*i;this._vSet(a-s*h-t*_,o-c*h-n*_,1),this._vSet(a,o,0)}this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var a=e.x,o=e.y,s=n,c=-t;this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*OQ,h=BQ(u)*i,_=FQ(u)*i;this._vSet(a,o,0),this._vSet(a-s*h+t*_,o-c*h+n*_,1)}},_roundJoin:function(e,t,n,i,r){var a=e.dy,o=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&UW.PT_LEFT)){var h=this._chooseBevel(t.flags&UW.PT_INNERBEVEL,e,t,n),_=h[0],f=h[1],d=h[2],p=h[3],m=zQ(-o,-a),v=zQ(-c,-s);v>m&&(v-=2*OQ),this._vSet(_,f,1),this._vSet(l-a*i,t.y-o*i,-1);for(var g=WQ(kQ((m-v)/OQ)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+BQ(x)*i,T=u+FQ(x)*i;this._vSet(l,u,0),this._vSet(S,T,-1)}this._vSet(d,p,1),this._vSet(l-s*i,u-c*i,-1)}else{var E=this._chooseBevel(t.flags&UW.PT_INNERBEVEL,e,t,-i),C=E[0],A=E[1],b=E[2],w=E[3],R=zQ(o,a),P=zQ(c,s);P<R&&(P+=2*OQ),this._vSet(l+a*i,u+o*i,1),this._vSet(C,A,-1);for(var I=WQ(kQ((P-R)/OQ)*r,2,r),D=0;D<I;D++){var O=R+D/(I-1)*(P-R),N=l+BQ(O)*n,M=u+FQ(O)*n;this._vSet(N,M,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(b,w,-1)}},_bevelJoin:function(e,t,n,i){var r=0,a=0,o=0,s=0,c=0,l=0,u=0,h=0,_=e.dy,f=-e.dx,d=t.dy,p=-t.dx;if(t.flags&UW.PT_LEFT){var m=this._chooseBevel(t.flags&UW.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-_*i,t.y-f*i,-1),this._vSet(u,h,1),this._vSet(t.x-d*i,t.y-p*i,-1)}else{var v=this._chooseBevel(t.flags&UW.PT_INNERBEVEL,e,t,-i);r=v[0],a=v[1],o=v[2],s=v[3],this._vSet(t.x+_*n,t.y+f*n,1),this._vSet(r,a,-1),this._vSet(t.x+d*n,t.y+p*n,1),this._vSet(o,s,-1)}},_vSet:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(UQ){var i=UQ,r=8*i.vertexStart,a=i.vData;a[r++]=e,a[r++]=t,a[r++]=0,Bn.toArray(a,HQ,r),r+=4,a[r++]=n,i.vertexStart++}}},XQ=e("graphicsAssembler",{getAssembler:function(){return qQ}});$q.Assembler=XQ;var YQ=function e(){K(this,e),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},KQ=new fi,QQ=null,ZQ=null,JQ=[],$Q=[],eZ=[],tZ=[],nZ=new hi,iZ=new hi,rZ=new ri,aZ=null,oZ=0,sZ=0,cZ=0,lZ=0,uZ=0,hZ=1,_Z=null,fZ="",dZ=0,pZ=0,mZ=0,vZ=0,gZ=0,yZ=0,xZ=0,SZ=!1,TZ=0,EZ=0,CZ=0,AZ={updateRenderData:function(e){e.renderData&&QQ!==e&&(e.renderData.vertDirty&&(ZQ=(QQ=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),QQ.actualFontSize=dZ,ZQ.setContentSize(iZ),this.updateUVs(e),QQ.renderData.vertDirty=!1,QQ.markForUpdateRenderData(!1),QQ=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.vertexCount,r=t.data,a=3,o=0;o<i;o++){var s=r[o];n[a]=s.u,n[a+1]=s.v,a+=9}},_updateFontScale:function(){hZ=dZ/pZ},_updateFontFamily:function(e){var t=e.font;_Z=t.spriteFrame,aZ=t.fntConfig,uV.fontAtlas=t.fontDefDictionary,fH.packToDynamicAtlas(e,_Z)},_updateLabelInfo:function(){uV.hash="",uV.margin=0},_updateProperties:function(e){fZ=e.string.toString(),dZ=e.fontSize,pZ=aZ?aZ.fontSize:e.fontSize,mZ=e.horizontalAlign,vZ=e.verticalAlign,gZ=e.spacingX,xZ=e.overflow,yZ=e._lineHeight;var t=ZQ.contentSize;iZ.width=t.width,iZ.height=t.height,xZ===RW.NONE?(SZ=!1,iZ.width+=2*uV.margin,iZ.height+=2*uV.margin):xZ===RW.RESIZE_HEIGHT?(SZ=!0,iZ.height+=2*uV.margin):SZ=e.enableWrapText,uV.lineHeight=yZ,uV.fontSize=dZ,this._setupBMFontOverflowMetrics()},_resetProperties:function(){aZ=null,_Z=null,uV.hash="",uV.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=fZ,t=e.length,n=aZ.kerningDict,i=JQ,r=-1,a=0;a<t;++a){var o=e.charCodeAt(a),s=n[r<<16|65535&o]||0;i[a]=a<t-1?s:0,r=o}},_multilineTextWrap:function(e){for(var t=fZ.length,n=0,i=0,r=0,a=0,o=0,s=0,c=0,l=null,u=0;u<t;){var h=fZ.charAt(u);if("\n"!==h){for(var _=e(fZ,u,t),f=s,d=c,p=o,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=fZ.charAt(y)))if(l=uV.fontAtlas.getLetterDefinitionForChar(h,uV)){var x=m+l.offsetX*hZ-uV.margin;if(SZ&&CZ>0&&i>0&&x+l.w*hZ>CZ&&!$H(h)){eZ.push(o),o=0,n++,i=0,r-=yZ*this._getFontScale()+0,v=!0;break}rZ.x=x,rZ.y=r-l.offsetY*hZ,this._recordLetterInfo(rZ,h,y,n),y+1<JQ.length&&y<t-1&&(m+=JQ[y+1]),m+=l.xAdvance*hZ+gZ,p=rZ.x+l.w*hZ,f<rZ.y&&(f=rZ.y),d>rZ.y-l.h*hZ&&(d=rZ.y-l.h*hZ)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas ".concat(aZ.atlasName," for letter:").concat(h));else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>d&&(c=d),a<(o=p)&&(a=o),u+=_)}else eZ.push(o),o=0,n++,i=0,r-=yZ*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return eZ.push(o),sZ=(oZ=n+1)*yZ*this._getFontScale(),oZ>1&&(sZ+=0*(oZ-1)),iZ.width=TZ,iZ.height=EZ,TZ<=0&&(iZ.width=parseFloat(a.toFixed(2))+2*uV.margin),EZ<=0&&(iZ.height=parseFloat(sZ.toFixed(2))+2*uV.margin),lZ=iZ.height,uZ=0,s>0&&(lZ=iZ.height+s),c<-sZ&&(uZ=sZ+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return xZ===RW.SHRINK?hZ:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(JH(i)||"\n"===i||$H(i))return 1;var r=1,a=uV.fontAtlas.getLetterDefinitionForChar(i,uV);if(!a)return r;for(var o=a.xAdvance*hZ+gZ,s=t+1;s<n&&(i=e.charAt(s),a=uV.fontAtlas.getLetterDefinitionForChar(i,uV));++s){if(o+a.offsetX*hZ+a.w*hZ>CZ&&!$H(i)&&CZ>0)return r;if(o+=a.xAdvance*hZ+gZ,"\n"===i||$H(i)||JH(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=$Q.length){var n=new YQ;$Q.push(n)}$Q[e].char=t,$Q[e].hash="".concat(t.charCodeAt(0)).concat(uV.hash),$Q[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=$Q.length){var r=new YQ;$Q.push(r)}var a=t.charCodeAt(0),o="".concat(a).concat(uV.hash);$Q[n].line=i,$Q[n].char=t,$Q[n].hash=o,$Q[n].valid=uV.fontAtlas.getLetter(o).valid,$Q[n].x=e.x,$Q[n].y=e.y},_alignText:function(){sZ=0,eZ.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),xZ===RW.SHRINK&&dZ>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||xZ===RW.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),dZ=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|dZ,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;hZ=r/pZ,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return sZ>iZ.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=fZ.length;t<n;++t){var i=$Q[t];if(i.valid){var r=uV.fontAtlas.getLetterDefinitionForChar(i.char,uV);if(!r)continue;var a=i.x+r.w*hZ,o=i.line;if(TZ>0)if(SZ){if(eZ[o]>iZ.width&&(a>iZ.width||a<0)){e=!0;break}}else if(a>iZ.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=eZ[t],i=e>iZ.width||e<0;return SZ?n>iZ.width&&i:i},_updateQuads:function(){if(!QQ)return!1;var e=_Z?_Z.texture:uV.fontAtlas.getTexture(),t=QQ.renderData;t.dataLength=0,t.resize(0,0);for(var n=ZQ.anchorPoint,i=iZ,r=n.x*i.width,a=n.y*i.height,o=!0,s=0,c=fZ.length;s<c;++s){var l=$Q[s];if(l.valid){var u=uV.fontAtlas.getLetter(l.hash);if(u){KQ.height=u.h,KQ.width=u.w,KQ.x=u.u,KQ.y=u.v;var h=l.y+cZ;if(EZ>0){if(h>lZ){var _=h-lZ;KQ.y+=_,KQ.height-=_,h-=_}h-u.h*hZ<uZ&&xZ===RW.CLAMP&&(KQ.height=h<uZ?0:(h-uZ)/hZ)}var f=l.line,d=l.x+u.w/2*hZ+tZ[f];if(TZ>0&&this._isHorizontalClamped(d,f))if(xZ===RW.CLAMP)KQ.width=0;else if(xZ===RW.SHRINK){if(iZ.width>u.w){o=!1;break}KQ.width=0}if(KQ.height>0&&KQ.width>0){var p=this._determineRect(),m=l.x+tZ[l.line];this.appendQuad(QQ,e,KQ,p,m-r,h-a,hZ)}}else console.warn("Can't find letter in this bitmap-font")}}return o},appendQuad:function(){},_determineRect:function(){var e=_Z.isRotated(),t=_Z.getOriginalSize(),n=_Z.getRect(),i=_Z.getOffset(),r=i.x+(t.width-n.width)/2,a=i.y-(t.height-n.height)/2;if(e){var o=KQ.x;KQ.x=n.x+n.height-KQ.y-KQ.height-a,KQ.y=o+n.y-r,KQ.y<0&&(KQ.height+=a)}else KQ.x+=n.x-r,KQ.y+=n.y+a;return e},_computeAlignmentOffset:function(){switch(tZ.length=0,mZ){case bW.LEFT:for(var e=0;e<oZ;++e)tZ.push(0);break;case bW.CENTER:for(var t=0,n=eZ.length;t<n;t++)tZ.push((iZ.width-eZ[t])/2);break;case bW.RIGHT:for(var i=0,r=eZ.length;i<r;i++)tZ.push(iZ.width-eZ[i])}if(cZ=iZ.height,vZ!==wW.TOP){var a=iZ.height-sZ+yZ*this._getFontScale()-pZ*hZ;vZ===wW.BOTTOM?cZ-=a:cZ-=a/2}},_setupBMFontOverflowMetrics:function(){var e=iZ.width,t=iZ.height;xZ===RW.RESIZE_HEIGHT&&(t=0),xZ===RW.NONE&&(e=0,t=0),TZ=e,EZ=t,nZ.width=e,nZ.height=t,CZ=e}},bZ=new Bn(255,255,255,255),wZ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t=e.node;bZ.set(e.color),bZ.a=255*t._uiProps.opacity,aH(t,0,e.renderData,bZ)},appendQuad:function(e,t,n,i,r,a,o){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=t.width,h=t.height,_=n.width,f=n.height,d=0,p=0,m=0,v=0;i?(d=n.x/u,v=(n.x+f)/u,p=(n.y+_)/h,m=n.y/h,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=p,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=p):(d=n.x/u,v=(n.x+_)/u,p=(n.y+f)/h,m=n.y/h,l[c].u=d,l[c].v=p,l[c+1].u=v,l[c+1].v=p,l[c+2].u=d,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=a-f*o,l[c+1].x=r+_*o,l[c+1].y=a-f*o,l[c+2].x=r,l[c+2].y=a,l[c+3].x=r+_*o,l[c+3].y=a}},updateColor:function(){}};Ke(wZ,AZ);var RZ=null,PZ=Qe(AZ,{getAssemblerData:function(){return RZ||(RZ=new lV(1024,1024)),RZ.getTexture()},_updateFontFamily:function(e){uV.fontAtlas=RZ,uV.fontFamily=this._getFontFamily(e);var t=e.getComponent(vY);t&&t.enabled?(uV.isOutlined=!0,uV.margin=t.width,uV.out=t.color.clone(),uV.out.a=t.color.a*e.color.a/255):(uV.isOutlined=!1,uV.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){uV.fontDesc=this._getFontDesc(),uV.color=e.color,uV.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(uV)},_getFontDesc:function(){return"".concat(uV.fontSize.toString(),"px ")+uV.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),IZ=new Bn(255,255,255,255),DZ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){if(e.renderData){var t=e.node;IZ.a=255*t._uiProps.opacity,aH(t,0,e.renderData,IZ)}},updateColor:function(){},appendQuad:wZ.appendQuad};Ke(DZ,PZ);var OZ=DW.Overflow,NZ=(1/255).toFixed(3),MZ=null,kZ=null,LZ=null,BZ="",FZ="",zZ=0,UZ=0,GZ=[],HZ=new hi,VZ=0,jZ=0,WZ=0,qZ=new Bn,XZ="",YZ=OZ.NONE,KZ=!1,QZ=null,ZZ=Bn.BLACK.clone(),JZ=null,$Z=Bn.BLACK.clone(),eJ=new fi,tJ=hi.ZERO.clone(),nJ=hi.ZERO.clone(),iJ=ri.ZERO.clone(),rJ=ri.ZERO.clone(),aJ=0,oJ=0,sJ=!1,cJ=!1,lJ=!1,uJ=["left","center","right"],hJ={getAssemblerData:function(){return DW._canvasPool.get()},resetAssemblerData:function(e){e&&DW._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=zZ,t.setContentSize(HZ),this.updateVertexData(e),this.updateUVs(e),e.markForUpdateRenderData(!1),MZ=null,kZ=null,LZ=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){XZ=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(MZ=n.context,kZ=n.canvas,LZ=e.spriteFrame,FZ=e.string.toString(),zZ=e.fontSize,UZ=zZ,YZ=e.overflow,nJ.width=HZ.width=t.width,nJ.height=HZ.height=t.height,oJ=e.underlineHeight,VZ=e.lineHeight,jZ=e.horizontalAlign,WZ=e.verticalAlign,qZ=e.color,e.node._uiProps.opacity,sJ=e.isBold,cJ=e.isItalic,lJ=e.isUnderline,KZ=YZ!==OZ.NONE&&(YZ===OZ.RESIZE_HEIGHT||e.enableWrapText),(QZ=(QZ=vY&&e.getComponent(vY))&&QZ.enabled&&QZ.width>0?QZ:null)&&ZZ.set(QZ.color),(JZ=(JZ=sQ&&e.getComponent(sQ))&&JZ.enabled?JZ:null)&&$Z.set(JZ.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(tJ.width=tJ.height=0,QZ&&(e=t=n=i=r=QZ.width,tJ.width=tJ.height=2*r),JZ){var a=JZ.blur+r,o=JZ.offset.x,s=JZ.offset.y;n=Math.max(n,-o+a),i=Math.max(i,o+a),e=Math.max(e,s+a),t=Math.max(t,-s+a)}if(cJ){var c=UZ*Math.tan(.20943951);i+=c,tJ.width+=c}eJ.x=n,eJ.y=e,eJ.width=n+i,eJ.height=e+t},_calculateFillTextStartPosition:function(){var e=0;jZ===bW.RIGHT?e=HZ.width-eJ.width:jZ===bW.CENTER&&(e=(HZ.width-eJ.width)/2);var t=this._getLineHeight()*(GZ.length-1),n=zZ*(1-HH/2);if(WZ!==wW.TOP){var i=t+eJ.height+zZ-HZ.height;WZ===wW.BOTTOM?n-=i+=HH/2*zZ:n-=i/2}n+=0*zZ,iJ.set(e+eJ.x,n+eJ.y)},_updateTexture:function(e){if(MZ&&kZ){MZ.clearRect(0,0,kZ.width,kZ.height),MZ.font=BZ,this._calculateFillTextStartPosition();var t=this._getLineHeight();MZ.lineJoin="round",QZ?(MZ.fillStyle="rgba(".concat(ZZ.r,", ").concat(ZZ.g,", ").concat(ZZ.b,", ").concat(NZ,")"),MZ.fillRect(0,0,kZ.width,kZ.height)):e._srcBlendFactor===zi.SRC_ALPHA&&(MZ.fillStyle="rgba(".concat(qZ.r,", ").concat(qZ.g,", ").concat(qZ.b,", ").concat(NZ,")"),MZ.fillRect(0,0,kZ.width,kZ.height)),MZ.fillStyle="rgb(".concat(qZ.r,", ").concat(qZ.g,", ").concat(qZ.b,")");var n=iJ.x,i=0;this._drawTextEffect(iJ,t);for(var r=0;r<GZ.length;++r)i=iJ.y+r*t,QZ&&MZ.strokeText(GZ[r],n,i),MZ.fillText(GZ[r],n,i);JZ&&(MZ.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===DW.CacheMode.BITMAP){var t=e.ttfSpriteFrame;fH.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;LZ&&kZ&&(n=LZ instanceof yH?LZ.texture:LZ,0!==kZ.width&&0!==kZ.height&&(n.reset({width:kZ.width,height:kZ.height,mipmapLevel:1}),n.uploadData(kZ),LZ instanceof yH&&(LZ.rect=new fi(0,0,kZ.width,kZ.height),LZ._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),c.director.root&&c.director.root.batcher2D&&c.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(!(e.cacheMode!==DW.CacheMode.BITMAP||!kZ||kZ.width<=0||kZ.height<=0)){var t=e.ttfSpriteFrame;fH.packToDynamicAtlas(e,t)}},_setupOutline:function(){MZ.strokeStyle="rgba(".concat(ZZ.r,", ").concat(ZZ.g,", ").concat(ZZ.b,", ").concat(ZZ.a/255,")"),MZ.lineWidth=2*QZ.width},_setupShadow:function(){MZ.shadowColor="rgba(".concat($Z.r,", ").concat($Z.g,", ").concat($Z.b,", ").concat($Z.a/255,")"),MZ.shadowBlur=JZ.blur,MZ.shadowOffsetX=JZ.offset.x,MZ.shadowOffsetY=-JZ.offset.y},_drawTextEffect:function(e,t){if(JZ||QZ||lJ){var n=GZ.length>1&&JZ,i=this._measureText(MZ,BZ),r=0,a=0;JZ&&this._setupShadow(),QZ&&this._setupOutline();for(var o=0;o<GZ.length;++o)r=e.x,a=e.y+o*t,n&&(QZ&&MZ.strokeText(GZ[o],r,a),MZ.fillText(GZ[o],r,a)),lJ&&(aJ=i(GZ[o]),jZ===bW.RIGHT?rJ.x=e.x-aJ:jZ===bW.CENTER?rJ.x=e.x-aJ/2:rJ.x=e.x,rJ.y=a+UZ/8,MZ.fillRect(rJ.x,rJ.y,aJ,oJ));n&&(MZ.shadowColor="transparent")}},_updateLabelDimensions:function(){HZ.width=Math.min(HZ.width,2048),HZ.height=Math.min(HZ.height,2048);var e=!1;kZ.width!==HZ.width&&(kZ.width=HZ.width,e=!0),kZ.height!==HZ.height&&(kZ.height=HZ.height,e=!0),e&&(MZ.font=BZ),MZ.textAlign=uJ[jZ],MZ.textBaseline="alphabetic"},_getFontDesc:function(){var e="".concat(zZ.toString(),"px ");return e+=XZ,sJ&&(e="bold ".concat(e)),cJ&&(e="italic ".concat(e)),e},_getLineHeight:function(){return 0|(0===VZ?zZ:VZ*zZ/UZ)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=ge(e);!(n=r()).done;){var a=eV(t,n.value,BZ);i.push(a)}return i},_measureText:function(e,t){return function(n){return eV(e,n,t)}},_calculateShrinkFont:function(e){if(MZ){var t=this._calculateParagraphLength(e,MZ),n=0,i=0,r=0;if(KZ){var a=nJ.width,o=nJ.height;if(a<0||o<0)return;i=o+1;for(var s=0,c=0|zZ+1,l=0;s<c;){if((l=s+c+1>>1)<=0){w(4003);break}zZ=l,BZ=this._getFontDesc(),MZ.font=BZ;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=eV(MZ,e[n],BZ);i+=nV(e[n],h,a,this._measureText(MZ,BZ)).length*u}i>o?c=l-1:s=l}0===s?w(4003):(zZ=s,BZ=this._getFontDesc(),MZ.font=BZ)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var _=(HZ.width-eJ.width)/r,f=HZ.height/i;zZ=UZ*Math.min(1,_,f)|0,BZ=this._getFontDesc(),MZ.font=BZ}}},_calculateWrapText:function(e){if(KZ&&MZ){GZ=[];for(var t=nJ.width,n=0;n<e.length;++n){var i=eV(MZ,e[n],BZ),r=nV(e[n],i,t,this._measureText(MZ,BZ));GZ=GZ.concat(r)}}},_calculateLabelFont:function(){if(MZ){var e=FZ.split("\n");switch(GZ=e,BZ=this._getFontDesc(),MZ.font=BZ,YZ){case OZ.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=eV(MZ,e[i],BZ);t=t>r?t:r}n=(GZ.length+HH)*this._getLineHeight();var a=parseFloat(t.toFixed(2)),o=parseFloat(n.toFixed(2));HZ.width=a+eJ.width,HZ.height=o+eJ.height,nJ.width=a+tJ.width,nJ.height=o+tJ.height;break;case OZ.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case OZ.CLAMP:this._calculateWrapText(e);break;case OZ.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(GZ.length+HH)*this._getLineHeight();HZ.height=s+eJ.height,nJ.height=s+tJ.height}}}},_J=Bn.WHITE.clone(),fJ={createData:function(e){var t=e.requestRenderData();t.dataLength=2,t.resize(4,6);var n=t.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)Bn.toArray(n,_J,i),i+=9;return t},fillBuffers:function(e){var t=e.renderData.chunk,n=e.renderData.data,i=e.node,r=t.vb,a=n[0],o=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=a.x*l.x,h=o.x*l.x,_=a.y*l.y,f=o.y*l.y,d=c.x,p=c.y,m=c.z,v=c.w,g=d*p,y=m*v,x=d*d-p*p,S=v*v-m*m,T=S+x,E=2*(g-y),C=S-x,A=2*(g+y),b=s.x,w=s.y;r[0]=T*u+E*_+b,r[1]=C*_+A*u+w,r[9]=T*h+E*_+b,r[10]=C*_+A*h+w,r[18]=T*u+E*f+b,r[19]=C*f+A*u+w,r[27]=T*h+E*f+b,r[28]=C*f+A*h+w;var R=t.bufferId,P=t.vertexOffset,I=t.vertexAccessor.getMeshBuffer(t.bufferId),D=t.vertexAccessor.getIndexBuffer(R),O=I.indexOffset;D[O++]=P,D[O++]=P+1,D[O++]=P+2,D[O++]=P+2,D[O++]=P+1,D[O++]=P+3,I.indexOffset+=6},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,a=n.anchorX*i,o=n.anchorY*r,s=t.data;s[0].x=-a,s[0].y=-o,s[1].x=i-a,s[1].y=r-o}},updateUVs:function(e){var t=e.renderData;if(t&&e.ttfSpriteFrame){var n=t.chunk.vb,i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Ke(fJ,hJ);var dJ=e("labelAssembler",{getAssembler:function(e){var t=fJ;return e.font instanceof UH?t=wZ:e.cacheMode===DW.CacheMode.CHAR&&(t=DZ),t}});DW.Assembler=dJ;var pJ=yY.FillType,mJ=new ei,vJ=new zn,gJ={updateRenderData:function(e){var t=e.spriteFrame;fH.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.updateRenderData(e,t),!n.vertDirty)return;var i=e.fillStart,r=e.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var a=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);a=a>1?1:a,this.updateUVs(e,i,a),this.updateVertexData(e,i,a)}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData.chunk.vb,a=i.width,o=i.height,s=i.rect,c=0,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0;switch(i.isRotated()?(c=s.x/a,l=(s.y+s.width)/o,u=_=c,d=m=(s.x+s.height)/a,f=v=l,h=p=s.y/o):(c=s.x/a,l=(s.y+s.height)/o,u=d=c,_=m=(s.x+s.width)/a,h=f=l,p=v=s.y/o),e.fillType){case pJ.HORIZONTAL:r[3]=u+(_-u)*t,r[4]=h+(f-h)*t,r[12]=u+(_-u)*n,r[13]=h+(f-h)*n,r[21]=d+(m-d)*t,r[22]=p+(v-p)*t,r[30]=d+(m-d)*n,r[31]=p+(v-p)*n;break;case pJ.VERTICAL:r[3]=u+(d-u)*t,r[4]=h+(p-h)*t,r[12]=_+(m-_)*t,r[13]=f+(v-f)*t,r[21]=u+(d-u)*n,r[22]=h+(p-h)*n,r[30]=_+(m-_)*n,r[31]=f+(v-f)*n;break;default:D(2626)}},updateVertexData:function(e,t,n){var i=e.renderData.data,r=e.node._uiProps.uiTransformComp,a=r.width,o=r.height,s=r.anchorX*a,c=r.anchorY*o,l=-s,u=-c,h=a-s,_=o-c,f=0;switch(e.fillType){case pJ.HORIZONTAL:f=l+(h-l)*n,l+=(h-l)*t,h=f;break;case pJ.VERTICAL:f=u+(_-u)*n,u+=(_-u)*t,_=f;break;default:D(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=_,i[3].x=h,i[3].y=_},createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6);for(var n,i=ge(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(mJ);for(var n=e.renderData.floatStride,i=e.renderData.data,r=t.vb,a=0,o=0;o<4;o++){var s=i[o];zn.transformMat4(vJ,s,mJ),r[a=o*n]=vJ.x,r[a+1]=vJ.y,r[a+2]=vJ.z}},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(n.bufferId),o=n.vertexAccessor.getIndexBuffer(i),s=a.indexOffset;o[s++]=r,o[s++]=r+1,o[s++]=r+2,o[s++]=r+2,o[s++]=r+1,o[s++]=r+3,a.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,a=e.color,o=a.r/255,s=a.g/255,c=a.b/255,l=e.node._uiProps.opacity,u=0;u<4;u++)n[r]=o,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},yJ=2*Math.PI,xJ=1e-6,SJ=new ei,TJ=new zn,EJ=[new ri,new ri,new ri,new ri],CJ=new Array(4),AJ=new Array(8),bJ=[new ri,new ri,new ri,new ri],wJ=[new ri,new ri,new ri,new ri],RJ=new ri,PJ=[new ri,new ri,new ri,new ri];function IJ(e,t,n,i,r,a,o){var s=Math.sin(a);s=Math.abs(s)>xJ?s:0;var c=Math.cos(a),l=0,u=0;if(0!==(c=Math.abs(c)>xJ?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);o[0].x=e,o[0].y=h}if((t-r.x)*c>0){var _=r.y+l*(t-r.x);o[2].x=t,o[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);o[3].x=f,o[3].y=i}if((n-r.y)*s>0){var d=r.x+u*(n-r.y);o[1].x=d,o[1].y=n}}}function DJ(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function OJ(e,t,n,i,r){var a=CJ,o=a[0],s=a[1],c=a[2],l=a[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,NJ((n.x-o)/(c-o),(n.y-s)/(l-s),e,t),NJ((i.x-o)/(c-o),(i.y-s)/(l-s),e,t+1),NJ((r.x-o)/(c-o),(r.y-s)/(l-s),e,t+2)}function NJ(e,t,n,i){var r=AJ,a=r[0]+(r[2]-r[0])*e,o=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=a+(o-a)*t,l.v=s+(c-s)*t}for(var MJ={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;fH.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;if(n&&t){if(!n.vertDirty)return;var i=n.data,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);r>=1;)r-=1;for(;r<0;)r+=1;var o=(r*=yJ)+(a*=yJ);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,a=t.anchorY*i,o=-r,s=-a,c=n-r,l=i-a,u=CJ;u[0]=o,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,_=RJ.x=Math.min(Math.max(0,h.x),1)*(c-o)+o,f=RJ.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;EJ[0].x=EJ[3].x=o,EJ[1].x=EJ[2].x=c,EJ[0].y=EJ[1].y=s,EJ[2].y=EJ[3].y=l;for(var d,p=ge(PJ);!(d=p()).done;){var m=d.value;ri.set(m,0,0)}_!==u[0]&&ri.set(PJ[0],3,0),_!==u[2]&&ri.set(PJ[2],1,2),f!==u[1]&&ri.set(PJ[1],0,1),f!==u[3]&&ri.set(PJ[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,a=0,o=0,s=0,c=AJ;e.isRotated()?(r=i.x/t,a=(i.x+i.height)/t,o=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=a,c[3]=c[7]=s,c[1]=c[5]=o):(r=i.x/t,a=(i.x+i.width)/t,o=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=a,c[1]=c[3]=s,c[5]=c[7]=o)}(t),IJ(CJ[0],CJ[2],CJ[1],CJ[3],RJ,r,bJ),IJ(CJ[0],CJ[2],CJ[1],CJ[3],RJ,r+a,wJ);for(var s=0,c=0;c<4;++c){var l=PJ[c];if(l)if(a>=yJ)n.dataLength=s+3,OJ(i,s,RJ,EJ[l.x],EJ[l.y]),s+=3;else{var u=DJ(RJ,EJ[l.x]),h=DJ(RJ,EJ[l.y]);h<u&&(h+=yJ),u-=yJ,h-=yJ;for(var _=0;_<3;++_)u>=o||(u>=r?(n.dataLength=s+3,OJ(i,s,RJ,EJ[l.x],h>=o?wJ[c]:EJ[l.y]),s+=3):h>r&&(h<=o?(n.dataLength=s+3,OJ(i,s,RJ,bJ[c],EJ[l.y]),s+=3):(n.dataLength=s+3,OJ(i,s,RJ,bJ[c],wJ[c]),s+=3))),u+=yJ,h+=yJ}}n.resize(s,s),n.updateRenderData(e,t)}},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,a=i.vertexOffset,o=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=o.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=a+l;o.indexOffset+=n.indexCount,o.setDirty()},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(SJ);for(var n=e.renderData,i=n.floatStride,r=e.renderData.data,a=t.vb,o=n.vertexCount,s=0,c=0;c<o;c++){var l=r[c];zn.set(TJ,l.x,l.y,0),zn.transformMat4(TJ,TJ,SJ),a[s+0]=TJ.x,a[s+1]=TJ.y,a[s+2]=TJ.z,a[s+3]=l.u,a[s+4]=l.v,s+=i}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,a=5,o=e.color,s=o.r/255,c=o.g/255,l=o.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[a]=s,n[a+1]=c,n[a+2]=l,n[a+3]=u,a+=i},updateColor:function(){}},kJ=[],LJ=0;LJ<4;LJ++)kJ.push(new zn);for(var BJ={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){var t=e.spriteFrame;fH.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData,i=t.vb,r=n.data,a=e.node,o=r[0],s=r[1],c=a.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,d=c.m12,p=c.m13,m=o.x,v=s.x,g=o.y,y=s.y;if(f){var x=m+d,S=v+d,T=g+p,E=y+p;i[0]=x,i[1]=T,i[9]=S,i[10]=T,i[18]=x,i[19]=E,i[27]=S,i[28]=E}else{var C=l*m,A=l*v,b=u*m,w=u*v,R=h*g+d,P=h*y+d,I=_*g+p,D=_*y+p;i[0]=C+R,i[1]=b+I,i[9]=A+R,i[10]=w+I,i[18]=C+P,i[19]=b+D,i[27]=A+P,i[28]=w+D}},fillBuffers:function(e){if(null!==e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(i),o=n.vertexAccessor.getIndexBuffer(i),s=a.indexOffset;o[s++]=r,o[s++]=r+1,o[s++]=r+2,o[s++]=r+2,o[s++]=r+1,o[s++]=r+3,a.indexOffset+=6}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,a=n.height,o=n.anchorX*r,s=n.anchorY*a,c=0,l=0,u=0,h=0;if(e.trim)c=-o,l=-s,u=r-o,h=a-s;else{var _=e.spriteFrame,f=_.getOriginalSize(),d=_.getRect(),p=f.width,m=f.height,v=d.width,g=d.height,y=_.getOffset(),x=r/p,S=a/m,T=y.x+(p-v)/2,E=y.x-(p-v)/2;c=T*x-o,l=(y.y+(m-g)/2)*S-s,u=r+E*x-o,h=a+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,t.vertDirty=!0}},updateUVs:function(e){if(e.spriteFrame){var t=e.renderData.chunk.vb,n=e.spriteFrame.uv;t[3]=n[0],t[4]=n[1],t[12]=n[2],t[13]=n[3],t[21]=n[4],t[22]=n[5],t[30]=n[6],t[31]=n[7]}},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=5,r=e.color,a=r.r/255,o=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=t.floatStride)n[i]=a,n[i+1]=o,n[i+2]=s,n[i+3]=c}},FJ=new zn,zJ=new ei,UJ={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,54),t},updateRenderData:function(e){var t=e.spriteFrame;fH.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData.data,n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,a=n.anchorX*i,o=n.anchorY*r,s=e.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=i-c-l,f=r-u-h,d=i/(c+l),p=r/(u+h);d=Number.isNaN(d)||d>1?1:d,p=Number.isNaN(p)||p>1?1:p,_=_<0?0:_,f=f<0?0:f,t[0].x=-a,t[0].y=-o,t[1].x=c*d-a,t[1].y=h*p-o,t[2].x=t[1].x+_,t[2].y=t[1].y+f,t[3].x=i-a,t[3].y=r-o},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(n.bufferId),o=n.vertexAccessor.getIndexBuffer(i),s=a.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;o[s++]=u,o[s++]=u+1,o[s++]=u+4,o[s++]=u+1,o[s++]=u+5,o[s++]=u+4}a.indexOffset=s},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(zJ);for(var n=e.renderData,i=n.floatStride,r=n.data,a=t.vb,o=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];zn.set(FJ,u.x,c.y,0),zn.transformMat4(FJ,FJ,zJ),o=(4*s+l)*i,a[o++]=FJ.x,a[o++]=FJ.y,a[o++]=FJ.z}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=e.spriteFrame.uvSliced,a=3,o=0;o<16;o++)n[a]=r[o].u,n[a+1]=r[o].v,a+=i},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,a=e.color,o=a.r/255,s=a.g/255,c=a.b/255,l=e.node._uiProps.opacity,u=0;u<16;u++)n[r]=o,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},GJ=[],HJ=0;HJ<4;HJ++)GJ.push(new zn);var VJ=new ei,jJ={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),a=Math.abs(i.height),o=n.getRect(),s=n.insetLeft,c=n.insetRight,l=o.width-s-c,u=n.insetTop,h=n.insetBottom,_=o.height-u-h,f=r-s-c,d=a-u-h;f=f>0?f:0,d=d>0?d:0;var p=0===l?f:f/l,m=0===_?d:d/_,v=Math.ceil(m+2),g=Math.ceil(p+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,f,d,v,g),t.resize(v*g*4,v*g*6)}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,a=i.vertexOffset,o=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=o.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=a,s[c++]=a+1,s[c++]=a+2,s[c++]=a+1,s[c++]=a+3,s[c++]=a+2,a+=4,o.indexOffset+=6;o.setDirty()},updateWorldVertexAndUVData:function(e,t){var n=e.node;n.getWorldMatrix(VJ);var i=e.renderData,r=i.floatStride,a=i.data,o=t.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=e.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,d=u.rect,p=u.insetLeft,m=u.insetRight,v=d.width-p-m,g=u.insetTop,y=u.insetBottom,x=d.height-g-y,S=c-p-m,T=l-g-y;S=S>0?S:0,T=T>0?T:0;for(var E=0===v?S:S/v,C=0===x?T:T/x,A=Math.ceil(C+2),b=Math.ceil(E+2),w=0,R=0,P=0,I=0,D=0,O=0,N=A;O<N;++O){I=a[O].y,D=a[O+1].y;for(var M=0,k=b;M<k;++M){R=a[M].x,P=a[M+1].x,zn.set(GJ[0],R,I,0),zn.set(GJ[1],P,I,0),zn.set(GJ[2],R,D,0),zn.set(GJ[3],P,D,0);for(var L=0;L<4;L++){var B=GJ[L];zn.transformMat4(B,B,VJ);var F=L*r;o[w+F]=B.x,o[w+F+1]=B.y,o[w+F+2]=B.z}w+=4*r}}w=0;for(var z=r,U=2*r,G=3*r,H=4*r,V=0,j=0,W=[],q=[],X=0,Y=A;X<Y;++X){j=T>x?T>=X*x?1:C%1:C;for(var K=0,Q=b;K<Q;++K){V=S>v?S>=K*v?1:E%1:E;var Z=w+3,J=Z+1;h?(0===X?(W[0]=f[0].u,W[1]=f[0].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X<A-1?(W[0]=f[4].u,W[1]=f[4].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X===A-1&&(W[0]=f[8].u,W[1]=f[8].u,W[2]=f[12].u),0===K?(q[0]=f[0].v,q[1]=f[1].v+(f[2].v-f[1].v)*V,q[2]=f[0].v):K<b-1?(q[0]=f[1].v,q[1]=f[1].v+(f[2].v-f[1].v)*V,q[2]=f[1].v):K===b-1&&(q[0]=f[2].v,q[1]=f[3].v,q[2]=f[2].v),W[3]=W[2],q[3]=q[1]):(0===K?(W[0]=f[0].u,W[1]=f[1].u+(f[2].u-f[1].u)*V,W[2]=_[0]):K<b-1?(W[0]=f[1].u,W[1]=f[1].u+(f[2].u-f[1].u)*V,W[2]=f[1].u):K===b-1&&(W[0]=f[2].u,W[1]=f[3].u,W[2]=f[2].u),0===X?(q[0]=f[0].v,q[1]=f[0].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X<A-1?(q[0]=f[4].v,q[1]=f[4].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X===A-1&&(q[0]=f[8].v,q[1]=f[8].v,q[2]=f[12].v),W[3]=W[1],q[3]=q[2]),o[Z]=W[0],o[J]=q[0],o[Z+z]=W[1],o[J+z]=q[1],o[Z+U]=W[2],o[J+U]=q[2],o[Z+G]=W[3],o[J+G]=q[3],w+=H}}},updateVerts:function(e,t,n,i,r){var a,o,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,d=s.anchorY*_,p=l.insetLeft,m=l.insetRight,v=u.width-p-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(p+m)>1?1:s.width/(p+m),T=s.height/(g+y)>1?1:s.height/(g+y);a=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,o=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var E=0;E<=r;E++)0===E?c[E].x=-f:E>0&&E<r?c[E].x=1===E?p*S+Math.min(v,t)-f:v>0?E===r-1?p+a+v*(E-2)-f:p+Math.min(v,t)+v*(E-2)-f:p+t-f:E===r&&(c[E].x=Math.min(p+t+m,h)-f);for(var C=0;C<=i;C++)0===C?c[C].y=-d:C>0&&C<i?c[C].y=1===C?y*T+Math.min(x,n)-d:x>0?C===i-1?y+o+(C-2)*x-d:y+Math.min(x,n)+(C-2)*x-d:y+n-d:C===i&&(c[C].y=Math.min(y+n+g,_)-d)},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,a=5,o=e.color,s=o.r/255,c=o.g/255,l=o.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[a]=s,n[a+1]=c,n[a+2]=l,n[a+3]=u,a+=i},updateColor:function(){}},WJ=yY.Type,qJ=yY.FillType,XJ=e("spriteAssembler",{getAssembler:function(e){var t=BJ,n=e;switch(n.type){case WJ.SLICED:t=UJ;break;case WJ.TILED:t=jJ;break;case WJ.FILLED:t=n.fillType===qJ.RADIAL?MJ:gJ}return t}});yY.Assembler=XJ;var YJ=fj.sharedManager,KJ={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){e.type===eX.IMAGE_STENCIL&&(BJ.updateRenderData(e),BJ.updateColor(e))},fillBuffers:function(e,t){(e.type!==eX.IMAGE_STENCIL||e.spriteFrame)&&(YJ.pushMask(e),t.finishMergeBatches(),function(e,t){YJ.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(YJ.enterLevel(e),e.type===eX.IMAGE_STENCIL){BJ.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),YJ.enableMask())}},QJ={fillBuffers:function(){YJ.exitMask()}},ZJ={getAssembler:function(){return KJ}},JJ={getAssembler:function(){return QJ}};aX.Assembler=ZJ,aX.PostAssembler=JJ;var $J=e("MeshBuffer",function(){function e(){K(this,e),this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}return Z(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"initialize",value:function(e,t,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=t,this._floatsPerVertex=pV(t),this._initVDataCount,this._floatsPerVertex,k(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))}},{key:"reset",value:function(){this._nextFreeIAHandle=0,this._dirty=!1}},{key:"destroy",value:function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0}},{key:"setDirty",value:function(){this._dirty=!0}},{key:"request",value:function(){return P(9002),!1}},{key:"requireFreeIA",value:function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia}},{key:"recycleIA",value:function(e){for(var t=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(e===t[n].ia){var i=t[n];return t[n]=t[--this._nextFreeIAHandle],void(t[this._nextFreeIAHandle]=i)}}},{key:"checkCapacity",value:function(e,t){var n=this.vertexOffset+e,i=this.indexOffset+t;return!(n>this._initVDataCount||i>this._initIDataCount)}},{key:"uploadBuffers",value:function(){if(0!==this.byteOffset&&this._dirty){for(var e=vh.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,t=this.byteOffset,n=this.indexOffset,i=0;i<e;++i){var r=this._iaPool[i],a=new Float32Array(this.vData.buffer,0,t>>2),o=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];t>s.size&&s.resize(t),s.update(a),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(o)}this._dirty=!1}}},{key:"createNewIA",value:function(e){var t,n,i;if(vh.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,a=Uint16Array.BYTES_PER_ELEMENT,o=e.createBuffer(new Tr(bi.VERTEX|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,r,r));i=e.createBuffer(new Tr(bi.INDEX|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,a,a)),n=[o],this._iaInfo=new Gr(this._attributes,n,i),t=e.createInputAssembler(this._iaInfo)}else t=e.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:t,vertexBuffers:n,indexBuffer:i}}}]),e}()),e$=[yD.EventType.MOUSE_DOWN,yD.EventType.MOUSE_MOVE,yD.EventType.MOUSE_UP,yD.EventType.MOUSE_WHEEL],t$=[yD.EventType.TOUCH_START,yD.EventType.TOUCH_MOVE,yD.EventType.TOUCH_END,yD.EventType.TOUCH_CANCEL],n$=(new(function(){function e(){K(this,e),this.priority=lD.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],xD._registerEventDispatcher(this),BI.callbacksInvoker.on(Jb.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),BI.callbacksInvoker.on(Jb.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),BI.callbacksInvoker.on(Jb.MARK_LIST_DIRTY,this._markListDirty,this)}return Z(e,[{key:"dispatchEvent",value:function(e){var t=e.type;return t$.includes(t)?this.dispatchEventTouch(e):!e$.includes(t)||this.dispatchEventMouse(e)}},{key:"addPointerEventProcessor",value:function(e){0===this._inDispatchCount?this._pointerEventProcessorList.includes(e)||(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.includes(e)||this._processorListToAdd.push(e),dt.array.remove(this._processorListToRemove,e)}},{key:"removePointerEventProcessor",value:function(e){0===this._inDispatchCount?(dt.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.includes(e)||this._processorListToRemove.push(e),dt.array.remove(this._processorListToAdd,e)}},{key:"dispatchEventMouse",value:function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var a=t[r];if(a.isEnabled&&a.shouldHandleEventMouse&&a._handleEventMouse(e)){if(i=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i}},{key:"dispatchEventTouch",value:function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,a=0;a<n;++a){var o=t[a];if(o.isEnabled&&o.shouldHandleEventTouch)if(e.type===Qb.TOUCH_START){if(o._handleEventTouch(e)){if(o.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(o.claimedTouchIdList.length>0){var s=o.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(o._handleEventTouch(e),e.type!==Qb.TOUCH_END&&e.type!==Qb.TOUCH_CANCEL||dt.array.removeAt(o.claimedTouchIdList,s),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r}},{key:"_updatePointerEventProcessorList",value:function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,a=0;a<r;++a)this.removePointerEventProcessor(i[a]);i.length=0}},{key:"_sortPointerEventProcessorList",value:function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node;if(r._uiProps){var a=r._uiProps.uiTransformComp;i.cachedCameraPriority=a.cameraPriority}}e.sort(this._sortByPriority),this._isListDirty=!1}}},{key:"_sortByPriority",value:function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,a=i,o=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=a.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(o=!0)&&i:r&&r.parent,a=null===(null===(h=a)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(o=!0)&&n:a&&a.parent}if(r._id===a._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,d=a?a.getSiblingIndex():0;return o?f-d:d-f}},{key:"_markListDirty",value:function(){this._isListDirty=!0}}]),e}()),function(){function e(t,n){K(this,e),this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=t,this._attributes=n,this._floatsPerVertex=pV(n),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}return Z(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}},{key:"initialize",value:function(){}},{key:"reset",value:function(){}},{key:"request",value:function(){}},{key:"appendBuffers",value:function(){}},{key:"uploadBuffers",value:function(){}},{key:"destroy",value:function(){this._attributes.length=0}}]),e}()),i$=new Jl((function(){return{offset:0,length:0}}),32),r$=function e(t,n,i,r){K(this,e),this.vertexAccessor=t,this.bufferId=n,this.vertexOffset=i,this.vb=r},a$=function(e){te(n,e);var t=le(n);function n(e,i,r,a){var o;return K(this,n),(o=t.call(this,e,i))._freeLists=[],o._vCount=0,o._iCount=0,o._vCount=r||Math.floor(1024*St.BATCHER2D_MEM_INCREMENT/o._vertexFormatBytes),o._iCount=a||o._vCount*n.IB_SCALE,o._allocateBuffer(),o}return Z(n,[{key:"destroy",value:function(){for(var e=0;e<this._buffers.length;++e){this._buffers[e].destroy();for(var t=this._freeLists[e],i=0;i<t.length;++i)i$.free(t[i])}this._buffers.length=0,this._freeLists.length=0,he(ne(n.prototype),"destroy",this).call(this)}},{key:"reset",value:function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}}},{key:"getVertexBuffer",value:function(e){return this._buffers[e].vData}},{key:"getIndexBuffer",value:function(e){return this._buffers[e].iData}},{key:"getMeshBuffer",value:function(e){return this._buffers[e]}},{key:"uploadBuffers",value:function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],n=this._buffers[e];(!t||t.length<n.vData.byteLength)&&n.uploadBuffers()}}},{key:"appendIndices",value:function(e,t){var n=this._buffers[e];t.length&&(n.iData.set(t,n.indexOffset),n.indexOffset+=t.length)}},{key:"allocateChunk",value:function(e,t){for(var n,i=e*this.vertexFormatBytes,r=null,a=0,o=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],a=c,o=l;break}if(s)break}if(s||(a=this._allocateBuffer(),(r=this._buffers[a])&&r.checkCapacity(e,t)&&(o=0,s=this._freeLists[a][o])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(a,o,s,i),new r$(this,a,u,h,t)}return P(9004,i),null}},{key:"recycleChunk",value:function(e){var t=this._freeLists[e.bufferId],n=this._buffers[e.bufferId],i=e.vertexOffset*this.vertexFormatBytes,r=e.vb.byteLength;if(0!==r){for(var a=!1,o=0,s=null,c=t[o];c&&c.offset<i;)s=c,c=t[++o];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,t.splice(o,1),i$.free(c),c=null),a=!0),!a&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=i$.alloc();l.offset=i,l.length=r,t.splice(o,0,l)}a=!0}if(a)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=i$.alloc();u.offset=i,u.length=r,t.push(u)}}}},{key:"_allocateChunkFromEntry",value:function(e,t,n,i){var r=n.length-i,a=n.offset+i,o=this._buffers[e];o.byteOffset<a&&(o.byteOffset=a),M(r>=0,9004,e,n.offset,n.length),0===r?(this._freeLists[e].splice(t,1),i$.free(n)):(n.offset+=i,n.length=r)}},{key:"_allocateBuffer",value:function(){M(this._buffers.length===this._freeLists.length,9003);var e=new $J,t=this._vCount*this._floatsPerVertex;e.initialize(this._device,this._attributes,t,this._iCount),this._buffers.push(e);var n=i$.alloc();n.offset=0,n.length=e.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1}}]),n}(n$);a$.IB_SCALE=4;var o$=new Jr(null),s$=new ei,c$=e("UI",function(){function e(t){var n=this;K(this,e),this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new gg,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new u$,this._meshDataArray=[],this._root=t,this.device=t.device,this._batches=new eu(64),this._drawBatchPool=new Jl((function(){return new aQ}),128,(function(e){return e.destroy(n)}))}return Z(e,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}},{key:"initialize",value:function(){return!0}},{key:"destroy",value:function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(e){e.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),fj.sharedManager.destroy()}},{key:"addScreen",value:function(e){this._screens.push(e),this._screens.sort(this._screenSort)}},{key:"removeScreen",value:function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)}},{key:"sortScreens",value:function(){this._screens.sort(this._screenSort)}},{key:"getFirstRenderCamera",value:function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null}},{key:"update",value:function(){for(var e=this._screens,t=0,n=0;n<e.length;++n){var i=e[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var a=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var o=this._batches.array[t];if(o.model)for(var s=o.model.subModels,c=0;c<s.length;c++)s[c].priority=a++;else o.descriptorSet=this._descriptorSetCache.getDescriptorSet(o);r.addBatch(o)}}}}},{key:"uploadBuffers",value:function(){this._batches.length>0&&(this._meshDataArray.forEach((function(e){e.uploadBuffers()})),this._bufferAccessors.forEach((function(e){e.uploadBuffers(),e.reset()})),this._descriptorSetCache.update())}},{key:"reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._bufferAccessors.forEach((function(e){e.reset()})),this._meshDataArray.forEach((function(e){e.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),fj.sharedManager.reset()}},{key:"switchBufferAccessor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fV,t=e===fV?36:mV(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var n=this._bufferAccessors.get(t);n||(n=new a$(this.device,e),this._bufferAccessors.set(t,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer}},{key:"registerBufferAccessor",value:function(e,t){this._bufferAccessors.set(e,t)}},{key:"updateBuffer",value:function(e,t){var n=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=n.getMeshBuffer(t).indexOffset)}},{key:"commitComp",value:function(e,t,n,i,r){var a,o=0,s=-1;if(t&&t.chunk){if(!t.isValid())return;o=t.dataHash,a=t.material,s=t.chunk.bufferId}e.stencilStage=fj.sharedManager.stage;var c=e.stencilStage;this._currHash===o&&0!==o&&this._currMaterial===a&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),t&&!t.isMeshBuffer&&this.updateBuffer(t.vertexFormat,s),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=e.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(e,this)}},{key:"commitIA",value:function(e,t,n,i,r){var a,o;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;e&&(a=-1===e.blendHash?null:e.getBlendState(),c=e.blendHash,e.stencilStage=fj.sharedManager.stage,o=null!==e.customMaterial?fj.sharedManager.getStencilStage(e.stencilStage,i):fj.sharedManager.getStencilStage(e.stencilStage),s=fj.sharedManager.getStencilHash(e.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=e.node.layer,l.inputAssembler=t,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,o,s,a,c,null,this),this._batches.push(l)}},{key:"commitModel",value:function(e,t,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(e.stencilStage!==DV.ENABLED&&e.stencilStage!==DV.DISABLED||(e.stencilStage=fj.sharedManager.stage),i=fj.sharedManager.getStencilStage(e.stencilStage,n),r=fj.sharedManager.getStencilHash(e.stencilStage));var a=c.director.getTotalFrames();t&&(t.updateTransform(a),t.updateUBOs(a));for(var o=0;o<t.subModels.length;o++){var s=this._drawBatchPool.alloc(),l=t.subModels[o];s.visFlags=e.node.layer,s.model=t,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,l.patches,this),s.inputAssembler=l.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=l.descriptorSet,this._batches.push(s)}}},{key:"setupStaticBatch",value:function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e}},{key:"endStaticBatch",value:function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()}},{key:"commitStaticBatch",value:function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()}},{key:"autoMergeBatches",value:function(e){var t=this._currMaterial;if(t){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var a=this._currBID,o=r.getMeshBuffer(a);if(!o)return;var s=o.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,o.indexOffset,o.setDirty(),(n=o.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=o.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;e&&(c=-1===e.blendHash?null:e.getBlendState(),h=e.blendHash,l=null!==e.customMaterial?fj.sharedManager.getStencilStage(e.stencilStage,t):fj.sharedManager.getStencilStage(e.stencilStage),u=fj.sharedManager.getStencilHash(e.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=n,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(t,l,u,c,h,null,this),this._batches.push(_)}}}},{key:"forceMergeBatches",value:function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)}},{key:"resetRenderStates",value:function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}},{key:"finishMergeBatches",value:function(){this.autoMergeBatches(),this.resetRenderStates()}},{key:"flushMaterial",value:function(e){this._currMaterial=e}},{key:"walk",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(e.activeInHierarchy){var n=e.children,i=e._uiProps,r=i.uiComp,a=this._pOpacity,o=a,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=o*=s*i.localOpacity,i._opacity=o,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0){oH(r.renderData,o);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!e._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,t)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=a,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),t+=1}}},{key:"_screenSort",value:function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()}},{key:"_releaseDescriptorSetCache",value:function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)}}]),e}()),l$=function(){function e(){K(this,e),this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var t=c.director.root.device;this._localData=new Float32Array(Sp.COUNT),this._localBuffer=t.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,Sp.SIZE,Sp.SIZE))}return Z(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"initialize",value:function(e){var t=c.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,o$.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(o$),this._descriptorSet.bindBuffer(Sp.BINDING,this._localBuffer);var n=$d.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0}},{key:"updateTransform",value:function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())}},{key:"equals",value:function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n}},{key:"reset",value:function(){this._transform=null,this._textureHash=0,this._samplerHash=0}},{key:"destroy",value:function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null}},{key:"isValid",value:function(){return this._transform&&this._transform.isValid}},{key:"uploadLocalData",value:function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;ei.toArray(this._localData,t,Sp.MAT_WORLD_OFFSET),ei.inverseTranspose(s$,t);var n=ei.determinant(s$),i=1/Math.sqrt(n);ei.multiplyScalar(s$,s$,i),ei.toArray(this._localData,s$,Sp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}}}]),e}(),u$=function(){function e(){K(this,e),this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Jl((function(){return new l$}),16,(function(e){return e.destroy()}))}return Z(e,[{key:"getDescriptorSet",value:function(e){var t,n=c.director.root;if(e.useLocalData){for(var i=this._localDescriptorSetCache,r=0,a=i.length;r<a;r++){var o=i[r];if(o.equals(e.useLocalData,e.textureHash,e.samplerHash))return o.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(e),this._localDescriptorSetCache.push(s),s.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);o$.layout=e.passes[0].localSetLayout;var l=n.device.createDescriptorSet(o$),u=$d.SAMPLER_SPRITE;return l.bindTexture(u,e.texture),l.bindSampler(u,e.sampler),l.update(),this._descriptorSetCache.set(t,l),this._dsCacheHashByTexture.set(e.textureHash,t),l}},{key:"update",value:function(){var e=this._localDescriptorSetCache,t=[];e.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=e.indexOf(n);t.push(i)}}));for(var n=t.length-1;n>=0;n--)e.splice(t[n],1)}},{key:"reset",value:function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0}},{key:"releaseDescriptorSetCache",value:function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))}},{key:"destroy",value:function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()}}]),e}();c.internal.Batcher2D=c$,U($J.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(e){return{name:e,suggest:"please use meshBuffer.accessor.".concat(e," instead")}}))),F($J.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),z($J.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),F(c$.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),z(BV.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),F(BV.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),e("QuadRenderData",function(e){te(n,e);var t=le(n);function n(e){var i;return K(this,n),i=t.call(this,e),P(9006),i}return n}(BV));var h$,_$,f$,d$,p$=null,m$=-1,v$="BES bswy:->@123丁ぁᄁ",g$=Object.create(null),y$=[],x$=3e3;function S$(){for(var e=!0,t=Date.now(),n=y$.length-1;n>=0;n--){var i=y$[n],r=i.fontFamilyName;if(t-i.startTime>x$)P(4933,r),i.onComplete(null,r),y$.splice(n,1);else{var a=i.refWidth,o="40px ".concat(r);p$.font=o,a!==eV(p$,v$,o)?(y$.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(m$),m$=-1)}function T$(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n="".concat(-1===i?e.substring(0,t):e.substring(i+1,t),"_LABEL")).indexOf(" ")&&(n='"'.concat(n,'"')),n}(e);if(g$[i])n(null,i);else{if(!p$){var r=document.createElement("canvas");r.width=100,r.height=100,p$=r.getContext("2d")}var a="40px ".concat(i),o=eV(p$,v$,a),s=document.createElement("style");s.type="text/css";var c="";Number.isNaN(i)?c+="@font-face { font-family:".concat(i,"; src:"):c+='@font-face { font-family:"'.concat(i,'"; src:'),c+='url("'.concat(e,'");'),s.textContent="".concat(c,"}"),document.body.appendChild(s);var l=document.createElement("div"),u=l.style;if(u.fontFamily=i,l.innerHTML=".",u.position="absolute",u.left="-100px",u.top="-100px",document.body.appendChild(l),function(){if(void 0===h$)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);h$=e?parseInt(e[1],10)>42:!t}else h$=!1;return h$}())!function(e,t,n){var i=new Promise((function(n,i){!function r(){Date.now()-e>=x$?i():document.fonts.load("40px ".concat(t)).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,a=new Promise((function(e,t){r=setTimeout(t,x$)}));Promise.race([a,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,t)}),(function(){P(4933,t),n(null,t)}))}(Date.now(),i,n);else{var h={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};y$.push(h),-1===m$&&(m$=setInterval(S$,100))}g$[i]=s}}function E$(e,t,n,i){var r=new LH;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}jM.register({".font":T$,".eot":T$,".ttf":T$,".woff":T$,".svg":T$,".ttc":T$}),ZM.register({".font":E$,".eot":E$,".ttf":E$,".woff":E$,".svg":E$,".ttc":E$}),c.UI={MeshBuffer:$J,spriteAssembler:XJ,graphicsAssembler:XQ,labelAssembler:dJ,RenderData:LV,MeshRenderData:BV},function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(_$||(_$={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(f$||(f$={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(d$||(d$={}));var C$,A$=0;function b$(e,t){var n;t.invoking||(t.invoking=!0,(n=t.func).call.apply(n,[e].concat(pe(t.args))).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var n=e._operationQueue[0];n&&b$(e,n)})).catch((function(){})))}function w$(e,t,n){var i=n.value;n.value=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return new Promise((function(t){var r=A$++,a=e;a._operationQueue.push({id:r,func:i,args:n,invoking:!1}),a._eventTarget.once(r.toString(),t),b$(a,a._operationQueue[0])}))}}function R$(e){return new Promise((function(t){var n=e.play();return void 0===n?t():(n.then(t).catch((function(){var n=function(){e.play().catch((function(){})),t()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var P$,I$,D$=function(){function e(t,n){K(this,e),this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=t,t.volume=n}return Z(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}},{key:"play",value:function(){var e=this;R$(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))}},{key:"stop",value:function(){this._domAudio.pause()}}]),e}(),O$=(xe((C$=function(){function e(t){var n=this;K(this,e),this._domAudio=void 0,this._state=d$.INIT,this._onEnded=void 0,this._eventTarget=new lu,this._operationQueue=[],this._domAudio=t,Eu.on("hide",this._onHide,this),Eu.on("show",this._onShow,this),this._onEnded=function(){n.seek(0).catch((function(){})),n._state=d$.INIT,n._eventTarget.emit(_$.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}return Z(e,[{key:"destroy",value:function(){Eu.off("hide",this._onHide,this),Eu.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null}},{key:"_onHide",value:function(){var e=this;this._state===d$.PLAYING&&this.pause().then((function(){e._state=d$.INTERRUPTED,e._eventTarget.emit(_$.INTERRUPTION_BEGIN)})).catch((function(){}))}},{key:"_onShow",value:function(){var e=this;this._state===d$.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(_$.INTERRUPTION_END)})).catch((function(){}))}},{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return f$.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=yn(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}},{key:"seek",value:function(e){return e=gn(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()}},{key:"play",value:function(){var e=this;return new Promise((function(t){R$(e._domAudio).then((function(){e._state=d$.PLAYING,t()})).catch((function(){}))}))}},{key:"pause",value:function(){return this._domAudio.pause(),this._state=d$.PAUSED,Promise.resolve()}},{key:"stop",value:function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=d$.STOPPED,t()}))}},{key:"onInterruptionBegin",value:function(e){this._eventTarget.on(_$.INTERRUPTION_BEGIN,e)}},{key:"offInterruptionBegin",value:function(e){this._eventTarget.off(_$.INTERRUPTION_BEGIN,e)}},{key:"onInterruptionEnd",value:function(e){this._eventTarget.on(_$.INTERRUPTION_END,e)}},{key:"offInterruptionEnd",value:function(e){this._eventTarget.off(_$.INTERRUPTION_END,e)}},{key:"onEnded",value:function(e){this._eventTarget.on(_$.ENDED,e)}},{key:"offEnded",value:function(e){this._eventTarget.off(_$.ENDED,e)}}],[{key:"load",value:function(t){return new Promise((function(n){e.loadNative(t).then((function(t){n(new e(t))})).catch((function(){}))}))}},{key:"loadNative",value:function(e){return new Promise((function(t,n){var i=document.createElement("audio"),r="canplaythrough";Eu.os===du.IOS?r="loadedmetadata":Eu.browserType===hu.FIREFOX&&(r="canplay");var a=setTimeout((function(){0===i.readyState?c():s()}),8e3),o=function(){clearTimeout(a),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){o(),t(i)},c=function(){o();var t="load audio failure - ".concat(e);n(t)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=e}))}},{key:"loadOneShotAudio",value:function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var t=new D$(e,n);i(t)})).catch(r)}))}}]),e}()).prototype,"seek",[w$],Object.getOwnPropertyDescriptor(C$.prototype,"seek"),C$.prototype),xe(C$.prototype,"play",[w$],Object.getOwnPropertyDescriptor(C$.prototype,"play"),C$.prototype),xe(C$.prototype,"pause",[w$],Object.getOwnPropertyDescriptor(C$.prototype,"pause"),C$.prototype),xe(C$.prototype,"stop",[w$],Object.getOwnPropertyDescriptor(C$.prototype,"stop"),C$.prototype),C$),N$=function(){function e(t){K(this,e),this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=t}return Z(e,[{key:"destroy",value:function(){this._nativeAudio=void 0}},{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}},{key:"_now",value:function(){return performance.now()/1e3}},{key:"_calculateCurrentTime",value:function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration}},{key:"start",value:function(){this._isPaused=!1,this._startTime=this._now()}},{key:"pause",value:function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())}},{key:"stop",value:function(){this._isPaused=!0,this._startOffset=0}},{key:"seek",value:function(e){this._startTime=this._now(),this._startOffset=gn(e,0,this.duration)}}]),e}(),M$=new(function(){function e(){K(this,e),this._audioBufferDataMap={}}return Z(e,[{key:"addCache",value:function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer ".concat(e," has been cached")):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}}},{key:"retainCache",value:function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache ".concat(e," has not been added."))}},{key:"getCache",value:function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer}},{key:"tryReleasingCache",value:function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache ".concat(e," has not been added."))}}]),e}()),k$=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,L$=function(){function e(){K(this,e),this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}return Z(e,[{key:"currentTime",get:function(){return this._context.currentTime}},{key:"decodeAudioData",value:function(e){var t=this;return new Promise((function(n){var i=t._context.decodeAudioData(e,(function(e){n(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==i||i.catch((function(){}))}))}},{key:"runContext",value:function(){var e=this;return new Promise((function(t){var n=e._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(t).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else t();else t()}))}},{key:"createBufferSource",value:function(e,t){var n=this._context.createBufferSource();return void 0!==e&&(n.buffer=e),void 0!==t&&(n.loop=t),n}},{key:"createGain",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=this._context.createGain();return this.setGainValue(t,e),t}},{key:"setGainValue",value:function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(n){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t}},{key:"connectContext",value:function(e){this._context&&e.connect(this._context.destination)}}]),e}();L$.support=!!k$,L$.support&&(I$=new L$);var B$,F$,z$,U$,G$,H$=function(){function e(t,n,i){K(this,e),this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=t.duration,this._url=i,this._bufferSourceNode=I$.createBufferSource(t,!1);var r=I$.createGain(n);this._bufferSourceNode.connect(r),I$.connectContext(r)}return Z(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}},{key:"play",value:function(){var e=this;this._bufferSourceNode.start(),I$.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;M$.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))}},{key:"stop",value:function(){clearTimeout(this._currentTimer),M$.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null}}]),e}(),V$=(xe((P$=function(){function e(t,n){K(this,e),this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=d$.INIT,this._audioTimer=void 0,this._eventTarget=new lu,this._operationQueue=[],this._audioBuffer=t,this._audioTimer=new N$(t),this._gainNode=I$.createGain(),I$.connectContext(this._gainNode),this._src=n,Eu.on("hide",this._onHide,this),Eu.on("show",this._onShow,this)}return Z(e,[{key:"destroy",value:function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),M$.tryReleasingCache(this._src),Eu.off("hide",this._onHide,this),Eu.off("show",this._onShow,this)}},{key:"_onHide",value:function(){var e=this;this._state===d$.PLAYING&&this.pause().then((function(){e._state=d$.INTERRUPTED,e._eventTarget.emit(_$.INTERRUPTION_BEGIN)})).catch((function(){}))}},{key:"_onShow",value:function(){var e=this;this._state===d$.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(_$.INTERRUPTION_END)})).catch((function(){}))}},{key:"src",get:function(){return this._src}},{key:"type",get:function(){return f$.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=yn(e),this._volume=e,I$.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}},{key:"seek",value:function(e){var t=this;return new Promise((function(n){t._audioTimer.seek(e),t._state===d$.PLAYING?t._doPlay().then(n).catch((function(){})):n()}))}},{key:"play",value:function(){return this._doPlay()}},{key:"_doPlay",value:function(){var e=this;return new Promise((function(t){e._stopSourceNode(),e._sourceNode=I$.createBufferSource(e._audioBuffer,e.loop),e._sourceNode.connect(e._gainNode),e._sourceNode.start(0,e._audioTimer.currentTime),I$.runContext().then((function(){e._state=d$.PLAYING,e._audioTimer.start(),window.clearTimeout(e._currentTimer),e._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(_$.ENDED),e._state=d$.INIT)}),1e3*(e._audioBuffer.duration-e._audioTimer.currentTime)),t()})).catch((function(){}))}))}},{key:"_stopSourceNode",value:function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(e){}}},{key:"pause",value:function(){return this._state===d$.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=d$.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()}},{key:"stop",value:function(){return this._sourceNode?(this._audioTimer.stop(),this._state=d$.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()}},{key:"onInterruptionBegin",value:function(e){this._eventTarget.on(_$.INTERRUPTION_BEGIN,e)}},{key:"offInterruptionBegin",value:function(e){this._eventTarget.off(_$.INTERRUPTION_BEGIN,e)}},{key:"onInterruptionEnd",value:function(e){this._eventTarget.on(_$.INTERRUPTION_END,e)}},{key:"offInterruptionEnd",value:function(e){this._eventTarget.off(_$.INTERRUPTION_END,e)}},{key:"onEnded",value:function(e){this._eventTarget.on(_$.ENDED,e)}},{key:"offEnded",value:function(e){this._eventTarget.off(_$.ENDED,e)}}],[{key:"load",value:function(t){return new Promise((function(n){e.loadNative(t).then((function(i){n(new e(i,t))})).catch((function(){}))}))}},{key:"loadNative",value:function(e){return new Promise((function(t,n){var i=M$.getCache(e);if(i)return M$.retainCache(e),void t(i);var r=new XMLHttpRequest,a="load audio failed: ".concat(e,", status: ");r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?I$.decodeAudioData(r.response).then((function(n){M$.addCache(e,n),t(n)})).catch((function(){})):n(new Error("".concat(a).concat(r.status,"(no response)")))},r.onerror=function(){n(new Error("".concat(a).concat(r.status,"(error)")))},r.ontimeout=function(){n(new Error("".concat(a).concat(r.status,"(time out)")))},r.onabort=function(){n(new Error("".concat(a).concat(r.status,"(abort)")))},r.send(null)}))}},{key:"loadOneShotAudio",value:function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var r=new H$(e,n,t);i(r)})).catch(r)}))}}]),e}()).prototype,"seek",[w$],Object.getOwnPropertyDescriptor(P$.prototype,"seek"),P$.prototype),xe(P$.prototype,"play",[w$],Object.getOwnPropertyDescriptor(P$.prototype,"play"),P$.prototype),xe(P$.prototype,"pause",[w$],Object.getOwnPropertyDescriptor(P$.prototype,"pause"),P$.prototype),xe(P$.prototype,"stop",[w$],Object.getOwnPropertyDescriptor(P$.prototype,"stop"),P$.prototype),P$),j$=function(){function e(t){K(this,e),this._audio=void 0,this._audio=t}return Z(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}},{key:"play",value:function(){this._audio.play()}},{key:"stop",value:function(){this._audio.stop()}}]),e}(),W$=function(){function e(t){K(this,e),this._player=void 0,this._player=t}return Z(e,[{key:"destroy",value:function(){this._player.destroy()}},{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}},{key:"seek",value:function(e){return this._player.seek(e)}},{key:"play",value:function(){return this._player.play()}},{key:"pause",value:function(){return this._player.pause()}},{key:"stop",value:function(){return this._player.stop()}},{key:"onInterruptionBegin",value:function(e){this._player.onInterruptionBegin(e)}},{key:"offInterruptionBegin",value:function(e){this._player.offInterruptionBegin(e)}},{key:"onInterruptionEnd",value:function(e){this._player.onInterruptionEnd(e)}},{key:"offInterruptionEnd",value:function(e){this._player.offInterruptionEnd(e)}},{key:"onEnded",value:function(e){this._player.onEnded(e)}},{key:"offEnded",value:function(e){this._player.offEnded(e)}}],[{key:"load",value:function(t,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==f$.DOM_AUDIO&&L$.support?V$.load(t).then((function(t){i(new e(t))})).catch((function(){})):(L$.support||P(5201),O$.load(t).then((function(t){i(new e(t))})).catch((function(){})))}))}},{key:"loadNative",value:function(e,t){return(null==t?void 0:t.audioLoadMode)!==f$.DOM_AUDIO&&L$.support?V$.loadNative(e):(L$.support||P(5201),O$.loadNative(e))}},{key:"loadOneShotAudio",value:function(e,t,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==f$.DOM_AUDIO&&L$.support?V$.loadOneShotAudio(e,t).then((function(e){i(new j$(e))})).catch(r):(L$.support||P(5201),O$.loadOneShotAudio(e,t).then((function(e){i(new j$(e))})).catch(r))}))}}]),e}();W$.maxAudioChannel=24;var q$=e("AudioClip",Cc("cc.AudioClip")((G$=U$=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_duration",z$,se(e)),e._loadMode=f$.UNKNOWN_AUDIO,e._meta=null,e._player=null,e}return Z(n,[{key:"destroy",value:function(){var e,t=he(ne(n.prototype),"destroy",this).call(this);return null===(e=this._player)||void 0===e||e.destroy(),this._player=null,this._meta&&(this._meta.player=null),t}},{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=f$.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"validate",value:function(){return!!this._meta}},{key:"getDuration",value:function(){return this._duration?this._duration:this._meta?this._meta.duration:0}},{key:"state",get:function(){return this._player?this._player.state:d$.INIT}},{key:"getCurrentTime",value:function(){return this._player?this._player.currentTime:0}},{key:"getVolume",value:function(){return this._player?this._player.volume:0}},{key:"getLoop",value:function(){return!!this._player&&this._player.loop}},{key:"setCurrentTime",value:function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))}},{key:"setVolume",value:function(e){this._player&&(this._player.volume=e)}},{key:"setLoop",value:function(e){this._player&&(this._player.loop=e)}},{key:"play",value:function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))}},{key:"pause",value:function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))}},{key:"stop",value:function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))}},{key:"playOneShot",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._nativeAsset&&W$.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))}}]),n}(Uu),U$.AudioType=f$,z$=xe((F$=G$).prototype,"_duration",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xe(F$.prototype,"_nativeDep",[dl],Object.getOwnPropertyDescriptor(F$.prototype,"_nativeDep"),F$.prototype),B$=F$))||B$);function X$(e,t,n){W$.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var i={player:t,url:e,duration:t.duration,type:t.type};n(null,i)})).catch((function(e){n(e)}))}function Y$(e,t,n,i){var r=new q$;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,i(null,r)}c.AudioClip=q$,jM.register({".mp3":X$,".ogg":X$,".wav":X$,".m4a":X$}),ZM.register({".mp3":Y$,".ogg":Y$,".wav":Y$,".m4a":Y$});var K$,Q$,Z$,J$,$$,e0,t0,n0,i0,r0,a0,o0,s0,c0,l0,u0,h0,_0,f0,d0=new(function(){function e(){K(this,e),this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}return Z(e,[{key:"_findIndex",value:function(e,t){return e.findIndex((function(e){return e.audio===t}))}},{key:"_tryAddPlaying",value:function(e,t){var n=this._findIndex(e,t);return n>-1?(e[n].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)}},{key:"addPlaying",value:function(e){if(e instanceof W$){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)}},{key:"_tryRemovePlaying",value:function(e,t){var n=this._findIndex(e,t);return-1!==n&&(Ee(e,n),!0)}},{key:"removePlaying",value:function(e){if(e instanceof W$){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)}},{key:"discardOnePlayingIfNeeded",value:function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<W$.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))}}]),e}());!function(e){e.STARTED="started",e.ENDED="ended"}(f0||(f0={}));var p0=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((K$=Cc("cc.AudioSource"),Q$=Uc(),Z$=Lc(),J$=rl(q$),$$=rl(q$),e0=Wc(),t0=Wc(),n0=Wc(),i0=qc(),r0=Wc(),K$(a0=Q$(a0=Z$((_0=h0=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_clip",s0,se(e)),e._player=null,ye(e,"_loop",c0,se(e)),ye(e,"_playOnAwake",l0,se(e)),ye(e,"_volume",u0,se(e)),e._cachedCurrentTime=0,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}return Z(n,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"_syncPlayer",value:function(){var e=this,t=this._clip;this._isLoaded=!1,this._lastSetClip!==t&&(t?t._nativeAsset?(this._lastSetClip=t,W$.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(n){e._lastSetClip===t?(e._isLoaded=!0,e._player&&(e._player.offEnded(),e._player.offInterruptionBegin(),e._player.offInterruptionEnd(),e._player.destroy()),e._player=n,n.onEnded((function(){d0.removePlaying(n),e.node.emit(f0.ENDED,e)})),n.onInterruptionBegin((function(){d0.removePlaying(n)})),n.onInterruptionEnd((function(){d0.addPlaying(n)})),e._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=gn(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"onLoad",value:function(){this._syncPlayer()}},{key:"onEnable",value:function(){this._playOnAwake&&!this.playing&&this.play()}},{key:"onDisable",value:function(){var e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()}},{key:"onDestroy",value:function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy(),this._player=null}},{key:"_getRootNode",value:function(){for(var e,t,n=this.node,i=null===(e=n)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;i;){var r,a,o;i=null===(a=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===a||null===(o=a.parent)||void 0===o?void 0:o.parent}return n}},{key:"play",value:function(){var e,t,n=this;this._isLoaded?(d0.discardOnePlayingIfNeeded(),this.state===d$.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((function(){}))),null===(e=this._player)||void 0===e||e.play().then((function(){d0.addPlaying(n._player),n.node.emit(f0.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")}},{key:"pause",value:function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((function(){d0.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")}},{key:"stop",value:function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((function(){d0.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")}},{key:"playOneShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;e._nativeAsset?W$.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){d0.discardOnePlayingIfNeeded(),e.onPlay=function(){d0.addPlaying(e)},e.onEnd=function(){d0.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")}},{key:"_syncStates",value:function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var n;null===(n=e[t])||void 0===n||n.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=gn(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:d$.INIT}},{key:"playing",get:function(){return this.state===n.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return W$.maxAudioChannel}}]),n}(sh),h0.AudioState=d$,h0.EventType=f0,s0=xe((o0=_0).prototype,"_clip",[J$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c0=xe(o0.prototype,"_loop",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),l0=xe(o0.prototype,"_playOnAwake",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),u0=xe(o0.prototype,"_volume",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),xe(o0.prototype,"clip",[$$,e0],Object.getOwnPropertyDescriptor(o0.prototype,"clip"),o0.prototype),xe(o0.prototype,"loop",[t0],Object.getOwnPropertyDescriptor(o0.prototype,"loop"),o0.prototype),xe(o0.prototype,"playOnAwake",[n0],Object.getOwnPropertyDescriptor(o0.prototype,"playOnAwake"),o0.prototype),xe(o0.prototype,"volume",[i0,r0],Object.getOwnPropertyDescriptor(o0.prototype,"volume"),o0.prototype),a0=o0))||a0)||a0)||a0));F(q$,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:p0,targetName:"AudioSource"}]),U(q$.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(e){return{name:e,suggest:"please use AudioSource.prototype.".concat(e," instead")}}))),c.AudioSourceComponent=p0,dt.setClassAlias(p0,"cc.AudioSourceComponent"),c.log=g,c.warn=y,c.error=x,c.assert=S,c._throw=C,c.logID=w,c.warnID=P,c.errorID=D,c.assertID=M,c.debug=j,c.path={join:wu,extname:Ru,mainFileName:Pu,basename:Iu,dirname:Du,changeExtname:Ou,changeBasename:Nu,_normalize:Mu,stripSep:ku,get sep(){return Lu()}};var m0=e("NodePool",function(){function e(t){K(this,e),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}return Z(e,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var a=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return a&&a.reuse&&a.reuse(arguments),r}}]),e}());c.NodePool=m0,c.renderer=VW;var v0,g0=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuDescriptorSet=null,e}return Z(n,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}},{key:"initialize",value:function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var a=[];this._gpuDescriptorSet={gpuDescriptors:a,descriptorIndices:i};for(var o=0;o<n.length;++o)for(var s=n[o],c=0;c<s.count;c++)a.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}},{key:"destroy",value:function(){this._layout=null,this._gpuDescriptorSet=null}},{key:"update",value:function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&ua){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&ha&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}}]),n}(Pa);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(v0||(v0={}));var y0=function(){function e(){K(this,e)}return Z(e,null,[{key:"instance",get:function(){return e._instance}},{key:"setInstance",value:function(t){e._instance=t}}]),e}();function x0(e,t){switch(e){case Ei.R8:return t.UNSIGNED_BYTE;case Ei.R8SN:return t.BYTE;case Ei.R8UI:return t.UNSIGNED_BYTE;case Ei.R8I:return t.BYTE;case Ei.R16F:return v0.HALF_FLOAT_OES;case Ei.R16UI:return t.UNSIGNED_SHORT;case Ei.R16I:return t.SHORT;case Ei.R32F:return t.FLOAT;case Ei.R32UI:return t.UNSIGNED_INT;case Ei.R32I:return t.INT;case Ei.RG8:return t.UNSIGNED_BYTE;case Ei.RG8SN:return t.BYTE;case Ei.RG8UI:return t.UNSIGNED_BYTE;case Ei.RG8I:return t.BYTE;case Ei.RG16F:return v0.HALF_FLOAT_OES;case Ei.RG16UI:return t.UNSIGNED_SHORT;case Ei.RG16I:return t.SHORT;case Ei.RG32F:return t.FLOAT;case Ei.RG32UI:return t.UNSIGNED_INT;case Ei.RG32I:return t.INT;case Ei.RGB8:case Ei.SRGB8:return t.UNSIGNED_BYTE;case Ei.RGB8SN:return t.BYTE;case Ei.RGB8UI:return t.UNSIGNED_BYTE;case Ei.RGB8I:return t.BYTE;case Ei.RGB16F:return v0.HALF_FLOAT_OES;case Ei.RGB16UI:return t.UNSIGNED_SHORT;case Ei.RGB16I:return t.SHORT;case Ei.RGB32F:return t.FLOAT;case Ei.RGB32UI:return t.UNSIGNED_INT;case Ei.RGB32I:return t.INT;case Ei.BGRA8:case Ei.RGBA8:case Ei.SRGB8_A8:return t.UNSIGNED_BYTE;case Ei.RGBA8SN:return t.BYTE;case Ei.RGBA8UI:return t.UNSIGNED_BYTE;case Ei.RGBA8I:return t.BYTE;case Ei.RGBA16F:return v0.HALF_FLOAT_OES;case Ei.RGBA16UI:return t.UNSIGNED_SHORT;case Ei.RGBA16I:return t.SHORT;case Ei.RGBA32F:return t.FLOAT;case Ei.RGBA32UI:return t.UNSIGNED_INT;case Ei.RGBA32I:return t.INT;case Ei.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Ei.R11G11B10F:return t.FLOAT;case Ei.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Ei.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Ei.RGB10A2:return t.UNSIGNED_BYTE;case Ei.RGB10A2UI:return t.UNSIGNED_INT;case Ei.RGB9E5:return t.UNSIGNED_BYTE;case Ei.DEPTH:return t.UNSIGNED_INT;case Ei.DEPTH_STENCIL:return v0.UNSIGNED_INT_24_8_WEBGL;case Ei.BC1:case Ei.BC1_SRGB:case Ei.BC2:case Ei.BC2_SRGB:case Ei.BC3:case Ei.BC3_SRGB:case Ei.BC4:return t.UNSIGNED_BYTE;case Ei.BC4_SNORM:return t.BYTE;case Ei.BC5:return t.UNSIGNED_BYTE;case Ei.BC5_SNORM:return t.BYTE;case Ei.BC6H_SF16:case Ei.BC6H_UF16:return t.FLOAT;case Ei.BC7:case Ei.BC7_SRGB:case Ei.ETC_RGB8:case Ei.ETC2_RGB8:case Ei.ETC2_SRGB8:case Ei.ETC2_RGB8_A1:case Ei.ETC2_SRGB8_A1:case Ei.EAC_R11:return t.UNSIGNED_BYTE;case Ei.EAC_R11SN:return t.BYTE;case Ei.EAC_RG11:return t.UNSIGNED_BYTE;case Ei.EAC_RG11SN:return t.BYTE;case Ei.PVRTC_RGB2:case Ei.PVRTC_RGBA2:case Ei.PVRTC_RGB4:case Ei.PVRTC_RGBA4:case Ei.PVRTC2_2BPP:case Ei.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Ei.ASTC_RGBA_4X4:case Ei.ASTC_RGBA_5X4:case Ei.ASTC_RGBA_5X5:case Ei.ASTC_RGBA_6X5:case Ei.ASTC_RGBA_6X6:case Ei.ASTC_RGBA_8X5:case Ei.ASTC_RGBA_8X6:case Ei.ASTC_RGBA_8X8:case Ei.ASTC_RGBA_10X5:case Ei.ASTC_RGBA_10X6:case Ei.ASTC_RGBA_10X8:case Ei.ASTC_RGBA_10X10:case Ei.ASTC_RGBA_12X10:case Ei.ASTC_RGBA_12X12:case Ei.ASTC_SRGBA_4X4:case Ei.ASTC_SRGBA_5X4:case Ei.ASTC_SRGBA_5X5:case Ei.ASTC_SRGBA_6X5:case Ei.ASTC_SRGBA_6X6:case Ei.ASTC_SRGBA_8X5:case Ei.ASTC_SRGBA_8X6:case Ei.ASTC_SRGBA_8X8:case Ei.ASTC_SRGBA_10X5:case Ei.ASTC_SRGBA_10X6:case Ei.ASTC_SRGBA_10X8:case Ei.ASTC_SRGBA_10X10:case Ei.ASTC_SRGBA_12X10:case Ei.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function S0(e,t){switch(e){case Ai.BOOL:return t.BOOL;case Ai.BOOL2:return t.BOOL_VEC2;case Ai.BOOL3:return t.BOOL_VEC3;case Ai.BOOL4:return t.BOOL_VEC4;case Ai.INT:return t.INT;case Ai.INT2:return t.INT_VEC2;case Ai.INT3:return t.INT_VEC3;case Ai.INT4:return t.INT_VEC4;case Ai.UINT:return t.UNSIGNED_INT;case Ai.FLOAT:return t.FLOAT;case Ai.FLOAT2:return t.FLOAT_VEC2;case Ai.FLOAT3:return t.FLOAT_VEC3;case Ai.FLOAT4:return t.FLOAT_VEC4;case Ai.MAT2:return t.FLOAT_MAT2;case Ai.MAT3:return t.FLOAT_MAT3;case Ai.MAT4:return t.FLOAT_MAT4;case Ai.SAMPLER2D:return t.SAMPLER_2D;case Ai.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Ai.UNKNOWN}}function T0(e){switch(e){case Ai.BOOL:case Ai.BOOL2:case Ai.BOOL3:case Ai.BOOL4:case Ai.INT:case Ai.INT2:case Ai.INT3:case Ai.INT4:case Ai.UINT:return Int32Array;case Ai.FLOAT:case Ai.FLOAT2:case Ai.FLOAT3:case Ai.FLOAT4:case Ai.MAT2:case Ai.MAT3:case Ai.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function E0(e,t){switch(e){case t.BOOL:return Ai.BOOL;case t.BOOL_VEC2:return Ai.BOOL2;case t.BOOL_VEC3:return Ai.BOOL3;case t.BOOL_VEC4:return Ai.BOOL4;case t.INT:return Ai.INT;case t.INT_VEC2:return Ai.INT2;case t.INT_VEC3:return Ai.INT3;case t.INT_VEC4:return Ai.INT4;case t.UNSIGNED_INT:return Ai.UINT;case t.FLOAT:return Ai.FLOAT;case t.FLOAT_VEC2:return Ai.FLOAT2;case t.FLOAT_VEC3:return Ai.FLOAT3;case t.FLOAT_VEC4:return Ai.FLOAT4;case t.FLOAT_MAT2:return Ai.MAT2;case t.FLOAT_MAT3:return Ai.MAT3;case t.FLOAT_MAT4:return Ai.MAT4;case t.SAMPLER_2D:return Ai.SAMPLER2D;case t.SAMPLER_CUBE:return Ai.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Ai.UNKNOWN}}function C0(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function A0(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}y0._instance=null;var b0,w0=[512,513,514,515,516,517,518,519],R0=[0,7680,7681,7682,7683,5386,34055,34056],P0=[32774,32778,32779,32775,32776],I0=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(b0||(b0={}));var D0=function e(t){K(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},O0=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b0.BEGIN_RENDER_PASS)).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new ur,e.clearFlag=rr.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return Z(n,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),n}(D0),N0=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b0.BIND_STATES)).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new sa,e}return Z(n,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0}}]),n}(D0),M0=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b0.DRAW)).drawInfo=new Cr,e}return Z(n,[{key:"clear",value:function(){}}]),n}(D0),k0=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b0.UPDATE_BUFFER)).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return Z(n,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),n}(D0),L0=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b0.COPY_BUFFER_TO_TEXTURE)).gpuTexture=null,e.buffers=[],e.regions=[],e}return Z(n,[{key:"clear",value:function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}]),n}(D0),B0=function(){function e(){K(this,e),this.cmds=new eu(1),this.beginRenderPassCmds=new eu(1),this.bindStatesCmds=new eu(1),this.drawCmds=new eu(1),this.updateBufferCmds=new eu(1),this.copyBufferToTextureCmds=new eu(1)}return Z(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function F0(e,t,n,i,r){if(t.usage&bi.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&bi.INDIRECT){t.indirects.clearDraws();for(var a=n.drawInfos,o=0;o<a.length;++o)t.indirects.setDrawInfo(i+o,a[o])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),z0.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),z0.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var z0={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function U0(e,t,n,i,r,a,o){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=t.colorAttachments[h];if(_.format!==Ei.UNKNOWN)switch(_.loadOp){case Vi.LOAD:break;case Vi.CLEAR:c.bs.targets[0].blendColorMask!==Gi.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case Vi.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Ei.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Vi.LOAD:break;case Vi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(a),l|=s.DEPTH_BUFFER_BIT;break;case Vi.DISCARD:}if(la[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Vi.LOAD:break;case Vi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(o),l|=s.STENCIL_BUFFER_BIT;break;case Vi.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var d=c.bs.targets[0].blendColorMask;if(d!==Gi.ALL){var p=(d&Gi.R)!==Gi.NONE,m=(d&Gi.G)!==Gi.NONE,v=(d&Gi.B)!==Gi.NONE,g=(d&Gi.A)!==Gi.NONE;s.colorMask(p,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function G0(e,t,n,i,r,a){var o,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,_=!1;if(t&&z0.gpuPipelineState!==t){if(z0.gpuPipelineState=t,z0.glPrimitive=t.glPrimitive,t.gpuShader){var f=t.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var d=t.rs;if(d){if(u.rs.cullMode!==d.cullMode){switch(d.cullMode){case Zi.NONE:l.disable(l.CULL_FACE);break;case Zi.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Zi.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=d.cullMode}var p=d.isFrontFaceCCW;u.rs.isFrontFaceCCW!==p&&(l.frontFace(p?l.CCW:l.CW),u.rs.isFrontFaceCCW=p),u.rs.depthBias===d.depthBias&&u.rs.depthBiasSlop===d.depthBiasSlop||(l.polygonOffset(d.depthBias,d.depthBiasSlop),u.rs.depthBias=d.depthBias,u.rs.depthBiasSlop=d.depthBiasSlop),u.rs.lineWidth!==d.lineWidth&&(l.lineWidth(d.lineWidth),u.rs.lineWidth=d.lineWidth)}var m=t.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(w0[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,w0[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,R0[m.stencilFailOpFront],R0[m.stencilZFailOpFront],R0[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,w0[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,R0[m.stencilFailOpBack],R0[m.stencilZFailOpBack],R0[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=t.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(P0[g.blendEq],P0[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(I0[g.blendSrc],I0[g.blendDst],I0[g.blendSrcAlpha],I0[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&Gi.R)!==Gi.NONE,(g.blendColorMask&Gi.G)!==Gi.NONE,(g.blendColorMask&Gi.B)!==Gi.NONE,(g.blendColorMask&Gi.A)!==Gi.NONE),y.blendColorMask=g.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var S=h.glBlocks.length,T=t.gpuPipelineLayout.dynamicOffsetIndices,E=0;E<S;E++){var C=h.glBlocks[E],A=i[C.set],b=A&&A.descriptorIndices[C.binding],w=b>=0&&A.gpuDescriptors[b],R=null,P=0;if(w&&w.gpuBuffer){var I=w.gpuBuffer,D=T[C.set],O=D&&D[C.binding];O>=0&&(P=r[O]),"vf32"in I?R=I.vf32:(P+=I.offset,R=I.gpuBuffer.vf32),P>>=2}if(R)for(var N=C.glActiveUniforms.length,M=0;M<N;M++){var k=C.glActiveUniforms[M];switch(k.glType){case l.BOOL:case l.INT:for(var L=0;L<k.array.length;++L){var B=k.offset+P+L;if(R[B]!==k.array[L]){for(var F=L,z=B;F<k.array.length;++F,++z)k.array[F]=R[z];l.uniform1iv(k.glLoc,k.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var U=0;U<k.array.length;++U){var G=k.offset+P+U;if(R[G]!==k.array[U]){for(var H=U,V=G;H<k.array.length;++H,++V)k.array[H]=R[V];l.uniform2iv(k.glLoc,k.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<k.array.length;++j){var W=k.offset+P+j;if(R[W]!==k.array[j]){for(var q=j,X=W;q<k.array.length;++q,++X)k.array[q]=R[X];l.uniform3iv(k.glLoc,k.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<k.array.length;++Y){var K=k.offset+P+Y;if(R[K]!==k.array[Y]){for(var Q=Y,Z=K;Q<k.array.length;++Q,++Z)k.array[Q]=R[Z];l.uniform4iv(k.glLoc,k.array);break}}break;case l.FLOAT:for(var J=0;J<k.array.length;++J){var $=k.offset+P+J;if(R[$]!==k.array[J]){for(var ee=J,te=$;ee<k.array.length;++ee,++te)k.array[ee]=R[te];l.uniform1fv(k.glLoc,k.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<k.array.length;++ne){var ie=k.offset+P+ne;if(R[ie]!==k.array[ne]){for(var re=ne,ae=ie;re<k.array.length;++re,++ae)k.array[re]=R[ae];l.uniform2fv(k.glLoc,k.array);break}}break;case l.FLOAT_VEC3:for(var oe=0;oe<k.array.length;++oe){var se=k.offset+P+oe;if(R[se]!==k.array[oe]){for(var ce=oe,le=se;ce<k.array.length;++ce,++le)k.array[ce]=R[le];l.uniform3fv(k.glLoc,k.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<k.array.length;++ue){var he=k.offset+P+ue;if(R[he]!==k.array[ue]){for(var _e=ue,fe=he;_e<k.array.length;++_e,++fe)k.array[_e]=R[fe];l.uniform4fv(k.glLoc,k.array);break}}break;case l.FLOAT_MAT2:for(var de=0;de<k.array.length;++de){var pe=k.offset+P+de;if(R[pe]!==k.array[de]){for(var me=de,ve=pe;me<k.array.length;++me,++ve)k.array[me]=R[ve];l.uniformMatrix2fv(k.glLoc,!1,k.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<k.array.length;++ge){var ye=k.offset+P+ge;if(R[ye]!==k.array[ge]){for(var xe=ge,Se=ye;xe<k.array.length;++xe,++Se)k.array[xe]=R[Se];l.uniformMatrix3fv(k.glLoc,!1,k.array);break}}break;case l.FLOAT_MAT4:for(var Te=0;Te<k.array.length;++Te){var Ee=k.offset+P+Te;if(R[Ee]!==k.array[Te]){for(var Ce=Te,Ae=Ee;Ce<k.array.length;++Ce,++Ae)k.array[Ce]=R[Ae];l.uniformMatrix4fv(k.glLoc,!1,k.array);break}}}}else x("Buffer binding '".concat(C.name,"' at set ").concat(C.set," binding ").concat(C.binding," is not bounded"))}for(var be=h.glSamplerTextures.length,we=0;we<be;we++)for(var Re=h.glSamplerTextures[we],Pe=i[Re.set],Ie=Pe&&Pe.descriptorIndices[Re.binding],De=Ie>=0&&Pe.gpuDescriptors[Ie],Oe=Re.units.length,Ne=0;Ne<Oe;Ne++){var Me=Re.units[Ne];if(De&&De.gpuSampler){if(De.gpuTexture&&De.gpuTexture.size>0){var ke=De.gpuTexture,Le=u.glTexUnits[Me];Le.glTexture!==ke.glTexture&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),ke.glTexture?l.bindTexture(ke.glTarget,ke.glTexture):l.bindTexture(ke.glTarget,e.nullTex2D.gpuTexture.glTexture),Le.glTexture=ke.glTexture);var Be=De.gpuSampler;ke.isPowerOf2?(o=Be.glWrapS,s=Be.glWrapT):(o=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=ke.isPowerOf2?ke.mipLevel<=1&&(Be.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Be.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Be.glMinFilter:Be.glMinFilter===l.LINEAR||Be.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Be.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,ke.glWrapS!==o&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(ke.glTarget,l.TEXTURE_WRAP_S,o),ke.glWrapS=o),ke.glWrapT!==s&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(ke.glTarget,l.TEXTURE_WRAP_T,s),ke.glWrapT=s),ke.glMinFilter!==c&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(ke.glTarget,l.TEXTURE_MIN_FILTER,c),ke.glMinFilter=c),ke.glMagFilter!==Be.glMagFilter&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(ke.glTarget,l.TEXTURE_MAG_FILTER,Be.glMagFilter),ke.glMagFilter=Be.glMagFilter)}De=Pe.gpuDescriptors[++Ie]}else x("Sampler binding '".concat(Re.name,"' at set ").concat(Re.set," binding ").concat(Re.binding," index ").concat(Ne," is not bounded"))}}if(n&&h&&(_||z0.gpuInputAssembler!==n)){z0.gpuInputAssembler=n;var Fe=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var ze=e.extensions.OES_vertex_array_object,Ue=n.glVAOs.get(h.glProgram);if(!Ue){var Ge;Ue=ze.createVertexArrayOES(),n.glVAOs.set(h.glProgram,Ue),ze.bindVertexArrayOES(Ue),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var je=h.glInputs[Ve];Ge=null;for(var We=n.glAttribs.length,qe=0;qe<We;qe++){var Xe=n.glAttribs[qe];if(Xe.name===je.name){Ge=Xe;break}}if(Ge){u.glArrayBuffer!==Ge.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ge.glBuffer),u.glArrayBuffer=Ge.glBuffer);for(var Ye=0;Ye<Ge.componentCount;++Ye){var Ke=je.glLoc+Ye,Qe=Ge.offset+Ge.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,Ge.count,Ge.glType,Ge.isNormalized,Ge.stride,Qe),Fe&&Fe.vertexAttribDivisorANGLE(Ke,Ge.isInstanced?1:0)}}}var Ze=n.gpuIndexBuffer;Ze&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Ze.glBuffer),ze.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==Ue&&(ze.bindVertexArrayOES(Ue),u.glVAO=Ue)}else{for(var Je=0;Je<e.capabilities.maxVertexAttributes;++Je)u.glCurrentAttribLocs[Je]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var at=n.glAttribs[rt];if(at.name===tt.name){nt=at;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var ot=0;ot<nt.componentCount;++ot){var st=tt.glLoc+ot,ct=nt.offset+nt.size*ot;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),Fe&&Fe.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,_t=0;_t<ht;_t++)switch(t.dynamicStates[_t]){case Ji.LINE_WIDTH:u.rs.lineWidth!==a.lineWidth&&(l.lineWidth(a.lineWidth),u.rs.lineWidth=a.lineWidth);break;case Ji.DEPTH_BIAS:u.rs.depthBias===a.depthBiasConstant&&u.rs.depthBiasSlop===a.depthBiasSlope||(l.polygonOffset(a.depthBiasConstant,a.depthBiasSlope),u.rs.depthBias=a.depthBiasConstant,u.rs.depthBiasSlop=a.depthBiasSlope);break;case Ji.BLEND_CONSTANTS:var ft=a.blendConstant;u.bs.blendColor.x===ft.x&&u.bs.blendColor.y===ft.y&&u.bs.blendColor.z===ft.z&&u.bs.blendColor.w===ft.w||(l.blendColor(ft.x,ft.y,ft.z,ft.w),u.bs.blendColor.copy(ft));break;case Ji.STENCIL_WRITE_MASK:var dt=a.stencilStatesFront,pt=a.stencilStatesBack;u.dss.stencilWriteMaskFront!==dt.writeMask&&(l.stencilMaskSeparate(l.FRONT,dt.writeMask),u.dss.stencilWriteMaskFront=dt.writeMask),u.dss.stencilWriteMaskBack!==pt.writeMask&&(l.stencilMaskSeparate(l.BACK,pt.writeMask),u.dss.stencilWriteMaskBack=pt.writeMask);break;case Ji.STENCIL_COMPARE_MASK:var mt=a.stencilStatesFront,vt=a.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,w0[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,w0[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function H0(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,a=i.WEBGL_multi_draw,o=z0.gpuInputAssembler,s=z0.glPrimitive;if(o){var c=o.gpuIndexBuffer;if(o.gpuIndirectBuffer){var l=o.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(a)l.instancedDraw?a.multiDrawElementsInstancedWEBGL(s,l.counts,0,o.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):a.multiDrawElementsWEBGL(s,l.counts,0,o.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],o.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],o.glIndexType,l.byteOffsets[h])}else if(a)l.instancedDraw?a.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):a.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var f=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,o.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var d=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,o.glIndexType,d)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var V0=new Array(b0.COUNT);function j0(e,t){V0.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=V0[i]++;switch(i){case b0.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[r];U0(e,a.gpuRenderPass,a.gpuFramebuffer,a.renderArea,a.clearColors,a.clearDepth,a.clearStencil);break;case b0.BIND_STATES:var o=t.bindStatesCmds.array[r];G0(e,o.gpuPipelineState,o.gpuInputAssembler,o.gpuDescriptorSets,o.dynamicOffsets,o.dynamicStates);break;case b0.DRAW:H0(e,t.drawCmds.array[r].drawInfo);break;case b0.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];F0(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case b0.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];W0(e,c.buffers,c.gpuTexture,c.regions)}}}function W0(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=1,c=1,l=0,u=la[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[o++];u?n.glInternalFmt===v0.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[o++];u?n.glInternalFmt===v0.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Oi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var q0=function(){function e(){K(this,e),this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}return Z(e,[{key:"clearDraws",value:function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1}},{key:"setDrawInfo",value:function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)}},{key:"_ensureCapacity",value:function(e){if(!(this._capacity>e)){this._capacity=r(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}}}]),e}(),X0=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}return Z(n,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}},{key:"initialize",value:function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&bi.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new q0,glTarget:0,glBuffer:null},this._usage&bi.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&bi.VERTEX){t.glTarget=n.ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),z0.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&bi.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),z0.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&bi.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&bi.INDIRECT||t.usage&bi.TRANSFER_DST||t.usage&bi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(y0.instance,this._gpuBuffer),y0.instance.memoryStatus.bufferSize+=this._size}},{key:"destroy",value:function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),z0.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),z0.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(y0.instance,this._gpuBuffer),y0.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)}},{key:"resize",value:function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&bi.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),z0.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&bi.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),z0.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&bi.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&bi.INDIRECT||t.usage&bi.TRANSFER_DST||t.usage&bi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(y0.instance,this._gpuBuffer),y0.instance.memoryStatus.bufferSize-=t,y0.instance.memoryStatus.bufferSize+=e)))}}},{key:"update",value:function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&bi.INDIRECT?0:e.byteLength,F0(y0.instance,this._gpuBuffer,e,0,n))}}]),n}(xa),Y0=function(){function e(t,n){K(this,e),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(n),this._freeCmds=new eu(n);for(var i=0;i<n;++i)this._frees[i]=new t;this._freeIdx=n-1}return Z(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var a=i,o=0;a<t;++a,++o)this._frees[a]=n[o];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),K0=function(){function e(){K(this,e),this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new Y0(O0,1),this.bindStatesCmdPool=new Y0(N0,1),this.drawCmdPool=new Y0(M0,1),this.updateBufferCmdPool=new Y0(k0,1),this.copyBufferToTextureCmdPool=new Y0(L0,1)}return Z(e,[{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),e}(),Q0=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).cmdPackage=new B0,e._cmdAllocator=new K0,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new sa,e._isStateInvalied=!1,e}return Z(n,[{key:"initialize",value:function(e){this._type=e.type,this._queue=e.queue;for(var t=y0.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)}},{key:"destroy",value:function(){this._cmdAllocator.clearCmds(this.cmdPackage)}},{key:"begin",value:function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,n,i,r,a){var o=this._cmdAllocator.beginRenderPassCmdPool.alloc(O0);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea=n,o.clearColors.length=i.length;for(var s=0;s<i.length;++s)o.clearColors[s]=i[s];o.clearDepth=r,o.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(b0.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}},{key:"bindDescriptorSet",value:function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,a=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(a){for(var o=this._curDynamicOffsets,s=a.dynamicOffsetOffsets[e],c=0;c<n.length;c++)o[s+c]=n[c];this._isStateInvalied=!0}}}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)}},{key:"setLineWidth",value:function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&$i.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&$i.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&$i.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&$i.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))}},{key:"draw",value:function(e){if(this._type===ir.PRIMARY&&this._isInRenderPass||this._type===ir.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(M0);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(b0.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,n){if(this._type===ir.PRIMARY&&!this._isInRenderPass||this._type===ir.SECONDARY){var i=e.gpuBuffer;if(i){var r,a=this._cmdAllocator.updateBufferCmdPool.alloc(k0),o=0;e.usage&bi.INDIRECT||(o=void 0!==n?n:t.byteLength),r=t,a.gpuBuffer=i,a.buffer=r,a.offset=0,a.size=o,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(b0.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBuffersToTexture",value:function(e,t,n){if(this._type===ir.PRIMARY&&!this._isInRenderPass||this._type===ir.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(L0);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(b0.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var a=i.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var o=0;o<i.cmdPackage.bindStatesCmds.length;++o){var s=i.cmdPackage.bindStatesCmds.array[o];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}}},{key:"pipelineBarrier",value:function(){}},{key:"bindStates",value:function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(N0);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(b0.BIND_STATES),this._isStateInvalied=!1)}}]),n}(Sa),Z0=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuFramebuffer=null,e}return Z(n,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}},{key:"initialize",value:function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;++n){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var a=Number.MAX_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorTextures[0].width},set width(e){a=e},get height(){return this.isOffscreen?o:this.gpuColorTextures[0].height},set height(e){o=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],a=i.createFramebuffer();if(a){t.glFramebuffer=a,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var o=0;o<t.gpuColorTextures.length;++o){var s=t.gpuColorTextures[o];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+o),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=la[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(y0.instance,this._gpuFramebuffer)}},{key:"destroy",value:function(){var e,t;this._gpuFramebuffer&&(e=y0.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)}}]),n}(Ca),J0=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuInputAssembler=null,e}return Z(n,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}},{key:"initialize",value:function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var a=null,o=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:a,gpuIndirectBuffer:s,glAttribs:[],glIndexType:o,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],o=void 0!==a.stream?a.stream:0,s=t.gpuVertexBuffers[o],c=x0(a.format,n),l=la[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:s.glBuffer,glType:c,size:l,count:la[a.format].count,stride:s.stride,componentCount:A0(c,n),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:i[o]},i[o]+=l}}(y0.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")}},{key:"destroy",value:function(){var e=y0.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.extensions.OES_vertex_array_object,a=e.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),a===i.value&&(r.bindVertexArrayOES(null),a=null),i=n.next();e.stateCache.glVAO=a,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}}]),n}(Ra),$0=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuDescriptorSetLayout=null,e}return Z(n,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}},{key:"initialize",value:function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var a=this._bindings[r];i.push(t),t+=a.count,a.binding>n&&(n=a.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var o=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,o[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&_a)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:o,descriptorCount:t}}},{key:"destroy",value:function(){this._bindings.length=0}}]),n}(Ia),e1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuPipelineLayout=null,e}return Z(n,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}},{key:"initialize",value:function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],a=0;a<this._setLayouts.length;a++){for(var o=this._setLayouts[a],s=o.gpuDescriptorSetLayout.dynamicBindings,c=Array(o.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(o.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}}},{key:"destroy",value:function(){this._setLayouts.length=0}}]),n}(Da),t1=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],n1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuPipelineState=null,e}return Z(n,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}},{key:"initialize",value:function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],a=0;a<31;a++)this._dynamicStates&1<<a&&r.push(1<<a);this._gpuPipelineState={glPrimitive:t1[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}}},{key:"destroy",value:function(){this._gpuPipelineState=null}}]),n}(Ba),i1=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"beginRenderPass",value:function(e,t,n,i,r,a){U0(y0.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,a),this._isInRenderPass=!0}},{key:"draw",value:function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;H0(y0.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"setViewport",value:function(e){var t=y0.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)}},{key:"setScissor",value:function(e){var t=y0.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)}},{key:"updateBuffer",value:function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&bi.INDIRECT?0:t.byteLength,F0(y0.instance,r,t,0,i))}}},{key:"copyBuffersToTexture",value:function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&W0(y0.instance,e,i,n)}}},{key:"execute",value:function(e,t){for(var n=0;n<t;++n){var i=e[n];j0(y0.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}}},{key:"bindStates",value:function(){G0(y0.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}}]),n}(Q0),r1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}return Z(n,[{key:"initialize",value:function(e){this._type=e.type}},{key:"destroy",value:function(){}},{key:"submit",value:function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}]),n}(Fa),a1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuRenderPass=null,e}return Z(n,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}},{key:"initialize",value:function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()}},{key:"destroy",value:function(){this._gpuRenderPass=null}}]),n}(za),o1=[10497,33648,33071,33071],s1=function(e){te(n,e);var t=le(n);function n(e,i){var r;K(this,n),(r=t.call(this,e,i))._gpuSampler=null;var a,o,s=r._info.minFilter,c=r._info.magFilter,l=r._info.mipFilter;a=s===ki.LINEAR||s===ki.ANISOTROPIC?l===ki.LINEAR||l===ki.ANISOTROPIC?9987:l===ki.POINT?9985:9729:l===ki.LINEAR||l===ki.ANISOTROPIC?9986:l===ki.POINT?9984:9728,o=c===ki.LINEAR||c===ki.ANISOTROPIC?9729:9728;var u=o1[r._info.addressU],h=o1[r._info.addressV],_=o1[r._info.addressW];return r._gpuSampler={glMinFilter:a,glMagFilter:o,glWrapS:u,glWrapT:h,glWrapR:_},r}return Z(n,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),n}(Ua),c1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuShader=null,e}return Z(n,[{key:"gpuShader",get:function(){return this._gpuShader}},{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,a="",o=1;switch(i.type){case Hi.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case Hi.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error("".concat(a," in '").concat(t.name,"' compilation failed.")),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n".concat(o++," ")}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var a=i(r);if("object"===Y(a))return a.v}var o=n.createProgram();if(o){t.glProgram=o;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '".concat(t.name,"'.")),void console.error(n.getProgramInfoLog(t.glProgram));T("Shader '".concat(t.name,"' compilation succeeded."));var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(t.glProgram,d),v=E0(f.type,n),g=C0(f.type,n);t.glInputs[_]={binding:m,name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var y=0;y<t.blocks.length;++y){var x=t.blocks[y],S={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};t.glBlocks[y]=S;for(var E=0;E<x.members.length;++E){var C=x.members[E],A=S0(C.type,n),b=C0(A,n),w=b*C.count;S.glUniforms[E]={binding:-1,name:C.name,type:C.type,stride:b,count:C.count,size:w,offset:0,glType:A,glLoc:null,array:null}}}}for(var R=0;R<t.subpassInputs.length;++R){var P=t.subpassInputs[R];t.samplerTextures.push(new Or(P.set,P.binding,P.name,Ai.SAMPLER2D,P.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var I=0;I<t.samplerTextures.length;++I){var D=t.samplerTextures[I];t.glSamplerTextures[I]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:S0(D.type,n),glLoc:null}}}for(var O=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),N=0;N<O;++N){var M=n.getActiveUniform(t.glProgram,N);if(M&&M.type!==n.SAMPLER_2D&&M.type!==n.SAMPLER_CUBE){var k=n.getUniformLocation(t.glProgram,M.name);if(e.extensions.isLocationActive(k)){var L,B=M.name.indexOf("[");L=-1!==B?M.name.substr(0,B):M.name;for(var F=0;F<t.glBlocks.length;F++)for(var z=t.glBlocks[F],U=0;U<z.glUniforms.length;U++){var G=z.glUniforms[U];if(G.name===L){G.glLoc=k,G.count=M.size,G.size=G.stride*G.count,G.array=new(T0(G.type))(G.size/4),z.glActiveUniforms.push(G);break}}}}}for(var H=0;H<t.glBlocks.length;H++)for(var V=t.glBlocks[H],j=0;j<V.glUniforms.length;j++){var W=V.glUniforms[j];W.offset=V.size/4,V.size+=W.size}for(var q=[],X=[],K=e.bindingMappingInfo,Q=e.stateCache.texUnitCacheMap,Z=0,J=0;J<t.blocks.length;++J)t.blocks[J].set===K.flexibleSet&&Z++;for(var $=0,ee=0;ee<t.samplerTextures.length;++ee){var te=t.samplerTextures[ee],ne=n.getUniformLocation(t.glProgram,te.name);if(e.extensions.isLocationActive(ne)&&(q.push(t.glSamplerTextures[ee]),X.push(ne)),void 0===Q[te.name]){var ie=te.binding+K.samplerOffsets[te.set]+$;te.set===K.flexibleSet&&(ie-=Z),Q[te.name]=ie%e.capabilities.maxTextureUnits,$+=te.count-1}}if(q.length){for(var re=[],ae=0;ae<q.length;++ae){var oe=q[ae],se=Q[oe.name];if(void 0!==se){oe.glLoc=X[ae];for(var ce=0;ce<oe.count;++ce){for(;re[se];)se=(se+1)%e.capabilities.maxTextureUnits;oe.units.push(se),re[se]=!0}}}for(var le=0,ue=0;ue<q.length;++ue){var he=q[ue];if(!e.extensions.isLocationActive(he.glLoc)){he.glLoc=X[ue];for(var _e=0;_e<he.count;++_e){for(;re[le];)le=(le+1)%e.capabilities.maxTextureUnits;void 0===Q[he.name]&&(Q[he.name]=le),he.units.push(le),re[le]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var fe=0;fe<q.length;fe++){var de=q[fe];de.glUnits=new Int32Array(de.units),n.uniform1iv(de.glLoc,de.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var pe=0;pe<t.glBlocks.length;)t.glBlocks[pe].glActiveUniforms.length?pe++:(t.glBlocks[pe]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}(y0.instance,this._gpuShader)}},{key:"destroy",value:function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}(y0.instance,this._gpuShader),this._gpuShader=null)}}]),n}(Ga),l1=function(){function e(){K(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new vr,this.scissorRect=new ur(0,0,0,0),this.rs=new Oa,this.dss=new Na,this.bs=new ka,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return Z(e,[{key:"initialize",value:function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)}}]),e}(),u1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuTexture=null,e}return Z(n,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"initialize",value:function(e,t){"texture"in e?console.log("WebGL does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=fa(this._width)&&fa(this._height),this._size=pa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case Ei.A8:return t.ALPHA;case Ei.L8:return t.LUMINANCE;case Ei.LA8:return t.LUMINANCE_ALPHA;case Ei.RGB8:case Ei.RGB16F:case Ei.RGB32F:return t.RGB;case Ei.BGRA8:case Ei.RGBA8:case Ei.SRGB8_A8:case Ei.RGBA16F:case Ei.RGBA32F:return t.RGBA;case Ei.R5G6B5:return t.RGB;case Ei.RGB5A1:case Ei.RGBA4:return t.RGBA;case Ei.DEPTH:return t.DEPTH_COMPONENT;case Ei.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Ei.BC1:return v0.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ei.BC1_ALPHA:return v0.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ei.BC1_SRGB:return v0.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ei.BC1_SRGB_ALPHA:return v0.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ei.BC2:return v0.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ei.BC2_SRGB:return v0.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ei.BC3:return v0.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ei.BC3_SRGB:return v0.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ei.ETC_RGB8:return v0.COMPRESSED_RGB_ETC1_WEBGL;case Ei.ETC2_RGB8:return v0.COMPRESSED_RGB8_ETC2;case Ei.ETC2_SRGB8:return v0.COMPRESSED_SRGB8_ETC2;case Ei.ETC2_RGB8_A1:return v0.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ei.ETC2_SRGB8_A1:return v0.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ei.ETC2_RGBA8:return v0.COMPRESSED_RGBA8_ETC2_EAC;case Ei.ETC2_SRGB8_A8:return v0.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ei.EAC_R11:return v0.COMPRESSED_R11_EAC;case Ei.EAC_R11SN:return v0.COMPRESSED_SIGNED_R11_EAC;case Ei.EAC_RG11:return v0.COMPRESSED_RG11_EAC;case Ei.EAC_RG11SN:return v0.COMPRESSED_SIGNED_RG11_EAC;case Ei.PVRTC_RGB2:return v0.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ei.PVRTC_RGBA2:return v0.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ei.PVRTC_RGB4:return v0.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ei.PVRTC_RGBA4:return v0.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Ei.ASTC_RGBA_4X4:return v0.COMPRESSED_RGBA_ASTC_4x4_KHR;case Ei.ASTC_RGBA_5X4:return v0.COMPRESSED_RGBA_ASTC_5x4_KHR;case Ei.ASTC_RGBA_5X5:return v0.COMPRESSED_RGBA_ASTC_5x5_KHR;case Ei.ASTC_RGBA_6X5:return v0.COMPRESSED_RGBA_ASTC_6x5_KHR;case Ei.ASTC_RGBA_6X6:return v0.COMPRESSED_RGBA_ASTC_6x6_KHR;case Ei.ASTC_RGBA_8X5:return v0.COMPRESSED_RGBA_ASTC_8x5_KHR;case Ei.ASTC_RGBA_8X6:return v0.COMPRESSED_RGBA_ASTC_8x6_KHR;case Ei.ASTC_RGBA_8X8:return v0.COMPRESSED_RGBA_ASTC_8x8_KHR;case Ei.ASTC_RGBA_10X5:return v0.COMPRESSED_RGBA_ASTC_10x5_KHR;case Ei.ASTC_RGBA_10X6:return v0.COMPRESSED_RGBA_ASTC_10x6_KHR;case Ei.ASTC_RGBA_10X8:return v0.COMPRESSED_RGBA_ASTC_10x8_KHR;case Ei.ASTC_RGBA_10X10:return v0.COMPRESSED_RGBA_ASTC_10x10_KHR;case Ei.ASTC_RGBA_12X10:return v0.COMPRESSED_RGBA_ASTC_12x10_KHR;case Ei.ASTC_RGBA_12X12:return v0.COMPRESSED_RGBA_ASTC_12x12_KHR;case Ei.ASTC_SRGBA_4X4:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Ei.ASTC_SRGBA_5X4:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Ei.ASTC_SRGBA_5X5:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Ei.ASTC_SRGBA_6X5:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Ei.ASTC_SRGBA_6X6:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Ei.ASTC_SRGBA_8X5:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Ei.ASTC_SRGBA_8X6:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Ei.ASTC_SRGBA_8X8:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Ei.ASTC_SRGBA_10X5:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Ei.ASTC_SRGBA_10X6:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Ei.ASTC_SRGBA_10X8:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Ei.ASTC_SRGBA_10X10:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Ei.ASTC_SRGBA_12X10:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Ei.ASTC_SRGBA_12X12:return v0.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=x0(t.format,n);var i=t.width,r=t.height;switch(t.type){case Ii.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&D(9100,a,e.capabilities.maxTextureSize),!e.extensions.WEBGL_depth_texture&&la[t.format].hasDepth)t.glInternalFmt=function(e,t){switch(e){case Ei.R5G6B5:return t.RGB565;case Ei.RGB5A1:return t.RGB5_A1;case Ei.RGBA4:return t.RGBA4;case Ei.RGBA16F:return v0.RGBA16F_EXT;case Ei.RGBA32F:return v0.RGBA32F_EXT;case Ei.SRGB8_A8:return v0.SRGB8_ALPHA8_EXT;case Ei.DEPTH:return t.DEPTH_COMPONENT16;case Ei.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));else if(t.glTexture=n.createTexture(),t.size>0){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),la[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=da(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;case Ii.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&D(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),la[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=da(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Ii.TEX2D,t.glTarget=n.TEXTURE_2D}}(y0.instance,this._gpuTexture),y0.instance.memoryStatus.textureSize+=this._size)}},{key:"destroy",value:function(){this._gpuTexture&&(function(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var a=0;a<i.length;a++)i[a].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+a),r=a,n.bindTexture(t.glTarget,null),i[a].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var o=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),o===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),o=null),t.glRenderbuffer=null}}(y0.instance,this._gpuTexture),y0.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}},{key:"resize",value:function(e,t){var n=this._size;this._width=e,this._height=t,this._size=pa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Ii.TEX2D:t.glTarget=n.TEXTURE_2D;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&D(9100,a,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),la[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=da(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case Ii.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&D(9100,h,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),la[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=da(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Ii.TEX2D,t.glTarget=n.TEXTURE_2D}}}(y0.instance,this._gpuTexture),y0.instance.memoryStatus.textureSize-=n,y0.instance.memoryStatus.textureSize+=this._size)}},{key:"initAsSwapchainTexture",value:function(e){var t=new wr;t.format=e.format,t.usage=la[e.format].hasDepth?Di.DEPTH_STENCIL_ATTACHMENT:Di.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)}}]),n}(Ha),h1="webglcontextlost";function _1(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function f1(e){var t={EXT_texture_filter_anisotropic:_1(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:_1(e,"EXT_blend_minmax"),EXT_frag_depth:_1(e,"EXT_frag_depth"),EXT_shader_texture_lod:_1(e,"EXT_shader_texture_lod"),EXT_sRGB:_1(e,"EXT_sRGB"),OES_vertex_array_object:_1(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:_1(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:_1(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:_1(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:_1(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:_1(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:_1(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:_1(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:_1(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:_1(e,"WEBGL_draw_buffers"),WEBGL_lose_context:_1(e,"WEBGL_lose_context"),WEBGL_depth_texture:_1(e,"WEBGL_depth_texture"),OES_texture_half_float:_1(e,"OES_texture_half_float"),OES_texture_half_float_linear:_1(e,"OES_texture_half_float_linear"),OES_texture_float:_1(e,"OES_texture_float"),OES_texture_float_linear:_1(e,"OES_texture_float_linear"),OES_standard_derivatives:_1(e,"OES_standard_derivatives"),OES_element_index_uint:_1(e,"OES_element_index_uint"),ANGLE_instanced_arrays:_1(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:_1(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return Eu.os===du.IOS&&14===Eu.osMainVersion&&Eu.isBrowser||(t.WEBGL_compressed_texture_astc=_1(e,"WEBGL_compressed_texture_astc")),Eu.os!==du.ANDROID&&Eu.os!==du.IOS&&(t.WEBGL_multi_draw=_1(e,"WEBGL_multi_draw")),Eu.browserType===hu.UC&&(t.ANGLE_instanced_arrays=null),Eu.os===du.IOS&&Eu.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var d1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).stateCache=new l1,e.cmdAllocator=new K0,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e}return Z(n,[{key:"extensions",get:function(){return this._extensions}},{key:"initialize",value:function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(h1,this._onWebGLContextLost);var t=y0.instance.gl;this.stateCache.initialize(y0.instance.capabilities.maxTextureUnits,y0.instance.capabilities.maxVertexAttributes),this._extensions=f1(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=Ei.RGBA8,i=Ei.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),a=t.getParameter(t.STENCIL_BITS);r&&a?i=Ei.DEPTH_STENCIL:r&&(i=Ei.DEPTH),this._colorTexture=new u1,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new u1,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=y0.instance.createTexture(new wr(Ii.TEX2D,Di.SAMPLED,Ei.RGBA8,2,2,Oi.GEN_MIPMAP)),this.nullTexCube=y0.instance.createTexture(new wr(Ii.CUBE,Di.SAMPLED,Ei.RGBA8,2,2,Oi.GEN_MIPMAP,6));var o=new mr;o.texExtent.width=2,o.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),y0.instance.copyBuffersToTexture([s],this.nullTex2D,[o]),o.texSubres.layerCount=6,y0.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[o])}},{key:"destroy",value:function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(h1,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null}},{key:"resize",value:function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(T("Resizing swapchain: ".concat(e,"x").concat(t)),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))}},{key:"_onWebGLContextLost",value:function(e){P(11e3),y(e)}}]),n}(Ea),p1=e("WebGLDevice",function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._swapchain=null,e._context=null,e}return Z(n,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"initialize",value:function(e){y0.setInstance(this),this._gfxAPI=xi.WEBGL,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:St.ENABLE_TRANSPARENT_CANVAS,antialias:St.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(Ta.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new na(tr.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new ta(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var n=t.getSupportedExtensions(),i="";if(n)for(var r,a=ge(n);!(r=a()).done;){var o=r.value;i+="".concat(o," ")}var s=f1(t);s.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(s.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(s.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var c=t.getParameter(t.VERSION);this._features.fill(!1),s.EXT_sRGB&&(this._features[Ti.FORMAT_SRGB]=!0),s.EXT_blend_minmax&&(this._features[Ti.BLEND_MINMAX]=!0),s.WEBGL_color_buffer_float&&(this._features[Ti.COLOR_FLOAT]=!0),s.EXT_color_buffer_half_float&&(this._features[Ti.COLOR_HALF_FLOAT]=!0),s.OES_texture_float&&(this._features[Ti.TEXTURE_FLOAT]=!0),s.OES_texture_half_float&&(this._features[Ti.TEXTURE_HALF_FLOAT]=!0),s.OES_texture_float_linear&&(this._features[Ti.TEXTURE_FLOAT_LINEAR]=!0),s.OES_texture_half_float_linear&&(this._features[Ti.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[Ti.FORMAT_RGB8]=!0,s.OES_element_index_uint&&(this._features[Ti.ELEMENT_INDEX_UINT]=!0),s.ANGLE_instanced_arrays&&(this._features[Ti.INSTANCED_ARRAYS]=!0),s.WEBGL_draw_buffers&&(this._features[Ti.MULTIPLE_RENDER_TARGETS]=!0);var l="";return s.WEBGL_compressed_texture_etc1&&(this._features[Ti.FORMAT_ETC1]=!0,l+="etc1 "),s.WEBGL_compressed_texture_etc&&(this._features[Ti.FORMAT_ETC2]=!0,l+="etc2 "),s.WEBGL_compressed_texture_s3tc&&(this._features[Ti.FORMAT_DXT]=!0,l+="dxt "),s.WEBGL_compressed_texture_pvrtc&&(this._features[Ti.FORMAT_PVRTC]=!0,l+="pvrtc "),s.WEBGL_compressed_texture_astc&&(this._features[Ti.FORMAT_ASTC]=!0,l+="astc "),T("WebGL device initialized."),T("RENDERER: ".concat(this._renderer)),T("VENDOR: ".concat(this._vendor)),T("VERSION: ".concat(c)),T("COMPRESSED_FORMAT: ".concat(l)),T("EXTENSIONS: ".concat(i)),!0}},{key:"destroy",value:function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"flushCommands",value:function(){}},{key:"acquire",value:function(){}},{key:"present",value:function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}},{key:"createCommandBuffer",value:function(e){var t=new(e.type===ir.PRIMARY?i1:Q0);return t.initialize(e),t}},{key:"createSwapchain",value:function(e){var t=new d1;return this._swapchain=t,t.initialize(e),t}},{key:"createBuffer",value:function(e){var t=new X0;return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new u1;return t.initialize(e),t}},{key:"createDescriptorSet",value:function(e){var t=new g0;return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new c1;return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new J0;return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new a1;return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new Z0;return t.initialize(e),t}},{key:"createDescriptorSetLayout",value:function(e){var t=new $0;return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new e1;return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new n1;return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new r1;return t.initialize(e),t}},{key:"getSampler",value:function(e){var t=Ua.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new s1(e,t)),this._samplers.get(t)}},{key:"getGlobalBarrier",value:function(e){var t=Va.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new Va(e,t)),this._globalBarriers.get(t)}},{key:"getTextureBarrier",value:function(e){var t=ja.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new ja(e,t)),this._textureBarriers.get(t)}},{key:"copyBuffersToTexture",value:function(e,t,n){W0(this,e,t.gpuTexture,n)}},{key:"copyTextureToBuffers",value:function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache,o=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,o);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),a.glFramebuffer=null,r.deleteFramebuffer(o)}(this,e.gpuTexture,t,n)}},{key:"copyTexImagesToTexture",value:function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Oi.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)}}]),n}(Ta));c.WebGLDevice=p1;var m1,v1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuDescriptorSet=null,e}return Z(n,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}},{key:"initialize",value:function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var a=[];this._gpuDescriptorSet={gpuDescriptors:a,descriptorIndices:i};for(var o=0;o<n.length;++o)for(var s=n[o],c=0;c<s.count;c++)a.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}},{key:"destroy",value:function(){this._layout=null,this._gpuDescriptorSet=null}},{key:"update",value:function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&ua?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&ha&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}}]),n}(Pa);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(m1||(m1={}));var g1=function(){function e(){K(this,e)}return Z(e,null,[{key:"instance",get:function(){return e._instance}},{key:"setInstance",value:function(t){e._instance=t}}]),e}();g1._instance=null;var y1=[10497,33648,33071,33071],x1=new Float32Array(4);function S1(e,t){switch(e){case Ei.R8:return t.UNSIGNED_BYTE;case Ei.R8SN:return t.BYTE;case Ei.R8UI:return t.UNSIGNED_BYTE;case Ei.R8I:return t.BYTE;case Ei.R16F:return t.HALF_FLOAT;case Ei.R16UI:return t.UNSIGNED_SHORT;case Ei.R16I:return t.SHORT;case Ei.R32F:return t.FLOAT;case Ei.R32UI:return t.UNSIGNED_INT;case Ei.R32I:return t.INT;case Ei.RG8:return t.UNSIGNED_BYTE;case Ei.RG8SN:return t.BYTE;case Ei.RG8UI:return t.UNSIGNED_BYTE;case Ei.RG8I:return t.BYTE;case Ei.RG16F:return t.HALF_FLOAT;case Ei.RG16UI:return t.UNSIGNED_SHORT;case Ei.RG16I:return t.SHORT;case Ei.RG32F:return t.FLOAT;case Ei.RG32UI:return t.UNSIGNED_INT;case Ei.RG32I:return t.INT;case Ei.RGB8:case Ei.SRGB8:return t.UNSIGNED_BYTE;case Ei.RGB8SN:return t.BYTE;case Ei.RGB8UI:return t.UNSIGNED_BYTE;case Ei.RGB8I:return t.BYTE;case Ei.RGB16F:return t.HALF_FLOAT;case Ei.RGB16UI:return t.UNSIGNED_SHORT;case Ei.RGB16I:return t.SHORT;case Ei.RGB32F:return t.FLOAT;case Ei.RGB32UI:return t.UNSIGNED_INT;case Ei.RGB32I:return t.INT;case Ei.BGRA8:case Ei.RGBA8:case Ei.SRGB8_A8:return t.UNSIGNED_BYTE;case Ei.RGBA8SN:return t.BYTE;case Ei.RGBA8UI:return t.UNSIGNED_BYTE;case Ei.RGBA8I:return t.BYTE;case Ei.RGBA16F:return t.HALF_FLOAT;case Ei.RGBA16UI:return t.UNSIGNED_SHORT;case Ei.RGBA16I:return t.SHORT;case Ei.RGBA32F:return t.FLOAT;case Ei.RGBA32UI:return t.UNSIGNED_INT;case Ei.RGBA32I:return t.INT;case Ei.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Ei.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case Ei.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Ei.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Ei.RGB10A2:case Ei.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case Ei.RGB9E5:case Ei.DEPTH:return t.FLOAT;case Ei.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case Ei.BC1:case Ei.BC1_SRGB:case Ei.BC2:case Ei.BC2_SRGB:case Ei.BC3:case Ei.BC3_SRGB:case Ei.BC4:return t.UNSIGNED_BYTE;case Ei.BC4_SNORM:return t.BYTE;case Ei.BC5:return t.UNSIGNED_BYTE;case Ei.BC5_SNORM:return t.BYTE;case Ei.BC6H_SF16:case Ei.BC6H_UF16:return t.FLOAT;case Ei.BC7:case Ei.BC7_SRGB:case Ei.ETC_RGB8:case Ei.ETC2_RGB8:case Ei.ETC2_SRGB8:case Ei.ETC2_RGB8_A1:case Ei.ETC2_SRGB8_A1:case Ei.EAC_R11:return t.UNSIGNED_BYTE;case Ei.EAC_R11SN:return t.BYTE;case Ei.EAC_RG11:return t.UNSIGNED_BYTE;case Ei.EAC_RG11SN:return t.BYTE;case Ei.PVRTC_RGB2:case Ei.PVRTC_RGBA2:case Ei.PVRTC_RGB4:case Ei.PVRTC_RGBA4:case Ei.PVRTC2_2BPP:case Ei.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Ei.ASTC_RGBA_4X4:case Ei.ASTC_RGBA_5X4:case Ei.ASTC_RGBA_5X5:case Ei.ASTC_RGBA_6X5:case Ei.ASTC_RGBA_6X6:case Ei.ASTC_RGBA_8X5:case Ei.ASTC_RGBA_8X6:case Ei.ASTC_RGBA_8X8:case Ei.ASTC_RGBA_10X5:case Ei.ASTC_RGBA_10X6:case Ei.ASTC_RGBA_10X8:case Ei.ASTC_RGBA_10X10:case Ei.ASTC_RGBA_12X10:case Ei.ASTC_RGBA_12X12:case Ei.ASTC_SRGBA_4X4:case Ei.ASTC_SRGBA_5X4:case Ei.ASTC_SRGBA_5X5:case Ei.ASTC_SRGBA_6X5:case Ei.ASTC_SRGBA_6X6:case Ei.ASTC_SRGBA_8X5:case Ei.ASTC_SRGBA_8X6:case Ei.ASTC_SRGBA_8X8:case Ei.ASTC_SRGBA_10X5:case Ei.ASTC_SRGBA_10X6:case Ei.ASTC_SRGBA_10X8:case Ei.ASTC_SRGBA_10X10:case Ei.ASTC_SRGBA_12X10:case Ei.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function T1(e,t){switch(e){case Ai.BOOL:return t.BOOL;case Ai.BOOL2:return t.BOOL_VEC2;case Ai.BOOL3:return t.BOOL_VEC3;case Ai.BOOL4:return t.BOOL_VEC4;case Ai.INT:return t.INT;case Ai.INT2:return t.INT_VEC2;case Ai.INT3:return t.INT_VEC3;case Ai.INT4:return t.INT_VEC4;case Ai.UINT:return t.UNSIGNED_INT;case Ai.FLOAT:return t.FLOAT;case Ai.FLOAT2:return t.FLOAT_VEC2;case Ai.FLOAT3:return t.FLOAT_VEC3;case Ai.FLOAT4:return t.FLOAT_VEC4;case Ai.MAT2:return t.FLOAT_MAT2;case Ai.MAT2X3:return t.FLOAT_MAT2x3;case Ai.MAT2X4:return t.FLOAT_MAT2x4;case Ai.MAT3X2:return t.FLOAT_MAT3x2;case Ai.MAT3:return t.FLOAT_MAT3;case Ai.MAT3X4:return t.FLOAT_MAT3x4;case Ai.MAT4X2:return t.FLOAT_MAT4x2;case Ai.MAT4X3:return t.FLOAT_MAT4x3;case Ai.MAT4:return t.FLOAT_MAT4;case Ai.SAMPLER2D:return t.SAMPLER_2D;case Ai.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case Ai.SAMPLER3D:return t.SAMPLER_3D;case Ai.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Ai.UNKNOWN}}function E1(e,t){switch(e){case t.BOOL:return Ai.BOOL;case t.BOOL_VEC2:return Ai.BOOL2;case t.BOOL_VEC3:return Ai.BOOL3;case t.BOOL_VEC4:return Ai.BOOL4;case t.INT:return Ai.INT;case t.INT_VEC2:return Ai.INT2;case t.INT_VEC3:return Ai.INT3;case t.INT_VEC4:return Ai.INT4;case t.UNSIGNED_INT:return Ai.UINT;case t.UNSIGNED_INT_VEC2:return Ai.UINT2;case t.UNSIGNED_INT_VEC3:return Ai.UINT3;case t.UNSIGNED_INT_VEC4:return Ai.UINT4;case t.FLOAT:return Ai.FLOAT;case t.FLOAT_VEC2:return Ai.FLOAT2;case t.FLOAT_VEC3:return Ai.FLOAT3;case t.FLOAT_VEC4:return Ai.FLOAT4;case t.FLOAT_MAT2:return Ai.MAT2;case t.FLOAT_MAT2x3:return Ai.MAT2X3;case t.FLOAT_MAT2x4:return Ai.MAT2X4;case t.FLOAT_MAT3x2:return Ai.MAT3X2;case t.FLOAT_MAT3:return Ai.MAT3;case t.FLOAT_MAT3x4:return Ai.MAT3X4;case t.FLOAT_MAT4x2:return Ai.MAT4X2;case t.FLOAT_MAT4x3:return Ai.MAT4X3;case t.FLOAT_MAT4:return Ai.MAT4;case t.SAMPLER_2D:return Ai.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return Ai.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return Ai.SAMPLER3D;case t.SAMPLER_CUBE:return Ai.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Ai.UNKNOWN}}function C1(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function A1(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var b1,w1=[512,513,514,515,516,517,518,519],R1=[0,7680,7681,7682,7683,5386,34055,34056],P1=[32774,32778,32779,32775,32776],I1=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(b1||(b1={}));var D1=function e(t){K(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},O1=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b1.BEGIN_RENDER_PASS)).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new ur,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return Z(n,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),n}(D1),N1=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b1.BIND_STATES)).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new sa,e}return Z(n,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0}}]),n}(D1),M1=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b1.DRAW)).drawInfo=new Cr,e}return Z(n,[{key:"clear",value:function(){}}]),n}(D1),k1=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b1.UPDATE_BUFFER)).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return Z(n,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),n}(D1),L1=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this,b1.COPY_BUFFER_TO_TEXTURE)).gpuTexture=null,e.buffers=[],e.regions=[],e}return Z(n,[{key:"clear",value:function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}]),n}(D1),B1=function(){function e(){K(this,e),this.cmds=new eu(1),this.beginRenderPassCmds=new eu(1),this.bindStatesCmds=new eu(1),this.drawCmds=new eu(1),this.updateBufferCmds=new eu(1),this.copyBufferToTextureCmds=new eu(1)}return Z(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function F1(e,t,n,i,r){if(t.usage&bi.INDIRECT){t.indirects.clearDraws();for(var a=n.drawInfos,o=0;o<a.length;++o)t.indirects.setDrawInfo(i+o,a[o])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),G1.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),G1.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function z1(e,t){var n=e.gl;t.glInternalFmt=function(e,t){switch(e){case Ei.A8:return t.ALPHA;case Ei.L8:return t.LUMINANCE;case Ei.LA8:return t.LUMINANCE_ALPHA;case Ei.R8:return t.R8;case Ei.R8SN:return t.R8_SNORM;case Ei.R8UI:return t.R8UI;case Ei.R8I:return t.R8I;case Ei.RG8:return t.RG8;case Ei.RG8SN:return t.RG8_SNORM;case Ei.RG8UI:return t.RG8UI;case Ei.RG8I:return t.RG8I;case Ei.RGB8:return t.RGB8;case Ei.RGB8SN:return t.RGB8_SNORM;case Ei.RGB8UI:return t.RGB8UI;case Ei.RGB8I:return t.RGB8I;case Ei.BGRA8:case Ei.RGBA8:return t.RGBA8;case Ei.RGBA8SN:return t.RGBA8_SNORM;case Ei.RGBA8UI:return t.RGBA8UI;case Ei.RGBA8I:return t.RGBA8I;case Ei.R16I:return t.R16I;case Ei.R16UI:return t.R16UI;case Ei.R16F:return t.R16F;case Ei.RG16I:return t.RG16I;case Ei.RG16UI:return t.RG16UI;case Ei.RG16F:return t.RG16F;case Ei.RGB16I:return t.RGB16I;case Ei.RGB16UI:return t.RGB16UI;case Ei.RGB16F:return t.RGB16F;case Ei.RGBA16I:return t.RGBA16I;case Ei.RGBA16UI:return t.RGBA16UI;case Ei.RGBA16F:return t.RGBA16F;case Ei.R32I:return t.R32I;case Ei.R32UI:return t.R32UI;case Ei.R32F:return t.R32F;case Ei.RG32I:return t.RG32I;case Ei.RG32UI:return t.RG32UI;case Ei.RG32F:return t.RG32F;case Ei.RGB32I:return t.RGB32I;case Ei.RGB32UI:return t.RGB32UI;case Ei.RGB32F:return t.RGB32F;case Ei.RGBA32I:return t.RGBA32I;case Ei.RGBA32UI:return t.RGBA32UI;case Ei.RGBA32F:return t.RGBA32F;case Ei.R5G6B5:return t.RGB565;case Ei.RGB5A1:return t.RGB5_A1;case Ei.RGBA4:return t.RGBA4;case Ei.SRGB8:return t.SRGB8;case Ei.SRGB8_A8:return t.SRGB8_ALPHA8;case Ei.RGB10A2:return t.RGB10_A2;case Ei.RGB10A2UI:return t.RGB10_A2UI;case Ei.R11G11B10F:return t.R11F_G11F_B10F;case Ei.DEPTH:return t.DEPTH_COMPONENT32F;case Ei.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case Ei.BC1:return m1.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ei.BC1_ALPHA:return m1.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ei.BC1_SRGB:return m1.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ei.BC1_SRGB_ALPHA:return m1.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ei.BC2:return m1.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ei.BC2_SRGB:return m1.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ei.BC3:return m1.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ei.BC3_SRGB:return m1.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ei.ETC_RGB8:return m1.COMPRESSED_RGB_ETC1_WEBGL;case Ei.ETC2_RGB8:return m1.COMPRESSED_RGB8_ETC2;case Ei.ETC2_SRGB8:return m1.COMPRESSED_SRGB8_ETC2;case Ei.ETC2_RGB8_A1:return m1.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ei.ETC2_SRGB8_A1:return m1.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ei.ETC2_RGBA8:return m1.COMPRESSED_RGBA8_ETC2_EAC;case Ei.ETC2_SRGB8_A8:return m1.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ei.EAC_R11:return m1.COMPRESSED_R11_EAC;case Ei.EAC_R11SN:return m1.COMPRESSED_SIGNED_R11_EAC;case Ei.EAC_RG11:return m1.COMPRESSED_RG11_EAC;case Ei.EAC_RG11SN:return m1.COMPRESSED_SIGNED_RG11_EAC;case Ei.PVRTC_RGB2:return m1.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ei.PVRTC_RGBA2:return m1.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ei.PVRTC_RGB4:return m1.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ei.PVRTC_RGBA4:return m1.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Ei.ASTC_RGBA_4X4:return m1.COMPRESSED_RGBA_ASTC_4x4_KHR;case Ei.ASTC_RGBA_5X4:return m1.COMPRESSED_RGBA_ASTC_5x4_KHR;case Ei.ASTC_RGBA_5X5:return m1.COMPRESSED_RGBA_ASTC_5x5_KHR;case Ei.ASTC_RGBA_6X5:return m1.COMPRESSED_RGBA_ASTC_6x5_KHR;case Ei.ASTC_RGBA_6X6:return m1.COMPRESSED_RGBA_ASTC_6x6_KHR;case Ei.ASTC_RGBA_8X5:return m1.COMPRESSED_RGBA_ASTC_8x5_KHR;case Ei.ASTC_RGBA_8X6:return m1.COMPRESSED_RGBA_ASTC_8x6_KHR;case Ei.ASTC_RGBA_8X8:return m1.COMPRESSED_RGBA_ASTC_8x8_KHR;case Ei.ASTC_RGBA_10X5:return m1.COMPRESSED_RGBA_ASTC_10x5_KHR;case Ei.ASTC_RGBA_10X6:return m1.COMPRESSED_RGBA_ASTC_10x6_KHR;case Ei.ASTC_RGBA_10X8:return m1.COMPRESSED_RGBA_ASTC_10x8_KHR;case Ei.ASTC_RGBA_10X10:return m1.COMPRESSED_RGBA_ASTC_10x10_KHR;case Ei.ASTC_RGBA_12X10:return m1.COMPRESSED_RGBA_ASTC_12x10_KHR;case Ei.ASTC_RGBA_12X12:return m1.COMPRESSED_RGBA_ASTC_12x12_KHR;case Ei.ASTC_SRGBA_4X4:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Ei.ASTC_SRGBA_5X4:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Ei.ASTC_SRGBA_5X5:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Ei.ASTC_SRGBA_6X5:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Ei.ASTC_SRGBA_6X6:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Ei.ASTC_SRGBA_8X5:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Ei.ASTC_SRGBA_8X6:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Ei.ASTC_SRGBA_8X8:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Ei.ASTC_SRGBA_10X5:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Ei.ASTC_SRGBA_10X6:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Ei.ASTC_SRGBA_10X8:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Ei.ASTC_SRGBA_10X10:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Ei.ASTC_SRGBA_12X10:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Ei.ASTC_SRGBA_12X12:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glFormat=function(e,t){switch(e){case Ei.A8:return t.ALPHA;case Ei.L8:return t.LUMINANCE;case Ei.LA8:return t.LUMINANCE_ALPHA;case Ei.R8:case Ei.R8SN:return t.RED;case Ei.R8UI:case Ei.R8I:return t.RED;case Ei.RG8:case Ei.RG8SN:case Ei.RG8UI:case Ei.RG8I:return t.RG;case Ei.RGB8:case Ei.RGB8SN:case Ei.RGB8UI:case Ei.RGB8I:return t.RGB;case Ei.BGRA8:case Ei.RGBA8:case Ei.RGBA8SN:case Ei.RGBA8UI:case Ei.RGBA8I:return t.RGBA;case Ei.R16UI:case Ei.R16I:case Ei.R16F:return t.RED;case Ei.RG16UI:case Ei.RG16I:case Ei.RG16F:return t.RG;case Ei.RGB16UI:case Ei.RGB16I:case Ei.RGB16F:return t.RGB;case Ei.RGBA16UI:case Ei.RGBA16I:case Ei.RGBA16F:return t.RGBA;case Ei.R32UI:case Ei.R32I:case Ei.R32F:return t.RED;case Ei.RG32UI:case Ei.RG32I:case Ei.RG32F:return t.RG;case Ei.RGB32UI:case Ei.RGB32I:case Ei.RGB32F:return t.RGB;case Ei.RGBA32UI:case Ei.RGBA32I:case Ei.RGBA32F:case Ei.RGB10A2:return t.RGBA;case Ei.R11G11B10F:case Ei.R5G6B5:return t.RGB;case Ei.RGB5A1:case Ei.RGBA4:return t.RGBA;case Ei.SRGB8:return t.RGB;case Ei.SRGB8_A8:return t.RGBA;case Ei.DEPTH:return t.DEPTH_COMPONENT;case Ei.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Ei.BC1:return m1.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ei.BC1_ALPHA:return m1.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ei.BC1_SRGB:return m1.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ei.BC1_SRGB_ALPHA:return m1.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ei.BC2:return m1.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ei.BC2_SRGB:return m1.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ei.BC3:return m1.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ei.BC3_SRGB:return m1.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ei.ETC_RGB8:return m1.COMPRESSED_RGB_ETC1_WEBGL;case Ei.ETC2_RGB8:return m1.COMPRESSED_RGB8_ETC2;case Ei.ETC2_SRGB8:return m1.COMPRESSED_SRGB8_ETC2;case Ei.ETC2_RGB8_A1:return m1.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ei.ETC2_SRGB8_A1:return m1.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ei.ETC2_RGBA8:return m1.COMPRESSED_RGBA8_ETC2_EAC;case Ei.ETC2_SRGB8_A8:return m1.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ei.EAC_R11:return m1.COMPRESSED_R11_EAC;case Ei.EAC_R11SN:return m1.COMPRESSED_SIGNED_R11_EAC;case Ei.EAC_RG11:return m1.COMPRESSED_RG11_EAC;case Ei.EAC_RG11SN:return m1.COMPRESSED_SIGNED_RG11_EAC;case Ei.PVRTC_RGB2:return m1.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ei.PVRTC_RGBA2:return m1.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ei.PVRTC_RGB4:return m1.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ei.PVRTC_RGBA4:return m1.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Ei.ASTC_RGBA_4X4:return m1.COMPRESSED_RGBA_ASTC_4x4_KHR;case Ei.ASTC_RGBA_5X4:return m1.COMPRESSED_RGBA_ASTC_5x4_KHR;case Ei.ASTC_RGBA_5X5:return m1.COMPRESSED_RGBA_ASTC_5x5_KHR;case Ei.ASTC_RGBA_6X5:return m1.COMPRESSED_RGBA_ASTC_6x5_KHR;case Ei.ASTC_RGBA_6X6:return m1.COMPRESSED_RGBA_ASTC_6x6_KHR;case Ei.ASTC_RGBA_8X5:return m1.COMPRESSED_RGBA_ASTC_8x5_KHR;case Ei.ASTC_RGBA_8X6:return m1.COMPRESSED_RGBA_ASTC_8x6_KHR;case Ei.ASTC_RGBA_8X8:return m1.COMPRESSED_RGBA_ASTC_8x8_KHR;case Ei.ASTC_RGBA_10X5:return m1.COMPRESSED_RGBA_ASTC_10x5_KHR;case Ei.ASTC_RGBA_10X6:return m1.COMPRESSED_RGBA_ASTC_10x6_KHR;case Ei.ASTC_RGBA_10X8:return m1.COMPRESSED_RGBA_ASTC_10x8_KHR;case Ei.ASTC_RGBA_10X10:return m1.COMPRESSED_RGBA_ASTC_10x10_KHR;case Ei.ASTC_RGBA_12X10:return m1.COMPRESSED_RGBA_ASTC_12x10_KHR;case Ei.ASTC_RGBA_12X12:return m1.COMPRESSED_RGBA_ASTC_12x12_KHR;case Ei.ASTC_SRGBA_4X4:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Ei.ASTC_SRGBA_5X4:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Ei.ASTC_SRGBA_5X5:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Ei.ASTC_SRGBA_6X5:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Ei.ASTC_SRGBA_6X6:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Ei.ASTC_SRGBA_8X5:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Ei.ASTC_SRGBA_8X6:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Ei.ASTC_SRGBA_8X8:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Ei.ASTC_SRGBA_10X5:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Ei.ASTC_SRGBA_10X6:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Ei.ASTC_SRGBA_10X8:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Ei.ASTC_SRGBA_10X10:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Ei.ASTC_SRGBA_12X10:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Ei.ASTC_SRGBA_12X12:return m1.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=S1(t.format,n);var i=t.width,r=t.height;switch(t.type){case Ii.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&D(9100,a,e.capabilities.maxTextureSize),t.samples===Ni.ONE){if(t.glTexture=n.createTexture(),t.size>0){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),la[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=da(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,r)}}else t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Ii.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>e.capabilities.maxCubeMapTextureSize&&D(9100,u,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),la[t.format].isCompressed)for(var _=0;_<t.mipLevel;++_){for(var f=da(t.format,i,r,1),d=new Uint8Array(f),p=0;p<6;++p)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+p,_,t.glInternalFmt,i,r,0,d);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Ii.TEX2D,t.glTarget=n.TEXTURE_2D}}function U1(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var a=0;a<i.length;++a)i[a].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+a),r=a,n.bindTexture(t.glTarget,null),i[a].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var o=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),o===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),o=null),t.glRenderbuffer=null}}var G1={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function H1(e,t,n,i,r,a,o){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),G1.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=t.colorAttachments[u];if(h.format!==Ei.UNKNOWN)switch(h.loadOp){case Vi.LOAD:break;case Vi.CLEAR:if(c.bs.targets[0].blendColorMask!==Gi.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)x1[0]=r[u].x,x1[1]=r[u].y,x1[2]=r[u].z,x1[3]=r[u].w,s.clearBufferfv(s.COLOR,u,x1);else{var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT}break;case Vi.DISCARD:G1.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Ei.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Vi.LOAD:break;case Vi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(a),l|=s.DEPTH_BUFFER_BIT;break;case Vi.DISCARD:G1.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(la[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Vi.LOAD:break;case Vi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(o),l|=s.STENCIL_BUFFER_BIT;break;case Vi.DISCARD:G1.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&G1.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,G1.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var f=c.bs.targets[0].blendColorMask;if(f!==Gi.ALL){var d=(f&Gi.R)!==Gi.NONE,p=(f&Gi.G)!==Gi.NONE,m=(f&Gi.B)!==Gi.NONE,v=(f&Gi.A)!==Gi.NONE;s.colorMask(d,p,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function V1(e,t,n,i,r,a){var o=e.gl,s=e.stateCache,c=t&&t.gpuShader,l=!1;if(t&&G1.gpuPipelineState!==t){if(G1.gpuPipelineState=t,G1.glPrimitive=t.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(o.useProgram(u),s.glProgram=u,l=!0)}var h=t.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case Zi.NONE:o.disable(o.CULL_FACE);break;case Zi.FRONT:o.enable(o.CULL_FACE),o.cullFace(o.FRONT);break;case Zi.BACK:o.enable(o.CULL_FACE),o.cullFace(o.BACK)}e.stateCache.rs.cullMode=h.cullMode}var _=h.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==_&&(o.frontFace(_?o.CCW:o.CW),e.stateCache.rs.isFrontFaceCCW=_),e.stateCache.rs.depthBias===h.depthBias&&e.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(o.polygonOffset(h.depthBias,h.depthBiasSlop),e.stateCache.rs.depthBias=h.depthBias,e.stateCache.rs.depthBiasSlop=h.depthBiasSlop),e.stateCache.rs.lineWidth!==h.lineWidth&&(o.lineWidth(h.lineWidth),e.stateCache.rs.lineWidth=h.lineWidth)}var f=t.dss;f&&(s.dss.depthTest!==f.depthTest&&(f.depthTest?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),s.dss.depthTest=f.depthTest),s.dss.depthWrite!==f.depthWrite&&(o.depthMask(f.depthWrite),s.dss.depthWrite=f.depthWrite),s.dss.depthFunc!==f.depthFunc&&(o.depthFunc(w1[f.depthFunc]),s.dss.depthFunc=f.depthFunc),s.dss.stencilTestFront===f.stencilTestFront&&s.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),s.dss.stencilTestFront=f.stencilTestFront,s.dss.stencilTestBack=f.stencilTestBack),s.dss.stencilFuncFront===f.stencilFuncFront&&s.dss.stencilRefFront===f.stencilRefFront&&s.dss.stencilReadMaskFront===f.stencilReadMaskFront||(o.stencilFuncSeparate(o.FRONT,w1[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),s.dss.stencilFuncFront=f.stencilFuncFront,s.dss.stencilRefFront=f.stencilRefFront,s.dss.stencilReadMaskFront=f.stencilReadMaskFront),s.dss.stencilFailOpFront===f.stencilFailOpFront&&s.dss.stencilZFailOpFront===f.stencilZFailOpFront&&s.dss.stencilPassOpFront===f.stencilPassOpFront||(o.stencilOpSeparate(o.FRONT,R1[f.stencilFailOpFront],R1[f.stencilZFailOpFront],R1[f.stencilPassOpFront]),s.dss.stencilFailOpFront=f.stencilFailOpFront,s.dss.stencilZFailOpFront=f.stencilZFailOpFront,s.dss.stencilPassOpFront=f.stencilPassOpFront),s.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(o.stencilMaskSeparate(o.FRONT,f.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),s.dss.stencilFuncBack===f.stencilFuncBack&&s.dss.stencilRefBack===f.stencilRefBack&&s.dss.stencilReadMaskBack===f.stencilReadMaskBack||(o.stencilFuncSeparate(o.BACK,w1[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),s.dss.stencilFuncBack=f.stencilFuncBack,s.dss.stencilRefBack=f.stencilRefBack,s.dss.stencilReadMaskBack=f.stencilReadMaskBack),s.dss.stencilFailOpBack===f.stencilFailOpBack&&s.dss.stencilZFailOpBack===f.stencilZFailOpBack&&s.dss.stencilPassOpBack===f.stencilPassOpBack||(o.stencilOpSeparate(o.BACK,R1[f.stencilFailOpBack],R1[f.stencilZFailOpBack],R1[f.stencilPassOpBack]),s.dss.stencilFailOpBack=f.stencilFailOpBack,s.dss.stencilZFailOpBack=f.stencilZFailOpBack,s.dss.stencilPassOpBack=f.stencilPassOpBack),s.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(o.stencilMaskSeparate(o.BACK,f.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var d=t.bs;if(d){s.bs.isA2C!==d.isA2C&&(d.isA2C?o.enable(o.SAMPLE_ALPHA_TO_COVERAGE):o.disable(o.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=d.isA2C),s.bs.blendColor.x===d.blendColor.x&&s.bs.blendColor.y===d.blendColor.y&&s.bs.blendColor.z===d.blendColor.z&&s.bs.blendColor.w===d.blendColor.w||(o.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),s.bs.blendColor.x=d.blendColor.x,s.bs.blendColor.y=d.blendColor.y,s.bs.blendColor.z=d.blendColor.z,s.bs.blendColor.w=d.blendColor.w);var p=d.targets[0],m=s.bs.targets[0];m.blend!==p.blend&&(p.blend?o.enable(o.BLEND):o.disable(o.BLEND),m.blend=p.blend),m.blendEq===p.blendEq&&m.blendAlphaEq===p.blendAlphaEq||(o.blendEquationSeparate(P1[p.blendEq],P1[p.blendAlphaEq]),m.blendEq=p.blendEq,m.blendAlphaEq=p.blendAlphaEq),m.blendSrc===p.blendSrc&&m.blendDst===p.blendDst&&m.blendSrcAlpha===p.blendSrcAlpha&&m.blendDstAlpha===p.blendDstAlpha||(o.blendFuncSeparate(I1[p.blendSrc],I1[p.blendDst],I1[p.blendSrcAlpha],I1[p.blendDstAlpha]),m.blendSrc=p.blendSrc,m.blendDst=p.blendDst,m.blendSrcAlpha=p.blendSrcAlpha,m.blendDstAlpha=p.blendDstAlpha),m.blendColorMask!==p.blendColorMask&&(o.colorMask((p.blendColorMask&Gi.R)!==Gi.NONE,(p.blendColorMask&Gi.G)!==Gi.NONE,(p.blendColorMask&Gi.B)!==Gi.NONE,(p.blendColorMask&Gi.A)!==Gi.NONE),m.blendColorMask=p.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var v=c.glBlocks.length,g=t.gpuPipelineLayout.dynamicOffsetIndices,y=0;y<v;y++){var S=c.glBlocks[y],T=i[S.set],E=T&&T.descriptorIndices[S.binding],C=E>=0&&T.gpuDescriptors[E];if(C&&C.gpuBuffer){var A=g[S.set],b=A&&A[S.binding],w=C.gpuBuffer.glOffset;b>=0&&(w+=r[b]),s.glBindUBOs[S.glBinding]===C.gpuBuffer.glBuffer&&s.glBindUBOOffsets[S.glBinding]===w||(w?o.bindBufferRange(o.UNIFORM_BUFFER,S.glBinding,C.gpuBuffer.glBuffer,w,C.gpuBuffer.size):o.bindBufferBase(o.UNIFORM_BUFFER,S.glBinding,C.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[S.glBinding]=C.gpuBuffer.glBuffer,s.glBindUBOOffsets[S.glBinding]=w)}else x("Buffer binding '".concat(S.name,"' at set ").concat(S.set," binding ").concat(S.binding," is not bounded"))}for(var R=c.glSamplerTextures.length,P=0;P<R;P++)for(var I=c.glSamplerTextures[P],D=i[I.set],O=D&&D.descriptorIndices[I.binding],N=O>=0&&D.gpuDescriptors[O],M=0;M<I.units.length;M++){var k=I.units[M],L=s.glTexUnits[k];if(N&&N.gpuTexture&&N.gpuSampler){if(N.gpuTexture&&N.gpuTexture.size>0){var B=N.gpuTexture;L.glTexture!==B.glTexture&&(s.texUnit!==k&&(o.activeTexture(o.TEXTURE0+k),s.texUnit=k),B.glTexture?o.bindTexture(B.glTarget,B.glTexture):o.bindTexture(B.glTarget,e.nullTex2D.gpuTexture.glTexture),L.glTexture=B.glTexture);var F=N.gpuSampler;s.glSamplerUnits[k]!==F.glSampler&&(o.bindSampler(k,F.glSampler),s.glSamplerUnits[k]=F.glSampler)}N=D.gpuDescriptors[++O]}else x("Sampler binding '".concat(I.name,"' at set ").concat(I.set," binding ").concat(I.binding," index ").concat(M," is not bounded"))}}if(n&&c&&(l||G1.gpuInputAssembler!==n))if(G1.gpuInputAssembler=n,e.extensions.useVAO){var z=n.glVAOs.get(c.glProgram);if(!z){var U;z=o.createVertexArray(),n.glVAOs.set(c.glProgram,z),o.bindVertexArray(z),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var G=0;G<c.glInputs.length;G++){var H=c.glInputs[G];U=null;for(var V=0;V<n.glAttribs.length;V++){var j=n.glAttribs[V];if(j.name===H.name){U=j;break}}if(U){s.glArrayBuffer!==U.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,U.glBuffer),s.glArrayBuffer=U.glBuffer);for(var W=0;W<U.componentCount;++W){var q=H.glLoc+W,X=U.offset+U.size*W;o.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,o.vertexAttribPointer(q,U.count,U.glType,U.isNormalized,U.stride,X),o.vertexAttribDivisor(q,U.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,Y.glBuffer),o.bindVertexArray(null),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==z&&(o.bindVertexArray(z),s.glVAO=z)}else{for(var K=0;K<e.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var Q=0;Q<c.glInputs.length;Q++){for(var Z=c.glInputs[Q],J=null,$=0;$<n.glAttribs.length;$++){var ee=n.glAttribs[$];if(ee.name===Z.name){J=ee;break}}if(J){s.glArrayBuffer!==J.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,J.glBuffer),s.glArrayBuffer=J.glBuffer);for(var te=0;te<J.componentCount;++te){var ne=Z.glLoc+te,ie=J.offset+J.size*te;!s.glEnabledAttribLocs[ne]&&ne>=0&&(o.enableVertexAttribArray(ne),s.glEnabledAttribLocs[ne]=!0),s.glCurrentAttribLocs[ne]=!0,o.vertexAttribPointer(ne,J.count,J.glType,J.isNormalized,J.stride,ie),o.vertexAttribDivisor(ne,J.isInstanced?1:0)}}}var re=n.gpuIndexBuffer;re&&s.glElementArrayBuffer!==re.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,re.glBuffer),s.glElementArrayBuffer=re.glBuffer);for(var ae=0;ae<e.capabilities.maxVertexAttributes;++ae)s.glEnabledAttribLocs[ae]!==s.glCurrentAttribLocs[ae]&&(o.disableVertexAttribArray(ae),s.glEnabledAttribLocs[ae]=!1)}if(t&&t.dynamicStates.length)for(var oe=t.dynamicStates.length,se=0;se<oe;se++)switch(t.dynamicStates[se]){case Ji.LINE_WIDTH:s.rs.lineWidth!==a.lineWidth&&(o.lineWidth(a.lineWidth),s.rs.lineWidth=a.lineWidth);break;case Ji.DEPTH_BIAS:s.rs.depthBias===a.depthBiasConstant&&s.rs.depthBiasSlop===a.depthBiasSlope||(o.polygonOffset(a.depthBiasConstant,a.depthBiasSlope),s.rs.depthBias=a.depthBiasConstant,s.rs.depthBiasSlop=a.depthBiasSlope);break;case Ji.BLEND_CONSTANTS:var ce=a.blendConstant;s.bs.blendColor.x===ce.x&&s.bs.blendColor.y===ce.y&&s.bs.blendColor.z===ce.z&&s.bs.blendColor.w===ce.w||(o.blendColor(ce.x,ce.y,ce.z,ce.w),s.bs.blendColor.copy(ce));break;case Ji.STENCIL_WRITE_MASK:var le=a.stencilStatesFront,ue=a.stencilStatesBack;s.dss.stencilWriteMaskFront!==le.writeMask&&(o.stencilMaskSeparate(o.FRONT,le.writeMask),s.dss.stencilWriteMaskFront=le.writeMask),s.dss.stencilWriteMaskBack!==ue.writeMask&&(o.stencilMaskSeparate(o.BACK,ue.writeMask),s.dss.stencilWriteMaskBack=ue.writeMask);break;case Ji.STENCIL_COMPARE_MASK:var he=a.stencilStatesFront,_e=a.stencilStatesBack;s.dss.stencilRefFront===he.reference&&s.dss.stencilReadMaskFront===he.compareMask||(o.stencilFuncSeparate(o.FRONT,w1[s.dss.stencilFuncFront],he.reference,he.compareMask),s.dss.stencilRefFront=he.reference,s.dss.stencilReadMaskFront=he.compareMask),s.dss.stencilRefBack===_e.reference&&s.dss.stencilReadMaskBack===_e.compareMask||(o.stencilFuncSeparate(o.BACK,w1[s.dss.stencilFuncBack],_e.reference,_e.compareMask),s.dss.stencilRefBack=_e.reference,s.dss.stencilReadMaskBack=_e.compareMask)}}function j1(e,t){var n=e.gl,i=G1.gpuInputAssembler,r=G1.glPrimitive,a=e.extensions.WEBGL_multi_draw;if(i){var o=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*o.stride;if(a)s.instancedDraw?a.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):a.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(a)s.instancedDraw?a.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):a.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(t.instanceCount)if(o){if(t.indexCount>0){var h=t.firstIndex*o.stride;n.drawElementsInstanced(r,t.indexCount,i.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(o){if(t.indexCount>0){var _=t.firstIndex*o.stride;n.drawElements(r,t.indexCount,i.glIndexType,_)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}}var W1=new Array(b1.COUNT);function q1(e,t){W1.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=W1[i]++;switch(i){case b1.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[r];H1(e,a.gpuRenderPass,a.gpuFramebuffer,a.renderArea,a.clearColors,a.clearDepth,a.clearStencil);break;case b1.BIND_STATES:var o=t.bindStatesCmds.array[r];V1(e,o.gpuPipelineState,o.gpuInputAssembler,o.gpuDescriptorSets,o.dynamicOffsets,o.dynamicStates);break;case b1.DRAW:j1(e,t.drawCmds.array[r].drawInfo);break;case b1.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];F1(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case b1.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];X1(e,c.buffers,c.gpuTexture,c.regions)}}}function X1(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=1,c=1,l=0,u=la[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[o++];u?n.glInternalFmt!==m1.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[o++];u?n.glInternalFmt!==m1.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Oi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var Y1=function(){function e(){K(this,e),this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}return Z(e,[{key:"clearDraws",value:function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1}},{key:"setDrawInfo",value:function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)}},{key:"_ensureCapacity",value:function(e){if(!(this._capacity>e)){this._capacity=r(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}}}]),e}(),K1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuBuffer=null,e}return Z(n,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"initialize",value:function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new Y1,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&bi.VERTEX){t.glTarget=n.ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),G1.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&bi.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),G1.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&bi.UNIFORM){t.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&bi.INDIRECT||t.usage&bi.TRANSFER_DST||t.usage&bi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE}(g1.instance,this._gpuBuffer),g1.instance.memoryStatus.bufferSize+=this._size}},{key:"destroy",value:function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),G1.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),G1.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(g1.instance,this._gpuBuffer),g1.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)}},{key:"resize",value:function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&bi.VERTEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),G1.gpuInputAssembler=null,i.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):t.usage&bi.INDEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),G1.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&bi.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&bi.INDIRECT||t.usage&bi.TRANSFER_DST||t.usage&bi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(g1.instance,this._gpuBuffer),g1.instance.memoryStatus.bufferSize-=t,g1.instance.memoryStatus.bufferSize+=e)))}}},{key:"update",value:function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&bi.INDIRECT?0:e.byteLength,F1(g1.instance,this._gpuBuffer,e,0,n))}}]),n}(xa),Q1=function(){function e(t,n){K(this,e),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(n),this._freeCmds=new eu(n);for(var i=0;i<n;++i)this._frees[i]=new t;this._freeIdx=n-1}return Z(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var a=i,o=0;a<t;++a,++o)this._frees[a]=n[o];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),Z1=function(){function e(){K(this,e),this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new Q1(O1,1),this.bindStatesCmdPool=new Q1(N1,1),this.drawCmdPool=new Q1(M1,1),this.updateBufferCmdPool=new Q1(k1,1),this.copyBufferToTextureCmdPool=new Q1(L1,1)}return Z(e,[{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),e}(),J1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).cmdPackage=new B1,e._cmdAllocator=new Z1,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUDescriptorSets=[],e._curGPUInputAssembler=null,e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new sa,e._isStateInvalied=!1,e}return Z(n,[{key:"initialize",value:function(e){this._type=e.type,this._queue=e.queue;for(var t=g1.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)}},{key:"destroy",value:function(){this._cmdAllocator.clearCmds(this.cmdPackage)}},{key:"begin",value:function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,n,i,r,a){var o=this._cmdAllocator.beginRenderPassCmdPool.alloc(O1);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea=n;for(var s=0;s<i.length;++s)o.clearColors[s]=i[s];o.clearDepth=r,o.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(b1.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}},{key:"bindDescriptorSet",value:function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,a=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(a){for(var o=this._curDynamicOffsets,s=a.dynamicOffsetOffsets[e],c=0;c<n.length;c++)o[s+c]=n[c];this._isStateInvalied=!0}}}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)}},{key:"setLineWidth",value:function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&$i.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&$i.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&$i.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&$i.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))}},{key:"draw",value:function(e){if(this._type===ir.PRIMARY&&this._isInRenderPass||this._type===ir.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(M1);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(b1.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,n){if(this._type===ir.PRIMARY&&!this._isInRenderPass||this._type===ir.SECONDARY){var i=e.gpuBuffer;if(i){var r,a=this._cmdAllocator.updateBufferCmdPool.alloc(k1),o=0;e.usage&bi.INDIRECT||(o=void 0!==n?n:t.byteLength),r=t,a.gpuBuffer=i,a.buffer=r,a.offset=0,a.size=o,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(b1.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBuffersToTexture",value:function(e,t,n){if(this._type===ir.PRIMARY&&!this._isInRenderPass||this._type===ir.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(L1);r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(b1.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var a=i.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var o=0;o<i.cmdPackage.bindStatesCmds.length;++o){var s=i.cmdPackage.bindStatesCmds.array[o];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}}},{key:"pipelineBarrier",value:function(){}},{key:"bindStates",value:function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(N1);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(b1.BIND_STATES),this._isStateInvalied=!1}}]),n}(Sa),$1=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuFramebuffer=null,e}return Z(n,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}},{key:"initialize",value:function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;n++){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var a=Number.MAX_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorTextures[0].width},set width(e){a=e},get height(){return this.isOffscreen?o:this.gpuColorTextures[0].height},set height(e){o=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],a=i.createFramebuffer();if(a){t.glFramebuffer=a,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var o=0;o<t.gpuColorTextures.length;++o){var s=t.gpuColorTextures[o];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+o),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=la[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(g1.instance,this._gpuFramebuffer)}},{key:"destroy",value:function(){var e,t;this._gpuFramebuffer&&(e=g1.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)}}]),n}(Ca),e2=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuInputAssembler=null,e}return Z(n,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}},{key:"initialize",value:function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var a=null,o=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:a,gpuIndirectBuffer:s,glAttribs:[],glIndexType:o,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],o=void 0!==a.stream?a.stream:0,s=t.gpuVertexBuffers[o],c=S1(a.format,n),l=la[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:s.glBuffer,glType:c,size:l,count:la[a.format].count,stride:s.stride,componentCount:A1(c,n),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:i[o]},i[o]+=l}}(g1.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")}},{key:"destroy",value:function(){var e=g1.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.gl,a=e.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),a===i.value&&(r.bindVertexArray(null),a=null),i=n.next();e.stateCache.glVAO=a,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}}]),n}(Ra),t2=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuDescriptorSetLayout=null,e}return Z(n,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}},{key:"initialize",value:function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var a=this._bindings[r];i.push(t),t+=a.count,a.binding>n&&(n=a.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var o=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,o[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&_a)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:o,descriptorCount:t}}},{key:"destroy",value:function(){this._bindings.length=0}}]),n}(Ia),n2=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuPipelineLayout=null,e}return Z(n,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}},{key:"initialize",value:function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],a=0;a<this._setLayouts.length;a++){for(var o=this._setLayouts[a],s=o.gpuDescriptorSetLayout.dynamicBindings,c=Array(o.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(o.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}}},{key:"destroy",value:function(){this._setLayouts.length=0}}]),n}(Da),i2=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],r2=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuPipelineState=null,e}return Z(n,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}},{key:"initialize",value:function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],a=0;a<31;a++)this._dynamicStates&1<<a&&r.push(1<<a);this._gpuPipelineState={glPrimitive:i2[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}}},{key:"destroy",value:function(){this._gpuPipelineState=null}}]),n}(Ba),a2=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"beginRenderPass",value:function(e,t,n,i,r,a){H1(g1.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,a),this._isInRenderPass=!0}},{key:"draw",value:function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;j1(g1.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"setViewport",value:function(e){var t=g1.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)}},{key:"setScissor",value:function(e){var t=g1.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)}},{key:"updateBuffer",value:function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&bi.INDIRECT?0:t.byteLength,F1(g1.instance,r,t,0,i))}}},{key:"copyBuffersToTexture",value:function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&X1(g1.instance,e,i,n)}}},{key:"execute",value:function(e,t){for(var n=0;n<t;++n){var i=e[n];q1(g1.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}}},{key:"bindStates",value:function(){V1(g1.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}}]),n}(J1),o2=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}return Z(n,[{key:"initialize",value:function(e){this._type=e.type}},{key:"destroy",value:function(){}},{key:"submit",value:function(e){for(var t=0;t<e.length;t++){var n=e[t];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}]),n}(Fa),s2=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuRenderPass=null,e}return Z(n,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}},{key:"initialize",value:function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()}},{key:"destroy",value:function(){this._gpuRenderPass=null}}]),n}(za),c2=function(e){te(n,e);var t=le(n);function n(e,i){var r,a,o,s,c;return K(this,n),(r=t.call(this,e,i))._gpuSampler=null,r._gpuSampler={glSampler:null,minFilter:r._info.minFilter,magFilter:r._info.magFilter,mipFilter:r._info.mipFilter,addressU:r._info.addressU,addressV:r._info.addressV,addressW:r._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},a=g1.instance,o=r._gpuSampler,(c=(s=a.gl).createSampler())&&(o.minFilter===ki.LINEAR||o.minFilter===ki.ANISOTROPIC?o.mipFilter===ki.LINEAR||o.mipFilter===ki.ANISOTROPIC?o.glMinFilter=s.LINEAR_MIPMAP_LINEAR:o.mipFilter===ki.POINT?o.glMinFilter=s.LINEAR_MIPMAP_NEAREST:o.glMinFilter=s.LINEAR:o.mipFilter===ki.LINEAR||o.mipFilter===ki.ANISOTROPIC?o.glMinFilter=s.NEAREST_MIPMAP_LINEAR:o.mipFilter===ki.POINT?o.glMinFilter=s.NEAREST_MIPMAP_NEAREST:o.glMinFilter=s.NEAREST,o.magFilter===ki.LINEAR||o.magFilter===ki.ANISOTROPIC?o.glMagFilter=s.LINEAR:o.glMagFilter=s.NEAREST,o.glWrapS=y1[o.addressU],o.glWrapT=y1[o.addressV],o.glWrapR=y1[o.addressW],o.glSampler=c,s.samplerParameteri(c,s.TEXTURE_MIN_FILTER,o.glMinFilter),s.samplerParameteri(c,s.TEXTURE_MAG_FILTER,o.glMagFilter),s.samplerParameteri(c,s.TEXTURE_WRAP_S,o.glWrapS),s.samplerParameteri(c,s.TEXTURE_WRAP_T,o.glWrapT),s.samplerParameteri(c,s.TEXTURE_WRAP_R,o.glWrapR),s.samplerParameterf(c,s.TEXTURE_MIN_LOD,0),s.samplerParameterf(c,s.TEXTURE_MAX_LOD,1e3)),r}return Z(n,[{key:"gpuSampler",get:function(){return this._gpuSampler}},{key:"destroy",value:function(){this._gpuSampler&&(function(e,t){var n=e.gl;if(t.glSampler){n.deleteSampler(t.glSampler);for(var i=e.stateCache.glSamplerUnits,r=0;r<i.length;++r)i[r]===t.glSampler&&(n.bindSampler(r,null),i[r]=null);t.glSampler=null}}(g1.instance,this._gpuSampler),this._gpuSampler=null)}}]),n}(Ua),l2=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuShader=null,e}return Z(n,[{key:"gpuShader",get:function(){return this._gpuShader}},{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,a="",o=1;switch(i.type){case Hi.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case Hi.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n".concat(i.source)),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error("".concat(a," in '").concat(t.name,"' compilation failed.")),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n".concat(o++," ")}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var a=i(r);if("object"===Y(a))return a.v}var o=n.createProgram();if(o){t.glProgram=o;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}n.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '".concat(t.name,"'.")),void console.error(n.getProgramInfoLog(t.glProgram));T("Shader '".concat(t.name,"' compilation succeeded."));var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(t.glProgram,d),v=E1(f.type,n),g=C1(f.type,n);t.glInputs[_]={name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}var y,S,E,C,A=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(A){t.glBlocks=new Array(A);for(var b=0;b<A;++b){var w=(y=n.getActiveUniformBlockName(t.glProgram,b)).indexOf("[");-1!==w&&(y=y.substr(0,w)),C=null;for(var R=0;R<t.blocks.length;R++)if(t.blocks[R].name===y){C=t.blocks[R];break}if(C){S=b,E=n.getActiveUniformBlockParameter(t.glProgram,S,n.UNIFORM_BLOCK_DATA_SIZE);var P=C.binding+(e.bindingMappingInfo.bufferOffsets[C.set]||0);n.uniformBlockBinding(t.glProgram,S,P),t.glBlocks[b]={set:C.set,binding:C.binding,idx:S,name:y,size:E,glBinding:P}}else x("Block '".concat(y,"' does not bound"))}}for(var I=0;I<t.subpassInputs.length;++I){var D=t.subpassInputs[I];t.samplerTextures.push(new Or(D.set,D.binding,D.name,Ai.SAMPLER2D,D.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var O=0;O<t.samplerTextures.length;++O){var N=t.samplerTextures[O];t.glSamplerTextures[O]={set:N.set,binding:N.binding,name:N.name,type:N.type,count:N.count,units:[],glUnits:null,glType:T1(N.type,n),glLoc:null}}}for(var M=[],k=[],L=e.stateCache.texUnitCacheMap,B=0,F=0;F<t.blocks.length;++F)t.blocks[F].set===e.bindingMappingInfo.flexibleSet&&B++;for(var z=0,U=0;U<t.samplerTextures.length;++U){var G=t.samplerTextures[U],H=n.getUniformLocation(t.glProgram,G.name);if(H&&-1!==H.id&&(M.push(t.glSamplerTextures[U]),k.push(H)),void 0===L[G.name]){var V=G.binding+e.bindingMappingInfo.samplerOffsets[G.set]+z;G.set===e.bindingMappingInfo.flexibleSet&&(V-=B),L[G.name]=V%e.capabilities.maxTextureUnits,z+=G.count-1}}if(M.length){for(var j=[],W=0;W<M.length;++W){var q=M[W],X=L[q.name];if(void 0!==X){q.glLoc=k[W];for(var K=0;K<q.count;++K){for(;j[X];)X=(X+1)%e.capabilities.maxTextureUnits;q.units.push(X),j[X]=!0}}}for(var Q=0,Z=0;Z<M.length;++Z){var J=M[Z];if(!J.glLoc){for(J.glLoc=k[Z];j[Q];)Q++;for(var $=0;$<J.count;++$){for(;j[Q];)Q=(Q+1)%e.capabilities.maxTextureUnits;void 0===L[J.name]&&(L[J.name]=Q),J.units.push(Q),j[Q]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var ee=0;ee<M.length;ee++){var te=M[ee];te.glUnits=new Int32Array(te.units),n.uniform1iv(te.glLoc,te.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=M}}(g1.instance,this._gpuShader)}},{key:"destroy",value:function(){var e,t;this._gpuShader&&(e=g1.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null),this._gpuShader=null)}}]),n}(Ga),u2=function(){function e(){K(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new vr,this.scissorRect=new ur(0,0,0,0),this.rs=new Oa,this.dss=new Na,this.bs=new ka,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return Z(e,[{key:"initialize",value:function(e,t,n){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)}}]),e}(),h2=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._gpuTexture=null,e}return Z(n,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"initialize",value:function(e,t){"texture"in e?console.log("WebGL2 does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=fa(this._width)&&fa(this._height),this._size=pa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},z1(g1.instance,this._gpuTexture),g1.instance.memoryStatus.textureSize+=this._size)}},{key:"destroy",value:function(){this._gpuTexture&&(U1(g1.instance,this._gpuTexture),g1.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}},{key:"resize",value:function(e,t){var n=this._size;this._width=e,this._height=t,this._size=pa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Ii.TEX2D:t.glTarget=n.TEXTURE_2D;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&D(9100,a,e.capabilities.maxTextureSize),t.samples===Ni.ONE){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),la[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=da(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else U1(e,t),z1(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Ii.CUBE:t.type=Ii.CUBE,t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>e.capabilities.maxCubeMapTextureSize&&D(9100,u,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),la[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var f=0;f<t.mipLevel;++f){var d=da(t.format,i,r,1),p=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,t.glInternalFmt,i,r,0,p),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else U1(e,t),z1(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Ii.TEX2D,t.glTarget=n.TEXTURE_2D}}}(g1.instance,this._gpuTexture),g1.instance.memoryStatus.textureSize-=n,g1.instance.memoryStatus.textureSize+=this._size)}},{key:"initAsSwapchainTexture",value:function(e){var t=new wr;t.format=e.format,t.usage=la[e.format].hasDepth?Di.DEPTH_STENCIL_ATTACHMENT:Di.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)}}]),n}(Ha),_2="webglcontextlost";function f2(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function d2(e){var t={EXT_texture_filter_anisotropic:f2(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:f2(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:f2(e,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:f2(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:f2(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:f2(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:f2(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:f2(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:f2(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:f2(e,"WEBGL_debug_shaders"),WEBGL_lose_context:f2(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:f2(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:f2(e,"OES_texture_half_float_linear"),OES_texture_float_linear:f2(e,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return Eu.os!==du.ANDROID&&Eu.os!==du.IOS&&(t.WEBGL_multi_draw=f2(e,"WEBGL_multi_draw")),t}var p2=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).stateCache=new u2,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGL2ContextLostHandler=null,e._extensions=null,e}return Z(n,[{key:"extensions",get:function(){return this._extensions}},{key:"initialize",value:function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(_2,this._onWebGLContextLost);var t=g1.instance.gl;this.stateCache.initialize(g1.instance.capabilities.maxTextureUnits,g1.instance.capabilities.maxUniformBufferBindings,g1.instance.capabilities.maxVertexAttributes),this._extensions=d2(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=Ei.RGBA8,i=Ei.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),a=t.getParameter(t.STENCIL_BITS);r&&a?i=Ei.DEPTH_STENCIL:r&&(i=Ei.DEPTH),this._colorTexture=new h2,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new h2,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=g1.instance.createTexture(new wr(Ii.TEX2D,Di.SAMPLED,Ei.RGBA8,2,2,Oi.NONE)),this.nullTexCube=g1.instance.createTexture(new wr(Ii.CUBE,Di.SAMPLED,Ei.RGBA8,2,2,Oi.NONE,6));var o=new mr;o.texExtent.width=2,o.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),g1.instance.copyBuffersToTexture([s],this.nullTex2D,[o]),o.texSubres.layerCount=6,g1.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[o])}},{key:"destroy",value:function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(_2,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null}},{key:"resize",value:function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(T("Resizing swapchain: ".concat(e,"x").concat(t)),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))}},{key:"_onWebGLContextLost",value:function(e){P(11e3),y(e)}}]),n}(Ea),m2=e("WebGL2Device",function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._swapchain=null,e._context=null,e}return Z(n,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"initialize",value:function(e){g1.setInstance(this),this._gfxAPI=xi.WEBGL2,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:St.ENABLE_TRANSPARENT_CANVAS,antialias:St.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",n)}catch(e){return null}return t}(Ta.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new na(tr.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new ta(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=t.getSupportedExtensions(),i="";if(n)for(var r,a=ge(n);!(r=a()).done;){var o=r.value;i+="".concat(o," ")}var s=d2(t);s.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(s.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(s.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var c=t.getParameter(t.VERSION);this._features.fill(!1),this._features[Ti.TEXTURE_FLOAT]=!0,this._features[Ti.TEXTURE_HALF_FLOAT]=!0,this._features[Ti.FORMAT_R11G11B10F]=!0,this._features[Ti.FORMAT_SRGB]=!0,this._features[Ti.FORMAT_RGB8]=!0,this._features[Ti.ELEMENT_INDEX_UINT]=!0,this._features[Ti.INSTANCED_ARRAYS]=!0,this._features[Ti.MULTIPLE_RENDER_TARGETS]=!0,this._features[Ti.BLEND_MINMAX]=!0,s.EXT_color_buffer_float&&(this._features[Ti.COLOR_FLOAT]=!0,this._features[Ti.COLOR_HALF_FLOAT]=!0),s.OES_texture_float_linear&&(this._features[Ti.TEXTURE_FLOAT_LINEAR]=!0),s.OES_texture_half_float_linear&&(this._features[Ti.TEXTURE_HALF_FLOAT_LINEAR]=!0);var l="";return s.WEBGL_compressed_texture_etc1&&(this._features[Ti.FORMAT_ETC1]=!0,l+="etc1 "),s.WEBGL_compressed_texture_etc&&(this._features[Ti.FORMAT_ETC2]=!0,l+="etc2 "),s.WEBGL_compressed_texture_s3tc&&(this._features[Ti.FORMAT_DXT]=!0,l+="dxt "),s.WEBGL_compressed_texture_pvrtc&&(this._features[Ti.FORMAT_PVRTC]=!0,l+="pvrtc "),s.WEBGL_compressed_texture_astc&&(this._features[Ti.FORMAT_ASTC]=!0,l+="astc "),T("WebGL2 device initialized."),T("RENDERER: ".concat(this._renderer)),T("VENDOR: ".concat(this._vendor)),T("VERSION: ".concat(c)),T("COMPRESSED_FORMAT: ".concat(l)),T("EXTENSIONS: ".concat(i)),!0}},{key:"destroy",value:function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null}},{key:"flushCommands",value:function(){}},{key:"acquire",value:function(){}},{key:"present",value:function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}},{key:"createCommandBuffer",value:function(e){var t=new(e.type===ir.PRIMARY?a2:J1);return t.initialize(e),t}},{key:"createSwapchain",value:function(e){var t=new p2;return this._swapchain=t,t.initialize(e),t}},{key:"createBuffer",value:function(e){var t=new K1;return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new h2;return t.initialize(e),t}},{key:"createDescriptorSet",value:function(e){var t=new v1;return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new l2;return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new e2;return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new s2;return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new $1;return t.initialize(e),t}},{key:"createDescriptorSetLayout",value:function(e){var t=new t2;return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new n2;return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new r2;return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new o2;return t.initialize(e),t}},{key:"getSampler",value:function(e){var t=Ua.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new c2(e,t)),this._samplers.get(t)}},{key:"getGlobalBarrier",value:function(e){var t=Va.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new Va(e,t)),this._globalBarriers.get(t)}},{key:"getTextureBarrier",value:function(e){var t=ja.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new ja(e,t)),this._textureBarriers.get(t)}},{key:"copyBuffersToTexture",value:function(e,t,n){X1(this,e,t.gpuTexture,n)}},{key:"copyTextureToBuffers",value:function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache,o=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,o);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),a.glFramebuffer=null,r.deleteFramebuffer(o)}(this,e.gpuTexture,t,n)}},{key:"copyTexImagesToTexture",value:function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Oi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)}}]),n}(Ta));function v2(e,t,n,i){var r=(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x),a=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),o=(i.y-n.y)*(t.x-e.x)-(i.x-n.x)*(t.y-e.y);if(0!==o){var s=r/o,c=a/o;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}c.WebGL2Device=m2;var g2=new ri,y2=new ri,x2=new ri,S2=new ri;function T2(e,t,n){for(var i=n.length,r=0;r<i;++r)if(v2(e,t,n[r],n[(r+1)%i]))return!0;return!1}function E2(e,t){for(var n=!1,i=e.x,r=e.y,a=t.length,o=0,s=a-1;o<a;s=o++){var c=t[o].x,l=t[o].y,u=t[s].x,h=t[s].y;l>r!=h>r&&i<(u-c)*(r-l)/(h-l)+c&&(n=!n)}return n}function C2(e,t,n,i){var r,a=n.x-t.x,o=n.y-t.y,s=a*a+o*o,c=((e.x-t.x)*a+(e.y-t.y)*o)/s;return r=i?s?c<0?t:c>1?n:g2.set(t.x+c*a,t.y+c*o):t:g2.set(t.x+c*a,t.y+c*o),a=e.x-r.x,o=e.y-r.y,Math.sqrt(a*a+o*o)}var A2,b2,w2=e("Intersection2D",(function e(){K(this,e)}));function R2(e,t){var n=t.length;return t[e<0?n- -e%n:e%n]}function P2(e,t,n){for(var i=[];t<e;)t+=n.length;for(;e<=t;++e)i.push(R2(e,n));return i}function I2(e,t,n){if(D2(e,n)){if(M2(R2(e,n),R2(e-1,n),R2(t,n))&&k2(R2(e,n),R2(e+1,n),R2(t,n)))return!1}else if(k2(R2(e,n),R2(e+1,n),R2(t,n))||M2(R2(e,n),R2(e-1,n),R2(t,n)))return!1;if(D2(t,n)){if(M2(R2(t,n),R2(t-1,n),R2(e,n))&&k2(R2(t,n),R2(t+1,n),R2(e,n)))return!1}else if(k2(R2(t,n),R2(t+1,n),R2(e,n))||M2(R2(t,n),R2(t-1,n),R2(e,n)))return!1;for(var i=0;i<n.length;++i)if((i+1)%n.length!=e&&i!=e&&(i+1)%n.length!=t&&i!=t){var r=new ri;if(U2(R2(e,n),R2(t,n),R2(i,n),R2(i+1,n),r))return!1}return!0}function D2(e,t){return O2(e,t)}function O2(e,t,n){if(void 0===n){var i=e,r=t;e=R2(i-1,r),t=R2(i,r),n=R2(i+1,r)}return G2(e,t,n)<0}function N2(e,t,n){return G2(e,t,n)>0}function M2(e,t,n){return G2(e,t,n)>=0}function k2(e,t,n){return G2(e,t,n)<=0}function L2(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i}function B2(e){F2(e)||e.reverse()}function F2(e){return e.length<3||function(e){var t,n=0;for(t=0;t<e.length;t++){var i=(t+1)%e.length;n+=e[t].x*e[i].y,n-=e[t].y*e[i].x}return n/2}(e)>0}function z2(e,t,n,i){var r,a=new ri,o=t.y-e.y,s=e.x-t.x,c=o*e.x+s*e.y,l=i.y-n.y,u=n.x-i.x,h=l*n.x+u*n.y,_=o*u-l*s;return r=_,0,Math.abs(r-0)<=1e-6||(a.x=(u*c-s*h)/_,a.y=(o*h-l*c)/_),a}function U2(e,t,n,i,r){if(e==n||e==i||t==n||t==i)return!1;var a=e.x,o=e.y,s=t.x,c=t.y,l=n.x,u=n.y,h=i.x,_=i.y;if(Math.max(a,s)<Math.min(l,h)||Math.max(l,h)<Math.min(a,s))return!1;if(Math.max(o,c)<Math.min(u,_)||Math.max(u,_)<Math.min(o,c))return!1;var f=(h-l)*(o-u)-(_-u)*(a-l),d=(s-a)*(o-u)-(c-o)*(a-l),p=(_-u)*(s-a)-(h-l)*(c-o);return!(Math.abs(p)<1e-6)&&(d/=p,(f/=p)>0&&f<1&&d>0&&d<1&&(r.x=a+f*(s-a),r.y=o+f*(c-o),!0))}function G2(e,t,n){return e.x*(t.y-n.y)+t.x*(n.y-e.y)+n.x*(e.y-t.y)}w2.lineLine=v2,w2.lineRect=function(e,t,n){var i=g2.set(n.x,n.y),r=y2.set(n.x,n.yMax),a=x2.set(n.xMax,n.yMax),o=S2.set(n.xMax,n.y);return!!(v2(e,t,i,r)||v2(e,t,r,a)||v2(e,t,a,o)||v2(e,t,o,i))},w2.linePolygon=T2,w2.rectRect=function(e,t){var n=e.x,i=e.y,r=e.x+e.width,a=e.y+e.height,o=t.x,s=t.y,c=t.x+t.width,l=t.y+t.height;return n<=c&&r>=o&&i<=l&&a>=s},w2.rectPolygon=function(e,t){var n=g2.set(e.x,e.y),i=y2.set(e.x,e.yMax),r=x2.set(e.xMax,e.yMax),a=S2.set(e.xMax,e.y);if(T2(n,i,t))return!0;if(T2(i,r,t))return!0;if(T2(r,a,t))return!0;if(T2(a,n,t))return!0;for(var o=0,s=t.length;o<s;++o)if(e.contains(t[o]))return!0;return!!(E2(n,t)||E2(i,t)||E2(r,t)||E2(a,t))},w2.rectCircle=function(e,t,n){var i=t.x,r=t.y,a=e.x,o=e.y,s=e.width,c=e.height,l=i,u=r;i<a?l=a:i>a+s&&(l=a+s),r<o?u=o:r>o+c&&(u=o+c);var h=i-l,_=r-u;return Math.sqrt(h*h+_*_)<=n},w2.polygonPolygon=function(e,t){var n,i;for(n=0,i=e.length;n<i;++n)if(T2(e[n],e[(n+1)%i],t))return!0;for(n=0,i=t.length;n<i;++n)if(E2(t[n],e))return!0;for(n=0,i=e.length;n<i;++n)if(E2(e[n],t))return!0;return!1},w2.circleCircle=function(e,t,n,i){return ri.distance(e,n)<t+i},w2.polygonCircle=function(e,t,n){var i=t;if(E2(i,e))return!0;for(var r=0,a=e.length;r<a;r++)if(C2(i,0===r?e[e.length-1]:e[r-1],e[r],!0)<n)return!0;return!1},w2.pointInPolygon=E2,w2.pointLineDistance=C2;var H2,V2,j2,W2,q2,X2=Object.freeze({__proto__:null,ConvexPartition:function e(t){B2(t);for(var n,i,r,a,o,s,c=[],l=new ri,u=new ri,h=0,_=0,f=0;f<t.length;++f)if(D2(f,t)){i=r=1e8;for(var d=0;d<t.length;++d)N2(R2(f-1,t),R2(f,t),R2(d,t))&&k2(R2(f-1,t),R2(f,t),R2(d-1,t))&&(a=z2(R2(f-1,t),R2(f,t),R2(d,t),R2(d-1,t)),O2(R2(f+1,t),R2(f,t),a)&&(n=L2(R2(f,t),a))<i&&(i=n,l=a,h=d)),N2(R2(f+1,t),R2(f,t),R2(d+1,t))&&k2(R2(f+1,t),R2(f,t),R2(d,t))&&(a=z2(R2(f+1,t),R2(f,t),R2(d,t),R2(d+1,t)),N2(R2(f-1,t),R2(f,t),a)&&(n=L2(R2(f,t),a))<r&&(r=n,_=d,u=a));if(h==(_+1)%t.length){var p=l.add(u).multiplyScalar(.5);(o=P2(f,_,t)).push(p),(s=P2(h,f,t)).push(p)}else{for(var m=0,v=h;_<h;)_+=t.length;for(var g=h;g<=_;++g)if(I2(f,g,t)){var y=1/(L2(R2(f,t),R2(g,t))+1);D2(g,t)?k2(R2(g-1,t),R2(g,t),R2(f,t))&&M2(R2(g+1,t),R2(g,t),R2(f,t))?y+=3:y+=2:y+=1,y>m&&(v=g,m=y)}o=P2(f,v,t),s=P2(v,f,t)}return(c=c.concat(e(o))).concat(e(s))}c.push(t);for(var x=c.length-1;x>=0;x--)0==c[x].length&&c.splice(x,0);return c},ForceCounterClockWise:B2,IsCounterClockWise:F2});!function(e){e[e.Static=0]="Static",e[e.Kinematic=1]="Kinematic",e[e.Dynamic=2]="Dynamic",e[e.Animated=3]="Animated"}(H2||(H2=e("ERigidBody2DType",{}))),mt(H2),function(e){e[e.None=0]="None",e[e.BOX=1]="BOX",e[e.CIRCLE=2]="CIRCLE",e[e.POLYGON=3]="POLYGON"}(V2||(V2=e("ECollider2DType",{}))),mt(V2),function(e){e[e.None=0]="None",e[e.DISTANCE=1]="DISTANCE",e[e.SPRING=2]="SPRING",e[e.WHEEL=3]="WHEEL",e[e.MOUSE=4]="MOUSE",e[e.FIXED=5]="FIXED",e[e.SLIDER=6]="SLIDER",e[e.RELATIVE=7]="RELATIVE",e[e.HINGE=8]="HINGE"}(j2||(j2=e("EJoint2DType",{}))),mt(j2),function(e){e[e.DEFAULT=1]="DEFAULT"}(W2||(W2=e("PhysicsGroup",{}))),mt(W2),function(e){e[e.Closest=0]="Closest",e[e.Any=1]="Any",e[e.AllClosest=2]="AllClosest",e[e.All=3]="All"}(q2||(q2=e("ERaycast2DType",{})));var Y2,K2=e("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});!function(e){e[e.None=0]="None",e[e.Shape=1]="Shape",e[e.Joint=2]="Joint",e[e.Aabb=4]="Aabb",e[e.Pair=8]="Pair",e[e.CenterOfMass=16]="CenterOfMass",e[e.Particle=32]="Particle",e[e.Controller=64]="Controller",e[e.All=63]="All"}(Y2||(Y2=e("EPhysics2DDrawFlags",{})));var Q2=e("PHYSICS_2D_PTM_RATIO",32),Z2=function(){return 0},J2={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:Z2,setType:Z2,setLinearDamping:Z2,setAngularDamping:Z2,setGravityScale:Z2,setFixedRotation:Z2,setAllowSleep:Z2,isActive:Z2,setActive:Z2,wakeUp:Z2,sleep:Z2,getMass:Z2,getInertia:Z2,getLinearVelocity:Z2,setLinearVelocity:Z2,getLinearVelocityFromWorldPoint:Z2,getAngularVelocity:Z2,setAngularVelocity:Z2,getLocalVector:Z2,getWorldVector:Z2,getLocalPoint:Z2,getWorldPoint:Z2,getLocalCenter:Z2,getWorldCenter:Z2,applyForce:Z2,applyForceToCenter:Z2,applyTorque:Z2,applyLinearImpulse:Z2,applyLinearImpulseToCenter:Z2,applyAngularImpulse:Z2,onEnable:Z2,onDisable:Z2,onDestroy:Z2},$2={INITED:!1};var e4,t4,n4,i4,r4,a4,o4={INITED:!1},s4={impl:null,initialize:Z2,setDampingRatio:Z2,setFrequency:Z2,setMaxForce:Z2,setTarget:Z2,setDistance:Z2,setAngularOffset:Z2,setCorrectionFactor:Z2,setLinearOffset:Z2,setMaxLength:Z2,setMaxTorque:Z2,setLowerLimit:Z2,setUpperLimit:Z2,setMaxMotorForce:Z2,setMaxMotorTorque:Z2,setMotorSpeed:Z2,enableLimit:Z2,enableMotor:Z2,setLowerAngle:Z2,setUpperAngle:Z2};!function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(e4||(e4={})),mt(e4),function(e){e[e.X_AXIS=0]="X_AXIS",e[e.Y_AXIS=1]="Y_AXIS",e[e.Z_AXIS=2]="Z_AXIS"}(t4||(t4={})),mt(t4),function(e){e[e.VERTEX=1]="VERTEX",e[e.LINE=2]="LINE",e[e.TRIANGLE=3]="TRIANGLE",e[e.TETRAHEDRON=4]="TETRAHEDRON"}(n4||(n4={})),mt(n4),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.MESH=5]="MESH",e[e.PLANE=6]="PLANE",e[e.SIMPLEX=7]="SIMPLEX",e[e.TERRAIN=8]="TERRAIN"}(i4||(i4={})),mt(i4),function(e){e[e.POINT_TO_POINT=0]="POINT_TO_POINT",e[e.HINGE=1]="HINGE",e[e.CONE_TWIST=2]="CONE_TWIST"}(r4||(r4={})),mt(r4),function(e){e[e.DEFAULT=1]="DEFAULT"}(a4||(a4={})),mt(a4);var c4,l4,u4,h4,_4,f4,d4,p4,m4,v4,g4,y4,x4,S4,T4,E4,C4,A4,b4,w4=function e(t){if(K(this,e),1===t){for(var n=this,i=function(e){var t="_".concat(1<<e);n[t]=0,n.updateArray=[],Object.defineProperty(n,1<<e,{get:function(){return this[t]},set:function(n){this[t]!==n&&(this[t]=n,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})},r=0;r<32;r++)i(r);this._1=a4.DEFAULT}else{for(var a=0;a<32;a++)this["".concat(1<<a)]=0;this[1]=a4.DEFAULT}},R4=null,P4=e("PhysicsSystem2D",function(e){te(n,e);var t=le(n);function n(){var e;K(this,n),(e=t.call(this)).velocityIterations=10,e.positionIterations=10,e.physicsWorld=void 0,e.collisionMatrix=new w4,e._enable=!0,e._allowSleep=!0,e._maxSubSteps=1,e._fixedTimeStep=1/60,e._autoSimulation=!0,e._accumulator=0,e._steping=!1,e._gravity=new ri(0,-10*Q2),e._delayEvents=[];var i=ZN.config?ZN.config.physics:null;if(i){if(ri.copy(e._gravity,i.gravity),e._gravity.multiplyScalar(Q2),e._allowSleep=i.allowSleep,e._fixedTimeStep=i.fixedTimeStep,e._maxSubSteps=i.maxSubSteps,e._autoSimulation=i.autoSimulation,i.collisionMatrix)for(var r in i.collisionMatrix){var a=parseInt(r),o=1<<parseInt(r);e.collisionMatrix["".concat(o)]=i.collisionMatrix[a]}if(i.collisionGroups){var s=i.collisionGroups;s instanceof Array&&(s.forEach((function(e){W2[e.name]=1<<e.index})),mt.update(W2))}}return e.physicsWorld=new A2.PhysicsWorld,e.gravity=e._gravity,e.allowSleep=e._allowSleep,e}return Z(n,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.physicsWorld.setAllowSleep(e)}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e),this.physicsWorld.setGravity(new ri(e.x/Q2,e.y/Q2))}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(e){this._maxSubSteps=e}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(e){this._fixedTimeStep=e}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(e){this._autoSimulation=e}},{key:"debugDrawFlags",get:function(){return this.physicsWorld.debugDrawFlags},set:function(e){this.physicsWorld.debugDrawFlags=e}},{key:"stepping",get:function(){return this._steping}},{key:"postUpdate",value:function(e){if(this._enable&&this._autoSimulation){$N.emit(JN.EVENT_BEFORE_PHYSICS),this._steping=!0;var t=this._fixedTimeStep,n=this.velocityIterations,i=this.positionIterations;this._accumulator+=e;for(var r=0;r++<this._maxSubSteps&&this._accumulator>t;)this.physicsWorld.step(t,n,i),this._accumulator-=t;for(var a=this._delayEvents,o=0,s=a.length;o<s;o++){var c=a[o];c.func.call(c.target)}a.length=0,this.physicsWorld.syncPhysicsToScene(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,$N.emit(JN.EVENT_AFTER_PHYSICS)}}},{key:"_callAfterStep",value:function(e,t){this._steping?this._delayEvents.push({target:e,func:t}):t.call(e)}},{key:"resetAccumulator",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._accumulator=e}},{key:"step",value:function(e){this.physicsWorld.step(e,this.velocityIterations,this.positionIterations)}},{key:"raycast",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:q2.Closest,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4294967295;return this.physicsWorld.raycast(e,t,n,i)}},{key:"testPoint",value:function(e){return this.physicsWorld.testPoint(e)}},{key:"testAABB",value:function(e){return this.physicsWorld.testAABB(e)}}],[{key:"PHYSICS_NONE",get:function(){return!b2}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===b2}},{key:"PHYSICS_BOX2D",get:function(){return"box2d"===b2}},{key:"PhysicsGroup",get:function(){return W2}},{key:"instance",get:function(){return R4||(R4=new n),R4}}]),n}(cu(zN)));P4.ID="PHYSICS_2D",$N.once(JN.EVENT_INIT,(function(){P4.PHYSICS_NONE||$N.registerSystem(P4.ID,P4.instance,zN.Priority.LOW)})),function(e){e[e.Circles=0]="Circles",e[e.FaceA=1]="FaceA",e[e.FaceB=2]="FaceB"}(c4||(c4=e("Physics2DManifoldType",{})));var I4,D4,O4,N4,M4,k4,L4,B4,F4,z4,U4,G4,H4,V4,j4,W4,q4,X4,Y4,K4,Q4,Z4,J4,$4,e3,t3,n3,i3,r3,a3,o3,s3,c3,l3,u3,h3,_3,f3,d3,p3,m3,v3,g3,y3,x3,S3,T3,E3,C3,A3,b3,w3,R3,P3,I3,D3,O3,N3,M3,k3,L3,B3,F3,z3,U3,G3,H3,V3,j3,W3,q3,X3,Y3,K3,Q3,Z3,J3,$3,e5,t5,n5,i5,r5,a5,o5,s5,c5,l5,u5,h5,_5,f5,d5,p5=Rc,m5=rl,v5=Lc,g5=e("RigidBody2D",(l4=Cc("cc.RigidBody2D"),u4=v5(),h4=m5(a4),_4=m5(H2),l4(f4=u4((xe((d4=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"enabledContactListener",p4,se(e)),ye(e,"bullet",m4,se(e)),ye(e,"awakeOnLoad",v4,se(e)),e._body=null,ye(e,"_group",g4,se(e)),ye(e,"_type",y4,se(e)),ye(e,"_allowSleep",x4,se(e)),ye(e,"_gravityScale",S4,se(e)),ye(e,"_linearDamping",T4,se(e)),ye(e,"_angularDamping",E4,se(e)),ye(e,"_linearVelocity",C4,se(e)),ye(e,"_angularVelocity",A4,se(e)),ye(e,"_fixedRotation",b4,se(e)),e}return Z(n,[{key:"group",get:function(){return this._group},set:function(e){this._group=e}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._body&&(e===H2.Animated?this._body.setType(H2.Kinematic):this._body.setType(e))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}},{key:"gravityScale",get:function(){return this._gravityScale},set:function(e){this._gravityScale=e,this._body&&this._body.setGravityScale(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}},{key:"linearVelocity",get:function(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity},set:function(e){this._linearVelocity=e,this._body&&this._body.setLinearVelocity(e)}},{key:"angularVelocity",get:function(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity},set:function(e){this._angularVelocity=e,this._body&&this._body.setAngularVelocity(e)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e,this._body&&this._body.setFixedRotation(e)}},{key:"isAwake",value:function(){return!!this._body&&this._body.isAwake}},{key:"wakeUp",value:function(){this._body&&this._body.wakeUp()}},{key:"sleep",value:function(){this._body&&this._body.sleep()}},{key:"getMass",value:function(){return this._body?this._body.getMass():0}},{key:"applyForce",value:function(e,t,n){this._body&&this._body.applyForce(e,t,n)}},{key:"applyForceToCenter",value:function(e,t){this._body&&this._body.applyForceToCenter(e,t)}},{key:"applyTorque",value:function(e,t){this._body&&this._body.applyTorque(e,t)}},{key:"applyLinearImpulse",value:function(e,t,n){this._body&&this._body.applyLinearImpulse(e,t,n)}},{key:"applyLinearImpulseToCenter",value:function(e,t){this._body&&this._body.applyLinearImpulseToCenter(e,t)}},{key:"applyAngularImpulse",value:function(e,t){this._body&&this._body.applyAngularImpulse(e,t)}},{key:"getLinearVelocityFromWorldPoint",value:function(e,t){return this._body?this._body.getLinearVelocityFromWorldPoint(e,t):t}},{key:"getLocalVector",value:function(e,t){return this._body?this._body.getLocalVector(e,t):t}},{key:"getWorldVector",value:function(e,t){return this._body?this._body.getWorldVector(e,t):t}},{key:"getLocalPoint",value:function(e,t){return this._body?this._body.getLocalPoint(e,t):t}},{key:"getWorldPoint",value:function(e,t){return this._body?this._body.getWorldPoint(e,t):t}},{key:"getLocalCenter",value:function(e){return this._body?this._body.getLocalCenter(e):e}},{key:"getWorldCenter",value:function(e){return this._body?this._body.getWorldCenter(e):e}},{key:"getInertia",value:function(){return this._body&&this._body.getInertia(),0}},{key:"onLoad",value:function(){this._body=c._global.CC_PHYSICS_2D_BUILTIN?J2:new A2.RigidBody,this._body.initialize(this)}},{key:"onEnable",value:function(){this._body&&this._body.onEnable()}},{key:"onDisable",value:function(){this._body&&this._body.onDisable()}},{key:"onDestroy",value:function(){this._body&&this._body.onDestroy()}},{key:"impl",get:function(){return this._body}}]),n}(sh)).prototype,"group",[h4],Object.getOwnPropertyDescriptor(d4.prototype,"group"),d4.prototype),p4=xe(d4.prototype,"enabledContactListener",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m4=xe(d4.prototype,"bullet",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xe(d4.prototype,"type",[_4],Object.getOwnPropertyDescriptor(d4.prototype,"type"),d4.prototype),xe(d4.prototype,"allowSleep",[p5],Object.getOwnPropertyDescriptor(d4.prototype,"allowSleep"),d4.prototype),xe(d4.prototype,"gravityScale",[p5],Object.getOwnPropertyDescriptor(d4.prototype,"gravityScale"),d4.prototype),xe(d4.prototype,"linearDamping",[p5],Object.getOwnPropertyDescriptor(d4.prototype,"linearDamping"),d4.prototype),xe(d4.prototype,"angularDamping",[p5],Object.getOwnPropertyDescriptor(d4.prototype,"angularDamping"),d4.prototype),xe(d4.prototype,"linearVelocity",[p5],Object.getOwnPropertyDescriptor(d4.prototype,"linearVelocity"),d4.prototype),xe(d4.prototype,"angularVelocity",[p5],Object.getOwnPropertyDescriptor(d4.prototype,"angularVelocity"),d4.prototype),xe(d4.prototype,"fixedRotation",[p5],Object.getOwnPropertyDescriptor(d4.prototype,"fixedRotation"),d4.prototype),v4=xe(d4.prototype,"awakeOnLoad",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),g4=xe(d4.prototype,"_group",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a4.DEFAULT}}),y4=xe(d4.prototype,"_type",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return H2.Dynamic}}),x4=xe(d4.prototype,"_allowSleep",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),S4=xe(d4.prototype,"_gravityScale",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),T4=xe(d4.prototype,"_linearDamping",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),E4=xe(d4.prototype,"_angularDamping",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C4=xe(d4.prototype,"_linearVelocity",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri}}),A4=xe(d4.prototype,"_angularVelocity",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b4=xe(d4.prototype,"_fixedRotation",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f4=d4))||f4)||f4)),y5=e("Collider2D",(I4=Cc("cc.Collider2D"),D4=rl(a4),I4((H4=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"editing",M4,se(e)),ye(e,"tag",k4,se(e)),e.TYPE=V2.None,e._shape=null,e._body=null,ye(e,"_group",L4,se(e)),ye(e,"_density",B4,se(e)),ye(e,"_sensor",F4,se(e)),ye(e,"_friction",z4,se(e)),ye(e,"_restitution",U4,se(e)),ye(e,"_offset",G4,se(e)),e}return Z(n,[{key:"group",get:function(){return this._group},set:function(e){this._group=e,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}},{key:"density",get:function(){return this._density},set:function(e){this._density=e}},{key:"sensor",get:function(){return this._sensor},set:function(e){this._sensor=e}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction=e}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution=e}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e}},{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._shape}},{key:"onLoad",value:function(){this._shape=function(e){return $2.INITED||($2.INITED=!0,$2[V2.BOX]=function(){return new A2.BoxShape},$2[V2.CIRCLE]=function(){return new A2.CircleShape},$2[V2.POLYGON]=function(){return new A2.PolygonShape}),$2[e]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(g5)}},{key:"onEnable",value:function(){this._shape&&this._shape.onEnable()}},{key:"onDisable",value:function(){this._shape&&this._shape.onDisable&&this._shape.onDisable()}},{key:"onDestroy",value:function(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()}},{key:"apply",value:function(){this._shape&&this._shape.apply&&this._shape.apply()}},{key:"worldAABB",get:function(){return this._shape?this._shape.worldAABB:new fi}}]),n}(cu(sh)),M4=xe((N4=H4).prototype,"editing",[Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k4=xe(N4.prototype,"tag",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xe(N4.prototype,"group",[D4],Object.getOwnPropertyDescriptor(N4.prototype,"group"),N4.prototype),xe(N4.prototype,"density",[Rc],Object.getOwnPropertyDescriptor(N4.prototype,"density"),N4.prototype),xe(N4.prototype,"sensor",[Rc],Object.getOwnPropertyDescriptor(N4.prototype,"sensor"),N4.prototype),xe(N4.prototype,"friction",[Rc],Object.getOwnPropertyDescriptor(N4.prototype,"friction"),N4.prototype),xe(N4.prototype,"restitution",[Rc],Object.getOwnPropertyDescriptor(N4.prototype,"restitution"),N4.prototype),xe(N4.prototype,"offset",[Rc],Object.getOwnPropertyDescriptor(N4.prototype,"offset"),N4.prototype),L4=xe(N4.prototype,"_group",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a4.DEFAULT}}),B4=xe(N4.prototype,"_density",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),F4=xe(N4.prototype,"_sensor",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),z4=xe(N4.prototype,"_friction",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.2}}),U4=xe(N4.prototype,"_restitution",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),G4=xe(N4.prototype,"_offset",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri}}),O4=N4))||O4)),x5=(e("BoxCollider2D",Cc("cc.BoxCollider2D")(V4=Lc()((q4=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_size",W4,se(e)),e.TYPE=V2.BOX,e}return Z(n,[{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),n}(y5),W4=xe((j4=q4).prototype,"_size",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(1,1)}}),xe(j4.prototype,"size",[Rc],Object.getOwnPropertyDescriptor(j4.prototype,"size"),j4.prototype),V4=j4))||V4)||V4),e("CircleCollider2D",Cc("cc.CircleCollider2D")(X4=Lc()((Q4=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_radius",K4,se(e)),e.TYPE=V2.CIRCLE,e}return Z(n,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e<0?0:e}},{key:"worldPosition",get:function(){return this._shape?this._shape.worldPosition:new ri}},{key:"worldRadius",get:function(){return this._shape?this._shape.worldRadius:0}}]),n}(y5),K4=xe((Y4=Q4).prototype,"_radius",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),xe(Y4.prototype,"radius",[Rc],Object.getOwnPropertyDescriptor(Y4.prototype,"radius"),Y4.prototype),X4=Y4))||X4)||X4),e("PolygonCollider2D",(Z4=Cc("cc.PolygonCollider2D"),J4=Lc(),$4=Rc({serializable:!1,displayOrder:0}),e3=Rc({type:ri}),Z4(t3=J4((a3=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"threshold",i3,se(e)),ye(e,"_points",r3,se(e)),e.TYPE=V2.POLYGON,e}return Z(n,[{key:"points",get:function(){return this._points},set:function(e){this._points=e}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),n}(y5),i3=xe((n3=a3).prototype,"threshold",[$4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),r3=xe(n3.prototype,"_points",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new ri(-1,-1),new ri(1,-1),new ri(1,1),new ri(-1,1)]}}),xe(n3.prototype,"points",[e3],Object.getOwnPropertyDescriptor(n3.prototype,"points"),n3.prototype),t3=n3))||t3)||t3)),e("Joint2D",(o3=Cc("cc.Joint2D"),s3=rl(g5),o3((d3=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"anchor",u3,se(e)),ye(e,"connectedAnchor",h3,se(e)),ye(e,"collideConnected",_3,se(e)),ye(e,"connectedBody",f3,se(e)),e._body=null,e._joint=null,e.TYPE=j2.None,e}return Z(n,[{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._joint}},{key:"onLoad",value:function(){this._joint=function(e){return function(){if(!o4.INITED){o4.INITED=!0;var e=c._global.CC_PHYSICS_2D_BUILTIN;o4[j2.SPRING]=function(){return e?s4:new A2.SpringJoint},o4[j2.DISTANCE]=function(){return e?s4:new A2.DistanceJoint},o4[j2.FIXED]=function(){return e?s4:new A2.FixedJoint},o4[j2.MOUSE]=function(){return e?s4:new A2.MouseJoint},o4[j2.RELATIVE]=function(){return e?s4:new A2.RelativeJoint},o4[j2.SLIDER]=function(){return e?s4:new A2.SliderJoint},o4[j2.WHEEL]=function(){return e?s4:new A2.WheelJoint},o4[j2.HINGE]=function(){return e?s4:new A2.HingeJoint}}}(),o4[e]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(g5)}},{key:"onEnable",value:function(){this._joint&&this._joint.onEnable&&this._joint.onEnable()}},{key:"onDisable",value:function(){this._joint&&this._joint.onDisable&&this._joint.onDisable()}},{key:"start",value:function(){this._joint&&this._joint.start&&this._joint.start()}},{key:"onDestroy",value:function(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()}}]),n}(sh),u3=xe((l3=d3).prototype,"anchor",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri}}),h3=xe(l3.prototype,"connectedAnchor",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri}}),_3=xe(l3.prototype,"collideConnected",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f3=xe(l3.prototype,"connectedBody",[s3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c3=l3))||c3))),S5=(e("DistanceJoint2D",Cc("cc.DistanceJoint2D")(p3=Lc()((xe((m3=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).TYPE=j2.DISTANCE,ye(e,"_maxLength",v3,se(e)),ye(e,"_autoCalcDistance",g3,se(e)),e}return Z(n,[{key:"maxLength",get:function(){return this._autoCalcDistance&&this.connectedBody?zn.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._maxLength},set:function(e){this._maxLength=e,this._joint&&this._joint.setMaxLength(e)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(e){this._autoCalcDistance=e}}]),n}(x5)).prototype,"maxLength",[Rc],Object.getOwnPropertyDescriptor(m3.prototype,"maxLength"),m3.prototype),xe(m3.prototype,"autoCalcDistance",[Rc],Object.getOwnPropertyDescriptor(m3.prototype,"autoCalcDistance"),m3.prototype),v3=xe(m3.prototype,"_maxLength",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),g3=xe(m3.prototype,"_autoCalcDistance",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),p3=m3))||p3)||p3),e("SpringJoint2D",Cc("cc.SpringJoint2D")(y3=Lc()((xe((x3=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).TYPE=j2.SPRING,ye(e,"_frequency",S3,se(e)),ye(e,"_dampingRatio",T3,se(e)),ye(e,"_distance",E3,se(e)),ye(e,"_autoCalcDistance",C3,se(e)),e}return Z(n,[{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}},{key:"distance",get:function(){return this._autoCalcDistance&&this.connectedBody?zn.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._distance},set:function(e){this._distance=e,this._joint&&this._joint.setDistance(e)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(e){this._autoCalcDistance=e}}]),n}(x5)).prototype,"frequency",[Rc],Object.getOwnPropertyDescriptor(x3.prototype,"frequency"),x3.prototype),xe(x3.prototype,"dampingRatio",[Rc],Object.getOwnPropertyDescriptor(x3.prototype,"dampingRatio"),x3.prototype),xe(x3.prototype,"distance",[Rc],Object.getOwnPropertyDescriptor(x3.prototype,"distance"),x3.prototype),xe(x3.prototype,"autoCalcDistance",[Rc],Object.getOwnPropertyDescriptor(x3.prototype,"autoCalcDistance"),x3.prototype),S3=xe(x3.prototype,"_frequency",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),T3=xe(x3.prototype,"_dampingRatio",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),E3=xe(x3.prototype,"_distance",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),C3=xe(x3.prototype,"_autoCalcDistance",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),y3=x3))||y3)||y3),e("MouseJoint2D",Cc("cc.MouseJoint2D")(A3=Lc()((xe((b3=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).TYPE=j2.MOUSE,ye(e,"_maxForce",w3,se(e)),ye(e,"_dampingRatio",R3,se(e)),ye(e,"_frequency",P3,se(e)),e._target=new ri,e}return Z(n,[{key:"target",get:function(){return this._target},set:function(e){this._target=e,this._joint&&this._joint.setTarget(e)}},{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}},{key:"maxForce",get:function(){return this._maxForce},set:function(e){this._maxForce=e,this._joint&&this._joint.setMaxForce(e)}},{key:"update",value:function(e){this._joint.update(e)}}]),n}(x5)).prototype,"frequency",[Rc],Object.getOwnPropertyDescriptor(b3.prototype,"frequency"),b3.prototype),xe(b3.prototype,"dampingRatio",[Rc],Object.getOwnPropertyDescriptor(b3.prototype,"dampingRatio"),b3.prototype),xe(b3.prototype,"maxForce",[Rc],Object.getOwnPropertyDescriptor(b3.prototype,"maxForce"),b3.prototype),w3=xe(b3.prototype,"_maxForce",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),R3=xe(b3.prototype,"_dampingRatio",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),P3=xe(b3.prototype,"_frequency",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),A3=b3))||A3)||A3),new zn),T5=new zn,E5=(e("RelativeJoint2D",Cc("cc.RelativeJoint2D")(I3=Lc()((xe((D3=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).TYPE=j2.RELATIVE,ye(e,"_maxForce",O3,se(e)),ye(e,"_maxTorque",N3,se(e)),ye(e,"_correctionFactor",M3,se(e)),ye(e,"_angularOffset",k3,se(e)),ye(e,"_linearOffset",L3,se(e)),ye(e,"_autoCalcOffset",B3,se(e)),e}return Z(n,[{key:"maxForce",get:function(){return this._maxForce},set:function(e){this._maxForce=e,this._joint&&this._joint.setMaxForce(e)}},{key:"maxTorque",get:function(){return this._maxTorque},set:function(e){this._maxTorque=e,this._joint&&this._joint.setMaxTorque(e)}},{key:"correctionFactor",get:function(){return this._correctionFactor},set:function(e){this._correctionFactor=e,this._joint&&this._joint.setCorrectionFactor(e)}},{key:"linearOffset",get:function(){return this._autoCalcOffset&&this.connectedBody?ri.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):this._linearOffset},set:function(e){this._linearOffset.set(e),this._joint&&this._joint.setLinearOffset(e)}},{key:"angularOffset",get:function(){return this._autoCalcOffset&&this.connectedBody&&(qn.toEuler(S5,this.node.worldRotation),qn.toEuler(T5,this.connectedBody.node.worldRotation),this._angularOffset=T5.z-S5.z),this._angularOffset},set:function(e){this._angularOffset=e,this._joint&&this._joint.setAngularOffset(e)}},{key:"autoCalcOffset",get:function(){return this._autoCalcOffset},set:function(e){this._autoCalcOffset=e}}]),n}(x5)).prototype,"maxForce",[Rc],Object.getOwnPropertyDescriptor(D3.prototype,"maxForce"),D3.prototype),xe(D3.prototype,"maxTorque",[Rc],Object.getOwnPropertyDescriptor(D3.prototype,"maxTorque"),D3.prototype),xe(D3.prototype,"correctionFactor",[Rc],Object.getOwnPropertyDescriptor(D3.prototype,"correctionFactor"),D3.prototype),xe(D3.prototype,"linearOffset",[Rc],Object.getOwnPropertyDescriptor(D3.prototype,"linearOffset"),D3.prototype),xe(D3.prototype,"angularOffset",[Rc],Object.getOwnPropertyDescriptor(D3.prototype,"angularOffset"),D3.prototype),xe(D3.prototype,"autoCalcOffset",[Rc],Object.getOwnPropertyDescriptor(D3.prototype,"autoCalcOffset"),D3.prototype),O3=xe(D3.prototype,"_maxForce",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),N3=xe(D3.prototype,"_maxTorque",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),M3=xe(D3.prototype,"_correctionFactor",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),k3=xe(D3.prototype,"_angularOffset",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),L3=xe(D3.prototype,"_linearOffset",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri}}),B3=xe(D3.prototype,"_autoCalcOffset",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I3=D3))||I3)||I3),new ri),C5=(e("SliderJoint2D",Cc("cc.SliderJoint2D")(F3=Lc()((xe((z3=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).TYPE=j2.SLIDER,ye(e,"_angle",U3,se(e)),ye(e,"_autoCalcAngle",G3,se(e)),ye(e,"_enableMotor",H3,se(e)),ye(e,"_maxMotorForce",V3,se(e)),ye(e,"_motorSpeed",j3,se(e)),ye(e,"_enableLimit",W3,se(e)),ye(e,"_lowerLimit",q3,se(e)),ye(e,"_upperLimit",X3,se(e)),e}return Z(n,[{key:"angle",get:function(){return this._autoCalcAngle&&this.connectedBody&&(ri.subtract(E5,this.connectedBody.node.worldPosition,this.node.worldPosition),this._angle=Tn(Math.atan2(E5.y,E5.x))),this._angle},set:function(e){this._angle=e}},{key:"autoCalcAngle",get:function(){return this._autoCalcAngle},set:function(e){this._autoCalcAngle=e}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(e){this._enableMotor=e}},{key:"maxMotorForce",get:function(){return this._maxMotorForce},set:function(e){this._maxMotorForce=e,this._joint&&this._joint.setMaxMotorForce(e)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(e){this._motorSpeed=e,this._joint&&this._joint.setMotorSpeed(e)}},{key:"enableLimit",get:function(){return this._enableLimit},set:function(e){this._enableLimit=e}},{key:"lowerLimit",get:function(){return this._lowerLimit},set:function(e){this._lowerLimit=e,this._joint&&this._joint.setLowerLimit(e)}},{key:"upperLimit",get:function(){return this._upperLimit},set:function(e){this._upperLimit=e,this._joint&&this._joint.setUpperLimit(e)}}]),n}(x5)).prototype,"angle",[Rc],Object.getOwnPropertyDescriptor(z3.prototype,"angle"),z3.prototype),xe(z3.prototype,"autoCalcAngle",[Rc],Object.getOwnPropertyDescriptor(z3.prototype,"autoCalcAngle"),z3.prototype),xe(z3.prototype,"enableMotor",[Rc],Object.getOwnPropertyDescriptor(z3.prototype,"enableMotor"),z3.prototype),xe(z3.prototype,"maxMotorForce",[Rc],Object.getOwnPropertyDescriptor(z3.prototype,"maxMotorForce"),z3.prototype),xe(z3.prototype,"motorSpeed",[Rc],Object.getOwnPropertyDescriptor(z3.prototype,"motorSpeed"),z3.prototype),xe(z3.prototype,"enableLimit",[Rc],Object.getOwnPropertyDescriptor(z3.prototype,"enableLimit"),z3.prototype),xe(z3.prototype,"lowerLimit",[Rc],Object.getOwnPropertyDescriptor(z3.prototype,"lowerLimit"),z3.prototype),xe(z3.prototype,"upperLimit",[Rc],Object.getOwnPropertyDescriptor(z3.prototype,"upperLimit"),z3.prototype),U3=xe(z3.prototype,"_angle",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),G3=xe(z3.prototype,"_autoCalcAngle",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),H3=xe(z3.prototype,"_enableMotor",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),V3=xe(z3.prototype,"_maxMotorForce",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),j3=xe(z3.prototype,"_motorSpeed",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),W3=xe(z3.prototype,"_enableLimit",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q3=xe(z3.prototype,"_lowerLimit",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X3=xe(z3.prototype,"_upperLimit",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),F3=z3))||F3)||F3),e("FixedJoint2D",Cc("cc.FixedJoint2D")(Y3=Lc()((xe((K3=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).TYPE=j2.FIXED,ye(e,"_frequency",Q3,se(e)),ye(e,"_dampingRatio",Z3,se(e)),e}return Z(n,[{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}}]),n}(x5)).prototype,"frequency",[Rc],Object.getOwnPropertyDescriptor(K3.prototype,"frequency"),K3.prototype),xe(K3.prototype,"dampingRatio",[Rc],Object.getOwnPropertyDescriptor(K3.prototype,"dampingRatio"),K3.prototype),Q3=xe(K3.prototype,"_frequency",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),Z3=xe(K3.prototype,"_dampingRatio",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Y3=K3))||Y3)||Y3),e("WheelJoint2D",Cc("cc.WheelJoint2D")(J3=Lc()((xe(($3=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).TYPE=j2.WHEEL,ye(e,"_angle",e5,se(e)),ye(e,"_enableMotor",t5,se(e)),ye(e,"_maxMotorTorque",n5,se(e)),ye(e,"_motorSpeed",i5,se(e)),ye(e,"_frequency",r5,se(e)),ye(e,"_dampingRatio",a5,se(e)),e}return Z(n,[{key:"angle",get:function(){return this._angle},set:function(e){this._angle=e}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(e){this._enableMotor=e,this._joint&&this._joint.enableMotor(e)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(e){this._maxMotorTorque=e,this._joint&&this._joint.setMaxMotorTorque(e)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(e){this._motorSpeed=e,this._joint&&this._joint.setMotorSpeed(e)}},{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}}]),n}(x5)).prototype,"angle",[Rc],Object.getOwnPropertyDescriptor($3.prototype,"angle"),$3.prototype),xe($3.prototype,"enableMotor",[Rc],Object.getOwnPropertyDescriptor($3.prototype,"enableMotor"),$3.prototype),xe($3.prototype,"maxMotorTorque",[Rc],Object.getOwnPropertyDescriptor($3.prototype,"maxMotorTorque"),$3.prototype),xe($3.prototype,"motorSpeed",[Rc],Object.getOwnPropertyDescriptor($3.prototype,"motorSpeed"),$3.prototype),xe($3.prototype,"frequency",[Rc],Object.getOwnPropertyDescriptor($3.prototype,"frequency"),$3.prototype),xe($3.prototype,"dampingRatio",[Rc],Object.getOwnPropertyDescriptor($3.prototype,"dampingRatio"),$3.prototype),e5=xe($3.prototype,"_angle",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),t5=xe($3.prototype,"_enableMotor",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),n5=xe($3.prototype,"_maxMotorTorque",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),i5=xe($3.prototype,"_motorSpeed",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),r5=xe($3.prototype,"_frequency",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),a5=xe($3.prototype,"_dampingRatio",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),J3=$3))||J3)||J3),e("HingeJoint2D",Cc("cc.HingeJoint2D")(o5=Lc()((xe((s5=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))).TYPE=j2.HINGE,ye(e,"_enableLimit",c5,se(e)),ye(e,"_lowerAngle",l5,se(e)),ye(e,"_upperAngle",u5,se(e)),ye(e,"_enableMotor",h5,se(e)),ye(e,"_maxMotorTorque",_5,se(e)),ye(e,"_motorSpeed",f5,se(e)),e}return Z(n,[{key:"enableLimit",get:function(){return this._enableLimit},set:function(e){this._enableLimit=e}},{key:"lowerAngle",get:function(){return this._lowerAngle},set:function(e){this._lowerAngle=e,this._joint&&this._joint.setLowerAngle(e)}},{key:"upperAngle",get:function(){return this._upperAngle},set:function(e){this._upperAngle=e,this._joint&&this._joint.setUpperAngle(e)}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(e){this._enableMotor=e,this._joint&&this._joint.enableMotor(e)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(e){this._maxMotorTorque=e,this._joint&&this._joint.setMaxMotorTorque(e)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(e){this._motorSpeed=e,this._joint&&this._joint.setMotorSpeed(e)}}]),n}(x5)).prototype,"enableLimit",[Rc],Object.getOwnPropertyDescriptor(s5.prototype,"enableLimit"),s5.prototype),xe(s5.prototype,"lowerAngle",[Rc],Object.getOwnPropertyDescriptor(s5.prototype,"lowerAngle"),s5.prototype),xe(s5.prototype,"upperAngle",[Rc],Object.getOwnPropertyDescriptor(s5.prototype,"upperAngle"),s5.prototype),xe(s5.prototype,"enableMotor",[Rc],Object.getOwnPropertyDescriptor(s5.prototype,"enableMotor"),s5.prototype),xe(s5.prototype,"maxMotorTorque",[Rc],Object.getOwnPropertyDescriptor(s5.prototype,"maxMotorTorque"),s5.prototype),xe(s5.prototype,"motorSpeed",[Rc],Object.getOwnPropertyDescriptor(s5.prototype,"motorSpeed"),s5.prototype),c5=xe(s5.prototype,"_enableLimit",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),l5=xe(s5.prototype,"_lowerAngle",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),u5=xe(s5.prototype,"_upperAngle",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),h5=xe(s5.prototype,"_enableMotor",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_5=xe(s5.prototype,"_maxMotorTorque",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),f5=xe(s5.prototype,"_motorSpeed",[Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),o5=s5))||o5)||o5),e("Physics2DUtils",{PolygonSeparator:X2}),function(){function e(){K(this,e),this._collider=null,this._worldAabb=new fi}return Z(e,[{key:"impl",get:function(){return null}},{key:"collider",get:function(){return this._collider}},{key:"apply",value:function(){}},{key:"initialize",value:function(e){this._collider=e}},{key:"onLoad",value:function(){}},{key:"onEnable",value:function(){P4.instance.physicsWorld.addShape(this)}},{key:"onDisable",value:function(){P4.instance.physicsWorld.removeShape(this)}},{key:"start",value:function(){}},{key:"update",value:function(){}},{key:"worldAABB",get:function(){return this._worldAabb}},{key:"containsPoint",value:function(e){return!!this.worldAABB.contains(e)}},{key:"intersectsRect",value:function(e){return!!this.worldAABB.intersects(e)}},{key:"onGroupChanged",value:function(){P4.instance.physicsWorld.updateShapeGroup(this)}}]),e}()),A5=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._worldPoints=[new ri,new ri,new ri,new ri],e}return Z(n,[{key:"worldPoints",get:function(){return this._worldPoints}},{key:"update",value:function(){var e=this._worldAabb,t=this.collider,n=t.size,i=t.offset;e.x=i.x-n.width/2,e.y=i.y-n.height/2,e.width=n.width,e.height=n.height;var r=this._worldPoints,a=r[0],o=r[1],s=r[2],c=r[3];e.transformMat4ToPoints(t.node.worldMatrix,a,o,s,c);var l=Math.min(a.x,o.x,s.x,c.x),u=Math.min(a.y,o.y,s.y,c.y),h=Math.max(a.x,o.x,s.x,c.x),_=Math.max(a.y,o.y,s.y,c.y);e.x=l,e.y=u,e.width=h-l,e.height=_-u}},{key:"containsPoint",value:function(e){return!!this.worldAABB.contains(e)&&w2.pointInPolygon(e,this.worldPoints)}},{key:"intersectsRect",value:function(e){return!!this.worldAABB.intersects(e)&&w2.rectPolygon(e,this.worldPoints)}}]),n}(C5),b5=new ri,w5=new ei,R5=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._worldPosition=new ri,e._worldRadius=0,e}return Z(n,[{key:"worldPosition",get:function(){return this._worldPosition}},{key:"worldRadius",get:function(){return this._worldRadius}},{key:"update",value:function(){var e=this._worldAabb,t=this.collider,n=t.node.getWorldMatrix(w5);ri.transformMat4(b5,t.offset,n);var i=this._worldPosition;i.x=b5.x,i.y=b5.y,n.m12=n.m13=0,b5.x=t.radius,b5.y=0,ri.transformMat4(b5,b5,n);var r=this._worldRadius=b5.length();e.x=i.x-r,e.y=i.y-r,e.width=2*r,e.height=2*r}},{key:"containsPoint",value:function(e){return!!this.worldAABB.contains(e)&&ri.subtract(b5,e,this.worldPosition).length()<this.worldRadius}},{key:"intersectsRect",value:function(e){return!!this.worldAABB.intersects(e)&&w2.rectCircle(e,this.worldPosition,this.worldRadius)}}]),n}(C5),P5=new ri,I5=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._worldPoints=[],e}return Z(n,[{key:"worldPoints",get:function(){return this._worldPoints}},{key:"update",value:function(){var e=this._worldAabb,t=this.collider,n=t.points,i=t.offset,r=t.node.worldMatrix,a=this._worldPoints;a.length=n.length;for(var o=1e6,s=1e6,c=-1e6,l=-1e6,u=0,h=n.length;u<h;u++){a[u]||(a[u]=new ri),P5.x=n[u].x+i.x,P5.y=n[u].y+i.y,ri.transformMat4(P5,P5,r);var _=P5.x,f=P5.y;a[u].x=_,a[u].y=f,_>c&&(c=_),_<o&&(o=_),f>l&&(l=f),f<s&&(s=f)}e.x=o,e.y=s,e.width=c-o,e.height=l-s}},{key:"containsPoint",value:function(e){return!!this.worldAABB.contains(e)&&w2.pointInPolygon(e,this.worldPoints)}},{key:"intersectsRect",value:function(e){return!!this.worldAABB.intersects(e)&&w2.rectPolygon(e,this.worldPoints)}}]),n}(C5),D5=function(){function e(t,n){K(this,e),this.shape1=void 0,this.shape2=void 0,this.testFunc=void 0,this.touching=!1,this.type=K2.None,this.shape1=t,this.shape2=n,this.touching=!1;var i=t instanceof A5||t instanceof I5,r=n instanceof A5||n instanceof I5,a=t instanceof R5,o=n instanceof R5;i&&r?this.testFunc=w2.polygonPolygon:a&&o?this.testFunc=w2.circleCircle:i&&o?this.testFunc=w2.polygonCircle:a&&r?(this.testFunc=w2.polygonCircle,this.shape1=n,this.shape2=t):x("Can not find contact for builtin shape: ".concat(t.constructor.name,", ").concat(n.constructor.name))}return Z(e,[{key:"test",value:function(){var e=this.shape1,t=this.shape2;return!!e.worldAABB.intersects(t.worldAABB)&&(this.testFunc===w2.polygonPolygon?w2.polygonPolygon(e.worldPoints,t.worldPoints):this.testFunc===w2.circleCircle?w2.circleCircle(e.worldPosition,e.worldRadius,t.worldPosition,t.worldRadius):this.testFunc===w2.polygonCircle&&w2.polygonCircle(e.worldPoints,t.worldPosition,t.worldRadius))}},{key:"updateState",value:function(){var e=this.test(),t=K2.None;return e&&!this.touching?(this.touching=!0,t=K2.BEGIN_CONTACT):!e&&this.touching&&(this.touching=!1,t=K2.END_CONTACT),this.type=t,t}}]),e}(),O5=[],N5=[];d5={PhysicsWorld:function(){function e(){K(this,e),this._contacts=[],this._shapes=[],this._debugGraphics=null,this._debugDrawFlags=0}return Z(e,[{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(e){this._debugDrawFlags=e}},{key:"shouldCollide",value:function(e,t){var n=e.collider,i=t.collider,r=P4.instance.collisionMatrix;return n!==i&&n.node!==i.node&&r[n.group]&i.group&&r[i.group]&n.group}},{key:"addShape",value:function(e){var t=this._shapes;if(-1===t.indexOf(e)){for(var n=0,i=t.length;n<i;n++){var r=t[n];if(this.shouldCollide(e,r)){var a=new D5(e,r);this._contacts.push(a)}}t.push(e)}}},{key:"removeShape",value:function(e){var t=this._shapes,n=t.indexOf(e);if(n>=0){t.splice(n,1);for(var i=this._contacts,r=i.length-1;r>=0;r--){var a=i[r];a.shape1!==e&&a.shape2!==e||(a.touching&&this._emitCollide(a,K2.END_CONTACT),i.splice(r,1))}}}},{key:"updateShapeGroup",value:function(e){this.removeShape(e),this.addShape(e)}},{key:"step",value:function(){for(var e=this._shapes,t=0,n=e.length;t<n;t++)e[t].update();var i=this._contacts;O5.length=0;for(var r=0,a=i.length;r<a;r++)i[r].updateState()!==K2.None&&O5.push(i[r]);for(var o=0,s=O5.length;o<s;o++){var c=O5[o];this._emitCollide(c)}}},{key:"drawDebug",value:function(){if(this._debugDrawFlags){this._checkDebugDrawValid();var e=this._debugGraphics;if(e){e.clear();for(var t=this._shapes,n=0,i=t.length;n<i;n++){var r=t[n];if(e.strokeColor=Bn.WHITE,r instanceof A5||r instanceof I5){var a=r.worldPoints;if(a.length>0){e.moveTo(a[0].x,a[0].y);for(var o=1;o<a.length;o++)e.lineTo(a[o].x,a[o].y);e.close(),e.stroke()}}else r instanceof R5&&(e.circle(r.worldPosition.x,r.worldPosition.y,r.worldRadius),e.stroke());if(this._debugDrawFlags&Y2.Aabb){var s=r.worldAABB;e.strokeColor=Bn.BLUE,e.moveTo(s.xMin,s.yMin),e.lineTo(s.xMin,s.yMax),e.lineTo(s.xMax,s.yMax),e.lineTo(s.xMax,s.yMin),e.close(),e.stroke()}}}}}},{key:"_emitCollide",value:function(e,t){t=t||e.type;var n=e.shape1.collider,i=e.shape2.collider;P4.instance.emit(t,n,i),n.emit(t,n,i),i.emit(t,i,n)}},{key:"_checkDebugDrawValid",value:function(){if(!this._debugGraphics||!this._debugGraphics.isValid){var e=OD("Canvas");if(!e){var t=$N.getScene();if(!t)return;(e=new tb("Canvas")).addComponent(gK),e.parent=t}var n=new tb("PHYSICS_2D_DEBUG_DRAW");n.hideFlags|=Tl.Flags.DontSave,n.parent=e,n.worldPosition=zn.ZERO,this._debugGraphics=n.addComponent($q),this._debugGraphics.lineWidth=2}var i=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(i.children.length-1)}},{key:"testPoint",value:function(e){var t=this._shapes;N5.length=0;for(var n=0;n<t.length;n++){var i=t[n];i.containsPoint(e)&&N5.push(i.collider)}return N5}},{key:"testAABB",value:function(e){var t=this._shapes;N5.length=0;for(var n=0;n<t.length;n++){var i=t[n];i.intersectsRect(e)&&N5.push(i.collider)}return N5}},{key:"impl",value:function(){return null}},{key:"setGravity",value:function(){}},{key:"setAllowSleep",value:function(){}},{key:"syncPhysicsToScene",value:function(){}},{key:"syncSceneToPhysics",value:function(){}},{key:"raycast",value:function(){return[]}}]),e}(),RigidBody:null,BoxShape:A5,CircleShape:R5,PolygonShape:I5,MouseJoint:null,DistanceJoint:null,SpringJoint:null,RelativeJoint:null,SliderJoint:null,FixedJoint:null,WheelJoint:null,HingeJoint:null},b2="builtin",c._global.CC_PHYSICS_2D_BUILTIN=!0,c._global.CC_PHYSICS_2D_BOX2D=!1,A2=d5;var M5,k5,L5,B5,F5,z5=function(){function e(){K(this,e),this._arrayBufferOrPaddings=[],this._length=0}return Z(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer}}]),e}(),U5=function(){function e(t,n){if(K(this,e),this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(var r=0;r<i;++r){var a=this._mesh.struct.morph.subMeshMorphs[r];a&&(a.targets.length>Ip.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[r]=new H5(this._mesh,r,this._mesh.struct.morph,n):this._subMeshRenderings[r]=new G5(this._mesh,r,this._mesh.struct.morph,n))}}}return Z(e,[{key:"createInstance",value:function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,a;n[i]=null!==(r=null===(a=this._subMeshRenderings[i])||void 0===a?void 0:a.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null===r)return null;var a=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(or.ATTR_POSITION)&&a.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(or.ATTR_NORMAL)&&a.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(or.ATTR_TANGENT)&&a.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),a.push.apply(a,pe(r.requiredPatches())),a},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=ge(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}}}]),e}(),G5=function(){function e(t,n,i,r){K(this,e),this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=r;var a=i.subMeshMorphs[n];this._subMeshMorph=a,q5(t,n,r);var o=t.struct.vertexBundles[t.struct.primitives[n].vertexBundelIndices[0]].view.count;this._verticesCount=o;var s=a.targets.length,c=W5(r,o*s);this._textureInfo={width:c.width,height:c.height},this._attributes=a.attributes.map((function(e,n){var i=c.create(),r=i.valueView;return a.targets.forEach((function(e,i){for(var a=e.displacements[n],s=new Float32Array(t.data.buffer,t.data.byteOffset+a.offset,a.count),c=o*i*4,l=0;l<o;++l)r[c+4*l+0]=s[3*l+0],r[c+4*l+1]=s[3*l+1],r[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:e,morphTexture:i}}))}return Z(e,[{key:"destroy",value:function(){for(var e,t=ge(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()}},{key:"createInstance",value:function(){var e=this,t=new j5(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=ge(e._attributes);!(i=r()).done;){var a=i.value,o=void 0;switch(a.name){case or.ATTR_POSITION:o=kp;break;case or.ATTR_NORMAL:o=Fp;break;case or.ATTR_TANGENT:o=Gp;break;default:y("Unexpected attribute!")}void 0!==o&&(n.bindSampler(o,a.morphTexture.sampler),n.bindTexture(o,a.morphTexture.texture))}n.bindBuffer(Ip.BINDING,t.buffer),n.update()},destroy:function(){}}}}]),e}(),H5=function(){function e(t,n,i,r){K(this,e),this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=r;var a=i.subMeshMorphs[n];q5(t,n,r),this._attributes=a.attributes.map((function(e,n){return{name:e,targets:a.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[n].offset,e.displacements[n].count)}}))}}))}return Z(e,[{key:"data",get:function(){return this._attributes}},{key:"createInstance",value:function(){return new V5(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)}}]),e}(),V5=function(){function e(t,n,i){K(this,e),this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new j5(i,0);var r=W5(i,n);this._morphUniforms.setMorphTextureInfo(r.width,r.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=r.create();return{attributeName:e.name,morphTexture:t}}))}return Z(e,[{key:"setWeights",value:function(e){for(var t=0;t<this._attributes.length;++t){var n=this._attributes[t],i=n.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var a=0;a<r.targets.length;++a){var o=r.targets[a].displacements,s=e[a],c=o.length/3;if(0===a)for(var l=0;l<c;++l)i[4*l+0]=o[3*l+0]*s,i[4*l+1]=o[3*l+1]*s,i[4*l+2]=o[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=o[3*u+0]*s,i[4*u+1]+=o[3*u+1]*s,i[4*u+2]+=o[3*u+2]*s}n.morphTexture.updatePixels()}}},{key:"requiredPatches",value:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]}},{key:"adaptPipelineState",value:function(e){for(var t,n=ge(this._attributes);!(t=n()).done;){var i=t.value,r=void 0;switch(i.attributeName){case or.ATTR_POSITION:r=kp;break;case or.ATTR_NORMAL:r=Fp;break;case or.ATTR_TANGENT:r=Gp;break;default:y("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,i.morphTexture.sampler),e.bindTexture(r,i.morphTexture.texture))}e.bindBuffer(Ip.BINDING,this._morphUniforms.buffer),e.update()}},{key:"destroy",value:function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()}}]),e}(),j5=function(){function e(t,n){K(this,e),this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=n,this._localBuffer=new DataView(new ArrayBuffer(Ip.SIZE)),this._remoteBuffer=t.createBuffer(new Tr(bi.UNIFORM|bi.TRANSFER_DST,Pi.HOST|Pi.DEVICE,Ip.SIZE,Ip.SIZE))}return Z(e,[{key:"destroy",value:function(){this._remoteBuffer.destroy()}},{key:"buffer",get:function(){return this._remoteBuffer}},{key:"setWeights",value:function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Ip.OFFSET_OF_WEIGHTS+4*t,e[t],c.sys.isLittleEndian)}},{key:"setMorphTextureInfo",value:function(e,t){this._localBuffer.setFloat32(Ip.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,c.sys.isLittleEndian),this._localBuffer.setFloat32(Ip.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,c.sys.isLittleEndian)}},{key:"setVerticesCount",value:function(e){this._localBuffer.setFloat32(Ip.OFFSET_OF_VERTICES_COUNT,e,c.sys.isLittleEndian)}},{key:"commit",value:function(){this._remoteBuffer.update(this._localBuffer.buffer)}}]),e}();function W5(e,t){var i,a,o,s;e.hasFeature(Ti.TEXTURE_FLOAT)?(i=t,o=16,a=Ov.PixelFormat.RGBA32F,s=Float32Array):(i=4*t,o=4,a=Ov.PixelFormat.RGBA8888,s=Uint8Array);var c=function(e){e<5&&(e=5);var t=n(r(e)),i=t>>1;return{width:1<<(1&t?i+1:i),height:1<<i}}(i),l=c.width,u=c.height;return{width:l,height:u,create:function(){var t=new ArrayBuffer(l*u*o),n=new Float32Array(t),i=s===Float32Array?n:new s(t),r=new lv({width:l,height:u,_data:i,_compressed:!1,format:a}),c=new Ov;c.setFilters(Ov.Filter.NEAREST,Ov.Filter.NEAREST),c.setMipFilter(Ov.Filter.NONE),c.setWrapMode(Ov.WrapMode.CLAMP_TO_EDGE,Ov.WrapMode.CLAMP_TO_EDGE,Ov.WrapMode.CLAMP_TO_EDGE),c.image=r,c.getGFXTexture()||y("Unexpected: failed to create morph texture?");var h=e.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(i)}}}}}function q5(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}function X5(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var Y5=new zn,K5=new zn,Q5=new Uint8Array,Z5=Cc("cc.Mesh")((F5=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),(e=t.call(this)).morphRendering=null,ye(e,"_struct",L5,se(e)),ye(e,"_hash",B5,se(e)),e._data=Q5,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}return Z(n,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=wa(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}},{key:"onLoaded",value:function(){this.initialize()}},{key:"initialize",value:function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=c.director.root.device,n=this._createVertexBuffers(t,e),i=[],r=0;r<this._struct.primitives.length;r++){var a=this._struct.primitives[r];if(0!==a.vertexBundelIndices.length){var o=null,s=null;if(a.indexView){var l=a.indexView,u=l.stride,h=l.length;if(4===u&&!t.hasFeature(Ti.ELEMENT_INDEX_UINT)){var _=this._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(_>=65536){P(10001,_,65536);continue}u>>=1,h>>=1}o=t.createBuffer(new Tr(bi.INDEX,Pi.DEVICE,h,u)),s=new(X5(l.stride))(e,l.offset,l.count),l.stride!==u&&(s=X5(u).from(s)),o.update(s)}var f=a.vertexBundelIndices.map((function(e){return n[e]})),d=[];if(a.vertexBundelIndices.length>0)for(var p=a.vertexBundelIndices[0],m=this._struct.vertexBundles[p].attributes,v=0;v<m.length;++v){var g=m[v];d[v]=new zr(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new Zb(f,d,a.primitiveMode,o);y.mesh=this,y.subMeshIdx=r,i.push(y)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(e,t){return new U5(e,t)}(this,t))}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),he(ne(n.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0}},{key:"getBoneSpaceBounds",value:function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new tc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var a=this._struct.primitives,o=0;o<a.length;o++){var s=this.readAttribute(o,or.ATTR_JOINTS),c=this.readAttribute(o,or.ATTR_WEIGHTS),l=this.readAttribute(o,or.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){zn.set(Y5,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,d=s[f];if(!(0===c[f]||d>=i.length)){zn.transformMat4(K5,Y5,i[d]),n[d]=!0;var p=t[d];zn.min(p.center,p.center,K5),zn.max(p.halfExtents,p.halfExtents,K5)}}}}for(var m=0;m<i.length;m++){var v=t[m];n[m]?tc.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t}},{key:"merge",value:function(e,t,n){if(n&&!this.validateMergingMesh(e))return!1;var i=new zn,r=t&&new qn,a=t&&new tc;if(r&&t.getRotation(r),!this._initialized){var o=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){o.maxPosition&&o.minPosition&&(zn.add(a.center,o.maxPosition,o.minPosition),zn.multiplyScalar(a.center,a.center,.5),zn.subtract(a.halfExtents,o.maxPosition,o.minPosition),zn.multiplyScalar(a.halfExtents,a.halfExtents,.5),tc.transform(a,a,t),zn.add(o.maxPosition,a.center,a.halfExtents),zn.subtract(o.minPosition,a.center,a.halfExtents));for(var c=0;c<o.vertexBundles.length;c++)for(var l=o.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===or.ATTR_POSITION||l.attributes[u].name===or.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+J5(l.attributes,u)),f=t8(_,h),d=n8(_,h);if(!f||!d)continue;for(var p=l.view.count,m=l.view.stride,v=e8(h),g=0;g<p;g++){var y=g*m,x=y+v,S=x+v;switch(i.set(f(y),f(x),f(S)),l.attributes[u].name){case or.ATTR_POSITION:i.transformMat4(t);break;case or.ATTR_NORMAL:zn.transformQuat(i,i,r)}d(y,i.x),d(x,i.y),d(S,i.z)}}}return this.reset({struct:o,data:s}),this.initialize(),!0}for(var T,E,C,A,b,w=new z5,R=0,P=0,I=0,D=0,O=0,N=0,M=0,k=0,L=!1,B=new Array(this._struct.vertexBundles.length),F=0;F<this._struct.vertexBundles.length;++F){var z=this._struct.vertexBundles[F],U=e._struct.vertexBundles[F];I=z.view.offset,D=U.view.offset,P=z.view.stride,R=z.view.count+U.view.count,T=new ArrayBuffer(R*P),E=new Uint8Array(T),I+=(C=this._data.subarray(I,I+z.view.length)).length,D+=(A=e._data.subarray(D,D+U.view.length)).length,E.set(C),O=0;for(var G,H=ge(z.attributes);!(G=H()).done;){var V=G.value;M=0,L=!1;for(var j,W=ge(U.attributes);!(j=W()).done;){var q=j.value;if(V.name===q.name&&V.format===q.format){L=!0;break}M+=la[q.format].size}if(L){k=la[V.format].size,N=z.view.length+O;for(var X=0;X<U.view.count;++X){if(b=A.subarray(M,M+k),E.set(b,N),(V.name===or.ATTR_POSITION||V.name===or.ATTR_NORMAL)&&t){var Y=new Float32Array(E.buffer,N,3);switch(i.set(Y[0],Y[1],Y[2]),V.name){case or.ATTR_POSITION:i.transformMat4(t);break;case or.ATTR_NORMAL:zn.transformQuat(i,i,r)}Y[0]=i.x,Y[1]=i.y,Y[2]=i.z}N+=z.view.stride,M+=U.view.stride}}O+=la[V.format].size}B[F]={attributes:z.attributes,view:{offset:w.getLength(),length:T.byteLength,count:R,stride:P}},w.addBuffer(T)}for(var K,Q,Z,J=0,$=2,ee=0,te=new Array(this._struct.primitives.length),ne=0;ne<this._struct.primitives.length;++ne){var ie=this._struct.primitives[ne],re=e._struct.primitives[ne];te[ne]={primitiveMode:ie.primitiveMode,vertexBundelIndices:ie.vertexBundelIndices};for(var ae,oe=ge(ie.vertexBundelIndices);!(ae=oe()).done;){var se=ae.value;ee=Math.max(ee,this._struct.vertexBundles[se].view.count)}if(ie.indexView&&re.indexView){J=ie.indexView.count,J+=re.indexView.count,I=ie.indexView.offset,D=re.indexView.offset,$=J<256?1:J<65536?2:4;var ce=new ArrayBuffer(J*$);if(K=2===$?new Uint16Array(ce):1===$?new Uint8Array(ce):new Uint32Array(ce),Q=2===ie.indexView.stride?new Uint16Array(this._data.buffer,I,ie.indexView.count):1===ie.indexView.stride?new Uint8Array(this._data.buffer,I,ie.indexView.count):new Uint32Array(this._data.buffer,I,ie.indexView.count),$===ie.indexView.stride)K.set(Q);else for(var le=0;le<ie.indexView.count;++le)K[le]=Q[le];I+=ie.indexView.length,Z=2===re.indexView.stride?new Uint16Array(e._data.buffer,D,re.indexView.count):1===re.indexView.stride?new Uint8Array(e._data.buffer,D,re.indexView.count):new Uint32Array(e._data.buffer,D,re.indexView.count);for(var ue=0;ue<re.indexView.count;++ue)K[ie.indexView.count+ue]=ee+Z[ue];D+=re.indexView.length,te[ne].indexView={offset:w.getLength(),length:ce.byteLength,count:J,stride:$},w.setNextAlignment($),w.addBuffer(ce)}}var he={vertexBundles:B,primitives:te,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return he.minPosition&&e._struct.minPosition&&he.maxPosition&&e._struct.maxPosition&&(t?(zn.add(a.center,e._struct.maxPosition,e._struct.minPosition),zn.multiplyScalar(a.center,a.center,.5),zn.subtract(a.halfExtents,e._struct.maxPosition,e._struct.minPosition),zn.multiplyScalar(a.halfExtents,a.halfExtents,.5),tc.transform(a,a,t),zn.add(i,a.center,a.halfExtents),zn.max(he.maxPosition,he.maxPosition,i),zn.subtract(i,a.center,a.halfExtents),zn.min(he.minPosition,he.minPosition,i)):(zn.min(he.minPosition,he.minPosition,e._struct.minPosition),zn.max(he.maxPosition,he.maxPosition,e._struct.maxPosition))),this.reset({struct:he,data:new Uint8Array(w.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var o=this._struct.primitives[a],s=e._struct.primitives[a];if(o.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<o.vertexBundelIndices.length;++c)if(o.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(o.primitiveMode!==s.primitiveMode)return!1;if(o.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,a=e.attributes[t].format,o=ga(la[a]);if(0!==r){var s=new DataView(n._data.buffer,e.view.offset+J5(e.attributes,t)),c=la[a],l=t8(s,a);if(o&&l){for(var u=c.count,h=new o(r*u),_=e.view.stride,f=0;f<r;++f)for(var d=0;d<u;++d)h[u*f+d]=l(_*f+h.BYTES_PER_ELEMENT*d);i=h}}})),i}},{key:"copyAttribute",value:function(e,t,n,i,r){var a=this,o=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(a._data.buffer,e.view.offset+J5(e.attributes,t)),u=new DataView(n,r),h=la[c],_=t8(l,c),f=n8(u,c);if(_&&f){for(var d=h.count,p=e.view.stride,m=e8(c),v=i,g=m,y=0;y<s;++y)for(var x=0;x<d;++x)f(v*y+g*x,_(p*y+m*x));o=!0}}else o=!0})),o}},{key:"readIndices",value:function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)}},{key:"copyIndices",value:function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?Ei.R8UI:2===n.indexView.stride?Ei.R16UI:Ei.R32UI,a=t8(new DataView(this._data.buffer),r),o=0;o<i;++o)t[o]=a(n.indexView.offset+la[r].size*o);return!0}},{key:"_accessAttribute",value:function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=ge(this._struct.primitives[e].vertexBundelIndices);!(i=r()).done;){var a=i.value,o=this._struct.vertexBundles[a],s=o.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){n(o,s);break}}}},{key:"_createVertexBuffers",value:function(e,t){return this._struct.vertexBundles.map((function(n){var i=e.createBuffer(new Tr(bi.VERTEX,Pi.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(t,n.view.offset,n.view.length);return i.update(r),i}))}},{key:"initDefault",value:function(e){he(ne(n.prototype),"initDefault",this).call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:Q5})}}]),n}(Uu),L5=xe((k5=F5).prototype,"_struct",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),B5=xe(k5.prototype,"_hash",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),M5=k5))||M5;function J5(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=la[r.format].size}return n}c.Mesh=Z5;var $5=vh.isLittleEndian;function e8(e){var t=la[e];return t.size/t.count}function t8(e,t){var n=la[t],i=n.size/n.count;switch(n.type){case Ci.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,$5)};case 4:return function(t){return e.getUint32(t,$5)}}break;case Ci.SNORM:case Ci.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,$5)};case 4:return function(t){return e.getInt32(t,$5)}}break;case Ci.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,$5)};case 4:return function(t){return e.getUint32(t,$5)}}break;case Ci.FLOAT:return function(t){return e.getFloat32(t,$5)}}return null}function n8(e,t){var n=la[t],i=n.size/n.count;switch(n.type){case Ci.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,$5)};case 4:return function(t,n){return e.setUint32(t,n,$5)}}break;case Ci.SNORM:case Ci.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,$5)};case 4:return function(t,n){return e.setInt32(t,n,$5)}}break;case Ci.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,$5)};case 4:return function(t,n){return e.setUint32(t,n,$5)}}break;case Ci.FLOAT:return function(t,n){return e.setFloat32(t,n,$5)}}return null}var i8,r8,a8,o8,s8,c8,l8,u8,h8,_8,f8,d8,p8,m8,v8,g8,y8,x8,S8,T8,E8,C8,A8,b8,w8,R8,P8,I8,D8,O8,N8,M8,k8=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._morphRenderingInstance=null,e._usedMaterials=new Set,e}return Z(n,[{key:"getMacroPatches",value:function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):he(ne(n.prototype),"getMacroPatches",this).call(this,e)}},{key:"initSubModel",value:function(e,t,i){return he(ne(n.prototype),"initSubModel",this).call(this,e,t,this._launderMaterial(i))}},{key:"destroy",value:function(){he(ne(n.prototype),"destroy",this).call(this),this._morphRenderingInstance=null}},{key:"setSubModelMaterial",value:function(e,t){return he(ne(n.prototype),"setSubModelMaterial",this).call(this,e,this._launderMaterial(t))}},{key:"_updateLocalDescriptors",value:function(e,t){he(ne(n.prototype),"_updateLocalDescriptors",this).call(this,e,t),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,t)}},{key:"_launderMaterial",value:function(e){return e}},{key:"setMorphRendering",value:function(e){this._morphRenderingInstance=e}}]),n}(gT),L8=mt({OFF:0,ON:1}),B8=mt({OFF:0,ON:1}),F8=(i8=Cc("cc.ModelLightmapSettings"),r8=Dc("_recieveShadow"),i8((f8=function(){function e(){K(this,e),ye(this,"texture",s8,this),ye(this,"uvParam",c8,this),ye(this,"_bakeable",l8,this),ye(this,"_castShadow",u8,this),ye(this,"_receiveShadow",h8,this),ye(this,"_lightmapSize",_8,this)}return Z(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),s8=xe((o8=f8).prototype,"texture",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c8=xe(o8.prototype,"uvParam",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci}}),l8=xe(o8.prototype,"_bakeable",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),u8=xe(o8.prototype,"_castShadow",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),h8=xe(o8.prototype,"_receiveShadow",[r8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_8=xe(o8.prototype,"_lightmapSize",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),xe(o8.prototype,"bakeable",[Gc],Object.getOwnPropertyDescriptor(o8.prototype,"bakeable"),o8.prototype),xe(o8.prototype,"castShadow",[Gc],Object.getOwnPropertyDescriptor(o8.prototype,"castShadow"),o8.prototype),xe(o8.prototype,"receiveShadow",[Gc],Object.getOwnPropertyDescriptor(o8.prototype,"receiveShadow"),o8.prototype),xe(o8.prototype,"lightmapSize",[Gc],Object.getOwnPropertyDescriptor(o8.prototype,"lightmapSize"),o8.prototype),a8=o8))||a8),z8=(d8=Cc("cc.MeshRenderer"),p8=Uc(),m8=bc(100),v8=Lc(),g8=rl(L8),y8=Wc(),x8=rl(B8),S8=Wc(),T8=rl(Z5),E8=Wc(),C8=Hc(),d8(A8=p8(A8=m8(A8=v8(A8=kc((N8=O8=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"lightmapSettings",w8,se(e)),ye(e,"_mesh",R8,se(e)),ye(e,"_shadowCastingMode",P8,se(e)),ye(e,"_shadowReceivingMode",I8,se(e)),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,ye(e,"_enableMorph",D8,se(e)),e._modelType=gT,e}return Z(n,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,n=this._mesh=e;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}},{key:"onLoad",value:function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onRestore",value:function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onEnable",value:function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()}},{key:"onDisable",value:function(){this._model&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(c.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}},{key:"getWeight",value:function(e,t){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[e];return n.length,n[t]}},{key:"setWeights",value:function(e,t){var n=this._subMeshShapesWeights;t>=n.length||n[t].length===e.length&&(n[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))}},{key:"setWeight",value:function(e,t,n){var i=this._subMeshShapesWeights;if(!(t>=i.length)){var r=i[t];n>=r.length||(r[n]=e,this._uploadSubMeshShapesWeights(t))}}},{key:"setInstancedAttribute",value:function(e,t){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,a=0;a<i.length;a++)if(i[a].name===e){r[a].set(t);break}}},{key:"_updateLightmap",value:function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()}},{key:"_updateModels",value:function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}}},{key:"_createModel",value:function(){var e=this._morphInstance&&this._modelType===gT?k8:this._modelType,t=this._model=c.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof k8&&t.setMorphRendering(this._morphInstance)}},{key:"_attachToScene",value:function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}}},{key:"_detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=fy.POSITION,this._model.transform.hasChangedFlags|=fy.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}}},{key:"_onUpdateLightingmap",value:function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}},{key:"_onMaterialModified",value:function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())}},{key:"_onMeshChanged",value:function(){}},{key:"_clearMaterials",value:function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)}},{key:"_getBuiltinMaterial",value:function(){return Gv.get("missing-material")}},{key:"_onVisibilityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===L8.OFF?this._model.castShadow=!1:(this._shadowCastingMode,L8.ON,"ShadowCastingMode ".concat(this._shadowCastingMode," is not supported."),this._model.castShadow=!0))}},{key:"_updateReceiveShadow",value:function(){this._model&&(this._shadowReceivingMode===B8.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}},{key:"_isBatchingEnabled",value:function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n)if(t.passes[n].batchingScheme)return!0}return!1}},{key:"_watchMorphInMesh",value:function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof k8&&this._model.setMorphRendering(this._morphInstance)}}},{key:"_initSubMeshShapesWeights",value:function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var n=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):n?(n.length,e.targets.length,n.slice(0)):new Array(e.targets.length).fill(0):[]}))}}}},{key:"_validateShapeWeights",value:function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var n=e.struct.morph;return n.subMeshMorphs.length===t.length&&t.every((function(e,t){var i,r,a=e.length;return(null!==(i=null===(r=n.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===a}))}},{key:"_uploadSubMeshShapesWeights",value:function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])}}]),n}(CB),O8.ShadowCastingMode=L8,O8.ShadowReceivingMode=B8,w8=xe((b8=N8).prototype,"lightmapSettings",[Ic,Gc,$c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new F8}}),R8=xe(b8.prototype,"_mesh",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),P8=xe(b8.prototype,"_shadowCastingMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return L8.OFF}}),I8=xe(b8.prototype,"_shadowReceivingMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return B8.ON}}),xe(b8.prototype,"shadowCastingMode",[g8,y8,$c],Object.getOwnPropertyDescriptor(b8.prototype,"shadowCastingMode"),b8.prototype),xe(b8.prototype,"receiveShadow",[x8,S8,$c],Object.getOwnPropertyDescriptor(b8.prototype,"receiveShadow"),b8.prototype),xe(b8.prototype,"mesh",[T8,E8],Object.getOwnPropertyDescriptor(b8.prototype,"mesh"),b8.prototype),xe(b8.prototype,"enableMorph",[C8,$c],Object.getOwnPropertyDescriptor(b8.prototype,"enableMorph"),b8.prototype),D8=xe(b8.prototype,"_enableMorph",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),A8=b8))||A8)||A8)||A8)||A8)||A8);!function(e){e[e.positions=or.ATTR_POSITION]="positions",e[e.normals=or.ATTR_NORMAL]="normals",e[e.uvs=or.ATTR_TEX_COORD]="uvs",e[e.colors=or.ATTR_COLOR]="colors"}(M8||(M8={}));var U8,G8,H8,V8,j8,W8,q8,X8,Y8,K8,Q8,Z8,J8,$8,e6,t6,n6,i6,r6,a6,o6,s6,c6,l6,u6,h6,_6,f6,d6,p6,m6,v6,g6,y6,x6,S6,T6,E6,C6,A6,b6,w6,R6,P6,I6,D6,O6,N6,M6,k6,L6,B6,F6,z6,U6,G6,H6,V6,j6,W6,q6,X6=[new zr(or.ATTR_POSITION,Ei.RGB32F),new zr(or.ATTR_NORMAL,Ei.RGB32F),new zr(or.ATTR_TEX_COORD,Ei.RG32F),new zr(or.ATTR_TANGENT,Ei.RGBA32F),new zr(or.ATTR_COLOR,Ei.RGBA32F)],Y6=new zn,K6=function(){function e(t,n,i){K(this,e),this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=n,this._accumStart=i}return Z(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}},{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(){var e=this._opts,t=e.average,n=e.isInteger,i=t?this._averageValue:this._value;return n?Math.round(i):Math.round(100*i)/100}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var n=t;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}}}]),e}(),Q6=Cc("cc.PerfCounter")(U8=function(e){te(n,e);var t=le(n);function n(e,i,r){var a;return K(this,n),(a=t.call(this,e,i,r))._time=void 0,a._time=r,a}return Z(n,[{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._time=e}},{key:"end",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._value=e-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,n=t-this._time;this._total++,n>(this._opts.average||1e3)&&(this._value=1e3*this._total/n,this._total=0,this._time=t,this._average(this._value))}}]),n}(K6))||U8,Z6="0123456789. ",J6=500,$6={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},e7={fps:{desc:"Framerate (FPS)",below:30,average:J6,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:J6},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:J6,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:J6},render:{desc:"Renderer (ms)",min:0,max:50,average:J6,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},t7=e("Profiler",function(){function e(){K(this,e),this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new mr,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(e7).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}return Z(e,[{key:"reset",value:function(){this._stats=null,this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer&&this._meshRenderer.destroy(),this._meshRenderer=null,this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(e7).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0}},{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),c.director.off(c.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),c.director.off(c.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),c.director.off(c.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),c.director.off(c.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),c.director.off(c.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),c.director.off(c.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,c.game.config.showFPS=!1)}},{key:"showStats",value:function(){if(!this._showFPS){if(!this._device){var e=c.director.root;this._device=e.device,this._swapchain=e.mainWindow.swapchain,this._pipeline=e.pipeline}this.generateCanvas(),this.generateStats(),c.game.once(c.Game.EVENT_ENGINE_INITED,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),c.director.on(c.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),c.director.on(c.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),c.director.on(c.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),c.director.on(c.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),c.director.on(c.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),c.director.on(c.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,c.game.config.showFPS=!0}}},{key:"generateCanvas",value:function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx.font="".concat(23,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new wr(Ii.TEX2D,Di.SAMPLED|Di.TRANSFER_DST,Ei.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}}},{key:"generateStats",value:function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var n in e7){var i=e7[n];this._ctx.fillText(i.desc,0,t*this._lineHeight),i.counter=new Q6(n,i,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<Z6.length;++r){var a=this._ctx.measureText(Z6[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,a)}for(var o=0;o<Z6.length;++o)this._ctx.fillText(Z6[o],o*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=e7,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new tb("PROFILER_NODE"),c.game.addPersistRootNode(this._rootNode);var e=new tb("Profiler_Root");e.parent=this._rootNode;for(var t=.4,n=t/this._totalLines,i=t/this._wordHeight,r=n/23,a=this._eachNumWidth*this._canvas.width*r,o=[0,t,0,i,t,0,i,0,0,0,0,0],s=[0,2,1,0,3,2],l=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],u=0,h=0;h<this._totalLines;h++)for(var _=0;_<8;_++){o.push(i+_*a,t-h*n,0),o.push(i+(_+1)*a,t-h*n,0),o.push(i+(_+1)*a,t-(h+1)*n,0),o.push(i+_*a,t-(h+1)*n,0),u=4*(8*h+_+1),s.push(0+u,2+u,1+u,0+u,3+u,2+u);var f=8*h+_,d=Math.floor(f/4),p=f-4*d;l.push(0,this._wordHeight,d,p),l.push(this._eachNumWidth,this._wordHeight,d,p),l.push(this._eachNumWidth,1,d,p),l.push(0,1,d,p)}this._meshRenderer=e.addComponent(z8),this._meshRenderer.mesh=function(e,t,n){n=n||{};var i,r=[],a=0,o=[],s=0,c=e.positions.slice();if(c.length>0){if(i=null,e.attributes)for(var l,u=ge(e.attributes);!(l=u()).done;){var h=l.value;if(h.name===or.ATTR_POSITION){i=h;break}}i||(i=X6[0]),r.push(i);var _=la[i.format];s=Math.max(s,Math.floor(c.length/_.count)),o.push({offset:a,data:c,attribute:i}),a+=_.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var f,d=ge(e.attributes);!(f=d()).done;){var p=f.value;if(p.name===or.ATTR_NORMAL){i=p;break}}i||(i=X6[1]);var m=la[i.format];r.push(i),s=Math.max(s,Math.floor(e.normals.length/m.count)),o.push({offset:a,data:e.normals,attribute:i}),a+=m.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var v,g=ge(e.attributes);!(v=g()).done;){var y=v.value;if(y.name===or.ATTR_TEX_COORD){i=y;break}}i||(i=X6[2]);var x=la[i.format];r.push(i),s=Math.max(s,Math.floor(e.uvs.length/x.count)),o.push({offset:a,data:e.uvs,attribute:i}),a+=x.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var S,T=ge(e.attributes);!(S=T()).done;){var E=S.value;if(E.name===or.ATTR_TANGENT){i=E;break}}i||(i=X6[3]);var C=la[i.format];r.push(i),s=Math.max(s,Math.floor(e.tangents.length/C.count)),o.push({offset:a,data:e.tangents,attribute:i}),a+=C.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var A,b=ge(e.attributes);!(A=b()).done;){var w=A.value;if(w.name===or.ATTR_COLOR){i=w;break}}i||(i=X6[4]);var R=la[i.format];r.push(i),s=Math.max(s,Math.floor(e.colors.length/R.count)),o.push({offset:a,data:e.colors,attribute:i}),a+=R.size}if(e.customAttributes)for(var P,I=ge(e.customAttributes);!(P=I()).done;){var D=P.value,O=la[D.attr.format];r.push(D.attr),s=Math.max(s,Math.floor(D.values.length/O.count)),o.push({offset:a,data:D.values,attribute:D.attr}),a+=O.size}for(var N=new z5,M=new ArrayBuffer(s*a),k=new DataView(M),L=0,B=o;L<B.length;L++){var F=B[L];Xb(k,F.data,F.attribute.format,F.offset,a)}N.setNextAlignment(0);var z={attributes:r,view:{offset:N.getLength(),length:M.byteLength,count:s,stride:a}};N.addBuffer(M);var U=null,G=0;if(e.indices){var H=e.indices;G=H.length,U=new ArrayBuffer(2*G),Xb(new DataView(U),H,Ei.R16UI)}var V={primitiveMode:e.primitiveMode||Yi.TRIANGLE_LIST,vertexBundelIndices:[0]};U&&(N.setNextAlignment(2),V.indexView={offset:N.getLength(),length:U.byteLength,count:G,stride:2},N.addBuffer(U));var j=e.minPos;if(!j&&n.calculateBounds){j=zn.set(new zn,1/0,1/0,1/0);for(var W=0;W<s;++W)zn.set(Y6,c[3*W+0],c[3*W+1],c[3*W+2]),zn.min(j,j,Y6)}var q=e.maxPos;if(!q&&n.calculateBounds){q=zn.set(new zn,-1/0,-1/0,-1/0);for(var X=0;X<s;++X)zn.set(Y6,c[3*X+0],c[3*X+1],c[3*X+2]),zn.max(q,q,Y6)}var Y={vertexBundles:[z],primitives:[V]};return j&&(Y.minPosition=new zn(j.x,j.y,j.z)),q&&(Y.maxPosition=new zn(q.x,q.y,q.z)),t||(t=new Z5),t.reset({struct:Y,data:new Uint8Array(N.getCombined())}),t}({positions:o,indices:s,colors:l});var m=new gg;m.initialize({effectName:"profiler"});var v=this.pass=m.passes[0],g=v.getBinding("mainTexture"),y=v.getBinding("digits"),x=v.getBinding("offset");v.bindTexture(g,this._texture),this.digitsData=v.blocks[y],this.offsetData=v.blocks[x],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=jd.Enum.PROFILER,this._inited=!0}}},{key:"beforeUpdate",value:function(){if(this._stats){var e=performance.now();this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=performance.now();c.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=performance.now();this._stats.physics.counter.start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=performance.now();this._stats.physics.counter.end(e)}}},{key:"beforeDraw",value:function(){if(this._stats&&this._inited){var e=this._swapchain.surfaceTransform,t=this._device.capabilities.clipSpaceSignY;if(e!==this.offsetData[3]){var n=$n[e],i=-.9*t;this.offsetData[0]=-.9*n[0]+i*n[2],this.offsetData[1]=-.9*n[1]+i*n[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=e}this.pass._setRootBufferDirty(!0),this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);var r=performance.now();this._stats.render.counter.start(r)}}},{key:"afterDraw",value:function(){if(this._stats&&this._inited){var e=performance.now();if(this._stats.frame.counter.end(e),this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),!(e-this.lastTime<J6)){this.lastTime=e;var t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;var n=0,i=this.digitsData;for(var r in this._stats){var a=this._stats[r];a.counter.sample(e);for(var o=a.counter.human().toString(),s=7;s>=0;s--){var c=8*n+s,l=o[o.length-(8-s)],u=$6[l];void 0===u&&(u=11),i[c]=u}n++}}}}}]),e}()),n7=e("profiler",new t7);c.profiler=n7;var i7,r7,a7,o7=new Bn;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(i7||(i7={})),yt(i7),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(r7||(r7={})),function(e){e.CLICK="click"}(a7||(a7={}));var s7=function(t){return e({Button:t,ButtonComponent:t}),t}((G8=Cc("cc.Button"),H8=Uc(),V8=bc(110),j8=Lc(),W8=Ac(qV),q8=rl(tb),X8=Zc(),Y8=Wc(),K8=Zc(),Q8=Wc(),Z8=rl(i7),J8=Zc(),$8=Wc(),e6=Zc(),t6=Wc(),n6=Zc(),i6=Wc(),r6=Zc(),a6=Wc(),o6=Zc(),s6=Wc(),c6=Xc(),l6=Yc(),u6=Zc(),h6=Wc(),_6=Zc(),f6=Wc(),d6=rl(yH),p6=Zc(),m6=Wc(),v6=rl(yH),g6=Zc(),y6=Wc(),x6=rl(yH),S6=Zc(),T6=Wc(),E6=rl(yH),C6=Zc(),A6=Wc(),b6=rl([KL]),w6=Zc(),R6=Wc(),G8(P6=H8(P6=V8(P6=j8(P6=W8(P6=kc((q6=W6=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"clickEvents",D6,se(e)),ye(e,"_interactable",O6,se(e)),ye(e,"_transition",N6,se(e)),ye(e,"_normalColor",M6,se(e)),ye(e,"_hoverColor",k6,se(e)),ye(e,"_pressedColor",L6,se(e)),ye(e,"_disabledColor",B6,se(e)),ye(e,"_normalSprite",F6,se(e)),ye(e,"_hoverSprite",z6,se(e)),ye(e,"_pressedSprite",U6,se(e)),ye(e,"_disabledSprite",G6,se(e)),ye(e,"_duration",H6,se(e)),ye(e,"_zoomScale",V6,se(e)),ye(e,"_target",j6,se(e)),e._pressed=!1,e._hovered=!1,e._fromColor=new Bn,e._toColor=new Bn,e._time=0,e._transitionFinished=!0,e._fromScale=new zn,e._toScale=new zn,e._originalScale=null,e._sprite=null,e._targetScale=new zn,e}return Z(n,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===i7.COLOR?this._updateColorTransition(r7.NORMAL):this._transition===i7.SPRITE&&this._updateSpriteTransition(r7.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(yY);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}},{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(yY);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()}},{key:"onEnable",value:function(){this._registerNodeEvent()}},{key:"onDisable",value:function(){this._resetState(),this._unregisterNodeEvent()}},{key:"onDestroy",value:function(){this.target.isValid&&this._unregisterTargetEvent(this.target)}},{key:"update",value:function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===i7.COLOR||this._transition===i7.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===i7.COLOR){var i=t._uiProps.uiComp;Bn.lerp(o7,this._fromColor,this._toColor,n),i&&(i.color=o7)}else this.transition===i7.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=xn(this._fromScale.x,this._toScale.x,n),this._targetScale.y=xn(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}}},{key:"_resizeNodeToTargetNode",value:function(){this.target&&this.target._uiProps.uiTransformComp}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===i7.COLOR&&this._interactable){var n=e.getComponent(IW);n&&(n.color=this._normalColor)}else t===i7.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}}},{key:"_registerNodeEvent",value:function(){this.node.on($E.TOUCH_START,this._onTouchBegan,this),this.node.on($E.TOUCH_MOVE,this._onTouchMove,this),this.node.on($E.TOUCH_END,this._onTouchEnded,this),this.node.on($E.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on($E.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on($E.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_registerTargetEvent",value:function(e){e.on($E.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off($E.TOUCH_START,this._onTouchBegan,this),this.node.off($E.TOUCH_MOVE,this._onTouchMove,this),this.node.off($E.TOUCH_END,this._onTouchEnded,this),this.node.off($E.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off($E.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off($E.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_unregisterTargetEvent",value:function(e){e.off($E.TRANSFORM_CHANGED)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(yY)),t}},{key:"_applyTarget",value:function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new zn),zn.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))}},{key:"_onTargetSpriteFrameChanged",value:function(e){this._transition===i7.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)}},{key:"_setCurrentStateSpriteFrame",value:function(e){if(e)switch(this._getButtonState()){case r7.NORMAL:this._normalSprite=e;break;case r7.HOVER:this._hoverSprite=e;break;case r7.PRESSED:this._pressedSprite=e;break;case r7.DISABLED:this._disabledSprite=e}}},{key:"_onTargetColorChanged",value:function(e){this._transition===i7.COLOR&&this._setCurrentStateColor(e)}},{key:"_setCurrentStateColor",value:function(e){switch(this._getButtonState()){case r7.NORMAL:this._normalColor=e;break;case r7.HOVER:this._hoverColor=e;break;case r7.PRESSED:this._pressedColor=e;break;case r7.DISABLED:this._disabledColor=e}}},{key:"_onTargetTransformChanged",value:function(e){e&fy.SCALE&&this._originalScale&&this._transition===i7.SCALE&&this._transitionFinished&&zn.copy(this._originalScale,this.target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());this._transition===i7.SCALE&&this.target&&this._originalScale?i?(zn.copy(this._fromScale,this._originalScale),zn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?r7.PRESSED:r7.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(KL.emitEvents(this.clickEvents,e),this.node.emit(a7.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==i7.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=r7.NORMAL;return this._interactable?this._pressed?e=r7.PRESSED:this._hovered&&(e=r7.HOVER):e=r7.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t,n=this["".concat(e,"Color")],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(IW);i&&(e===r7.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))}},{key:"_updateSpriteTransition",value:function(e){var t=this["".concat(e,"Sprite")];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===r7.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){this._originalScale&&(zn.copy(this._fromScale,this._originalScale),zn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}},{key:"_zoomBack",value:function(){this.target&&this._originalScale&&(zn.copy(this._fromScale,this.target.getScale()),zn.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===i7.COLOR?this._updateColorTransition(e):t===i7.SPRITE?this._updateSpriteTransition(e):t===i7.SCALE&&this._updateScaleTransition(e)}}]),n}(sh),W6.Transition=i7,W6.EventType=a7,xe((I6=q6).prototype,"target",[q8,X8,Y8],Object.getOwnPropertyDescriptor(I6.prototype,"target"),I6.prototype),xe(I6.prototype,"interactable",[K8,Q8],Object.getOwnPropertyDescriptor(I6.prototype,"interactable"),I6.prototype),xe(I6.prototype,"transition",[Z8,J8,$8],Object.getOwnPropertyDescriptor(I6.prototype,"transition"),I6.prototype),xe(I6.prototype,"normalColor",[e6,t6],Object.getOwnPropertyDescriptor(I6.prototype,"normalColor"),I6.prototype),xe(I6.prototype,"pressedColor",[n6,i6],Object.getOwnPropertyDescriptor(I6.prototype,"pressedColor"),I6.prototype),xe(I6.prototype,"hoverColor",[r6,a6],Object.getOwnPropertyDescriptor(I6.prototype,"hoverColor"),I6.prototype),xe(I6.prototype,"disabledColor",[o6,s6],Object.getOwnPropertyDescriptor(I6.prototype,"disabledColor"),I6.prototype),xe(I6.prototype,"duration",[c6,l6,u6,h6],Object.getOwnPropertyDescriptor(I6.prototype,"duration"),I6.prototype),xe(I6.prototype,"zoomScale",[_6,f6],Object.getOwnPropertyDescriptor(I6.prototype,"zoomScale"),I6.prototype),xe(I6.prototype,"normalSprite",[d6,p6,m6],Object.getOwnPropertyDescriptor(I6.prototype,"normalSprite"),I6.prototype),xe(I6.prototype,"pressedSprite",[v6,g6,y6],Object.getOwnPropertyDescriptor(I6.prototype,"pressedSprite"),I6.prototype),xe(I6.prototype,"hoverSprite",[x6,S6,T6],Object.getOwnPropertyDescriptor(I6.prototype,"hoverSprite"),I6.prototype),xe(I6.prototype,"disabledSprite",[E6,C6,A6],Object.getOwnPropertyDescriptor(I6.prototype,"disabledSprite"),I6.prototype),D6=xe(I6.prototype,"clickEvents",[b6,Ic,w6,R6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),O6=xe(I6.prototype,"_interactable",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),N6=xe(I6.prototype,"_transition",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i7.NONE}}),M6=xe(I6.prototype,"_normalColor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bn.WHITE.clone()}}),k6=xe(I6.prototype,"_hoverColor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bn(211,211,211,255)}}),L6=xe(I6.prototype,"_pressedColor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bn.WHITE.clone()}}),B6=xe(I6.prototype,"_disabledColor",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bn(124,124,124,255)}}),F6=xe(I6.prototype,"_normalSprite",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),z6=xe(I6.prototype,"_hoverSprite",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U6=xe(I6.prototype,"_pressedSprite",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),G6=xe(I6.prototype,"_disabledSprite",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H6=xe(I6.prototype,"_duration",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),V6=xe(I6.prototype,"_zoomScale",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),j6=xe(I6.prototype,"_target",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),P6=I6))||P6)||P6)||P6)||P6)||P6)||P6));c.Button=s7;var c7,l7,u7,h7=function(){function e(){K(this,e)}return Z(e,null,[{key:"add",value:function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)}},{key:"remove",value:function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)}},{key:"resort",value:function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))}},{key:"next",value:function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}}}]),e}();h7._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(c7||(c7={})),mt(c7),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(l7||(l7={})),mt(l7),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(u7||(u7={})),mt(u7);var _7,f7,d7,p7,m7,v7,g7,y7,x7,S7,T7,E7,C7,A7,b7,w7,R7,P7,I7,D7,O7,N7,M7,k7,L7,B7,F7,z7,U7,G7,H7,V7,j7,W7,q7,X7,Y7,K7,Q7,Z7,J7,$7,e9,t9,n9,i9,r9,a9,o9,s9,c9,l9,u9,h9,_9,f9,d9,p9,m9,v9,g9,y9=function(){function e(){K(this,e),this._editing=!1,this._delegate=null}return Z(e,[{key:"init",value:function(){}},{key:"onEnable",value:function(){}},{key:"update",value:function(){}},{key:"onDisable",value:function(){this._editing&&this.endEditing()}},{key:"clear",value:function(){this._delegate=null}},{key:"setTabIndex",value:function(){}},{key:"setSize",value:function(){}},{key:"setFocus",value:function(e){e?this.beginEditing():this.endEditing()}},{key:"isFocused",value:function(){return this._editing}},{key:"beginEditing",value:function(){}},{key:"endEditing",value:function(){}}]),e}(),x9=new ei,S9=new ei,T9=new zn,E9=null,C9=0,A9=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._delegate=null,e._inputMode=-1,e._inputFlag=-1,e._returnType=-1,e.__eventListeners={},e.__autoResize=!1,e.__orientationChanged=void 0,e._edTxt=null,e._isTextArea=!1,e._textLabelFont=null,e._textLabelFontSize=null,e._textLabelFontColor=null,e._textLabelAlign=null,e._placeholderLabelFont=null,e._placeholderLabelFontSize=null,e._placeholderLabelFontColor=null,e._placeholderLabelAlign=null,e._placeholderLineHeight=null,e._placeholderStyleSheet=null,e._domId="EditBoxId_".concat(++C9),e}return Z(n,[{key:"init",value:function(e){e&&(this._delegate=e,e.inputMode===l7.ANY?this._createTextArea():this._createInput(),h7.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())}},{key:"clear",value:function(){this._removeEventListeners(),this._removeDomFromGameContainer(),h7.remove(this),E9===this&&(E9=null),this._delegate=null}},{key:"update",value:function(){this._updateMatrix()}},{key:"setTabIndex",value:function(e){this._edTxt.tabIndex=e,h7.resort()}},{key:"setSize",value:function(e,t){var n=this._edTxt;n&&(n.style.width="".concat(e,"px"),n.style.height="".concat(t,"px"))}},{key:"beginEditing",value:function(){E9&&E9!==this&&E9.setFocus(!1),this._editing=!0,E9=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()}},{key:"endEditing",value:function(){this._edTxt.blur()}},{key:"_createInput",value:function(){this._isTextArea=!1,this._edTxt=document.createElement("input")}},{key:"_createTextArea",value:function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")}},{key:"_addDomToGameContainer",value:function(){c.GAME_VIEW&&this._edTxt?(c.gameView.container.appendChild(this._edTxt),c.gameView.head.appendChild(this._placeholderStyleSheet)):ZN.container&&this._edTxt&&(ZN.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))}},{key:"_removeDomFromGameContainer",value:function(){(c.GAME_VIEW?Pt(c.gameView.container,this._edTxt):Pt(ZN.container,this._edTxt))&&this._edTxt&&(c.GAME_VIEW?c.gameView.container.removeChild(this._edTxt):ZN.container.removeChild(this._edTxt)),(c.GAME_VIEW?Pt(c.gameView.head,this._placeholderStyleSheet):Pt(document.head,this._placeholderStyleSheet))&&(c.GAME_VIEW?c.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null}},{key:"_showDom",value:function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),vh.isMobile&&this._showDomOnMobile()}},{key:"_hideDom",value:function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),vh.isMobile&&this._hideDomOnMobile()}},{key:"_showDomOnMobile",value:function(){vh.os!==du.ANDROID&&vh.os!==du.OHOS||(dh.handleResizeEvent=!1,this._adjustWindowScroll())}},{key:"_hideDomOnMobile",value:function(){vh.os!==du.ANDROID&&vh.os!==du.OHOS||(dh.handleResizeEvent=!0),this._scrollBackWindow()}},{key:"_adjustWindowScroll",value:function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)}},{key:"_scrollBackWindow",value:function(){setTimeout((function(){vh.browserType!==hu.WECHAT||vh.os!==du.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._delegate.node,t=lM.getScaleX(),n=lM.getScaleY(),i=1,r=1;c.GAME_VIEW&&(i=c.gameView.canvas.width/c.game.canvas.width,r=c.gameView.canvas.height/c.game.canvas.height),t*=i,n*=r;var a=lM.getViewportRect(),o=dh.devicePixelRatio;e.getWorldMatrix(x9);var s=e._uiProps.uiTransformComp;if(s&&zn.set(T9,-s.anchorX*s.width,-s.anchorY*s.height,T9.z),ei.transform(x9,x9,T9),e._uiProps.uiTransformComp){var l=$N.root.batcher2D.getFirstRenderCamera(e);if(l){l.node.getWorldRT(S9);var u=S9.m12,h=S9.m13,_=nM.center;S9.m12=_.x-(S9.m00*u+S9.m04*h),S9.m13=_.y-(S9.m01*u+S9.m05*h),ei.multiply(S9,S9,x9),t/=o,n/=o;var f=c.GAME_VIEW?c.gameView.container:ZN.container,d=S9.m00*t,p=x9.m01,m=x9.m04,v=S9.m05*n,g=parseInt(f&&f.style.paddingLeft||"0");g+=a.x*i/o;var y=parseInt(f&&f.style.paddingBottom||"0");y+=a.y/o;var x=S9.m12*t+g,S=S9.m13*n+y,T="matrix(".concat(d,",").concat(-p,",").concat(-m,",").concat(v,",").concat(x,",").concat(-S,")");this._edTxt.style.transform=T,this._edTxt.style["-webkit-transform"]=T,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}}},{key:"_updateInputType",value:function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var a="none";return n===u7.INITIAL_CAPS_ALL_CHARACTERS?a="uppercase":n===u7.INITIAL_CAPS_WORD&&(a="capitalize"),void(r.style.textTransform=a)}if(r=r,n===u7.PASSWORD)return r.type="password",void(r.style.textTransform="none");var o=r.type;t===l7.EMAIL_ADDR?o="email":t===l7.NUMERIC||t===l7.DECIMAL?o="number":t===l7.PHONE_NUMBER?(o="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===l7.URL?o="url":(o="text",i===c7.SEARCH&&(o="search")),r.type=o;var s="none";n===u7.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===u7.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}}},{key:"_updateMaxLength",value:function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e}},{key:"_initStyleSheet",value:function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="".concat(2,"px"),e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}}},{key:"_updateStyleSheet",value:function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))}},{key:"_updateTextLabel",value:function(e){if(e){var t=e.font;t=!t||t instanceof UH?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize="".concat(n,"px"),i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case DW.HorizontalAlign.LEFT:i.style.textAlign="left";break;case DW.HorizontalAlign.CENTER:i.style.textAlign="center";break;case DW.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}}},{key:"_updatePlaceholderLabel",value:function(e){if(e){var t=e.font;t=!t||t instanceof UH?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),a=e.fontSize,o="";switch(e.horizontalAlign){case DW.HorizontalAlign.LEFT:o="left";break;case DW.HorizontalAlign.CENTER:o="center";break;case DW.HorizontalAlign.RIGHT:o="right"}i.innerHTML="#".concat(this._domId,"::-webkit-input-placeholder{text-transform: initial;-family: ").concat(t,";font-size: ").concat(n,"px;color: ").concat(r,";line-height: ").concat(a,"px;text-align: ").concat(o,";}")+"#".concat(this._domId,"::-moz-placeholder{text-transform: initial;-family: ").concat(t,";font-size: ").concat(n,"px;color: ").concat(r,";line-height: ").concat(a,"px;text-align: ").concat(o,";}")+"#".concat(this._domId,"::-ms-input-placeholder{text-transform: initial;-family: ").concat(t,";font-size: ").concat(n,"px;color: ").concat(r,";line-height: ").concat(a,"px;text-align: ").concat(o,";}"),vh.browserType===hu.EDGE&&(i.innerHTML+="#".concat(this._domId,"::-ms-clear{display: none;}"))}}}},{key:"_registerEventListeners",value:function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&vh.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===rD.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===rD.TAB&&(n.propagationStopped=!0,n.preventDefault(),h7.next(e))},i.onBlur=function(){vh.isMobile&&n&&i.compositionEnd(),e._editing=!1,E9=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}}},{key:"_removeEventListeners",value:function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}}}]),n}(y9);function b9(e){return e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()}))}function w9(e){return e.charAt(0).toUpperCase()+e.slice(1)}!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(g9||(g9={}));var R9,P9,I9,D9,O9,N9,M9,k9,L9,B9,F9,z9,U9,G9,H9,V9,j9,W9,q9,X9,Y9,K9,Q9,Z9,J9,$9,eee,tee,nee,iee,ree,aee,oee,see,cee,lee,uee,hee,_ee,fee,dee,pee,mee,vee,gee,yee,xee,See,Tee,Eee,Cee,Aee,bee,wee,Ree,Pee,Iee,Dee,Oee,Nee,Mee,kee=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((_7=Cc("cc.EditBox"),f7=Uc(),d7=bc(110),p7=Lc(),m7=Ac(qV),v7=Zc(),g7=Wc(),y7=Zc(),x7=Wc(),S7=rl(DW),T7=Zc(),E7=Wc(),C7=rl(DW),A7=Zc(),b7=Wc(),w7=rl(yH),R7=Zc(),P7=Wc(),I7=rl(u7),D7=Zc(),O7=Wc(),N7=rl(l7),M7=Zc(),k7=Wc(),L7=rl(c7),B7=Zc(),F7=Wc(),z7=Zc(),U7=Wc(),G7=Zc(),H7=Wc(),V7=rl([KL]),j7=Zc(),W7=Wc(),q7=rl([KL]),X7=Zc(),Y7=Wc(),K7=rl([KL]),Q7=Zc(),Z7=Wc(),J7=rl([KL]),$7=Zc(),e9=Wc(),_7(t9=f7(t9=d7(t9=p7(t9=m7(t9=kc((v9=m9=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"editingDidBegan",i9,se(e)),ye(e,"textChanged",r9,se(e)),ye(e,"editingDidEnded",a9,se(e)),ye(e,"editingReturn",o9,se(e)),e._impl=null,e._background=null,ye(e,"_textLabel",s9,se(e)),ye(e,"_placeholderLabel",c9,se(e)),ye(e,"_returnType",l9,se(e)),ye(e,"_string",u9,se(e)),ye(e,"_tabIndex",h9,se(e)),ye(e,"_backgroundImage",_9,se(e)),ye(e,"_inputFlag",f9,se(e)),ye(e,"_inputMode",d9,se(e)),ye(e,"_maxLength",p9,se(e)),e._isLabelVisible=!1,e}return Z(n,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}},{key:"__preload",value:function(){this._init()}},{key:"onEnable",value:function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"onDisable",value:function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"focus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"blur",value:function(){this._impl&&this._impl.setFocus(!1)}},{key:"isFocused",value:function(){return!!this._impl&&this._impl.isFocused()}},{key:"_editBoxEditingDidBegan",value:function(){KL.emitEvents(this.editingDidBegan,this),this.node.emit(g9.EDITING_DID_BEGAN,this)}},{key:"_editBoxEditingDidEnded",value:function(){KL.emitEvents(this.editingDidEnded,this),this.node.emit(g9.EDITING_DID_ENDED,this)}},{key:"_editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,KL.emitEvents(this.textChanged,e,this),this.node.emit(g9.TEXT_CHANGED,this)}},{key:"_editBoxEditingReturn",value:function(){KL.emitEvents(this.editingReturn,this),this.node.emit(g9.EDITING_RETURN,this)}},{key:"_showLabels",value:function(){this._isLabelVisible=!0,this._updateLabels()}},{key:"_hideLabels",value:function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_onTouchBegan",value:function(e){e.propagationStopped=!0}},{key:"_onTouchCancel",value:function(e){e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0}},{key:"_init",value:function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on($E.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new n._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}},{key:"_ensureBackgroundSprite",value:function(){if(!this._background){var e=this.node.getComponent(yY);e||(e=this.node.addComponent(yY)),e!==this._background&&(e.type=yY.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}}},{key:"_updateTextLabel",value:function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||((t=new tb("TEXT_LABEL")).layer=this.node.layer),(e=t.getComponent(DW))||(e=t.addComponent(DW)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=DW.Overflow.CLAMP,this._inputMode===l7.ANY?(e.verticalAlign=wW.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)}},{key:"_updatePlaceholderLabel",value:function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||((t=new tb("PLACEHOLDER_LABEL")).layer=this.node.layer),(e=t.getComponent(DW))||(e=t.addComponent(DW)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=DW.Overflow.CLAMP,this._inputMode===l7.ANY?(e.verticalAlign=wW.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this.placeholder}},{key:"_syncSize",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)}},{key:"_updateLabels",value:function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}}},{key:"_updateLabelStringStyle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this._inputFlag;if(t||n!==u7.PASSWORD)n===u7.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():n===u7.INITIAL_CAPS_WORD?e=b9(e):n===u7.INITIAL_CAPS_SENTENCE&&(e=w9(e));else{for(var i="",r=e.length,a=0;a<r;++a)i+="●";e=i}return e}},{key:"_registerEvent",value:function(){this.node.on($E.TOUCH_START,this._onTouchBegan,this),this.node.on($E.TOUCH_END,this._onTouchEnded,this)}},{key:"_unregisterEvent",value:function(){this.node.off($E.TOUCH_START,this._onTouchBegan,this),this.node.off($E.TOUCH_END,this._onTouchEnded,this)}},{key:"_onBackgroundSpriteFrameChanged",value:function(){this._background&&(this.backgroundImage=this._background.spriteFrame)}},{key:"_registerBackgroundEvent",value:function(){var e=this._background&&this._background.node;null==e||e.on(yY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)}},{key:"_unregisterBackgroundEvent",value:function(){var e=this._background&&this._background.node;null==e||e.off(yY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)}},{key:"_updateLabelPosition",value:function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),a.node.setPosition(n+2,i+e.height,a.node.position.z),this._inputMode===l7.ANY&&(a.verticalAlign=wW.TOP),a.enableWrapText=this._inputMode===l7.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),this._inputMode===l7.ANY&&(r.verticalAlign=wW.TOP),r.enableWrapText=this._inputMode===l7.ANY)}},{key:"_resizeChildNodes",value:function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize),this._syncSize()}}]),n}(sh),m9._EditBoxImpl=y9,m9.KeyboardReturnType=c7,m9.InputFlag=u7,m9.InputMode=l7,m9.EventType=g9,xe((n9=v9).prototype,"string",[v7,g7],Object.getOwnPropertyDescriptor(n9.prototype,"string"),n9.prototype),xe(n9.prototype,"placeholder",[y7,x7],Object.getOwnPropertyDescriptor(n9.prototype,"placeholder"),n9.prototype),xe(n9.prototype,"textLabel",[S7,T7,E7],Object.getOwnPropertyDescriptor(n9.prototype,"textLabel"),n9.prototype),xe(n9.prototype,"placeholderLabel",[C7,A7,b7],Object.getOwnPropertyDescriptor(n9.prototype,"placeholderLabel"),n9.prototype),xe(n9.prototype,"backgroundImage",[w7,R7,P7],Object.getOwnPropertyDescriptor(n9.prototype,"backgroundImage"),n9.prototype),xe(n9.prototype,"inputFlag",[I7,D7,O7],Object.getOwnPropertyDescriptor(n9.prototype,"inputFlag"),n9.prototype),xe(n9.prototype,"inputMode",[N7,M7,k7],Object.getOwnPropertyDescriptor(n9.prototype,"inputMode"),n9.prototype),xe(n9.prototype,"returnType",[L7,B7,F7],Object.getOwnPropertyDescriptor(n9.prototype,"returnType"),n9.prototype),xe(n9.prototype,"maxLength",[z7,U7],Object.getOwnPropertyDescriptor(n9.prototype,"maxLength"),n9.prototype),xe(n9.prototype,"tabIndex",[G7,H7],Object.getOwnPropertyDescriptor(n9.prototype,"tabIndex"),n9.prototype),i9=xe(n9.prototype,"editingDidBegan",[V7,Ic,j7,W7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),r9=xe(n9.prototype,"textChanged",[q7,Ic,X7,Y7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a9=xe(n9.prototype,"editingDidEnded",[K7,Ic,Q7,Z7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),o9=xe(n9.prototype,"editingReturn",[J7,Ic,$7,e9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),s9=xe(n9.prototype,"_textLabel",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c9=xe(n9.prototype,"_placeholderLabel",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l9=xe(n9.prototype,"_returnType",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return c7.DEFAULT}}),u9=xe(n9.prototype,"_string",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),h9=xe(n9.prototype,"_tabIndex",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_9=xe(n9.prototype,"_backgroundImage",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f9=xe(n9.prototype,"_inputFlag",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return u7.DEFAULT}}),d9=xe(n9.prototype,"_inputMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return l7.ANY}}),p9=xe(n9.prototype,"_maxLength",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),t9=n9))||t9)||t9)||t9)||t9)||t9)||t9));"object"===("undefined"==typeof window?"undefined":Y(window))&&"object"===("undefined"==typeof document?"undefined":Y(document))&&(kee._EditBoxImpl=A9),c.internal.EditBox=kee,function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(Pee||(Pee={})),yt(Pee),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(Iee||(Iee={})),yt(Iee),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Dee||(Dee={})),yt(Dee),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(Oee||(Oee={})),yt(Oee),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(Nee||(Nee={})),yt(Nee),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(Mee||(Mee={})),yt(Mee);var Lee,Bee,Fee,zee,Uee,Gee,Hee,Vee,jee,Wee,qee,Xee,Yee,Kee,Qee,Zee,Jee,$ee,ete,tte,nte,ite,rte,ate=new zn,ote=function(t){return e({Layout:t,LayoutComponent:t}),t}((R9=Cc("cc.Layout"),P9=Uc(),I9=bc(110),D9=Lc(),O9=Ac(qV),N9=Hc(),M9=Wc(),k9=Hc(),L9=Wc(),B9=rl(Pee),F9=Zc(),z9=Wc(),U9=rl(Iee),G9=Hc(),H9=Wc(),V9=Hc(),j9=Wc(),W9=rl(Dee),q9=Wc(),X9=Wc(),Y9=Wc(),K9=Wc(),Q9=Wc(),Z9=Wc(),J9=Wc(),$9=rl(Oee),eee=Wc(),tee=rl(Nee),nee=Wc(),iee=rl(Mee),ree=Hc(),aee=Wc(),oee=Hc(),see=Wc(),cee=Wc(),R9(lee=P9(lee=I9(lee=D9(lee=O9(lee=kc((Ree=wee=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_resizeMode",hee,se(e)),ye(e,"_layoutType",_ee,se(e)),ye(e,"_cellSize",fee,se(e)),ye(e,"_startAxis",dee,se(e)),ye(e,"_paddingLeft",pee,se(e)),ye(e,"_paddingRight",mee,se(e)),ye(e,"_paddingTop",vee,se(e)),ye(e,"_paddingBottom",gee,se(e)),ye(e,"_spacingX",yee,se(e)),ye(e,"_spacingY",xee,se(e)),ye(e,"_verticalDirection",See,se(e)),ye(e,"_horizontalDirection",Tee,se(e)),ye(e,"_constraint",Eee,se(e)),ye(e,"_constraintNum",Cee,se(e)),ye(e,"_affectedByScale",Aee,se(e)),ye(e,"_isAlign",bee,se(e)),e._layoutSize=new hi(300,200),e._layoutDirty=!0,e._childrenDirty=!1,e._usefulLayoutObj=[],e._init=!1,e}return Z(n,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===Pee.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===Pee.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==Pee.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==Pee.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==Mee.NONE&&this._constraintNum!==e&&(e<=0&&y("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}},{key:"updateLayout",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(hi.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()}},{key:"onDisable",value:function(){this._usefulLayoutObj.length=0,this._removeEventListeners()}},{key:"_checkUsefulObj",value:function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}}},{key:"_addEventListeners",value:function(){$N.on(JN.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on($E.SIZE_CHANGED,this._resized,this),this.node.on($E.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on($E.CHILD_ADDED,this._childAdded,this),this.node.on($E.CHILD_REMOVED,this._childRemoved,this),this.node.on($E.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){$N.off(JN.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off($E.SIZE_CHANGED,this._resized,this),this.node.off($E.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off($E.CHILD_ADDED,this._childAdded,this),this.node.off($E.CHILD_REMOVED,this._childRemoved,this),this.node.off($E.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on($E.SIZE_CHANGED,this._doLayoutDirty,this),n.on($E.TRANSFORM_CHANGED,this._transformDirty,this),n.on($E.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on($E.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}}},{key:"_removeChildrenEventListeners",value:function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off($E.SIZE_CHANGED,this._doLayoutDirty,this),n.off($E.TRANSFORM_CHANGED,this._transformDirty,this),n.off($E.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off($E.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}}},{key:"_childAdded",value:function(e){e.on($E.SIZE_CHANGED,this._doLayoutDirty,this),e.on($E.TRANSFORM_CHANGED,this._transformDirty,this),e.on($E.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on($E.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()}},{key:"_childRemoved",value:function(e){e.off($E.SIZE_CHANGED,this._doLayoutDirty,this),e.off($E.TRANSFORM_CHANGED,this._transformDirty,this),e.off($E.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off($E.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()}},{key:"_resized",value:function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,a=this._getFixedBreakingNum(),o=1,s=this._paddingLeft;this._horizontalDirection===Nee.RIGHT_TO_LEFT&&(o=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+o*s,l=c-o*this._spacingX,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==Pee.GRID&&this._resizeMode===Iee.CHILDREN&&(m=(e-v-(p-1)*this._spacingX)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,T=S.scale,E=this._getUsedScaleValue(T.x),C=this._getUsedScaleValue(T.y);this._resizeMode===Iee.CHILDREN&&(x.width=m/E,this._layoutType===Pee.GRID&&(x.height=this._cellSize.height/C));var A=Math.abs(this._horizontalDirection-x.anchorX),b=x.width*E,w=x.height*C;w>_&&(f=Math.max(_,f),h=_||w,_=w),l+=o*(A*b+this._spacingX);var R=o*(1-A)*b;if(t){if(a>0)(d=y/a>0&&y%a==0)&&(h=_>w?_:h);else if(b>e-v)l>c+o*A*b&&(d=!0);else{var P=(1-this._horizontalDirection-r.x)*e,I=l+R+o*(o>0?this._paddingRight:this._paddingLeft);d=Math.abs(I)>Math.abs(P)}d&&(l=c+o*A*b,w!==_&&(h=_),u+=h+this._spacingY,h=_=w)}var D=n(S,x,u);i&&S.setPosition(l,D),l+=R}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()}},{key:"_doLayoutVertically",value:function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,a=this._getFixedBreakingNum(),o=1,s=this._paddingBottom;this._verticalDirection===Oee.TOP_TO_BOTTOM&&(o=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+o*s,l=c-o*this._spacingY,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==Pee.GRID&&this._resizeMode===Iee.CHILDREN&&(m=(e-v-(p-1)*this._spacingY)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,T=S.scale,E=this._getUsedScaleValue(T.x),C=this._getUsedScaleValue(T.y);this._resizeMode===Iee.CHILDREN&&(x.height=m/C,this._layoutType===Pee.GRID&&(x.width=this._cellSize.width/E));var A=Math.abs(this._verticalDirection-x.anchorY),b=x.width*E,w=x.height*C;b>u&&(h=Math.max(u,h),_=u||b,u=b),l+=o*(A*w+this._spacingY);var R=o*(1-A)*w;if(t){if(a>0)(d=y/a>0&&y%a==0)&&(_=u>w?u:_);else if(w>e-v)l>c+o*A*w&&(d=!0);else{var P=(1-this._verticalDirection-r.y)*e,I=l+R+o*(o>0?this._paddingTop:this._paddingBottom);d=Math.abs(I)>Math.abs(P)}d&&(l=c+o*A*w,b!==u&&(_=u),f+=_+this._spacingX,_=u=b)}var D=n(S,x,f);i&&(S.getPosition(ate),S.setPosition(D,l,ate.z)),l+=R}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var n=this,i=t.width,r=1,a=-e.y*t.height,o=this._paddingBottom;this._verticalDirection===Oee.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,o=this._paddingTop);var s=function(e,t,i){return a+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+o)},c=0;this._resizeMode===Iee.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),a=-e.y*c,this._verticalDirection===Oee.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===Iee.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var n=this,i=t.height,r=1,a=-e.x*t.width,o=this._paddingLeft;this._horizontalDirection===Nee.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,o=this._paddingRight);var s=function(e,t,i){return a+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+o)},c=0;this._resizeMode===Iee.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),a=-e.x*c,this._horizontalDirection===Nee.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===Iee.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)}},{key:"_doLayoutGrid",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===Dee.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===Dee.VERTICAL&&this._doLayoutGridAxisVertical(t,n)}},{key:"_getHorizontalBaseWidth",value:function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===Iee.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],a=r.node.scale;t+=r.width*this._getUsedScaleValue(a.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t}},{key:"_getVerticalBaseHeight",value:function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===Iee.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],a=r.node.scale;t+=r.height*this._getUsedScaleValue(a.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t}},{key:"_doLayout",value:function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===Pee.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?zn.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===Pee.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?zn.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===Pee.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e&fy.SCALE&&e&fy.POSITION&&this._affectedByScale&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_childrenChanged",value:function(){this._childrenDirty=!0,this._doLayoutDirty()}},{key:"_getPaddingH",value:function(){return this._paddingLeft+this._paddingRight}},{key:"_getPaddingV",value:function(){return this._paddingTop+this._paddingBottom}},{key:"_getFixedBreakingNum",value:function(){if(this._layoutType!==Pee.GRID||this._constraint===Mee.NONE||this._constraintNum<=0)return 0;var e=this._constraint===Mee.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===Dee.VERTICAL&&(e=this._constraint===Mee.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e}}]),n}(sh),wee.Type=Pee,wee.VerticalDirection=Oee,wee.HorizontalDirection=Nee,wee.ResizeMode=Iee,wee.AxisDirection=Dee,wee.Constraint=Mee,xe((uee=Ree).prototype,"alignHorizontal",[N9,M9],Object.getOwnPropertyDescriptor(uee.prototype,"alignHorizontal"),uee.prototype),xe(uee.prototype,"alignVertical",[k9,L9],Object.getOwnPropertyDescriptor(uee.prototype,"alignVertical"),uee.prototype),xe(uee.prototype,"type",[B9,F9,z9],Object.getOwnPropertyDescriptor(uee.prototype,"type"),uee.prototype),xe(uee.prototype,"resizeMode",[U9,G9,H9],Object.getOwnPropertyDescriptor(uee.prototype,"resizeMode"),uee.prototype),xe(uee.prototype,"cellSize",[V9,j9],Object.getOwnPropertyDescriptor(uee.prototype,"cellSize"),uee.prototype),xe(uee.prototype,"startAxis",[W9,q9],Object.getOwnPropertyDescriptor(uee.prototype,"startAxis"),uee.prototype),xe(uee.prototype,"paddingLeft",[X9],Object.getOwnPropertyDescriptor(uee.prototype,"paddingLeft"),uee.prototype),xe(uee.prototype,"paddingRight",[Y9],Object.getOwnPropertyDescriptor(uee.prototype,"paddingRight"),uee.prototype),xe(uee.prototype,"paddingTop",[K9],Object.getOwnPropertyDescriptor(uee.prototype,"paddingTop"),uee.prototype),xe(uee.prototype,"paddingBottom",[Q9],Object.getOwnPropertyDescriptor(uee.prototype,"paddingBottom"),uee.prototype),xe(uee.prototype,"spacingX",[Z9],Object.getOwnPropertyDescriptor(uee.prototype,"spacingX"),uee.prototype),xe(uee.prototype,"spacingY",[J9],Object.getOwnPropertyDescriptor(uee.prototype,"spacingY"),uee.prototype),xe(uee.prototype,"verticalDirection",[$9,eee],Object.getOwnPropertyDescriptor(uee.prototype,"verticalDirection"),uee.prototype),xe(uee.prototype,"horizontalDirection",[tee,nee],Object.getOwnPropertyDescriptor(uee.prototype,"horizontalDirection"),uee.prototype),xe(uee.prototype,"constraint",[iee,ree,aee],Object.getOwnPropertyDescriptor(uee.prototype,"constraint"),uee.prototype),xe(uee.prototype,"constraintNum",[oee,see],Object.getOwnPropertyDescriptor(uee.prototype,"constraintNum"),uee.prototype),xe(uee.prototype,"affectedByScale",[cee],Object.getOwnPropertyDescriptor(uee.prototype,"affectedByScale"),uee.prototype),hee=xe(uee.prototype,"_resizeMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Iee.NONE}}),_ee=xe(uee.prototype,"_layoutType",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pee.NONE}}),fee=xe(uee.prototype,"_cellSize",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(40,40)}}),dee=xe(uee.prototype,"_startAxis",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dee.HORIZONTAL}}),pee=xe(uee.prototype,"_paddingLeft",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mee=xe(uee.prototype,"_paddingRight",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vee=xe(uee.prototype,"_paddingTop",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gee=xe(uee.prototype,"_paddingBottom",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yee=xe(uee.prototype,"_spacingX",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xee=xe(uee.prototype,"_spacingY",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),See=xe(uee.prototype,"_verticalDirection",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oee.TOP_TO_BOTTOM}}),Tee=xe(uee.prototype,"_horizontalDirection",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nee.LEFT_TO_RIGHT}}),Eee=xe(uee.prototype,"_constraint",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mee.NONE}}),Cee=xe(uee.prototype,"_constraintNum",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Aee=xe(uee.prototype,"_affectedByScale",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bee=xe(uee.prototype,"_isAlign",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lee=uee))||lee)||lee)||lee)||lee)||lee)||lee));c.Layout=ote,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(rte||(rte={})),mt(rte);var ste,cte,lte,ute,hte,_te,fte,dte,pte,mte,vte,gte,yte,xte,Ste,Tte,Ete,Cte,Ate,bte,wte,Rte,Pte,Ite,Dte=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((Lee=Cc("cc.ProgressBar"),Bee=Uc(),Fee=bc(110),zee=Lc(),Uee=Ac(qV),Gee=rl(yY),Hee=Wc(),Vee=rl(rte),jee=Wc(),Wee=Wc(),qee=qc(),Xee=Wc(),Yee=Wc(),Lee(Kee=Bee(Kee=Fee(Kee=zee(Kee=Uee((ite=nte=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_barSprite",Zee,se(e)),ye(e,"_mode",Jee,se(e)),ye(e,"_totalLength",$ee,se(e)),ye(e,"_progress",ete,se(e)),ye(e,"_reverse",tte,se(e)),e}return Z(n,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===rte.HORIZONTAL?this.totalLength=n.width:this._mode===rte.VERTICAL?this.totalLength=n.height:this._mode===rte.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===rte.FILLED&&(e=yn(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}},{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===yY.FillType.RADIAL&&(this._mode=rte.FILLED),this._mode===rte.HORIZONTAL?this.totalLength=r.width:this._mode===rte.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var a=-n.width*i.x;e.setPosition(a,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),a=new ri(0,.5),o=yn(this._progress),s=this._totalLength*o,c=i,l=0,u=0;switch(this._mode){case rte.HORIZONTAL:this._reverse&&(a=new ri(1,.5)),c=new hi(s,i.height),l=this._totalLength,u=i.height;break;case rte.VERTICAL:a=this._reverse?new ri(.5,1):new ri(.5,0),c=new hi(i.width,s),l=i.width,u=this._totalLength}if(this._mode===rte.FILLED)this._barSprite.type!==yY.Type.FILLED?y("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==yY.Type.FILLED){var h=a.x-n.x,_=a.y-n.y,f=new zn(l*h,u*_,0);e.setPosition(r.x+f.x,r.y+f.y,r.z),t.setAnchorPoint(a),t.setContentSize(c)}else y("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}}]),n}(sh),nte.Mode=rte,xe((Qee=ite).prototype,"barSprite",[Gee,Hee],Object.getOwnPropertyDescriptor(Qee.prototype,"barSprite"),Qee.prototype),xe(Qee.prototype,"mode",[Vee,jee],Object.getOwnPropertyDescriptor(Qee.prototype,"mode"),Qee.prototype),xe(Qee.prototype,"totalLength",[Wee],Object.getOwnPropertyDescriptor(Qee.prototype,"totalLength"),Qee.prototype),xe(Qee.prototype,"progress",[qee,Qc,Xee],Object.getOwnPropertyDescriptor(Qee.prototype,"progress"),Qee.prototype),xe(Qee.prototype,"reverse",[Yee],Object.getOwnPropertyDescriptor(Qee.prototype,"reverse"),Qee.prototype),Zee=xe(Qee.prototype,"_barSprite",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jee=xe(Qee.prototype,"_mode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rte.HORIZONTAL}}),$ee=xe(Qee.prototype,"_totalLength",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ete=xe(Qee.prototype,"_progress",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),tte=xe(Qee.prototype,"_reverse",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Kee=Qee))||Kee)||Kee)||Kee)||Kee)||Kee));c.ProgressBar=Dte;var Ote,Nte=new zn,Mte=new zn,kte=new zn,Lte=new ri,Bte=new Bn,Fte=new ri;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Ote||(Ote={})),yt(Ote);var zte,Ute=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((ste=Cc("cc.ScrollBar"),cte=Uc(),lte=bc(110),ute=Lc(),hte=Ac(qV),_te=rl(yY),fte=Zc(),dte=Wc(),pte=rl(Ote),mte=Zc(),vte=Wc(),gte=Zc(),yte=Wc(),xte=Zc(),Ste=Wc(),ste(Tte=cte(Tte=lte(Tte=ute(Tte=hte((Ite=Pte=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_scrollView",Cte,se(e)),ye(e,"_handle",Ate,se(e)),ye(e,"_direction",bte,se(e)),ye(e,"_enableAutoHide",wte,se(e)),ye(e,"_autoHideTime",Rte,se(e)),e._touching=!1,e._opacity=255,e._autoHideRemainingTime=0,e}return Z(n,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(ri.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(ri.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}},{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,o=0,s=0,c=0,l=0,u=Fte;u.set(0,0),this._direction===Ote.HORIZONTAL?(a=n.width,o=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===Ote.VERTICAL&&(a=n.height,o=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(a,o,l,s),_=Fte;this._calculatePosition(_,a,o,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(yY);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){Nte.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(Nte,Mte);var r=n.convertToNodeSpaceAR(Mte);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(ri.ZERO)}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(yY);t&&(Bte.set(t.color),Bte.a=e,t.color=Bte),(t=this._handle.getComponent(yY))&&(Bte.set(t.color),Bte.a=e,t.color=Bte)}}},{key:"_updateHandlerPosition",value:function(e){if(this._handle){var t=kte;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,a=this.handle.node.parent;zn.set(Nte,-n.width*i.x,-n.height*i.y,0);var o=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(Nte,Mte),s=e;s.set(0,0,0),a._uiProps.uiTransformComp.convertToNodeSpaceAR(o,s),this.direction===Ote.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===Ote.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===Ote.HORIZONTAL||e.height<=t.height&&this._direction===Ote.VERTICAL}},{key:"_calculateLength",value:function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)}},{key:"_calculatePosition",value:function(e,t,n,i,r,a,o){var s=t-n;a&&(s+=Math.abs(a));var c=0;s&&(c=yn(c=r/s));var l=(i-o)*c;this._direction===Ote.VERTICAL?e.set(0,l):e.set(l,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===Lte.x&&i.y===Lte.y||t.setAnchorPoint(Lte),this._direction===Ote.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}}]),n}(sh),Pte.Direction=Ote,xe((Ete=Ite).prototype,"handle",[_te,fte,dte],Object.getOwnPropertyDescriptor(Ete.prototype,"handle"),Ete.prototype),xe(Ete.prototype,"direction",[pte,mte,vte],Object.getOwnPropertyDescriptor(Ete.prototype,"direction"),Ete.prototype),xe(Ete.prototype,"enableAutoHide",[gte,yte],Object.getOwnPropertyDescriptor(Ete.prototype,"enableAutoHide"),Ete.prototype),xe(Ete.prototype,"autoHideTime",[xte,Ste],Object.getOwnPropertyDescriptor(Ete.prototype,"autoHideTime"),Ete.prototype),Cte=xe(Ete.prototype,"_scrollView",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ate=xe(Ete.prototype,"_handle",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bte=xe(Ete.prototype,"_direction",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ote.HORIZONTAL}}),wte=xe(Ete.prototype,"_enableAutoHide",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rte=xe(Ete.prototype,"_autoHideTime",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Tte=Ete))||Tte)||Tte)||Tte)||Tte)||Tte));c.ScrollBar=Ute;var Gte,Hte,Vte,jte,Wte,qte,Xte,Yte,Kte,Qte,Zte,Jte,$te,ene,tne,nne,ine,rne,ane,one,sne,cne,lne,une,hne,_ne,fne,dne,pne,mne,vne,gne,yne,xne,Sne,Tne,Ene,Cne,Ane,bne,wne,Rne,Pne,Ine,Dne,One,Nne,Mne,kne=e("ViewGroup",Cc("cc.ViewGroup")(zte=bc(110)(zte=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return n}(sh))||zte)||zte);c.ViewGroup=kne;var Lne,Bne=1e-4,Fne=new zn,zne=new zn,Une=new ri,Gne=new ri,Hne=function(){return(new Date).getMilliseconds()},Vne={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(Lne||(Lne={}));var jne,Wne,qne,Xne,Yne,Kne,Qne,Zne,Jne,$ne,eie,tie,nie,iie,rie,aie,oie,sie,cie,lie,uie,hie=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((Gte=Cc("cc.ScrollView"),Hte=Uc(),Vte=bc(110),jte=Lc(),Wte=Ac(qV),qte=qc(),Xte=Zc(),Yte=Wc(),Kte=qc(),Qte=Zc(),Zte=Wc(),Jte=Zc(),$te=Wc(),ene=Zc(),tne=Wc(),nne=rl(tb),ine=Zc(),rne=Wc(),ane=Zc(),one=Wc(),sne=rl(Ute),cne=Zc(),lne=Wc(),une=Zc(),hne=Wc(),_ne=rl(Ute),fne=Zc(),dne=Wc(),pne=Zc(),mne=Wc(),vne=rl([KL]),gne=Zc(),yne=Wc(),Gte(xne=Hte(xne=Vte(xne=jte(xne=Wte((Mne=Nne=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"bounceDuration",Tne,se(e)),ye(e,"brake",Ene,se(e)),ye(e,"elastic",Cne,se(e)),ye(e,"inertia",Ane,se(e)),ye(e,"horizontal",bne,se(e)),ye(e,"vertical",wne,se(e)),ye(e,"cancelInnerEvents",Rne,se(e)),ye(e,"scrollEvents",Pne,se(e)),e._autoScrolling=!1,e._scrolling=!1,ye(e,"_content",Ine,se(e)),ye(e,"_horizontalScrollBar",Dne,se(e)),ye(e,"_verticalScrollBar",One,se(e)),e._topBoundary=0,e._bottomBoundary=0,e._leftBoundary=0,e._rightBoundary=0,e._touchMoveDisplacements=[],e._touchMoveTimeDeltas=[],e._touchMovePreviousTimestamp=0,e._touchMoved=!1,e._autoScrollAttenuate=!1,e._autoScrollStartPosition=new zn,e._autoScrollTargetDelta=new zn,e._autoScrollTotalTime=0,e._autoScrollAccumulatedTime=0,e._autoScrollCurrentlyOutOfBoundary=!1,e._autoScrollBraking=!1,e._autoScrollBrakingStartPosition=new zn,e._outOfBoundaryAmount=new zn,e._outOfBoundaryAmountDirty=!0,e._stopMouseWheel=!1,e._mouseWheelEventElapsedTime=0,e._isScrollEndedWithThresholdEventFired=!1,e._scrollEventEmitMask=0,e._isBouncing=!1,e._contentPos=new zn,e._deltaPos=new zn,e}return Z(n,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):w(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(ri.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(ri.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}},{key:"scrollToBottom",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._calculateMovePercentDelta({anchor:new ri(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)}},{key:"scrollToTop",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._calculateMovePercentDelta({anchor:new ri(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)}},{key:"scrollToLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._calculateMovePercentDelta({anchor:new ri(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)}},{key:"scrollToRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._calculateMovePercentDelta({anchor:new ri(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)}},{key:"scrollToTopLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._calculateMovePercentDelta({anchor:new ri(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)}},{key:"scrollToTopRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._calculateMovePercentDelta({anchor:new ri(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)}},{key:"scrollToBottomLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._calculateMovePercentDelta({anchor:new ri(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)}},{key:"scrollToBottomRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._calculateMovePercentDelta({anchor:new ri(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)}},{key:"scrollToOffset",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=this.getMaxScrollOffset(),r=new ri(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new ri(t,e)}},{key:"getMaxScrollOffset",value:function(){if(!this._content||!this.view)return ri.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new ri(t=t>=0?t:0,n=n>=0?n:0)}},{key:"scrollToPercentHorizontal",value:function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new ri(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)}},{key:"scrollTo",value:function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new ri(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)}},{key:"scrollToPercentVertical",value:function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new ri(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){this._setContentPosition(e)}},{key:"_setContentPosition",value:function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<Bne&&Math.abs(e.y-t.y)<Bne||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}}},{key:"getContentPosition",value:function(){return this._getContentPosition()}},{key:"_getContentPosition",value:function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):zn.ZERO.clone()}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return Bne}},{key:"start",value:function(){this._calculateBoundary(),this._content&&$N.once(JN.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this._content&&(this._content.on($E.SIZE_CHANGED,this._calculateBoundary,this),this._content.on($E.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on($E.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on($E.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this._content&&(this._content.off($E.SIZE_CHANGED,this._calculateBoundary,this),this._content.off($E.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off($E.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off($E.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on($E.TOUCH_START,this._onTouchBegan,this,!0),this.node.on($E.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on($E.TOUCH_END,this._onTouchEnded,this,!0),this.node.on($E.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on($E.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off($E.TOUCH_START,this._onTouchBegan,this,!0),this.node.off($E.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off($E.TOUCH_END,this._onTouchEnded,this,!0),this.node.off($E.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off($E.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new zn,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(Une);if(i.subtract(n.getUIStartLocation(Gne)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new iD(e.getTouches(),e.bubbles,Kb.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(Lne.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this._content&&this.view){var e=this._content.getComponent(ote);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(!e||e.eventPhase!==JI.CAPTURING_PHASE)return!1;if(t)for(var n,i=ge(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(kne));if(r.getComponent(kne))return!0}return!1}},{key:"_startInertiaScroll",value:function(e){var t=new zn(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,a=i.width-r.width,o=i.height-r.height,s=this._calculateAttenuatedFactor(a),c=this._calculateAttenuatedFactor(o);n.x=n.x*a*(1-this.brake)*s,n.y=n.y*o*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var _=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)}},{key:"_calculateAutoScrollTimeByInitialSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,zn.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0);var r=this._getHowMuchOutOfBoundary();r.equals(zn.ZERO,Bne)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=new zn,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(zn.ZERO);else{var n=new zn;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var n=this._flattenVectorByDirection(e);Fne.set(this._getContentPosition()),Fne.add(n),Fne.set(Math.round(1e4*Fne.x)*Bne,Math.round(1e4*Fne.y)*Bne,Fne.z),this._setContentPosition(Fne);var i=this._getHowMuchOutOfBoundary();Une.set(i.x,i.y),this._updateScrollBar(Une),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width}},{key:"_getContentRightBoundary",value:function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width}},{key:"_getContentTopBoundary",value:function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height}},{key:"_getContentBottomBoundary",value:function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new zn).equals(zn.ZERO,Bne)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new zn,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+e.x>this._leftBoundary?t.x=this._leftBoundary-(n+e.x):i+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(i+e.x));var r=this._getContentTopBoundary(),a=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):a+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(a+e.y)),e.equals(zn.ZERO,Bne)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if(e===Lne.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===Lne.SCROLL_TO_TOP||e===Lne.SCROLL_TO_BOTTOM||e===Lne.SCROLL_TO_LEFT||e===Lne.SCROLL_TO_RIGHT){var t=1<<Vne[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}KL.emitEvents(this.scrollEvents,this,Vne[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();Fne.set(this._getContentPosition()),Fne.add(e),this._content.setPosition(Fne),this._updateScrollBar(ri.ZERO)}}},{key:"_hideScrollBar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}},{key:"_updateScrollBarState",value:function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e.eventPhase===JI.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)}},{key:"_handleReleaseLogic",value:function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(Lne.SCROLL_ENDED))}},{key:"_getLocalAxisAlignDelta",value:function(e,t){var n=this.node._uiProps.uiTransformComp,i=new zn;n&&(t.getUILocation(Une),t.getUIPreviousLocation(Gne),Fne.set(Une.x,Une.y,0),zne.set(Gne.x,Gne.y,0),n.convertToNodeSpaceAR(Fne,Fne),n.convertToNodeSpaceAR(zne,zne),zn.subtract(i,Fne,zne)),e.set(i)}},{key:"_scrollChildren",value:function(e){this._clampDelta(e);var t,n=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var i="",r="";if(this._content){var a=this._content._uiProps.uiTransformComp,o=a.anchorX,s=a.anchorY,c=a.width,l=a.height,u=this._content.position||zn.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=Lne.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=Lne.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-o*c+c+n.x<=this._rightBoundary&&(r=Lne.SCROLL_TO_RIGHT):n.x>0&&u.x-o*c+n.x>=this._leftBoundary&&(r=Lne.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(Lne.SCROLL_BEGAN)),this._dispatchEvent(Lne.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent(Lne.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=Hne(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}}},{key:"_gatherTouchMove",value:function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=Hne();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(zn.ZERO,Bne))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(Lne.BOUNCE_TOP),e.y<0&&this._dispatchEvent(Lne.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(Lne.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(Lne.BOUNCE_LEFT),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(Fne,Bne)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals(zn.ZERO,Bne)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var a=this._autoScrollTargetDelta.clone();a.multiplyScalar(r);var o=this._autoScrollStartPosition.clone();o.add(a);var s=Math.abs(r-1)<=Bne;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(Lne.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=o.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),o.set(this._autoScrollBrakingStartPosition),o.add(c)}else{var l=o.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(zn.ZERO,Bne)||(o.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=o.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(Lne.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(Lne.SCROLL_ENDED))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals(zn.ZERO,Bne))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Lne.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Lne.SCROLL_ENDED),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(ri.ZERO,ri.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var a=this._getContentLeftBoundary()-this._leftBoundary;a=-a;var o=new zn;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,o.x=a-s*t.x),i&&(s=c.height-l.height,o.y=r-s*t.y)}return o}},{key:"_moveContentToTopLeft",value:function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new zn,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var a=this._content._uiProps.uiTransformComp.contentSize;a.height<e.height&&(i=a.height-e.height,n.y=t-i),a.width<e.width&&(i=a.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()}},{key:"_scaleChanged",value:function(e){e===fy.SCALE&&this._calculateBoundary()}}]),n}(kne),Nne.EventType=Lne,Tne=xe((Sne=Mne).prototype,"bounceDuration",[Ic,qte,Xte,Yte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ene=xe(Sne.prototype,"brake",[Ic,Kte,Qte,Zte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Cne=xe(Sne.prototype,"elastic",[Ic,Jte,$te],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ane=xe(Sne.prototype,"inertia",[Ic,ene,tne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xe(Sne.prototype,"content",[nne,ine,rne],Object.getOwnPropertyDescriptor(Sne.prototype,"content"),Sne.prototype),bne=xe(Sne.prototype,"horizontal",[Ic,ane,one],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xe(Sne.prototype,"horizontalScrollBar",[sne,cne,lne],Object.getOwnPropertyDescriptor(Sne.prototype,"horizontalScrollBar"),Sne.prototype),wne=xe(Sne.prototype,"vertical",[Ic,une,hne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xe(Sne.prototype,"verticalScrollBar",[_ne,fne,dne],Object.getOwnPropertyDescriptor(Sne.prototype,"verticalScrollBar"),Sne.prototype),Rne=xe(Sne.prototype,"cancelInnerEvents",[Ic,pne,mne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Pne=xe(Sne.prototype,"scrollEvents",[vne,Ic,gne,yne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ine=xe(Sne.prototype,"_content",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dne=xe(Sne.prototype,"_horizontalScrollBar",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),One=xe(Sne.prototype,"_verticalScrollBar",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xne=Sne))||xne)||xne)||xne)||xne)||xne));c.ScrollView=hie;var _ie,fie=new zn;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(_ie||(_ie={})),yt(_ie);var die,pie,mie,vie,gie,yie,xie,Sie,Tie,Eie,Cie,Aie,bie,wie,Rie,Pie,Iie,Die,Oie,Nie,Mie=function(t){return e({Slider:t,SliderComponent:t}),t}((jne=Cc("cc.Slider"),Wne=Uc(),qne=bc(110),Xne=Lc(),Yne=Ac(qV),Kne=rl(yY),Qne=Wc(),Zne=rl(_ie),Jne=Wc(),$ne=qc(),eie=Wc(),tie=rl([KL]),nie=Wc(),jne(iie=Wne(iie=qne(iie=Xne(iie=Yne((uie=lie=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"slideEvents",aie,se(e)),ye(e,"_handle",oie,se(e)),ye(e,"_direction",sie,se(e)),ye(e,"_progress",cie,se(e)),e._offset=new zn,e._dragging=!1,e._touchHandle=!1,e._handleLocalPos=new zn,e._touchPos=new zn,e}return Z(n,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}},{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on($E.TOUCH_START,this._onTouchBegan,this),this.node.on($E.TOUCH_MOVE,this._onTouchMoved,this),this.node.on($E.TOUCH_END,this._onTouchEnded,this),this.node.on($E.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on($E.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on($E.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on($E.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off($E.TOUCH_START,this._onTouchBegan,this),this.node.off($E.TOUCH_MOVE,this._onTouchMoved,this),this.node.off($E.TOUCH_END,this._onTouchEnded,this),this.node.off($E.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off($E.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off($E.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off($E.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();zn.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new zn,e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){KL.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();zn.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,fie);this.direction===_ie.Horizontal?this.progress=yn(.5+(i.x-this._offset.x)/n.width):this.progress=yn(.5+(i.y-this._offset.y)/n.height)}}},{key:"_updateHandlePosition",value:function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===_ie.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}}},{key:"_changeLayout",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===_ie.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}}}]),n}(sh),lie.Direction=_ie,xe((rie=uie).prototype,"handle",[Kne,Qne],Object.getOwnPropertyDescriptor(rie.prototype,"handle"),rie.prototype),xe(rie.prototype,"direction",[Zne,Jne],Object.getOwnPropertyDescriptor(rie.prototype,"direction"),rie.prototype),xe(rie.prototype,"progress",[Qc,$ne,eie],Object.getOwnPropertyDescriptor(rie.prototype,"progress"),rie.prototype),aie=xe(rie.prototype,"slideEvents",[tie,Ic,nie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oie=xe(rie.prototype,"_handle",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sie=xe(rie.prototype,"_direction",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _ie.Horizontal}}),cie=xe(rie.prototype,"_progress",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),iie=rie))||iie)||iie)||iie)||iie)||iie));function kie(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}c.Slider=Mie,function(e){e.TOGGLE="toggle"}(Nie||(Nie={}));var Lie,Bie,Fie,zie,Uie,Gie,Hie,Vie,jie,Wie,qie,Xie,Yie=function(t){return e({Toggle:t,ToggleComponent:t}),t}((die=Cc("cc.Toggle"),pie=Uc(),mie=bc(110),vie=Lc(),gie=Ac(qV),yie=Zc(),xie=Wc(),Sie=rl(yY),Tie=Zc(),Eie=Wc(),Cie=rl([KL]),Aie=Wc(),die(bie=pie(bie=mie(bie=vie(bie=gie((Oie=Die=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"checkEvents",Rie,se(e)),ye(e,"_isChecked",Pie,se(e)),ye(e,"_checkMark",Iie,se(e)),e}return Z(n,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return c.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}},{key:"_internalToggle",value:function(){this.isChecked=!this.isChecked}},{key:"_set",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}}},{key:"playEffect",value:function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}},{key:"setIsCheckedWithoutNotify",value:function(e){this._set(e,!1)}},{key:"onEnable",value:function(){he(ne(n.prototype),"onEnable",this).call(this),this.playEffect(),this.node.on(n.EventType.CLICK,this._internalToggle,this)}},{key:"onDisable",value:function(){he(ne(n.prototype),"onDisable",this).call(this),this.node.off(n.EventType.CLICK,this._internalToggle,this)}},{key:"OnDestroy",value:function(){var e=this._toggleContainer;e&&e.ensureValidState()}},{key:"_emitToggleEvents",value:function(){this.node.emit(n.EventType.TOGGLE,this),this.checkEvents&&KL.emitEvents(this.checkEvents,this)}}]),n}(s7),Die.EventType=kie(Nie,a7),xe((wie=Oie).prototype,"isChecked",[yie,xie],Object.getOwnPropertyDescriptor(wie.prototype,"isChecked"),wie.prototype),xe(wie.prototype,"checkMark",[Sie,Tie,Eie],Object.getOwnPropertyDescriptor(wie.prototype,"checkMark"),wie.prototype),Rie=xe(wie.prototype,"checkEvents",[Cie,Ic,Aie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pie=xe(wie.prototype,"_isChecked",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Iie=xe(wie.prototype,"_checkMark",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bie=wie))||bie)||bie)||bie)||bie)||bie));c.Toggle=Yie;var Kie,Qie,Zie,Jie,$ie,ere,tre,nre,ire,rre,are,ore,sre,cre,lre,ure,hre,_re,fre,dre,pre,mre,vre,gre,yre,xre,Sre,Tre,Ere,Cre,Are,bre,wre,Rre,Pre,Ire,Dre,Ore,Nre,Mre,kre,Lre,Bre,Fre,zre,Ure=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((Lie=Cc("cc.ToggleContainer"),Bie=Uc(),Fie=bc(110),zie=Lc(),Uie=Wc(),Gie=rl([KL]),Hie=Wc(),Lie(Vie=Bie(Vie=Fie(Vie=zie(Vie=kc((Xie=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_allowSwitchOff",Wie,se(e)),ye(e,"checkEvents",qie,se(e)),e}return Z(n,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}},{key:"onEnable",value:function(){this.ensureValidState(),this.node.on($E.CHILD_ADDED,this.ensureValidState,this),this.node.on($E.CHILD_REMOVED,this.ensureValidState,this)}},{key:"onDisable",value:function(){this.node.off($E.CHILD_ADDED,this.ensureValidState,this),this.node.off($E.CHILD_REMOVED,this.ensureValidState,this)}},{key:"activeToggles",value:function(){return this.toggleItems.filter((function(e){return e.isChecked}))}},{key:"anyTogglesChecked",value:function(){return!!this.toggleItems.find((function(e){return e.isChecked}))}},{key:"notifyToggleCheck",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==e&&(t?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&c.Component.EventHandler.emitEvents(this.checkEvents,e)}}},{key:"ensureValidState",value:function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var a=n[r];a!==i&&(a.isChecked=!1)}}}]),n}(sh),Wie=xe((jie=Xie).prototype,"_allowSwitchOff",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xe(jie.prototype,"allowSwitchOff",[Uie],Object.getOwnPropertyDescriptor(jie.prototype,"allowSwitchOff"),jie.prototype),qie=xe(jie.prototype,"checkEvents",[Gie,Ic,Hie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vie=jie))||Vie)||Vie)||Vie)||Vie)||Vie));c.ToggleContainer=Ure;var Gre,Hre,Vre=new ri;function jre(e){return e instanceof DD?nM:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:hi.ZERO}function Wre(e,t,n,i){e.parent?Vre.set(e.parent.getScale().x,e.parent.getScale().y):Vre.set(0,0);for(var r=Vre.x,a=Vre.y,o=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(o+=l.x,s+=l.y,(c=c.parent)===t)break;c?Vre.set(c.getScale().x,c.getScale().y):Vre.set(0,0);var u=Vre.x,h=Vre.y;o*=u,s*=h,r*=u,a*=h}i.x=0!==r?1/r:1,i.y=0!==a?1/a:1,n.x=-o,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(Gre||(Gre={})),yt(Gre),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(Hre||(Hre={}));var qre,Xre,Yre,Kre,Qre,Zre,Jre,$re,eae,tae,nae,iae,rae,aae,oae,sae,cae,lae,uae,hae=Hre.TOP|Hre.BOT,_ae=Hre.LEFT|Hre.RIGHT,fae=function(t){return e({Widget:t,WidgetComponent:t}),t}((Kie=Cc("cc.Widget"),Qie=Uc(),Zie=bc(110),Jie=Lc(),$ie=Ac(qV),ere=rl(tb),tre=Wc(),nre=Wc(),ire=Wc(),rre=Wc(),are=Wc(),ore=Wc(),sre=Wc(),cre=Hc(),lre=Hc(),ure=Wc(),hre=Wc(),_re=Wc(),fre=Wc(),dre=Wc(),pre=Wc(),mre=rl(Gre),vre=Wc(),Kie(gre=Qie(gre=Zie(gre=Jie(gre=$ie(gre=kc((zre=Fre=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r)))._lastPos=new zn,e._lastSize=new hi,e._dirty=!0,e._hadAlignOnce=!1,ye(e,"_alignFlags",xre,se(e)),ye(e,"_target",Sre,se(e)),ye(e,"_left",Tre,se(e)),ye(e,"_right",Ere,se(e)),ye(e,"_top",Cre,se(e)),ye(e,"_bottom",Are,se(e)),ye(e,"_horizontalCenter",bre,se(e)),ye(e,"_verticalCenter",wre,se(e)),ye(e,"_isAbsLeft",Rre,se(e)),ye(e,"_isAbsRight",Pre,se(e)),ye(e,"_isAbsTop",Ire,se(e)),ye(e,"_isAbsBottom",Dre,se(e)),ye(e,"_isAbsHorizontalCenter",Ore,se(e)),ye(e,"_isAbsVerticalCenter",Nre,se(e)),ye(e,"_originalWidth",Mre,se(e)),ye(e,"_originalHeight",kre,se(e)),ye(e,"_alignMode",Lre,se(e)),ye(e,"_lockFlags",Bre,se(e)),e}return Z(n,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&Hre.TOP)>0},set:function(e){this._setAlign(Hre.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&Hre.BOT)>0},set:function(e){this._setAlign(Hre.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&Hre.LEFT)>0},set:function(e){this._setAlign(Hre.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&Hre.RIGHT)>0},set:function(e){this._setAlign(Hre.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&Hre.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=Hre.MID):this._alignFlags&=~Hre.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&Hre.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=Hre.CENTER):this._alignFlags&=~Hre.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&_ae)===_ae}},{key:"isStretchHeight",get:function(){return(this._alignFlags&hae)===hae}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(Hre.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(Hre.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(Hre.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(Hre.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(Hre.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(Hre.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}},{key:"updateAlignment",value:function(){c._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),c._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()}},{key:"onDisable",value:function(){c._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}},{key:"onDestroy",value:function(){this._removeParentEvent()}},{key:"_adjustWidgetToAllowMovingInEditor",value:function(){}},{key:"_adjustWidgetToAllowResizingInEditor",value:function(){}},{key:"_adjustWidgetToAnchorChanged",value:function(){this.setDirty()}},{key:"_adjustTargetToParentChanged",value:function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()}},{key:"_registerEvent",value:function(){this.node.on($E.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on($E.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on($E.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on($E.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_unregisterEvent",value:function(){this.node.off($E.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off($E.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off($E.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}},{key:"_removeParentEvent",value:function(){this.node.off($E.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_autoChangedValue",value:function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:nM;this.isAlignLeft&&e===Hre.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===Hre.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===Hre.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===Hre.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===Hre.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===Hre.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;e&&e.getComponent(qV)&&(e.on($E.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on($E.SIZE_CHANGED,this._setDirtyByMode,this),e.on($E.ANCHOR_CHANGED,this._setDirtyByMode,this))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off($E.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off($E.SIZE_CHANGED,this._setDirtyByMode,this),e.off($E.ANCHOR_CHANGED,this._setDirtyByMode,this))}},{key:"_unregisterOldParentEvents",value:function(e){var t=this._target||e;t&&(t.off($E.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off($E.SIZE_CHANGED,this._setDirtyByMode,this))}},{key:"_setDirtyByMode",value:function(){this.alignMode===Gre.ALWAYS&&this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&_ae)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||(this._dirty=!0)}}]),n}(sh),Fre.AlignMode=Gre,xe((yre=zre).prototype,"target",[ere,tre],Object.getOwnPropertyDescriptor(yre.prototype,"target"),yre.prototype),xe(yre.prototype,"isAlignTop",[nre],Object.getOwnPropertyDescriptor(yre.prototype,"isAlignTop"),yre.prototype),xe(yre.prototype,"isAlignBottom",[ire],Object.getOwnPropertyDescriptor(yre.prototype,"isAlignBottom"),yre.prototype),xe(yre.prototype,"isAlignLeft",[rre],Object.getOwnPropertyDescriptor(yre.prototype,"isAlignLeft"),yre.prototype),xe(yre.prototype,"isAlignRight",[are],Object.getOwnPropertyDescriptor(yre.prototype,"isAlignRight"),yre.prototype),xe(yre.prototype,"isAlignVerticalCenter",[ore],Object.getOwnPropertyDescriptor(yre.prototype,"isAlignVerticalCenter"),yre.prototype),xe(yre.prototype,"isAlignHorizontalCenter",[sre],Object.getOwnPropertyDescriptor(yre.prototype,"isAlignHorizontalCenter"),yre.prototype),xe(yre.prototype,"isStretchWidth",[cre],Object.getOwnPropertyDescriptor(yre.prototype,"isStretchWidth"),yre.prototype),xe(yre.prototype,"isStretchHeight",[lre],Object.getOwnPropertyDescriptor(yre.prototype,"isStretchHeight"),yre.prototype),xe(yre.prototype,"top",[ure],Object.getOwnPropertyDescriptor(yre.prototype,"top"),yre.prototype),xe(yre.prototype,"editorTop",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"editorTop"),yre.prototype),xe(yre.prototype,"bottom",[hre],Object.getOwnPropertyDescriptor(yre.prototype,"bottom"),yre.prototype),xe(yre.prototype,"editorBottom",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"editorBottom"),yre.prototype),xe(yre.prototype,"left",[_re],Object.getOwnPropertyDescriptor(yre.prototype,"left"),yre.prototype),xe(yre.prototype,"editorLeft",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"editorLeft"),yre.prototype),xe(yre.prototype,"right",[fre],Object.getOwnPropertyDescriptor(yre.prototype,"right"),yre.prototype),xe(yre.prototype,"editorRight",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"editorRight"),yre.prototype),xe(yre.prototype,"horizontalCenter",[dre],Object.getOwnPropertyDescriptor(yre.prototype,"horizontalCenter"),yre.prototype),xe(yre.prototype,"editorHorizontalCenter",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"editorHorizontalCenter"),yre.prototype),xe(yre.prototype,"verticalCenter",[pre],Object.getOwnPropertyDescriptor(yre.prototype,"verticalCenter"),yre.prototype),xe(yre.prototype,"editorVerticalCenter",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"editorVerticalCenter"),yre.prototype),xe(yre.prototype,"isAbsoluteTop",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"isAbsoluteTop"),yre.prototype),xe(yre.prototype,"isAbsoluteBottom",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"isAbsoluteBottom"),yre.prototype),xe(yre.prototype,"isAbsoluteLeft",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"isAbsoluteLeft"),yre.prototype),xe(yre.prototype,"isAbsoluteRight",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"isAbsoluteRight"),yre.prototype),xe(yre.prototype,"isAbsoluteHorizontalCenter",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"isAbsoluteHorizontalCenter"),yre.prototype),xe(yre.prototype,"isAbsoluteVerticalCenter",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"isAbsoluteVerticalCenter"),yre.prototype),xe(yre.prototype,"alignMode",[mre,vre],Object.getOwnPropertyDescriptor(yre.prototype,"alignMode"),yre.prototype),xe(yre.prototype,"alignFlags",[Gc],Object.getOwnPropertyDescriptor(yre.prototype,"alignFlags"),yre.prototype),xre=xe(yre.prototype,"_alignFlags",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sre=xe(yre.prototype,"_target",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tre=xe(yre.prototype,"_left",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ere=xe(yre.prototype,"_right",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cre=xe(yre.prototype,"_top",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Are=xe(yre.prototype,"_bottom",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bre=xe(yre.prototype,"_horizontalCenter",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wre=xe(yre.prototype,"_verticalCenter",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rre=xe(yre.prototype,"_isAbsLeft",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Pre=xe(yre.prototype,"_isAbsRight",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ire=xe(yre.prototype,"_isAbsTop",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Dre=xe(yre.prototype,"_isAbsBottom",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ore=xe(yre.prototype,"_isAbsHorizontalCenter",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Nre=xe(yre.prototype,"_isAbsVerticalCenter",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Mre=xe(yre.prototype,"_originalWidth",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kre=xe(yre.prototype,"_originalHeight",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lre=xe(yre.prototype,"_alignMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gre.ON_WINDOW_RESIZE}}),Bre=xe(yre.prototype,"_lockFlags",[Ic,Oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gre=yre))||gre)||gre)||gre)||gre)||gre)||gre));c.internal.computeInverseTransForTarget=Wre,c.internal.getReadonlyNodeSize=jre,c.Widget=fae;var dae,pae=new Bn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(dae||(dae={})),yt(dae);var mae,vae,gae,yae,xae,Sae,Tae,Eae,Cae,Aae,bae,wae,Rae,Pae,Iae,Dae,Oae,Nae,Mae,kae,Lae,Bae,Fae,zae,Uae,Gae,Hae,Vae,jae,Wae,qae,Xae,Yae,Kae,Qae,Zae,Jae,$ae,eoe,toe,noe,ioe,roe,aoe=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((qre=Cc("cc.PageViewIndicator"),Xre=Uc(),Yre=bc(110),Kre=Lc(),Qre=rl(yH),Zre=Wc(),Jre=rl(dae),$re=Wc(),eae=rl(hi),tae=Wc(),nae=Wc(),qre(iae=Xre(iae=Yre(iae=Kre((uae=lae=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"spacing",aae,se(e)),ye(e,"_spriteFrame",oae,se(e)),ye(e,"_direction",sae,se(e)),ye(e,"_cellSize",cae,se(e)),e._layout=null,e._pageView=null,e._indicators=[],e}return Z(n,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}},{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(ote),this._layout||(this._layout=this.addComponent(ote));var e=this._layout;this.direction===dae.HORIZONTAL?(e.type=ote.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===dae.VERTICAL&&(e.type=ote.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=ote.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new tb;e.layer=this.node.layer;var t=e.addComponent(yY);return t.spriteFrame=this.spriteFrame,t.sizeMode=yY.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;pae.set(r.color),pae.a=127.5,r.color=pae}}if(e[t]._uiProps.uiComp){var a=e[t]._uiProps.uiComp;pae.set(a.color),pae.a=255,a.color=pae}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}}]),n}(sh),lae.Direction=dae,xe((rae=uae).prototype,"spriteFrame",[Qre,Zre],Object.getOwnPropertyDescriptor(rae.prototype,"spriteFrame"),rae.prototype),xe(rae.prototype,"direction",[Jre,$re],Object.getOwnPropertyDescriptor(rae.prototype,"direction"),rae.prototype),xe(rae.prototype,"cellSize",[eae,tae],Object.getOwnPropertyDescriptor(rae.prototype,"cellSize"),rae.prototype),aae=xe(rae.prototype,"spacing",[Ic,nae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oae=xe(rae.prototype,"_spriteFrame",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sae=xe(rae.prototype,"_direction",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dae.HORIZONTAL}}),cae=xe(rae.prototype,"_cellSize",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(20,20)}}),iae=rae))||iae)||iae)||iae)||iae));c.PageViewIndicator=aoe;var ooe,soe,coe,loe=new ri;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(ooe||(ooe={})),yt(ooe),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(soe||(soe={})),yt(soe),function(e){e.PAGE_TURNING="page-turning"}(coe||(coe={}));var uoe=function(t){return e({PageView:t,PageViewComponent:t}),t}((mae=Cc("cc.PageView"),vae=Uc(),gae=bc(110),yae=Lc(),xae=rl(ooe),Sae=Wc(),Tae=rl(soe),Eae=Wc(),Cae=qc(),Aae=Wc(),bae=qc(),wae=Wc(),Rae=rl(aoe),Pae=Wc(),Iae=Wc(),Dae=rl(Ute),Oae=Hc(),Nae=rl(Ute),Mae=Hc(),kae=Hc(),Lae=Hc(),Bae=Hc(),Fae=rl([KL]),zae=Hc(),Uae=Wc(),Gae=rl([KL]),Hae=Wc(),mae(Vae=vae(Vae=gae(Vae=yae((roe=ioe=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"autoPageTurningThreshold",Wae,se(e)),ye(e,"horizontal",qae,se(e)),ye(e,"vertical",Xae,se(e)),ye(e,"cancelInnerEvents",Yae,se(e)),ye(e,"scrollEvents",Kae,se(e)),ye(e,"pageTurningSpeed",Qae,se(e)),ye(e,"pageEvents",Zae,se(e)),ye(e,"_sizeMode",Jae,se(e)),ye(e,"_direction",$ae,se(e)),ye(e,"_scrollThreshold",eoe,se(e)),ye(e,"_pageTurningEventTiming",toe,se(e)),ye(e,"_indicator",noe,se(e)),e._curPageIdx=0,e._lastPageIdx=0,e._pages=[],e._initContentPos=new zn,e._scrollCenterOffsetX=[],e._scrollCenterOffsetY=[],e._touchBeganPosition=new ri,e._touchEndPosition=new ri,e}return Z(n,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return he(ne(n.prototype),"verticalScrollBar",this)},set:function(e){fe(ne(n.prototype),"verticalScrollBar",e,this,!0)}},{key:"horizontalScrollBar",get:function(){return he(ne(n.prototype),"horizontalScrollBar",this)},set:function(e){fe(ne(n.prototype),"horizontalScrollBar",e,this,!0)}},{key:"onEnable",value:function(){he(ne(n.prototype),"onEnable",this).call(this),this.node.on($E.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(n.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){he(ne(n.prototype),"onDisable",this).call(this),this.node.off($E.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(n.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):w(4301))}},{key:"insertPage",value:function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void w(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):P(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3;e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){if(this.content){var e=this.content.getComponent(ote);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===soe.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}}},{key:"_updateAllPagesSize",value:function(){var e=this.view;if(this.content&&e&&this._sizeMode===ooe.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(n.EventType.SCROLL_ENDED))}},{key:"_onTouchBegan",value:function(e,t){e.touch.getUILocation(loe),ri.set(this._touchBeganPosition,loe.x,loe.y),he(ne(n.prototype),"_onTouchBegan",this).call(this,e,t)}},{key:"_onTouchMoved",value:function(e,t){he(ne(n.prototype),"_onTouchMoved",this).call(this,e,t)}},{key:"_onTouchEnded",value:function(e,t){e.touch.getUILocation(loe),ri.set(this._touchEndPosition,loe.x,loe.y),he(ne(n.prototype),"_onTouchEnded",this).call(this,e,t)}},{key:"_onTouchCancelled",value:function(e,t){e.touch.getUILocation(loe),ri.set(this._touchEndPosition,loe.x,loe.y),he(ne(n.prototype),"_onTouchCancelled",this).call(this,e,t)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===soe.Horizontal,this.vertical=this.direction===soe.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(ote);if(t){if(this._sizeMode===ooe.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===soe.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===soe.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,KL.emitEvents(this.pageEvents,this,coe.PAGE_TURNING),this.node.emit(coe.PAGE_TURNING,this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===soe.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===soe.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new ri;if(this._sizeMode===ooe.Free)this.direction===soe.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===soe.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===soe.Horizontal?t.x=e*n.width:this.direction===soe.Vertical&&(t.y=e*n.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===soe.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,n){if(this._sizeMode===ooe.Free){var i=0,r=0;if(this.direction===soe.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===soe.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var a=this.view;if(!a)return!1;if(this.direction===soe.Horizontal)return Math.abs(e.x)>=a.width*this.scrollThreshold;if(this.direction===soe.Vertical)return Math.abs(e.y)>=a.height*this.scrollThreshold}return!1}},{key:"_autoScrollToPage",value:function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new ri;ri.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var a=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(a))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}}}]),n}(hie),ioe.SizeMode=ooe,ioe.Direction=soe,ioe.EventType=kie(coe,Lne),xe((jae=roe).prototype,"sizeMode",[xae,Sae],Object.getOwnPropertyDescriptor(jae.prototype,"sizeMode"),jae.prototype),xe(jae.prototype,"direction",[Tae,Eae],Object.getOwnPropertyDescriptor(jae.prototype,"direction"),jae.prototype),xe(jae.prototype,"scrollThreshold",[Qc,Cae,Aae],Object.getOwnPropertyDescriptor(jae.prototype,"scrollThreshold"),jae.prototype),xe(jae.prototype,"pageTurningEventTiming",[Qc,bae,wae],Object.getOwnPropertyDescriptor(jae.prototype,"pageTurningEventTiming"),jae.prototype),xe(jae.prototype,"indicator",[Rae,Pae],Object.getOwnPropertyDescriptor(jae.prototype,"indicator"),jae.prototype),Wae=xe(jae.prototype,"autoPageTurningThreshold",[Ic,Iae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),xe(jae.prototype,"verticalScrollBar",[Dae,dl,Oae],Object.getOwnPropertyDescriptor(jae.prototype,"verticalScrollBar"),jae.prototype),xe(jae.prototype,"horizontalScrollBar",[Nae,dl,Mae],Object.getOwnPropertyDescriptor(jae.prototype,"horizontalScrollBar"),jae.prototype),qae=xe(jae.prototype,"horizontal",[dl,Ic,kae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Xae=xe(jae.prototype,"vertical",[dl,Ic,Lae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yae=xe(jae.prototype,"cancelInnerEvents",[dl,Ic,Bae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kae=xe(jae.prototype,"scrollEvents",[Fae,Ic,dl,zae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qae=xe(jae.prototype,"pageTurningSpeed",[Ic,Gc,Uae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Zae=xe(jae.prototype,"pageEvents",[Gae,Ic,Hae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jae=xe(jae.prototype,"_sizeMode",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ooe.Unified}}),$ae=xe(jae.prototype,"_direction",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return soe.Horizontal}}),eoe=xe(jae.prototype,"_scrollThreshold",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),toe=xe(jae.prototype,"_pageTurningEventTiming",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),noe=xe(jae.prototype,"_indicator",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vae=jae))||Vae)||Vae)||Vae)||Vae));c.PageView=uoe;var hoe=new zn,_oe=new ri,foe=new ri,doe=new ri(1,1),poe=new ri,moe=new ri;function voe(e,t){if(!t._hadAlignOnce){t.alignMode===Gre.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=foe,a=doe;i?Wre(e,n=i,r,a):n=e.parent;var o=jre(n),s=n instanceof DD||!n.getComponent(qV),c=s?_oe:n.getComponent(qV).anchorPoint,l=s;e.getPosition(hoe);var u=e._uiProps.uiTransformComp,h=hoe.x,_=hoe.y,f=u.anchorPoint,d=e.getScale();if(t.alignFlags&Hre.HORIZONTAL){var p=0,m=0,v=o.width;l?(p=nM.left.x,m=nM.right.x):m=(p=-c.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(p+=r.x,p*=a.x,m+=r.x,m*=a.x);var g=0,y=f.x,x=d.x;if(x<0&&(y=1-y,x=-x),t.isStretchWidth)g=m-p,0!==x&&(u.width=g/x),h=p+y*g;else if(g=u.width*x,t.isAlignHorizontalCenter){var S=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,T=(.5-c.x)*o.width;i&&(S*=a.x,T+=r.x,T*=a.x),h=T+(y-.5)*g+S}else h=t.isAlignLeft?p+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&Hre.VERTICAL){var E=0,C=0,A=o.height;l?(C=nM.bottom.y,E=nM.top.y):E=(C=-c.y*A)+A,C+=t.isAbsoluteBottom?t.bottom:t.bottom*A,E-=t.isAbsoluteTop?t.top:t.top*A,i&&(C+=r.y,C*=a.y,E+=r.y,E*=a.y);var b=0,w=f.y,R=d.y;if(R<0&&(w=1-w,R=-R),t.isStretchHeight)b=E-C,0!==R&&(u.height=b/R),_=C+w*b;else if(b=u.height*R,t.isAlignVerticalCenter){var P=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*A,I=(.5-c.y)*o.height;i&&(P*=a.y,I+=r.y,I*=a.y),_=I+(w-.5)*b+P}else _=t.isAlignBottom?C+w*b:E+(w-1)*b;t._lastSize.height=b}e.setPosition(h,_,hoe.z),zn.set(t._lastPos,h,_,hoe.z)}}function goe(e){var t=e.getComponent(fae);if(t&&t.enabled){if(!c.isValid(e,!0))return;Soe.push(t)}for(var n,i=ge(e.children);!(n=i()).done;){var r=n.value;r.active&&goe(r)}}function yoe(){var e=$N.getScene();if(e){Toe.isAligning=!0,Toe._nodesOrderDirty&&(Soe.length=0,goe(e),Toe._nodesOrderDirty=!1);var t=null,n=Toe._activeWidgetsIterator;for(n.i=0;n.i<Soe.length;++n.i)(t=Soe[n.i])._dirty&&(voe(t.node,t),t._dirty=!1);Toe.isAligning=!1}}var xoe,Soe=[],Toe=e("widgetManager",c._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new ft.MutableForwardIterator(Soe),animationState:null,init:function(){$N.on(JN.EVENT_AFTER_SCENE_LAUNCH,yoe),$N.on(JN.EVENT_AFTER_UPDATE,yoe),aM.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);aM.instance.on("canvas-resize",e),dh.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=$N.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=tb.isNode(e)&&e.getComponent(fae);t&&t.enabled&&(t.alignMode===Gre.ON_WINDOW_RESIZE||t.alignMode===Gre.ALWAYS)&&t.setDirty();for(var n,i=ge(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var a=poe;a.set(0,0);var o=moe;if(o.set(1,1),e.target&&Wre(i,r=e.target,a,o),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:_oe,l=i._uiProps.uiTransformComp,u=jre(r),h=l.anchorPoint,_=i.getPosition(),f=Hre,d=i.getScale(),p=0;if(t&f.LEFT){var m=-c.x*u.width;m+=a.x,m*=o.x,p=_.x-h.x*l.width*d.x-m,e.isAbsoluteLeft||(p/=u.width),p/=o.x,e.left=n(e.left,p)}if(t&f.RIGHT){var v=(1-c.x)*u.width;v+=a.x,p=(v*=o.x)-(_.x+(1-h.x)*l.width*d.x),e.isAbsoluteRight||(p/=u.width),p/=o.x,e.right=n(e.right,p)}if(t&f.TOP){var g=(1-c.y)*u.height;g+=a.y,p=(g*=o.y)-(_.y+(1-h.y)*l.height*d.y),e.isAbsoluteTop||(p/=u.height),p/=o.y,e.top=n(e.top,p)}if(t&f.BOT){var y=-c.y*u.height;y+=a.y,y*=o.y,p=_.y-h.y*l.height*d.y-y,e.isAbsoluteBottom||(p/=u.height),p/=o.y,e.bottom=n(e.bottom,p)}}},updateAlignment:function e(t){var n=t.parent;n&&tb.isNode(n)&&e(n);var i=t.getComponent(fae);i&&n&&voe(t,i)},AlignMode:Gre,AlignFlags:Hre});$N.on(JN.EVENT_INIT,(function(){Toe.init()}));var Eoe,Coe,Aoe,boe,woe,Roe,Poe,Ioe,Doe,Ooe,Noe,Moe,koe,Loe,Boe,Foe,zoe,Uoe,Goe,Hoe=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(Cc("cc.SafeArea")(xoe=Uc()(xoe=bc(110)(xoe=kc(xoe=Lc()(xoe=Ac(fae)(xoe=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"onEnable",value:function(){this.updateArea(),dh.on("window-resize",this.updateArea,this),dh.on("orientation-change",this.updateArea,this)}},{key:"onDisable",value:function(){dh.off("window-resize",this.updateArea,this),dh.off("orientation-change",this.updateArea,this)}},{key:"updateArea",value:function(){var e=this.node.getComponent(fae),t=this.node.getComponent(qV);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=lM.getVisibleSize(),a=r.width,o=r.height,s=vh.getSafeAreaRect();e.top=o-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=a-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),Toe.add(e)}}}]),n}(sh))||xoe)||xoe)||xoe)||xoe)||xoe)||xoe);c.SafeArea=Hoe;var Voe,joe=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((Eoe=Cc("cc.UICoordinateTracker"),Coe=Uc(),Aoe=Lc(),boe=bc(110),woe=rl(tb),Roe=Wc(),Poe=rl(dB),Ioe=Wc(),Doe=Wc(),Ooe=Wc(),Noe=rl([KL]),Moe=Wc(),Eoe(koe=Coe(koe=Aoe(koe=boe((xe((Loe=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"syncEvents",Boe,se(e)),ye(e,"_target",Foe,se(e)),ye(e,"_camera",zoe,se(e)),ye(e,"_useScale",Uoe,se(e)),ye(e,"_distance",Goe,se(e)),e._transformPos=new zn,e._viewPos=new zn,e._canMove=!0,e._lastWPos=new zn,e._lastCameraPos=new zn,e}return Z(n,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}},{key:"onEnable",value:function(){this._checkCanMove()}},{key:"update",value:function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&zn.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);KL.emitEvents(this.syncEvents,this._transformPos,n)}}},{key:"_checkCanMove",value:function(){this._canMove=!(!this._camera||!this._target)}}]),n}(sh)).prototype,"target",[woe,Roe],Object.getOwnPropertyDescriptor(Loe.prototype,"target"),Loe.prototype),xe(Loe.prototype,"camera",[Poe,Ioe],Object.getOwnPropertyDescriptor(Loe.prototype,"camera"),Loe.prototype),xe(Loe.prototype,"useScale",[Doe],Object.getOwnPropertyDescriptor(Loe.prototype,"useScale"),Loe.prototype),xe(Loe.prototype,"distance",[Ooe],Object.getOwnPropertyDescriptor(Loe.prototype,"distance"),Loe.prototype),Boe=xe(Loe.prototype,"syncEvents",[Noe,Ic,Moe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Foe=xe(Loe.prototype,"_target",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zoe=xe(Loe.prototype,"_camera",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uoe=xe(Loe.prototype,"_useScale",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Goe=xe(Loe.prototype,"_distance",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),koe=Loe))||koe)||koe)||koe)||koe)),Woe=[$E.TOUCH_START,$E.TOUCH_END,$E.TOUCH_MOVE,$E.MOUSE_DOWN,$E.MOUSE_MOVE,$E.MOUSE_UP,$E.MOUSE_ENTER,$E.MOUSE_LEAVE,$E.MOUSE_WHEEL];function qoe(e){e.propagationStopped=!0}var Xoe,Yoe,Koe,Qoe,Zoe,Joe,$oe,ese,tse,nse,ise,rse,ase=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(Cc("cc.BlockInputEvents")(Voe=Uc()(Voe=Lc()(Voe=function(e){te(n,e);var t=le(n);function n(){return K(this,n),t.apply(this,arguments)}return Z(n,[{key:"onEnable",value:function(){for(var e=0;e<Woe.length;e++)this.node.on(Woe[e],qoe,this)}},{key:"onDisable",value:function(){for(var e=0;e<Woe.length;e++)this.node.off(Woe[e],qoe,this)}}]),n}(sh))||Voe)||Voe)||Voe),ose={},sse=e("SubContextView",(Xoe=Cc("cc.SubContextView"),Yoe=Uc(),Koe=bc(110),Qoe=Ac(qV),Zoe=Lc(),Joe=Wc(),$oe=Wc(),Xoe(ese=Yoe(ese=Koe(ese=Qoe(ese=Zoe((xe((tse=function(e){te(n,e);var t=le(n);function n(){var e;return K(this,n),ye(e=t.call(this),"_fps",nse,se(e)),e._sprite=void 0,e._imageAsset=void 0,e._texture=void 0,e._updatedTime=0,e._updateInterval=0,e._openDataContext=void 0,e._content=void 0,ye(e,"_designResolutionSize",ise,se(e)),e._content=new tb("content"),e._content.hideFlags|=Tl.Flags.DontSave|Tl.Flags.HideInHierarchy,e._sprite=null,e._imageAsset=new lv,e._openDataContext=null,e._updatedTime=performance.now(),e._texture=new Ov,e}return Z(n,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}},{key:"onLoad",value:function(){ose.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=ose.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1}},{key:"onEnable",value:function(){this._registerNodeEvent()}},{key:"onDisable",value:function(){this._unregisterNodeEvent()}},{key:"_initSharedCanvas",value:function(){if(this._openDataContext){var e=this._openDataContext.canvas;e.width=this._designResolutionSize.width,e.height=this._designResolutionSize.height}}},{key:"_initContentNode",value:function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(yY),this._sprite||(this._sprite=this._content.addComponent(yY)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new yH;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}}},{key:"_updateSubContextView",value:function(){if(this._openDataContext){var e=this.node.getComponent(qV),t=this._content.getComponent(qV),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var a=lM.getViewportRect(),o=t.getBoundingBoxToWorld(),s=lM.getVisibleSize(),c=dh.devicePixelRatio,l=(a.width*(o.x/s.width)+a.x)/c,u=(a.height*(o.y/s.height)+a.y)/c,h=a.width*(o.width/s.width)/c,_=a.height*(o.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}}},{key:"_updateSubContextTexture",value:function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}}},{key:"_registerNodeEvent",value:function(){this.node.on($E.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on($E.SIZE_CHANGED,this._updateSubContextView,this),this.node.on($E.LAYER_CHANGED,this._updateContentLayer,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off($E.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off($E.SIZE_CHANGED,this._updateSubContextView,this),this.node.off($E.LAYER_CHANGED,this._updateContentLayer,this)}},{key:"_updateContentLayer",value:function(){this._content.layer=this.node.layer}},{key:"update",value:function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())}},{key:"onDestroy",value:function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null}}]),n}(sh)).prototype,"designResolutionSize",[Joe],Object.getOwnPropertyDescriptor(tse.prototype,"designResolutionSize"),tse.prototype),xe(tse.prototype,"fps",[$oe],Object.getOwnPropertyDescriptor(tse.prototype,"fps"),tse.prototype),nse=xe(tse.prototype,"_fps",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),ise=xe(tse.prototype,"_designResolutionSize",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hi(640,960)}}),ese=tse))||ese)||ese)||ese)||ese)||ese));c.SubContextView=sse;var cse,lse=e("UIReorderComponent",Cc("cc.UIReorderComponent")(rse=function e(){K(this,e),P(1408,"UIReorderComponent")})||rse);c.UIReorderComponent=lse,c.ButtonComponent=s7,dt.setClassAlias(s7,"cc.ButtonComponent"),c.EditBoxComponent=kee,dt.setClassAlias(kee,"cc.EditBoxComponent"),c.LayoutComponent=ote,dt.setClassAlias(ote,"cc.LayoutComponent"),c.ProgressBarComponent=Dte,dt.setClassAlias(Dte,"cc.ProgressBarComponent"),c.ScrollViewComponent=hie,dt.setClassAlias(hie,"cc.ScrollViewComponent"),c.ScrollBarComponent=Ute,dt.setClassAlias(Ute,"cc.ScrollBarComponent"),c.SliderComponent=Mie,dt.setClassAlias(Mie,"cc.SliderComponent"),c.ToggleComponent=Yie,dt.setClassAlias(Yie,"cc.ToggleComponent"),c.ToggleContainerComponent=Ure,dt.setClassAlias(Ure,"cc.ToggleContainerComponent"),c.WidgetComponent=fae,dt.setClassAlias(fae,"cc.WidgetComponent"),c.PageViewComponent=uoe,dt.setClassAlias(uoe,"cc.PageViewComponent"),c.PageViewIndicatorComponent=aoe,dt.setClassAlias(aoe,"cc.PageViewIndicatorComponent"),c.SafeAreaComponent=Hoe,dt.setClassAlias(Hoe,"cc.SafeAreaComponent"),dt.setClassAlias(joe,"cc.UICoordinateTrackerComponent"),c.BlockInputEventsComponent=ase,dt.setClassAlias(ase,"cc.BlockInputEventsComponent"),function(e){e.NONE="none",e.LOADING="loading",e.LOADED="loaded",e.ERROR="error"}(cse||(cse={}));var use=function(){function e(t){K(this,e),this._componentEventList=new Map,this._state=cse.NONE,this._wrapper=void 0,this._webview=null,this._loaded=!1,this._forceUpdate=!1,this._component=null,this._uiTrans=null,this._node=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(qV),this.reset(),this.createWebView()}return Z(e,[{key:"reset",value:function(){this._wrapper=null,this._webview=null,this._loaded=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._state=cse.NONE,this._forceUpdate=!1}},{key:"loaded",get:function(){return this._loaded}},{key:"componentEventList",get:function(){return this._componentEventList}},{key:"webview",get:function(){return this._webview}},{key:"state",get:function(){return this._state}},{key:"UICamera",get:function(){return $N.root.batcher2D.getFirstRenderCamera(this._node)}},{key:"dispatchEvent",value:function(e){var t=this._componentEventList.get(e);if(t){this._state=e;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t.call(this,i)}}},{key:"destroy",value:function(){this.removeWebView(),this._wrapper=null,this._webview=null,this._loaded=!1,this._component=null,this._uiTrans=null,this._forceUpdate=!1,this._componentEventList.clear()}}]),e}();c.internal.WebViewImpl=use;var hse,_se,fse,dse,pse,mse,vse,gse,yse,xse,Sse,Tse,Ese,Cse,Ase=ii(),bse=function(e){te(n,e);var t=le(n);function n(e){return K(this,n),t.call(this,e)}return Z(n,[{key:"_bindDomEvent",value:function(){var e=this;this.webview&&this.webview.addEventListener("load",(function(t){e._forceUpdate=!0,e.dispatchEvent(cse.LOADED);var n=t.target,i=n.contentDocument&&n.contentDocument.body;i&&i.innerHTML.includes("404")&&e.dispatchEvent(cse.ERROR,i.innerHTML)}))}},{key:"loadURL",value:function(e){this.webview&&(this.webview.src=e,this.dispatchEvent(cse.LOADING))}},{key:"createWebView",value:function(){var e=document.createElement("div");this._wrapper=e,e.id="webview-wrapper",e.style["-webkit-overflow"]="auto",e.style["-webkit-overflow-scrolling"]="touch",e.style.position="absolute",e.style.bottom="0px",e.style.left="0px",e.style.transformOrigin="0px 100% 0px",e.style["-webkit-transform-origin"]="0px 100% 0px",ZN.container.appendChild(e);var t=document.createElement("iframe");this._webview=t,t.id="webview",t.style.border="none",t.style.width="100%",t.style.height="100%",e.appendChild(t),this._bindDomEvent()}},{key:"removeWebView",value:function(){var e=this._wrapper;Pt(ZN.container,e)&&ZN.container.removeChild(e),this.reset()}},{key:"enable",value:function(){this._wrapper&&(this._wrapper.style.visibility="visible")}},{key:"disable",value:function(){this._wrapper&&(this._wrapper.style.visibility="hidden")}},{key:"evaluateJS",value:function(e){if(this.webview){var t=this.webview.contentWindow;if(t)try{t.eval(e)}catch(e){this.dispatchEvent(cse.ERROR,e),x(e)}}}},{key:"setOnJSCallback",value:function(){y("The platform does not support")}},{key:"setJavascriptInterfaceScheme",value:function(){y("The platform does not support")}},{key:"syncMatrix",value:function(){if(this._wrapper&&this._uiTrans&&this._component&&"hidden"!==this._wrapper.style.visibility){var e=this.UICamera;if(e){this._component.node.getWorldMatrix(Ase),e.update(!0),e.worldMatrixToScreen(Ase,Ase,ZN.canvas.width,ZN.canvas.height);var t=this._uiTrans.contentSize,n=t.width,i=t.height;if(this._forceUpdate||this._m00!==Ase.m00||this._m01!==Ase.m01||this._m04!==Ase.m04||this._m05!==Ase.m05||this._m12!==Ase.m12||this._m13!==Ase.m13||this._w!==n||this._h!==i){this._m00=Ase.m00,this._m01=Ase.m01,this._m04=Ase.m04,this._m05=Ase.m05,this._m12=Ase.m12,this._m13=Ase.m13,this._w=n,this._h=i;var r=dh.devicePixelRatio,a=1/r,o=1/r,s=ZN.container,c=Ase.m00*a,l=Ase.m01,u=Ase.m04,h=Ase.m05*o;this._wrapper.style.width="".concat(n,"px"),this._wrapper.style.height="".concat(i,"px");var _=this._w*a,f=this._h*o,d=_*Ase.m00*this._uiTrans.anchorX,p=f*Ase.m05*this._uiTrans.anchorY,m=s&&s.style.paddingLeft?parseInt(s.style.paddingLeft):0,v=s&&s.style.paddingBottom?parseInt(s.style.paddingBottom):0,g=Ase.m12*a-d+m,y=Ase.m13*o-p+v,x="matrix(".concat(c,",").concat(-l,",").concat(-u,",").concat(h,",").concat(g,",").concat(-y,")");this._wrapper.style.transform=x,this._wrapper.style["-webkit-transform"]=x,this._forceUpdate=!1}}}}}]),n}(use),wse=function(){function e(){K(this,e)}return Z(e,null,[{key:"getImpl",value:function(e){return new bse(e)}}]),e}();c.internal.WebViewImplManager=wse;var Rse=e("WebView",(hse=Cc("cc.WebView"),_se=Uc(),fse=Lc(),dse=Ac(qV),pse=Wc(),mse=rl([KL]),vse=Zc(),gse=Wc(),hse(yse=_se(yse=fse(yse=dse(yse=kc((Cse=Ese=function(e){te(n,e);var t=le(n);function n(){var e;K(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return ye(e=t.call.apply(t,[this].concat(r)),"_url",Sse,se(e)),e._impl=null,ye(e,"webviewEvents",Tse,se(e)),e}return Z(n,[{key:"url",get:function(){return this._url},set:function(e){this._url=e,this._impl&&this._impl.loadURL(e)}},{key:"nativeWebView",get:function(){return this._impl&&this._impl.webview||null}},{key:"state",get:function(){return this._impl?this._impl.state:cse.NONE}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"__preload",value:function(){this._impl=wse.getImpl(this),this._impl.componentEventList.set(cse.LOADING,this.onLoading.bind(this)),this._impl.componentEventList.set(cse.LOADED,this.onLoaded.bind(this)),this._impl.componentEventList.set(cse.ERROR,this.onError.bind(this)),this._impl.loadURL(this._url)}},{key:"onLoading",value:function(){KL.emitEvents(this.webviewEvents,this,cse.LOADING),this.node.emit(cse.LOADING,this)}},{key:"onLoaded",value:function(){KL.emitEvents(this.webviewEvents,this,cse.LOADED),this.node.emit(cse.LOADED,this)}},{key:"onError",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];KL.emitEvents(this.webviewEvents,this,cse.ERROR,t),this.node.emit(cse.ERROR,this,t)}},{key:"onEnable",value:function(){this._impl&&this._impl.enable()}},{key:"onDisable",value:function(){this._impl&&this._impl.disable()}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(){this._impl&&this._impl.syncMatrix()}}]),n}(sh),Ese.EventType=cse,Sse=xe((xse=Cse).prototype,"_url",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"https://cocos.com"}}),xe(xse.prototype,"url",[pse],Object.getOwnPropertyDescriptor(xse.prototype,"url"),xse.prototype),Tse=xe(xse.prototype,"webviewEvents",[Ic,mse,vse,gse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yse=xse))||yse)||yse)||yse)||yse)||yse));c.internal.WebView=Rse}}}));
